USE [master]
GO
/****** Object:  Database [dbc01y30]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DATABASE [dbc01y30]
 CONTAINMENT = NONE
 ON  PRIMARY 
( NAME = N'dbc01y30', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL16.SQLEX2022\MSSQL\DATA\dbc01y30.mdf' , SIZE = 48960KB , MAXSIZE = UNLIMITED, FILEGROWTH = 1024KB )
 LOG ON 
( NAME = N'dbc01y30_log', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL16.SQLEX2022\MSSQL\DATA\dbc01y30_log.ldf' , SIZE = 5056KB , MAXSIZE = 2048GB , FILEGROWTH = 10%)
 WITH CATALOG_COLLATION = DATABASE_DEFAULT, LEDGER = OFF
GO
ALTER DATABASE [dbc01y30] SET COMPATIBILITY_LEVEL = 110
GO
IF (1 = FULLTEXTSERVICEPROPERTY('IsFullTextInstalled'))
begin
EXEC [dbc01y30].[dbo].[sp_fulltext_database] @action = 'enable'
end
GO
ALTER DATABASE [dbc01y30] SET ANSI_NULL_DEFAULT OFF 
GO
ALTER DATABASE [dbc01y30] SET ANSI_NULLS OFF 
GO
ALTER DATABASE [dbc01y30] SET ANSI_PADDING OFF 
GO
ALTER DATABASE [dbc01y30] SET ANSI_WARNINGS OFF 
GO
ALTER DATABASE [dbc01y30] SET ARITHABORT OFF 
GO
ALTER DATABASE [dbc01y30] SET AUTO_CLOSE OFF 
GO
ALTER DATABASE [dbc01y30] SET AUTO_SHRINK ON 
GO
ALTER DATABASE [dbc01y30] SET AUTO_UPDATE_STATISTICS ON 
GO
ALTER DATABASE [dbc01y30] SET CURSOR_CLOSE_ON_COMMIT OFF 
GO
ALTER DATABASE [dbc01y30] SET CURSOR_DEFAULT  GLOBAL 
GO
ALTER DATABASE [dbc01y30] SET CONCAT_NULL_YIELDS_NULL OFF 
GO
ALTER DATABASE [dbc01y30] SET NUMERIC_ROUNDABORT OFF 
GO
ALTER DATABASE [dbc01y30] SET QUOTED_IDENTIFIER OFF 
GO
ALTER DATABASE [dbc01y30] SET RECURSIVE_TRIGGERS OFF 
GO
ALTER DATABASE [dbc01y30] SET  DISABLE_BROKER 
GO
ALTER DATABASE [dbc01y30] SET AUTO_UPDATE_STATISTICS_ASYNC OFF 
GO
ALTER DATABASE [dbc01y30] SET DATE_CORRELATION_OPTIMIZATION OFF 
GO
ALTER DATABASE [dbc01y30] SET TRUSTWORTHY OFF 
GO
ALTER DATABASE [dbc01y30] SET ALLOW_SNAPSHOT_ISOLATION OFF 
GO
ALTER DATABASE [dbc01y30] SET PARAMETERIZATION SIMPLE 
GO
ALTER DATABASE [dbc01y30] SET READ_COMMITTED_SNAPSHOT OFF 
GO
ALTER DATABASE [dbc01y30] SET HONOR_BROKER_PRIORITY OFF 
GO
ALTER DATABASE [dbc01y30] SET RECOVERY SIMPLE 
GO
ALTER DATABASE [dbc01y30] SET  MULTI_USER 
GO
ALTER DATABASE [dbc01y30] SET PAGE_VERIFY CHECKSUM  
GO
ALTER DATABASE [dbc01y30] SET DB_CHAINING OFF 
GO
ALTER DATABASE [dbc01y30] SET FILESTREAM( NON_TRANSACTED_ACCESS = OFF ) 
GO
ALTER DATABASE [dbc01y30] SET TARGET_RECOVERY_TIME = 0 SECONDS 
GO
ALTER DATABASE [dbc01y30] SET DELAYED_DURABILITY = DISABLED 
GO
ALTER DATABASE [dbc01y30] SET ACCELERATED_DATABASE_RECOVERY = OFF  
GO
ALTER DATABASE [dbc01y30] SET QUERY_STORE = OFF
GO
USE [dbc01y30]
GO
/****** Object:  User [AWAD]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE USER [AWAD] WITHOUT LOGIN WITH DEFAULT_SCHEMA=[AWAD]
GO
/****** Object:  Default [Dflt_arhdr_modified]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_arhdr_modified] 
AS
1














GO
/****** Object:  Default [Dflt_budctr_modified]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_budctr_modified] 
AS
1















GO
/****** Object:  Default [Dflt_budctr_percent]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_budctr_percent] 
AS
0.00

















GO
/****** Object:  Default [Dflt_budget_modified]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_budget_modified] 
AS
1
















GO
/****** Object:  Default [Dflt_classfil_modified]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_classfil_modified] 
AS
1

















GO
/****** Object:  Default [Dflt_customer_cu_alwcr]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_customer_cu_alwcr] 
AS
1

















GO
/****** Object:  Default [Dflt_customer_modified]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_customer_modified] 
AS
1
















GO
/****** Object:  Default [Dflt_fcimage_modified]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_fcimage_modified] 
AS
1

















GO
/****** Object:  Default [Dflt_glchart_modified]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_glchart_modified] 
AS
1

















GO
/****** Object:  Default [Dflt_glcstctr_modified]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_glcstctr_modified] 
AS
1

















GO
/****** Object:  Default [Dflt_glcurr_modified]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_glcurr_modified] 
AS
1

















GO
/****** Object:  Default [Dflt_gljrdtl_jdfcamt]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_gljrdtl_jdfcamt] 
AS
0.00

















GO
/****** Object:  Default [Dflt_gljrdtl_jdlcamt]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_gljrdtl_jdlcamt] 
AS
0.00

















GO
/****** Object:  Default [Dflt_gljrhdr_modified]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_gljrhdr_modified] 
AS
1

















GO
/****** Object:  Default [Dflt_lcdraft_drinvno]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_lcdraft_drinvno] 
AS
0.00

















GO
/****** Object:  Default [Dflt_lcdtl_ld_discamt]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_lcdtl_ld_discamt] 
AS
0.00

















GO
/****** Object:  Default [Dflt_lcdtl_ld_fdscamt]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_lcdtl_ld_fdscamt] 
AS
0.00















GO
/****** Object:  Default [Dflt_lcfile_lcfcyrate]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_lcfile_lcfcyrate] 
AS
0.00

















GO
/****** Object:  Default [Dflt_lcfile_lcinsprtg]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_lcfile_lcinsprtg] 
AS
0.00

















GO
/****** Object:  Default [Dflt_lchdr_lh_lc]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_lchdr_lh_lc] 
AS
''
















GO
/****** Object:  Default [Dflt_pudept_modified]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_pudept_modified] 
AS
1

















GO
/****** Object:  Default [Dflt_pudtl_pkqty]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_pudtl_pkqty] 
AS
1

















GO
/****** Object:  Default [Dflt_puhdr_lccode]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_puhdr_lccode] 
AS
space(15)
















GO
/****** Object:  Default [Dflt_puhdr_modified]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_puhdr_modified] 
AS
1

















GO
/****** Object:  Default [Dflt_salecntr_modified]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_salecntr_modified] 
AS
1

















GO
/****** Object:  Default [Dflt_salecntr_slwhsrc]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_salecntr_slwhsrc] 
AS
1

















GO
/****** Object:  Default [Dflt_sales_hd_modified]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_sales_hd_modified] 
AS
1

















GO
/****** Object:  Default [Dflt_sales_qh_modified]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_sales_qh_modified] 
AS
1
















GO
/****** Object:  Default [Dflt_salesmen_modified]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_salesmen_modified] 
AS
1

















GO
/****** Object:  Default [Dflt_slclass_modified]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_slclass_modified] 
AS
1

















GO
/****** Object:  Default [Dflt_starea_modified]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_starea_modified] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_bcserial]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_bcserial] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_calap]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_calap] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_calar]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_calar] 
AS
1
















GO
/****** Object:  Default [Dflt_stbranch_calgl]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_calgl] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_calst]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_calst] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_01]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_01] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_02]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_02] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_03]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_03] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_04]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_04] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_05]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_05] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_06]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_06] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_07]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_07] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_08]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_08] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_09]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_09] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_10]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_10] 
AS
1















GO
/****** Object:  Default [Dflt_stbranch_jv_101]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_101] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_11]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_11] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_12]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_12] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_13]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_13] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_14]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_14] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_16]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_16] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_17]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_17] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_18]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_18] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_19]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_19] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_20]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_20] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_21]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_21] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_22]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_22] 
AS
1















GO
/****** Object:  Default [Dflt_stbranch_jv_23]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_23] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_24]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_24] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_26]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_26] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_27]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_27] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_28]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_28] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_30]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_30] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_31]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_31] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_32]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_32] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_33]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_33] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_jv_34]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_jv_34] 
AS
1

















GO
/****** Object:  Default [Dflt_stbranch_modified]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stbranch_modified] 
AS
1

















GO
/****** Object:  Default [Dflt_stclass_modified]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stclass_modified] 
AS
1

















GO
/****** Object:  Default [Dflt_sthdr_modified]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_sthdr_modified] 
AS
1

















GO
/****** Object:  Default [Dflt_stitems_modified]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stitems_modified] 
AS
1

















GO
/****** Object:  Default [Dflt_stprice_modified]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stprice_modified] 
AS
1

















GO
/****** Object:  Default [Dflt_stunits_modified]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stunits_modified] 
AS
1

















GO
/****** Object:  Default [Dflt_stwhous_modified]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_stwhous_modified] 
AS
1

















GO
/****** Object:  Default [Dflt_supplier_modified]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[Dflt_supplier_modified] 
AS
1

















GO
/****** Object:  Default [UW_ZeroDefault]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE DEFAULT [dbo].[UW_ZeroDefault] 
AS
0

















GO
USE [dbc01y30]
GO
/****** Object:  Sequence [dbo].[seq1]    Script Date: 2025-11-13 12:21:51 PM ******/
CREATE SEQUENCE [dbo].[seq1] 
 AS [bigint]
 START WITH 1
 INCREMENT BY 1
 MINVALUE -9223372036854775808
 MAXVALUE 9223372036854775807
 CACHE 
GO
/****** Object:  UserDefinedFunction [dbo].[Acc_is_zero_value]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2022-05-29@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE FUNCTION [dbo].[Acc_is_zero_value](@lval1 float,@max_decimal int)
RETURNS float AS
BEGIN
  declare @f_zero varchar(15)='',
          @ttl_zero int,
		  @fnl_value float,
		  @ldecimal_modified bit,
          @l_intiger_part varchar(50),
		  @l_decimal_part varchar(50),
		  @l_decimalchr varchar(50),
		  @l_pos int =0,
		  @l_ctr int,
		  @nval1 numeric(30,12),
		  @org_nval1 numeric(30,12),
		  @l_zero_string  varchar(15)
--------- Step 1 when value is 0
		  if @lval1=0 return @lval1

		  set @ldecimal_modified=0
		  set @max_decimal= isnull(@max_decimal,4)
		  set @org_nval1=cast(@lval1 as numeric(30,12))
		  if @max_decimal<4 set @max_decimal=4
		  
		  set @nval1=cast(abs(@lval1) as numeric(30,12))

		  set @l_zero_string=replicate('0',@max_decimal)
		  set @l_decimalchr=format(@nval1,'G')
		  set @l_pos=charindex('.',	@l_decimalchr)
		  if @l_pos>0
		  begin
		      set @l_intiger_part=substring(@l_decimalchr,1,@l_pos-1)
			  set @l_decimal_part=substring(@l_decimalchr,@l_pos+1,12)
		      if @nval1<1
			  begin
				   set @f_zero=substring(@l_decimalchr,@l_pos+1,@max_decimal);
				   if @f_zero=@l_zero_string
				   begin
				       set @fnl_value=0
					   return @fnl_value
				   end
			  end
			  set @l_ctr=12
			  set @ttl_zero=0
			  while @l_ctr>1
			  begin
			      if substring(@l_decimal_part,@l_ctr,1)='0' set @ttl_zero=@ttl_zero+1
				  else
				  begin
				       if @ttl_zero>=4
					   begin
					       set @l_decimal_part=substring(@l_decimal_part,1,@l_ctr)
						   set @ldecimal_modified=1
						   set @ttl_zero=0
						   break
					   end
					   else set @ttl_zero=0
				  end
				  set @l_ctr=@l_ctr-1
			  end
			  if @ttl_zero>=4
			  begin
			      set @l_decimal_part=substring(@l_decimal_part,1,@l_ctr)
			  end
			  if @l_ctr=3
			  set @fnl_value=cast(@l_intiger_part+'.'+@l_decimal_part as numeric(30,3))
			  else if @l_ctr=4 set @fnl_value=cast(@l_intiger_part+'.'+@l_decimal_part as numeric(30,4))
			  else if @l_ctr=5 set @fnl_value=cast(@l_intiger_part+'.'+@l_decimal_part as numeric(30,5))
			  else if @l_ctr=6 set @fnl_value=cast(@l_intiger_part+'.'+@l_decimal_part as numeric(30,6))
			  else if @l_ctr=7 set @fnl_value=cast(@l_intiger_part+'.'+@l_decimal_part as numeric(30,7))
			  else if @l_ctr=8 set @fnl_value=cast(@l_intiger_part+'.'+@l_decimal_part as numeric(30,8))
			  else if @l_ctr=9 set @fnl_value=cast(@l_intiger_part+'.'+@l_decimal_part as numeric(30,9))
			  else if @l_ctr=10 set @fnl_value=cast(@l_intiger_part+'.'+@l_decimal_part as numeric(30,10))
			  else if @l_ctr=11 set @fnl_value=cast(@l_intiger_part+'.'+@l_decimal_part as numeric(30,11))
			  else set @fnl_value=cast(@l_intiger_part+'.'+@l_decimal_part as numeric(30,12))
			  
		  end 
		  if @lval1<0 set @fnl_value=@fnl_value*-1
	return @fnl_value
END



GO
/****** Object:  UserDefinedFunction [dbo].[FetchStatusOfCursorNamed]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
	    CREATE FUNCTION [dbo].[FetchStatusOfCursorNamed](@CursorName nvarchar(50))
         RETURNS int AS
         BEGIN
                 DECLARE @fetch_status int
                 select @fetch_status = fetch_status from sys.dm_exec_cursors(@@SPID) where name = @CursorName
                 RETURN @fetch_status
         END
 














GO
/****** Object:  UserDefinedFunction [dbo].[fltr_numbers_fm_string]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [dbo].[fltr_numbers_fm_string]
(@alphanumeric_str varchar(100)) 
RETURNS varchar(100)
AS BEGIN 
    declare @string varchar(100)
	set @string=@alphanumeric_str
	WHILE PATINDEX('%[^0-9]%',@string) <> 0	SET @string = STUFF(@string,PATINDEX('%[^0-9]%',@string),1,'')
	return @string
end

--WHILE PATINDEX('%[^0-9]%', @puvodni) > 0 SET @puvodni = REPLACE(@puvodni, SUBSTRING(@puvodni,
-- PATINDEX('%[^0-9]%', @puvodni), 1), '' )









GO
/****** Object:  UserDefinedFunction [dbo].[FnGetSrlno]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [dbo].[FnGetSrlno]
(@comp char(2),@brno char(2), @Type char(2))
RETURNS int
AS BEGIN
DECLARE @NewRef INT
DECLARE @isEx INT
SET @NewRef =0
SET @isEx=1
IF @Type ='04' 
BEGIN
	SELECT @NewRef  = jv_04   FROM stbranch  WHERE COMPANY=@comp and BRNNO=@brno
	WHILE   @isEx=1
	BEGIN
			IF(SELECT  COUNT(*) FROM sales_hd  WHERE company=@brno and  invtype ='04' and ref=@NewRef    )>0
		    BEGIN 
	          SET @NewRef=@NewRef+1
	        END 
			ELSE 
			BEGIN
				SET @NewRef=@NewRef
				SET @isEx=0
			END
	END 
END
IF @Type ='06' 
BEGIN 	
	SELECT @NewRef  = jv_06   FROM stbranch  WHERE COMPANY=@comp and BRNNO=@brno

	WHILE   @isEx=1
	BEGIN
			IF(SELECT  COUNT(*) FROM sales_hd  WHERE company=@brno and  invtype ='06' and ref=@NewRef  )>0
		    BEGIN 
	          SET @NewRef=@NewRef+1
	        END 
	        ELSE 
	        BEGIN
	           SET @NewRef=@NewRef
	           SET @isEx=0
	        END
	 END 
END
SET @isEx=1
IF @Type ='32' 
BEGIN 

	SELECT @NewRef  = jv_32   FROM stbranch  WHERE COMPANY=@comp and BRNNO=@brno

	WHILE   @isEx=1
	BEGIN
			IF(SELECT  COUNT(*) FROM sales_qh   WHERE sales_qh.ref  =@NewRef  and  sales_qh.invtype ='01'  )>0
		    BEGIN 
				 SET @NewRef=@NewRef+1
			END 
			ELSE 
			BEGIN
				SET @NewRef=@NewRef
				SET @isEx=0
			END
	END 
END
IF @Type ='20' 
BEGIN 
	SELECT @NewRef  = jv_20   FROM stbranch  WHERE COMPANY=@comp and BRNNO=@brno

	WHILE   @isEx=1
	BEGIN
			IF(SELECT  COUNT(*) FROM sthdr  WHERE branch=@brno and  trtype ='20' and ref=@NewRef  )>0
		    BEGIN 
	            SET @NewRef=@NewRef+1
			END 
			ELSE 
	        BEGIN
				SET @NewRef=@NewRef
				SET @isEx=0
			END
	END 
END
RETURN @NewRef
END












GO
/****** Object:  UserDefinedFunction [dbo].[full_day_cut]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE function [dbo].[full_day_cut](@m_emp char(6),@m_date Char(8),@am_1_pm_2 Char(1),@cut_minutes int,
                                   @m_f_day_free numeric(5,2))
returns int as
begin
 declare @aply_full bit=0,@rtrn_value Int=0
 declare @sat char(1),@sun char(1),@mon char(1),@tue char(1),@wed char(1),@thu char(1),@fri char(1),
         @pos_whours numeric(4,2),@tmp_day_name char(3),@free_to_detuct int=0

 set @rtrn_value=@cut_minutes
 set @aply_full=1
 If @m_emp='' Or @m_date='' or @am_1_pm_2='' Or @am_1_pm_2 not in ('1','2')
    set @aply_full=0
 
 if @aply_full=1
 begin
      set @aply_full=0
	  select @sat=sat,@sun=sun,@mon=mon,@tue=tue,@wed=wed,@thu=thu,@fri=fri,@pos_whours=pos_whours
	         from ppemp where empno=@m_emp
      if @@rowcount<>0
	  begin	    
		set @tmp_day_name=substring(DATENAME(dw,@m_date),1,3)
		if @tmp_day_name='Fri'
		   set @free_to_detuct=@m_f_day_free
        set @aply_full=0
		IF @tmp_day_name='Sat'
		   if @sat not in ('1','4')
		      set @aply_full=1
		IF @tmp_day_name='Sun'
		   if @sun not in ('1','4')
		      set @aply_full=1
		IF @tmp_day_name='Mon'
		   if @mon not in ('1','4')
		      set @aply_full=1
		IF @tmp_day_name='Tue'
		   if @tue not in ('1','4')
		      set @aply_full=1
		IF @tmp_day_name='Wed'
		   if @wed not in ('1','4')
		      set @aply_full=1
		IF @tmp_day_name='Thu'
		   if @thu not in ('1','4')
		      set @aply_full=1	     
		IF @tmp_day_name='Fri'
		   if @fri not in ('1','4')
		      set @aply_full=1	     
	  end
 end
 if @aply_full=1	   
 begin
   if (@pos_whours*60)-@free_to_detuct>@rtrn_value
      set @rtrn_value=(@pos_whours*60)-@free_to_detuct
 end
 return(@rtrn_value)
end






GO
/****** Object:  UserDefinedFunction [dbo].[g_hours]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE function [dbo].[g_hours](@time_value int) 
returns int as
begin
 declare @y char(4),@x int,@rtrn_value Int=0
 --if @time_value<60 return 0
 if @time_value>=60
    begin
      set @y=ltrim(rtrim(str(@time_value)))
      set @x=len(@y)
      if cast(substring(@y,1,1) as int)>0 and @x<=3 set @y='0'+@y
      set @x=len(@y)
      if @x<4 set @y=@y+replicate('0',4-@x)
	  set @rtrn_value=cast(substring(@y,1,2) as int)
	end
    return(@rtrn_value)
end






GO
/****** Object:  UserDefinedFunction [dbo].[g_minutes]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE function [dbo].[g_minutes](@time_value int) 
returns int as
begin
 declare @y char(4),@x int,@rtrn_value Int=0
 --if @time_value<60 return 0
 if @time_value>=60
    begin
      set @y=ltrim(rtrim(str(@time_value)))
      set @x=len(@y)
      if cast(substring(@y,1,1) as int)>0 and @x<=3 set @y='0'+@y
      set @x=len(@y)
      if @x<4 set @y=@y+replicate('0',4-@x)
	  set @rtrn_value=cast(substring(@y,3,2) as int)
	end
    return(@rtrn_value)
end






GO
/****** Object:  UserDefinedFunction [dbo].[get_ClientLastPrice]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [dbo].[get_ClientLastPrice]
(@comp char(2),@custid varchar(19), @lbarcode varchar(20),@Glact bit)
-- @mode 
RETURNS float
AS BEGIN
    declare @dbc varchar(40),
    @c_l_price float=0,
	@lpkqty numeric(8,3),
	@sql varchar(400)='',
	@paralist varchar(400)
	set @dbc=DB_NAME()	

	if @glact=0
	begin
		select top 1 @c_l_price=price ,@lpkqty=pkqty from sales_dt where company=@comp and ltrim(rtrim(custno))=@custid and 
		ltrim(rtrim(barcode))=@lbarcode and invtype in ('04','06') order by invdate desc

		if isnull(@c_l_price,0)=0
		begin
		  declare @yrcode char(2)
		  set @yrcode=substring(@dbc,7,2)
		  set @dbc=substring(@dbc,1,6)+str(cast(@yrcode as int)-1,2)
		  if exists(SELECT name FROM sys.databases where name=@dbc)
		  begin
			 set @paralist='@c_l_price float output,@lpkqty numeric(8,3) output'
			 set @sql='select top 1 @c_l_price=price,@lpkqty=pkqty from '+@dbc+'.dbo.sales_dt where 
					   company='''+@comp+''' and ltrim(rtrim(custno))='''+@custid+''' and 
					   ltrim(rtrim(barcode))='''+@lbarcode+''' and invtype in (''04'',''06'') order by invdate desc'

			 EXECUTE sp_executesql @sql ,@paralist,@c_l_price=@c_l_price output,@lpkqty=@lpkqty output
		  end
		end
	end
	set @c_l_price=isnull(@c_l_price,0)
	set @lpkqty=isnull(@lpkqty,0)
	if @c_l_price>0 and @lpkqty>1 set @c_l_price=@c_l_price/@lpkqty
	return @c_l_price
end











GO
/****** Object:  UserDefinedFunction [dbo].[get_emp_abs_multiple]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE function [dbo].[get_emp_abs_multiple](@m_emp char(6),@m_date Char(8),@m_worktype Char(2),@m_period_no char(1),
                                             @m_no_absmultiple bit,@m_abs_mltiple_max bit,@p_dept Char(2),@p_grp Char(2))
returns numeric(7,2) as
begin
   declare @continue_checking bit=0,@m_ndx int=0,@rtrn_value numeric(7,2)=0
   declare @timing_1 char(2),@timing_2 char(2),@timing_3 char(2),@m_dept char(2),@m_grp char(2),@day_order int,
           @m_emp_no_abs_multiple bit,@m_prd_pctg char(10),
           @d1_p1_ptg numeric(7,2),@d1_p2_ptg numeric(7,2),@d1_p3_ptg numeric(7,2),
		   @d2_p1_ptg numeric(7,2),@d2_p2_ptg numeric(7,2),@d2_p3_ptg numeric(7,2),
		   @d3_p1_ptg numeric(7,2),@d3_p2_ptg numeric(7,2),@d3_p3_ptg numeric(7,2),
		   @d4_p1_ptg numeric(7,2),@d4_p2_ptg numeric(7,2),@d4_p3_ptg numeric(7,2),
		   @d5_p1_ptg numeric(7,2),@d5_p2_ptg numeric(7,2),@d5_p3_ptg numeric(7,2),
		   @d6_p1_ptg numeric(7,2),@d6_p2_ptg numeric(7,2),@d6_p3_ptg numeric(7,2),
		   @d7_p1_ptg numeric(7,2),@d7_p2_ptg numeric(7,2),@d7_p3_ptg numeric(7,2),
		   @day_of_tgt_date int

   set @day_of_tgt_date=cast(SUBSTRING(@m_date,7,2) as int)

   set @rtrn_value=0
   set @continue_checking=1
   If @m_emp='' Or @m_date='' or @m_worktype='  '
      set @continue_checking=0
   if @continue_checking=1
   begin
	 set @m_ndx=0
	 if @m_period_no in ('1','2','3')
	 begin
	    set @m_ndx=CAST(@m_period_no as int)      
     end
	 if @m_ndx=0
	 begin
	   set @continue_checking=0
	   select @timing_1=timing_1,@timing_2=timing_2,@timing_3=timing_3,@m_emp_no_abs_multiple=no_abs_multiple,
	          @m_dept=deptcode,@m_grp=adds_id from ppemp where empno=@m_emp
	   if @@rowcount<>0
	   begin
		 if ISNULL(@timing_1,' ')=@m_worktype
			set @m_ndx=1
		 if ISNULL(@timing_2,' ')=@m_worktype
			set @m_ndx=2
		 if ISNULL(@timing_3,' ')=@m_worktype
			set @m_ndx=3
		end
		if @m_ndx in (1,2,3)
		   set @continue_checking=1
	   end
	 end     
	 if @m_no_absmultiple is null
	 begin
	    if ISNULL(@m_emp_no_abs_multiple,CAST(0 as bit))=0
		   set @continue_checking=0
     end
	 if @continue_checking=1 and @m_ndx in (1,2,3)
	 begin   

      if @p_dept is null set @p_dept=@m_dept
      if @p_grp is null set @p_grp=@m_grp

	  set @day_order=(DATEPART(W,@m_date)% 7) +1 --DATEPART(W,@m_date)+1
	  set @continue_checking=0
	  if @m_abs_mltiple_max=1
	     select @d1_p1_ptg=d1_p1_ptg,@d1_p2_ptg=d1_p2_ptg,@d1_p3_ptg=d1_p3_ptg,
		        @d2_p1_ptg=d2_p1_ptg,@d2_p2_ptg=d2_p2_ptg,@d2_p3_ptg=d2_p3_ptg,
		        @d3_p1_ptg=d3_p1_ptg,@d3_p2_ptg=d3_p2_ptg,@d3_p3_ptg=d3_p3_ptg,
		        @d4_p1_ptg=d4_p1_ptg,@d4_p2_ptg=d4_p2_ptg,@d4_p3_ptg=d4_p3_ptg,
		        @d5_p1_ptg=d5_p1_ptg,@d5_p2_ptg=d5_p2_ptg,@d5_p3_ptg=d5_p3_ptg,
		        @d6_p1_ptg=d6_p1_ptg,@d6_p2_ptg=d6_p2_ptg,@d6_p3_ptg=d6_p3_ptg,
		        @d7_p1_ptg=d7_p1_ptg,@d7_p2_ptg=d7_p2_ptg,@d7_p3_ptg=d7_p3_ptg
			    from pp_abs_multiple where fm_date<=@m_date and to_date>=@m_date 
			    and case when dept<>'' then dept else @p_dept end = @p_dept
			    and case when grp<>'' then grp else @p_grp end = @p_grp
			    and case when fm_day<>0 then fm_day else @day_of_tgt_date end <=@day_of_tgt_date
			    and case when to_day<>0 then to_day else @day_of_tgt_date end >=@day_of_tgt_date
			    and case when @day_order=1 and @m_ndx=1 then d1_p1_ptg
			             when @day_order=1 and @m_ndx=2 then d1_p2_ptg
					     when @day_order=1 and @m_ndx=3 then d1_p3_ptg
					     when @day_order=2 and @m_ndx=1 then d2_p1_ptg
			             when @day_order=2 and @m_ndx=2 then d2_p2_ptg
					     when @day_order=2 and @m_ndx=3 then d2_p3_ptg
					     when @day_order=3 and @m_ndx=1 then d3_p1_ptg
			             when @day_order=3 and @m_ndx=2 then d3_p2_ptg
					     when @day_order=3 and @m_ndx=3 then d3_p3_ptg 
					     when @day_order=4 and @m_ndx=1 then d4_p1_ptg
			             when @day_order=4 and @m_ndx=2 then d4_p2_ptg
					     when @day_order=4 and @m_ndx=3 then d4_p3_ptg
					     when @day_order=5 and @m_ndx=1 then d5_p1_ptg
			             when @day_order=5 and @m_ndx=2 then d5_p2_ptg
					     when @day_order=5 and @m_ndx=3 then d5_p3_ptg
					     when @day_order=6 and @m_ndx=1 then d6_p1_ptg
			             when @day_order=6 and @m_ndx=2 then d6_p2_ptg
					     when @day_order=6 and @m_ndx=1 then d6_p1_ptg
			             when @day_order=7 and @m_ndx=1 then d7_p1_ptg
					     when @day_order=7 and @m_ndx=2 then d7_p2_ptg
					     when @day_order=7 and @m_ndx=3 then d7_p3_ptg end >0
			    order by case when @day_order=1 and @m_ndx=1 then d1_p1_ptg
			                  when @day_order=1 and @m_ndx=2 then d1_p2_ptg
					          when @day_order=1 and @m_ndx=3 then d1_p3_ptg
					          when @day_order=2 and @m_ndx=1 then d2_p1_ptg
			                  when @day_order=2 and @m_ndx=2 then d2_p2_ptg
					          when @day_order=2 and @m_ndx=3 then d2_p3_ptg
					          when @day_order=3 and @m_ndx=1 then d3_p1_ptg
			                  when @day_order=3 and @m_ndx=2 then d3_p2_ptg
					          when @day_order=3 and @m_ndx=3 then d3_p3_ptg 
					          when @day_order=4 and @m_ndx=1 then d4_p1_ptg
			                  when @day_order=4 and @m_ndx=2 then d4_p2_ptg
					          when @day_order=4 and @m_ndx=3 then d4_p3_ptg
					          when @day_order=5 and @m_ndx=1 then d5_p1_ptg
			                  when @day_order=5 and @m_ndx=2 then d5_p2_ptg
					          when @day_order=5 and @m_ndx=3 then d5_p3_ptg
					          when @day_order=6 and @m_ndx=1 then d6_p1_ptg
			                  when @day_order=6 and @m_ndx=2 then d6_p2_ptg
					          when @day_order=6 and @m_ndx=1 then d6_p1_ptg
			                  when @day_order=7 and @m_ndx=1 then d7_p1_ptg
					          when @day_order=7 and @m_ndx=2 then d7_p2_ptg
					          when @day_order=7 and @m_ndx=3 then d7_p3_ptg  end asc
	  else
	     select @d1_p1_ptg=d1_p1_ptg,@d1_p2_ptg=d1_p2_ptg,@d1_p3_ptg=d1_p3_ptg,
		        @d2_p1_ptg=d2_p1_ptg,@d2_p2_ptg=d2_p2_ptg,@d2_p3_ptg=d2_p3_ptg,
		        @d3_p1_ptg=d3_p1_ptg,@d3_p2_ptg=d3_p2_ptg,@d3_p3_ptg=d3_p3_ptg,
		        @d4_p1_ptg=d4_p1_ptg,@d4_p2_ptg=d4_p2_ptg,@d4_p3_ptg=d4_p3_ptg,
		        @d5_p1_ptg=d5_p1_ptg,@d5_p2_ptg=d5_p2_ptg,@d5_p3_ptg=d5_p3_ptg,
		        @d6_p1_ptg=d6_p1_ptg,@d6_p2_ptg=d6_p2_ptg,@d6_p3_ptg=d6_p3_ptg,
		        @d7_p1_ptg=d7_p1_ptg,@d7_p2_ptg=d7_p2_ptg,@d7_p3_ptg=d7_p3_ptg
			    from pp_abs_multiple where fm_date<=@m_date and to_date>=@m_date 
			    and case when dept<>'' then dept else @p_dept end = @m_dept
			    and case when grp<>'' then grp else @p_grp end = @p_grp
			    and case when fm_day<>0 then fm_day else @day_order end <=@day_order
			    and case when to_day<>0 then to_day else @day_order end >=@day_order
			    and case when @day_order=1 and @m_ndx=1 then d1_p1_ptg
			             when @day_order=1 and @m_ndx=2 then d1_p2_ptg
					     when @day_order=1 and @m_ndx=3 then d1_p3_ptg
					     when @day_order=2 and @m_ndx=1 then d2_p1_ptg
			             when @day_order=2 and @m_ndx=2 then d2_p2_ptg
					     when @day_order=2 and @m_ndx=3 then d2_p3_ptg
					     when @day_order=3 and @m_ndx=1 then d3_p1_ptg
			             when @day_order=3 and @m_ndx=2 then d3_p2_ptg
					     when @day_order=3 and @m_ndx=3 then d3_p3_ptg
					     when @day_order=4 and @m_ndx=1 then d4_p1_ptg
			             when @day_order=4 and @m_ndx=2 then d4_p2_ptg
					     when @day_order=4 and @m_ndx=3 then d4_p3_ptg
					     when @day_order=5 and @m_ndx=1 then d5_p1_ptg
			             when @day_order=5 and @m_ndx=2 then d5_p2_ptg
					     when @day_order=5 and @m_ndx=3 then d5_p3_ptg
					     when @day_order=6 and @m_ndx=1 then d6_p1_ptg
			             when @day_order=6 and @m_ndx=2 then d6_p2_ptg
					     when @day_order=6 and @m_ndx=1 then d6_p1_ptg
			             when @day_order=7 and @m_ndx=1 then d7_p1_ptg
					     when @day_order=7 and @m_ndx=2 then d7_p2_ptg
					     when @day_order=7 and @m_ndx=3 then d7_p3_ptg end >0
			    order by case when @day_order=1 and @m_ndx=1 then d1_p1_ptg
			                  when @day_order=1 and @m_ndx=2 then d1_p2_ptg
					          when @day_order=1 and @m_ndx=3 then d1_p3_ptg
					          when @day_order=2 and @m_ndx=1 then d2_p1_ptg
			                  when @day_order=2 and @m_ndx=2 then d2_p2_ptg
					          when @day_order=2 and @m_ndx=3 then d2_p3_ptg
					          when @day_order=3 and @m_ndx=1 then d3_p1_ptg
			                  when @day_order=3 and @m_ndx=2 then d3_p2_ptg
					          when @day_order=3 and @m_ndx=3 then d3_p3_ptg 
					          when @day_order=4 and @m_ndx=1 then d4_p1_ptg
			                  when @day_order=4 and @m_ndx=2 then d4_p2_ptg
					          when @day_order=4 and @m_ndx=3 then d4_p3_ptg
					          when @day_order=5 and @m_ndx=1 then d5_p1_ptg
			                  when @day_order=5 and @m_ndx=2 then d5_p2_ptg
					          when @day_order=5 and @m_ndx=3 then d5_p3_ptg
					          when @day_order=6 and @m_ndx=1 then d6_p1_ptg
			                  when @day_order=6 and @m_ndx=2 then d6_p2_ptg
					          when @day_order=6 and @m_ndx=1 then d6_p1_ptg
			                  when @day_order=7 and @m_ndx=1 then d7_p1_ptg
					          when @day_order=7 and @m_ndx=2 then d7_p2_ptg
					          when @day_order=7 and @m_ndx=3 then d7_p3_ptg  end desc
      if @@rowcount<>0
	  begin
	    set @rtrn_value=case when @day_order=1 and @m_ndx=1 then @d1_p1_ptg
		                     when @day_order=1 and @m_ndx=2 then @d1_p2_ptg
							 when @day_order=1 and @m_ndx=3 then @d1_p3_ptg
					         when @day_order=2 and @m_ndx=1 then @d2_p1_ptg
			                 when @day_order=2 and @m_ndx=2 then @d2_p2_ptg
					         when @day_order=2 and @m_ndx=3 then @d2_p3_ptg
					         when @day_order=3 and @m_ndx=1 then @d3_p1_ptg
			                 when @day_order=3 and @m_ndx=2 then @d3_p2_ptg
					         when @day_order=3 and @m_ndx=3 then @d3_p3_ptg 
					         when @day_order=4 and @m_ndx=1 then @d4_p1_ptg
			                 when @day_order=4 and @m_ndx=2 then @d4_p2_ptg
					         when @day_order=4 and @m_ndx=3 then @d4_p3_ptg
					         when @day_order=5 and @m_ndx=1 then @d5_p1_ptg
			                 when @day_order=5 and @m_ndx=2 then @d5_p2_ptg
					         when @day_order=5 and @m_ndx=3 then @d5_p3_ptg
					         when @day_order=6 and @m_ndx=1 then @d6_p1_ptg
			                 when @day_order=6 and @m_ndx=2 then @d6_p2_ptg
					         when @day_order=6 and @m_ndx=1 then @d6_p1_ptg
			                 when @day_order=7 and @m_ndx=1 then @d7_p1_ptg
					         when @day_order=7 and @m_ndx=2 then @d7_p2_ptg
					         when @day_order=7 and @m_ndx=3 then @d7_p3_ptg end
	  end
     end

	return(@rtrn_value)
end






GO
/****** Object:  UserDefinedFunction [dbo].[get_emp_late_permition_minutes]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE function [dbo].[get_emp_late_permition_minutes](@m_emp char(6),@m_date Char(8),@m_worktype Char(2),@m_period_no char(1))
returns smallint as
begin
   declare @continue_checking bit=0,@m_ndx int=0,@rtrn_value smallint=0
   declare @timing_1 char(2),@timing_2 char(2),@timing_3 char(2),
           @x_timing_1_minutes smallint,@x_timing_2_minutes smallint,@x_timing_3_minutes smallint

   set @rtrn_value=0
   set @continue_checking=1
   If @m_emp='' Or @m_date='' or @m_worktype='  '
      set @continue_checking=0
   if @continue_checking=1
   begin
	 set @m_ndx=0
	 if @m_period_no in ('1','2','3')
	    set @m_ndx=CAST(@m_period_no as int)      
	 if @m_ndx=0
	 begin
	   set @continue_checking=0
	   select @timing_1=timing_1,@timing_2=timing_2,@timing_3=timing_3 from ppemp where empno=@m_emp
	   if @@rowcount<>0
	   begin
		 if ISNULL(@timing_1,' ')=@m_worktype
			set @m_ndx=1
		 if ISNULL(@timing_2,' ')=@m_worktype
			set @m_ndx=2
		 if ISNULL(@timing_3,' ')=@m_worktype
			set @m_ndx=3
		end
		if @m_ndx in (1,2,3)
		   set @continue_checking=1
	   end
	 end
     if @continue_checking=1 and @m_ndx in (1,2,3)
	 begin   
	  set @continue_checking=0
	  select @x_timing_1_minutes=timing_1_minutes,@x_timing_2_minutes=timing_2_minutes,
	         @x_timing_3_minutes=timing_3_minutes from pp_emp_late_permissions 
			 where empcode=@m_emp and work_date=@m_date
      if @@rowcount<>0
	  begin
		if @m_ndx=1
		   set @rtrn_value=ISNULL(@x_timing_1_minutes,CAST(0 as smallint))
		if @m_ndx=2
		   set @rtrn_value=ISNULL(@x_timing_2_minutes,CAST(0 as smallint))
		if @m_ndx=3
		   set @rtrn_value=ISNULL(@x_timing_3_minutes,CAST(0 as smallint))
	  end
     end

	 return(@rtrn_value)
end






GO
/****** Object:  UserDefinedFunction [dbo].[get_last_ref]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [dbo].[get_last_ref](@ltype char(2),@lcmp char(2))
RETURNS int AS
BEGIN
	DECLARE @lref int 
	declare @tmpv int
	if @ltype='02' 
	begin
		select @lref=jv_02 from stbranch where brnno=@lcmp
	end
	if @ltype='04' 
	begin
		select @lref=jv_04 from stbranch where brnno=@lcmp
	end
	if @ltype='06' 
	begin
		select @lref=jv_06 from stbranch where brnno=@lcmp
	end
	if @ltype='26' 
	begin
		select @lref=jv_26 from stbranch where brnno=@lcmp
	end
	if @ltype='24' 
	begin
		select @lref=jv_24 from stbranch where brnno=@lcmp
	end
	if @ltype='01' 
	begin
		select @lref=jv_01 from stbranch where brnno=@lcmp
	end
	if @ltype='20' 
	begin
		select @lref=jv_20 from stbranch where brnno=@lcmp
	end
	if @ltype='17' 
	begin
		select @lref=jv_17 from stbranch where brnno=@lcmp
	end
	if @ltype='18' -- st receive 01
	begin
		select @lref=jv_18 from stbranch where brnno=@lcmp
	end
	if @ltype='34' 
	begin
		select @lref=jv_34 from stbranch where brnno=@lcmp
	end
	if @ltype='46' 
	begin
		select @lref=jv_46 from stbranch where brnno=@lcmp
	end
	set @lref=iif(isnull(@lref,0)=0,1,@lref) 
	if @ltype in ('04','06','24','26','01','17','02')
	begin
		if @ltype in ('04','06','26','24')
		begin
			while 1=1
			begin
				set @tmpv=0  -- it is very important to have this line inside the loop
				select @tmpv=ref from sales_hd where company=@lcmp and invtype=@ltype and ref=@lref
				if isnull(@tmpv,0)>0 set @lref=@lref+1
				else break
			end	
		end
		while 1=1
		begin
			set @tmpv=0   -- it is very important to have this line inside the loop
			select @tmpv=jhref from gljrhdr where jhcomp=@lcmp and jhtype=@ltype and jhref=@lref
			if isnull(@tmpv,0)>0 set @lref=@lref+1
			else break
		end 
	end
	else
	if  @ltype in ('18','20','46')
	begin
	    
		while 1=1
		begin
			set @tmpv=0  -- it is very important to have this line inside the loop
			select @tmpv=ref from sthdr where branch=@lcmp and trtype=@ltype and ref=@lref
			if isnull(@tmpv,0)>0 set @lref=@lref+1
			else break
		end		
	end	
	else
	begin
	    
		while 1=1
		begin
			set @tmpv=0  -- it is very important to have this line inside the loop
			select @tmpv=ref from ord_hdr where company=@lcmp  and ref=@lref
			if isnull(@tmpv,0)>0 set @lref=@lref+1
			else break
		end			
	end					  
	return @lref
END
 











GO
/****** Object:  UserDefinedFunction [dbo].[get_last_ref_section]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2022-05-16@@$$##  Important : must have this line as first line which contains the last update date for the this file 

CREATE FUNCTION [dbo].[get_last_ref_section](@ltype char(2),@lcmp char(2),@lsectionID char(6))
RETURNS int AS
BEGIN
	DECLARE @lref int 
	declare @tmpv int
	if @ltype='04' 
	begin
		select @lref=jv_04 from glsction where sc_company=@lcmp and sc_code=@lsectionID
	end
	if @ltype='06' 
	begin
		select @lref=isnull(jv_06,1) from glsction where sc_company=@lcmp and sc_code=@lsectionID
	end
	if @ltype='26' 
	begin
		select @lref=isnull(jv_26,1) from glsction where sc_company=@lcmp and sc_code=@lsectionID
	end
	if @ltype='01' 
	begin
		select @lref=isnull(jv_01,1) from glsction where sc_company=@lcmp and sc_code=@lsectionID
	end
	if @ltype='20' 
	begin
		select @lref=jv_20 from glsction where sc_company=@lcmp and sc_code=@lsectionID
	end
	if @ltype='17' 
	begin
		select @lref=isnull(jv_17,1) from glsction where sc_company=@lcmp and sc_code=@lsectionID
	end
	if @ltype='18' -- st receive 01
	begin
		select @lref=jv_18 from glsction where sc_company=@lcmp and sc_code=@lsectionID
	end
	if @ltype='34' 
	begin
		select @lref=jv_34 from glsction where sc_company=@lcmp and sc_code=@lsectionID
	end
	set @lref=iif(isnull(@lref,0)=0,1,@lref) 
	if @ltype in ('04','06','26','01','17')
	begin
		if @ltype in ('04','06','26')
		begin
			while 1=1
			begin
				set @tmpv=0  -- it is very important to have this line inside the loop
				select @tmpv=ref from sales_hd where company=@lcmp and invtype=@ltype and ref=@lref
				if isnull(@tmpv,0)>0 set @lref=@lref+1
				else break
			end	
		end
		while 1=1
		begin
			set @tmpv=0   -- it is very important to have this line inside the loop
			select @tmpv=jhref from gljrhdr where jhcomp=@lcmp and jhtype=@ltype and jhref=@lref
			if isnull(@tmpv,0)>0 set @lref=@lref+1
			else break
		end 
	end
	else
	if  @ltype in ('18','20')
	begin
	    
		while 1=1
		begin
			set @tmpv=0  -- it is very important to have this line inside the loop
			select @tmpv=ref from sthdr where branch=@lcmp and trtype=@ltype and ref=@lref
			if isnull(@tmpv,0)>0 set @lref=@lref+1
			else break
		end		
	end	
	else
	begin
	    
		while 1=1
		begin
			set @tmpv=0  -- it is very important to have this line inside the loop
			select @tmpv=ref from ord_hdr where company=@lcmp  and ref=@lref
			if isnull(@tmpv,0)>0 set @lref=@lref+1
			else break
		end			
	end					  
	return @lref
END
 


GO
/****** Object:  UserDefinedFunction [dbo].[half_day_cut]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE function [dbo].[half_day_cut](@m_emp char(6),@m_date Char(8),@am_1_pm_2 Char(1),@cut_minutes int,@m_f_day_cut bit)
returns int as
begin
	 declare @aply_half bit=0,@rtrn_value Int=0
	 declare @sat char(1),@sun char(1),@mon char(1),@tue char(1),@wed char(1),@thu char(1),@fri char(1),
			 @pos_whours numeric(4,2),@tmp_day_name char(3)

	 set @rtrn_value=@cut_minutes
	 set @aply_half=1
	 If @m_emp='' Or @m_date='' or @am_1_pm_2='' Or @am_1_pm_2 not in ('1','2')
		set @aply_half=0
 
	 if @aply_half=1
	 begin
		 set @aply_half=0
		 select @sat=sat,@sun=sun,@mon=mon,@tue=tue,@wed=wed,@thu=thu,@fri=fri,@pos_whours=pos_whours
				from ppemp where empno=@m_emp
		 if @@rowcount<>0
		 begin	    
			set @tmp_day_name=substring(DATENAME(dw,@m_date),1,3)
			set @aply_half=0
			IF @tmp_day_name='Sat'
			   if (@sat in ('2','3') and @m_f_day_cut=0) or @sat='1'
				  set @aply_half=1
			IF @tmp_day_name='Sun'
			   if (@sun in ('2','3') and @m_f_day_cut=0) or @sun='1'
				  set @aply_half=1
			IF @tmp_day_name='Mon'
			   if (@mon in ('2','3') and @m_f_day_cut=0) or @mon='1'
				  set @aply_half=1
			IF @tmp_day_name='Tue'
			   if (@tue in ('2','3') and @m_f_day_cut=0) or @tue='1'
				  set @aply_half=1
			IF @tmp_day_name='Wed'
			   if (@wed in ('2','3') and @m_f_day_cut=0) or @wed='1'
				  set @aply_half=1
			IF @tmp_day_name='Thu'
			   if (@thu in ('2','3') and @m_f_day_cut=0) or @thu='1'
				  set @aply_half=1	     
			IF @tmp_day_name='Fri'
			   if (@fri in ('2','3') and @m_f_day_cut=0) or @fri='1'
				  set @aply_half=1	     
		 end
     end
	 if @aply_half=1	   
	    set @rtrn_value=(@pos_whours*60)/2

	return(@rtrn_value)
end






GO
/****** Object:  UserDefinedFunction [dbo].[is_any_character_small_Caps]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2022-07-23@@$$##  Important : must have this line as first line which contains the last update date for the this file
create function [dbo].[is_any_character_small_Caps](@String varchar(500))
returns int   --Position Of The Character That Is small
as
begin
   declare @return int=0  --initial no small character
   declare @position int

   set @position = 1

   while @position <= datalength(@string)
   begin
       if ascii(substring(@string, @position,1)) between 97 and 122 --Means This Is A Small Letter
           set @return = @position
       else
           set @return = 0

       if @Return = 0
           set @position = @position + 1
       else
           goto exit_function
   end

   exit_function:
   return @return
end


GO
/****** Object:  UserDefinedFunction [dbo].[is_emp_abs_permitted]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE function [dbo].[is_emp_abs_permitted](@m_emp char(6),@m_date Char(8),@m_worktype Char(2),@m_period_no char(1))
returns bit as
begin
   declare @continue_checking bit=0,@m_ndx int=0,@rtrn_value bit=0
   declare @timing_1 char(2),@timing_2 char(2),@timing_3 char(2),
           @timing_1_permitted bit,@timing_2_permitted bit,@timing_3_permitted bit

   set @rtrn_value=0
   set @continue_checking=1
   If @m_emp='' Or @m_date='' or @m_worktype='  '
      set @continue_checking=0
   if @continue_checking=1
   begin
	 set @m_ndx=0
	 if @m_period_no in ('1','2','3')
	    set @m_ndx=CAST(@m_period_no as int)      
	 if @m_ndx=0
	 begin
	   set @continue_checking=0
	   select @timing_1=timing_1,@timing_2=timing_2,@timing_3=timing_3 from ppemp where empno=@m_emp
	   if @@rowcount<>0
	   begin
		 if ISNULL(@timing_1,' ')=@m_worktype
			set @m_ndx=1
		 if ISNULL(@timing_2,' ')=@m_worktype
			set @m_ndx=2
		 if ISNULL(@timing_3,' ')=@m_worktype
			set @m_ndx=3
		end
		if @m_ndx in (1,2,3)
		   set @continue_checking=1
	   end
	 end
     if @continue_checking=1 and @m_ndx in (1,2,3)
	 begin   
	  set @continue_checking=0
	  select @timing_1_permitted=timing_1_permitted,@timing_2_permitted=timing_2_permitted,
	         @timing_3_permitted=timing_3_permitted from pp_abs_permissions 
			 where empcode=@m_emp and work_date=@m_date
      if @@rowcount<>0
	  begin
		if @m_ndx=1
		   if ISNULL(@timing_1_permitted,CAST(0 as bit))=1
		      set @rtrn_value=1
		if @m_ndx=2
		   if ISNULL(@timing_2_permitted,CAST(0 as bit))=1
		      set @rtrn_value=1
		if @m_ndx=1
		   if ISNULL(@timing_3_permitted,CAST(0 as bit))=1
		      set @rtrn_value=1     
	  end
     end

	 return(@rtrn_value)
end






GO
/****** Object:  UserDefinedFunction [dbo].[is_emp_late_permitted]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE function [dbo].[is_emp_late_permitted](@m_emp char(6),@m_date Char(8),@m_worktype Char(2),@m_period_no char(1))
returns bit as
begin
   declare @continue_checking bit=0,@m_ndx int=0,@rtrn_value bit=0
   declare @timing_1 char(2),@timing_2 char(2),@timing_3 char(2),@m_dept char(2),@m_grp char(2),@day_order int,
           @m_prd_pctg char(10),
           @d1_p1_ok bit,@d1_p2_ok bit,@d1_p3_ok bit,
		   @d2_p1_ok bit,@d2_p2_ok bit,@d2_p3_ok bit,
		   @d3_p1_ok bit,@d3_p2_ok bit,@d3_p3_ok bit,
		   @d4_p1_ok bit,@d4_p2_ok bit,@d4_p3_ok bit,
		   @d5_p1_ok bit,@d5_p2_ok bit,@d5_p3_ok bit,
		   @d6_p1_ok bit,@d6_p2_ok bit,@d6_p3_ok bit,
		   @d7_p1_ok bit,@d7_p2_ok bit,@d7_p3_ok bit
   set @rtrn_value=0
   set @continue_checking=1
   If @m_emp='' Or @m_date='' or @m_worktype='  '
      set @continue_checking=0
   if @continue_checking=1
   begin
	 set @m_ndx=0
	 if @m_period_no in ('1','2','3')
	    set @m_ndx=CAST(@m_period_no as int)      

	 select @timing_1=timing_1,@timing_2=timing_2,@timing_3=timing_3,@m_dept=deptcode,@m_grp=adds_id 
	    from ppemp where empno=@m_emp

	 if @m_ndx=0
	 begin
	   set @continue_checking=0
	   select @timing_1=timing_1,@timing_2=timing_2,@timing_3=timing_3,@m_dept=deptcode,@m_grp=adds_id 
	      from ppemp where empno=@m_emp
	   if @@rowcount<>0
	   begin
		 if ISNULL(@timing_1,' ')=@m_worktype
			set @m_ndx=1
		 if ISNULL(@timing_2,' ')=@m_worktype
			set @m_ndx=2
		 if ISNULL(@timing_3,' ')=@m_worktype
			set @m_ndx=3
		end
		if @m_ndx in (1,2,3)
		   set @continue_checking=1
	 end
   end     

   if @continue_checking=1 and @m_ndx in (1,2,3)
   begin   
	  set @day_order=DATEPART(W,@m_date)+1
	  set @continue_checking=0
	  select @d1_p1_ok=d1_p1_ok,@d1_p2_ok=d1_p2_ok,@d1_p3_ok=d1_p3_ok,
		     @d2_p1_ok=d2_p1_ok,@d2_p2_ok=d2_p2_ok,@d2_p3_ok=d2_p3_ok,
		     @d3_p1_ok=d3_p1_ok,@d3_p2_ok=d3_p2_ok,@d3_p3_ok=d3_p3_ok,
	         @d4_p1_ok=d4_p1_ok,@d4_p2_ok=d4_p2_ok,@d4_p3_ok=d4_p3_ok,
		     @d5_p1_ok=d5_p1_ok,@d5_p2_ok=d5_p2_ok,@d5_p3_ok=d5_p3_ok,
		     @d6_p1_ok=d6_p1_ok,@d6_p2_ok=d6_p2_ok,@d6_p3_ok=d6_p3_ok,
		     @d7_p1_ok=d7_p1_ok,@d7_p2_ok=d7_p2_ok,@d7_p3_ok=d7_p3_ok
		from pp_late_permissions where fm_date<=@m_date and to_date>=@m_date 
		and case when dept<>'' then dept else @m_dept end = @m_dept
		and case when grp<>'' then grp else @m_grp end = @m_grp
		and case when fm_day<>0 then fm_day else @day_order end <=@day_order
		and case when to_day<>0 then to_day else @day_order end >=@day_order
      if @@rowcount<>0
	  begin
	    set @rtrn_value=case when @day_order=1 and @m_ndx=1 then @d1_p1_ok
		                     when @day_order=1 and @m_ndx=2 then @d1_p2_ok
							 when @day_order=1 and @m_ndx=3 then @d1_p3_ok
					         when @day_order=2 and @m_ndx=1 then @d2_p1_ok
			                 when @day_order=2 and @m_ndx=2 then @d2_p2_ok
					         when @day_order=2 and @m_ndx=3 then @d2_p3_ok
					         when @day_order=3 and @m_ndx=1 then @d3_p1_ok
			                 when @day_order=3 and @m_ndx=2 then @d3_p2_ok
					         when @day_order=3 and @m_ndx=3 then @d3_p3_ok 
					         when @day_order=4 and @m_ndx=1 then @d4_p1_ok
			                 when @day_order=4 and @m_ndx=2 then @d4_p2_ok
					         when @day_order=4 and @m_ndx=3 then @d4_p3_ok
					         when @day_order=5 and @m_ndx=1 then @d5_p1_ok
			                 when @day_order=5 and @m_ndx=2 then @d5_p2_ok
					         when @day_order=5 and @m_ndx=3 then @d5_p3_ok
					         when @day_order=6 and @m_ndx=1 then @d6_p1_ok
			                 when @day_order=6 and @m_ndx=2 then @d6_p2_ok
					         when @day_order=6 and @m_ndx=3 then @d6_p3_ok
			                 when @day_order=7 and @m_ndx=1 then @d7_p1_ok
					         when @day_order=7 and @m_ndx=2 then @d7_p2_ok
					         when @day_order=7 and @m_ndx=3 then @d7_p3_ok end
	  end
   end

   return(@rtrn_value)
end





GO
/****** Object:  UserDefinedFunction [dbo].[is_period_off_for_employee]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE function [dbo].[is_period_off_for_employee](@m_emp char(6),@m_date Char(8),@am_1_pm_2 Char(1),
                                                  @emp_day_work Char(1),@m_ok_off_day_attendance bit)
returns bit as
begin
 declare @continue_checking bit=0,@rtrn_value bit=0
 declare @sat char(1),@sun char(1),@mon char(1),@tue char(1),@wed char(1),@thu char(1),@fri char(1),
         @tmp_day_name char(3),@tgt_day_work Char(1)

 set @rtrn_value=0
 set @continue_checking=1
 If @m_emp='' Or @m_date='' or @am_1_pm_2='' Or @am_1_pm_2 not in ('1','2')
    set @continue_checking=0
 
 if @continue_checking=1
 begin
    set @tgt_day_work=isnull(@emp_day_work,'')
	if @tgt_day_work=''
    begin
      set @continue_checking=0
	  select @sat=sat,@sun=sun,@mon=mon,@tue=tue,@wed=wed,@thu=thu,@fri=fri from ppemp where empno=@m_emp
      if @@rowcount<>0
	  begin
		set @tmp_day_name=substring(DATENAME(dw,@m_date),1,3)
        set @continue_checking=0
		IF @tmp_day_name='Sat'
		   set @tgt_day_work=@sat	     
		IF @tmp_day_name='Sun'
		   set @tgt_day_work=@sat	     
		IF @tmp_day_name='Mon'
		   set @tgt_day_work=@sat	     
		IF @tmp_day_name='Tue'
		   set @tgt_day_work=@sat	     
		IF @tmp_day_name='Wed'
		   set @tgt_day_work=@sat	     
		IF @tmp_day_name='Thu'
		   set @tgt_day_work=@sat	     
		IF @tmp_day_name='Fri'
		   set @tgt_day_work=@sat	     
	  end

	  if @tgt_day_work<>''
	     set @continue_checking=1    
	end
 end 
 if @continue_checking=1 and @tgt_day_work<>''
 begin
	if @am_1_pm_2='1'
	begin 
	  if @tgt_day_work in ('4','3')
	     set @rtrn_value=1
	end
	else
	begin
	  if @tgt_day_work in ('4','2')
	     set @rtrn_value=1	      
	end

	if isnull(@emp_day_work,'')<>''
	begin
	  if @rtrn_value=0
	  begin
		if @am_1_pm_2='1'
		begin 
		  if @tgt_day_work in ('4','3') and isnull(@m_ok_off_day_attendance,cast(0 as bit))=1
			 set @rtrn_value=1
		end
		else
		begin
		  if @tgt_day_work in ('4','2') and isnull(@m_ok_off_day_attendance,cast(0 as bit))=1
			 set @rtrn_value=1	      
		end
	  end
	end

 end

 return(@rtrn_value)
end






GO
/****** Object:  UserDefinedFunction [dbo].[must_calc_time_fm_attendance]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE function [dbo].[must_calc_time_fm_attendance](@m_emp char(6),@m_date Char(8),@am_1_pm_2 Char(1),
                                                     @emp_day_work Char(1),@m_ok_off_day_attendance bit)
returns bit as
begin
 declare @continue_checking bit=0,@rtrn_value bit=0
 declare @sat char(1),@sun char(1),@mon char(1),@tue char(1),@wed char(1),@thu char(1),@fri char(1),
         @tmp_day_name char(3),@tgt_day_work Char(1)

 set @rtrn_value=0
 set @continue_checking=1
 If @m_emp='' Or @m_date='' or @am_1_pm_2='' Or @am_1_pm_2 not in ('1','2')
    set @continue_checking=0
 
 if @continue_checking=1
 begin
    set @tgt_day_work=isnull(@emp_day_work,'')
	if @tgt_day_work=''
    begin
      set @continue_checking=0
	  select @sat=sat,@sun=sun,@mon=mon,@tue=tue,@wed=wed,@thu=thu,@fri=fri from ppemp where empno=@m_emp
      if @@rowcount<>0
	  begin
		set @tmp_day_name=substring(DATENAME(dw,@m_date),1,3)
        set @continue_checking=0
		IF @tmp_day_name='Sat'
		   set @tgt_day_work=@sat	     
		IF @tmp_day_name='Sun'
		   set @tgt_day_work=@sat	     
		IF @tmp_day_name='Mon'
		   set @tgt_day_work=@sat	     
		IF @tmp_day_name='Tue'
		   set @tgt_day_work=@sat	     
		IF @tmp_day_name='Wed'
		   set @tgt_day_work=@sat	     
		IF @tmp_day_name='Thu'
		   set @tgt_day_work=@sat	     
		IF @tmp_day_name='Fri'
		   set @tgt_day_work=@sat	     
	  end
      
	  if @tgt_day_work<>''
	     set @continue_checking=1
	end
 end 
 if @continue_checking=1 and @tgt_day_work<>''
 begin
	if @am_1_pm_2='1'
	begin 
	  if @tgt_day_work not in ('4','3')
	     set @rtrn_value=1
	end
	else
	begin
	  if @tgt_day_work not in ('4','2')
	     set @rtrn_value=1	      
	end
 
 	if isnull(@emp_day_work,'')<>''
	begin
	  if @rtrn_value=0
	  begin
		if @am_1_pm_2='1'
		begin 
		  if @tgt_day_work in ('4','3') and isnull(@m_ok_off_day_attendance,cast(0 as bit))=1
			 set @rtrn_value=1
		end
		else
		begin
		  if @tgt_day_work in ('4','2') and isnull(@m_ok_off_day_attendance,cast(0 as bit))=1
			 set @rtrn_value=1	      
		end
	  end
	end
 
 end  
 return(@rtrn_value)
end






GO
/****** Object:  UserDefinedFunction [dbo].[value_balanced]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [dbo].[value_balanced](@lval1 float,@lval2 float)
RETURNS bit AS
BEGIN
  declare @llmatched bit=0,
          @f_val char(3)='',
		  @l_dif varchar(50),
		  @l_pos int =0,
		  @nval1 numeric(20,5),
		  @nval2 numeric(20,5),
		  @x_dif  numeric(20,5)

		  set @nval1=cast(@lval1 as numeric(20,5))
		  set @nval2=cast(@lval2 as numeric(20,5))

		  set @x_dif=abs(@nval1-@nval2)
		  if @x_dif=0
		  begin
		    set @llmatched=1
			return @llmatched
	      end
		  else
		  if @x_dif>=1
		  begin
		    set @llmatched=0
			return @llmatched		     
		  end
		  set @l_dif=format(@x_dif,'G')
		  set @l_pos=charindex('.',	@l_dif)
		  if @l_pos>0  set @f_val=substring(@l_dif,@l_pos+1,3);
	      set @llmatched=iif(@f_val='000',1,0)
	return @llmatched
END
 















GO
/****** Object:  Table [dbo].[apclass]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[apclass](
	[cl_company] [char](2) NOT NULL,
	[cl_code] [char](2) NOT NULL,
	[cl_desc] [varchar](50) NOT NULL,
	[cl_crlser] [char](19) NOT NULL,
	[cl_dscser] [char](19) NOT NULL,
	[cl_salser] [char](19) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[modified] [bit] NOT NULL,
	[cl_ldesc] [varchar](50) NOT NULL,
	[rowguid] [uniqueidentifier] ROWGUIDCOL  NOT NULL,
	[cstcode] [char](4) NULL,
	[classkey] [char](2) NULL,
 CONSTRAINT [PK_apclass] PRIMARY KEY CLUSTERED 
(
	[cl_company] ASC,
	[cl_code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[apdtl]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[apdtl](
	[dt_company] [char](2) NOT NULL,
	[dt_type] [char](2) NOT NULL,
	[dt_ref] [numeric](6, 0) NOT NULL,
	[dt_date] [char](8) NOT NULL,
	[dt_lcamt] [float] NOT NULL,
	[dt_paidamt] [float] NOT NULL,
	[dt_discamt] [float] NOT NULL,
	[dt_cucode] [char](6) NOT NULL,
	[dt_fcy] [char](3) NOT NULL,
	[dt_trxsrc] [char](2) NOT NULL,
	[dt_fcamt] [float] NOT NULL,
	[dt_fpydamt] [float] NOT NULL,
	[dt_fdscamt] [float] NOT NULL,
	[dt_lcaloc] [float] NOT NULL,
	[dt_fcaloc] [float] NOT NULL,
	[dt_aloctd] [char](1) NOT NULL,
	[dt_pdinv] [numeric](6, 0) NOT NULL,
	[dt_duedate] [char](8) NOT NULL,
	[dt_desc] [varchar](70) NOT NULL,
	[dt_chkno] [char](8) NOT NULL,
	[dt_chkdate] [char](8) NOT NULL,
	[dt_chkbnk] [char](2) NOT NULL,
	[dt_dbcr] [char](1) NOT NULL,
	[dt_ackey] [char](19) NOT NULL,
	[dt_folio] [numeric](4, 0) NOT NULL,
	[dt_rcvno] [numeric](6, 0) NOT NULL,
	[dt_lstdate] [char](8) NOT NULL,
	[tdscdays] [numeric](3, 0) NULL,
	[tdscpcs] [numeric](5, 2) NOT NULL,
	[match] [bit] NOT NULL,
	[rplct_post] [bit] NULL,
	[rowguid] [uniqueidentifier] ROWGUIDCOL  NOT NULL,
 CONSTRAINT [PK_apdtl] PRIMARY KEY CLUSTERED 
(
	[dt_company] ASC,
	[dt_type] ASC,
	[dt_ref] ASC,
	[dt_folio] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[aphdr]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[aphdr](
	[hd_company] [char](2) NOT NULL,
	[hd_type] [char](2) NOT NULL,
	[hd_ref] [numeric](6, 0) NOT NULL,
	[hd_date] [char](8) NOT NULL,
	[hd_fcy] [char](3) NOT NULL,
	[hd_ftotal] [float] NOT NULL,
	[hd_fcyrate] [float] NULL,
	[hd_ltotal] [float] NOT NULL,
	[hd_cucode] [char](6) NOT NULL,
	[hd_desc1] [varchar](70) NOT NULL,
	[hd_ser] [char](19) NOT NULL,
	[hd_rlsd] [bit] NOT NULL,
	[hd_posted] [bit] NOT NULL,
	[hd_trxsrc] [char](2) NOT NULL,
	[hd_sysdate] [char](8) NOT NULL,
	[hd_lcnet] [float] NOT NULL,
	[hd_fcnet] [float] NOT NULL,
	[hd_lccnet] [float] NOT NULL,
	[hd_fccnet] [float] NOT NULL,
	[isit_opst] [bit] NOT NULL,
	[opst_val] [float] NOT NULL,
	[opst_fcy] [char](3) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[modified] [bit] NOT NULL,
	[rcvdtrn] [bit] NOT NULL,
	[usrid] [char](10) NOT NULL,
	[clcode] [char](2) NOT NULL,
	[clcmnd] [bit] NOT NULL,
	[dscamt] [float] NOT NULL,
	[payinv] [bit] NOT NULL,
	[rowguid] [uniqueidentifier] ROWGUIDCOL  NOT NULL,
	[bankref] [char](20) NULL,
 CONSTRAINT [PK_aphdr] PRIMARY KEY CLUSTERED 
(
	[hd_company] ASC,
	[hd_type] ASC,
	[hd_ref] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[aplcrmt_dt]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[aplcrmt_dt](
	[cu_company] [char](2) NOT NULL,
	[cu_code] [char](6) NOT NULL,
	[cf_fcy] [char](3) NOT NULL,
	[cu_name] [varchar](50) NULL,
	[stkopenbal] [float] NULL,
	[punet] [float] NULL,
	[pubfr1m] [float] NULL,
	[runbal] [float] NULL,
	[salescost] [float] NULL,
	[wval] [float] NULL,
	[profit] [float] NULL,
	[pubfr2m] [float] NULL,
	[pubfr3m] [float] NULL,
	[pubfr4m] [float] NULL,
	[pprcnt] [float] NULL,
	[diffbal] [float] NULL,
	[lstpaiddate] [char](8) NULL,
	[classname] [char](20) NULL,
	[lstpayment] [numeric](12, 2) NULL,
	[pselected] [bit] NULL,
	[refno] [numeric](6, 0) NULL,
	[cu_opnbal] [float] NULL,
	[mgroup] [char](2) NULL,
	[cu_class] [char](2) NULL,
	[usrid] [char](10) NULL,
	[ref_id] [int] NOT NULL,
	[trdate] [char](8) NULL,
	[bname] [varchar](60) NULL,
	[bbkacct] [varchar](60) NULL,
	[bbank] [varchar](50) NULL,
	[extradsc] [numeric](12, 2) NULL,
	[desctxt] [varchar](60) NULL,
	[venderbal] [float] NULL,
	[diffbal2] [float] NULL,
	[cnfdate] [char](8) NULL,
	[usrcnf] [char](10) NULL,
	[adjval] [float] NULL,
 CONSTRAINT [PK_aplcrmt_dt_1] PRIMARY KEY CLUSTERED 
(
	[cu_company] ASC,
	[cu_code] ASC,
	[cf_fcy] ASC,
	[ref_id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[arch_offers_dt]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[arch_offers_dt](
	[company] [char](2) NOT NULL,
	[slcenter] [char](2) NOT NULL,
	[itemno] [char](16) NULL,
	[unicode] [char](6) NULL,
	[barcode] [char](20) NOT NULL,
	[DiscountP] [numeric](5, 2) NULL,
	[disctype] [char](1) NULL,
	[MinQty] [numeric](10, 3) NULL,
	[GivenAmt] [numeric](8, 2) NULL,
	[StartDate] [date] NULL,
	[EndDate] [date] NULL,
	[InActive] [bit] NULL,
	[lastupdt] [char](8) NULL,
	[Max2buy] [int] NULL,
	[lprice1] [numeric](11, 2) NULL,
	[itemgroup] [char](1) NULL,
	[refno] [int] NOT NULL,
 CONSTRAINT [PK_arch_offers_dt] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[slcenter] ASC,
	[refno] ASC,
	[barcode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[arch_offers_dt_sub]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[arch_offers_dt_sub](
	[company] [char](2) NOT NULL,
	[slcenter] [char](2) NOT NULL,
	[ms_barcode] [char](20) NOT NULL,
	[barcode] [char](20) NOT NULL,
	[price] [float] NULL,
	[givenqty] [float] NULL,
	[refno] [int] NOT NULL,
 CONSTRAINT [PK_arch_offers_dt_sub] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[slcenter] ASC,
	[refno] ASC,
	[ms_barcode] ASC,
	[barcode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[arch_offers_hd]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[arch_offers_hd](
	[company] [char](2) NOT NULL,
	[slcenter] [char](2) NOT NULL,
	[refno] [int] NOT NULL,
	[arch_date] [char](8) NULL,
	[arch_desc] [varchar](80) NULL,
	[usrid] [varchar](10) NULL,
	[lastupdt] [char](8) NULL,
	[entries] [int] NULL,
 CONSTRAINT [PK_arch_offers_hd] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[slcenter] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Archive_Attachments]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Archive_Attachments](
	[Company] [char](2) NOT NULL,
	[SystemType] [char](2) NOT NULL,
	[screentype] [tinyint] NOT NULL,
	[t_a_s_g_code] [varchar](50) NULL,
	[fcy_ref] [varchar](10) NULL,
	[FileGUID] [nvarchar](100) NOT NULL,
	[FileName] [nvarchar](200) NULL,
	[FileExtension] [nvarchar](20) NULL,
	[FileSize] [bigint] NULL,
	[UsrID] [char](10) NOT NULL,
	[CreateDate] [datetime] NOT NULL,
	[extname] [varchar](20) NULL,
 CONSTRAINT [PK_Archive_Data] PRIMARY KEY CLUSTERED 
(
	[Company] ASC,
	[FileGUID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ardtl]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ardtl](
	[dt_company] [char](2) NOT NULL,
	[dt_type] [char](2) NOT NULL,
	[dt_ref] [numeric](6, 0) NOT NULL,
	[dt_date] [char](8) NOT NULL,
	[dt_lcamt] [float] NULL,
	[dt_paidamt] [float] NULL,
	[dt_discamt] [float] NULL,
	[dt_cucode] [char](6) NOT NULL,
	[dt_fcy] [char](3) NOT NULL,
	[dt_trxsrc] [char](2) NOT NULL,
	[dt_fcamt] [float] NULL,
	[dt_fpydamt] [float] NULL,
	[dt_fdscamt] [float] NULL,
	[dt_lcaloc] [float] NULL,
	[dt_fcaloc] [float] NULL,
	[dt_aloctd] [char](1) NOT NULL,
	[dt_pdinv] [numeric](6, 0) NOT NULL,
	[dt_duedate] [char](8) NOT NULL,
	[dt_desc] [varchar](70) NOT NULL,
	[dt_chkno] [char](8) NOT NULL,
	[dt_chkdate] [char](8) NOT NULL,
	[dt_chkbnk] [char](2) NOT NULL,
	[dt_dbcr] [char](1) NOT NULL,
	[dt_ackey] [char](19) NOT NULL,
	[dt_folio] [numeric](3, 0) NOT NULL,
	[dt_rcvno] [numeric](6, 0) NOT NULL,
	[dt_lstdate] [char](8) NOT NULL,
	[tdscdays] [numeric](2, 0) NULL,
	[tdscpcs] [numeric](4, 2) NULL,
	[match] [bit] NOT NULL,
	[rplct_post] [bit] NULL,
 CONSTRAINT [PK_ardtl] PRIMARY KEY CLUSTERED 
(
	[dt_company] ASC,
	[dt_type] ASC,
	[dt_ref] ASC,
	[dt_folio] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[arhdr]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[arhdr](
	[hd_company] [char](2) NOT NULL,
	[hd_type] [char](2) NOT NULL,
	[hd_ref] [numeric](6, 0) NOT NULL,
	[hd_date] [char](8) NOT NULL,
	[hd_fcy] [char](3) NOT NULL,
	[hd_ftotal] [float] NULL,
	[hd_fcyrate] [float] NULL,
	[hd_ltotal] [float] NULL,
	[hd_cucode] [char](6) NOT NULL,
	[hd_desc1] [varchar](70) NOT NULL,
	[hd_ser] [char](19) NOT NULL,
	[hd_rlsd] [bit] NOT NULL,
	[hd_posted] [bit] NOT NULL,
	[hd_trxsrc] [char](2) NOT NULL,
	[hd_sysdate] [char](8) NOT NULL,
	[hd_lcnet] [float] NULL,
	[hd_fcnet] [float] NULL,
	[hd_lccnet] [float] NULL,
	[hd_fccnet] [float] NULL,
	[isit_opst] [bit] NOT NULL,
	[opst_val] [float] NULL,
	[opst_fcy] [char](3) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[modified] [bit] NOT NULL,
	[rcvdtrn] [bit] NOT NULL,
	[usrid] [char](10) NOT NULL,
	[clcode] [char](2) NOT NULL,
	[clcmnd] [bit] NOT NULL,
	[dscamt] [float] NULL,
	[payinv] [bit] NOT NULL,
	[discountedBill] [bit] NULL,
 CONSTRAINT [PK_arhdr] PRIMARY KEY CLUSTERED 
(
	[hd_company] ASC,
	[hd_type] ASC,
	[hd_ref] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[arReconciliation]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[arReconciliation](
	[branch] [char](2) NOT NULL,
	[refno] [int] NOT NULL,
	[trdate] [char](8) NULL,
	[custno] [char](6) NULL,
	[fcy] [char](3) NULL,
	[rcn_cust_bal] [float] NULL,
	[rcn_date] [char](8) NULL,
	[rcn_cust_emp] [varchar](50) NULL,
	[cu_title] [varchar](20) NULL,
	[usrid] [char](10) NULL,
	[usridchg] [char](10) NULL,
	[posted] [bit] NULL,
	[remarks] [varchar](70) NULL,
 CONSTRAINT [PK_arReconciliation_1] PRIMARY KEY CLUSTERED 
(
	[branch] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[bkacct]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[bkacct](
	[company] [char](2) NOT NULL,
	[bkcode] [char](2) NOT NULL,
	[actcode] [numeric](3, 0) NOT NULL,
	[bkbrname] [varchar](30) NULL,
	[actname] [varchar](35) NULL,
	[actno] [char](15) NULL,
	[glact] [char](19) NULL,
	[srlcode] [numeric](3, 0) NULL,
	[addrs] [varchar](40) NULL,
	[stopped] [bit] NULL,
	[autonm] [bit] NULL,
	[actlname] [varchar](35) NULL,
	[lastupdt] [char](8) NULL,
	[is_credit_card_acc] [bit] NULL,
	[cardcomm] [char](19) NULL,
	[sc_code] [char](6) NULL,
	[maxpkcntr] [numeric](1, 0) NULL,
	[maxcomm] [numeric](12, 3) NULL,
	[chrgprcnt1] [numeric](10, 5) NULL,
	[chrgprcnt2] [numeric](10, 5) NULL,
	[chrgprcnt3] [numeric](10, 5) NULL,
	[chrgprcnt4] [numeric](10, 5) NULL,
	[frmamt1] [numeric](14, 3) NULL,
	[frmamt2] [numeric](14, 3) NULL,
	[frmamt3] [numeric](14, 3) NULL,
	[frmamt4] [numeric](14, 3) NULL,
	[toamt1] [numeric](14, 3) NULL,
	[toamt2] [numeric](14, 3) NULL,
	[toamt3] [numeric](14, 3) NULL,
	[toamt4] [numeric](14, 3) NULL,
	[vat_comm_one_entry] [bit] NULL,
 CONSTRAINT [PK_bkacct] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[bkcode] ASC,
	[actcode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[bkbank]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[bkbank](
	[bkcode] [char](2) NOT NULL,
	[bkname] [varchar](30) NULL,
	[bklname] [varchar](30) NULL,
	[lastupdt] [char](8) NULL,
 CONSTRAINT [PK_bkbank] PRIMARY KEY CLUSTERED 
(
	[bkcode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[BKBNFCH]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[BKBNFCH](
	[BCOMPANY] [char](2) NOT NULL,
	[bcode] [char](6) NOT NULL,
	[bname] [varchar](60) NULL,
	[BSWIFT] [varchar](60) NULL,
	[BADDRS] [varchar](60) NULL,
	[BADDRS2] [varchar](60) NULL,
	[BBKACCT] [varchar](60) NULL,
	[BBANK] [varchar](50) NULL,
	[BBKADDRS] [varchar](60) NULL,
	[BBKCITY] [varchar](50) NULL,
	[BFRNR] [bit] NULL,
	[BCUSTNO] [char](6) NULL,
	[BGLACT] [char](19) NULL,
	[BFCY] [char](3) NULL,
	[lastupdt] [char](8) NULL,
	[bmemid] [char](20) NULL,
	[brepname] [char](40) NULL,
	[dscprsnt] [numeric](5, 2) NULL,
	[bactive] [bit] NULL,
 CONSTRAINT [PK_BKBNFCH] PRIMARY KEY CLUSTERED 
(
	[BCOMPANY] ASC,
	[bcode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[bkfile]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[bkfile](
	[bkcode] [char](2) NULL,
	[bkname] [varchar](50) NULL,
	[bkacc] [char](19) NULL,
	[bkser] [char](19) NULL,
	[lastupdt] [char](8) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[BKREMITER]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[BKREMITER](
	[rcode] [char](4) NOT NULL,
	[RNAME] [varchar](60) NULL,
	[RBKACCT] [varchar](60) NULL,
	[NATIONALITY] [varchar](50) NULL,
	[RIDCARD] [varchar](60) NULL,
	[RCARDISSUE] [varchar](50) NULL,
	[RADDRS] [varchar](60) NULL,
	[RPHONE] [varchar](60) NULL,
	[ROTHERS] [varchar](60) NULL,
	[RCOMPANY] [char](2) NULL,
	[RFRNR] [bit] NULL,
	[lastupdt] [char](8) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[bkserial]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[bkserial](
	[code] [numeric](3, 0) NULL,
	[bkcode] [char](2) NULL,
	[actcode] [numeric](3, 0) NULL,
	[company] [char](2) NULL,
	[startsrl] [numeric](10, 0) NULL,
	[endsrl] [numeric](10, 0) NULL,
	[cdate] [char](8) NULL,
	[cstatus] [bit] NULL,
	[srlptr] [numeric](10, 0) NULL,
	[chqsize] [bit] NULL,
	[lastupdt] [char](8) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[BKTRANSFER]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[BKTRANSFER](
	[refno] [numeric](6, 0) NOT NULL,
	[trtype] [numeric](1, 0) NOT NULL,
	[TRFORIGN] [bit] NULL,
	[TRDATE] [char](10) NULL,
	[TRBRNNO] [char](15) NULL,
	[TRFCY] [char](10) NULL,
	[TRAMOUNT] [float] NULL,
	[TPURPOSE] [numeric](1, 0) NULL,
	[TRCOMM] [numeric](13, 5) NULL,
	[COMPANY] [char](2) NULL,
	[TRTEXT] [varchar](50) NULL,
	[CTYPE] [numeric](1, 0) NULL,
	[TRFRNR] [bit] NULL,
	[BNAME] [varchar](60) NULL,
	[BSWIFT] [varchar](60) NULL,
	[BADDRS] [varchar](60) NULL,
	[BBKACCT] [varchar](60) NULL,
	[BBANK] [varchar](60) NULL,
	[BBKADDRS] [varchar](60) NULL,
	[BBKCITY] [varchar](60) NULL,
	[ACTNO] [varchar](50) NULL,
	[RNAME] [varchar](60) NULL,
	[RNATIONALITY] [varchar](50) NULL,
	[RIDCARD] [varchar](60) NULL,
	[RADDRS] [varchar](60) NULL,
	[RPHONE] [varchar](60) NULL,
	[ROTHERS] [varchar](60) NULL,
	[JVREF] [numeric](6, 0) NULL,
	[FCYRATE] [numeric](12, 6) NULL,
	[BCODE] [char](4) NULL,
	[GLBKACT] [char](19) NULL,
	[CUSTNO] [char](10) NULL,
	[GLKEY] [char](19) NULL,
	[GENJV] [bit] NULL,
	[USRID] [char](10) NULL,
	[DESC1] [varchar](50) NULL,
	[POSTED] [bit] NULL,
	[RELEASED] [bit] NULL,
	[BFCY] [char](3) NULL,
	[mgmtcnfrm] [numeric](1, 0) NULL,
	[mgmtnote] [varchar](100) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[bktransx]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[bktransx](
	[company] [char](2) NOT NULL,
	[trtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[cucode] [char](6) NULL,
	[glact] [char](19) NULL,
	[bkact] [char](19) NULL,
	[ctype] [numeric](1, 0) NULL,
	[amt] [numeric](12, 2) NULL,
	[trdate] [char](8) NULL,
	[chkdate] [char](8) NULL,
	[chkno] [numeric](10, 0) NULL,
	[bank] [char](2) NULL,
	[rcvname] [varchar](45) NULL,
	[bending] [bit] NULL,
	[xdesc] [varchar](70) NULL,
	[canceled] [bit] NULL,
	[actcode] [numeric](3, 0) NULL,
	[dtentry] [char](10) NULL,
	[fcy] [char](3) NULL,
	[posted] [bit] NULL,
	[released] [bit] NULL,
	[printed] [bit] NULL,
	[trxsrc] [char](2) NULL,
	[actno] [char](15) NULL,
	[cstname] [varchar](45) NULL,
	[chqwthd] [char](8) NULL,
	[chkdesc] [varchar](70) NULL,
	[fcyrate] [numeric](10, 5) NULL,
	[isit_opst] [bit] NULL,
	[opst_fcy] [char](3) NULL,
	[opst_val] [numeric](15, 4) NULL,
	[rcvdtrn] [bit] NULL,
	[hide_jv] [bit] NULL,
	[rcvno] [numeric](6, 0) NULL,
	[bcode] [char](6) NULL,
	[bal] [numeric](13, 3) NULL,
	[stk] [numeric](13, 3) NULL,
	[dscac] [char](19) NULL,
	[dscamt] [numeric](13, 3) NULL,
	[dscptg] [numeric](10, 3) NULL,
	[dscdesc] [varchar](70) NULL,
	[ptodate] [char](8) NULL,
	[mgmtcnfrm] [numeric](1, 0) NULL,
	[mgmtnote] [varchar](100) NULL,
 CONSTRAINT [PK_bktransx] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[trtype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[brselected]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[brselected](
	[name] [char](25) NULL,
	[brnno] [char](2) NULL,
	[selectd] [bit] NULL,
	[newbarcode] [bit] NULL,
	[priceupdt] [bit] NULL,
	[noupdate] [bit] NULL,
	[copydesc] [bit] NULL,
	[updateonlyitems] [bit] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[brxref]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[brxref](
	[keyglacc] [char](19) NOT NULL,
	[keycustno] [char](6) NOT NULL,
	[keybrno] [char](2) NOT NULL,
	[brxglacc] [char](19) NOT NULL,
	[brxcustno] [char](6) NOT NULL,
	[brxbrno] [char](2) NOT NULL,
	[brxwhno] [char](2) NOT NULL,
	[brxdept] [char](2) NOT NULL,
	[brxsys] [char](2) NOT NULL,
	[brxstatus] [bit] NOT NULL,
	[price_2_check] [numeric](1, 0) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[budctr]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[budctr](
	[bucntr] [char](4) NOT NULL,
	[bucomp] [char](2) NOT NULL,
	[buser] [char](19) NOT NULL,
	[bufcy] [char](3) NOT NULL,
	[xpercent] [numeric](5, 3) NULL,
	[lastupdt] [char](8) NOT NULL,
	[modified] [bit] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[budget]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[budget](
	[bucomp] [char](2) NOT NULL,
	[buser] [char](19) NOT NULL,
	[bufcy] [char](3) NOT NULL,
	[bubal01] [numeric](13, 2) NOT NULL,
	[bubal02] [numeric](13, 2) NOT NULL,
	[bubal03] [numeric](13, 2) NOT NULL,
	[bubal04] [numeric](13, 2) NOT NULL,
	[bubal05] [numeric](13, 2) NOT NULL,
	[bubal06] [numeric](13, 2) NOT NULL,
	[bubal07] [numeric](13, 2) NOT NULL,
	[bubal08] [numeric](13, 2) NOT NULL,
	[bubal09] [numeric](13, 2) NOT NULL,
	[bubal10] [numeric](13, 2) NOT NULL,
	[bubal11] [numeric](13, 2) NOT NULL,
	[bubal12] [numeric](13, 2) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[year_bgt] [numeric](13, 2) NOT NULL,
	[modified] [bit] NOT NULL,
 CONSTRAINT [PK_budget] PRIMARY KEY CLUSTERED 
(
	[bucomp] ASC,
	[buser] ASC,
	[bufcy] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[classfil]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[classfil](
	[cl_company] [char](2) NOT NULL,
	[cl_code] [char](2) NOT NULL,
	[cl_desc] [varchar](30) NOT NULL,
	[cl_crlser] [char](19) NOT NULL,
	[cl_dscser] [char](19) NOT NULL,
	[cl_salser] [char](19) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[modified] [bit] NOT NULL,
	[cl_ldesc] [varchar](30) NOT NULL,
	[cstcode] [char](4) NULL,
 CONSTRAINT [PK_classfil] PRIMARY KEY CLUSTERED 
(
	[cl_company] ASC,
	[cl_code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[colors_txtile]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[colors_txtile](
	[cl_code] [char](3) NOT NULL,
	[cl_name] [varchar](10) NULL,
	[cl_lname] [varchar](10) NULL,
 CONSTRAINT [PK_colors] PRIMARY KEY CLUSTERED 
(
	[cl_code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[customer]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[customer](
	[cu_name] [varchar](60) NOT NULL,
	[cu_company] [char](2) NOT NULL,
	[cu_code] [char](6) NOT NULL,
	[cu_class] [char](2) NOT NULL,
	[cu_addrs] [varchar](50) NOT NULL,
	[cu_tel] [varchar](30) NOT NULL,
	[cu_fax] [varchar](50) NOT NULL,
	[cu_tlx] [varchar](50) NOT NULL,
	[cu_email] [varchar](30) NOT NULL,
	[cu_cntactp] [varchar](50) NOT NULL,
	[cu_title] [varchar](50) NOT NULL,
	[cu_crlmt] [numeric](14, 2) NOT NULL,
	[cu_pymnt] [numeric](3, 0) NOT NULL,
	[cu_status] [numeric](1, 0) NOT NULL,
	[cu_opnbal] [float] NULL,
	[cu_curbal] [float] NULL,
	[cf_fcy] [char](3) NOT NULL,
	[cf_opnfcy] [float] NULL,
	[cf_curfcy] [float] NULL,
	[cu_xrf] [char](6) NOT NULL,
	[cu_alwcr] [bit] NOT NULL,
	[cu_ctlser] [char](19) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[cu_lcaloc] [float] NULL,
	[cu_fcaloc] [float] NULL,
	[cu_instlmnt] [numeric](11, 2) NOT NULL,
	[cu_instldays] [numeric](2, 0) NOT NULL,
	[cu_install] [bit] NOT NULL,
	[modified] [bit] NOT NULL,
	[cmncode] [char](8) NOT NULL,
	[cu_lname] [varchar](40) NOT NULL,
	[cu_city] [char](6) NOT NULL,
	[cu_type] [char](1) NOT NULL,
	[cu_laddrs] [varchar](50) NOT NULL,
	[cu_carrier] [char](3) NOT NULL,
	[cu_mobile] [varchar](50) NOT NULL,
	[section] [char](6) NULL,
	[cu_sendsms] [bit] NULL,
	[cu_onlycsh] [bit] NULL,
	[clnt_taxcode] [varchar](20) NULL,
	[taxFree] [bit] NULL,
	[cu_kind] [char](1) NULL,
	[ok_free] [bit] NULL,
	[ok_no_pay] [bit] NULL,
	[ok_no_down_payment] [bit] NULL,
	[exduplimit] [bit] NULL,
	[individual_clnt] [bit] NULL,
	[cu_invdsc] [numeric](7, 3) NULL,
	[slcode] [char](2) NULL,
	[lst_inv_excd_duedate] [bit] NULL,
	[usrid] [char](10) NULL,
	[usridchg] [char](10) NULL,
	[Added_date] [char](8) NULL,
	[location] [varchar](100) NULL,
 CONSTRAINT [PK_customer_1] PRIMARY KEY CLUSTERED 
(
	[cu_company] ASC,
	[cu_code] ASC,
	[cf_fcy] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[customer_ei]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[customer_ei](
	[cu_company] [char](2) NOT NULL,
	[cu_code] [varchar](20) NOT NULL,
	[cf_fcy] [char](3) NOT NULL,
	[district] [varchar](50) NULL,
	[district_l] [varchar](50) NULL,
	[city_text] [varchar](50) NULL,
	[city_text_l] [varchar](50) NULL,
	[country_code] [numeric](3, 0) NULL,
	[postal_code] [varchar](20) NULL,
	[Other_id_SchemeID] [varchar](20) NULL,
	[bldg_no] [varchar](50) NULL,
	[bldg_no_l] [varchar](50) NULL,
	[street_name] [varchar](50) NULL,
	[street_name_l] [varchar](50) NULL,
	[area_name] [varchar](50) NULL,
	[area_name_l] [varchar](50) NULL,
	[extra_address_no] [varchar](50) NULL,
	[extra_address_no_l] [varchar](50) NULL,
	[street_name2] [varchar](50) NULL,
	[street_name2_l] [varchar](50) NULL,
	[Group_VAT_ID] [varchar](30) NULL,
	[Other_Scheme_Type] [varchar](10) NULL,
	[client_name] [varchar](50) NULL,
	[client_mobile] [varchar](15) NULL,
	[country_text] [varchar](50) NULL,
	[country_text_l] [varchar](50) NULL,
 CONSTRAINT [PK_customer_ei] PRIMARY KEY CLUSTERED 
(
	[cu_company] ASC,
	[cu_code] ASC,
	[cf_fcy] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[customer_opn]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[customer_opn](
	[cu_autokey] [int] NOT NULL,
	[cu_rqstdate] [char](8) NOT NULL,
	[cu_rqstdateH] [char](8) NOT NULL,
	[cu_name] [varchar](40) NOT NULL,
	[cu_company] [char](2) NOT NULL,
	[cu_code] [char](6) NOT NULL,
	[cu_class] [char](2) NOT NULL,
	[cu_addrs] [varchar](50) NOT NULL,
	[cu_tel] [varchar](21) NOT NULL,
	[cu_fax] [varchar](10) NOT NULL,
	[cu_email] [varchar](30) NOT NULL,
	[cu_cntactp] [varchar](20) NOT NULL,
	[cu_title] [varchar](20) NOT NULL,
	[cu_crlmt] [numeric](14, 2) NOT NULL,
	[cu_pymnt] [numeric](3, 0) NOT NULL,
	[cu_status] [numeric](1, 0) NOT NULL,
	[cf_fcy] [char](3) NOT NULL,
	[cu_alwcr] [bit] NOT NULL,
	[cu_ctlser] [char](19) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[modified] [bit] NOT NULL,
	[cu_lname] [varchar](40) NOT NULL,
	[cu_city] [char](6) NOT NULL,
	[cu_type] [char](1) NOT NULL,
	[cu_laddrs] [varchar](50) NOT NULL,
	[cu_carrier] [char](3) NOT NULL,
	[cu_mobile] [varchar](21) NOT NULL,
	[section] [char](4) NULL,
	[cu_onlycsh] [bit] NULL,
	[cu_traderegno] [char](10) NOT NULL,
	[cu_traderegdt] [char](8) NOT NULL,
	[cu_govrn] [char](2) NOT NULL,
	[cu_city2] [char](2) NOT NULL,
	[cu_area] [varchar](20) NOT NULL,
	[cu_owner] [varchar](50) NOT NULL,
	[cu_ownernlty] [nchar](2) NULL,
	[cu_ownerID] [char](10) NOT NULL,
	[cu_ownerIDDT] [char](8) NULL,
	[cu_ownerADDress] [varchar](50) NULL,
	[cu_ownerTEL] [varchar](21) NULL,
	[cu_ownerFAX] [varchar](21) NULL,
	[cu_ownerMOBILe] [varchar](21) NULL,
	[cu_buyer1name] [varchar](50) NULL,
	[cu_buyer1ID] [varchar](10) NULL,
	[cu_buyer1nlty] [varchar](2) NULL,
	[cu_buyer1remarks] [varchar](50) NULL,
	[cu_buyer2name] [varchar](50) NULL,
	[cu_buyer2ID] [varchar](10) NULL,
	[cu_buyer2nlty] [varchar](2) NULL,
	[cu_buyer2remarks] [varchar](50) NULL,
	[cu_buyer3name] [varchar](50) NULL,
	[cu_buyer3ID] [varchar](10) NULL,
	[cu_buyer3nlty] [varchar](2) NULL,
	[cu_buyer3remarks] [varchar](50) NULL,
	[cu_vusername] [varchar](10) NULL,
	[cu_accepted] [bit] NULL,
	[cu_addedbefore] [bit] NULL,
 CONSTRAINT [PK_customer_opn] PRIMARY KEY CLUSTERED 
(
	[cu_autokey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[delchgdtl]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[delchgdtl](
	[slcenter] [char](2) NOT NULL,
	[company] [char](2) NOT NULL,
	[invtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[invdate] [char](8) NOT NULL,
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[qty] [float] NULL,
	[fqty] [float] NULL,
	[price] [float] NULL,
	[discpc] [float] NULL,
	[cost] [float] NOT NULL,
	[ds_acfm] [numeric](1, 0) NOT NULL,
	[sl_acfm] [numeric](1, 0) NOT NULL,
	[gclass] [char](12) NOT NULL,
	[custno] [char](6) NOT NULL,
	[fcy] [char](3) NOT NULL,
	[barcode] [char](20) NOT NULL,
	[imfcval] [float] NOT NULL,
	[pack] [char](1) NOT NULL,
	[pkqty] [float] NULL,
	[shadd] [char](1) NOT NULL,
	[shdpk] [float] NULL,
	[shdqty] [float] NULL,
	[frtqty] [float] NULL,
	[rtnqty] [float] NULL,
	[whno] [char](2) NOT NULL,
	[cmbkey] [char](24) NOT NULL,
	[trx_id] [int] NOT NULL,
	[jdtext] [varchar](110) NULL,
	[dbcr] [char](1) NULL,
	[src] [char](2) NULL,
	[fld1] [float] NULL,
	[fld2] [float] NULL,
	[acc] [char](19) NULL,
	[brxref] [numeric](6, 0) NULL,
	[match] [bit] NULL,
	[dt_duedate] [char](8) NULL,
	[dt_chkno] [char](8) NULL,
	[dt_chkdate] [char](8) NULL,
	[dt_lstdate] [char](8) NULL,
	[dt_folio] [numeric](5, 0) NULL,
	[tdscdays] [numeric](3, 0) NULL,
	[taxtype] [char](1) NULL,
	[amtincldvat] [bit] NULL,
	[vndr_name] [varchar](50) NULL,
	[fld3] [float] NULL,
	[fld4] [float] NULL,
	[fld5] [float] NULL,
	[fld6] [float] NULL,
	[fld7] [float] NULL,
	[fld8] [float] NULL,
	[fld9] [float] NULL,
	[item_vat] [numeric](12, 3) NULL,
	[item_price_net] [float] NULL,
	[item_fq_vat] [numeric](12, 3) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[delchghdr]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[delchghdr](
	[slcenter] [char](2) NOT NULL,
	[branch] [char](2) NOT NULL,
	[company] [char](2) NOT NULL,
	[invtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[invdate] [char](8) NOT NULL,
	[custno] [char](6) NOT NULL,
	[custnm] [varchar](110) NULL,
	[glser] [char](19) NOT NULL,
	[dsctype] [char](1) NOT NULL,
	[pstmode] [numeric](1, 0) NOT NULL,
	[fcy] [char](3) NOT NULL,
	[fcyrate] [float] NULL,
	[duedate] [char](8) NOT NULL,
	[invttl] [float] NOT NULL,
	[invcst] [float] NOT NULL,
	[invdspc] [float] NOT NULL,
	[invdsvl] [float] NOT NULL,
	[valafds] [float] NOT NULL,
	[invpaid] [float] NULL,
	[caser] [char](19) NOT NULL,
	[entries] [numeric](5, 0) NOT NULL,
	[released] [bit] NOT NULL,
	[posted] [bit] NOT NULL,
	[fixrate] [float] NULL,
	[extamt] [float] NULL,
	[extser] [char](19) NOT NULL,
	[pricetp] [char](1) NOT NULL,
	[ischeque] [bit] NOT NULL,
	[chkno] [char](8) NOT NULL,
	[chkdate] [char](8) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[jvgenrt] [bit] NOT NULL,
	[cccommsn] [float] NOT NULL,
	[belowbal] [bit] NOT NULL,
	[fcy2] [char](3) NOT NULL,
	[ccpayment] [float] NULL,
	[rplsamt] [float] NULL,
	[pdother] [bit] NOT NULL,
	[slcode] [char](2) NOT NULL,
	[prpaidamt] [float] NULL,
	[instldays] [numeric](3, 0) NOT NULL,
	[instflag] [bit] NOT NULL,
	[slcmnd] [bit] NOT NULL,
	[inv_printed] [numeric](2, 0) NOT NULL,
	[bendit] [bit] NOT NULL,
	[modified] [bit] NOT NULL,
	[rqstorder] [numeric](6, 0) NOT NULL,
	[rqststld] [bit] NOT NULL,
	[carrier] [char](3) NOT NULL,
	[rcvdtrn] [bit] NOT NULL,
	[usrid] [char](10) NOT NULL,
	[address] [varchar](50) NOT NULL,
	[suspend] [bit] NOT NULL,
	[rtnref] [numeric](6, 0) NOT NULL,
	[ispurchase] [bit] NOT NULL,
	[stkjvno] [numeric](6, 0) NOT NULL,
	[posinv] [numeric](1, 0) NULL,
	[whodelete] [char](10) NOT NULL,
	[action_type] [bit] NOT NULL,
	[action_tdate] [smalldatetime] NOT NULL,
	[src] [char](2) NULL,
	[trx_id] [int] NOT NULL,
	[pricevattype] [numeric](1, 0) NULL,
	[clnt_kind] [char](1) NULL,
	[vat_amt_rcvd] [float] NULL,
	[vat_percent] [numeric](5, 2) NULL,
	[crtd_fm_batch_ref] [int] NULL,
	[diffamount] [float] NULL,
	[fld1] [float] NULL,
	[fld2] [float] NULL,
	[fld3] [int] NULL,
	[zatca_rounding] [bit] NULL,
 CONSTRAINT [PK_delchghdr_1] PRIMARY KEY CLUSTERED 
(
	[trx_id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[expense]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[expense](
	[expcompany] [char](2) NOT NULL,
	[expcode] [int] NOT NULL,
	[expacct] [char](19) NULL,
	[expstatus] [numeric](1, 0) NULL,
	[exptype] [numeric](1, 0) NULL,
	[expfxdamt] [numeric](12, 3) NULL,
	[expmn1] [numeric](12, 3) NULL,
	[expmn2] [numeric](12, 3) NULL,
	[expmn3] [numeric](12, 3) NULL,
	[expmn4] [numeric](12, 3) NULL,
	[expmn5] [numeric](12, 3) NULL,
	[expmn6] [numeric](12, 3) NULL,
	[expmn7] [numeric](12, 3) NULL,
	[expmn8] [numeric](12, 3) NULL,
	[expmn9] [numeric](12, 3) NULL,
	[expmn10] [numeric](12, 3) NULL,
	[expmn11] [numeric](12, 3) NULL,
	[expmn12] [numeric](12, 3) NULL,
	[lastupdt] [char](8) NULL,
	[crtdate] [char](8) NULL,
	[lstusrupdate] [char](10) NULL,
 CONSTRAINT [PK_expense_1] PRIMARY KEY CLUSTERED 
(
	[expcompany] ASC,
	[expcode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[exporders_dt]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[exporders_dt](
	[company] [char](2) NULL,
	[orderid] [int] NULL,
	[expcode] [int] NULL,
	[exptype] [numeric](1, 0) NULL,
	[qty] [numeric](13, 3) NULL,
	[price] [numeric](13, 3) NULL,
	[expdescrp] [varchar](60) NULL,
	[lastamtaprvd] [numeric](13, 3) NULL,
	[lastdateaprvd] [char](8) NULL,
	[mnthbudget] [numeric](13, 3) NULL,
	[expaction] [numeric](1, 0) NULL,
	[transf2user] [char](10) NULL,
	[transfreason] [varchar](70) NULL,
	[transfaction] [numeric](1, 0) NULL,
	[acpt_rjkt_rsn] [varchar](70) NULL,
	[expstatus] [numeric](1, 0) NULL,
	[amtaplyvat] [numeric](13, 3) NULL,
	[amtnovat] [numeric](13, 3) NULL,
	[vat_amt_paid] [float] NULL,
	[folio] [int] NULL,
	[expactn_date] [char](8) NULL,
	[expaprvl_date] [char](8) NULL,
	[costcenter] [char](4) NULL,
	[cstcntrtype] [numeric](1, 0) NULL,
	[xfr_posted] [bit] NULL,
	[xfrpostdate] [char](8) NULL,
	[expfolio] [int] NULL,
	[ttl_invamt_vat] [float] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[exporders_hd]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[exporders_hd](
	[company] [char](2) NOT NULL,
	[orderId] [int] NOT NULL,
	[orddate] [char](8) NULL,
	[ordusrid] [char](10) NULL,
	[ordposted] [bit] NULL,
	[ordpostdate] [varchar](25) NULL,
	[ordpostusrid] [char](10) NULL,
	[orddescrp] [varchar](70) NULL,
	[audit_posted] [bit] NULL,
	[audit_date] [varchar](25) NULL,
	[audit_usrid] [char](10) NULL,
	[audPostusrid] [char](10) NULL,
	[audpostdate] [varchar](25) NULL,
	[confirm_posted] [bit] NULL,
	[confirm_date] [varchar](25) NULL,
	[confirm_usrid] [char](10) NULL,
	[jv_posted] [bit] NULL,
	[jvcrt_date] [varchar](25) NULL,
	[jvcrt_usrid] [nchar](10) NULL,
	[glref] [int] NULL,
	[glser] [char](19) NULL,
	[gltext] [varchar](70) NULL,
	[trtype] [char](2) NULL,
	[vat_percent] [numeric](5, 2) NULL,
	[current_status] [numeric](2, 0) NULL,
	[expttl] [float] NULL,
	[expentries] [int] NULL,
	[trnsfr_entries] [numeric](3, 0) NULL,
	[trnsfrPostdate] [varchar](25) NULL,
	[trnsfr_posted] [bit] NULL,
	[trnsfrpostusrid] [char](10) NULL,
	[confirmpostdate] [varchar](25) NULL,
	[confirmpostusrid] [char](10) NULL,
	[ttl4jv] [float] NULL,
	[ttlvat] [float] NULL,
	[ttlaplyamt] [float] NULL,
	[ttlnovatamt] [float] NULL,
	[trnsfr_Done_entries] [numeric](3, 0) NULL,
 CONSTRAINT [PK_exporders_hd] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[orderId] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[expreplaced_dt]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[expreplaced_dt](
	[company] [char](2) NOT NULL,
	[glref] [int] NOT NULL,
	[orderid] [int] NOT NULL,
	[rplsd_txt] [varchar](70) NULL,
	[confirmed] [bit] NULL,
	[confirmpostdate] [varchar](25) NULL,
	[ttl4jv] [float] NULL,
	[glrefcnf] [int] NULL,
	[audit_usrid] [char](10) NULL,
	[glser] [char](19) NULL,
 CONSTRAINT [PK_expreplaced_dt] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[glref] ASC,
	[orderid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[expreplaced_hd]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[expreplaced_hd](
	[company] [char](2) NOT NULL,
	[glref] [int] NOT NULL,
	[gldate] [char](8) NULL,
	[usrid] [char](10) NULL,
	[frm_date] [char](8) NULL,
	[to_date] [char](8) NULL,
	[frm_order] [int] NULL,
	[to_order] [int] NULL,
	[glacct] [char](19) NULL,
	[entries] [int] NULL,
	[posted] [bit] NULL,
	[posteddate] [varchar](25) NULL,
	[postedusrid] [char](10) NULL,
	[confirm_date] [varchar](25) NULL,
	[confirm_usrid] [char](10) NULL,
	[confirm_entries] [int] NULL,
	[expttl] [float] NULL,
	[gltext] [varchar](70) NULL,
 CONSTRAINT [PK_expreplaced_hd_1] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[glref] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[exptype]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[exptype](
	[expcode] [int] NOT NULL,
	[expname] [varchar](50) NULL,
	[explname] [varchar](50) NULL,
	[lastupdt] [char](8) NULL,
	[lstusrupdate] [char](10) NULL,
 CONSTRAINT [PK_exptype] PRIMARY KEY CLUSTERED 
(
	[expcode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[expusers]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[expusers](
	[username] [char](10) NOT NULL,
	[usr_title] [numeric](2, 0) NULL,
	[alwordsrch] [bit] NULL,
	[alwordpost] [bit] NULL,
	[alwaudsrch] [bit] NULL,
	[alwaudxfr] [bit] NULL,
	[alwreopenrqst] [bit] NULL,
	[alwaudpost] [bit] NULL,
	[alwxfrsrch] [bit] NULL,
	[alwxfrpost] [bit] NULL,
	[alwcnfsrch] [bit] NULL,
	[alwcnfpost] [bit] NULL,
	[alwcnfjvcrt] [bit] NULL,
	[alwtransfer2him] [bit] NULL,
	[alwunpostjv] [bit] NULL,
	[alwunpostcnf] [bit] NULL,
 CONSTRAINT [PK_expusers] PRIMARY KEY CLUSTERED 
(
	[username] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[expvatdtl]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[expvatdtl](
	[company] [char](2) NOT NULL,
	[orderid] [int] NOT NULL,
	[expcode] [int] NOT NULL,
	[folio] [int] NOT NULL,
	[pricevattype] [numeric](1, 0) NULL,
	[amtaplyvat] [numeric](13, 3) NULL,
	[amtnovat] [numeric](13, 3) NULL,
	[vat_amt_paid] [float] NULL,
	[vndr_taxcode] [varchar](15) NULL,
	[vndr_name] [varchar](50) NULL,
	[invttl] [numeric](13, 3) NULL,
 CONSTRAINT [PK_expvatdtl] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[orderid] ASC,
	[expcode] ASC,
	[folio] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[f_assets]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[f_assets](
	[company] [char](2) NOT NULL,
	[fano] [char](8) NOT NULL,
	[mclass] [char](2) NOT NULL,
	[sclass] [char](2) NOT NULL,
	[category] [char](4) NOT NULL,
	[msection] [char](4) NOT NULL,
	[dptproj] [char](4) NOT NULL,
	[desc1] [varchar](45) NOT NULL,
	[desc2] [varchar](45) NOT NULL,
	[ldesc1] [varchar](45) NOT NULL,
	[ldesc2] [varchar](45) NOT NULL,
	[person_using] [varchar](45) NOT NULL,
	[lperson_using] [varchar](45) NOT NULL,
	[purch_date] [char](8) NOT NULL,
	[purch_from] [varchar](45) NOT NULL,
	[lpurch_from] [varchar](45) NOT NULL,
	[purch_jvtype] [char](2) NOT NULL,
	[purch_jvref] [numeric](6, 0) NOT NULL,
	[purch_jvdate] [char](8) NOT NULL,
	[fcy] [char](3) NOT NULL,
	[deptype] [char](1) NOT NULL,
	[life] [float] NOT NULL,
	[deprate] [float] NOT NULL,
	[lopncost] [float] NOT NULL,
	[fopncost] [float] NOT NULL,
	[eqcopncost] [float] NOT NULL,
	[lcost] [float] NOT NULL,
	[fcost] [float] NOT NULL,
	[eqccost] [float] NOT NULL,
	[lscrap] [float] NOT NULL,
	[fscrap] [float] NOT NULL,
	[eqcscrap] [float] NOT NULL,
	[lttldep] [float] NOT NULL,
	[fttldep] [float] NOT NULL,
	[eqcttldep] [float] NOT NULL,
	[lyerdep] [float] NOT NULL,
	[fyerdep] [float] NOT NULL,
	[eqcyerdep] [float] NOT NULL,
	[lastdepdate] [char](8) NOT NULL,
	[fstatus] [char](1) NOT NULL,
	[opendate] [char](8) NOT NULL,
	[lbns_msaha] [float] NOT NULL,
	[fpicture] [varchar](100) NOT NULL,
	[landstatus] [char](2) NOT NULL,
	[bldgclass] [char](2) NOT NULL,
	[bldgtype] [char](2) NOT NULL,
	[bldgarea] [float] NOT NULL,
	[bldgfloors] [numeric](3, 0) NOT NULL,
	[bldgstat] [char](2) NOT NULL,
	[manfctrddate] [varchar](8) NOT NULL,
	[countryoforg] [varchar](20) NOT NULL,
	[model] [varchar](20) NOT NULL,
	[chase] [varchar](20) NOT NULL,
	[engine] [varchar](20) NOT NULL,
	[orgcolor] [varchar](20) NOT NULL,
	[plateno] [varchar](20) NOT NULL,
	[customno] [varchar](20) NOT NULL,
	[customfrom] [varchar](20) NOT NULL,
	[customdate] [varchar](8) NOT NULL,
	[tyressize] [varchar](20) NOT NULL,
	[weighttoload] [varchar](20) NOT NULL,
	[noofpassengers] [numeric](4, 0) NOT NULL,
	[fueltype] [varchar](10) NOT NULL,
	[internalno] [varchar](10) NOT NULL,
	[powertype] [varchar](2) NOT NULL,
	[power] [float] NOT NULL,
	[frntr_type] [varchar](2) NOT NULL,
	[frntr_made] [varchar](2) NOT NULL,
	[quantity] [int] NOT NULL,
	[sold_date] [char](8) NOT NULL,
	[sold_jvno] [numeric](6, 0) NOT NULL,
	[sold_lamt] [float] NOT NULL,
	[sold_famt] [float] NOT NULL,
	[sold_eqcamt] [float] NOT NULL,
	[glser] [varchar](19) NOT NULL,
	[yrser] [varchar](19) NOT NULL,
	[adser] [varchar](19) NOT NULL,
	[rvser] [varchar](19) NOT NULL,
	[classkey] [char](8) NOT NULL,
	[taxtype] [char](1) NULL,
	[lastupdt] [varchar](8) NOT NULL,
	[modified] [bit] NOT NULL,
 CONSTRAINT [PK_f_assets] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[fano] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[f_class]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[f_class](
	[company] [char](2) NOT NULL,
	[cmbkey] [char](8) NOT NULL,
	[mclass] [char](2) NOT NULL,
	[sclass] [char](2) NOT NULL,
	[category] [char](4) NOT NULL,
	[clname] [varchar](45) NOT NULL,
	[lclname] [varchar](45) NOT NULL,
	[glser] [varchar](19) NOT NULL,
	[yesdep] [bit] NOT NULL,
	[yrser] [varchar](19) NOT NULL,
	[adser] [varchar](19) NOT NULL,
	[rvser] [varchar](19) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[modified] [bit] NOT NULL,
	[pkey] [int] NOT NULL,
	[chkey] [int] NOT NULL,
 CONSTRAINT [PK_f_class] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[cmbkey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[f_cost]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[f_cost](
	[company] [char](2) NOT NULL,
	[fano] [char](8) NOT NULL,
	[costtype] [char](2) NOT NULL,
	[mclass] [char](2) NOT NULL,
	[lopnamount] [float] NOT NULL,
	[fopnamount] [float] NOT NULL,
	[eqopnamount] [float] NOT NULL,
	[lamount] [float] NOT NULL,
	[famount] [float] NOT NULL,
	[eqamount] [float] NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[modified] [bit] NOT NULL,
 CONSTRAINT [PK_f_cost] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[fano] ASC,
	[costtype] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[f_dptproj]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[f_dptproj](
	[company] [char](2) NOT NULL,
	[msection] [char](4) NOT NULL,
	[dptproj] [char](4) NOT NULL,
	[name] [varchar](45) NOT NULL,
	[lname] [varchar](45) NOT NULL,
	[glser] [varchar](19) NOT NULL,
	[yrser] [varchar](19) NOT NULL,
	[adser] [varchar](19) NOT NULL,
	[rvser] [varchar](19) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[modified] [bit] NOT NULL,
 CONSTRAINT [PK_f_dptproj] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[msection] ASC,
	[dptproj] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[f_mainsections]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[f_mainsections](
	[company] [char](2) NOT NULL,
	[msection] [char](4) NOT NULL,
	[name] [varchar](45) NOT NULL,
	[lname] [varchar](45) NOT NULL,
	[govrn] [char](2) NOT NULL,
	[city] [char](2) NOT NULL,
	[region] [char](2) NOT NULL,
	[glser] [varchar](19) NOT NULL,
	[yrser] [varchar](19) NOT NULL,
	[adser] [varchar](19) NOT NULL,
	[rvser] [varchar](19) NOT NULL,
	[classkey] [char](6) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[modified] [bit] NOT NULL,
 CONSTRAINT [PK_f_mainsections] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[msection] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[f_tables]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[f_tables](
	[prefix] [char](5) NOT NULL,
	[code] [char](2) NOT NULL,
	[serial] [char](2) NOT NULL,
	[name] [varchar](30) NOT NULL,
	[lname] [varchar](30) NOT NULL,
	[modified] [bit] NULL,
	[lastupdt] [char](8) NULL,
 CONSTRAINT [PK_f_tables] PRIMARY KEY CLUSTERED 
(
	[prefix] ASC,
	[code] ASC,
	[serial] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[fadtl]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[fadtl](
	[fd_company] [char](2) NOT NULL,
	[fd_type] [char](2) NOT NULL,
	[fd_ref] [numeric](6, 0) NOT NULL,
	[fd_date] [char](8) NOT NULL,
	[fd_fcy] [char](3) NOT NULL,
	[fd_mclass] [char](2) NOT NULL,
	[fd_costtyp] [char](2) NOT NULL,
	[fd_fano] [char](8) NOT NULL,
	[fd_cucode] [char](6) NOT NULL,
	[fd_supcode] [char](6) NOT NULL,
	[fd_glser] [char](19) NOT NULL,
	[fd_famount] [float] NOT NULL,
	[fd_lamount] [float] NOT NULL,
	[fd_famteqc] [float] NOT NULL,
	[fd_trxsrc] [char](2) NOT NULL,
	[fd_fatype] [char](1) NOT NULL,
	[fd_folio] [numeric](6, 0) NOT NULL,
	[fd_lclval] [float] NOT NULL,
	[fd_fcyval] [float] NOT NULL,
	[fd_eqcval] [float] NOT NULL,
	[fd_dbcr] [char](1) NOT NULL,
	[fd_ackey] [char](19) NOT NULL,
	[fd_deptype] [char](1) NOT NULL,
	[fd_rate] [float] NOT NULL,
	[fd_lastdep] [char](8) NOT NULL,
	[fd_lstdate] [char](8) NOT NULL,
	[fd_desc] [varchar](70) NOT NULL,
	[Taxtype] [char](1) NULL,
 CONSTRAINT [PK_fadtl] PRIMARY KEY CLUSTERED 
(
	[fd_company] ASC,
	[fd_type] ASC,
	[fd_ref] ASC,
	[fd_folio] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[fahdr]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[fahdr](
	[fh_company] [char](2) NOT NULL,
	[fh_type] [char](2) NOT NULL,
	[fh_ref] [numeric](6, 0) NOT NULL,
	[fh_date] [char](8) NOT NULL,
	[fh_fcy] [char](3) NOT NULL,
	[fh_ftotal] [float] NOT NULL,
	[fh_fcyrate] [numeric](9, 6) NOT NULL,
	[fh_ltotal] [float] NOT NULL,
	[fh_ftoteqc] [float] NOT NULL,
	[fh_ser] [char](19) NOT NULL,
	[fh_bnfcry_type] [numeric](1, 0) NOT NULL,
	[fh_cucode] [char](6) NOT NULL,
	[fh_glact] [char](19) NOT NULL,
	[fh_desc] [varchar](70) NOT NULL,
	[fh_rlsd] [bit] NOT NULL,
	[fh_posted] [bit] NOT NULL,
	[fh_trxsrc] [char](2) NOT NULL,
	[fh_fatype] [char](1) NOT NULL,
	[fh_sysdate] [char](8) NOT NULL,
	[fh_dtlocal] [float] NOT NULL,
	[fh_dtfcy] [float] NOT NULL,
	[fh_dtfceqc] [float] NOT NULL,
	[fh_plser] [char](19) NOT NULL,
	[fh_dtlclcr] [float] NOT NULL,
	[fh_dtfcycr] [float] NOT NULL,
	[fh_dteqccr] [float] NOT NULL,
	[clnt_vndr_kind] [char](1) NULL,
	[clnt_vndr_taxcode] [varchar](20) NULL,
	[vat_percent] [numeric](5, 2) NULL,
	[taxfree_amnt] [float] NULL,
	[vat_amt] [float] NULL,
	[VatNot4Vender_clnt] [bit] NULL,
	[PriceIncludeVat] [bit] NULL,
	[PriceVatType] [numeric](1, 0) NULL,
	[invdsvl] [float] NULL,
	[hlldscnt] [float] NULL,
	[slcenter] [char](2) NULL,
	[entries] [numeric](5, 0) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[modified] [bit] NOT NULL,
	[rcvdtrn] [bit] NOT NULL,
	[usrid] [char](10) NOT NULL,
 CONSTRAINT [PK_fahdr] PRIMARY KEY CLUSTERED 
(
	[fh_company] ASC,
	[fh_type] ASC,
	[fh_ref] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[fcimage]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[fcimage](
	[glcomp] [char](2) NOT NULL,
	[glkey] [char](19) NOT NULL,
	[glcurrency] [char](3) NOT NULL,
	[fc_fcy] [char](3) NOT NULL,
	[fcbal01] [float] NOT NULL,
	[fcbal02] [float] NOT NULL,
	[fcbal03] [float] NOT NULL,
	[fcbal04] [float] NOT NULL,
	[fcbal05] [float] NOT NULL,
	[fcbal06] [float] NOT NULL,
	[fcbal07] [float] NOT NULL,
	[fcbal08] [float] NOT NULL,
	[fcbal09] [float] NOT NULL,
	[fcbal10] [float] NOT NULL,
	[fcbal11] [float] NOT NULL,
	[fcbal12] [float] NOT NULL,
	[fcbal13] [float] NOT NULL,
	[lastupdt] [datetime] NOT NULL,
	[modified] [bit] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[freplicate]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[freplicate](
	[brnno] [char](2) NOT NULL,
	[cmnbarcode] [bit] NULL,
	[chgprice] [bit] NULL,
	[SipAddress] [char](15) NULL,
	[sqlSname] [char](30) NULL,
	[stopextract] [bit] NULL,
	[stopupdate] [bit] NULL,
	[brtype] [numeric](1, 0) NULL,
	[glnoexport] [bit] NULL,
	[arnoexport] [bit] NULL,
	[stnoexport] [bit] NULL,
	[slnoexport] [bit] NULL,
	[punoexport] [bit] NULL,
	[apnoexport] [bit] NULL,
	[chknoexport] [bit] NULL,
	[itemupdate] [bit] NULL,
	[localBranch] [bit] NULL,
 CONSTRAINT [PK_freplicate] PRIMARY KEY CLUSTERED 
(
	[brnno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[fsiss_dt]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[fsiss_dt](
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[branch] [char](2) NOT NULL,
	[trtype] [char](2) NOT NULL,
	[qty] [numeric](12, 3) NOT NULL,
	[fqty] [numeric](11, 3) NOT NULL,
	[whno] [char](2) NOT NULL,
	[binno] [char](6) NOT NULL,
	[lcost] [float] NOT NULL,
	[trdate] [char](8) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[sysdate] [char](8) NOT NULL,
	[src] [char](2) NOT NULL,
	[lprice] [float] NOT NULL,
	[fcost] [float] NOT NULL,
	[fprice] [numeric](11, 2) NOT NULL,
	[expdate] [char](8) NULL,
	[towhno] [char](2) NOT NULL,
	[tobinno] [char](6) NOT NULL,
	[barcode] [char](20) NOT NULL,
	[cmbkey] [char](24) NULL,
	[discpc] [numeric](6, 2) NULL,
	[pack] [char](1) NULL,
	[shdpk] [numeric](8, 3) NULL,
	[shdqty] [numeric](14, 3) NULL,
	[folio] [numeric](7, 0) NULL,
	[qtyrcv] [numeric](13, 3) NULL,
	[qtysent] [numeric](13, 3) NULL,
	[qtyrsv] [numeric](13, 3) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[fsiss_hd]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[fsiss_hd](
	[branch] [char](2) NOT NULL,
	[trtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[trdate] [char](8) NOT NULL,
	[description] [varchar](40) NOT NULL,
	[amnttl] [float] NOT NULL,
	[costttl] [float] NOT NULL,
	[sysdate] [char](8) NOT NULL,
	[src] [char](2) NOT NULL,
	[released] [bit] NOT NULL,
	[posted] [bit] NOT NULL,
	[fcy] [char](3) NOT NULL,
	[fcyrate] [numeric](6, 3) NOT NULL,
	[whno] [char](2) NOT NULL,
	[entries] [numeric](6, 0) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[towhno] [char](2) NOT NULL,
	[modified] [bit] NOT NULL,
	[rcvdtrn] [bit] NOT NULL,
	[custno] [char](19) NOT NULL,
	[usrid] [char](10) NOT NULL,
	[brsupp] [char](19) NOT NULL,
	[tobrno] [char](2) NOT NULL,
	[brxref] [numeric](6, 0) NOT NULL,
	[glref] [numeric](6, 0) NOT NULL,
	[isbrtrx] [bit] NOT NULL,
	[ostatus] [numeric](1, 0) NOT NULL,
 CONSTRAINT [PK_fsiss_hd_1] PRIMARY KEY CLUSTERED 
(
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[fsrcv_dt]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[fsrcv_dt](
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[branch] [char](2) NOT NULL,
	[trtype] [char](2) NOT NULL,
	[qty] [numeric](12, 3) NOT NULL,
	[fqty] [numeric](11, 3) NOT NULL,
	[whno] [char](2) NOT NULL,
	[binno] [char](6) NOT NULL,
	[lcost] [float] NOT NULL,
	[trdate] [char](8) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[sysdate] [char](8) NOT NULL,
	[src] [char](2) NOT NULL,
	[lprice] [float] NOT NULL,
	[fcost] [float] NOT NULL,
	[fprice] [numeric](11, 2) NOT NULL,
	[expdate] [char](8) NULL,
	[towhno] [char](2) NOT NULL,
	[tobinno] [char](6) NOT NULL,
	[barcode] [char](20) NOT NULL,
	[cmbkey] [char](24) NULL,
	[discpc] [numeric](6, 2) NULL,
	[pack] [char](1) NULL,
	[shdpk] [numeric](8, 3) NULL,
	[shdqty] [numeric](14, 3) NULL,
	[folio] [numeric](7, 0) NULL,
	[qtyrcv] [numeric](13, 3) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[fsrcv_hd]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[fsrcv_hd](
	[branch] [char](2) NOT NULL,
	[trtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[trdate] [char](8) NOT NULL,
	[description] [varchar](40) NOT NULL,
	[amnttl] [float] NOT NULL,
	[costttl] [float] NOT NULL,
	[sysdate] [char](8) NOT NULL,
	[src] [char](2) NOT NULL,
	[released] [bit] NOT NULL,
	[posted] [bit] NOT NULL,
	[fcy] [char](3) NOT NULL,
	[fcyrate] [numeric](6, 3) NOT NULL,
	[whno] [char](2) NOT NULL,
	[entries] [numeric](6, 0) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[towhno] [char](2) NOT NULL,
	[modified] [bit] NOT NULL,
	[rcvdtrn] [bit] NOT NULL,
	[custno] [char](19) NOT NULL,
	[usrid] [char](10) NOT NULL,
	[brsupp] [char](19) NOT NULL,
	[tobrno] [char](2) NOT NULL,
	[brxref] [numeric](6, 0) NOT NULL,
	[glref] [numeric](6, 0) NOT NULL,
	[isbrtrx] [bit] NOT NULL,
	[ostatus] [numeric](1, 0) NOT NULL,
	[usrchkid] [char](10) NULL,
	[shrt_vchr] [numeric](6, 0) NULL,
	[excess_vchr] [numeric](6, 0) NULL,
	[rcvdate] [char](8) NULL,
	[shrt_vchr_receipt] [numeric](6, 0) NULL,
	[excess_vchr_receipt] [numeric](6, 0) NULL,
 CONSTRAINT [PK_fsrcv_hd] PRIMARY KEY CLUSTERED 
(
	[branch] ASC,
	[trtype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[glchart]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[glchart](
	[glname] [varchar](50) NOT NULL,
	[glkey] [char](19) NOT NULL,
	[glcomp] [char](2) NOT NULL,
	[glcurbal] [float] NULL,
	[glopnbal] [float] NULL,
	[glopndate] [char](8) NULL,
	[glamnd] [char](8) NULL,
	[glacttyp] [char](1) NOT NULL,
	[glgroup] [char](1) NOT NULL,
	[glactive] [char](1) NOT NULL,
	[glpurge] [char](1) NULL,
	[accontrol] [bit] NOT NULL,
	[glp_lcode] [char](1) NOT NULL,
	[glcurrency] [char](3) NOT NULL,
	[glbal01] [float] NULL,
	[glbal02] [float] NULL,
	[glbal03] [float] NULL,
	[glbal04] [float] NULL,
	[glbal05] [float] NULL,
	[glbal06] [float] NULL,
	[glbal07] [float] NULL,
	[glbal08] [float] NULL,
	[glbal09] [float] NULL,
	[glbal10] [float] NULL,
	[glbal11] [float] NULL,
	[glbal12] [float] NULL,
	[glbal13] [float] NULL,
	[fccurbal] [numeric](13, 2) NULL,
	[fcopnbal] [numeric](13, 2) NULL,
	[fcbal01] [numeric](13, 2) NULL,
	[fcbal02] [numeric](13, 2) NULL,
	[fcbal03] [numeric](13, 2) NULL,
	[fcbal04] [numeric](13, 2) NULL,
	[fcbal05] [numeric](13, 2) NULL,
	[fcbal06] [numeric](13, 2) NULL,
	[fcbal07] [numeric](13, 2) NULL,
	[fcbal08] [numeric](13, 2) NULL,
	[fcbal09] [numeric](13, 2) NULL,
	[fcbal10] [numeric](13, 2) NULL,
	[fcbal11] [numeric](13, 2) NULL,
	[fcbal12] [numeric](13, 2) NULL,
	[fcbal13] [numeric](13, 2) NULL,
	[glsgrp] [char](1) NOT NULL,
	[imopnbal] [float] NOT NULL,
	[imcurbal] [float] NOT NULL,
	[lastupdt] [char](8) NULL,
	[gleval] [bit] NULL,
	[acprotect] [bit] NULL,
	[pkey] [numeric](5, 0) NULL,
	[chkey] [numeric](5, 0) NULL,
	[cashbnk] [bit] NULL,
	[modified] [bit] NULL,
	[gllname] [varchar](50) NULL,
	[section] [char](6) NULL,
	[isbracc] [bit] NULL,
	[actlvl] [int] NULL,
	[glackind] [char](1) NULL,
	[rowguid] [uniqueidentifier] NULL,
	[usrid] [char](10) NULL,
	[usridchg] [char](10) NULL,
 CONSTRAINT [PK_glchart_1] PRIMARY KEY CLUSTERED 
(
	[glkey] ASC,
	[glcurrency] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[glcstctr]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[glcstctr](
	[company] [char](2) NOT NULL,
	[cscode] [char](4) NOT NULL,
	[csname] [varchar](30) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[modified] [bit] NOT NULL,
	[cslname] [varchar](30) NOT NULL,
	[whtype] [tinyint] NULL,
	[cs_code] [char](6) NULL,
	[rowguid] [uniqueidentifier] NULL,
	[xpercent] [numeric](6, 3) NULL,
 CONSTRAINT [PK_glcstctr] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[cscode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[glcurr]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[glcurr](
	[curname] [varchar](30) NOT NULL,
	[curcode] [char](3) NOT NULL,
	[currate] [numeric](10, 5) NOT NULL,
	[curfix] [numeric](10, 5) NOT NULL,
	[cursname] [char](5) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[curparts] [char](10) NOT NULL,
	[modified] [bit] NOT NULL,
	[curlname] [varchar](30) NOT NULL,
	[curlsname] [char](10) NOT NULL,
	[curlparts] [char](10) NOT NULL,
	[curminrate] [numeric](12, 5) NULL,
	[curmaxrate] [numeric](12, 5) NULL,
	[standard_fcy_code] [varchar](3) NULL,
 CONSTRAINT [PK_glcurr] PRIMARY KEY CLUSTERED 
(
	[curcode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[gljrcost]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[gljrcost](
	[company] [char](2) NOT NULL,
	[jdtype] [char](2) NOT NULL,
	[jdref] [numeric](6, 0) NOT NULL,
	[cstcode] [char](4) NOT NULL,
	[jdkey] [char](19) NOT NULL,
	[jdcurr] [char](3) NOT NULL,
	[Xpercent] [numeric](5, 2) NOT NULL,
	[amt] [float] NULL,
	[jddbcr] [char](1) NOT NULL,
	[jdfc_imgval] [float] NOT NULL,
	[jdfolno] [numeric](3, 0) NOT NULL,
	[rplct_post] [bit] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[gljrdtl]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[gljrdtl](
	[jdcomp] [char](2) NOT NULL,
	[jdtype] [char](2) NOT NULL,
	[jdref] [numeric](6, 0) NOT NULL,
	[jdkey] [char](19) NOT NULL,
	[jddate] [char](8) NOT NULL,
	[jdtext] [varchar](110) NOT NULL,
	[jdlcamt] [float] NOT NULL,
	[jddbcr] [char](1) NOT NULL,
	[jdfcamt] [float] NOT NULL,
	[jdcurr] [char](3) NOT NULL,
	[jdfolio] [numeric](4, 0) NOT NULL,
	[jdfolno] [numeric](3, 0) NOT NULL,
	[jdsysdate] [char](8) NOT NULL,
	[jdsrc] [char](2) NOT NULL,
	[jdfc_imgval] [float] NULL,
	[jdcstval] [float] NULL,
	[cstkey] [char](22) NULL,
	[brnno] [char](2) NULL,
	[bracc] [char](19) NULL,
	[brxref] [numeric](6, 0) NULL,
	[match] [bit] NULL,
	[rplct_post] [bit] NULL,
	[rowguid] [uniqueidentifier] ROWGUIDCOL  NOT NULL,
	[taxcatId] [numeric](3, 0) NULL,
	[jhcustno] [char](6) NULL,
 CONSTRAINT [PK_gljrdtl] PRIMARY KEY CLUSTERED 
(
	[jdcomp] ASC,
	[jdtype] ASC,
	[jdref] ASC,
	[jdfolio] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[gljrhdr]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[gljrhdr](
	[jhcomp] [char](2) NOT NULL,
	[jhtype] [char](2) NOT NULL,
	[jhref] [numeric](6, 0) NOT NULL,
	[jhdate] [char](8) NOT NULL,
	[jhtext] [varchar](110) NOT NULL,
	[jhamt] [float] NOT NULL,
	[jhentries] [numeric](4, 0) NULL,
	[jhsrc] [char](2) NOT NULL,
	[jhsysdate] [char](8) NOT NULL,
	[jhcurr] [char](3) NOT NULL,
	[jhfcflag] [numeric](1, 0) NOT NULL,
	[jhrate] [float] NULL,
	[jhreleased] [bit] NOT NULL,
	[jhposted] [bit] NOT NULL,
	[lastupdt] [char](8) NULL,
	[jhlccrttl] [float] NULL,
	[jhlcdbttl] [float] NULL,
	[jhfccrttl] [float] NULL,
	[jhfcdbttl] [float] NULL,
	[jhimgrate] [float] NULL,
	[modified] [bit] NULL,
	[serial_no] [numeric](4, 0) NULL,
	[rcvdtrn] [bit] NULL,
	[suspend] [bit] NOT NULL,
	[usrid] [char](10) NOT NULL,
	[isbrtrx] [bit] NULL,
	[brxref] [char](8) NULL,
	[brxfrm] [char](2) NULL,
	[jhcustno] [char](6) NULL,
	[hide_jv] [bit] NULL,
	[rowguid] [uniqueidentifier] ROWGUIDCOL  NOT NULL,
	[bankref] [char](20) NULL,
	[Vat_Percent] [numeric](5, 2) NULL,
	[jhtext1] [varchar](70) NULL,
	[sc_codeyrtp] [char](9) NULL,
	[zatca_rounding] [bit] NULL,
 CONSTRAINT [PK_gljrhdr] PRIMARY KEY CLUSTERED 
(
	[jhcomp] ASC,
	[jhtype] ASC,
	[jhref] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[glsction]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[glsction](
	[sc_code] [char](6) NULL,
	[sc_name] [varchar](40) NOT NULL,
	[sc_lname] [varchar](40) NOT NULL,
	[sc_company] [char](2) NOT NULL,
	[sc_whno] [char](2) NULL,
	[sc_arcode] [numeric](6, 0) NULL,
	[sc_nowh] [numeric](1, 0) NULL,
	[sc_m_center] [bit] NULL,
	[lastupdt] [char](8) NULL,
	[rebate_act] [char](19) NULL,
	[lossRebateAct] [char](19) NULL,
	[jv_01] [numeric](6, 0) NULL,
	[jv_02] [numeric](6, 0) NULL,
	[jv_03] [numeric](6, 0) NULL,
	[jv_04] [numeric](6, 0) NULL,
	[jv_05] [numeric](6, 0) NULL,
	[jv_06] [numeric](6, 0) NULL,
	[jv_07] [numeric](6, 0) NULL,
	[jv_08] [numeric](6, 0) NULL,
	[jv_09] [numeric](6, 0) NULL,
	[jv_10] [numeric](6, 0) NULL,
	[jv_11] [numeric](6, 0) NULL,
	[jv_12] [numeric](6, 0) NULL,
	[jv_13] [numeric](6, 0) NULL,
	[jv_14] [numeric](6, 0) NULL,
	[jv_18] [numeric](6, 0) NULL,
	[jv_19] [numeric](6, 0) NULL,
	[jv_20] [numeric](6, 0) NULL,
	[jv_21] [numeric](6, 0) NULL,
	[jv_22] [numeric](6, 0) NULL,
	[jv_23] [numeric](6, 0) NULL,
	[jv_24] [numeric](6, 0) NULL,
	[jv_26] [numeric](6, 0) NULL,
	[jv_27] [numeric](6, 0) NULL,
	[jv_28] [numeric](6, 0) NULL,
	[jv_30] [numeric](6, 0) NULL,
	[jv_31] [numeric](6, 0) NULL,
	[jv_32] [numeric](6, 0) NULL,
	[jv_33] [numeric](6, 0) NULL,
	[jv_34] [numeric](6, 0) NULL,
	[jv_45] [numeric](10, 0) NULL,
	[jv_46] [numeric](6, 0) NULL,
	[jv_16] [numeric](6, 0) NULL,
	[jv_17] [numeric](6, 0) NULL,
	[sysno] [numeric](2, 0) NULL,
	[No_round_nm] [bit] NULL,
	[PriceVatType] [numeric](1, 0) NULL,
	[mkt_frc_rounding] [bit] NULL,
	[is_dsc_amt] [bit] NULL,
	[auto_dsc_hll] [bit] NULL,
	[max_dsc_hll] [numeric](3, 2) NULL,
	[sc_card_srlno] [int] NULL,
	[sc_card_jvno] [int] NULL,
	[ar_dscser] [char](19) NULL,
	[ap_dscser] [char](19) NULL,
	[sc_lvlno] [int] NULL,
	[cashser] [char](19) NULL,
	[crdt_limit] [float] NULL,
	[sc_lvl1] [char](2) NULL,
	[sc_lvl2] [char](2) NULL,
	[sc_lvl3] [char](2) NULL,
	[CHKEY] [int] NULL,
	[PKEY] [int] NULL,
	[jv_start_year_serial] [numeric](6, 0) NULL,
	[sc_fxdpart] [char](2) NULL,
	[jv_301] [int] NULL,
	[jv_60] [int] NULL,
	[jv_61] [int] NULL,
	[jv_105] [int] NULL,
	[jv_106] [int] NULL,
	[jv_107] [int] NULL,
	[jv_108] [int] NULL,
	[jv_109] [int] NULL,
	[jv_110] [int] NULL,
	[jv_205] [int] NULL,
	[jv_209] [int] NULL,
	[jv_210] [int] NULL,
	[jv_211] [int] NULL,
	[jv_212] [int] NULL,
	[jv_213] [int] NULL,
	[jv_214] [int] NULL,
	[jv_215] [int] NULL,
	[jv_216] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[installment_cmp]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[installment_cmp](
	[inscompany] [char](2) NOT NULL,
	[inscode] [numeric](3, 0) NOT NULL,
	[insshort] [varchar](20) NULL,
	[insname] [varchar](70) NOT NULL,
	[inscommamt] [numeric](10, 3) NULL,
	[inscommprcnt] [numeric](5, 3) NULL,
	[instaxable] [bit] NULL,
	[insacct] [varchar](19) NULL,
	[modified] [bit] NULL,
	[inslname] [varchar](70) NULL,
	[lastupdt] [char](8) NULL,
	[inscontact] [varchar](50) NULL,
	[insmobile] [varchar](40) NULL,
	[usrid] [char](10) NULL,
	[insinactive] [bit] NULL,
	[cmsn_pd_by_buyer] [bit] NULL,
	[inscmsnacct] [varchar](19) NULL,
	[commp_notrtnd] [numeric](5, 2) NULL,
	[ins_taxcode] [varchar](20) NULL,
	[api_auto_connect] [bit] NULL,
	[token_api] [varchar](1000) NULL,
	[is_it_production] [bit] NULL,
	[what_company] [char](2) NULL,
	[ins_publickey] [varchar](500) NULL,
	[ins_merchant_act] [varchar](50) NULL,
 CONSTRAINT [PK_installment_cmp] PRIMARY KEY CLUSTERED 
(
	[inscompany] ASC,
	[inscode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[installment_trx]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[installment_trx](
	[company] [char](2) NOT NULL,
	[invtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[trx_inscode] [numeric](3, 0) NOT NULL,
	[trx_cmsn_pd_by_buyer] [bit] NULL,
	[trx_instaxable] [bit] NULL,
	[trx_inscommprcnt] [numeric](6, 3) NULL,
	[trx_inscommamt] [numeric](10, 3) NULL,
	[installment_amt] [float] NULL,
	[trx_buyer_mobile] [varchar](15) NULL,
	[trx_confirmed_code] [varchar](10) NULL,
	[trx_instlmnt_vourcher] [varchar](40) NULL,
	[trx_buyer_name] [varchar](40) NULL,
	[trx_datetime] [smalldatetime] NULL,
	[trx_commp_notrtnd] [numeric](6, 3) NULL,
 CONSTRAINT [PK_installment_trx] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[invtype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[insurance]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[insurance](
	[company] [char](2) NOT NULL,
	[iscode] [char](2) NOT NULL,
	[isname] [varchar](50) NULL,
	[islname] [varchar](50) NULL,
	[glaccno] [char](19) NULL,
	[ispercent] [numeric](5, 2) NULL,
	[isextraprcnt] [numeric](5, 2) NULL,
	[gldscact] [char](19) NULL,
	[lastupdt] [char](8) NULL,
 CONSTRAINT [PK_insurance] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[iscode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[inventory]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[inventory](
	[id] [bigint] IDENTITY(1,1) NOT NULL,
	[whno] [char](2) NULL,
	[binno] [char](6) NULL,
	[ctr] [varchar](2) NULL,
	[itemno] [varchar](24) NULL,
	[barcode] [varchar](20) NULL,
	[qty] [int] NULL,
	[transDate] [smalldatetime] NULL,
	[srlno] [bigint] NULL,
 CONSTRAINT [PK_inventory] PRIMARY KEY CLUSTERED 
(
	[id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[invhstry]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[invhstry](
	[company] [char](2) NULL,
	[contr] [numeric](4, 0) NOT NULL,
	[refno] [numeric](8, 0) NOT NULL,
	[cmbkey] [char](24) NULL,
	[qty] [float] NULL,
	[price] [float] NULL,
	[barcode] [char](20) NOT NULL,
	[dscprsnt] [numeric](2, 0) NULL,
	[srlno] [numeric](4, 0) NOT NULL,
	[invdate] [date] NULL,
	[tdatetime] [smalldatetime] NULL,
	[slperson] [numeric](6, 0) NULL,
	[invorrtrn] [char](1) NULL,
	[deletedx] [bit] NULL,
	[ref_id] [int] NULL,
	[qtydel] [float] NULL,
	[retreived] [bit] NULL,
	[offer_amt] [float] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ips]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ips](
	[ip] [varchar](15) NOT NULL,
	[port] [int] NULL,
	[dscption] [varchar](20) NULL,
 CONSTRAINT [PK_ips] PRIMARY KEY CLUSTERED 
(
	[ip] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ipscopy]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ipscopy](
	[ip] [varchar](15) NOT NULL,
	[port] [int] NULL,
	[dscption] [varchar](20) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[items]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[items](
	[mgroup] [nvarchar](255) NULL,
	[cmbkey] [nvarchar](255) NULL,
	[name] [nvarchar](255) NULL,
	[الأجنبي] [nvarchar](255) NULL,
	[الوحدة] [nvarchar](255) NULL,
	[الباركود] [nvarchar](255) NULL,
	[العبوة] [float] NULL,
	[رئيسية] [float] NULL,
	[النوع] [nvarchar](255) NULL,
	[التكلفة ] [nvarchar](255) NULL,
	[سعر البيع] [nvarchar](255) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[jccstord_dtl]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[jccstord_dtl](
	[company] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[invdate] [char](8) NULL,
	[itemno] [char](16) NULL,
	[unicode] [char](6) NULL,
	[qty] [numeric](13, 3) NULL,
	[custno] [char](6) NULL,
	[fcy] [char](3) NULL,
	[barcode] [char](20) NULL,
	[cmbkey] [char](24) NULL,
	[jcno] [numeric](10, 0) NULL,
	[folio] [numeric](7, 0) NOT NULL,
 CONSTRAINT [PK_jccstord_dtl] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[refno] ASC,
	[folio] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[jccstord_hdr]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[jccstord_hdr](
	[company] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[invdate] [char](8) NULL,
	[custno] [char](6) NOT NULL,
	[custnm] [varchar](50) NULL,
	[fcy] [char](3) NOT NULL,
	[fcyrate] [numeric](6, 3) NULL,
	[entries] [numeric](5, 0) NULL,
	[cstordrno] [char](10) NULL,
	[orddatetime] [smalldatetime] NULL,
	[lastupdt] [char](8) NULL,
	[modified] [bit] NULL,
	[rcvdtrn] [bit] NULL,
	[slcode] [char](2) NULL,
 CONSTRAINT [PK_jccstord_hdr] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[jchdr]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[jchdr](
	[ch_company] [char](2) NOT NULL,
	[ch_jcno] [numeric](10, 0) NOT NULL,
	[ch_jcdate] [char](8) NOT NULL,
	[ch_jcdesc] [varchar](70) NOT NULL,
	[cmbkey] [char](24) NOT NULL,
	[ch_cucode] [char](6) NOT NULL,
	[ch_price] [numeric](12, 3) NOT NULL,
	[ch_batchqty] [numeric](12, 3) NOT NULL,
	[ch_tgtqty] [float] NULL,
	[ch_ttlcost] [float] NOT NULL,
	[ch_matitems] [numeric](5, 0) NOT NULL,
	[ch_expentries] [numeric](5, 0) NOT NULL,
	[ch_matttlqty] [float] NULL,
	[ch_expttlhours] [float] NOT NULL,
	[ch_expttlcost] [float] NOT NULL,
	[ch_matttlcost] [float] NOT NULL,
	[ch_fnlqty] [float] NULL,
	[ch_stg1waste] [float] NULL,
	[ch_stg2waste] [float] NULL,
	[ch_stg3waste] [float] NULL,
	[ch_othrwaste] [float] NULL,
	[ch_ttlwaste] [float] NULL,
	[ch_untcost] [float] NOT NULL,
	[ch_status] [char](1) NOT NULL,
	[ch_sampleno] [char](10) NOT NULL,
	[ch_xfrno] [numeric](6, 0) NOT NULL,
	[ch_issno] [numeric](6, 0) NOT NULL,
	[ch_rcvno] [numeric](6, 0) NOT NULL,
	[ch_rcvdate] [char](8) NOT NULL,
	[ch_dpcmbkey] [char](24) NOT NULL,
	[usrid] [char](10) NOT NULL,
	[modified] [bit] NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[ch_expentries1] [numeric](5, 0) NULL,
	[ch_expttlhours1] [float] NULL,
	[ch_expttlcost1] [float] NULL,
	[ch_expentries2] [numeric](5, 0) NULL,
	[ch_expttlhours2] [float] NULL,
	[ch_expttlcost2] [float] NULL,
	[ch_expentries3] [numeric](5, 0) NULL,
	[ch_expttlhours3] [float] NULL,
	[ch_expttlcost3] [float] NULL,
	[ch_xfr_gnrtdt] [smalldatetime] NULL,
	[ch_xfr_postdt] [smalldatetime] NULL,
	[ch_iss_gnrtdt] [smalldatetime] NULL,
	[ch_iss_postdt] [smalldatetime] NULL,
	[ch_rcv_gnrtdt] [smalldatetime] NULL,
	[ch_rcv_postdt] [smalldatetime] NULL,
	[ch_fnlqtyrcv] [float] NULL,
	[ch_cstrqstno] [numeric](6, 0) NULL,
	[fcy] [char](3) NULL,
	[fcyrate] [float] NULL,
	[ch_ttlcost_fcy] [float] NULL,
	[ch_expttlcost_fcy] [float] NULL,
	[ch_matttlcost_fcy] [float] NULL,
	[ch_untcost_fcy] [float] NULL,
	[ch_expttlcost1_fcy] [float] NULL,
	[ch_expttlcost2_fcy] [float] NULL,
	[ch_expttlcost3_fcy] [float] NULL,
	[section] [char](4) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[jcitmwclass]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[jcitmwclass](
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[ws_code] [char](4) NOT NULL,
	[ws_fmqty] [numeric](12, 3) NOT NULL,
	[ws_toqty] [numeric](12, 3) NOT NULL,
	[ws_wastepctg] [float] NOT NULL,
	[cmbkey] [char](24) NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[jcmatdtl]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[jcmatdtl](
	[cd_company] [char](2) NOT NULL,
	[cd_jcno] [numeric](10, 0) NOT NULL,
	[cmbkey] [char](24) NOT NULL,
	[tgtqty] [float] NULL,
	[wastepctg] [float] NOT NULL,
	[qtyb4waste] [float] NULL,
	[fnlqty] [float] NULL,
	[lcost] [float] NOT NULL,
	[folio] [numeric](5, 0) NOT NULL,
	[fcost] [float] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[jcresources]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[jcresources](
	[rs_code] [char](4) NOT NULL,
	[rs_desc] [char](30) NOT NULL,
	[rs_ldesc] [char](30) NOT NULL,
	[rs_type] [numeric](1, 0) NOT NULL,
	[rs_hourcost] [float] NOT NULL,
	[rs_remarks] [char](30) NOT NULL,
	[modified] [bit] NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[rs_level] [numeric](1, 0) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[jcrsrsdtl]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[jcrsrsdtl](
	[rd_company] [char](2) NOT NULL,
	[rd_jcno] [numeric](10, 0) NOT NULL,
	[rd_code] [char](4) NOT NULL,
	[rd_tgthours] [float] NOT NULL,
	[rd_hourcost] [float] NOT NULL,
	[rd_remarks] [char](30) NOT NULL,
	[rd_fnlhours] [float] NOT NULL,
	[folio] [numeric](5, 0) NOT NULL,
	[rd_hourcost_fcy] [float] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[jcsetup]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[jcsetup](
	[mscomp] [char](2) NULL,
	[jc_whrcycle] [char](2) NULL,
	[jc_whfactory] [char](2) NULL,
	[jc_whready] [char](2) NULL,
	[jc_whrow] [char](2) NULL,
	[jc_itemhalik] [char](24) NULL,
	[jc_addmatitm] [bit] NULL,
	[jc_chgmatqty] [bit] NULL,
	[jc_chgwsptg] [bit] NULL,
	[jc_usefnlwste] [bit] NULL,
	[jc_seplocprdday] [bit] NULL,
	[jc_resources_cost_is_fcy] [bit] NULL,
	[brnno] [char](2) NULL,
	[sc_code] [char](4) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[jcstditmmat]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[jcstditmmat](
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[rsitemno] [char](16) NOT NULL,
	[rsunicode] [char](6) NOT NULL,
	[tgtqty] [float] NULL,
	[wastepctg] [float] NOT NULL,
	[qtyb4waste] [float] NULL,
	[cmbkey] [char](24) NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[jcstditmrsrc]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[jcstditmrsrc](
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[rs_code] [char](4) NOT NULL,
	[rs_hours] [float] NOT NULL,
	[rs_remarks] [char](30) NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[jcstitems]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[jcstitems](
	[cmbkey] [char](24) NOT NULL,
	[is_mnfctrd] [bit] NULL,
	[rs_type] [numeric](1, 0) NULL,
	[is_material] [bit] NULL,
	[unt_weight] [numeric](14, 3) NULL,
	[is_batch] [bit] NULL,
	[itm_batch_qty] [numeric](14, 3) NULL,
	[days_to_exp_fm_prod] [int] NULL,
 CONSTRAINT [PK_jcstitems] PRIMARY KEY CLUSTERED 
(
	[cmbkey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[lccsttyp]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[lccsttyp](
	[lccstcode] [char](2) NULL,
	[lccstname] [varchar](30) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[lcdraft]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[lcdraft](
	[drno] [char](15) NULL,
	[drlcno] [char](15) NULL,
	[dramount] [float] NULL,
	[drlateexp] [float] NULL,
	[drpostexp] [float] NULL,
	[drotherexp] [float] NULL,
	[drdesc] [varchar](40) NULL,
	[drdate] [datetime] NULL,
	[drdue] [datetime] NULL,
	[drcompany] [char](2) NULL,
	[drinvtype] [char](2) NULL,
	[drinvno] [numeric](6, 0) NULL,
	[drwarndays] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[lcdtl]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[lcdtl](
	[ld_type] [char](2) NULL,
	[ld_ref] [numeric](6, 0) NULL,
	[ld_date] [datetime] NULL,
	[ld_lcamt] [float] NULL,
	[ld_lc] [char](15) NULL,
	[ld_csttype] [char](2) NULL,
	[ld_ackey] [char](19) NULL,
	[ld_fcy] [char](3) NULL,
	[ld_fcamt] [float] NULL,
	[ld_trxsrc] [char](2) NULL,
	[ld_desc] [varchar](70) NULL,
	[ld_dbcr] [char](1) NULL,
	[ld_company] [char](2) NULL,
	[ld_sysdate] [datetime] NULL,
	[ld_draftno] [char](15) NULL,
	[ld_drafttrn] [char](1) NULL,
	[ld_discamt] [float] NOT NULL,
	[ld_fdscamt] [float] NOT NULL,
	[brnno] [char](2) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[lcfile]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[lcfile](
	[lcno] [char](15) NULL,
	[lcdesc] [varchar](50) NULL,
	[lcfcy] [char](3) NULL,
	[lcglacc] [char](19) NULL,
	[lcsupp] [char](6) NULL,
	[lccompany] [char](2) NULL,
	[lcbank] [char](2) NULL,
	[lcdraft] [bit] NOT NULL,
	[lctype] [char](1) NULL,
	[lccountry] [varchar](30) NULL,
	[lcgoods] [varchar](50) NULL,
	[lcvalue] [float] NULL,
	[lcopendate] [datetime] NULL,
	[lcshipdate] [datetime] NULL,
	[lcxchgdate] [datetime] NULL,
	[lcxtnddate] [datetime] NULL,
	[lcxtndreason] [varchar](30) NULL,
	[lclopnbal] [float] NULL,
	[lcfopnbal] [float] NULL,
	[lclcurbal] [float] NULL,
	[lcfcurbal] [float] NULL,
	[lceopnbal] [float] NULL,
	[lcecurbal] [float] NULL,
	[lcstatus] [numeric](1, 0) NULL,
	[lcexpdate] [datetime] NULL,
	[lcfcyrate] [float] NULL,
	[lcinsprtg] [float] NULL,
	[modified] [bit] NOT NULL,
	[lastupdt] [datetime] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[lchdr]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[lchdr](
	[lh_type] [char](2) NULL,
	[lh_ref] [numeric](6, 0) NULL,
	[lh_date] [datetime] NULL,
	[lh_fcy] [char](3) NULL,
	[lh_ftotal] [float] NULL,
	[lh_fcyrate] [numeric](8, 5) NULL,
	[lh_ltotal] [float] NULL,
	[lh_desc1] [varchar](70) NULL,
	[lh_ser] [char](19) NULL,
	[lh_rlsd] [bit] NOT NULL,
	[lh_posted] [bit] NOT NULL,
	[lh_company] [char](2) NULL,
	[lh_trxsrc] [char](2) NULL,
	[lh_sysdate] [datetime] NULL,
	[isit_opst] [bit] NOT NULL,
	[opst_val] [float] NULL,
	[opst_fcy] [char](3) NULL,
	[lh_lcnet] [float] NULL,
	[lh_fcnet] [float] NULL,
	[lh_lccnet] [float] NULL,
	[lh_fccnet] [float] NULL,
	[lh_isdraft] [char](1) NULL,
	[lastupdt] [datetime] NULL,
	[modified] [bit] NOT NULL,
	[rcvdtrn] [bit] NOT NULL,
	[usrid] [char](10) NULL,
	[lh_lc] [char](15) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[lengths_txtile]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[lengths_txtile](
	[ln_code] [char](4) NOT NULL,
	[ln_name] [varchar](10) NULL,
	[ln_lname] [varchar](10) NULL,
	[ln_pkqty] [numeric](8, 3) NULL,
 CONSTRAINT [PK_lengths] PRIMARY KEY CLUSTERED 
(
	[ln_code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[llnn]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[llnn](
	[items] [nvarchar](255) NULL,
	[lprice1] [nvarchar](255) NULL,
	[mnprice] [nvarchar](255) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[notifyMe]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[notifyMe](
	[branch] [char](2) NOT NULL,
	[trtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[folio] [numeric](2, 0) NOT NULL,
	[trdate] [char](8) NULL,
	[mode] [numeric](1, 0) NULL,
	[usrnotify] [char](10) NOT NULL,
	[datenotify] [char](8) NULL,
	[inactive] [bit] NULL,
	[notes] [text] NULL,
	[usrid] [char](10) NULL,
	[src] [char](2) NULL,
	[smsaction] [bit] NULL,
	[emailacton] [bit] NULL,
	[loginacton] [bit] NULL,
	[pemail] [varchar](50) NULL,
	[pmobile] [varchar](20) NULL,
	[smsdone] [bit] NULL,
	[emaildone] [bit] NULL,
	[autojv] [bit] NULL,
	[ntperiod] [char](1) NULL,
	[lastprdgnr] [numeric](2, 0) NULL,
	[stop_jv] [bit] NULL,
	[actcode] [char](19) NULL,
	[fcy] [char](3) NULL,
	[expdays] [numeric](4, 0) NULL,
	[report_id] [char](3) NULL,
	[isrecursv] [bit] NULL,
	[RecursvNo] [numeric](3, 0) NULL,
	[lstrptshwn] [char](8) NULL,
 CONSTRAINT [PK_notification] PRIMARY KEY CLUSTERED 
(
	[branch] ASC,
	[trtype] ASC,
	[refno] ASC,
	[folio] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
/****** Object:  Table [dbo].[NqatiBankApi]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[NqatiBankApi](
	[bk_company] [char](2) NOT NULL,
	[bk_Bank_ID] [int] NOT NULL,
	[bk_name] [varchar](80) NULL,
	[bk_lname] [varchar](80) NULL,
	[bk_urlToken] [varchar](150) NULL,
	[bk_urlAuthorization] [varchar](150) NULL,
	[bk_client_id] [varchar](80) NULL,
	[bk_client_secret] [varchar](80) NULL,
	[bk_merchantToken] [varchar](50) NULL,
	[bk_grant_type] [varchar](50) NULL,
	[bk_scope] [varchar](100) NULL,
	[usrid] [varchar](10) NULL,
	[last_updated_date] [varchar](25) NULL,
	[bk_inactive] [bit] NULL,
	[bk_glact] [char](19) NULL,
	[bk_urlClientAmt] [varchar](150) NULL,
 CONSTRAINT [PK_NqatiBankApi] PRIMARY KEY CLUSTERED 
(
	[bk_Bank_ID] ASC,
	[bk_company] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[orcountry]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[orcountry](
	[country_id] [numeric](3, 0) NOT NULL,
	[cnname] [varchar](50) NULL,
	[lcnname] [varchar](50) NULL,
	[standard_country_code] [varchar](3) NULL,
 CONSTRAINT [PK_orcountry] PRIMARY KEY CLUSTERED 
(
	[country_id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ord_dtl]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ord_dtl](
	[company] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[invdate] [char](8) NOT NULL,
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[qty] [float] NULL,
	[price] [float] NULL,
	[discpc] [numeric](5, 2) NOT NULL,
	[cost] [numeric](11, 2) NOT NULL,
	[custno] [char](6) NOT NULL,
	[fcy] [char](3) NOT NULL,
	[barcode] [char](20) NOT NULL,
	[pack] [char](1) NOT NULL,
	[pkqty] [numeric](10, 3) NULL,
	[qtyrcv] [float] NULL,
	[qtyrsv] [float] NULL,
	[lstrcvdate] [char](8) NOT NULL,
	[cmbkey] [char](24) NULL,
	[fqty] [numeric](12, 2) NULL,
	[folio] [int] NULL,
	[splyinv] [varchar](20) NULL,
	[dlvrydate] [char](8) NULL,
	[caser] [char](19) NULL,
	[brqty3] [numeric](12, 3) NULL,
	[brqty4] [numeric](12, 3) NULL,
	[shadd] [char](1) NULL,
	[shdpk] [numeric](10, 3) NULL,
	[shdqty] [numeric](9, 3) NULL,
	[frtqty] [numeric](9, 3) NULL,
	[Taxtype] [char](1) NULL,
	[remarks] [varchar](40) NULL,
	[item_bal] [numeric](13, 3) NULL,
	[mnpack0] [char](1) NULL,
	[last_ord_cost] [float] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ord_hdr]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ord_hdr](
	[branch] [char](2) NOT NULL,
	[company] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[invdate] [char](8) NOT NULL,
	[custno] [char](6) NOT NULL,
	[custnm] [varchar](50) NOT NULL,
	[glser] [char](19) NOT NULL,
	[fcy] [char](3) NOT NULL,
	[fcyrate] [numeric](6, 3) NOT NULL,
	[invttl] [float] NOT NULL,
	[invcst] [float] NOT NULL,
	[invdspc] [float] NOT NULL,
	[invdsvl] [float] NOT NULL,
	[valafds] [float] NOT NULL,
	[invpaid] [float] NOT NULL,
	[caser] [char](19) NOT NULL,
	[entries] [numeric](5, 0) NOT NULL,
	[fixrate] [numeric](6, 3) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[isl_c] [bit] NOT NULL,
	[modified] [bit] NOT NULL,
	[splyinv] [varchar](20) NULL,
	[closed] [bit] NOT NULL,
	[processed] [bit] NOT NULL,
	[rcvdtrn] [bit] NOT NULL,
	[usrid] [char](10) NULL,
	[vat_amt_paid] [float] NULL,
	[PriceIncludeVat] [bit] NULL,
	[taxfree_purchase] [float] NULL,
	[fqtyval] [float] NULL,
	[dlvry_date] [char](8) NULL,
	[tdscpcs] [numeric](5, 2) NULL,
	[tdscdays] [numeric](3, 0) NULL,
	[slcenter] [char](2) NULL,
	[slcode] [char](2) NULL,
 CONSTRAINT [PK_ord_hdr] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[orgrpitem]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[orgrpitem](
	[group_id] [numeric](7, 0) NOT NULL,
	[itmname] [char](45) NOT NULL,
	[branch] [char](2) NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[orpacking]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[orpacking](
	[pack_id] [char](1) NOT NULL,
	[pkname] [varchar](30) NULL,
	[lpkname] [char](15) NOT NULL,
	[pkorder] [char](1) NOT NULL,
	[pkdfqty] [numeric](8, 3) NULL,
	[pkwhlsl] [bit] NULL,
	[standard_unit_code] [varchar](5) NULL,
 CONSTRAINT [PK_orpacking] PRIMARY KEY CLUSTERED 
(
	[pack_id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[orpacktp]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[orpacktp](
	[pack_id] [char](1) NOT NULL,
	[pkname] [char](20) NOT NULL,
	[lpkname] [char](20) NOT NULL,
	[NoOfCartons] [numeric](8, 2) NULL,
 CONSTRAINT [PK_orpacktp] PRIMARY KEY CLUSTERED 
(
	[pack_id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[poclnt_taxcode]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[poclnt_taxcode](
	[company] [char](2) NOT NULL,
	[contr] [numeric](4, 0) NOT NULL,
	[refno] [numeric](8, 0) NOT NULL,
	[client_taxcode] [varchar](25) NULL,
	[client_name] [varchar](70) NULL,
	[updated_date] [smalldatetime] NULL,
 CONSTRAINT [PK_poclnt_taxcode] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[contr] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[poitem_btn]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[poitem_btn](
	[company] [char](2) NOT NULL,
	[button_no] [int] NOT NULL,
	[barcode] [char](20) NOT NULL,
	[short_name] [varchar](20) NULL,
	[short_lname] [varchar](20) NULL,
	[cmbkey] [char](24) NULL,
	[grp_id] [char](2) NOT NULL,
 CONSTRAINT [PK_poitem_btn] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[grp_id] ASC,
	[button_no] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[poitem_grp]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[poitem_grp](
	[company] [char](2) NOT NULL,
	[grp_id] [char](2) NOT NULL,
	[grp_name] [varchar](50) NULL,
	[grp_lname] [varchar](50) NULL,
	[net_printer_name] [varchar](60) NULL,
 CONSTRAINT [PK_poitem_grp] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[grp_id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ponqatibkinv]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ponqatibkinv](
	[company] [char](2) NOT NULL,
	[contr] [numeric](4, 0) NOT NULL,
	[refno] [numeric](8, 0) NOT NULL,
	[bk_bank_id] [int] NULL,
	[client_mobile] [varchar](15) NULL,
	[bk_amount] [float] NULL,
	[bk_transactionId] [varchar](20) NULL,
 CONSTRAINT [PK_ponqatibkinv] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[contr] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pos_chdt]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pos_chdt](
	[company] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[cstcode] [char](20) NOT NULL,
	[lcamt] [numeric](12, 2) NOT NULL,
	[folio] [int] NOT NULL,
	[sc_code] [char](6) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pos_chhd]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pos_chhd](
	[company] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[chdate] [char](8) NULL,
	[desctxt] [varchar](55) NULL,
	[lcamt] [numeric](12, 2) NOT NULL,
	[posted] [bit] NULL,
	[entries] [numeric](6, 0) NULL,
	[trdate] [char](8) NULL,
	[dbacc] [char](19) NULL,
	[cracc] [char](19) NULL,
	[chrcode] [varchar](3) NULL,
	[usrid] [char](10) NULL,
	[sc_code] [char](6) NULL,
	[glref] [int] NULL,
 CONSTRAINT [PK_pos_chhd] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pos_chrt]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pos_chrt](
	[company] [char](2) NOT NULL,
	[chrcode] [varchar](3) NOT NULL,
	[chname] [varchar](50) NULL,
	[chaddress] [varchar](60) NULL,
	[chtel] [varchar](30) NULL,
	[chfax] [varchar](20) NULL,
	[chpcntct] [varchar](40) NULL,
	[chmobile] [varchar](20) NULL,
	[chacct] [char](19) NULL,
	[saved_halals] [bit] NULL,
	[shft_fkey] [char](2) NULL,
	[sc_code] [char](6) NULL,
	[chr_taxcode] [varchar](20) NULL,
 CONSTRAINT [pk_poschrt] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[chrcode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pos_ctr]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pos_ctr](
	[ctrcompany] [char](2) NOT NULL,
	[ctrcode] [numeric](4, 0) NOT NULL,
	[ctrloc] [varchar](30) NOT NULL,
	[ctrstatus] [numeric](1, 0) NOT NULL,
	[ctrnote] [varchar](30) NOT NULL,
	[ctrcash] [bit] NOT NULL,
	[ctrrpls] [bit] NOT NULL,
	[ctrcard] [bit] NOT NULL,
	[ctrsanet] [bit] NOT NULL,
	[ctrsanetpctg] [float] NOT NULL,
	[ctrvisa] [bit] NOT NULL,
	[ctrvisapctg] [float] NOT NULL,
	[ctrmaster] [bit] NOT NULL,
	[ctrmasterpctg] [float] NOT NULL,
	[ctrothers] [bit] NOT NULL,
	[ctrotherspctg] [float] NOT NULL,
	[slcenter] [char](2) NOT NULL,
	[invser] [numeric](8, 0) NOT NULL,
	[drwrcomport] [numeric](1, 0) NOT NULL,
	[spath] [varchar](50) NOT NULL,
	[ctrserial] [char](15) NOT NULL,
	[modified] [bit] NOT NULL,
	[started] [smalldatetime] NOT NULL,
	[ended] [smalldatetime] NOT NULL,
	[drawer] [bit] NOT NULL,
	[cdisplay] [bit] NOT NULL,
	[slmsg] [varchar](45) NOT NULL,
	[rtnmsg] [varchar](45) NOT NULL,
	[footmsg1] [varchar](45) NOT NULL,
	[footmsg2] [varchar](45) NOT NULL,
	[footmsg3] [varchar](45) NOT NULL,
	[saveinserver] [bit] NOT NULL,
	[saveinvall] [bit] NOT NULL,
	[scr_open] [numeric](1, 0) NOT NULL,
	[slnoprint] [bit] NOT NULL,
	[rtnoprint] [bit] NOT NULL,
	[ccconus] [bit] NOT NULL,
	[upditem_hrs] [numeric](3, 2) NOT NULL,
	[updinv_hrs] [numeric](3, 2) NOT NULL,
	[prntbyclass] [bit] NOT NULL,
	[sltype] [bit] NOT NULL,
	[rttype] [bit] NOT NULL,
	[rptype] [bit] NOT NULL,
	[icrptype] [bit] NOT NULL,
	[ctrprpaid] [bit] NOT NULL,
	[rtfmothrs] [bit] NULL,
	[magcard] [bit] NULL,
	[usbdsply] [bit] NULL,
	[dsplycomport] [numeric](2, 0) NULL,
	[rpt_grp_items] [bit] NULL,
	[ctrsaned] [bit] NULL,
	[ctreftpos] [char](2) NULL,
	[ctrsndecrpos] [bit] NULL,
	[eftport] [numeric](2, 0) NULL,
	[ntk_printer1] [varchar](60) NULL,
	[ntk_printer2] [varchar](60) NULL,
	[grp_printers] [bit] NULL,
	[grp_prnt_local] [bit] NULL,
	[ctrotherpay] [bit] NULL,
	[cshRtn_f_o_b] [bit] NULL,
	[paybycard] [bit] NULL,
	[CTRBKNQTPAY] [bit] NULL,
	[UserCode] [varchar](20) NULL,
	[CashierCode] [varchar](20) NULL,
	[Usrpassword] [varchar](20) NULL,
	[mnfd_system] [varchar](5) NULL,
	[ctrmanafith] [bit] NULL,
	[new_secugen] [bit] NULL,
	[ctrinstlmnt_pay] [bit] NULL,
	[ctrcredit] [bit] NULL,
	[alw_taxed_invoice] [bit] NULL,
 CONSTRAINT [PK_pos_ctr] PRIMARY KEY CLUSTERED 
(
	[ctrcompany] ASC,
	[ctrcode] ASC,
	[slcenter] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pos_dsc]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pos_dsc](
	[dsccompany] [char](2) NOT NULL,
	[dsccard] [char](20) NOT NULL,
	[dscname] [varchar](50) NULL,
	[dscaddress] [varchar](30) NOT NULL,
	[dsctel] [varchar](21) NULL,
	[dscprtg] [float] NOT NULL,
	[dscstatus] [numeric](1, 0) NOT NULL,
	[dscnote] [varchar](30) NOT NULL,
	[modified] [bit] NOT NULL,
	[mnth_target] [numeric](12, 3) NULL,
	[mnthbal] [numeric](12, 3) NULL,
	[trgt_prcnt] [numeric](4, 2) NOT NULL,
	[prepaidamt] [numeric](10, 3) NULL,
	[cardtype] [numeric](1, 0) NULL,
	[cardused] [bit] NOT NULL,
	[expdate] [char](8) NULL,
	[chrcode] [varchar](3) NULL,
	[cstpassw] [char](12) NULL,
	[crtdate] [char](8) NULL,
	[crtyear] [char](4) NULL,
	[cust_ttlsales] [numeric](12, 3) NULL,
	[sales_grantd] [numeric](12, 3) NULL,
	[ttl_grantd] [numeric](12, 3) NULL,
	[vchr_value] [numeric](12, 3) NULL,
	[vchr_used] [numeric](12, 3) NULL,
	[mothercard] [char](20) NULL,
	[lastpaycard] [char](20) NULL,
	[nqati_openbal] [numeric](10, 3) NULL,
	[nodsc4promo] [bit] NULL,
	[employees_only] [bit] NULL,
	[no_payment] [bit] NULL,
	[smsvrfycode] [bit] NULL,
	[gender] [bit] NULL,
	[birthday] [date] NULL,
	[email] [varchar](50) NULL,
	[pass] [varchar](10) NULL,
	[credit_client] [bit] NULL,
	[credit_limit] [numeric](12, 3) NULL,
	[pay_once_all] [bit] NULL,
	[usrid] [varchar](10) NULL,
	[usridchg] [varchar](10) NULL,
	[added_date] [char](8) NULL,
	[lastupdt] [char](8) NULL,
 CONSTRAINT [PK_pos_dsc_1] PRIMARY KEY CLUSTERED 
(
	[dsccompany] ASC,
	[dsccard] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pos_dt]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pos_dt](
	[company] [char](2) NOT NULL,
	[contr] [numeric](4, 0) NOT NULL,
	[refno] [numeric](8, 0) NOT NULL,
	[cmbkey] [char](24) NOT NULL,
	[qty] [float] NOT NULL,
	[price] [float] NOT NULL,
	[barcode] [char](20) NOT NULL,
	[dscprsnt] [float] NULL,
	[srlno] [numeric](4, 0) NOT NULL,
	[rtrnd] [float] NULL,
	[dsc_amt] [numeric](5, 0) NULL,
	[offer_amt] [float] NULL,
	[nqati_prcnt] [numeric](3, 0) NULL,
	[scl_barcode] [varchar](13) NULL,
	[Taxtype] [char](1) NULL,
	[item_vat] [numeric](12, 3) NULL,
	[item_price_net] [float] NULL,
	[invdscamt] [float] NULL,
 CONSTRAINT [PK_pos_dt] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[contr] ASC,
	[refno] ASC,
	[srlno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pos_dtti]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pos_dtti](
	[company] [char](2) NOT NULL,
	[contr] [numeric](4, 0) NOT NULL,
	[refno] [numeric](8, 0) NOT NULL,
	[cmbkey] [char](24) NOT NULL,
	[qty] [float] NOT NULL,
	[price] [float] NOT NULL,
	[barcode] [char](20) NOT NULL,
	[dscprsnt] [float] NULL,
	[srlno] [numeric](4, 0) NOT NULL,
	[rtrnd] [numeric](10, 3) NULL,
	[dsc_amt] [numeric](5, 0) NULL,
	[offer_amt] [float] NULL,
	[nqati_prcnt] [numeric](3, 0) NULL,
	[Taxtype] [char](1) NULL,
 CONSTRAINT [PK_pos_dtti] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[contr] ASC,
	[refno] ASC,
	[srlno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[POS_ei]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[POS_ei](
	[company] [char](2) NOT NULL,
	[contr] [numeric](4, 0) NOT NULL,
	[refno] [numeric](8, 0) NOT NULL,
	[InvoiceTypeCode] [varchar](6) NULL,
	[tax_invoice_type] [char](2) NULL,
	[uuid] [uniqueidentifier] ROWGUIDCOL  NULL,
	[previousInvoiceHash] [text] NULL,
	[QRvalue] [text] NULL,
	[Order_ref_id] [varchar](50) NULL,
	[ContractDocRef] [varchar](50) NULL,
	[PaymentType] [varchar](50) NULL,
	[InvoiceTransactionCode] [varchar](10) NULL,
	[DebitCreditReason] [varchar](60) NULL,
	[CurrentInvoiceHash] [text] NULL,
	[InvoiceCounterValue] [int] NULL,
	[LatestDeliveryDate] [date] NULL,
	[einv_is_sent] [int] NULL,
	[ubl] [text] NULL,
	[invoice_charges] [float] NULL,
	[ExemptionReason] [varchar](100) NULL,
	[EXEMPTIONCODE] [varchar](25) NULL,
	[reason_not_sent] [varchar](2000) NULL,
	[zatca_datetime] [varchar](40) NULL,
	[folio] [varchar](20) NULL,
	[deviceSN] [varchar](100) NULL,
	[zatca_conn] [numeric](1, 0) NULL,
	[clnt_taxcode] [varchar](20) NULL,
 CONSTRAINT [PK_pos_ei] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[contr] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pos_hd]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pos_hd](
	[company] [char](2) NOT NULL,
	[contr] [numeric](4, 0) NOT NULL,
	[refno] [numeric](8, 0) NOT NULL,
	[invdate] [date] NOT NULL,
	[entries] [numeric](5, 0) NOT NULL,
	[slperson] [numeric](6, 0) NOT NULL,
	[paytype] [numeric](1, 0) NOT NULL,
	[chargepctg] [float] NOT NULL,
	[chargeamt] [float] NULL,
	[invdspc] [float] NULL,
	[disccard] [char](20) NOT NULL,
	[cardtype] [numeric](1, 0) NOT NULL,
	[invttl] [float] NOT NULL,
	[invcst] [float] NOT NULL,
	[invdsvl] [float] NOT NULL,
	[valafds] [float] NOT NULL,
	[invpaid] [numeric](12, 3) NULL,
	[pricetp] [char](1) NOT NULL,
	[slcenter] [char](2) NOT NULL,
	[invorrtrn] [char](1) NOT NULL,
	[cashamt] [float] NULL,
	[modified] [bit] NOT NULL,
	[salinvno] [numeric](8, 0) NOT NULL,
	[salctrno] [numeric](4, 0) NOT NULL,
	[tdatetime] [datetime] NULL,
	[cktype] [numeric](1, 0) NOT NULL,
	[geninv] [numeric](6, 0) NOT NULL,
	[rref] [numeric](8, 0) NOT NULL,
	[rcontr] [numeric](4, 0) NOT NULL,
	[ccpaid] [float] NULL,
	[ccconus] [bit] NOT NULL,
	[prepaidamt] [float] NULL,
	[fmbranch] [char](2) NULL,
	[mobile] [char](11) NULL,
	[fcamt] [numeric](18, 5) NULL,
	[custtype] [numeric](1, 0) NULL,
	[paycard] [char](20) NULL,
	[frc_rtncash] [bit] NULL,
	[saned_amt] [numeric](12, 3) NULL,
	[rtncshamt] [float] NULL,
	[dfvchramt] [numeric](12, 3) NULL,
	[vat_amt_rcvd] [float] NULL,
	[taxfree_sales] [float] NULL,
	[hlldscnt] [float] NULL,
	[discamt] [bit] NULL,
	[No_round_nm] [bit] NULL,
	[PriceVatType] [numeric](1, 0) NULL,
	[CashDsc4RtnPrepaid] [float] NULL,
	[stcpay_amt] [float] NULL,
	[outside_order] [bit] NULL,
	[qitaf_amt] [float] NULL,
	[whlslinv] [bit] NULL,
	[vat_percent] [numeric](5, 2) NULL,
	[usrid] [numeric](6, 0) NULL,
	[paybycard] [bit] NULL,
	[bk_amount] [float] NULL,
	[deleted_geninv] [numeric](8, 0) NULL,
	[slcode] [char](2) NULL,
	[inv_copies_no] [numeric](3, 0) NULL,
	[chrty_code] [char](1) NULL,
	[installment_amt] [float] NULL,
	[zatca_rounding] [bit] NULL,
 CONSTRAINT [PK_pos_hd] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[contr] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pos_hdti]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pos_hdti](
	[company] [char](2) NOT NULL,
	[contr] [numeric](4, 0) NOT NULL,
	[refno] [numeric](8, 0) NOT NULL,
	[invdate] [date] NOT NULL,
	[entries] [numeric](5, 0) NOT NULL,
	[slperson] [numeric](6, 0) NOT NULL,
	[paytype] [numeric](1, 0) NOT NULL,
	[chargepctg] [float] NOT NULL,
	[chargeamt] [float] NULL,
	[invdspc] [float] NULL,
	[disccard] [char](20) NOT NULL,
	[cardtype] [numeric](1, 0) NOT NULL,
	[invttl] [float] NOT NULL,
	[invcst] [float] NOT NULL,
	[invdsvl] [float] NOT NULL,
	[valafds] [float] NOT NULL,
	[invpaid] [numeric](11, 2) NOT NULL,
	[pricetp] [char](1) NOT NULL,
	[slcenter] [char](2) NOT NULL,
	[invorrtrn] [char](1) NOT NULL,
	[cashamt] [numeric](11, 2) NOT NULL,
	[modified] [bit] NOT NULL,
	[salinvno] [numeric](8, 0) NOT NULL,
	[salctrno] [numeric](4, 0) NOT NULL,
	[tdatetime] [datetime] NULL,
	[cktype] [numeric](1, 0) NOT NULL,
	[geninv] [numeric](6, 0) NOT NULL,
	[rref] [numeric](8, 0) NOT NULL,
	[rcontr] [numeric](4, 0) NOT NULL,
	[ccpaid] [numeric](11, 2) NOT NULL,
	[ccconus] [bit] NOT NULL,
	[prepaidamt] [numeric](11, 2) NULL,
	[fmbranch] [char](2) NULL,
	[mobile] [char](11) NULL,
	[fcamt] [numeric](18, 5) NULL,
	[custtype] [numeric](1, 0) NULL,
	[paycard] [char](20) NULL,
	[saned_amt] [numeric](12, 2) NULL,
	[rtncshamt] [numeric](12, 2) NULL,
	[dfvchramt] [numeric](12, 2) NULL,
	[invstatus] [int] NULL,
	[vat_amt_rcvd] [float] NULL,
	[taxfree_sales] [float] NULL,
	[hlldscnt] [float] NULL,
	[discamt] [bit] NULL,
	[No_round_nm] [bit] NULL,
	[PriceVatType] [numeric](1, 0) NULL,
	[stcpay_amt] [float] NULL,
	[Qitaf_amt] [float] NULL,
	[outside_order] [bit] NULL,
	[vat_percent] [numeric](5, 2) NULL,
 CONSTRAINT [PK_pos_hdti] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[contr] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pos_mny]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pos_mny](
	[company] [char](2) NOT NULL,
	[contr] [numeric](4, 0) NOT NULL,
	[mnydate] [date] NOT NULL,
	[slpcode] [numeric](6, 0) NOT NULL,
	[oner] [numeric](12, 0) NOT NULL,
	[fiver] [numeric](12, 0) NOT NULL,
	[tenr] [numeric](12, 0) NOT NULL,
	[twntyr] [numeric](12, 0) NOT NULL,
	[fiftyr] [numeric](12, 0) NOT NULL,
	[hundredr] [numeric](12, 0) NOT NULL,
	[twohandr] [numeric](12, 0) NOT NULL,
	[fivehandr] [numeric](12, 0) NOT NULL,
	[modified] [bit] NOT NULL,
	[rtnval] [numeric](11, 2) NOT NULL,
	[network] [numeric](11, 2) NOT NULL,
	[prepaidamt] [numeric](11, 2) NULL,
	[scrtnval] [numeric](12, 2) NULL,
	[scnetwork] [numeric](12, 2) NULL,
	[scprepaidamt] [numeric](12, 2) NULL,
	[sccash] [numeric](12, 2) NULL,
	[saned_amt] [numeric](12, 2) NULL,
	[scsaned_amt] [numeric](12, 2) NULL,
	[fiveh] [numeric](8, 0) NULL,
	[tenh] [numeric](8, 0) NULL,
	[twntyfiveh] [numeric](8, 0) NULL,
	[fiftyh] [numeric](8, 0) NULL,
	[stcpay_amt] [float] NULL,
	[Qitaf_amt] [float] NULL,
 CONSTRAINT [PK_pos_mny_1] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[contr] ASC,
	[mnydate] ASC,
	[slpcode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pos_nqmbr]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pos_nqmbr](
	[nq_mobile] [char](20) NOT NULL,
	[nq_name] [varchar](50) NULL,
	[nq_address] [varchar](50) NULL,
	[nq_email] [varchar](50) NULL,
	[nq_prsn_identified_tel] [char](20) NULL,
	[nq_disccard] [char](20) NULL,
	[nq_lastupdt] [char](8) NULL,
	[nq_date_registered] [char](8) NULL,
 CONSTRAINT [PK_pos_nqmbr] PRIMARY KEY CLUSTERED 
(
	[nq_mobile] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pos_slp]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pos_slp](
	[slpcompany] [char](2) NOT NULL,
	[slpcode] [numeric](6, 0) NOT NULL,
	[slpname] [varchar](30) NOT NULL,
	[slpaddress] [varchar](30) NOT NULL,
	[slptel] [char](12) NOT NULL,
	[slppassword] [varchar](100) NOT NULL,
	[slpchgqty] [bit] NOT NULL,
	[slpchgprice] [bit] NOT NULL,
	[slpdelline] [bit] NOT NULL,
	[slpothersinv] [bit] NOT NULL,
	[slpreturn] [bit] NOT NULL,
	[slpstatus] [numeric](1, 0) NOT NULL,
	[slpalowdisc] [bit] NOT NULL,
	[slpmaxdisc] [float] NOT NULL,
	[slppricetp] [char](1) NOT NULL,
	[slpalowcancel] [bit] NOT NULL,
	[slpalowopdr] [bit] NOT NULL,
	[modified] [bit] NOT NULL,
	[slpalowexit] [bit] NOT NULL,
	[slprtwoinv] [bit] NOT NULL,
	[slpblowbal] [bit] NOT NULL,
	[scr_open] [numeric](2, 0) NULL,
	[alwitmdsc] [bit] NOT NULL,
	[maxitmdsc] [numeric](2, 0) NULL,
	[alwuserpls] [bit] NOT NULL,
	[alwuseicrpls] [bit] NOT NULL,
	[slpmagnetic] [bit] NULL,
	[alwusebrrtn] [bit] NULL,
	[alwreprint] [bit] NULL,
	[frcrplinv] [bit] NULL,
	[catch_thief] [bit] NULL,
	[sold_once] [bit] NULL,
	[only_scan_bc] [bit] NULL,
	[stop_item_column] [bit] NULL,
	[slpfpalw] [bit] NULL,
	[slpfpimage] [text] NULL,
	[slcenter] [char](2) NULL,
	[salesquota] [numeric](13, 2) NULL,
	[commissionP] [numeric](9, 3) NULL,
	[bonus] [numeric](13, 2) NULL,
	[supervisor] [bit] NULL,
	[ReadInvByBarcd] [bit] NULL,
	[alwcshcardpay] [bit] NULL,
	[alwrtncash] [bit] NULL,
	[alwmtchrtn] [bit] NULL,
	[alwinvtrnsfr] [bit] NULL,
	[slp_hlldscamtMAX] [numeric](3, 2) NULL,
	[alwprnttmpinv] [bit] NULL,
	[ignore_mnmprice] [bit] NULL,
	[NoExceed_hll] [bit] NULL,
	[showallsuspndinv] [bit] NULL,
	[slpfpimage2] [text] NULL,
	[nodelchgmny] [bit] NULL,
	[delitmbybrcd] [bit] NULL,
	[noinvprint_atsave] [bit] NULL,
	[No_item_srch_in_inv] [bit] NULL,
	[No_dsc_if_no_mobile] [bit] NULL,
	[slpfpimage3] [text] NULL,
	[alwexcdmaxqty] [bit] NULL,
	[alwcsh_rtrn_L2yr] [bit] NULL,
 CONSTRAINT [PK_pos_slp] PRIMARY KEY CLUSTERED 
(
	[slpcompany] ASC,
	[slpcode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
/****** Object:  Table [dbo].[poscccard]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[poscccard](
	[company] [char](2) NOT NULL,
	[contr] [numeric](4, 0) NOT NULL,
	[refno] [numeric](8, 0) NOT NULL,
	[cccardno] [char](20) NOT NULL,
	[ccsrlno] [int] NOT NULL,
	[cardtype] [numeric](1, 0) NULL,
	[ccpaid] [float] NULL,
	[ccconus] [bit] NULL,
	[chargepctg] [float] NULL,
	[chargeamt] [float] NULL,
	[cctype] [varchar](25) NULL,
	[approvl_no] [char](6) NULL,
	[TransDate] [char](10) NULL,
	[TransTime] [char](10) NULL,
	[TransNo] [varchar](12) NULL,
	[terminal_id] [varchar](16) NULL,
 CONSTRAINT [PK_poscccard] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[contr] ASC,
	[refno] ASC,
	[cccardno] ASC,
	[ccsrlno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[poschrtinv]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[poschrtinv](
	[company] [char](2) NOT NULL,
	[contr] [numeric](4, 0) NOT NULL,
	[refno] [numeric](8, 0) NOT NULL,
	[hllamt] [numeric](6, 3) NULL,
	[chrcode] [varchar](3) NULL,
 CONSTRAINT [PK_poschrtinv] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[contr] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[posdlvry]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[posdlvry](
	[company] [char](2) NOT NULL,
	[contr] [numeric](4, 0) NOT NULL,
	[refno] [numeric](8, 0) NOT NULL,
	[mobile_No] [varchar](30) NULL,
	[client_name] [varchar](50) NULL,
	[client_address] [varchar](50) NULL,
	[delivery_date] [smalldatetime] NULL,
	[meal_type] [numeric](1, 0) NULL,
	[No_of_dishes] [int] NULL,
	[remarks] [varchar](80) NULL,
	[room_no] [numeric](4, 0) NULL,
	[table_no] [numeric](4, 0) NULL,
 CONSTRAINT [PK_posdlvry] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[contr] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[posfcamt]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[posfcamt](
	[company] [char](2) NOT NULL,
	[contr] [numeric](4, 0) NOT NULL,
	[refno] [numeric](8, 0) NOT NULL,
	[fcy] [char](3) NOT NULL,
	[fcamt] [numeric](12, 3) NOT NULL,
	[fcyrate] [numeric](10, 5) NOT NULL,
	[lcamt] [float] NULL,
	[srlno] [numeric](2, 0) NOT NULL,
 CONSTRAINT [PK_posfcamt] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[contr] ASC,
	[refno] ASC,
	[srlno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[posinstlmnt_trx]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[posinstlmnt_trx](
	[company] [char](2) NOT NULL,
	[contr] [numeric](4, 0) NOT NULL,
	[refno] [numeric](8, 0) NOT NULL,
	[trx_inscode] [numeric](3, 0) NOT NULL,
	[trx_cmsn_pd_by_buyer] [bit] NULL,
	[trx_instaxable] [bit] NULL,
	[trx_inscommprcnt] [numeric](6, 3) NULL,
	[trx_inscommamt] [numeric](10, 3) NULL,
	[installment_amt] [float] NULL,
	[trx_buyer_mobile] [varchar](15) NULL,
	[trx_confirmed_code] [varchar](50) NULL,
	[trx_instlmnt_vourcher] [varchar](50) NULL,
	[trx_buyer_name] [varchar](40) NULL,
	[trx_commp_notrtnd] [numeric](6, 3) NULL,
	[api_auto_connect] [bit] NULL,
	[installment_amt_rtn] [float] NULL,
	[trx_request_id] [varchar](50) NULL,
	[trx_send_latin] [bit] NULL,
	[trx_is_production] [bit] NULL,
 CONSTRAINT [PK_posinstlmnt_trx] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[contr] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[posinvoffer]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[posinvoffer](
	[company] [char](2) NOT NULL,
	[contr] [numeric](4, 0) NOT NULL,
	[refno] [numeric](8, 0) NOT NULL,
	[srlno] [numeric](4, 0) NOT NULL,
	[msbrcd_srlno] [numeric](4, 0) NULL,
	[offer_type] [numeric](2, 0) NULL,
	[itemgroup] [char](1) NULL,
	[minqty] [numeric](10, 3) NULL,
	[givenamt] [float] NULL,
	[givenqty] [numeric](10, 3) NULL,
	[Max2buy] [numeric](10, 3) NULL,
	[grp_min_qty] [int] NULL,
	[grp_partial] [bit] NULL,
	[grp_no] [int] NULL,
	[offer_no] [int] NULL,
	[grp_flexable] [bit] NULL,
 CONSTRAINT [PK_posdt_offer] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[contr] ASC,
	[refno] ASC,
	[srlno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[posmnfthcard]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[posmnfthcard](
	[company] [char](2) NOT NULL,
	[contr] [numeric](4, 0) NOT NULL,
	[refno] [numeric](8, 0) NOT NULL,
	[clncard] [varchar](20) NOT NULL,
	[itemcode] [varchar](20) NOT NULL,
	[paidamt] [float] NULL,
	[mnorgname] [varchar](60) NULL,
	[mnorgtaxcode] [varchar](20) NULL,
	[invoiceType] [char](1) NULL,
	[balancetype] [varchar](20) NULL,
	[mnqty] [numeric](12, 3) NULL,
	[manafithtrxid] [varchar](20) NULL,
	[mn_vat_amt] [float] NULL,
	[requestid] [varchar](20) NULL,
 CONSTRAINT [PK_posmnfthcard] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[contr] ASC,
	[refno] ASC,
	[clncard] ASC,
	[itemcode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[posppcard]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[posppcard](
	[company] [char](2) NOT NULL,
	[contr] [numeric](4, 0) NOT NULL,
	[refno] [numeric](8, 0) NOT NULL,
	[disccard] [char](20) NOT NULL,
	[paytype] [numeric](1, 0) NULL,
	[prepaidamt] [float] NULL,
	[paycard] [char](20) NOT NULL,
	[nodsc4promo] [bit] NULL,
	[prepaidamt_rtn] [float] NULL,
 CONSTRAINT [PK_posppcard] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[contr] ASC,
	[refno] ASC,
	[disccard] ASC,
	[paycard] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[posrtninv]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[posrtninv](
	[company] [char](2) NOT NULL,
	[rcontr] [numeric](4, 0) NOT NULL,
	[rref] [numeric](8, 0) NOT NULL,
	[contr] [numeric](4, 0) NOT NULL,
	[refno] [numeric](8, 0) NOT NULL,
	[rtnamt] [numeric](12, 2) NULL,
 CONSTRAINT [PK_posrtninv] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[rcontr] ASC,
	[rref] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[possanedchrty]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[possanedchrty](
	[company] [char](2) NOT NULL,
	[contr] [numeric](4, 0) NOT NULL,
	[refno] [numeric](8, 0) NOT NULL,
	[chrty_code] [varchar](3) NULL,
	[mobileno] [varchar](20) NULL,
	[approval_code] [varchar](20) NULL,
	[saned_amt] [float] NULL,
 CONSTRAINT [PK_possanedchrty] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[contr] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pp_abs_multiple]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pp_abs_multiple](
	[company] [char](2) NOT NULL,
	[fm_date] [char](8) NOT NULL,
	[to_date] [char](8) NOT NULL,
	[dept] [char](2) NOT NULL,
	[grp] [char](2) NOT NULL,
	[fm_day] [numeric](2, 0) NOT NULL,
	[to_day] [numeric](2, 0) NOT NULL,
	[d1_p1_ptg] [numeric](7, 2) NOT NULL,
	[d1_p2_ptg] [numeric](7, 2) NOT NULL,
	[d1_p3_ptg] [numeric](7, 2) NOT NULL,
	[d2_p1_ptg] [numeric](7, 2) NOT NULL,
	[d2_p2_ptg] [numeric](7, 2) NOT NULL,
	[d2_p3_ptg] [numeric](7, 2) NOT NULL,
	[d3_p1_ptg] [numeric](7, 2) NOT NULL,
	[d3_p2_ptg] [numeric](7, 2) NOT NULL,
	[d3_p3_ptg] [numeric](7, 2) NOT NULL,
	[d4_p1_ptg] [numeric](7, 2) NOT NULL,
	[d4_p2_ptg] [numeric](7, 2) NOT NULL,
	[d4_p3_ptg] [numeric](7, 2) NOT NULL,
	[d5_p1_ptg] [numeric](7, 2) NOT NULL,
	[d5_p2_ptg] [numeric](7, 2) NOT NULL,
	[d5_p3_ptg] [numeric](7, 2) NOT NULL,
	[d6_p1_ptg] [numeric](7, 2) NOT NULL,
	[d6_p2_ptg] [numeric](7, 2) NOT NULL,
	[d6_p3_ptg] [numeric](7, 2) NOT NULL,
	[d7_p1_ptg] [numeric](7, 2) NOT NULL,
	[d7_p2_ptg] [numeric](7, 2) NOT NULL,
	[d7_p3_ptg] [numeric](7, 2) NOT NULL,
	[remarks] [char](40) NOT NULL,
	[modified] [bit] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pp_abs_permissions]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pp_abs_permissions](
	[company] [char](2) NOT NULL,
	[empcode] [char](6) NOT NULL,
	[work_date] [char](8) NOT NULL,
	[timing_1] [char](2) NOT NULL,
	[ok_1] [bit] NOT NULL,
	[timing_1_permitted] [bit] NOT NULL,
	[timing_2] [char](2) NOT NULL,
	[ok_2] [bit] NOT NULL,
	[timing_2_permitted] [bit] NOT NULL,
	[timing_3] [char](2) NOT NULL,
	[ok_3] [bit] NOT NULL,
	[timing_3_permitted] [bit] NOT NULL,
	[permit_reason] [varchar](70) NOT NULL,
	[permitted_by] [varchar](30) NOT NULL,
	[crtd_dttime] [smalldatetime] NOT NULL,
	[usrid] [char](10) NOT NULL,
	[modified] [bit] NOT NULL,
	[lastupdt] [char](8) NOT NULL,
 CONSTRAINT [PK_pp_abs_permissions_1] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[empcode] ASC,
	[work_date] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pp_att_all]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pp_att_all](
	[id] [bigint] IDENTITY(1,1) NOT NULL,
	[empNo] [varchar](10) NULL,
	[logDate] [varchar](8) NULL,
	[logTime] [varchar](5) NULL,
	[punchdTime] [smalldatetime] NULL,
 CONSTRAINT [PK_logAtt] PRIMARY KEY CLUSTERED 
(
	[id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pp_emp_late_permissions]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pp_emp_late_permissions](
	[company] [char](2) NOT NULL,
	[empcode] [char](6) NOT NULL,
	[work_date] [char](8) NOT NULL,
	[timing_1] [char](2) NOT NULL,
	[ok_1] [bit] NOT NULL,
	[timing_1_minutes] [smallint] NOT NULL,
	[timing_2] [char](2) NOT NULL,
	[ok_2] [bit] NOT NULL,
	[timing_2_minutes] [smallint] NOT NULL,
	[timing_3] [char](2) NOT NULL,
	[ok_3] [bit] NOT NULL,
	[timing_3_minutes] [smallint] NOT NULL,
	[permit_reason] [varchar](70) NOT NULL,
	[permitted_by] [varchar](30) NOT NULL,
	[crtd_dttime] [smalldatetime] NOT NULL,
	[usrid] [char](10) NOT NULL,
	[modified] [bit] NOT NULL,
	[lastupdt] [char](8) NOT NULL,
 CONSTRAINT [PK_pp_emp_late_permissions] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[empcode] ASC,
	[work_date] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pp_emp_requests]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pp_emp_requests](
	[rq_id] [int] NOT NULL,
	[rq_empno] [char](6) NOT NULL,
	[rq_company] [char](2) NOT NULL,
	[dept_no] [char](2) NULL,
	[grp] [char](2) NULL,
	[rq_time] [smalldatetime] NOT NULL,
	[rq_type] [char](1) NOT NULL,
	[rq_lv_type] [char](1) NULL,
	[rq_lv_fmdate] [char](8) NULL,
	[rq_lv_todate] [char](8) NULL,
	[rq_loan_type] [char](2) NULL,
	[rq_loan_date] [char](8) NULL,
	[rq_loan_Amount] [float] NULL,
	[rq_late_permsn_date] [char](8) NULL,
	[rq_late_prd_1] [char](2) NULL,
	[rq_late_minutes_1] [smallint] NULL,
	[rq_late_prd_2] [char](2) NULL,
	[rq_late_minutes_2] [smallint] NULL,
	[rq_late_prd_3] [char](2) NULL,
	[rq_late_minutes_3] [smallint] NULL,
	[rq_abs_permsn_date] [char](8) NULL,
	[rq_abs_prd_1] [char](2) NULL,
	[rq_abs_prmt_1] [bit] NULL,
	[rq_abs_prd_2] [char](2) NULL,
	[rq_abs_prmt_2] [bit] NULL,
	[rq_abs_prd_3] [char](2) NULL,
	[rq_abs_prmt_3] [bit] NULL,
	[rq_status] [char](1) NOT NULL,
	[remarks] [varchar](100) NULL,
	[admin_reply] [numeric](1, 0) NULL,
	[approved_fmdate] [char](8) NULL,
	[approved_todate] [char](8) NULL,
	[approved_Amount] [float] NULL,
	[approved_late_minutes_1] [smallint] NULL,
	[approved_late_minutes_2] [smallint] NULL,
	[approved_late_minutes_3] [smallint] NULL,
	[approved_abs_prmt_1] [bit] NULL,
	[approved_abs_prmt_2] [bit] NULL,
	[approved_abs_prmt_3] [bit] NULL,
	[admin_remarks] [varchar](100) NULL,
	[usrid] [char](10) NULL,
	[modified] [bit] NULL,
	[lastupdt] [char](8) NOT NULL,
 CONSTRAINT [PK_pp_emp_requests] PRIMARY KEY CLUSTERED 
(
	[rq_id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pp_indemnity_settlments]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pp_indemnity_settlments](
	[company] [char](2) NOT NULL,
	[empno] [char](6) NOT NULL,
	[stlmnt_date] [char](8) NOT NULL,
	[termination_reason] [char](1) NOT NULL,
	[last_stlmnt_date] [char](8) NOT NULL,
	[last_stlmnt_bal] [float] NOT NULL,
	[last_indemnity_stlmnt_date] [char](8) NOT NULL,
	[join_date] [char](8) NOT NULL,
	[base_date] [char](8) NOT NULL,
	[base_date_indemnity] [char](8) NOT NULL,
	[deptcode] [char](2) NOT NULL,
	[grp] [char](2) NOT NULL,
	[salary] [float] NOT NULL,
	[srvc_days_ttl] [int] NOT NULL,
	[srvc_years] [numeric](2, 0) NOT NULL,
	[srvc_months] [numeric](2, 0) NOT NULL,
	[srvc_days] [numeric](2, 0) NOT NULL,
	[leav_with_no_pay_ttl] [float] NOT NULL,
	[yearly_leave] [numeric](6, 2) NOT NULL,
	[leavopen] [float] NOT NULL,
	[leavopen_stlmnt_date] [char](8) NOT NULL,
	[leavbal] [float] NOT NULL,
	[leav_clcltd_days] [float] NOT NULL,
	[leav_taken] [float] NOT NULL,
	[leav_balance] [float] NOT NULL,
	[leav_amount] [float] NOT NULL,
	[tickets_amount] [float] NOT NULL,
	[tickets_months] [numeric](6, 2) NOT NULL,
	[grantd_ticket_amount] [float] NOT NULL,
	[loans_balance] [float] NOT NULL,
	[srvc_indmnty_days_ttl] [int] NOT NULL,
	[srvc_indmnty_years] [numeric](2, 0) NOT NULL,
	[srvc_indmnty_months] [numeric](2, 0) NOT NULL,
	[srvc_indmnty_days] [numeric](2, 0) NOT NULL,
	[leav_with_no_pay_indmnty_ttl] [int] NOT NULL,
	[net_srvc_indmnty_days] [int] NOT NULL,
	[no_indemnity] [bit] NOT NULL,
	[indmty_value] [float] NOT NULL,
	[other_deductions] [float] NOT NULL,
	[other_additions] [float] NOT NULL,
	[net_amount] [float] NOT NULL,
	[remarks] [varchar](70) NOT NULL,
	[crtd_dttime] [smalldatetime] NOT NULL,
	[usrid] [char](10) NOT NULL,
	[modified] [bit] NOT NULL,
	[lastupdt] [char](8) NOT NULL,
 CONSTRAINT [PK_pp_indemnity_settlments] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[empno] ASC,
	[stlmnt_date] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pp_indemnity_setup]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pp_indemnity_setup](
	[t_code] [char](1) NOT NULL,
	[no_indemnity] [bit] NOT NULL,
	[below_2_years] [int] NOT NULL,
	[below_5_2_years] [int] NOT NULL,
	[below_5_rest_years] [int] NOT NULL,
	[below_10_2_years] [int] NOT NULL,
	[below_10_5_years] [int] NOT NULL,
	[below_10_rest_years] [int] NOT NULL,
	[above_10_2_years] [int] NOT NULL,
	[above_10_5_years] [int] NOT NULL,
	[above_10_10_years] [int] NOT NULL,
	[above_10_rest_years] [int] NOT NULL,
	[t_remarks] [varchar](90) NOT NULL,
	[modified] [bit] NOT NULL,
	[lastupdt] [char](8) NOT NULL,
 CONSTRAINT [PK_pp_indemnity_setup] PRIMARY KEY CLUSTERED 
(
	[t_code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pp_late_permissions]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pp_late_permissions](
	[company] [char](2) NOT NULL,
	[fm_date] [char](8) NOT NULL,
	[to_date] [char](8) NOT NULL,
	[dept] [char](2) NOT NULL,
	[grp] [char](2) NOT NULL,
	[fm_day] [numeric](2, 0) NOT NULL,
	[to_day] [numeric](2, 0) NOT NULL,
	[d1_p1_ok] [bit] NOT NULL,
	[d1_p2_ok] [bit] NOT NULL,
	[d1_p3_ok] [bit] NOT NULL,
	[d2_p1_ok] [bit] NOT NULL,
	[d2_p2_ok] [bit] NOT NULL,
	[d2_p3_ok] [bit] NOT NULL,
	[d3_p1_ok] [bit] NOT NULL,
	[d3_p2_ok] [bit] NOT NULL,
	[d3_p3_ok] [bit] NOT NULL,
	[d4_p1_ok] [bit] NOT NULL,
	[d4_p2_ok] [bit] NOT NULL,
	[d4_p3_ok] [bit] NOT NULL,
	[d5_p1_ok] [bit] NOT NULL,
	[d5_p2_ok] [bit] NOT NULL,
	[d5_p3_ok] [bit] NOT NULL,
	[d6_p1_ok] [bit] NOT NULL,
	[d6_p2_ok] [bit] NOT NULL,
	[d6_p3_ok] [bit] NOT NULL,
	[d7_p1_ok] [bit] NOT NULL,
	[d7_p2_ok] [bit] NOT NULL,
	[d7_p3_ok] [bit] NOT NULL,
	[remarks] [char](40) NOT NULL,
	[modified] [bit] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pp_leave_settlments]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pp_leave_settlments](
	[company] [char](2) NOT NULL,
	[empno] [char](6) NOT NULL,
	[stlmnt_date] [char](8) NOT NULL,
	[last_rtn_fm_leave] [char](8) NOT NULL,
	[last_stlmnt_date] [char](8) NOT NULL,
	[last_stlmnt_bal] [float] NOT NULL,
	[join_date] [char](8) NOT NULL,
	[base_date] [char](8) NOT NULL,
	[deptcode] [char](2) NOT NULL,
	[grp] [char](2) NOT NULL,
	[salary] [float] NOT NULL,
	[srvc_days_ttl] [int] NOT NULL,
	[srvc_years] [numeric](2, 0) NOT NULL,
	[srvc_months] [numeric](2, 0) NOT NULL,
	[srvc_days] [numeric](2, 0) NOT NULL,
	[leav_with_no_pay_ttl] [float] NOT NULL,
	[yearly_leave] [numeric](6, 2) NOT NULL,
	[leavopen] [float] NOT NULL,
	[leavopen_stlmnt_date] [char](8) NOT NULL,
	[leavbal] [float] NOT NULL,
	[leav_clcltd_days] [float] NOT NULL,
	[leav_taken] [float] NOT NULL,
	[leav_balance] [float] NOT NULL,
	[leav_amount] [float] NOT NULL,
	[tickets_amount] [float] NOT NULL,
	[tickets_months] [numeric](6, 2) NOT NULL,
	[grantd_ticket_amount] [float] NOT NULL,
	[loans_balance] [float] NOT NULL,
	[other_deductions] [float] NOT NULL,
	[other_additions] [float] NOT NULL,
	[net_amount] [float] NOT NULL,
	[remarks] [varchar](70) NOT NULL,
	[crtd_dttime] [smalldatetime] NOT NULL,
	[usrid] [char](10) NOT NULL,
	[modified] [bit] NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[rqstd_normal_days] [float] NULL,
	[approved_normal_days] [float] NULL,
	[normal_lv_from] [char](8) NULL,
	[normal_lv_to] [char](8) NULL,
	[rqstd_wopay_days] [float] NULL,
	[approved_wopay_days] [float] NULL,
	[wopay_lv_from] [char](8) NULL,
	[wopay_lv_to] [char](8) NULL,
 CONSTRAINT [PK_pp_leave_settlments] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[empno] ASC,
	[stlmnt_date] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pp_spcl_leaves]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pp_spcl_leaves](
	[sp_id] [int] NOT NULL,
	[empno] [char](6) NOT NULL,
	[company] [char](2) NOT NULL,
	[sp_date] [char](8) NULL,
	[sp_time] [smalldatetime] NOT NULL,
	[sp_days] [float] NULL,
	[sp_authorisedby] [varchar](30) NULL,
	[sp_remarks] [varchar](70) NULL,
	[posted] [bit] NULL,
	[usrid] [char](10) NULL,
	[modified] [bit] NULL,
	[lastupdt] [char](8) NOT NULL,
 CONSTRAINT [PK_pp_spcl_leaves] PRIMARY KEY CLUSTERED 
(
	[sp_id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pp_termination_reasons]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pp_termination_reasons](
	[t_code] [char](1) NOT NULL,
	[t_reason] [varchar](100) NOT NULL,
	[t_lreason] [varchar](100) NOT NULL,
	[t_remarks] [varchar](90) NOT NULL,
	[modified] [bit] NOT NULL,
	[lastupdt] [char](8) NOT NULL,
 CONSTRAINT [PK_pp_termination_reasons] PRIMARY KEY CLUSTERED 
(
	[t_code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pp_violations_penalties]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pp_violations_penalties](
	[vcode] [char](5) NOT NULL,
	[violation_desc] [varchar](250) NULL,
	[violation_ldesc] [varchar](250) NULL,
	[frst_time_pnlty_type] [char](2) NULL,
	[frst_time_pnlty_hdptg] [numeric](7, 2) NULL,
	[frst_time_pnlty_text] [varchar](250) NULL,
	[frst_time_pnlty_ltext] [varchar](250) NULL,
	[scnd_time_pnlty_type] [char](2) NULL,
	[scnd_time_pnlty_hdptg] [numeric](7, 2) NULL,
	[scnd_time_pnlty_text] [varchar](250) NULL,
	[scnd_time_pnlty_ltext] [varchar](250) NULL,
	[thrd_time_pnlty_type] [char](2) NULL,
	[thrd_time_pnlty_hdptg] [numeric](7, 2) NULL,
	[thrd_time_pnlty_text] [varchar](250) NULL,
	[thrd_time_pnlty_ltext] [varchar](250) NULL,
	[frth_time_pnlty_type] [char](2) NULL,
	[frth_time_pnlty_hdptg] [numeric](7, 2) NULL,
	[frth_time_pnlty_text] [varchar](250) NULL,
	[frth_time_pnlty_ltext] [varchar](250) NULL,
	[remarks] [varchar](250) NULL,
	[company] [char](2) NULL,
	[modified] [bit] NULL,
	[lastupdt] [char](8) NULL,
 CONSTRAINT [PK_pp_violations_penalties] PRIMARY KEY CLUSTERED 
(
	[vcode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppaphdr]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppaphdr](
	[maintype] [char](1) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[trdate] [char](8) NOT NULL,
	[calctype] [char](1) NOT NULL,
	[valprtg] [numeric](11, 2) NOT NULL,
	[company] [char](2) NOT NULL,
	[remarks] [char](70) NOT NULL,
	[entries] [numeric](5, 0) NOT NULL,
	[sysdate] [char](8) NOT NULL,
	[usrid] [char](10) NOT NULL,
	[modified] [bit] NOT NULL,
	[rcvdtrn] [bit] NOT NULL,
 CONSTRAINT [UQ_ppaphdr] UNIQUE NONCLUSTERED 
(
	[company] ASC,
	[maintype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppapsal]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppapsal](
	[empno] [char](6) NOT NULL,
	[trdate] [char](8) NOT NULL,
	[tramt] [numeric](14, 2) NOT NULL,
	[sal] [numeric](14, 2) NOT NULL,
	[punsh] [numeric](14, 2) NOT NULL,
	[award] [numeric](14, 2) NOT NULL,
	[cutsal] [numeric](14, 2) NOT NULL,
	[addsal] [numeric](14, 2) NOT NULL,
	[salyear] [char](4) NOT NULL,
	[sysdate] [char](8) NOT NULL,
	[monthsal] [char](2) NOT NULL,
	[newold] [char](1) NOT NULL,
	[ok_tax] [bit] NOT NULL,
	[ok_social] [bit] NOT NULL,
	[maintype] [char](1) NOT NULL,
	[saldate] [char](8) NOT NULL,
	[valprtg] [numeric](11, 2) NOT NULL,
	[calctype] [char](1) NOT NULL,
	[company] [char](2) NOT NULL,
	[modified] [bit] NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[no_of_hours] [numeric](10, 2) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pparea]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pparea](
	[name] [char](20) NOT NULL,
	[cmbkey] [char](6) NOT NULL,
	[govrn] [char](2) NOT NULL,
	[city] [char](2) NOT NULL,
	[region] [char](2) NOT NULL,
	[modified] [bit] NOT NULL,
	[lname] [char](20) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[pkey] [int] NOT NULL,
	[chkey] [int] NOT NULL,
 CONSTRAINT [PK_pparea] PRIMARY KEY CLUSTERED 
(
	[cmbkey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppbank]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppbank](
	[b_code] [char](4) NOT NULL,
	[b_name] [varchar](70) NOT NULL,
	[b_lname] [varchar](70) NOT NULL,
	[b_short] [char](10) NOT NULL,
	[b_xfrcomm] [numeric](14, 2) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppcdbt]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppcdbt](
	[code] [char](2) NOT NULL,
	[namea] [char](30) NOT NULL,
	[namee] [char](30) NOT NULL,
	[remarks] [char](60) NOT NULL,
	[subtype] [char](1) NOT NULL,
	[company] [char](2) NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppcgrp]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppcgrp](
	[code] [char](2) NOT NULL,
	[namea] [char](30) NOT NULL,
	[remarks] [char](80) NOT NULL,
	[company] [char](2) NOT NULL,
	[namee] [char](30) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppchld]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppchld](
	[code] [char](2) NOT NULL,
	[namea] [char](30) NOT NULL,
	[namee] [char](30) NOT NULL,
	[from_date] [char](8) NOT NULL,
	[todate] [char](8) NOT NULL,
	[remarks] [char](60) NOT NULL,
	[company] [char](2) NOT NULL,
	[type] [char](1) NOT NULL,
	[only_group] [char](2) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppcinstd]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppcinstd](
	[code] [char](2) NOT NULL,
	[namea] [char](30) NOT NULL,
	[namee] [char](30) NOT NULL,
	[acc_key] [char](19) NOT NULL,
	[getins] [bit] NOT NULL,
	[remarks] [char](30) NOT NULL,
	[ok_social] [bit] NOT NULL,
	[ok_tax] [bit] NOT NULL,
	[company] [char](2) NOT NULL,
	[ok_ddct] [bit] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppcintr]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppcintr](
	[code] [char](2) NOT NULL,
	[namea] [char](30) NOT NULL,
	[namee] [char](30) NOT NULL,
	[remarks] [char](60) NOT NULL,
	[company] [char](2) NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppcjob]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppcjob](
	[code] [char](2) NOT NULL,
	[namea] [char](30) NOT NULL,
	[mon_sal] [numeric](9, 2) NOT NULL,
	[namee] [char](30) NOT NULL,
	[remarks] [char](80) NOT NULL,
	[job_add_val] [numeric](10, 0) NOT NULL,
	[description] [char](30) NOT NULL,
	[company] [char](2) NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppclng]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppclng](
	[code] [char](2) NOT NULL,
	[namea] [char](50) NOT NULL,
	[namee] [char](50) NOT NULL,
	[remarks] [char](80) NOT NULL,
	[company] [char](2) NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppcnt]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppcnt](
	[ccode] [char](3) NOT NULL,
	[namea] [char](50) NOT NULL,
	[namee] [char](50) NOT NULL,
	[remark] [char](80) NOT NULL,
	[company] [char](2) NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppcprtcd]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppcprtcd](
	[code] [char](2) NOT NULL,
	[namea] [char](50) NOT NULL,
	[namee] [char](50) NOT NULL,
	[enterexsit] [numeric](1, 0) NOT NULL,
	[late] [numeric](1, 0) NOT NULL,
	[punch] [numeric](1, 0) NOT NULL,
	[excetra] [numeric](1, 0) NOT NULL,
	[overtime] [numeric](1, 0) NOT NULL,
	[hourwork] [numeric](1, 0) NOT NULL,
	[prtlatevalue] [numeric](6, 2) NOT NULL,
	[prtaddvalue] [numeric](6, 2) NOT NULL,
	[remarks] [char](10) NOT NULL,
	[company] [char](2) NOT NULL,
	[modified] [bit] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppcrgt]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppcrgt](
	[code] [char](2) NOT NULL,
	[namea] [char](30) NOT NULL,
	[namee] [char](30) NOT NULL,
	[state_time] [numeric](4, 0) NOT NULL,
	[end_time] [numeric](4, 0) NOT NULL,
	[remarks] [char](40) NOT NULL,
	[isampm] [char](1) NOT NULL,
	[l_limit] [numeric](4, 0) NOT NULL,
	[h_limit] [numeric](4, 0) NOT NULL,
	[company] [char](2) NOT NULL,
	[freelate] [numeric](3, 0) NOT NULL,
	[modified] [bit] NOT NULL,
	[maxlatein] [numeric](4, 0) NOT NULL,
	[maxearlyout] [numeric](4, 0) NOT NULL,
	[f_late_lmt] [numeric](3, 0) NULL,
	[d1_sprt_timing] [bit] NULL,
	[d1_state_time] [numeric](4, 0) NULL,
	[d1_end_time] [numeric](4, 0) NULL,
	[d1_l_limit] [numeric](4, 0) NULL,
	[d1_maxlatein] [numeric](4, 0) NULL,
	[d1_maxearlyout] [numeric](4, 0) NULL,
	[d1_h_limit] [numeric](4, 0) NULL,
	[d1_freelate] [numeric](3, 0) NULL,
	[d1_f_late_lmt] [numeric](3, 0) NULL,
	[d2_sprt_timing] [bit] NULL,
	[d2_state_time] [numeric](4, 0) NULL,
	[d2_end_time] [numeric](4, 0) NULL,
	[d2_l_limit] [numeric](4, 0) NULL,
	[d2_maxlatein] [numeric](4, 0) NULL,
	[d2_maxearlyout] [numeric](4, 0) NULL,
	[d2_h_limit] [numeric](4, 0) NULL,
	[d2_freelate] [numeric](3, 0) NULL,
	[d2_f_late_lmt] [numeric](3, 0) NULL,
	[d3_sprt_timing] [bit] NULL,
	[d3_state_time] [numeric](4, 0) NULL,
	[d3_end_time] [numeric](4, 0) NULL,
	[d3_l_limit] [numeric](4, 0) NULL,
	[d3_maxlatein] [numeric](4, 0) NULL,
	[d3_maxearlyout] [numeric](4, 0) NULL,
	[d3_h_limit] [numeric](4, 0) NULL,
	[d3_freelate] [numeric](3, 0) NULL,
	[d3_f_late_lmt] [numeric](3, 0) NULL,
	[d4_sprt_timing] [bit] NULL,
	[d4_state_time] [numeric](4, 0) NULL,
	[d4_end_time] [numeric](4, 0) NULL,
	[d4_l_limit] [numeric](4, 0) NULL,
	[d4_maxlatein] [numeric](4, 0) NULL,
	[d4_maxearlyout] [numeric](4, 0) NULL,
	[d4_h_limit] [numeric](4, 0) NULL,
	[d4_freelate] [numeric](3, 0) NULL,
	[d4_f_late_lmt] [numeric](3, 0) NULL,
	[d5_sprt_timing] [bit] NULL,
	[d5_state_time] [numeric](4, 0) NULL,
	[d5_end_time] [numeric](4, 0) NULL,
	[d5_l_limit] [numeric](4, 0) NULL,
	[d5_maxlatein] [numeric](4, 0) NULL,
	[d5_maxearlyout] [numeric](4, 0) NULL,
	[d5_h_limit] [numeric](4, 0) NULL,
	[d5_freelate] [numeric](3, 0) NULL,
	[d5_f_late_lmt] [numeric](3, 0) NULL,
	[d6_sprt_timing] [bit] NULL,
	[d6_state_time] [numeric](4, 0) NULL,
	[d6_end_time] [numeric](4, 0) NULL,
	[d6_l_limit] [numeric](4, 0) NULL,
	[d6_maxlatein] [numeric](4, 0) NULL,
	[d6_maxearlyout] [numeric](4, 0) NULL,
	[d6_h_limit] [numeric](4, 0) NULL,
	[d6_freelate] [numeric](3, 0) NULL,
	[d6_f_late_lmt] [numeric](3, 0) NULL,
	[d7_sprt_timing] [bit] NULL,
	[d7_state_time] [numeric](4, 0) NULL,
	[d7_end_time] [numeric](4, 0) NULL,
	[d7_l_limit] [numeric](4, 0) NULL,
	[d7_maxlatein] [numeric](4, 0) NULL,
	[d7_maxearlyout] [numeric](4, 0) NULL,
	[d7_h_limit] [numeric](4, 0) NULL,
	[d7_freelate] [numeric](3, 0) NULL,
	[d7_f_late_lmt] [numeric](3, 0) NULL,
 CONSTRAINT [PK_ppcrgt] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY],
 CONSTRAINT [UQ_ppcrgt] UNIQUE NONCLUSTERED 
(
	[code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppcsal]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppcsal](
	[code] [char](2) NOT NULL,
	[namea] [char](30) NOT NULL,
	[namee] [char](30) NOT NULL,
	[remarks] [char](30) NOT NULL,
	[ok_social] [bit] NOT NULL,
	[ok_tax] [bit] NOT NULL,
	[company] [char](2) NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppcsci]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppcsci](
	[code] [char](2) NOT NULL,
	[namea] [char](30) NOT NULL,
	[namee] [char](30) NOT NULL,
	[remarks] [char](80) NOT NULL,
	[company] [char](2) NOT NULL,
 CONSTRAINT [UQ_ppcsci] UNIQUE NONCLUSTERED 
(
	[code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppctax]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppctax](
	[code] [char](2) NOT NULL,
	[taxname] [char](30) NOT NULL,
	[fromvalue] [numeric](9, 2) NOT NULL,
	[tovalue] [numeric](9, 2) NOT NULL,
	[precent] [numeric](9, 2) NOT NULL,
	[stfrtype] [bit] NOT NULL,
	[company] [char](2) NOT NULL,
	[taxlname] [char](30) NULL,
 CONSTRAINT [UQ_ppctax] UNIQUE NONCLUSTERED 
(
	[code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppcty]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppcty](
	[code] [char](6) NOT NULL,
	[namea] [char](50) NOT NULL,
	[namee] [char](50) NOT NULL,
	[remark] [char](80) NOT NULL,
	[ccode] [char](3) NOT NULL,
	[company] [char](2) NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppdcrs]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppdcrs](
	[empno] [char](6) NOT NULL,
	[scode] [char](2) NOT NULL,
	[namea] [char](30) NOT NULL,
	[namee] [char](30) NOT NULL,
	[period] [numeric](5, 0) NOT NULL,
	[cdate] [char](8) NOT NULL,
	[place] [char](50) NOT NULL,
	[remarks] [char](80) NOT NULL,
	[validation] [char](30) NOT NULL,
	[ispaid] [char](10) NOT NULL,
	[orginazation] [char](30) NOT NULL,
	[company] [char](2) NOT NULL,
	[stoppped] [bit] NOT NULL,
	[modified] [bit] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppddbt]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppddbt](
	[hd_ref] [numeric](6, 0) NOT NULL,
	[hd_company] [char](2) NOT NULL,
	[empno] [char](6) NOT NULL,
	[dbtcode] [char](2) NOT NULL,
	[hd_ltotal] [numeric](9, 2) NOT NULL,
	[hd_ftotal] [numeric](9, 2) NOT NULL,
	[hd_fcy] [char](3) NOT NULL,
	[hd_fcyrate] [numeric](7, 2) NOT NULL,
	[hd_date] [char](8) NOT NULL,
	[hd_desc1] [char](60) NOT NULL,
	[hd_type] [char](2) NOT NULL,
	[posted] [bit] NOT NULL,
	[released] [bit] NOT NULL,
	[hd_trxsrc] [char](2) NOT NULL,
	[hd_lcnet] [numeric](14, 2) NOT NULL,
	[hd_lccnet] [numeric](14, 2) NOT NULL,
	[hd_fcnet] [numeric](14, 2) NOT NULL,
	[hd_fccnet] [numeric](14, 2) NOT NULL,
	[cvalue] [numeric](9, 2) NOT NULL,
	[transtype] [char](1) NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppdept]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppdept](
	[dp_name] [char](30) NOT NULL,
	[dp_dept] [char](2) NOT NULL,
	[dp_brno] [char](2) NOT NULL,
	[dp_comp] [char](2) NOT NULL,
	[modified] [bit] NOT NULL,
	[entertype] [char](2) NULL,
	[exittype] [char](2) NULL,
	[timing_1] [char](2) NULL,
	[timing_2] [char](2) NULL,
	[timing_3] [char](2) NULL,
	[dp_lname] [char](30) NULL,
	[dp_slrydue_ac] [char](19) NULL,
	[dp_slryxpns_ac] [char](19) NULL,
	[dp_allowncxpns_ac] [char](19) NULL,
	[dp_ovtmxpns_ac] [char](19) NULL,
	[dp_rwrdsxpns_ac] [char](19) NULL,
	[dp_socinsurxpns_ac] [char](19) NULL,
	[dp_absence_ac] [char](19) NULL,
	[dp_late_ac] [char](19) NULL,
	[dp_pnshmnt_ac] [char](19) NULL,
	[dp_socinsurance_ac] [char](19) NULL,
 CONSTRAINT [PK_ppdept] PRIMARY KEY CLUSTERED 
(
	[dp_comp] ASC,
	[dp_brno] ASC,
	[dp_dept] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppdhld]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppdhld](
	[empno] [char](6) NOT NULL,
	[code] [char](2) NOT NULL,
	[cancel] [char](1) NOT NULL,
	[from_date] [char](8) NOT NULL,
	[to_date] [char](8) NOT NULL,
	[remarks] [char](30) NOT NULL,
	[rtrn_date] [char](8) NOT NULL,
	[statusCode] [char](1) NOT NULL,
	[ttlposted] [float] NULL,
	[saldate] [char](8) NOT NULL,
	[daystopost] [float] NULL,
	[company] [char](2) NOT NULL,
	[stopped] [bit] NOT NULL,
	[modified] [bit] NOT NULL,
	[paid_salary_ptg] [numeric](1, 0) NULL,
	[public_hdays] [numeric](4, 0) NULL,
	[fst_day_hlfdy_lv] [bit] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppdinstd]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppdinstd](
	[empno] [char](6) NOT NULL,
	[code] [char](2) NOT NULL,
	[insdate] [char](8) NOT NULL,
	[value] [numeric](9, 2) NOT NULL,
	[insstdate] [char](8) NOT NULL,
	[insflag] [bit] NOT NULL,
	[remarks] [char](50) NOT NULL,
	[company] [char](2) NOT NULL,
	[stopped] [bit] NOT NULL,
	[modified] [bit] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppdintd]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppdintd](
	[empcode] [char](6) NOT NULL,
	[iname] [char](30) NOT NULL,
	[relative] [char](20) NOT NULL,
	[his_job] [char](20) NOT NULL,
	[place] [char](20) NOT NULL,
	[phone] [char](20) NOT NULL,
	[remarks] [char](60) NOT NULL,
	[company] [char](2) NOT NULL,
	[stopped] [bit] NOT NULL,
	[modified] [bit] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppdlng]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppdlng](
	[empno] [char](6) NOT NULL,
	[lngcode] [char](2) NOT NULL,
	[reading] [char](20) NOT NULL,
	[writing] [char](20) NOT NULL,
	[speaking] [char](20) NOT NULL,
	[remarks] [char](80) NOT NULL,
	[company] [char](2) NOT NULL,
	[stopped] [bit] NOT NULL,
	[modified] [bit] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppdloan]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppdloan](
	[empcode] [char](6) NOT NULL,
	[ltype] [char](2) NOT NULL,
	[ldate] [char](8) NOT NULL,
	[lamount] [numeric](9, 2) NOT NULL,
	[linstamt] [numeric](9, 2) NOT NULL,
	[start_ddct] [char](8) NOT NULL,
	[lbalamt] [numeric](9, 2) NOT NULL,
	[deptcode] [char](2) NOT NULL,
	[lstatus] [char](1) NOT NULL,
	[saldate] [char](8) NOT NULL,
	[amnt] [numeric](9, 2) NOT NULL,
	[fstsaldeduct] [char](8) NOT NULL,
	[company] [char](2) NOT NULL,
	[stoped] [bit] NOT NULL,
	[modified] [bit] NOT NULL,
	[remarks] [varchar](70) NOT NULL,
	[rq_id] [int] NULL,
 CONSTRAINT [UQ_ppdloan] UNIQUE NONCLUSTERED 
(
	[empcode] ASC,
	[ltype] ASC,
	[ldate] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppdpos]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppdpos](
	[jobno] [char](2) NOT NULL,
	[empno] [char](6) NOT NULL,
	[devcode] [char](2) NOT NULL,
	[start_date] [char](8) NOT NULL,
	[end_date] [char](8) NOT NULL,
	[remarks] [char](50) NOT NULL,
	[company] [char](2) NOT NULL,
	[stopped] [bit] NOT NULL,
	[modified] [bit] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppdprt]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppdprt](
	[empno] [char](6) NOT NULL,
	[code] [char](2) NOT NULL,
	[start_date] [char](8) NOT NULL,
	[end_date] [char](8) NOT NULL,
	[remarks] [char](50) NOT NULL,
	[company] [char](2) NOT NULL,
	[stopped] [bit] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppdpuaw]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppdpuaw](
	[empno] [char](2) NOT NULL,
	[punch] [numeric](9, 2) NOT NULL,
	[award] [numeric](9, 2) NOT NULL,
	[fromdate] [char](8) NOT NULL,
	[todate] [char](8) NOT NULL,
	[desc_] [char](50) NOT NULL,
	[puawdate] [char](8) NOT NULL,
	[company] [char](2) NOT NULL,
	[stopped] [bit] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppdrel]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppdrel](
	[empcode] [char](6) NOT NULL,
	[rname] [char](30) NOT NULL,
	[relative] [char](20) NOT NULL,
	[profission] [char](20) NOT NULL,
	[work_place] [char](20) NOT NULL,
	[pahone] [char](20) NOT NULL,
	[remarks] [char](50) NOT NULL,
	[company] [char](2) NOT NULL,
	[stopped] [bit] NOT NULL,
	[modified] [bit] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppdsal]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppdsal](
	[empno] [char](6) NOT NULL,
	[code] [char](2) NOT NULL,
	[actual_sal] [numeric](10, 0) NOT NULL,
	[start_date] [char](8) NOT NULL,
	[end_date] [char](8) NOT NULL,
	[insurance_sal] [numeric](10, 0) NOT NULL,
	[start_in_sal] [char](8) NOT NULL,
	[end_in_sal] [char](8) NOT NULL,
	[remarks] [char](30) NOT NULL,
	[company] [char](2) NOT NULL,
	[stopped] [bit] NOT NULL,
	[modified] [bit] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppdsci]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppdsci](
	[empcode] [char](6) NOT NULL,
	[scicode] [char](2) NOT NULL,
	[sdate] [char](8) NOT NULL,
	[remarks] [varchar](80) NOT NULL,
	[company] [char](2) NOT NULL,
	[stopped] [bit] NOT NULL,
	[modified] [bit] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppdson]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppdson](
	[empcode] [char](6) NOT NULL,
	[sonname] [char](30) NOT NULL,
	[gender] [char](1) NOT NULL,
	[isstuding] [bit] NOT NULL,
	[ismarrid] [bit] NOT NULL,
	[brith_date] [char](8) NOT NULL,
	[social_sate] [char](1) NOT NULL,
	[isworking] [bit] NOT NULL,
	[remarks] [char](60) NOT NULL,
	[company] [char](2) NOT NULL,
	[stopped] [bit] NOT NULL,
	[modified] [bit] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppdtl]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppdtl](
	[pdcomp] [char](2) NOT NULL,
	[pdkey] [char](19) NOT NULL,
	[pddate] [char](8) NOT NULL,
	[pdref] [numeric](6, 0) NOT NULL,
	[pdtype] [char](2) NOT NULL,
	[pdtext] [char](50) NOT NULL,
	[pdlcamt] [float] NOT NULL,
	[pddbcr] [char](1) NOT NULL,
	[pdfcamt] [float] NOT NULL,
	[pdcurr] [char](3) NOT NULL,
	[pdfolio] [numeric](6, 0) NOT NULL,
	[pdsysdate] [char](8) NOT NULL,
	[pdsrc] [char](2) NOT NULL,
	[pdfc_imgval] [float] NOT NULL,
	[brnno] [char](2) NOT NULL,
	[empno] [char](6) NOT NULL,
	[pdpptype] [numeric](1, 0) NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppdwprv]    Script Date: 2025-11-13 12:21:51 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppdwprv](
	[empcode] [char](6) NOT NULL,
	[work_desc] [char](50) NOT NULL,
	[place] [char](30) NOT NULL,
	[sal] [numeric](10, 0) NOT NULL,
	[from_date] [char](8) NOT NULL,
	[todate] [char](8) NOT NULL,
	[leave_reason] [char](30) NOT NULL,
	[remarks] [char](50) NOT NULL,
	[company] [char](2) NOT NULL,
	[stopped] [bit] NOT NULL,
	[modified] [bit] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppecdbt]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppecdbt](
	[code] [char](2) NOT NULL,
	[namea] [char](50) NOT NULL,
	[namee] [char](50) NOT NULL,
	[remark] [char](80) NOT NULL,
	[company] [char](2) NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppemp]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppemp](
	[company] [char](2) NOT NULL,
	[deptcode] [char](2) NOT NULL,
	[empno] [char](6) NOT NULL,
	[adds_id] [char](2) NOT NULL,
	[cnt_id] [char](2) NOT NULL,
	[cty_id] [char](6) NOT NULL,
	[nat_id] [char](2) NOT NULL,
	[first_name] [char](30) NOT NULL,
	[last_name] [char](30) NOT NULL,
	[gender] [char](1) NOT NULL,
	[social_state] [char](1) NOT NULL,
	[issmoke] [char](1) NOT NULL,
	[can_work_night] [numeric](2, 0) NOT NULL,
	[pos_whours] [numeric](4, 2) NOT NULL,
	[insurance_no] [char](15) NOT NULL,
	[no_h_can_w] [numeric](2, 0) NOT NULL,
	[street] [char](20) NOT NULL,
	[city] [char](20) NOT NULL,
	[h_phone] [char](20) NOT NULL,
	[id_card] [char](20) NOT NULL,
	[brith_palce] [char](20) NOT NULL,
	[birth_date] [char](8) NOT NULL,
	[nationalty] [char](2) NOT NULL,
	[military_stat] [char](1) NOT NULL,
	[wives_no] [numeric](1, 0) NOT NULL,
	[remarks] [char](30) NOT NULL,
	[order_date] [char](8) NOT NULL,
	[passport_no] [char](20) NOT NULL,
	[pass_issue_date] [char](8) NOT NULL,
	[pass_exp_date] [char](8) NOT NULL,
	[pass_orgin] [char](20) NOT NULL,
	[join_date] [char](8) NOT NULL,
	[isregister] [char](1) NOT NULL,
	[insur_ldate] [char](8) NOT NULL,
	[insur_fdate] [char](8) NOT NULL,
	[residence_fdate] [char](8) NOT NULL,
	[residance_no] [char](20) NOT NULL,
	[residance_ldate] [char](8) NOT NULL,
	[residance_orgin] [char](20) NOT NULL,
	[max_loan] [numeric](11, 2) NOT NULL,
	[lastsaldate] [char](8) NOT NULL,
	[amtdept] [numeric](14, 2) NOT NULL,
	[instamt] [numeric](14, 2) NOT NULL,
	[foreignx] [bit] NOT NULL,
	[picture] [varchar](90) NOT NULL,
	[addrs] [char](60) NOT NULL,
	[empstatus] [char](1) NOT NULL,
	[religion] [char](1) NOT NULL,
	[leavdays] [numeric](6, 2) NOT NULL,
	[leavbal] [float] NOT NULL,
	[leavopen] [float] NOT NULL,
	[blood_type] [char](2) NOT NULL,
	[work_lic] [char](20) NOT NULL,
	[work_licstart] [char](8) NOT NULL,
	[work_licend] [char](8) NOT NULL,
	[worl_licorgn] [char](20) NOT NULL,
	[heth_insuno] [char](20) NOT NULL,
	[modified] [bit] NOT NULL,
	[acc_no] [char](19) NOT NULL,
	[openbal] [numeric](14, 2) NOT NULL,
	[curbal] [numeric](14, 2) NOT NULL,
	[xfr_date] [char](8) NOT NULL,
	[xfr_company] [char](2) NOT NULL,
	[xfr_bal] [numeric](14, 2) NOT NULL,
	[entertype] [char](2) NOT NULL,
	[exittype] [char](2) NOT NULL,
	[sat] [char](1) NOT NULL,
	[sun] [char](1) NOT NULL,
	[mon] [char](1) NOT NULL,
	[tue] [char](1) NOT NULL,
	[wed] [char](1) NOT NULL,
	[thu] [char](1) NOT NULL,
	[fri] [char](1) NOT NULL,
	[timing_1] [char](2) NOT NULL,
	[timing_2] [char](2) NOT NULL,
	[heth_fmdt] [char](8) NULL,
	[heth_todt] [char](8) NULL,
	[our_iqamah] [bit] NOT NULL,
	[sponsor] [char](30) NULL,
	[ctcttype] [char](1) NULL,
	[mobile] [char](15) NULL,
	[bank_code] [char](4) NULL,
	[bank_acc] [char](35) NULL,
	[id_from] [char](20) NULL,
	[id_date] [char](8) NULL,
	[nopunch] [bit] NOT NULL,
	[istraining] [bit] NOT NULL,
	[rtfmlv_dt] [char](8) NULL,
	[image1] [varchar](90) NULL,
	[image2] [varchar](90) NULL,
	[image3] [varchar](90) NULL,
	[image4] [varchar](90) NULL,
	[image5] [varchar](90) NULL,
	[image6] [varchar](90) NULL,
	[my_bk_name] [varchar](50) NULL,
	[hist_file] [varchar](90) NULL,
	[iq_xfr_dt] [char](8) NULL,
	[saned_amt] [numeric](14, 2) NULL,
	[sis_comp] [char](4) NULL,
	[punch1_nolate] [bit] NULL,
	[timing_3] [char](2) NULL,
	[no_abs_multiple] [bit] NULL,
	[leavopen_stlmnt_date] [char](8) NULL,
	[tickets_amount] [float] NULL,
	[tickets_months] [numeric](6, 2) NULL,
	[sal_upto] [char](8) NULL,
 CONSTRAINT [UQ_ppemp] UNIQUE NONCLUSTERED 
(
	[empno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pphdr]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pphdr](
	[phtype] [char](2) NOT NULL,
	[phref] [numeric](6, 0) NOT NULL,
	[phdate] [char](8) NOT NULL,
	[phtext] [char](50) NOT NULL,
	[phamt] [float] NOT NULL,
	[phentries] [numeric](6, 0) NOT NULL,
	[phsrc] [char](2) NOT NULL,
	[phsysdate] [char](8) NOT NULL,
	[phcurr] [char](3) NOT NULL,
	[phfcflag] [numeric](1, 0) NOT NULL,
	[phrate] [numeric](9, 4) NOT NULL,
	[phcomp] [char](2) NOT NULL,
	[phpptype] [numeric](1, 0) NOT NULL,
	[phser] [char](19) NOT NULL,
	[phreleased] [bit] NOT NULL,
	[phposted] [bit] NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[phlcttl] [float] NOT NULL,
	[phfcttl] [float] NOT NULL,
	[phimgrate] [float] NOT NULL,
	[phlc2ttl] [float] NOT NULL,
	[modified] [bit] NOT NULL,
	[serial_no] [numeric](5, 0) NOT NULL,
	[rcvdtrn] [bit] NOT NULL,
	[usrid] [char](10) NOT NULL,
	[phcmp_socamt] [float] NULL,
	[phttlnet_salry] [float] NULL,
 CONSTRAINT [PK_pphdr] PRIMARY KEY NONCLUSTERED 
(
	[phtype] ASC,
	[phref] ASC,
	[phcomp] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY],
 CONSTRAINT [UQ_pphdr] UNIQUE CLUSTERED 
(
	[phcomp] ASC,
	[phtype] ASC,
	[phref] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppinout]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppinout](
	[dept_no] [char](2) NOT NULL,
	[empcode] [char](6) NOT NULL,
	[worktype] [char](2) NOT NULL,
	[work_date] [char](8) NOT NULL,
	[entertime] [numeric](4, 0) NOT NULL,
	[exittime] [numeric](4, 0) NOT NULL,
	[entertype] [char](2) NOT NULL,
	[exittype] [char](2) NOT NULL,
	[posted] [bit] NOT NULL,
	[saldate] [char](8) NOT NULL,
	[isampm] [char](1) NOT NULL,
	[remarks] [char](30) NOT NULL,
	[company] [char](2) NOT NULL,
	[manual] [bit] NOT NULL,
	[prfctentry] [numeric](4, 0) NOT NULL,
	[prfctexit] [numeric](4, 0) NOT NULL,
	[z_ismidnight] [bit] NOT NULL,
	[indattime] [smalldatetime] NULL,
	[outdattime] [smalldatetime] NULL,
	[org_indattime] [smalldatetime] NULL,
	[org_outdattime] [smalldatetime] NULL,
	[chg_user] [char](10) NULL,
	[chg_time] [smalldatetime] NULL,
	[pos_whours] [numeric](4, 2) NULL,
	[hour_salary] [float] NULL,
	[emp_day_work] [char](1) NULL,
	[period_no] [char](1) NULL,
	[no_absmultiple] [bit] NULL,
	[grp] [char](2) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppinoutm]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppinoutm](
	[dp_dept] [char](2) NOT NULL,
	[worktype] [char](2) NOT NULL,
	[workdate] [char](8) NULL,
	[entertype] [char](2) NOT NULL,
	[exittype] [char](2) NOT NULL,
	[company] [char](2) NOT NULL,
	[modified] [bit] NOT NULL,
	[ok_infrom] [smalldatetime] NULL,
	[ok_into] [smalldatetime] NULL,
	[ok_outfrom] [smalldatetime] NULL,
	[ok_outto] [smalldatetime] NULL,
	[in_ideal] [smalldatetime] NULL,
	[out_ideal] [smalldatetime] NULL,
	[freelate] [numeric](3, 0) NULL,
	[f_late_lmt] [numeric](3, 0) NULL,
	[rcvdtrn] [bit] NOT NULL,
	[f_day_cut] [bit] NULL,
	[f_Hday_cut] [bit] NULL,
	[punch1_halflate] [bit] NULL,
	[f_day_free] [numeric](5, 2) NULL,
	[mnth_days] [int] NULL,
	[f_allovrtime] [bit] NULL,
	[ok_off_day_attendance] [bit] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppjrdtl]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppjrdtl](
	[jdcomp] [char](2) NOT NULL,
	[jdtype] [char](2) NOT NULL,
	[jdref] [numeric](6, 0) NOT NULL,
	[jdkey] [char](19) NOT NULL,
	[jddate] [char](8) NOT NULL,
	[jdtext] [varchar](70) NOT NULL,
	[jdlcamt] [float] NOT NULL,
	[jddbcr] [char](1) NOT NULL,
	[jdfcamt] [float] NOT NULL,
	[jdcurr] [char](3) NOT NULL,
	[jdfolio] [numeric](6, 0) NOT NULL,
	[jdsysdate] [char](8) NOT NULL,
	[jdsrc] [char](2) NOT NULL,
	[brnno] [char](2) NOT NULL,
	[empno] [char](6) NOT NULL,
	[pdpptype] [numeric](1, 0) NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppMonitor]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppMonitor](
	[id] [bigint] IDENTITY(1,1) NOT NULL,
	[ip] [varchar](15) NULL,
	[dscption] [varchar](20) NULL,
	[lastPunch] [smalldatetime] NULL,
 CONSTRAINT [PK_ppMonitor] PRIMARY KEY CLUSTERED 
(
	[id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppsal]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppsal](
	[empno] [char](6) NOT NULL,
	[deptcode] [char](2) NOT NULL,
	[salary] [numeric](14, 2) NOT NULL,
	[sal_social] [numeric](11, 2) NOT NULL,
	[sal_tax] [numeric](11, 2) NOT NULL,
	[ok_social] [bit] NOT NULL,
	[cmp_socamt] [numeric](11, 2) NOT NULL,
	[emp_socamt] [numeric](11, 2) NOT NULL,
	[tax_amt] [numeric](9, 2) NOT NULL,
	[badlat] [numeric](14, 2) NOT NULL,
	[badl_social] [numeric](11, 2) NOT NULL,
	[badl_tax] [numeric](11, 2) NOT NULL,
	[punsh] [numeric](14, 2) NOT NULL,
	[punsh_social] [numeric](11, 2) NOT NULL,
	[punsh_tax] [numeric](11, 2) NOT NULL,
	[award] [numeric](14, 2) NOT NULL,
	[award_social] [numeric](11, 2) NOT NULL,
	[award_tax] [numeric](11, 2) NOT NULL,
	[cutsal] [numeric](14, 2) NOT NULL,
	[cut_social] [numeric](11, 2) NOT NULL,
	[cut_tax] [numeric](11, 2) NOT NULL,
	[addsal] [numeric](14, 2) NOT NULL,
	[add_social] [numeric](11, 2) NOT NULL,
	[add_tax] [numeric](11, 2) NOT NULL,
	[loan] [numeric](14, 2) NOT NULL,
	[loan_half] [numeric](11, 2) NOT NULL,
	[loan_tmp] [numeric](11, 2) NOT NULL,
	[late_in] [numeric](6, 0) NOT NULL,
	[early_out] [numeric](6, 0) NOT NULL,
	[late_out] [numeric](6, 0) NOT NULL,
	[early_in] [numeric](6, 0) NOT NULL,
	[absdays] [float] NULL,
	[emp_ratio] [float] NOT NULL,
	[salyear] [char](4) NOT NULL,
	[salmonth] [char](2) NOT NULL,
	[salday] [char](2) NOT NULL,
	[sysdate] [char](8) NOT NULL,
	[newold] [char](1) NOT NULL,
	[stmttype] [char](1) NOT NULL,
	[on_leave] [bit] NOT NULL,
	[foreignx] [bit] NOT NULL,
	[join_age] [numeric](9, 4) NOT NULL,
	[lastsaldate] [char](8) NOT NULL,
	[join_date] [char](8) NOT NULL,
	[insur_fdate] [char](8) NOT NULL,
	[insur_ldate] [char](8) NOT NULL,
	[mleavdays] [float] NOT NULL,
	[whours] [numeric](5, 2) NOT NULL,
	[dsalary] [float] NOT NULL,
	[mnormleav] [numeric](7, 2) NOT NULL,
	[last_name] [char](30) NOT NULL,
	[first_name] [char](30) NOT NULL,
	[final_date] [char](8) NOT NULL,
	[company] [char](2) NOT NULL,
	[sal_upto] [char](8) NOT NULL,
	[saldate] [char](8) NOT NULL,
	[bdl_1] [numeric](14, 2) NOT NULL,
	[bdl_2] [numeric](14, 2) NOT NULL,
	[bdl_3] [numeric](14, 2) NOT NULL,
	[bdl_4] [numeric](14, 2) NOT NULL,
	[bdl_5] [numeric](14, 2) NOT NULL,
	[bdl_otrs] [numeric](14, 2) NOT NULL,
	[saned_amt] [numeric](14, 2) NULL,
	[late_amt] [float] NULL,
	[over_amt] [float] NULL,
	[days_abs_join] [numeric](2, 0) NULL,
	[late_abs] [numeric](14, 2) NULL,
	[saldate2] [char](8) NULL,
	[leav_abs_days] [float] NULL,
	[normleav_2] [float] NULL,
	[added_hrs_06] [numeric](10, 2) NULL,
	[added_amt_06] [numeric](14, 2) NULL,
	[added_amt_06_tax] [numeric](11, 2) NULL,
	[added_amt_06_social] [numeric](11, 2) NULL,
	[ddctd_hrs_06] [numeric](10, 2) NULL,
	[ddctd_amt_06] [numeric](14, 2) NULL,
	[ddctd_amt_06_tax] [numeric](11, 2) NULL,
	[ddctd_amt_06_social] [numeric](11, 2) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppsalrcvr]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppsalrcvr](
	[empno] [char](6) NOT NULL,
	[company] [char](2) NOT NULL,
	[saldate] [char](8) NOT NULL,
	[sysdate] [char](8) NOT NULL,
	[file_name] [char](20) NOT NULL,
	[fkey] [char](16) NOT NULL,
	[fld_name1] [char](20) NOT NULL,
	[fld_val1] [char](20) NOT NULL,
	[fld_name2] [char](20) NOT NULL,
	[fld_val2] [char](20) NOT NULL,
	[fld_name3] [char](20) NOT NULL,
	[fld_val3] [char](20) NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppscompany]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppscompany](
	[code] [char](4) NOT NULL,
	[name] [varchar](80) NOT NULL,
	[remarks] [varchar](80) NOT NULL,
	[ppscommpany] [char](10) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppsetup]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppsetup](
	[mscomp] [char](2) NOT NULL,
	[passport_days] [int] NOT NULL,
	[iqamah_days] [int] NOT NULL,
	[wrkpermit_days] [int] NOT NULL,
	[smsmobile] [char](20) NOT NULL,
	[ok_acct] [bit] NOT NULL,
	[hinsur_days] [int] NULL,
	[ok_social] [bit] NOT NULL,
	[comp_ptg] [numeric](5, 2) NULL,
	[natemp_ptg] [numeric](5, 2) NULL,
	[foremp_ptg] [numeric](5, 2) NULL,
	[ok_tax] [bit] NOT NULL,
	[f_day_cut] [bit] NOT NULL,
	[f_day_free] [numeric](5, 2) NULL,
	[dtl_trslry] [bit] NOT NULL,
	[ok_train] [bit] NULL,
	[train_prd] [int] NULL,
	[train_days] [int] NULL,
	[ok_salsms] [bit] NULL,
	[date_adj] [numeric](3, 0) NULL,
	[time_dir] [char](90) NULL,
	[f_allovrtime] [bit] NULL,
	[mnth_days] [int] NULL,
	[cmb_bank] [char](4) NULL,
	[ok_saned] [bit] NULL,
	[f_Hday_cut] [bit] NULL,
	[punch1_halflate] [bit] NULL,
	[use_daily_salary] [bit] NULL,
	[leave_up_to_185] [bit] NULL,
	[three_periods_attendance] [bit] NULL,
	[ok_off_day_attendance] [bit] NULL,
	[res_allow_code] [char](2) NULL,
	[leave_below_bal] [bit] NULL,
	[abs_mltiple_max] [bit] NULL,
	[trans_allow_code] [char](2) NULL,
	[last_att_trans_day] [int] NULL,
	[comp_foremp_ptg] [numeric](5, 2) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppwarnings]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppwarnings](
	[empno] [char](6) NULL,
	[code] [char](2) NULL,
	[wdate] [char](8) NULL,
	[wdesc] [varchar](100) NULL,
	[wtimes] [smallint] NULL,
	[remarks] [varchar](100) NULL,
	[company] [char](2) NULL,
	[modified] [bit] NULL,
	[wid] [int] IDENTITY(1,1) NOT NULL,
	[w_use_vcode] [bit] NULL,
	[w_vcode] [char](5) NULL,
	[w_pnlty_type] [char](2) NULL,
	[w_pnlty_hdptg] [numeric](7, 2) NULL,
	[gnrtd_maintype] [char](1) NULL,
	[gnrtd_ref] [numeric](6, 0) NULL,
	[rcvdtrn] [bit] NULL,
	[lastupdt] [char](8) NULL,
	[usrid] [char](10) NULL,
PRIMARY KEY CLUSTERED 
(
	[wid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ppxfr]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ppxfr](
	[xfr_no] [numeric](6, 0) NOT NULL,
	[xfr_date] [char](8) NOT NULL,
	[xfr_empno] [char](6) NOT NULL,
	[xfr_fmdate] [char](8) NOT NULL,
	[xfr_fmcomp] [char](2) NOT NULL,
	[xfr_fmdept] [char](2) NOT NULL,
	[xfr_tocomp] [char](2) NOT NULL,
	[xfr_todept] [char](2) NOT NULL,
	[xfr_remarks] [char](60) NOT NULL,
	[xfr_acc_no] [char](19) NOT NULL,
	[modified] [bit] NOT NULL,
	[posted] [bit] NOT NULL,
	[rcvdtrn] [bit] NOT NULL,
	[xfr_type] [numeric](1, 0) NULL,
	[usrid] [char](10) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pricehst]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pricehst](
	[prcode] [numeric](12, 0) NOT NULL,
	[oldprice] [numeric](11, 2) NOT NULL,
	[newprice] [numeric](11, 2) NOT NULL,
	[tdate] [char](8) NOT NULL,
	[usrid] [char](10) NOT NULL,
	[qty] [numeric](11, 2) NOT NULL,
	[cmbkey] [char](24) NULL,
	[company] [char](2) NULL,
	[xitemkey] [char](22) NOT NULL,
	[modified] [bit] NOT NULL,
	[slcenter] [char](2) NULL,
	[promotion] [bit] NULL,
	[prm_start] [char](8) NULL,
	[prm_end] [char](8) NULL,
	[barcode] [char](20) NULL,
 CONSTRAINT [PK_pricehst] PRIMARY KEY CLUSTERED 
(
	[prcode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pucustom]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pucustom](
	[company] [char](2) NOT NULL,
	[invtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[custom_code] [char](20) NOT NULL,
	[cstdate] [char](8) NULL,
	[policy_no] [varchar](30) NULL,
	[policy_date] [char](8) NULL,
	[shipping_port] [varchar](50) NULL,
	[ttlqty] [numeric](13, 3) NULL,
	[ttlweight] [numeric](13, 3) NULL,
	[custm_broker] [varchar](60) NULL,
	[usrid] [char](10) NULL,
	[exported_company] [varchar](70) NULL,
	[itemsvalue] [float] NULL,
	[custom_value] [float] NULL,
	[vat_value] [float] NULL,
	[cstm_picture] [varchar](100) NULL,
	[lastupdt] [char](8) NULL,
	[transaction_no] [varchar](30) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pudept]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pudept](
	[dp_name] [varchar](30) NOT NULL,
	[dp_brno] [char](2) NOT NULL,
	[dp_dept] [char](2) NOT NULL,
	[dp_cashser] [char](19) NOT NULL,
	[dp_cslser] [char](19) NOT NULL,
	[dp_oslser] [char](19) NOT NULL,
	[dp_rcslser] [char](19) NOT NULL,
	[dp_roslser] [char](19) NOT NULL,
	[dp_custser] [char](19) NOT NULL,
	[dp_expser] [char](19) NOT NULL,
	[dp_okdiff] [bit] NOT NULL,
	[dp_diffser] [char](19) NOT NULL,
	[dp_mainwh] [char](2) NOT NULL,
	[dp_rtrnwh] [char](2) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[dp_comp] [char](2) NOT NULL,
	[modified] [bit] NOT NULL,
	[cstcode] [char](4) NOT NULL,
	[serfrt] [char](19) NOT NULL,
	[serins] [char](19) NOT NULL,
	[sercst] [char](19) NOT NULL,
	[serpvl] [char](19) NOT NULL,
	[sersmp] [char](19) NOT NULL,
	[serfn] [char](19) NOT NULL,
	[sertkt] [char](19) NOT NULL,
	[serfre] [char](19) NOT NULL,
	[sertrn] [char](19) NOT NULL,
	[seroth] [char](19) NOT NULL,
	[dp_lname] [varchar](30) NOT NULL,
	[vat_paid_act] [char](19) NULL,
	[chk_serfrt] [bit] NULL,
	[chk_serins] [bit] NULL,
	[chk_sercst] [bit] NULL,
	[chk_serpvl] [bit] NULL,
	[chk_sersmp] [bit] NULL,
	[chk_serfn] [bit] NULL,
	[chk_sertkt] [bit] NULL,
	[chk_serfre] [bit] NULL,
	[chk_sertrn] [bit] NULL,
	[chk_seroth] [bit] NULL,
	[VAT_AUTO_CALC] [bit] NULL,
	[suspended] [bit] NULL,
	[sc_code] [char](6) NULL,
	[servndr] [char](19) NULL,
 CONSTRAINT [PK_pudept] PRIMARY KEY CLUSTERED 
(
	[dp_brno] ASC,
	[dp_dept] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[pudtl]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pudtl](
	[slcenter] [char](2) NOT NULL,
	[company] [char](2) NOT NULL,
	[invtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[invdate] [char](8) NOT NULL,
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[qty] [float] NULL,
	[fqty] [numeric](10, 3) NOT NULL,
	[price] [float] NULL,
	[discpc] [float] NULL,
	[cost] [numeric](11, 2) NOT NULL,
	[ds_acfm] [numeric](1, 0) NOT NULL,
	[sl_acfm] [numeric](1, 0) NOT NULL,
	[gclass] [char](12) NOT NULL,
	[custno] [char](6) NOT NULL,
	[fcy] [char](3) NOT NULL,
	[barcode] [char](20) NOT NULL,
	[imfcval] [float] NOT NULL,
	[pack] [char](1) NOT NULL,
	[pkqty] [numeric](10, 3) NULL,
	[expdate] [char](8) NOT NULL,
	[binno] [char](6) NOT NULL,
	[shdqty] [numeric](9, 3) NOT NULL,
	[shdpk] [numeric](10, 3) NULL,
	[shadd] [char](1) NOT NULL,
	[frtqty] [numeric](9, 3) NOT NULL,
	[cmbkey] [char](24) NULL,
	[folio] [numeric](7, 0) NOT NULL,
	[rplct_post] [bit] NULL,
	[whno] [char](2) NULL,
	[splyinv] [char](20) NULL,
	[edm_value] [numeric](10, 3) NULL,
	[garntee_amt] [float] NULL,
	[Taxtype] [char](1) NULL,
	[item_vat] [numeric](12, 3) NULL,
	[item_price_net] [float] NULL,
	[item_fq_vat] [numeric](12, 3) NULL,
	[invdscamt] [float] NULL,
	[dsc_amt] [float] NULL,
 CONSTRAINT [PK_pudtl] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[invtype] ASC,
	[refno] ASC,
	[folio] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[puhdr]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[puhdr](
	[slcenter] [char](2) NOT NULL,
	[branch] [char](2) NOT NULL,
	[company] [char](2) NOT NULL,
	[invtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[invdate] [char](8) NOT NULL,
	[custno] [char](6) NOT NULL,
	[custnm] [varchar](50) NOT NULL,
	[glser] [char](19) NOT NULL,
	[dsctype] [char](1) NOT NULL,
	[pstmode] [numeric](1, 0) NOT NULL,
	[fcy] [char](3) NOT NULL,
	[fcyrate] [float] NULL,
	[duedate] [char](8) NOT NULL,
	[invttl] [float] NOT NULL,
	[invcst] [float] NOT NULL,
	[invdspc] [float] NOT NULL,
	[invdsvl] [float] NOT NULL,
	[valafds] [float] NOT NULL,
	[invpaid] [float] NOT NULL,
	[caser] [char](19) NOT NULL,
	[entries] [numeric](5, 0) NOT NULL,
	[released] [bit] NOT NULL,
	[posted] [bit] NOT NULL,
	[fixrate] [float] NULL,
	[spply_exp] [float] NOT NULL,
	[pricetp] [char](1) NOT NULL,
	[isglact] [bit] NOT NULL,
	[chkno] [char](8) NOT NULL,
	[chkdate] [char](8) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[jvgenrt] [bit] NOT NULL,
	[imfcval] [float] NOT NULL,
	[lcser] [char](19) NOT NULL,
	[frieght] [numeric](12, 2) NOT NULL,
	[insurexp] [numeric](12, 2) NOT NULL,
	[customfee] [numeric](12, 2) NOT NULL,
	[portexp] [numeric](12, 2) NOT NULL,
	[samplexp] [numeric](12, 2) NOT NULL,
	[lcinvexp] [float] NOT NULL,
	[fcinvexp] [float] NOT NULL,
	[lcothrexp] [numeric](12, 2) NOT NULL,
	[fineexp] [numeric](12, 2) NOT NULL,
	[lcttlexp] [float] NOT NULL,
	[fcttlexp] [float] NOT NULL,
	[tktexp] [numeric](11, 2) NOT NULL,
	[freexp] [numeric](11, 2) NOT NULL,
	[transexp] [numeric](11, 2) NOT NULL,
	[prodrate] [float] NOT NULL,
	[isl_c] [bit] NOT NULL,
	[binno] [char](6) NOT NULL,
	[aprxcst] [bit] NOT NULL,
	[aprxpc] [float] NOT NULL,
	[aprxser] [char](19) NOT NULL,
	[expser] [char](19) NOT NULL,
	[modified] [bit] NOT NULL,
	[splyinv] [char](20) NULL,
	[isorder] [bit] NOT NULL,
	[settled] [bit] NOT NULL,
	[rcvdtrn] [bit] NOT NULL,
	[fcothrexp] [numeric](12, 2) NOT NULL,
	[usrid] [char](10) NOT NULL,
	[jvdsc] [numeric](6, 0) NOT NULL,
	[paylcl] [bit] NOT NULL,
	[tdscpcs] [numeric](5, 2) NOT NULL,
	[tdscdays] [numeric](3, 0) NULL,
	[orderno] [char](20) NOT NULL,
	[slcode] [char](2) NOT NULL,
	[lccode] [char](15) NULL,
	[shpdate] [char](8) NULL,
	[edm] [int] NULL,
	[gntd_fm_lc] [bit] NULL,
	[lc_ship_no] [numeric](4, 0) NULL,
	[xfr_amt] [float] NULL,
	[xfr_acc] [char](19) NULL,
	[vat_amt_paid] [float] NULL,
	[taxfree_purchase] [float] NULL,
	[VatNot4Vender] [bit] NULL,
	[vndr_taxcode] [varchar](20) NULL,
	[expns4vat] [float] NULL,
	[tax_Pd_mthd] [char](1) NULL,
	[vndr_kind] [char](1) NULL,
	[manulvat] [float] NULL,
	[dscamt_type] [numeric](1, 0) NULL,
	[hlldscnt] [float] NULL,
	[PriceIncludeVat] [bit] NULL,
	[vat_percent] [numeric](5, 2) NULL,
	[fqtyval] [float] NULL,
	[datetime_stamp] [datetime] NULL,
	[chng_item_price] [bit] NULL,
	[zatca_rounding] [bit] NULL,
	[unincld_vndr_expns] [float] NULL,
	[is_pu_dsc_amt] [bit] NULL,
 CONSTRAINT [PK_puhdr] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[invtype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[puprsnitems]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[puprsnitems](
	[itemno] [char](16) NOT NULL,
	[slcode] [char](2) NULL,
	[notified] [bit] NULL,
 CONSTRAINT [PK_puprsnitems] PRIMARY KEY CLUSTERED 
(
	[itemno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[Qinvtrk]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Qinvtrk](
	[company] [char](2) NULL,
	[invtype] [char](2) NULL,
	[refno] [int] NULL,
	[usrid] [char](10) NULL,
	[acsusrid] [char](10) NULL,
	[acsdate] [smalldatetime] NULL,
	[acsmachine] [varchar](50) NULL,
	[acsdsplyothersQH] [bit] NULL,
	[acsremote] [bit] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[re_elec_inv_dt]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[re_elec_inv_dt](
	[company] [char](2) NOT NULL,
	[refno] [char](15) NOT NULL,
	[iyear] [char](4) NOT NULL,
	[imonth] [char](2) NOT NULL,
	[trdate] [char](8) NULL,
	[property_code] [int] NOT NULL,
	[fcy] [char](3) NULL,
	[unit_code] [int] NULL,
	[powertype] [numeric](1, 0) NULL,
	[contract] [int] NULL,
	[tenant_code] [int] NULL,
	[prev_reading] [numeric](12, 2) NULL,
	[current_reading] [numeric](12, 2) NULL,
	[diff_reading] [numeric](12, 2) NULL,
	[amount] [float] NULL,
	[cleaning_fees] [float] NULL,
	[services_amount] [float] NULL,
	[local_fees] [float] NULL,
	[Late_amount] [float] NULL,
	[total_amount] [float] NULL,
	[other_fees] [float] NULL,
	[retext] [varchar](110) NOT NULL,
	[folio] [numeric](4, 0) NOT NULL,
	[trxsrc] [char](2) NULL,
	[rplct_post] [bit] NULL,
	[meter_no] [varchar](20) NULL,
	[loc_cur_bal] [float] NULL,
	[itype] [char](1) NULL,
	[price_type_code] [int] NULL,
	[Sewage_fees] [float] NULL,
	[local_council_fees] [float] NULL,
	[meter_rent_amount] [float] NULL,
	[city_dvlpmnt_amount] [float] NULL,
	[operations_services_amount] [float] NULL,
 CONSTRAINT [PK_re_elec_inv_dt] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[refno] ASC,
	[folio] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[re_elec_inv_hd]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[re_elec_inv_hd](
	[company] [char](2) NOT NULL,
	[refno] [char](15) NOT NULL,
	[iyear] [char](4) NOT NULL,
	[imonth] [char](2) NOT NULL,
	[trdate] [char](8) NULL,
	[iss_date] [char](8) NULL,
	[duedate] [char](8) NULL,
	[property_code] [int] NOT NULL,
	[fcy] [char](3) NULL,
	[fcyrate] [float] NULL,
	[powertype] [numeric](1, 0) NULL,
	[prev_reading] [numeric](12, 2) NULL,
	[current_reading] [numeric](12, 2) NULL,
	[diff_reading] [numeric](12, 2) NULL,
	[amount] [float] NULL,
	[cleaning_fees] [float] NULL,
	[services_amount] [float] NULL,
	[local_fees] [float] NULL,
	[Late_amount] [float] NULL,
	[total_amount] [float] NULL,
	[other_fees] [float] NULL,
	[retext] [varchar](110) NOT NULL,
	[trxsrc] [char](2) NULL,
	[lastupdt] [char](8) NULL,
	[usrid] [char](10) NULL,
	[rcvdtrn] [bit] NULL,
	[modified] [bit] NULL,
	[entries] [numeric](4, 0) NULL,
	[released] [bit] NULL,
	[posted] [bit] NULL,
	[jvtype] [char](2) NULL,
	[jvno] [numeric](6, 0) NULL,
	[itype] [char](1) NULL,
	[Sewage_fees] [float] NULL,
	[local_council_fees] [float] NULL,
	[meter_rent_amount] [float] NULL,
	[city_dvlpmnt_amount] [float] NULL,
	[operations_services_amount] [float] NULL,
	[inv_only_unit_code] [int] NULL,
 CONSTRAINT [PK_re_elec_inv_hd] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[re_elec_meters]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[re_elec_meters](
	[company] [char](2) NOT NULL,
	[meter_no] [varchar](20) NOT NULL,
	[un_re_code] [int] NOT NULL,
	[un_code] [int] NOT NULL,
	[prev_reading] [numeric](12, 2) NOT NULL,
	[current_reading] [numeric](12, 2) NOT NULL,
	[last_elect_reading] [numeric](12, 2) NOT NULL,
	[inactive] [bit] NOT NULL,
	[remarks] [varchar](70) NOT NULL,
	[crtdate] [char](8) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[lstusrupdate] [char](10) NOT NULL,
	[modified] [bit] NOT NULL,
	[meter_type] [char](1) NULL,
	[price_type_code] [int] NULL,
 CONSTRAINT [PK_re_elec_meters] PRIMARY KEY CLUSTERED 
(
	[meter_no] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[re_entitle_batch_dt]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[re_entitle_batch_dt](
	[company] [char](2) NOT NULL,
	[refno] [int] NOT NULL,
	[trdate] [char](8) NOT NULL,
	[fcy] [char](3) NOT NULL,
	[contract] [int] NOT NULL,
	[payment_no] [numeric](4, 0) NOT NULL,
	[tenant_code] [int] NOT NULL,
	[ftramount] [float] NOT NULL,
	[ltramount] [float] NOT NULL,
	[vat_amt_paid] [float] NOT NULL,
	[duedate] [char](8) NOT NULL,
	[re_code] [int] NOT NULL,
	[un_code] [int] NOT NULL,
	[glser] [char](19) NOT NULL,
	[gnrtd_trtype] [char](2) NOT NULL,
	[gnrtd_ref] [numeric](6, 0) NOT NULL,
	[folio] [numeric](5, 0) NOT NULL,
 CONSTRAINT [PK_re_entitle_batch_dt] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[refno] ASC,
	[folio] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[re_entitle_batch_hd]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[re_entitle_batch_hd](
	[company] [char](2) NOT NULL,
	[refno] [int] NOT NULL,
	[trdate] [char](8) NOT NULL,
	[fcy] [char](3) NOT NULL,
	[fcyrate] [float] NOT NULL,
	[contract_type] [numeric](1, 0) NOT NULL,
	[re_code] [int] NOT NULL,
	[duedatefm] [char](8) NOT NULL,
	[duedateto] [char](8) NOT NULL,
	[retext] [varchar](70) NOT NULL,
	[Vat_Percent] [numeric](5, 2) NOT NULL,
	[ttlfamount] [float] NOT NULL,
	[ttlamount] [float] NOT NULL,
	[ttlvatamt] [float] NOT NULL,
	[caser] [char](19) NOT NULL,
	[usrid] [char](10) NOT NULL,
	[batchstatus] [char](1) NOT NULL,
	[entries] [numeric](5, 0) NOT NULL,
	[modified] [bit] NOT NULL,
	[rcvdtrn] [bit] NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[datetime_stamp] [smalldatetime] NULL,
 CONSTRAINT [pk_re_entitle_batch_hd] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[re_fixes_maintenance]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[re_fixes_maintenance](
	[company] [char](2) NOT NULL,
	[trdate] [char](8) NULL,
	[fcy] [char](3) NULL,
	[fcyrate] [float] NULL,
	[amount] [float] NULL,
	[descrptn] [text] NOT NULL,
	[unit_or_property] [numeric](1, 0) NULL,
	[un_code] [int] NULL,
	[re_code] [int] NULL,
	[cost_bear_by] [numeric](1, 0) NULL,
	[cost_paid_by] [numeric](1, 0) NULL,
	[bear_by_contract] [int] NULL,
	[bear_by_tenant_code] [int] NULL,
	[paid_by_cash_ac] [char](19) NULL,
	[paid_by_broker] [int] NULL,
	[retext] [varchar](110) NOT NULL,
	[trtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[released] [bit] NULL,
	[posted] [bit] NULL,
	[trxsrc] [char](2) NULL,
	[lastupdt] [char](8) NULL,
	[usrid] [char](10) NULL,
	[rcvdtrn] [bit] NULL,
	[modified] [bit] NULL,
	[vat_percent] [numeric](5, 2) NULL,
 CONSTRAINT [PK_re_fixes_maintenance] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[trtype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
/****** Object:  Table [dbo].[re_prices_types]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[re_prices_types](
	[price_code] [int] NOT NULL,
	[price_type] [char](1) NULL,
	[price_name] [varchar](60) NULL,
	[price_lname] [varchar](60) NULL,
	[inactive] [bit] NOT NULL,
	[remarks] [varchar](50) NULL,
	[price_strips_residental] [numeric](1, 0) NULL,
	[residental_strip_max1] [numeric](6, 0) NULL,
	[residental_strip_max2] [numeric](6, 0) NULL,
	[residental_strip_max3] [numeric](6, 0) NULL,
	[residental_strip_max4] [numeric](6, 0) NULL,
	[residental_strip_max5] [numeric](6, 0) NULL,
	[residental_strip_max6] [numeric](6, 0) NULL,
	[residental_strip_price1] [float] NULL,
	[residental_strip_price2] [float] NULL,
	[residental_strip_price3] [float] NULL,
	[residental_strip_price4] [float] NULL,
	[residental_strip_price5] [float] NULL,
	[residental_strip_price6] [float] NULL,
	[residental_strip_price7] [float] NULL,
	[residental_services_amount] [float] NULL,
	[residental_cleaning_fees_ptg] [numeric](5, 2) NULL,
	[residental_local_fees_ptg] [numeric](5, 2) NULL,
	[residental_other_fees_ptg] [numeric](5, 2) NULL,
	[price_strips_commercial] [numeric](1, 0) NULL,
	[commercial_strip_max1] [numeric](6, 0) NULL,
	[commercial_strip_max2] [numeric](6, 0) NULL,
	[commercial_strip_max3] [numeric](6, 0) NULL,
	[commercial_strip_max4] [numeric](6, 0) NULL,
	[commercial_strip_max5] [numeric](6, 0) NULL,
	[commercial_strip_max6] [numeric](6, 0) NULL,
	[commercial_strip_price1] [float] NULL,
	[commercial_strip_price2] [float] NULL,
	[commercial_strip_price3] [float] NULL,
	[commercial_strip_price4] [float] NULL,
	[commercial_strip_price5] [float] NULL,
	[commercial_strip_price6] [float] NULL,
	[commercial_strip_price7] [float] NULL,
	[commercial_services_amount] [float] NULL,
	[commercial_cleaning_fees_ptg] [numeric](5, 2) NULL,
	[commercial_local_fees_ptg] [numeric](5, 2) NULL,
	[commercial_other_fees_ptg] [numeric](5, 2) NULL,
	[residental_Sewage_fees_ptg] [numeric](5, 2) NULL,
	[residental_local_council_fees_ptg] [numeric](5, 2) NULL,
	[residental_meter_rent_amount] [float] NULL,
	[residental_city_dvlpmnt_amount] [float] NULL,
	[residental_operations_services_ptg] [numeric](5, 2) NULL,
	[commercial_Sewage_fees_ptg] [numeric](5, 2) NULL,
	[commercial_local_council_fees_ptg] [numeric](5, 2) NULL,
	[commercial_meter_rent_amount] [float] NULL,
	[commercial_city_dvlpmnt_amount] [float] NULL,
	[commercial_operations_services_ptg] [numeric](5, 2) NULL,
	[crtdate] [char](8) NULL,
	[lastupdt] [char](8) NULL,
	[lstusrupdate] [char](10) NULL,
	[modified] [bit] NULL,
 CONSTRAINT [PK_re_prices_types] PRIMARY KEY CLUSTERED 
(
	[price_code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[re_spcl_dsc_dt]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[re_spcl_dsc_dt](
	[company] [char](2) NOT NULL,
	[trtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[trdate] [char](8) NULL,
	[contract] [int] NULL,
	[tenant_code] [int] NULL,
	[fcy] [char](3) NULL,
	[fcyrate] [float] NULL,
	[type_of_dsc] [numeric](1, 0) NULL,
	[dsc_factor] [float] NULL,
	[dsc_value] [float] NULL,
	[vat_value] [float] NULL,
	[dsc_ac] [char](19) NULL,
	[vat_ac] [char](19) NULL,
	[retext] [varchar](110) NOT NULL,
	[folio] [numeric](4, 0) NOT NULL,
	[trxsrc] [char](2) NULL,
	[rplct_post] [bit] NULL,
	[re_code] [int] NULL,
	[un_code] [int] NULL,
	[un_kind] [numeric](1, 0) NULL,
 CONSTRAINT [PK_re_spcl_dsc_dt] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[trtype] ASC,
	[refno] ASC,
	[folio] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[re_spcl_dsc_hd]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[re_spcl_dsc_hd](
	[company] [char](2) NOT NULL,
	[trtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[trdate] [char](8) NULL,
	[contract_type] [numeric](1, 0) NULL,
	[fcy] [char](3) NULL,
	[fcyrate] [float] NULL,
	[un_kind] [numeric](1, 0) NULL,
	[unit_or_property] [numeric](1, 0) NULL,
	[un_code] [int] NULL,
	[re_code] [int] NULL,
	[type_of_dsc] [numeric](1, 0) NULL,
	[dsc_factor] [float] NULL,
	[dsc_ttl_value] [float] NULL,
	[vat_ttl_value] [float] NULL,
	[retext] [varchar](110) NOT NULL,
	[trxsrc] [char](2) NULL,
	[entries] [numeric](4, 0) NULL,
	[released] [bit] NULL,
	[posted] [bit] NULL,
	[lastupdt] [char](8) NULL,
	[usrid] [char](10) NULL,
	[rcvdtrn] [bit] NULL,
	[modified] [bit] NULL,
	[Vat_Percent] [numeric](5, 2) NULL,
	[datetime_stamp] [datetime] NULL,
	[inv_printed] [numeric](2, 0) NULL,
 CONSTRAINT [PK_re_spcl_dsc_hd] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[trtype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[rebank]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[rebank](
	[bank_code] [int] NOT NULL,
	[bank_name] [varchar](50) NULL,
	[bank_lname] [varchar](50) NULL,
	[remarks] [varchar](50) NULL,
	[crtdate] [char](8) NULL,
	[lastupdt] [char](8) NULL,
	[lstusrupdate] [char](10) NULL,
	[modified] [bit] NULL,
 CONSTRAINT [PK_bank] PRIMARY KEY CLUSTERED 
(
	[bank_code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[rebrokers]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[rebrokers](
	[company] [char](2) NOT NULL,
	[code] [int] NOT NULL,
	[fcy] [char](3) NOT NULL,
	[name] [varchar](60) NULL,
	[lname] [varchar](60) NULL,
	[idtype_code] [int] NULL,
	[natnlty_code] [int] NULL,
	[IdNo] [varchar](30) NULL,
	[IdCopy] [numeric](3, 0) NULL,
	[mobile] [varchar](25) NULL,
	[tel] [varchar](50) NULL,
	[email] [varchar](50) NULL,
	[fax] [varchar](20) NULL,
	[re_percent] [numeric](5, 2) NULL,
	[bank_code] [int] NULL,
	[bkacct] [varchar](30) NULL,
	[glser] [char](19) NULL,
	[openbal] [float] NULL,
	[curbal] [float] NULL,
	[openfcy] [float] NULL,
	[curfcy] [float] NULL,
	[inactive] [bit] NULL,
	[remarks] [varchar](50) NULL,
	[crtdate] [char](8) NULL,
	[lastupdt] [char](8) NULL,
	[lstusrupdate] [char](10) NULL,
	[modified] [bit] NULL,
	[traderegno] [varchar](20) NULL,
	[city] [char](6) NULL,
	[location] [varchar](70) NULL,
	[llocation] [varchar](70) NULL,
	[national_address] [varchar](50) NULL,
	[mgr_name] [varchar](60) NULL,
	[mgr_lname] [varchar](60) NULL,
 CONSTRAINT [PK_rebrokers] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[code] ASC,
	[fcy] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[recontracts]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[recontracts](
	[company] [char](2) NOT NULL,
	[contract] [int] NOT NULL,
	[regno] [varchar](20) NOT NULL,
	[contract_type] [numeric](1, 0) NOT NULL,
	[fcy] [char](3) NULL,
	[fcyrate] [float] NULL,
	[kind] [numeric](1, 0) NULL,
	[issdate] [char](8) NULL,
	[issplace] [varchar](20) NULL,
	[start_date] [char](8) NULL,
	[end_date] [char](8) NULL,
	[no_of_months] [float] NULL,
	[un_code] [int] NULL,
	[un_basic_totalrent] [float] NULL,
	[monthly_fixed_srvc_amount] [bit] NULL,
	[un_elect_meter_current] [numeric](12, 2) NULL,
	[un_water_meter_current] [numeric](12, 2) NULL,
	[un_gaz_meter_current] [numeric](12, 2) NULL,
	[tenant_code] [int] NULL,
	[un_deposit_amt] [float] NULL,
	[un_advanced_amt] [float] NULL,
	[un_elect_monthly_amnt] [float] NULL,
	[un_water_monthly_amnt] [float] NULL,
	[un_gas_monthly_amnt] [float] NULL,
	[un_no_of_parkings] [numeric](3, 0) NULL,
	[un_parking_monthly_amnt] [float] NULL,
	[un_monthly_rent_amt] [float] NULL,
	[total_amnt] [float] NULL,
	[is_taxable] [bit] NULL,
	[RentVatType] [numeric](1, 0) NULL,
	[vat_percent] [numeric](5, 2) NULL,
	[vat_amt] [float] NULL,
	[rent_payment_period] [numeric](1, 0) NULL,
	[rent_no_of_payments] [numeric](4, 0) NULL,
	[rent_regular_payment] [float] NULL,
	[first_prd_paymnt] [float] NULL,
	[last_prd_paymnt] [float] NULL,
	[rent_payments_total] [float] NULL,
	[regular_payment_vat] [float] NULL,
	[first_payment_vat] [float] NULL,
	[tenant_rcvunit_date] [char](8) NULL,
	[check_out_date] [char](8) NULL,
	[clnt_taxcode] [varchar](20) NULL,
	[remarks] [varchar](50) NULL,
	[statusCode] [char](1) NULL,
	[last_pyment_generated] [numeric](4, 0) NULL,
	[last_balance] [float] NULL,
	[last_loc_balance] [float] NULL,
	[last_deposit_amt] [float] NULL,
	[last_loc_deposit_amt] [float] NULL,
	[last_elect_balance] [float] NULL,
	[current_balance] [float] NULL,
	[current_loc_balance] [float] NULL,
	[current_elect_balance] [float] NULL,
	[crtdate] [char](8) NULL,
	[lastupdt] [char](8) NULL,
	[lstusrupdate] [char](10) NULL,
	[modified] [bit] NULL,
	[un_broker_code] [int] NULL,
	[un_re_percent] [numeric](5, 2) NULL,
	[end_status_date] [char](8) NULL,
	[last_loc_elect_balance] [float] NULL,
	[current_loc_elect_balance] [float] NULL,
	[terminate_reason] [varchar](100) NULL,
	[terminate_datetime] [smalldatetime] NULL,
	[terminate_usrid] [char](10) NULL,
	[srvces_amnt] [float] NULL,
	[Contract_image] [varchar](180) NULL,
	[rent_amount] [float] NULL,
	[cat1_amount] [float] NULL,
	[cat2_amount] [float] NULL,
	[cat3_amount] [float] NULL,
	[cat4_amount] [float] NULL,
	[cat5_amount] [float] NULL,
	[cat6_amount] [float] NULL,
	[cat7_amount] [float] NULL,
	[renew_of_contract] [int] NULL,
	[usrid] [char](10) NULL,
 CONSTRAINT [PK_recontracts] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[contract] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[recontracts_elec_open]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[recontracts_elec_open](
	[company] [char](2) NOT NULL,
	[contract] [int] NOT NULL,
	[un_code] [int] NOT NULL,
	[meter_no] [varchar](20) NOT NULL,
	[un_elect_meter_current] [numeric](12, 2) NOT NULL,
	[opn_bal] [float] NULL,
	[loc_opn_bal] [float] NULL,
	[cur_bal] [float] NULL,
	[loc_cur_bal] [float] NULL,
	[meter_type] [char](1) NULL,
 CONSTRAINT [PK_recontracts_elec_open] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[contract] ASC,
	[meter_no] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[reidtypes]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[reidtypes](
	[idtype_code] [int] NOT NULL,
	[idtype_name] [varchar](50) NULL,
	[idtype_lname] [varchar](50) NULL,
	[remarks] [varchar](50) NULL,
	[crtdate] [char](8) NULL,
	[lastupdt] [char](8) NULL,
	[lstusrupdate] [char](10) NULL,
	[modified] [bit] NULL,
 CONSTRAINT [PK_renationality] PRIMARY KEY CLUSTERED 
(
	[idtype_code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[renatnlty]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[renatnlty](
	[natnlty_code] [int] NOT NULL,
	[natnlty_name] [varchar](50) NULL,
	[natnlty_lname] [varchar](50) NULL,
	[remarks] [varchar](50) NULL,
	[crtdate] [char](8) NULL,
	[lastupdt] [char](8) NULL,
	[lstusrupdate] [char](10) NULL,
	[modified] [bit] NULL,
 CONSTRAINT [PK_renatnlty] PRIMARY KEY CLUSTERED 
(
	[natnlty_code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[reowners]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[reowners](
	[company] [char](2) NOT NULL,
	[code] [int] NOT NULL,
	[fcy] [char](3) NOT NULL,
	[name] [varchar](60) NULL,
	[lname] [varchar](60) NULL,
	[idtype_code] [int] NULL,
	[natnlty_code] [int] NULL,
	[IdNo] [varchar](30) NULL,
	[IdCopy] [numeric](3, 0) NULL,
	[mobile] [varchar](25) NULL,
	[tel] [varchar](50) NULL,
	[email] [varchar](50) NULL,
	[fax] [varchar](20) NULL,
	[bank_code] [int] NULL,
	[bkacctno] [varchar](30) NULL,
	[glser] [char](19) NULL,
	[openbal] [float] NULL,
	[curbal] [float] NULL,
	[openfcy] [float] NULL,
	[curfcy] [float] NULL,
	[inactive] [bit] NULL,
	[remarks] [varchar](50) NULL,
	[crtdate] [char](8) NULL,
	[lastupdt] [char](8) NULL,
	[lstusrupdate] [char](10) NULL,
	[modified] [bit] NULL,
	[traderegno] [varchar](20) NULL,
 CONSTRAINT [PK_reowners] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[code] ASC,
	[fcy] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[repayments]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[repayments](
	[company] [char](2) NOT NULL,
	[contract] [int] NOT NULL,
	[payment_no] [numeric](4, 0) NOT NULL,
	[fcy] [char](3) NULL,
	[issdate] [char](8) NULL,
	[duedate] [char](8) NULL,
	[amount] [float] NULL,
	[vat_amt] [float] NULL,
	[jv_type] [char](2) NULL,
	[jv_no] [numeric](6, 0) NULL,
	[jv_date] [char](8) NULL,
	[paid_amount] [float] NULL,
	[paid_vat_amt] [float] NULL,
	[crtd_dttime] [smalldatetime] NULL,
 CONSTRAINT [PK_reunitscontractinstlmnts] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[contract] ASC,
	[payment_no] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[reproperty]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[reproperty](
	[company] [char](2) NOT NULL,
	[re_code] [int] NOT NULL,
	[re_name] [varchar](60) NULL,
	[re_lname] [varchar](60) NULL,
	[re_city] [char](6) NULL,
	[re_location] [varchar](70) NULL,
	[re_llocation] [varchar](70) NULL,
	[re_national_address] [varchar](50) NULL,
	[re_resttype_code] [int] NULL,
	[re_glser] [char](19) NULL,
	[re_descrptn] [text] NULL,
	[re_no_of_floors] [numeric](3, 0) NULL,
	[re_no_of_units] [numeric](3, 0) NULL,
	[re_no_of_elevators] [numeric](3, 0) NULL,
	[re_no_of_Parking_lots] [numeric](3, 0) NULL,
	[re_income_ac] [char](19) NULL,
	[re_expense_ac] [char](19) NULL,
	[re_ours_deposit_ac] [char](19) NULL,
	[re_others_deposit_ac] [char](19) NULL,
	[re_elect_ac] [char](19) NULL,
	[re_powertype] [numeric](1, 0) NULL,
	[prev_reading] [numeric](12, 2) NULL,
	[last_elect_reading] [numeric](12, 2) NULL,
	[crtdate] [char](8) NULL,
	[lastupdt] [char](8) NULL,
	[lstusrupdate] [char](10) NULL,
	[modified] [bit] NULL,
	[re_tel] [varchar](50) NULL,
	[re_fax] [varchar](20) NULL,
	[re_email] [varchar](50) NULL,
	[re_traderegno] [varchar](20) NULL,
	[re_ownr_ID] [int] NULL,
	[re_water_ac] [char](19) NULL,
	[prev_normal_water_reading] [numeric](12, 2) NULL,
	[last_normal_water_reading] [numeric](12, 2) NULL,
	[prev_filtrd_water_reading] [numeric](12, 2) NULL,
	[last_filtrd_water_reading] [numeric](12, 2) NULL,
 CONSTRAINT [PK_rerealestates] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[re_code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
/****** Object:  Table [dbo].[repropertytypes]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[repropertytypes](
	[resttype_code] [int] NOT NULL,
	[resttype_name] [varchar](50) NULL,
	[resttype_lname] [varchar](50) NULL,
	[remarks] [varchar](50) NULL,
	[crtdate] [char](8) NULL,
	[lastupdt] [char](8) NULL,
	[lstusrupdate] [char](10) NULL,
	[modified] [bit] NULL,
 CONSTRAINT [PK_rerealestatetypes] PRIMARY KEY CLUSTERED 
(
	[resttype_code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[resetup]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[resetup](
	[company] [char](2) NOT NULL,
	[brnno] [char](2) NOT NULL,
	[restp_name] [varchar](60) NULL,
	[restp_lname] [varchar](60) NULL,
	[restp_idtype_code] [int] NULL,
	[restp_natnlty_code] [int] NULL,
	[restp_IdNo] [varchar](30) NULL,
	[restp_IdCopy] [numeric](3, 0) NULL,
	[restpr_mobile] [varchar](25) NULL,
	[restp_tel] [varchar](50) NULL,
	[restp_email] [varchar](50) NULL,
	[restp_fax] [varchar](20) NULL,
	[restp_must_security_deposit] [bit] NULL,
	[restp_RentVatType] [numeric](1, 0) NULL,
	[restp_ctrct_issplace] [varchar](20) NULL,
	[restp_ctrct_deposit_months] [numeric](3, 0) NULL,
	[restp_income_Ac] [char](19) NULL,
	[restp_expense_Ac] [char](19) NULL,
	[vat_paid_act] [char](19) NULL,
	[vat_rcvd_act] [char](19) NULL,
	[ours_deposit_ac] [char](19) NULL,
	[others_deposit_ac] [char](19) NULL,
	[elect_income_Ac] [char](19) NULL,
	[cleaning_fees_Ac] [char](19) NULL,
	[services_Ac] [char](19) NULL,
	[local_fees_Ac] [char](19) NULL,
	[other_fees_Ac] [char](19) NULL,
	[unrented_elect_exp_ac] [char](19) NULL,
	[price_strips_residental] [numeric](1, 0) NULL,
	[residental_strip_max1] [numeric](6, 0) NULL,
	[residental_strip_max2] [numeric](6, 0) NULL,
	[residental_strip_max3] [numeric](6, 0) NULL,
	[residental_strip_max4] [numeric](6, 0) NULL,
	[residental_strip_max5] [numeric](6, 0) NULL,
	[residental_strip_max6] [numeric](6, 0) NULL,
	[residental_strip_price1] [float] NULL,
	[residental_strip_price2] [float] NULL,
	[residental_strip_price3] [float] NULL,
	[residental_strip_price4] [float] NULL,
	[residental_strip_price5] [float] NULL,
	[residental_strip_price6] [float] NULL,
	[residental_strip_price7] [float] NULL,
	[residental_services_amount] [float] NULL,
	[residental_cleaning_fees_ptg] [numeric](5, 2) NULL,
	[residental_local_fees_ptg] [numeric](5, 2) NULL,
	[residental_other_fees_ptg] [numeric](5, 2) NULL,
	[price_strips_commercial] [numeric](1, 0) NULL,
	[commercial_strip_max1] [numeric](6, 0) NULL,
	[commercial_strip_max2] [numeric](6, 0) NULL,
	[commercial_strip_max3] [numeric](6, 0) NULL,
	[commercial_strip_max4] [numeric](6, 0) NULL,
	[commercial_strip_max5] [numeric](6, 0) NULL,
	[commercial_strip_max6] [numeric](6, 0) NULL,
	[commercial_strip_price1] [float] NULL,
	[commercial_strip_price2] [float] NULL,
	[commercial_strip_price3] [float] NULL,
	[commercial_strip_price4] [float] NULL,
	[commercial_strip_price5] [float] NULL,
	[commercial_strip_price6] [float] NULL,
	[commercial_strip_price7] [float] NULL,
	[commercial_services_amount] [float] NULL,
	[commercial_cleaning_fees_ptg] [numeric](5, 2) NULL,
	[commercial_local_fees_ptg] [numeric](5, 2) NULL,
	[commercial_other_fees_ptg] [numeric](5, 2) NULL,
	[crtdate] [char](8) NULL,
	[lastupdt] [char](8) NULL,
	[lstusrupdate] [char](10) NULL,
	[modified] [bit] NULL,
	[restp_re_un_glser] [char](19) NULL,
	[restp_re_dsc_glser] [char](19) NULL,
	[use_contract_type2] [bit] NULL,
	[basic_cur_is_local] [bit] NULL,
	[electricity_cur] [char](3) NULL,
	[rent_cur] [char](3) NULL,
	[allow_cntrct_edit] [bit] NULL,
	[use_water_meters] [bit] NULL,
	[normal_water_dflt_price_code] [int] NULL,
	[filtrd_water_dflt_price_code] [int] NULL,
	[water_income_Ac] [char](19) NULL,
	[Sewage_fees_Ac] [char](19) NULL,
	[local_council_fees_Ac] [char](19) NULL,
	[meter_rent_Ac] [char](19) NULL,
	[city_dvlpmnt_Ac] [char](19) NULL,
	[operations_services_Ac] [char](19) NULL,
	[unrented_water_exp_ac] [char](19) NULL,
	[sl_dept] [char](2) NULL,
	[pu_dept] [char](2) NULL,
	[rent_svccmbkey] [char](24) NULL,
	[cat1_svccmbkey] [char](24) NULL,
	[cat1_income_Ac] [char](19) NULL,
	[cat1_expense_Ac] [char](19) NULL,
	[cat2_svccmbkey] [char](24) NULL,
	[cat2_income_Ac] [char](19) NULL,
	[cat2_expense_Ac] [char](19) NULL,
	[cat3_svccmbkey] [char](24) NULL,
	[cat3_income_Ac] [char](19) NULL,
	[cat3_expense_Ac] [char](19) NULL,
	[cat4_svccmbkey] [char](24) NULL,
	[cat4_income_Ac] [char](19) NULL,
	[cat4_expense_Ac] [char](19) NULL,
	[cat5_svccmbkey] [char](24) NULL,
	[cat5_income_Ac] [char](19) NULL,
	[cat5_expense_Ac] [char](19) NULL,
	[cat6_svccmbkey] [char](24) NULL,
	[cat6_income_Ac] [char](19) NULL,
	[cat6_expense_Ac] [char](19) NULL,
	[cat7_svccmbkey] [char](24) NULL,
	[cat7_income_Ac] [char](19) NULL,
	[cat7_expense_Ac] [char](19) NULL,
	[due_period] [numeric](1, 0) NULL,
	[contract_srch_type] [numeric](1, 0) NULL,
	[no_currency_diff] [bit] NULL,
	[force_contract_modification] [bit] NULL,
	[contract_srch_status] [numeric](1, 0) NULL,
	[prd1_duedate_is_issdate] [bit] NULL,
	[rent_svccmbkey_tax_exemptd] [char](24) NULL,
	[cat1_svccmbkey_tax_exemptd] [char](24) NULL,
	[cat2_svccmbkey_tax_exemptd] [char](24) NULL,
	[cat3_svccmbkey_tax_exemptd] [char](24) NULL,
	[cat4_svccmbkey_tax_exemptd] [char](24) NULL,
	[cat5_svccmbkey_tax_exemptd] [char](24) NULL,
	[cat6_svccmbkey_tax_exemptd] [char](24) NULL,
	[cat7_svccmbkey_tax_exemptd] [char](24) NULL,
	[use_Shared_Services] [bit] NULL,
	[Shared_Services_income_Ac] [char](19) NULL,
 CONSTRAINT [PK_rsetup] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[brnno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[retenants]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[retenants](
	[company] [char](2) NOT NULL,
	[code] [int] NOT NULL,
	[fcy] [char](3) NOT NULL,
	[name] [varchar](60) NULL,
	[lname] [varchar](60) NULL,
	[idtype_code] [int] NULL,
	[natnlty_code] [int] NULL,
	[IdNo] [varchar](30) NULL,
	[IdCopy] [numeric](3, 0) NULL,
	[mobile] [varchar](25) NULL,
	[tel] [varchar](50) NULL,
	[email] [varchar](50) NULL,
	[fax] [varchar](20) NULL,
	[bank_code] [int] NULL,
	[bkacct] [varchar](30) NULL,
	[glser] [char](19) NULL,
	[openbal] [float] NULL,
	[curbal] [float] NULL,
	[openfcy] [float] NULL,
	[curfcy] [float] NULL,
	[inactive] [bit] NULL,
	[remarks] [varchar](50) NULL,
	[crtdate] [char](8) NULL,
	[lastupdt] [char](8) NULL,
	[lstusrupdate] [char](10) NULL,
	[modified] [bit] NULL,
	[traderegno] [varchar](20) NULL,
	[clnt_taxcode] [varchar](20) NULL,
	[bldg_no] [varchar](50) NULL,
	[bldg_no_l] [varchar](50) NULL,
	[street_name] [varchar](50) NULL,
	[street_name_l] [varchar](50) NULL,
	[area_name] [varchar](50) NULL,
	[area_name_l] [varchar](50) NULL,
	[extra_address_no] [varchar](50) NULL,
	[extra_address_no_l] [varchar](50) NULL,
	[district] [varchar](50) NULL,
	[district_l] [varchar](50) NULL,
	[city_text] [varchar](50) NULL,
	[city_text_l] [varchar](50) NULL,
	[country_text] [varchar](50) NULL,
	[country_text_l] [varchar](50) NULL,
	[postal_code] [varchar](20) NULL,
	[Other_id] [varchar](20) NULL,
 CONSTRAINT [PK_rerenters] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[code] ASC,
	[fcy] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[retenants_ei]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[retenants_ei](
	[company] [char](2) NOT NULL,
	[Code] [int] NOT NULL,
	[fcy] [char](3) NOT NULL,
	[district] [varchar](50) NULL,
	[district_l] [varchar](50) NULL,
	[city_text] [varchar](50) NULL,
	[city_text_l] [varchar](50) NULL,
	[country_code] [numeric](3, 0) NULL,
	[postal_code] [varchar](20) NULL,
	[Other_id_SchemeID] [varchar](20) NULL,
	[bldg_no] [varchar](50) NULL,
	[bldg_no_l] [varchar](50) NULL,
	[street_name] [varchar](50) NULL,
	[street_name_l] [varchar](50) NULL,
	[area_name] [varchar](50) NULL,
	[area_name_l] [varchar](50) NULL,
	[extra_address_no] [varchar](50) NULL,
	[extra_address_no_l] [varchar](50) NULL,
	[street_name2] [varchar](50) NULL,
	[street_name2_l] [varchar](50) NULL,
	[Group_VAT_ID] [varchar](30) NULL,
	[Other_Scheme_Type] [varchar](10) NULL,
 CONSTRAINT [PK_retenants_ei] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[Code] ASC,
	[fcy] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[retrans_dt]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[retrans_dt](
	[company] [char](2) NOT NULL,
	[trtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[retranstype] [char](1) NULL,
	[trdate] [char](8) NULL,
	[contract] [int] NULL,
	[tenant_code] [int] NULL,
	[payment_no] [numeric](4, 0) NULL,
	[fcy] [char](3) NULL,
	[trxsrc] [char](2) NULL,
	[ftramount] [float] NULL,
	[ltramount] [float] NULL,
	[lastpaydate] [char](8) NULL,
	[lastpaidamt] [float] NULL,
	[retext] [varchar](110) NOT NULL,
	[folio] [numeric](4, 0) NOT NULL,
	[vat_amt_paid] [float] NULL,
	[vat_amt_fcy] [float] NULL,
	[lcaloc] [float] NULL,
	[fcaloc] [float] NULL,
	[aloctd] [char](1) NULL,
	[duedate] [char](8) NULL,
	[chkno] [char](8) NULL,
	[chkdate] [char](8) NULL,
	[chkbnk] [int] NULL,
	[dbcr] [char](1) NULL,
	[ackey] [char](19) NULL,
	[rcvno] [numeric](6, 0) NULL,
	[lstdate] [char](8) NULL,
	[match] [bit] NULL,
	[rplct_post] [bit] NULL,
	[electricty_ref] [char](15) NULL,
	[broker_code] [int] NULL,
	[re_code] [int] NULL,
	[un_code] [int] NULL,
	[meter_no] [varchar](20) NULL,
	[taxcatId] [numeric](3, 0) NULL,
	[itype] [char](1) NULL,
 CONSTRAINT [PK_retrans_dt] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[trtype] ASC,
	[refno] ASC,
	[folio] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[retrans_hd]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[retrans_hd](
	[company] [char](2) NOT NULL,
	[trtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[rent_type] [numeric](1, 0) NOT NULL,
	[retranstype] [char](1) NULL,
	[trdate] [char](8) NULL,
	[fcy] [char](3) NULL,
	[fcyrate] [float] NULL,
	[ttlfamount] [float] NULL,
	[ttlamount] [float] NULL,
	[caser] [char](19) NULL,
	[glser] [char](19) NULL,
	[retext] [varchar](110) NOT NULL,
	[released] [bit] NULL,
	[posted] [bit] NULL,
	[trxsrc] [char](2) NULL,
	[lastupdt] [char](8) NULL,
	[usrid] [char](10) NULL,
	[dtlttlfamt] [float] NULL,
	[dtlttlamt] [float] NULL,
	[dtlttlvatamt] [float] NULL,
	[rcvdtrn] [bit] NULL,
	[modified] [bit] NULL,
	[entries] [numeric](4, 0) NULL,
	[Vat_Percent] [numeric](5, 2) NULL,
	[fixrate] [numeric](9, 6) NULL,
	[lcnet] [float] NULL,
	[fcnet] [float] NULL,
	[lccnet] [float] NULL,
	[fccnet] [float] NULL,
	[isit_opst] [bit] NULL,
	[opst_val] [float] NULL,
	[opst_fcy] [char](3) NULL,
	[clcode] [char](2) NULL,
	[rcvd_by] [numeric](1, 0) NULL,
	[is_brokr_commsn] [bit] NULL,
	[brokr_percent] [numeric](5, 2) NULL,
	[brokr_commsn_amount] [float] NULL,
	[datetime_stamp] [datetime] NULL,
	[inv_printed] [numeric](2, 0) NULL,
	[diffamount] [float] NULL,
	[crtd_fm_batch_ref] [int] NULL,
	[itype] [char](1) NULL,
	[rtntype] [char](2) NULL,
	[rtnref] [numeric](6, 0) NULL,
	[rtndate] [char](8) NULL,
 CONSTRAINT [PK_retrans_hd] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[trtype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[reunits]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[reunits](
	[company] [char](2) NOT NULL,
	[un_code] [int] NOT NULL,
	[un_re_code] [int] NOT NULL,
	[un_number] [varchar](20) NULL,
	[un_name] [varchar](60) NULL,
	[un_lname] [varchar](60) NULL,
	[un_type] [int] NULL,
	[un_kind] [numeric](1, 0) NULL,
	[un_ownership] [numeric](1, 0) NULL,
	[un_area] [varchar](30) NULL,
	[un_owner_code] [int] NULL,
	[un_renter_code] [int] NULL,
	[un_unuse_code] [int] NULL,
	[un_descrptn] [text] NULL,
	[un_floor_no] [varchar](30) NULL,
	[un_no_of_rooms] [varchar](30) NULL,
	[un_bathrooms] [varchar](30) NULL,
	[un_deposit_amt] [numeric](12, 3) NULL,
	[un_annual_rent_amt] [numeric](12, 3) NULL,
	[un_fcy] [char](3) NULL,
	[un_elect_meter_No] [varchar](30) NULL,
	[un_water_meter_no] [varchar](30) NULL,
	[un_gaz_meter_no] [varchar](30) NULL,
	[un_glser] [char](19) NULL,
	[un_status] [char](1) NULL,
	[un_income_ac] [char](19) NULL,
	[un_expense_ac] [char](19) NULL,
	[un_ours_deposit_ac] [char](19) NULL,
	[un_others_deposit_ac] [char](19) NULL,
	[un_elect_ac] [char](19) NULL,
	[prev_reading] [numeric](12, 2) NULL,
	[last_elect_reading] [numeric](12, 2) NULL,
	[crtdate] [char](8) NULL,
	[lastupdt] [char](8) NULL,
	[lstusrupdate] [char](10) NULL,
	[modified] [bit] NULL,
	[un_broker_code] [int] NULL,
	[un_re_percent] [numeric](5, 2) NULL,
	[un_furniture_status] [numeric](1, 0) NULL,
	[un_ktchn_cabnts_instld] [numeric](1, 0) NULL,
	[un_water_ac] [char](19) NULL,
 CONSTRAINT [PK_reunits] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[un_code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
/****** Object:  Table [dbo].[reunits_extra]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[reunits_extra](
	[company] [char](2) NOT NULL,
	[un_code] [int] NOT NULL,
	[bedroom] [numeric](3, 0) NULL,
	[guest_room] [numeric](3, 0) NULL,
	[board_room] [numeric](3, 0) NULL,
	[hall_room] [numeric](3, 0) NULL,
	[dining_room] [numeric](3, 0) NULL,
	[maid_room] [numeric](3, 0) NULL,
	[storage_room] [numeric](3, 0) NULL,
	[kids_room] [numeric](3, 0) NULL,
	[kitchen] [numeric](3, 0) NULL,
	[kitchen_w_cabinets] [numeric](3, 0) NULL,
	[bathroom] [numeric](3, 0) NULL,
	[driver_room] [numeric](3, 0) NULL,
	[Patio] [numeric](3, 0) NULL,
	[Balcony] [numeric](3, 0) NULL,
	[central_ac] [numeric](3, 0) NULL,
	[window_ac] [numeric](3, 0) NULL,
	[split_ac] [numeric](3, 0) NULL,
 CONSTRAINT [PK_reunits_extra] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[un_code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[reunituse]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[reunituse](
	[unuse_code] [int] NOT NULL,
	[unuse_name] [varchar](50) NULL,
	[unuse_lname] [varchar](50) NULL,
	[remarks] [varchar](50) NULL,
	[crtdate] [char](8) NULL,
	[lastupdt] [char](8) NULL,
	[lstusrupdate] [char](10) NULL,
	[modified] [bit] NULL,
 CONSTRAINT [PK_reunituse] PRIMARY KEY CLUSTERED 
(
	[unuse_code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[salecntr]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[salecntr](
	[dp_name] [varchar](30) NOT NULL,
	[dp_brno] [char](2) NOT NULL,
	[dp_dept] [char](2) NOT NULL,
	[dp_cashser] [char](19) NOT NULL,
	[dp_cslser] [char](19) NOT NULL,
	[dp_oslser] [char](19) NOT NULL,
	[dp_rcslser] [char](19) NOT NULL,
	[dp_roslser] [char](19) NOT NULL,
	[dp_custser] [char](19) NOT NULL,
	[dp_expser] [char](19) NOT NULL,
	[dp_okdiff] [bit] NOT NULL,
	[dp_diffser] [char](19) NOT NULL,
	[dp_mainwh] [char](2) NOT NULL,
	[dp_rtrnwh] [char](2) NOT NULL,
	[lastupdt] [char](10) NOT NULL,
	[dp_comp] [char](2) NOT NULL,
	[dp_fccrdt] [bit] NOT NULL,
	[nochg_print] [bit] NOT NULL,
	[modified] [bit] NOT NULL,
	[srcst] [char](19) NOT NULL,
	[cstcode] [char](4) NOT NULL,
	[dp_crdcardac] [char](19) NOT NULL,
	[dp_rplsac] [char](19) NOT NULL,
	[dp_cardcomm] [char](19) NOT NULL,
	[dp_lname] [varchar](30) NOT NULL,
	[slwhsrc] [numeric](1, 0) NULL,
	[prpaidcrdac] [char](19) NOT NULL,
	[FRC_CRSL_FC] [bit] NULL,
	[inv_form_no] [numeric](2, 0) NULL,
	[sc_code] [char](6) NULL,
	[sanedcrd_act] [char](19) NULL,
	[no_of_invCopies] [numeric](1, 0) NULL,
	[vat_rcvd_act] [char](19) NULL,
	[custody_ac] [char](19) NULL,
	[stcpay_act] [char](19) NULL,
	[suspended] [bit] NULL,
	[qitaf_act] [char](19) NULL,
	[slscmnact] [char](19) NULL,
	[webcmnact] [char](19) NULL,
	[tprtexpact] [char](19) NULL,
	[bldg_no] [varchar](50) NULL,
	[bldg_no_l] [varchar](50) NULL,
	[street_name] [varchar](50) NULL,
	[street_name_l] [varchar](50) NULL,
	[area_name] [varchar](50) NULL,
	[area_name_l] [varchar](50) NULL,
	[extra_address_no] [varchar](50) NULL,
	[extra_address_no_l] [varchar](50) NULL,
	[district] [varchar](50) NULL,
	[district_l] [varchar](50) NULL,
	[city_text] [varchar](50) NULL,
	[city_text_l] [varchar](50) NULL,
	[street_name2] [varchar](50) NULL,
	[street_name2_l] [varchar](50) NULL,
	[postal_code] [varchar](20) NULL,
	[Other_id_SchemeID] [varchar](20) NULL,
	[Group_VAT_ID] [varchar](30) NULL,
	[country_code] [int] NULL,
	[Other_Scheme_Type] [varchar](10) NULL,
	[manafith_api] [varchar](100) NULL,
 CONSTRAINT [PK_salecntr] PRIMARY KEY CLUSTERED 
(
	[dp_brno] ASC,
	[dp_dept] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[sales_dd]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[sales_dd](
	[slcenter] [char](2) NOT NULL,
	[company] [char](2) NOT NULL,
	[invtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[invdate] [char](8) NOT NULL,
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[qty] [float] NULL,
	[fqty] [numeric](11, 3) NOT NULL,
	[price] [float] NULL,
	[discpc] [float] NULL,
	[cost] [float] NOT NULL,
	[ds_acfm] [numeric](1, 0) NOT NULL,
	[sl_acfm] [numeric](1, 0) NOT NULL,
	[gclass] [char](12) NOT NULL,
	[custno] [char](6) NOT NULL,
	[fcy] [char](3) NOT NULL,
	[barcode] [char](20) NOT NULL,
	[imfcval] [float] NOT NULL,
	[pack] [char](1) NOT NULL,
	[pkqty] [numeric](8, 3) NOT NULL,
	[shadd] [char](1) NOT NULL,
	[shdpk] [numeric](8, 3) NOT NULL,
	[shdqty] [numeric](11, 3) NOT NULL,
	[frtqty] [numeric](9, 3) NOT NULL,
	[rtnqty] [numeric](12, 3) NOT NULL,
	[whno] [char](2) NOT NULL,
	[cmbkey] [char](24) NULL,
	[dscqty] [numeric](12, 3) NULL,
	[dscprice] [float] NULL,
	[rplct_post] [bit] NULL,
	[folio] [numeric](4, 0) NOT NULL,
	[whqty] [varchar](200) NULL,
	[nprice2] [numeric](12, 3) NULL,
	[nprice3] [numeric](12, 3) NULL,
	[jvtype] [char](2) NULL,
	[jvref] [numeric](6, 0) NULL,
	[taxtype] [char](1) NULL,
	[item_vat] [numeric](12, 3) NULL,
	[item_price_net] [float] NULL,
	[dscpack] [char](1) NULL,
	[avgcost] [float] NULL,
 CONSTRAINT [PK_sales_dd] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[invtype] ASC,
	[refno] ASC,
	[folio] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[sales_dh]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[sales_dh](
	[slcenter] [char](2) NOT NULL,
	[branch] [char](2) NOT NULL,
	[company] [char](2) NOT NULL,
	[invtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[invdate] [char](8) NOT NULL,
	[custno] [char](6) NOT NULL,
	[custnm] [varchar](50) NOT NULL,
	[glser] [char](19) NOT NULL,
	[dsctype] [char](1) NOT NULL,
	[pstmode] [numeric](1, 0) NOT NULL,
	[fcy] [char](3) NOT NULL,
	[fcyrate] [numeric](6, 3) NOT NULL,
	[duedate] [char](8) NOT NULL,
	[invttl] [float] NOT NULL,
	[invcst] [float] NOT NULL,
	[invdspc] [float] NOT NULL,
	[invdsvl] [float] NOT NULL,
	[valafds] [float] NOT NULL,
	[invpaid] [numeric](14, 2) NOT NULL,
	[caser] [char](19) NOT NULL,
	[entries] [numeric](5, 0) NOT NULL,
	[released] [bit] NOT NULL,
	[posted] [bit] NOT NULL,
	[fixrate] [numeric](6, 3) NOT NULL,
	[extamt] [numeric](14, 2) NOT NULL,
	[extser] [char](19) NOT NULL,
	[pricetp] [char](1) NOT NULL,
	[ischeque] [bit] NOT NULL,
	[chkno] [char](8) NOT NULL,
	[chkdate] [char](8) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[jvgenrt] [bit] NOT NULL,
	[cccommsn] [float] NOT NULL,
	[belowbal] [bit] NOT NULL,
	[fcy2] [char](3) NOT NULL,
	[ccpayment] [numeric](13, 2) NOT NULL,
	[rplsamt] [numeric](13, 2) NOT NULL,
	[pdother] [bit] NOT NULL,
	[slcode] [char](2) NOT NULL,
	[prpaidamt] [numeric](12, 2) NULL,
	[instldays] [numeric](2, 0) NOT NULL,
	[instflag] [bit] NOT NULL,
	[slcmnd] [bit] NOT NULL,
	[inv_printed] [numeric](2, 0) NOT NULL,
	[bendit] [bit] NOT NULL,
	[modified] [bit] NOT NULL,
	[rqstorder] [numeric](6, 0) NOT NULL,
	[rqststld] [bit] NOT NULL,
	[carrier] [char](3) NOT NULL,
	[rcvdtrn] [bit] NOT NULL,
	[usrid] [char](10) NOT NULL,
	[address] [varchar](50) NOT NULL,
	[suspend] [bit] NOT NULL,
	[rtnref] [numeric](6, 0) NOT NULL,
	[ispurchase] [bit] NOT NULL,
	[stkjvno] [numeric](6, 0) NOT NULL,
	[posinv] [numeric](1, 0) NULL,
	[jvdate] [char](8) NULL,
	[vat_amt_rcvd] [float] NULL,
	[taxfree_sales] [float] NULL,
	[PriceVatType] [numeric](1, 0) NULL,
	[vat_percent] [numeric](5, 2) NULL,
	[datetime_stamp] [datetime] NULL,
	[clnt_taxcode] [varchar](20) NULL,
	[clnt_kind] [char](1) NULL,
	[jvtype] [char](2) NULL,
	[jvref] [numeric](6, 0) NULL,
	[yrcode] [char](4) NULL,
	[zatca_rounding] [bit] NULL,
	[dsc4allqty] [bit] NULL,
	[invoicelist] [varchar](200) NULL,
 CONSTRAINT [PK_sales_dh] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[invtype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[sales_dt]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[sales_dt](
	[slcenter] [char](2) NOT NULL,
	[company] [char](2) NOT NULL,
	[invtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[invdate] [char](8) NOT NULL,
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[qty] [float] NULL,
	[fqty] [numeric](11, 3) NOT NULL,
	[price] [float] NULL,
	[discpc] [float] NOT NULL,
	[cost] [float] NOT NULL,
	[ds_acfm] [numeric](1, 0) NOT NULL,
	[sl_acfm] [numeric](1, 0) NOT NULL,
	[gclass] [char](12) NOT NULL,
	[custno] [char](6) NOT NULL,
	[fcy] [char](3) NOT NULL,
	[barcode] [char](20) NOT NULL,
	[imfcval] [float] NOT NULL,
	[pack] [char](1) NOT NULL,
	[pkqty] [numeric](10, 3) NULL,
	[shadd] [char](1) NOT NULL,
	[shdpk] [numeric](10, 3) NULL,
	[shdqty] [numeric](11, 3) NOT NULL,
	[frtqty] [numeric](9, 3) NOT NULL,
	[rtnqty] [float] NULL,
	[whno] [char](2) NOT NULL,
	[cmbkey] [char](24) NULL,
	[folio] [numeric](7, 0) NOT NULL,
	[rplct_post] [bit] NULL,
	[sold_item_status] [numeric](1, 0) NULL,
	[Taxtype] [char](1) NULL,
	[ps_item_vat] [float] NULL,
	[dsc_amt] [float] NULL,
	[binno] [char](6) NULL,
	[item_price_net] [float] NULL,
	[invdscamt] [float] NULL,
	[item_fq_vat] [numeric](13, 3) NULL,
	[item_vat] [numeric](14, 3) NULL,
	[m_sl_ref] [int] NULL,
 CONSTRAINT [PK_sales_dt] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[invtype] ASC,
	[refno] ASC,
	[folio] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[sales_dtx]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[sales_dtx](
	[company] [char](2) NOT NULL,
	[invtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[folio] [numeric](6, 0) NOT NULL,
	[binno] [char](6) NULL,
	[expdate] [char](8) NULL,
 CONSTRAINT [PK_sales_dtx] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[invtype] ASC,
	[refno] ASC,
	[folio] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[sales_ei]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[sales_ei](
	[company] [char](2) NOT NULL,
	[invtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[InvoiceTypeCode] [varchar](6) NULL,
	[tax_invoice_type] [char](2) NULL,
	[uuid] [uniqueidentifier] ROWGUIDCOL  NULL,
	[previousInvoiceHash] [text] NULL,
	[QRvalue] [text] NULL,
	[Order_ref_id] [varchar](50) NULL,
	[ContractDocRef] [varchar](50) NULL,
	[PaymentType] [varchar](50) NULL,
	[InvoiceTransactionCode] [varchar](10) NULL,
	[DebitCreditReason] [varchar](100) NULL,
	[CurrentInvoiceHash] [text] NULL,
	[InvoiceCounterValue] [varchar](40) NULL,
	[LatestDeliveryDate] [date] NULL,
	[einv_is_sent] [int] NULL,
	[usr_slct_simple_einv] [bit] NULL,
	[invoice_charges] [float] NULL,
	[ubl] [varchar](max) NULL,
	[ExemptionReason] [varchar](100) NULL,
	[Exemptioncode] [varchar](20) NULL,
	[reason_not_sent] [varchar](2000) NULL,
	[zatca_datetime] [varchar](40) NULL,
	[folio] [varchar](20) NULL,
	[DeviceSN] [varchar](100) NULL,
	[is_production] [bit] NULL,
 CONSTRAINT [PK_sales_ei] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[invtype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
/****** Object:  Table [dbo].[sales_gd]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[sales_gd](
	[refno] [numeric](6, 0) NOT NULL,
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[company] [char](2) NOT NULL,
	[barcode] [char](20) NOT NULL,
	[cmbkey] [char](24) NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[sales_gh]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[sales_gh](
	[refno] [numeric](6, 0) NOT NULL,
	[sysdate] [char](8) NOT NULL,
	[xdesc] [varchar](50) NOT NULL,
	[company] [char](2) NOT NULL,
	[entries] [numeric](5, 0) NOT NULL,
	[suspend] [bit] NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[modified] [bit] NOT NULL,
	[rcvdtrn] [bit] NOT NULL,
	[usrid] [char](10) NOT NULL,
 CONSTRAINT [PK_sales_gh_1] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[sales_hd]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[sales_hd](
	[slcenter] [char](2) NOT NULL,
	[branch] [char](2) NOT NULL,
	[company] [char](2) NOT NULL,
	[invtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[invdate] [char](8) NOT NULL,
	[custno] [char](6) NOT NULL,
	[custnm] [varchar](50) NOT NULL,
	[glser] [char](19) NOT NULL,
	[dsctype] [char](1) NOT NULL,
	[pstmode] [numeric](1, 0) NOT NULL,
	[fcy] [char](3) NOT NULL,
	[fcyrate] [numeric](6, 3) NOT NULL,
	[duedate] [char](8) NOT NULL,
	[invttl] [float] NOT NULL,
	[invcst] [float] NOT NULL,
	[invdspc] [float] NOT NULL,
	[invdsvl] [float] NOT NULL,
	[valafds] [float] NOT NULL,
	[invpaid] [float] NULL,
	[caser] [char](19) NOT NULL,
	[entries] [numeric](6, 0) NULL,
	[released] [bit] NOT NULL,
	[posted] [bit] NOT NULL,
	[fixrate] [numeric](6, 3) NOT NULL,
	[extamt] [float] NULL,
	[extser] [char](19) NOT NULL,
	[pricetp] [char](1) NOT NULL,
	[ischeque] [bit] NOT NULL,
	[chkno] [char](8) NOT NULL,
	[chkdate] [char](8) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[jvgenrt] [bit] NOT NULL,
	[cccommsn] [float] NOT NULL,
	[belowbal] [bit] NOT NULL,
	[fcy2] [char](3) NOT NULL,
	[ccpayment] [float] NULL,
	[rplsamt] [float] NULL,
	[pdother] [bit] NOT NULL,
	[slcode] [char](2) NOT NULL,
	[prpaidamt] [float] NULL,
	[instldays] [numeric](2, 0) NOT NULL,
	[instflag] [bit] NOT NULL,
	[slcmnd] [bit] NOT NULL,
	[inv_printed] [numeric](2, 0) NOT NULL,
	[bendit] [bit] NOT NULL,
	[modified] [bit] NOT NULL,
	[rqstorder] [numeric](6, 0) NOT NULL,
	[rqststld] [bit] NOT NULL,
	[carrier] [char](3) NOT NULL,
	[rcvdtrn] [bit] NOT NULL,
	[usrid] [char](10) NOT NULL,
	[address] [varchar](50) NOT NULL,
	[suspend] [bit] NOT NULL,
	[rtnref] [numeric](6, 0) NOT NULL,
	[ispurchase] [bit] NOT NULL,
	[stkjvno] [numeric](6, 0) NOT NULL,
	[posinv] [numeric](1, 0) NULL,
	[sanedcrd_amt] [numeric](12, 2) NULL,
	[remarks] [char](1) NULL,
	[remarks2] [char](40) NULL,
	[invlocked] [bit] NULL,
	[rtncash_dfrpl] [numeric](12, 2) NULL,
	[vat_amt_rcvd] [float] NULL,
	[taxfree_sales] [float] NULL,
	[clnt_taxcode] [varchar](20) NULL,
	[clnt_kind] [char](1) NULL,
	[hlldscnt] [float] NULL,
	[sysno] [numeric](2, 0) NULL,
	[No_round_nm] [bit] NULL,
	[PriceVatType] [numeric](1, 0) NULL,
	[smssent] [bit] NULL,
	[stcpay_amt] [float] NULL,
	[fc2lcamt] [float] NULL,
	[qitaf_amt] [float] NULL,
	[whlslinv] [bit] NULL,
	[vat_percent] [numeric](5, 2) NULL,
	[fsh_printed] [numeric](2, 0) NULL,
	[fqtyval] [float] NULL,
	[datetime_stamp] [datetime] NULL,
	[discountedBill] [bit] NULL,
	[Fusrprintinv] [varchar](10) NULL,
	[almnm_contract_section] [numeric](1, 0) NULL,
	[instlmnt_code] [numeric](3, 0) NULL,
	[installment_amt] [float] NULL,
	[mobileNo] [varchar](20) NULL,
	[client_name] [varchar](40) NULL,
	[cashpaid] [float] NULL,
	[zatca_rounding] [bit] NULL,
	[multi_refund_inv] [bit] NULL,
	[refund_no_inv_avl] [bit] NULL,
 CONSTRAINT [PK_sales_hd_1] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[invtype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[sales_od]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[sales_od](
	[slcenter] [char](2) NOT NULL,
	[invtype] [char](2) NOT NULL,
	[company] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[invdate] [char](8) NOT NULL,
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[qty] [float] NULL,
	[fqty] [numeric](10, 3) NOT NULL,
	[price] [float] NULL,
	[discpc] [numeric](6, 2) NOT NULL,
	[cost] [float] NOT NULL,
	[ds_acfm] [numeric](1, 0) NOT NULL,
	[sl_acfm] [numeric](1, 0) NOT NULL,
	[gclass] [char](8) NOT NULL,
	[custno] [char](6) NOT NULL,
	[fcy] [char](3) NOT NULL,
	[barcode] [char](20) NOT NULL,
	[imfcval] [float] NOT NULL,
	[pack] [char](1) NOT NULL,
	[pkqty] [numeric](8, 3) NOT NULL,
	[lstrcvdate] [char](8) NOT NULL,
	[fqtyrcv] [numeric](12, 3) NOT NULL,
	[qtyrcv] [numeric](12, 3) NOT NULL,
	[porder] [numeric](6, 0) NOT NULL,
	[shadd] [char](1) NOT NULL,
	[shdpk] [numeric](8, 3) NOT NULL,
	[shdqty] [numeric](12, 3) NOT NULL,
	[frtqty] [numeric](12, 3) NOT NULL,
	[cmbkey] [char](24) NULL,
	[whno] [char](2) NULL,
	[folio] [int] NULL,
	[taxtype] [char](1) NULL,
	[item_vat] [numeric](12, 3) NULL,
	[item_price_net] [float] NULL,
	[item_fq_vat] [numeric](12, 3) NULL,
	[invdscamt] [float] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[sales_oh]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[sales_oh](
	[slcenter] [char](2) NOT NULL,
	[branch] [char](2) NOT NULL,
	[invtype] [char](2) NOT NULL,
	[company] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[invdate] [char](8) NOT NULL,
	[custno] [char](6) NOT NULL,
	[custnm] [varchar](50) NOT NULL,
	[glser] [char](19) NOT NULL,
	[dsctype] [char](1) NOT NULL,
	[pstmode] [numeric](1, 0) NOT NULL,
	[fcy] [char](3) NOT NULL,
	[fcyrate] [numeric](7, 2) NOT NULL,
	[duedate] [char](8) NOT NULL,
	[invttl] [float] NOT NULL,
	[invcst] [float] NOT NULL,
	[invdspc] [float] NOT NULL,
	[invdsvl] [float] NOT NULL,
	[valafds] [float] NOT NULL,
	[invpaid] [numeric](14, 2) NOT NULL,
	[caser] [char](19) NOT NULL,
	[entries] [numeric](5, 0) NOT NULL,
	[released] [bit] NOT NULL,
	[posted] [bit] NOT NULL,
	[fixrate] [numeric](7, 2) NOT NULL,
	[extamt] [numeric](14, 2) NOT NULL,
	[extser] [char](19) NOT NULL,
	[pricetp] [char](1) NOT NULL,
	[ischeque] [bit] NOT NULL,
	[chkno] [char](8) NOT NULL,
	[chkdate] [char](8) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[jvgenrt] [bit] NOT NULL,
	[imfcval] [numeric](14, 5) NOT NULL,
	[slcode] [char](2) NOT NULL,
	[rqstorder] [char](10) NOT NULL,
	[rcvdate] [char](8) NOT NULL,
	[lstrcvdate] [char](8) NOT NULL,
	[ordclosed] [bit] NOT NULL,
	[cstordrno] [char](16) NOT NULL,
	[isorder] [bit] NOT NULL,
	[rcvdtrn] [bit] NOT NULL,
	[puorder] [numeric](6, 0) NOT NULL,
	[carrier] [char](3) NULL,
	[vat_amt_rcvd] [float] NULL,
	[taxfree_sales] [float] NULL,
	[clnt_taxcode] [varchar](20) NULL,
	[clnt_kind] [char](1) NULL,
	[wh_rsvqty] [bit] NULL,
	[zatca_rounding] [bit] NULL,
	[vat_percent] [numeric](5, 2) NULL,
	[pricevattype] [numeric](1, 0) NULL,
 CONSTRAINT [PK_sales_oh_1] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[sales_qd]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[sales_qd](
	[slcenter] [char](2) NOT NULL,
	[invtype] [char](2) NOT NULL,
	[company] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[invdate] [char](8) NOT NULL,
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[itemdesc] [char](30) NOT NULL,
	[qty] [float] NULL,
	[fqty] [numeric](10, 3) NOT NULL,
	[price] [float] NULL,
	[discpc] [numeric](6, 2) NOT NULL,
	[cost] [float] NOT NULL,
	[ds_acfm] [numeric](1, 0) NOT NULL,
	[sl_acfm] [numeric](1, 0) NOT NULL,
	[gclass] [char](8) NOT NULL,
	[custno] [char](6) NOT NULL,
	[fcy] [char](3) NOT NULL,
	[barcode] [char](20) NOT NULL,
	[imfcval] [float] NOT NULL,
	[pack] [char](1) NOT NULL,
	[pkqty] [numeric](9, 3) NOT NULL,
	[shadd] [char](1) NULL,
	[shdpk] [numeric](9, 3) NOT NULL,
	[shdqty] [numeric](14, 3) NOT NULL,
	[frtqty] [numeric](12, 3) NOT NULL,
	[cmbkey] [char](24) NULL,
	[folio] [numeric](4, 0) NULL,
	[whno] [char](2) NULL,
	[item_Quoted] [bit] NULL,
	[dsc_amt] [float] NULL,
	[item_vat] [numeric](12, 3) NULL,
	[item_price_net] [float] NULL,
	[item_fq_vat] [numeric](12, 3) NULL,
	[invdscamt] [float] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[sales_qh]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[sales_qh](
	[slcenter] [char](2) NOT NULL,
	[branch] [char](2) NOT NULL,
	[invtype] [char](2) NOT NULL,
	[company] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[invdate] [char](8) NOT NULL,
	[custno] [char](6) NOT NULL,
	[custnm] [varchar](50) NOT NULL,
	[glser] [char](19) NOT NULL,
	[dsctype] [char](1) NOT NULL,
	[pstmode] [numeric](1, 0) NOT NULL,
	[fcy] [char](3) NOT NULL,
	[fcyrate] [numeric](7, 2) NOT NULL,
	[duedate] [char](8) NOT NULL,
	[invttl] [float] NOT NULL,
	[invcst] [float] NOT NULL,
	[invdspc] [float] NOT NULL,
	[invdsvl] [float] NOT NULL,
	[valafds] [float] NOT NULL,
	[invpaid] [numeric](14, 2) NOT NULL,
	[caser] [char](19) NOT NULL,
	[entries] [numeric](5, 0) NOT NULL,
	[released] [bit] NOT NULL,
	[posted] [bit] NOT NULL,
	[fixrate] [numeric](7, 2) NOT NULL,
	[extamt] [float] NOT NULL,
	[extser] [char](19) NOT NULL,
	[pricetp] [char](1) NOT NULL,
	[ischeque] [bit] NOT NULL,
	[chkno] [char](8) NOT NULL,
	[chkdate] [char](8) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[jvgenrt] [bit] NOT NULL,
	[imfcval] [numeric](14, 5) NOT NULL,
	[slcode] [char](2) NOT NULL,
	[modified] [bit] NOT NULL,
	[rcvdtrn] [bit] NOT NULL,
	[remarks] [varchar](65) NULL,
	[remarks2] [varchar](65) NULL,
	[usrid] [char](10) NULL,
	[vat_amt_rcvd] [float] NULL,
	[taxfree_sales] [float] NULL,
	[clnt_taxcode] [varchar](20) NULL,
	[clnt_kind] [char](1) NULL,
	[qhtype] [char](1) NULL,
	[qhstatus] [char](1) NULL,
	[newcstmrname] [varchar](50) NULL,
	[newcstmrcntct] [varchar](50) NULL,
	[cstmrmobile] [varchar](50) NULL,
	[fqtyval] [float] NULL,
	[zatca_rounding] [bit] NULL,
	[vat_percent] [numeric](5, 2) NULL,
	[pricevattype] [numeric](1, 0) NULL,
 CONSTRAINT [PK_sales_qh] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[salesmen]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[salesmen](
	[slcompany] [char](2) NOT NULL,
	[slcode] [char](2) NOT NULL,
	[slshort] [char](10) NOT NULL,
	[slname] [varchar](40) NOT NULL,
	[slcomm] [numeric](4, 2) NOT NULL,
	[clcomm] [numeric](4, 2) NOT NULL,
	[sltarget] [numeric](12, 2) NOT NULL,
	[cltarget] [numeric](12, 2) NOT NULL,
	[salesman] [bit] NOT NULL,
	[collector] [bit] NOT NULL,
	[sltype] [numeric](1, 0) NOT NULL,
	[lstcomm] [char](8) NOT NULL,
	[modified] [bit] NOT NULL,
	[sllname] [varchar](40) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[purshman] [bit] NOT NULL,
	[notify_type] [int] NULL,
	[notify_within] [int] NULL,
	[slemail] [varchar](60) NULL,
	[slmobile] [varchar](20) NULL,
	[usrid] [char](10) NULL,
	[slscmnact] [char](19) NULL,
	[crdt_limit] [float] NULL,
	[sl_center] [char](2) NULL,
 CONSTRAINT [PK_salesmen] PRIMARY KEY CLUSTERED 
(
	[slcompany] ASC,
	[slcode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[sdaad_dt]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[sdaad_dt](
	[company] [char](2) NULL,
	[sdtype] [char](2) NULL,
	[refno] [numeric](6, 0) NULL,
	[sdsubscrbno] [char](20) NULL,
	[sdamount] [float] NULL,
	[sdlastpaid] [char](8) NULL,
	[sdlastamt] [float] NULL,
	[sdtext] [varchar](70) NULL,
	[sdtcode] [char](3) NULL,
	[folio] [int] NULL,
	[vat_amt_paid] [float] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[sdaad_hd]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[sdaad_hd](
	[company] [char](2) NOT NULL,
	[sdtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[sdtext] [varchar](70) NULL,
	[sdtcode] [char](3) NULL,
	[caser] [char](19) NULL,
	[sddate] [char](8) NULL,
	[sdamount] [float] NULL,
	[released] [bit] NULL,
	[posted] [bit] NULL,
	[lastupdt] [char](8) NULL,
	[usrid] [char](10) NULL,
	[sdttlamt] [float] NULL,
	[rcvdtrn] [bit] NULL,
	[sdentries] [numeric](4, 0) NULL,
	[Vat_Percent] [numeric](5, 2) NULL,
	[sdttlvatamt] [float] NULL,
	[vat_included] [bit] NULL,
	[sdNoVat] [bit] NULL,
 CONSTRAINT [PK_sdaad_hd] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[sdtype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[sddtl]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[sddtl](
	[dt_company] [char](2) NOT NULL,
	[dt_type] [char](2) NOT NULL,
	[dt_ref] [numeric](6, 0) NOT NULL,
	[dt_date] [char](8) NOT NULL,
	[dt_lcamt] [float] NOT NULL,
	[dt_paidamt] [float] NOT NULL,
	[dt_discamt] [float] NOT NULL,
	[dt_cucode] [char](6) NOT NULL,
	[dt_fcy] [char](3) NOT NULL,
	[dt_trxsrc] [char](2) NOT NULL,
	[dt_fcamt] [float] NOT NULL,
	[dt_fpydamt] [float] NOT NULL,
	[dt_fdscamt] [float] NOT NULL,
	[dt_lcaloc] [float] NOT NULL,
	[dt_fcaloc] [float] NOT NULL,
	[dt_aloctd] [char](1) NOT NULL,
	[dt_pdinv] [numeric](6, 0) NOT NULL,
	[dt_duedate] [char](8) NOT NULL,
	[dt_desc] [varchar](70) NOT NULL,
	[dt_chkno] [char](8) NOT NULL,
	[dt_chkdate] [char](8) NOT NULL,
	[dt_chkbnk] [char](2) NOT NULL,
	[dt_dbcr] [char](1) NOT NULL,
	[dt_ackey] [char](19) NOT NULL,
	[dt_folio] [numeric](4, 0) NOT NULL,
	[dt_rcvno] [numeric](6, 0) NOT NULL,
	[dt_lstdate] [char](8) NOT NULL,
	[tdscdays] [numeric](2, 0) NOT NULL,
	[tdscpcs] [numeric](4, 2) NOT NULL,
	[match] [bit] NOT NULL,
	[rplct_post] [bit] NULL,
	[rowguid] [uniqueidentifier] ROWGUIDCOL  NOT NULL,
	[dt_sucode] [char](6) NULL,
	[cstcode] [char](4) NULL,
	[taxcatId] [numeric](3, 0) NULL,
	[jdcstval] [float] NULL,
	[cstkey] [char](22) NULL,
	[vndr_taxcode] [varchar](20) NULL,
	[vndr_name] [varchar](50) NULL,
	[no_chng_col] [bit] NULL,
	[amtincldvat] [bit] NULL,
 CONSTRAINT [PK_sddtl] PRIMARY KEY CLUSTERED 
(
	[dt_company] ASC,
	[dt_type] ASC,
	[dt_ref] ASC,
	[dt_folio] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[sdhdr]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[sdhdr](
	[hd_company] [char](2) NOT NULL,
	[hd_type] [char](2) NOT NULL,
	[hd_ref] [numeric](6, 0) NOT NULL,
	[hd_date] [char](8) NOT NULL,
	[hd_fcy] [char](3) NOT NULL,
	[hd_ftotal] [float] NOT NULL,
	[hd_fcyrate] [numeric](9, 6) NULL,
	[hd_ltotal] [float] NOT NULL,
	[hd_cucode] [char](6) NOT NULL,
	[hd_desc1] [varchar](70) NOT NULL,
	[hd_ser] [char](19) NOT NULL,
	[hd_rlsd] [bit] NOT NULL,
	[hd_posted] [bit] NOT NULL,
	[hd_trxsrc] [char](2) NOT NULL,
	[hd_sysdate] [char](8) NOT NULL,
	[hd_lcnet] [float] NOT NULL,
	[hd_fcnet] [float] NOT NULL,
	[hd_lccnet] [float] NOT NULL,
	[hd_fccnet] [float] NOT NULL,
	[isit_opst] [bit] NOT NULL,
	[opst_val] [float] NOT NULL,
	[opst_fcy] [char](3) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[modified] [bit] NOT NULL,
	[rcvdtrn] [bit] NOT NULL,
	[usrid] [char](10) NOT NULL,
	[clcode] [char](2) NOT NULL,
	[clcmnd] [bit] NOT NULL,
	[dscamt] [float] NOT NULL,
	[payinv] [bit] NOT NULL,
	[rowguid] [uniqueidentifier] ROWGUIDCOL  NOT NULL,
	[Vat_Percent] [numeric](5, 2) NULL,
	[serial_no] [int] NULL,
	[brxfrm] [char](2) NULL,
	[caser] [char](19) NULL,
	[ctype] [numeric](1, 0) NULL,
	[datetime_stamp] [datetime] NULL,
	[clnt_kind] [char](1) NULL,
	[hide_jv] [bit] NULL,
 CONSTRAINT [PK_sdhdr] PRIMARY KEY CLUSTERED 
(
	[hd_company] ASC,
	[hd_type] ASC,
	[hd_ref] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[sdsubscriber_dt]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[sdsubscriber_dt](
	[sdcompany] [char](2) NOT NULL,
	[sdsubscrbNo] [char](20) NOT NULL,
	[sdtcode] [char](3) NOT NULL,
	[sdmaxamt] [numeric](12, 3) NULL,
	[sddfltamt] [numeric](12, 3) NULL,
	[sdexpglacc] [char](19) NULL,
	[sdinactive] [bit] NULL,
 CONSTRAINT [PK_sdsubscriber_dt_1] PRIMARY KEY CLUSTERED 
(
	[sdcompany] ASC,
	[sdsubscrbNo] ASC,
	[sdtcode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[sdsubscribers]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[sdsubscribers](
	[sdcompany] [char](2) NOT NULL,
	[sdsubscrbNo] [char](20) NOT NULL,
	[sdname] [varchar](50) NULL,
	[sdsubscrbNo2] [char](20) NULL,
	[sdsubname] [varchar](50) NULL,
	[sdsubaddress] [varchar](50) NULL,
	[sdinactive] [bit] NULL,
	[lastupdt] [char](8) NULL,
	[sdcstcode] [char](4) NULL,
	[sdsubtype] [char](2) NOT NULL,
 CONSTRAINT [PK_sdsubscribers_1] PRIMARY KEY CLUSTERED 
(
	[sdcompany] ASC,
	[sdsubscrbNo] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[sdtype]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[sdtype](
	[sdtcode] [char](3) NOT NULL,
	[sdtname] [varchar](35) NULL,
	[sdtlname] [varchar](30) NULL,
	[lastupdt] [char](8) NULL,
	[sdsubtype] [char](2) NULL,
	[sdNoVat] [bit] NULL,
 CONSTRAINT [PK_sdtype] PRIMARY KEY CLUSTERED 
(
	[sdtcode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[slalmnmglassdtls]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[slalmnmglassdtls](
	[company] [char](2) NOT NULL,
	[invtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[contract_second_party] [varchar](150) NULL,
	[contract_hdr] [varchar](250) NULL,
	[section_1_1] [varchar](40) NULL,
	[section_1_2] [varchar](40) NULL,
	[section_1_3] [varchar](40) NULL,
	[section_1_4] [varchar](40) NULL,
	[section_1_5] [varchar](40) NULL,
	[section_1_6] [varchar](40) NULL,
	[section_1_type_1] [varchar](40) NULL,
	[section_1_type_2] [varchar](40) NULL,
	[section_1_type_3] [varchar](40) NULL,
	[section_1_type_4] [varchar](40) NULL,
	[section_1_type_5] [varchar](40) NULL,
	[section_1_type_6] [varchar](40) NULL,
	[section_1_producer] [varchar](40) NULL,
	[section_1_alum_color_1] [varchar](30) NULL,
	[section_1_alum_color_2] [varchar](30) NULL,
	[section_1_alum_color_3] [varchar](30) NULL,
	[section_1_alum_color_4] [varchar](30) NULL,
	[section_1_alum_color_5] [varchar](30) NULL,
	[section_1_alum_color_6] [varchar](30) NULL,
	[section_1_glass_color_1] [varchar](30) NULL,
	[section_1_glass_color_2] [varchar](30) NULL,
	[section_1_glass_color_3] [varchar](30) NULL,
	[section_1_glass_color_4] [varchar](30) NULL,
	[section_1_glass_color_5] [varchar](30) NULL,
	[section_1_glass_color_6] [varchar](30) NULL,
	[section_1_Cladding_Network] [varchar](40) NULL,
	[section_1_other_details] [varchar](250) NULL,
	[section_1_silicon] [varchar](40) NULL,
	[section_1_fliparm] [varchar](40) NULL,
	[section_1_handles] [varchar](40) NULL,
	[section_1_hinges] [varchar](40) NULL,
	[section_1_tires] [varchar](40) NULL,
	[section_1_rubber] [varchar](40) NULL,
	[section_1_mosquito_mesh] [varchar](40) NULL,
	[section_1_foam] [varchar](40) NULL,
	[section_1_angles] [varchar](40) NULL,
	[section_1_assembly_screws] [varchar](40) NULL,
	[section_1_wall_screws] [varchar](40) NULL,
	[section_2_1] [varchar](40) NULL,
	[section_2_2] [varchar](40) NULL,
	[section_2_3] [varchar](40) NULL,
	[section_2_4] [varchar](40) NULL,
	[section_2_5] [varchar](40) NULL,
	[section_2_6] [varchar](40) NULL,
	[section_2_producer] [varchar](40) NULL,
	[section_2_alum_color_1] [varchar](30) NULL,
	[section_2_alum_color_2] [varchar](30) NULL,
	[section_2_alum_color_3] [varchar](30) NULL,
	[section_2_alum_color_4] [varchar](30) NULL,
	[section_2_alum_color_5] [varchar](30) NULL,
	[section_2_alum_color_6] [varchar](30) NULL,
	[section_2_sliding_Panel] [varchar](40) NULL,
	[section_2_other_details] [varchar](250) NULL,
	[section_2_kelon] [varchar](40) NULL,
	[section_2_silicon] [varchar](40) NULL,
	[section_2_handles] [varchar](40) NULL,
	[section_2_hinges] [varchar](40) NULL,
	[section_2_rubber] [varchar](40) NULL,
	[section_2_assembly_screws] [varchar](40) NULL,
	[section_2_wall_screws] [varchar](40) NULL,
	[section_2_Panel_Handles] [varchar](40) NULL,
	[section_2_angles] [varchar](40) NULL,
	[section_2_fliparm] [varchar](40) NULL,
	[contract_structure_desc] [varchar](250) NULL,
	[contract_structure_type] [varchar](150) NULL,
	[contract_work_period] [varchar](100) NULL,
	[contract_waranty] [varchar](250) NULL,
	[contract_payment] [varchar](250) NULL,
 CONSTRAINT [PK_slalmnmglassdtls] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[invtype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[slccpayment]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[slccpayment](
	[company] [char](2) NOT NULL,
	[invtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[cccardno] [varchar](50) NULL,
	[ccsrlno] [int] NULL,
	[cardtype] [tinyint] NULL,
	[ccpaid] [numeric](12, 3) NULL,
	[ccconus] [bit] NULL,
	[chargepctg] [float] NULL,
	[chargeamt] [float] NULL,
	[cctype] [varchar](10) NULL,
	[approvl_no] [varchar](10) NULL,
	[TransDate] [varchar](10) NULL,
	[TransTime] [varchar](10) NULL,
	[TransNo] [varchar](12) NULL,
	[terminal_id] [varchar](16) NULL,
	[src] [char](2) NULL,
	[bkactcode] [char](5) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[slclass]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[slclass](
	[company] [char](2) NOT NULL,
	[name] [char](20) NOT NULL,
	[cmbkey] [char](12) NOT NULL,
	[mgroup] [char](2) NOT NULL,
	[sgroup] [char](2) NOT NULL,
	[category] [char](2) NOT NULL,
	[sercsh] [char](19) NOT NULL,
	[sercrd] [char](19) NOT NULL,
	[serrch] [char](19) NOT NULL,
	[serrcr] [char](19) NOT NULL,
	[serdsc] [char](19) NOT NULL,
	[serpcsh] [char](19) NOT NULL,
	[serpcrd] [char](19) NOT NULL,
	[serprch] [char](19) NOT NULL,
	[serprcr] [char](19) NOT NULL,
	[serpdsc] [char](19) NOT NULL,
	[sgroup3] [char](3) NOT NULL,
	[sgroup4] [char](3) NOT NULL,
	[modified] [bit] NOT NULL,
	[cstcode] [char](4) NOT NULL,
	[lname] [char](20) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[srslcst] [char](19) NOT NULL,
 CONSTRAINT [PK_slclass] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[cmbkey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[slfcypay]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[slfcypay](
	[company] [char](2) NOT NULL,
	[invtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[fcy] [char](3) NOT NULL,
	[fcamt] [float] NOT NULL,
	[fcyrate] [numeric](10, 5) NOT NULL,
	[lcamt] [float] NULL,
	[srlno] [numeric](2, 0) NOT NULL,
	[fixrate] [numeric](10, 5) NULL,
 CONSTRAINT [PK_slfcypay] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[invtype] ASC,
	[refno] ASC,
	[srlno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[slglsscc]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[slglsscc](
	[cccode] [tinyint] NOT NULL,
	[ccname] [varchar](50) NULL,
	[cclname] [varchar](50) NULL,
	[chrgprcnt] [numeric](9, 5) NULL,
	[ccmada] [bit] NULL,
	[ccconus] [bit] NULL,
	[ccinactive] [bit] NULL,
	[lastupdt] [char](8) NULL,
	[is_tax_applied] [bit] NULL,
 CONSTRAINT [PK_credit_cards] PRIMARY KEY CLUSTERED 
(
	[cccode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[slglssgrade]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[slglssgrade](
	[company] [char](2) NOT NULL,
	[invtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[Drsp] [varchar](10) NULL,
	[Drcl] [varchar](10) NULL,
	[Drax] [varchar](10) NULL,
	[dipd] [varchar](10) NULL,
	[dlsp] [varchar](10) NULL,
	[dlcl] [varchar](10) NULL,
	[dlax] [varchar](10) NULL,
	[xadd] [varchar](10) NULL,
	[nrsp] [varchar](10) NULL,
	[nrcl] [varchar](10) NULL,
	[nrax] [varchar](10) NULL,
	[nipd] [varchar](10) NULL,
	[nlsp] [varchar](10) NULL,
	[nlcl] [varchar](10) NULL,
	[nlax] [varchar](10) NULL,
	[lrsp] [varchar](10) NULL,
	[lrcl] [varchar](10) NULL,
	[lrax] [varchar](10) NULL,
	[clenstype] [varchar](30) NULL,
	[llsp] [varchar](10) NULL,
	[llcl] [varchar](10) NULL,
	[llax] [varchar](10) NULL,
	[bc] [varchar](10) NULL,
	[dia] [varchar](10) NULL,
	[mobile] [varchar](20) NULL,
	[clnt_id] [varchar](20) NULL,
	[lastupdt] [char](8) NULL,
 CONSTRAINT [PK_slglssgrade] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[invtype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[slinvexp]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[slinvexp](
	[company] [char](2) NOT NULL,
	[invtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[fcy] [char](3) NULL,
	[transportOnUs] [bit] NULL,
	[transportamt] [float] NULL,
	[transport_vat] [float] NULL,
	[slsmanprcnt] [numeric](5, 3) NULL,
	[slsmanamt] [float] NULL,
	[broker_code] [int] NULL,
	[broker_amt] [numeric](10, 3) NULL,
	[broker_prcnt] [numeric](5, 3) NULL,
	[broker_vat_amt] [float] NULL,
	[broker_taxable] [bit] NULL,
	[broker_ttlcmsn] [float] NULL,
	[broker_cmnamt] [float] NULL,
	[trans_code] [char](3) NULL,
	[pricewithtransport] [bit] NULL,
	[clnt_cntrct_no] [int] NULL,
	[driver_no] [int] NULL,
	[driver_cntrct_no] [int] NULL,
	[driver_expnseamt] [float] NULL,
	[truck_no] [varchar](30) NULL,
	[trans_expnse] [float] NULL,
	[trans_cntrct_no] [int] NULL,
	[trans_cost_per_pack] [float] NULL,
	[from_whno] [char](2) NULL,
	[trans_pack] [char](1) NULL,
	[is_vat] [bit] NULL,
 CONSTRAINT [PK_slinvexp] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[invtype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[slktchndtls]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[slktchndtls](
	[company] [char](2) NOT NULL,
	[invtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[k_dscrptn] [varchar](40) NULL,
	[k_type] [varchar](40) NULL,
	[marble] [varchar](40) NULL,
	[m_flange] [varchar](40) NULL,
	[m_line] [varchar](40) NULL,
	[m_surface] [varchar](40) NULL,
	[aluminium_color] [varchar](40) NULL,
	[formica] [varchar](40) NULL,
	[sheet] [varchar](40) NULL,
	[leaf] [varchar](40) NULL,
	[entry_color] [varchar](40) NULL,
	[handles] [varchar](40) NULL,
	[hinges] [varchar](40) NULL,
	[shelves] [varchar](40) NULL,
	[other_details] [varchar](250) NULL,
	[dlvry_days] [numeric](3, 0) NULL,
	[contract_second_party] [varchar](150) NULL,
	[contract_hdr] [varchar](250) NULL,
	[contract_work_period] [varchar](100) NULL,
	[contract_waranty] [varchar](250) NULL,
	[contract_payment] [varchar](250) NULL,
 CONSTRAINT [PK_slktchndtls] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[invtype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[sllinedtls]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[sllinedtls](
	[company] [char](2) NOT NULL,
	[invtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[folio] [int] NOT NULL,
	[txtnote] [varchar](60) NULL,
 CONSTRAINT [PK_sllinedtls] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[invtype] ASC,
	[refno] ASC,
	[folio] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[slpaytype]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[slpaytype](
	[company] [char](2) NOT NULL,
	[invtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[iscode] [char](2) NULL,
	[isr_card_no] [varchar](20) NULL,
	[aprvdamt] [float] NULL,
	[cln_amt] [float] NULL,
	[cln_extra_amt] [float] NULL,
	[isr_dsc40] [float] NULL,
	[isr_dscextra25] [float] NULL,
	[isr_crdtamt] [float] NULL,
	[rmnamt] [float] NULL,
	[policyno] [varchar](20) NULL,
	[providercode] [varchar](20) NULL,
	[aprovedno] [varchar](20) NULL,
	[expdate] [char](8) NULL,
	[subcompname] [varchar](50) NULL,
	[Comp_pay_full] [bit] NULL,
 CONSTRAINT [PK_bkpaytype] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[invtype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[slpu_unused_inv]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[slpu_unused_inv](
	[company] [char](2) NOT NULL,
	[invtype] [char](2) NOT NULL,
	[refno] [int] NOT NULL,
	[sc_code] [char](6) NULL,
	[is_used] [bit] NULL,
	[usrid] [varchar](10) NULL,
	[invdate] [smalldatetime] NULL,
	[reasons] [numeric](1, 0) NULL,
	[lastupdate] [smalldatetime] NULL,
 CONSTRAINT [PK_SlPu_unused_inv] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[invtype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[slpuorder_od]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[slpuorder_od](
	[company] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[porder] [numeric](6, 0) NOT NULL,
	[qty] [numeric](13, 3) NOT NULL,
 CONSTRAINT [PK_slpuorder_od] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[refno] ASC,
	[itemno] ASC,
	[unicode] ASC,
	[porder] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[slqktchndtls]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[slqktchndtls](
	[company] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[k_dscrptn] [varchar](40) NULL,
	[k_type] [varchar](40) NULL,
	[marble] [varchar](40) NULL,
	[m_flange] [varchar](40) NULL,
	[m_line] [varchar](40) NULL,
	[m_surface] [varchar](40) NULL,
	[aluminium_color] [varchar](40) NULL,
	[formica] [varchar](40) NULL,
	[sheet] [varchar](40) NULL,
	[leaf] [varchar](40) NULL,
	[entry_color] [varchar](40) NULL,
	[handles] [varchar](40) NULL,
	[hinges] [varchar](40) NULL,
	[shelves] [varchar](40) NULL,
	[other_details] [varchar](250) NULL,
	[dlvry_days] [numeric](3, 0) NULL,
 CONSTRAINT [PK_slqktchndtls] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[slqlinedtls]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[slqlinedtls](
	[company] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[folio] [int] NOT NULL,
	[txtnote] [varchar](60) NULL,
 CONSTRAINT [PK_slqlinedtls] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[refno] ASC,
	[folio] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[slservicecodes]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[slservicecodes](
	[company] [char](2) NULL,
	[invtype] [char](2) NULL,
	[refno] [numeric](6, 0) NULL,
	[srvcecode] [varchar](15) NULL,
	[folio] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[sltrans]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[sltrans](
	[code] [char](3) NOT NULL,
	[cname] [varchar](40) NOT NULL,
	[pname] [varchar](30) NULL,
	[address] [varchar](50) NULL,
	[tel] [char](10) NULL,
	[fax] [char](10) NULL,
	[mobile] [char](10) NULL,
	[modified] [bit] NULL,
	[lcname] [varchar](40) NULL,
	[lpname] [varchar](30) NULL,
	[lastupdt] [char](8) NULL,
	[laddress] [varchar](50) NULL,
	[pricePerUnit] [numeric](10, 2) NULL,
	[tprtexpact] [char](19) NULL,
	[is_vat] [bit] NULL,
 CONSTRAINT [PK_sltrans] PRIMARY KEY CLUSTERED 
(
	[code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[slvchrimage]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[slvchrimage](
	[company] [char](2) NOT NULL,
	[invtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[vchrpicture] [varchar](70) NULL,
	[voucherNo] [char](20) NULL,
	[No_of_cartons] [int] NULL,
	[pricePerUnit] [numeric](10, 2) NULL,
	[carrierNo] [char](3) NULL,
	[DriverName] [varchar](30) NULL,
	[mobileNo] [char](20) NULL,
	[delivaryDate] [char](8) NULL,
	[rcvdDate] [char](8) NULL,
	[rcvd_person] [varchar](30) NULL,
	[Pstatus] [char](1) NULL,
	[notes] [text] NULL,
	[src] [char](2) NULL,
	[vdate] [char](8) NULL,
	[usrid] [char](10) NULL,
	[confirmed] [bit] NULL,
	[rtnref] [numeric](6, 0) NULL,
 CONSTRAINT [PK_slvchrimage] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[invtype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
/****** Object:  Table [dbo].[slverifyinv]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[slverifyinv](
	[company] [char](2) NOT NULL,
	[invtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[lastsendcode] [int] NULL,
	[receivedcode] [int] NULL,
	[verifystatus] [numeric](1, 0) NULL,
	[lastinvamt] [float] NULL,
	[modified_inv] [bit] NULL,
	[lastrcvddate] [char](8) NULL,
	[lastsenddate] [char](8) NULL,
	[NoOfSends] [numeric](3, 0) NULL,
	[sndusrid] [char](10) NULL,
	[rcvusrid] [char](10) NULL,
 CONSTRAINT [PK_slverifyinv] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[invtype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[st_slsord_dtl]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[st_slsord_dtl](
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[branch] [char](2) NOT NULL,
	[trtype] [char](2) NULL,
	[qty] [float] NOT NULL,
	[fqty] [numeric](11, 3) NULL,
	[whno] [char](2) NOT NULL,
	[binno] [char](6) NOT NULL,
	[lcost] [float] NULL,
	[trdate] [char](8) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[src] [char](2) NOT NULL,
	[fcost] [float] NULL,
	[expdate] [char](8) NULL,
	[towhno] [char](2) NULL,
	[tobinno] [char](6) NULL,
	[barcode] [char](20) NOT NULL,
	[cmbkey] [char](24) NOT NULL,
	[pack] [char](1) NULL,
	[folio] [numeric](7, 0) NOT NULL,
 CONSTRAINT [PK_st_slsord_dtl] PRIMARY KEY CLUSTERED 
(
	[branch] ASC,
	[refno] ASC,
	[folio] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[starea]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[starea](
	[name] [char](20) NOT NULL,
	[cmbkey] [char](6) NOT NULL,
	[govrn] [char](2) NOT NULL,
	[city] [char](2) NOT NULL,
	[region] [char](2) NOT NULL,
	[modified] [bit] NOT NULL,
	[lname] [char](20) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[pkey] [int] NOT NULL,
	[chkey] [int] NOT NULL,
 CONSTRAINT [PK_starea] PRIMARY KEY CLUSTERED 
(
	[cmbkey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stasmbld]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stasmbld](
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[asmitemno] [char](16) NOT NULL,
	[asmunicode] [char](6) NOT NULL,
	[cmbkey] [char](24) NOT NULL,
	[qtyneeded] [numeric](8, 3) NOT NULL,
 CONSTRAINT [PK_stasmbld] PRIMARY KEY CLUSTERED 
(
	[itemno] ASC,
	[unicode] ASC,
	[asmitemno] ASC,
	[asmunicode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stattrbname]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stattrbname](
	[atn_id] [char](2) NOT NULL,
	[atn_name] [varchar](15) NULL,
	[atn_lname] [varchar](15) NULL,
	[atn_type] [numeric](1, 0) NULL,
	[lastupdt] [char](8) NULL,
 CONSTRAINT [PK_orattrbname] PRIMARY KEY CLUSTERED 
(
	[atn_id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stbins]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stbins](
	[branch] [char](2) NOT NULL,
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[whno] [char](2) NOT NULL,
	[binno] [char](6) NOT NULL,
	[qty] [float] NULL,
	[rsvqty] [float] NULL,
	[openbal] [float] NULL,
	[lcost] [float] NOT NULL,
	[fcost] [float] NOT NULL,
	[openlcost] [float] NOT NULL,
	[openfcost] [float] NOT NULL,
	[expdate] [char](8) NOT NULL,
 CONSTRAINT [PK_stbins_1] PRIMARY KEY CLUSTERED 
(
	[branch] ASC,
	[itemno] ASC,
	[unicode] ASC,
	[whno] ASC,
	[binno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stbranch]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stbranch](
	[name] [varchar](40) NOT NULL,
	[brnno] [char](2) NOT NULL,
	[govrn] [char](2) NULL,
	[city] [char](2) NULL,
	[area] [char](2) NULL,
	[cmbkey] [char](6) NULL,
	[company] [char](2) NULL,
	[cashser] [char](19) NULL,
	[modified] [bit] NULL,
	[bcserial] [numeric](13, 0) NULL,
	[jv_01] [numeric](6, 0) NULL,
	[jv_02] [numeric](6, 0) NULL,
	[jv_03] [numeric](6, 0) NULL,
	[jv_04] [numeric](6, 0) NULL,
	[jv_05] [numeric](6, 0) NULL,
	[jv_06] [numeric](6, 0) NULL,
	[jv_07] [numeric](6, 0) NULL,
	[jv_08] [numeric](6, 0) NULL,
	[jv_09] [numeric](6, 0) NULL,
	[jv_10] [numeric](6, 0) NULL,
	[jv_11] [numeric](6, 0) NULL,
	[jv_12] [numeric](6, 0) NULL,
	[jv_13] [numeric](6, 0) NULL,
	[jv_14] [numeric](6, 0) NULL,
	[jv_18] [numeric](6, 0) NULL,
	[jv_19] [numeric](6, 0) NULL,
	[jv_20] [numeric](6, 0) NULL,
	[jv_21] [numeric](6, 0) NULL,
	[jv_22] [numeric](6, 0) NULL,
	[jv_23] [numeric](6, 0) NULL,
	[jv_24] [numeric](6, 0) NULL,
	[jv_26] [numeric](6, 0) NULL,
	[jv_27] [numeric](6, 0) NULL,
	[jv_28] [numeric](6, 0) NULL,
	[jv_30] [numeric](6, 0) NULL,
	[jv_31] [numeric](6, 0) NULL,
	[jv_32] [numeric](6, 0) NULL,
	[jv_33] [numeric](6, 0) NULL,
	[jv_34] [numeric](8, 0) NULL,
	[calgl] [numeric](2, 0) NULL,
	[calar] [numeric](2, 0) NULL,
	[calap] [numeric](2, 0) NULL,
	[calst] [numeric](2, 0) NULL,
	[srdiff] [char](19) NULL,
	[lname] [varchar](30) NULL,
	[lastupdt] [char](8) NULL,
	[jv_45] [numeric](10, 0) NULL,
	[stkxtoser] [char](19) NULL,
	[stkxfmser] [char](19) NULL,
	[baddress] [varchar](60) NULL,
	[lbaddress] [char](10) NULL,
	[phone] [varchar](40) NULL,
	[fax] [char](20) NULL,
	[jv_17] [numeric](6, 0) NULL,
	[jv_16] [numeric](6, 0) NULL,
	[jv_46] [numeric](6, 0) NULL,
	[dscalwser] [char](19) NULL,
	[dscernser] [char](19) NULL,
	[jv_101] [int] NULL,
	[manualser] [bit] NULL,
	[smsdispname] [char](11) NULL,
	[smsuser] [int] NULL,
	[smsfooter] [char](40) NULL,
	[rebate_act] [char](19) NULL,
	[fm_price1] [numeric](6, 0) NULL,
	[to_price1] [numeric](6, 0) NULL,
	[doz_price1] [numeric](6, 0) NULL,
	[ctn_price1] [numeric](6, 0) NULL,
	[fm_price2] [numeric](6, 0) NULL,
	[to_price2] [numeric](6, 0) NULL,
	[doz_price2] [numeric](6, 0) NULL,
	[ctn_price2] [numeric](6, 0) NULL,
	[fm_price3] [numeric](6, 0) NULL,
	[to_price3] [numeric](6, 0) NULL,
	[doz_price3] [numeric](6, 0) NULL,
	[ctn_price3] [numeric](6, 0) NULL,
	[pricetp] [char](1) NULL,
	[rebate_loss] [char](19) NULL,
	[sysno] [numeric](2, 0) NULL,
	[No_round_nm] [bit] NULL,
	[PriceVatType] [numeric](1, 0) NULL,
	[mkt_frc_rounding] [bit] NULL,
	[is_dsc_amt] [bit] NULL,
	[auto_dsc_hll] [bit] NULL,
	[max_dsc_hll] [numeric](3, 2) NULL,
	[pos_type] [int] NULL,
	[jv_51] [int] NULL,
	[sc_lvlno] [int] NULL,
	[vat_paid_act] [char](19) NULL,
	[jv_105] [int] NULL,
	[jv_106] [int] NULL,
	[jv_107] [int] NULL,
	[jv_108] [int] NULL,
	[jv_109] [int] NULL,
	[jv_110] [int] NULL,
	[Jv_37] [int] NULL,
	[jv_55] [numeric](10, 0) NULL,
	[jv_56] [numeric](6, 0) NULL,
	[JV_60] [int] NULL,
	[JV_61] [int] NULL,
	[district] [varchar](50) NULL,
	[district_l] [varchar](50) NULL,
	[city_text] [varchar](50) NULL,
	[city_text_l] [varchar](50) NULL,
	[postal_code] [varchar](20) NULL,
	[bldg_no] [varchar](50) NULL,
	[bldg_no_l] [varchar](50) NULL,
	[street_name] [varchar](50) NULL,
	[street_name_l] [varchar](50) NULL,
	[area_name] [varchar](50) NULL,
	[area_name_l] [varchar](50) NULL,
	[extra_address_no] [varchar](50) NULL,
	[extra_address_no_l] [varchar](50) NULL,
	[crdt_limit] [float] NULL,
	[Street_Name2] [varchar](50) NULL,
	[Street_Name2_l] [varchar](50) NULL,
	[Group_VAT_ID] [varchar](30) NULL,
	[Other_id_SchemeID] [varchar](20) NULL,
	[country_code] [int] NULL,
	[Other_Scheme_Type] [varchar](10) NULL,
	[vat_rcvd_act] [char](19) NULL,
	[remote_br_sqlserver] [varchar](45) NULL,
	[rvnuact] [varchar](19) NULL,
	[jv_301] [int] NULL,
	[jv_205] [int] NULL,
	[jv_209] [int] NULL,
	[jv_210] [int] NULL,
	[jv_211] [int] NULL,
	[jv_212] [int] NULL,
	[jv_213] [int] NULL,
	[jv_214] [int] NULL,
	[jv_215] [int] NULL,
	[jv_216] [int] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stbrand]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stbrand](
	[brand_id] [numeric](4, 0) NOT NULL,
	[name] [char](15) NOT NULL,
	[lname] [char](15) NOT NULL,
 CONSTRAINT [PK_stbrand] PRIMARY KEY CLUSTERED 
(
	[brand_id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stbrprice]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stbrprice](
	[company] [char](2) NOT NULL,
	[slcenter] [char](2) NOT NULL,
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[lprice1] [numeric](11, 2) NOT NULL,
	[lprice2] [numeric](11, 2) NOT NULL,
	[lprice3] [numeric](11, 2) NOT NULL,
	[maxdisc1] [numeric](4, 2) NOT NULL,
	[maxdisc2] [numeric](4, 2) NOT NULL,
	[maxdisc3] [numeric](4, 2) NOT NULL,
	[mnmprice] [numeric](11, 2) NOT NULL,
	[pprice1] [numeric](11, 2) NOT NULL,
	[pprice2] [numeric](11, 2) NULL,
	[pprice3] [numeric](11, 2) NULL,
	[modelno] [char](16) NULL,
	[promotion] [bit] NOT NULL,
	[prm_start] [char](20) NULL,
	[prm_end] [char](20) NULL,
	[slsprsnt] [numeric](9, 2) NULL,
	[fprice1] [numeric](11, 2) NULL,
	[fprice2] [numeric](11, 2) NULL,
	[fprice3] [numeric](11, 2) NULL,
	[modified] [bit] NOT NULL,
	[lastupdt] [char](8) NULL,
 CONSTRAINT [PK_stbrprice_1] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[slcenter] ASC,
	[itemno] ASC,
	[unicode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stclass]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stclass](
	[name] [char](20) NOT NULL,
	[cmbkey] [char](12) NOT NULL,
	[mgroup] [char](2) NOT NULL,
	[sgroup] [char](2) NOT NULL,
	[category] [char](2) NOT NULL,
	[sercsh] [char](19) NOT NULL,
	[sercrd] [char](19) NOT NULL,
	[serrch] [char](19) NOT NULL,
	[serrcr] [char](19) NOT NULL,
	[serdsc] [char](19) NOT NULL,
	[serpcsh] [char](19) NOT NULL,
	[serpcrd] [char](19) NOT NULL,
	[serprch] [char](19) NOT NULL,
	[serprcr] [char](19) NOT NULL,
	[serpdsc] [char](19) NOT NULL,
	[sgroup3] [char](3) NOT NULL,
	[sgroup4] [char](3) NOT NULL,
	[modified] [bit] NOT NULL,
	[pkey] [int] NOT NULL,
	[chkey] [int] NOT NULL,
	[lname] [char](20) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[max_sl_limit] [numeric](12, 3) NULL,
 CONSTRAINT [PK_stclass] PRIMARY KEY CLUSTERED 
(
	[cmbkey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stcommission]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stcommission](
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[commtype] [numeric](1, 0) NOT NULL,
	[commission] [numeric](9, 3) NOT NULL,
	[cmntarget] [numeric](12, 3) NOT NULL,
	[InActive] [bit] NOT NULL,
	[cmsn_onQty] [bit] NOT NULL,
	[cmsn_calctype] [numeric](1, 0) NULL,
	[cmsn_perqty] [float] NULL,
	[cmsn_payval] [float] NULL,
	[cmsn_remarks] [varchar](40) NULL,
 CONSTRAINT [PK_stcommission] PRIMARY KEY CLUSTERED 
(
	[itemno] ASC,
	[unicode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stcosttype]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stcosttype](
	[branch] [char](2) NOT NULL,
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[lastlcost] [float] NULL,
	[highlcost] [float] NULL,
	[lowlcost] [float] NULL,
	[lstrcvdate] [char](8) NULL,
	[lastfcost] [float] NULL,
	[frstrcvdate] [char](8) NULL,
	[frstrcvd01] [char](8) NULL,
	[lastrcvd01] [char](8) NULL,
	[lastlcost01] [float] NULL,
	[frstlcost01] [float] NULL,
	[pufrstlcost] [float] NULL,
	[brlastissue] [char](8) NULL,
 CONSTRAINT [PK_stcosttype_1] PRIMARY KEY CLUSTERED 
(
	[branch] ASC,
	[itemno] ASC,
	[unicode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stcrtpuinv]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stcrtpuinv](
	[branch] [char](2) NOT NULL,
	[splycode] [char](19) NOT NULL,
	[fcy] [char](3) NOT NULL,
	[splyinv] [char](20) NOT NULL,
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[dbxyr] [char](2) NULL,
	[idate] [char](8) NULL,
	[lastupdt] [char](8) NULL,
	[rplct_post] [bit] NULL,
	[slcode] [char](2) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stdtl]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stdtl](
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[branch] [char](2) NOT NULL,
	[trtype] [char](2) NOT NULL,
	[qty] [float] NULL,
	[fqty] [numeric](11, 3) NOT NULL,
	[whno] [char](2) NOT NULL,
	[binno] [char](6) NOT NULL,
	[lcost] [float] NOT NULL,
	[trdate] [char](8) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[sysdate] [char](8) NOT NULL,
	[src] [char](2) NOT NULL,
	[lprice] [float] NOT NULL,
	[fcost] [float] NULL,
	[fprice] [float] NULL,
	[expdate] [char](8) NULL,
	[towhno] [char](2) NULL,
	[tobinno] [char](6) NULL,
	[barcode] [char](20) NOT NULL,
	[cmbkey] [char](24) NOT NULL,
	[discpc] [numeric](6, 2) NULL,
	[pack] [char](1) NULL,
	[shdpk] [numeric](10, 3) NULL,
	[shdqty] [float] NULL,
	[folio] [numeric](7, 0) NOT NULL,
	[rplct_post] [bit] NULL,
	[q_frt] [numeric](7, 0) NULL,
 CONSTRAINT [PK_stdtl] PRIMARY KEY CLUSTERED 
(
	[branch] ASC,
	[trtype] ASC,
	[refno] ASC,
	[folio] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stfcyprice]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stfcyprice](
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[fcyprice1] [float] NULL,
	[fcyprice2] [float] NULL,
	[fcyprice3] [float] NULL,
	[fcymnmprice] [float] NULL,
 CONSTRAINT [PK_stfcyprice] PRIMARY KEY CLUSTERED 
(
	[itemno] ASC,
	[unicode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[sthdr]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[sthdr](
	[branch] [char](2) NOT NULL,
	[trtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[trdate] [char](8) NOT NULL,
	[description] [varchar](70) NULL,
	[amnttl] [float] NOT NULL,
	[costttl] [float] NOT NULL,
	[sysdate] [char](8) NULL,
	[src] [char](2) NOT NULL,
	[released] [bit] NOT NULL,
	[posted] [bit] NOT NULL,
	[fcy] [char](3) NOT NULL,
	[fcyrate] [float] NULL,
	[whno] [char](2) NOT NULL,
	[entries] [numeric](6, 0) NULL,
	[lastupdt] [char](8) NULL,
	[towhno] [char](2) NULL,
	[modified] [bit] NOT NULL,
	[rcvdtrn] [bit] NULL,
	[custno] [char](19) NULL,
	[usrid] [char](10) NOT NULL,
	[brsupp] [char](19) NULL,
	[tobrno] [char](2) NULL,
	[brxref] [numeric](6, 0) NULL,
	[glref] [numeric](6, 0) NULL,
	[isbrtrx] [bit] NULL,
	[asmtype] [numeric](1, 0) NULL,
	[repost] [bit] NULL,
	[items_rcvd] [bit] NULL,
	[trx_printed] [numeric](2, 0) NULL,
	[pricetp] [char](1) NULL,
	[Damaged] [bit] NULL,
 CONSTRAINT [PK_sthdr] PRIMARY KEY CLUSTERED 
(
	[branch] ASC,
	[trtype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stitem_mae]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stitem_mae](
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[splyordno] [char](20) NULL,
	[ordqty] [numeric](14, 3) NULL,
	[ordprice] [float] NULL,
	[ordrdlvry] [char](8) NULL,
	[colors] [varchar](70) NULL,
	[sizes] [varchar](70) NULL,
	[min_slqty] [numeric](14, 3) NULL,
 CONSTRAINT [PK_stitem_mae] PRIMARY KEY CLUSTERED 
(
	[itemno] ASC,
	[unicode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stitembc]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stitembc](
	[pbarcode] [char](20) NOT NULL,
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NULL,
	[cmbkey] [char](24) NOT NULL,
	[pack] [char](10) NOT NULL,
	[pkqty] [numeric](10, 3) NOT NULL,
	[lprice1] [float] NULL,
	[weight] [numeric](12, 3) NULL,
	[mnmprice] [numeric](11, 2) NULL,
	[itext] [varchar](30) NULL,
	[litext] [varchar](15) NULL,
	[pkorder] [numeric](2, 0) NULL,
	[lastrcvd] [char](8) NULL,
	[lprice2] [float] NULL,
 CONSTRAINT [PK_stitembc] PRIMARY KEY CLUSTERED 
(
	[pbarcode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stitembc_brprice]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stitembc_brprice](
	[branch] [char](2) NOT NULL,
	[pbarcode] [char](20) NOT NULL,
	[cmbkey] [char](24) NOT NULL,
	[lprice1] [numeric](11, 2) NULL,
	[mnmprice] [numeric](11, 2) NULL,
	[lprice2] [numeric](11, 2) NULL,
 CONSTRAINT [PK_stitembc_brprice] PRIMARY KEY CLUSTERED 
(
	[branch] ASC,
	[pbarcode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stitemnqati]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stitemnqati](
	[cmbkey] [char](24) NOT NULL,
	[nqati_prcnt] [numeric](2, 0) NULL,
	[dsc_prcnt] [numeric](2, 0) NULL,
	[lastupdt] [char](8) NULL,
 CONSTRAINT [PK_stitemnqati] PRIMARY KEY CLUSTERED 
(
	[cmbkey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stitempictures]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stitempictures](
	[cmbkey] [char](24) NOT NULL,
	[picture_order] [int] NOT NULL,
	[picture_name] [varchar](200) NULL,
	[default_picture] [bit] NULL,
	[item_image] [image] NULL,
 CONSTRAINT [PK_stitempictures_1] PRIMARY KEY CLUSTERED 
(
	[cmbkey] ASC,
	[picture_order] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stitemrp]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stitemrp](
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[rplitemno] [char](16) NULL,
	[rplunicode] [char](6) NULL,
	[cmbkey] [char](24) NULL,
	[rplorder] [numeric](2, 0) NULL,
	[lastupdt] [date] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stitems]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stitems](
	[name] [varchar](45) NOT NULL,
	[itemno] [char](16) NOT NULL,
	[mgroup] [char](2) NOT NULL,
	[sgroup] [char](2) NOT NULL,
	[category] [char](2) NOT NULL,
	[fcy] [char](3) NOT NULL,
	[classkey] [char](12) NOT NULL,
	[exdatealw] [bit] NOT NULL,
	[noofsbitem] [int] NOT NULL,
	[modified] [bit] NOT NULL,
	[sgroup3] [char](3) NOT NULL,
	[sgroup4] [char](3) NOT NULL,
	[company] [char](2) NOT NULL,
	[lname] [varchar](40) NOT NULL,
	[country] [numeric](3, 0) NOT NULL,
	[season] [char](1) NOT NULL,
	[splycode] [char](19) NOT NULL,
	[splylcact] [bit] NOT NULL,
	[itemtype] [char](1) NOT NULL,
	[prntasmitm] [bit] NOT NULL,
	[prmdesc] [char](8) NOT NULL,
	[scndesc] [char](8) NOT NULL,
	[cmpprcnt] [bit] NOT NULL,
	[dsctype] [char](1) NOT NULL,
	[brand_id] [numeric](4, 0) NOT NULL,
	[msplycode] [char](6) NOT NULL,
	[modelno] [char](16) NULL,
	[nosales] [bit] NULL,
	[vprice] [numeric](13, 2) NULL,
	[fix_barcode] [bit] NULL,
	[taxtype] [char](1) NULL,
	[taxfree] [bit] NULL,
 CONSTRAINT [PK_stitems] PRIMARY KEY CLUSTERED 
(
	[itemno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stitmphoto]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stitmphoto](
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[remarks] [varchar](250) NULL,
	[ipicture] [varchar](80) NULL,
	[ord_qty] [float] NULL,
	[mnimumdt] [char](8) NULL,
	[cust_pctg] [float] NULL,
	[is_double_width] [bit] NULL,
	[is_price_per_length] [bit] NULL,
	[is_accessory_stk_item] [bit] NULL,
	[dsc_amt1] [float] NULL,
	[dsc_amt2] [float] NULL,
	[dsc_amt3] [float] NULL,
	[usrid] [varchar](10) NULL,
	[usrid_lstchg] [varchar](10) NULL,
	[exemption_reason_code] [varchar](20) NULL,
	[onlinesales] [bit] NULL,
	[extra_tax_p] [numeric](6, 2) NULL,
	[startdate] [char](8) NULL,
	[enddate] [char](8) NULL,
 CONSTRAINT [PK_stitmphoto] PRIMARY KEY CLUSTERED 
(
	[itemno] ASC,
	[unicode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stitmsply]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stitmsply](
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[branch] [char](2) NOT NULL,
	[splycode] [char](19) NOT NULL,
	[fcy] [char](3) NOT NULL,
	[splylcact] [bit] NULL,
	[msplycode] [char](6) NULL,
	[lrcvdate] [char](8) NULL,
	[lastlcost] [float] NULL,
	[lastfcost] [float] NULL,
	[splyitemno] [varchar](20) NULL,
	[lastupdt] [char](8) NULL,
 CONSTRAINT [PK_stitmsply] PRIMARY KEY CLUSTERED 
(
	[branch] ASC,
	[itemno] ASC,
	[unicode] ASC,
	[splycode] ASC,
	[fcy] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stoffer_grp_dt]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stoffer_grp_dt](
	[grp_no] [int] NOT NULL,
	[barcode] [varchar](20) NOT NULL,
	[dstrb_percent] [numeric](6, 2) NULL,
	[minqty] [numeric](10, 3) NULL,
 CONSTRAINT [PK_stoffer_grp_dt] PRIMARY KEY CLUSTERED 
(
	[grp_no] ASC,
	[barcode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stoffer_grp_hd]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stoffer_grp_hd](
	[grp_no] [int] NOT NULL,
	[grp_name] [varchar](50) NULL,
	[grp_lname] [varchar](50) NULL,
	[grp_entries] [int] NULL,
	[amt_dstrbut_type] [char](1) NULL,
	[grp_inactive] [bit] NULL,
	[Added_date] [char](8) NULL,
	[lastupdt] [char](8) NULL,
	[usrid] [varchar](10) NULL,
	[usridchg] [varchar](10) NULL,
	[grp_flexable] [bit] NULL,
 CONSTRAINT [PK_stoffer_grp_hd] PRIMARY KEY CLUSTERED 
(
	[grp_no] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stoffers]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stoffers](
	[company] [char](2) NOT NULL,
	[slcenter] [char](2) NOT NULL,
	[itemno] [char](16) NULL,
	[unicode] [char](6) NULL,
	[barcode] [char](20) NOT NULL,
	[DiscountP] [numeric](5, 2) NULL,
	[disctype] [char](1) NULL,
	[MinQty] [numeric](10, 3) NULL,
	[GivenAmt] [float] NULL,
	[StartDate] [date] NULL,
	[EndDate] [date] NULL,
	[InActive] [bit] NULL,
	[lastupdt] [char](8) NULL,
	[Max2buy] [int] NULL,
	[lprice1] [float] NULL,
	[itemgroup] [char](1) NULL,
	[cmbkey] [char](24) NULL,
	[qty_offer_sold] [numeric](13, 3) NULL,
	[offer_no] [int] NOT NULL,
 CONSTRAINT [PK_stoffers] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[slcenter] ASC,
	[barcode] ASC,
	[offer_no] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stoffers_dt]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stoffers_dt](
	[company] [char](2) NOT NULL,
	[slcenter] [char](2) NOT NULL,
	[ms_barcode] [char](20) NOT NULL,
	[barcode] [char](20) NOT NULL,
	[price] [float] NULL,
	[givenqty] [float] NULL,
	[offer_no] [int] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stoffers_main]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stoffers_main](
	[company] [char](2) NOT NULL,
	[slcenter] [char](2) NOT NULL,
	[offer_no] [int] NOT NULL,
	[offer_date] [char](8) NULL,
	[offer_desc] [varchar](70) NULL,
	[disctype] [char](1) NULL,
	[itemgroup] [char](1) NULL,
	[StartDate] [date] NULL,
	[EndDate] [date] NULL,
	[StartTime] [time](7) NULL,
	[EndTime] [time](7) NULL,
	[InActive] [bit] NULL,
	[lastupdt] [char](8) NULL,
	[added_date] [char](8) NULL,
	[usrid] [varchar](50) NULL,
	[usridchg] [varchar](50) NULL,
	[grp_no] [int] NULL,
	[grp_givenamt] [float] NULL,
	[grp_min_qty] [int] NULL,
	[entries] [int] NULL,
	[pricetp] [char](1) NULL,
	[offer_expired] [bit] NULL,
	[dstrbute_type] [char](1) NULL,
 CONSTRAINT [PK_stoffers_main] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[slcenter] ASC,
	[offer_no] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stoffers_tmp]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stoffers_tmp](
	[company] [char](2) NOT NULL,
	[slcenter] [char](2) NOT NULL,
	[itemno] [char](16) NULL,
	[unicode] [char](6) NULL,
	[barcode] [char](20) NOT NULL,
	[DiscountP] [numeric](5, 2) NULL,
	[disctype] [char](1) NULL,
	[MinQty] [numeric](10, 3) NULL,
	[GivenAmt] [float] NULL,
	[StartDate] [date] NULL,
	[EndDate] [date] NULL,
	[InActive] [bit] NULL,
	[lastupdt] [char](8) NULL,
	[Max2buy] [int] NULL,
	[lprice1] [float] NULL,
	[itemgroup] [char](1) NULL,
	[cmbkey] [char](24) NULL,
	[qty_offer_sold] [numeric](13, 3) NULL,
	[offer_no] [int] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stprice]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stprice](
	[name] [char](15) NOT NULL,
	[code] [char](1) NOT NULL,
	[disc] [char](8) NULL,
	[lprice] [char](8) NULL,
	[fprice] [char](8) NULL,
	[minsal] [numeric](9, 2) NULL,
	[maxsal] [numeric](9, 2) NULL,
	[modified] [bit] NULL,
	[lname] [char](15) NULL,
	[lastupdt] [char](8) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stPriceByQty]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stPriceByQty](
	[barcode] [char](20) NOT NULL,
	[serial_no] [int] NOT NULL,
	[fmqty] [numeric](12, 3) NULL,
	[toqty] [numeric](12, 3) NULL,
	[slcprice] [float] NULL,
	[lastupdt] [char](8) NULL,
	[itemno] [char](16) NULL,
	[unicode] [char](6) NULL,
	[cat_price_type] [numeric](1, 0) NULL,
 CONSTRAINT [PK_stPriceByQty] PRIMARY KEY CLUSTERED 
(
	[barcode] ASC,
	[serial_no] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stprmattrb]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stprmattrb](
	[atn_id] [char](2) NULL,
	[pat_id] [char](3) NOT NULL,
	[pat_name] [varchar](15) NULL,
	[pat_lname] [varchar](15) NULL,
	[lastupdt] [char](8) NULL,
 CONSTRAINT [PK_stprmattrb] PRIMARY KEY CLUSTERED 
(
	[pat_id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stqtybc]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stqtybc](
	[barcode] [char](20) NOT NULL,
	[cmbkey] [char](24) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
 CONSTRAINT [PK_stqtybc_1] PRIMARY KEY CLUSTERED 
(
	[barcode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[streorderQP]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[streorderQP](
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[reorderQ] [numeric](12, 3) NULL,
	[lastupdt] [char](8) NULL,
	[reorderD] [numeric](3, 0) NULL,
	[reorderP] [numeric](6, 2) NULL,
 CONSTRAINT [PK_streorderQP] PRIMARY KEY CLUSTERED 
(
	[itemno] ASC,
	[unicode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stscnattrb]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stscnattrb](
	[atn_id] [char](2) NULL,
	[sat_id] [char](3) NOT NULL,
	[sat_name] [varchar](15) NULL,
	[sat_lname] [varchar](15) NULL,
	[lastupdt] [char](8) NULL,
 CONSTRAINT [PK_stscnattrb] PRIMARY KEY CLUSTERED 
(
	[sat_id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stunits]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stunits](
	[name] [char](8) NOT NULL,
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[moved] [bit] NOT NULL,
	[openlcost] [float] NOT NULL,
	[lcost] [float] NOT NULL,
	[lprice1] [numeric](11, 2) NOT NULL,
	[fprice1] [numeric](11, 2) NOT NULL,
	[maxdisc1] [numeric](4, 2) NOT NULL,
	[lprice2] [float] NULL,
	[fprice2] [numeric](11, 2) NOT NULL,
	[maxdisc2] [numeric](4, 2) NOT NULL,
	[lprice3] [numeric](11, 2) NOT NULL,
	[fprice3] [numeric](11, 2) NOT NULL,
	[maxdisc3] [numeric](4, 2) NOT NULL,
	[openfcost] [float] NOT NULL,
	[fcost] [float] NOT NULL,
	[lrcvdate] [char](8) NOT NULL,
	[lastissue] [char](8) NOT NULL,
	[openbal] [float] NULL,
	[curbal] [float] NULL,
	[rsvqty] [float] NULL,
	[minstk] [numeric](11, 3) NOT NULL,
	[maxstk] [numeric](11, 3) NOT NULL,
	[orderlevel] [numeric](11, 2) NOT NULL,
	[leadday] [numeric](3, 0) NOT NULL,
	[Xdecimal] [bit] NOT NULL,
	[barcode] [char](20) NOT NULL,
	[pack1] [char](1) NOT NULL,
	[pkqty1] [numeric](10, 3) NOT NULL,
	[pack2] [char](1) NOT NULL,
	[pkqty2] [numeric](10, 3) NOT NULL,
	[pack3] [char](1) NOT NULL,
	[pkqty3] [numeric](8, 3) NOT NULL,
	[company] [char](2) NOT NULL,
	[modified] [bit] NOT NULL,
	[pack0] [char](1) NOT NULL,
	[packtp] [char](1) NOT NULL,
	[scnname] [char](8) NOT NULL,
	[crtdate] [char](8) NOT NULL,
	[inactive] [bit] NOT NULL,
	[prmcode] [char](3) NOT NULL,
	[scncode] [char](3) NOT NULL,
	[cmbkey] [char](24) NOT NULL,
	[mnmprice] [numeric](11, 2) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[modelno] [char](16) NOT NULL,
	[splyitemno] [varchar](20) NULL,
	[splyinv] [varchar](20) NULL,
	[invprice] [float] NULL,
	[invqty] [numeric](10, 3) NULL,
	[invpk] [char](1) NULL,
	[pp2] [numeric](6, 2) NULL,
	[pp3] [numeric](6, 2) NULL,
 CONSTRAINT [PK_stunits_1] PRIMARY KEY CLUSTERED 
(
	[itemno] ASC,
	[unicode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stwhous]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stwhous](
	[name] [char](20) NOT NULL,
	[whno] [char](2) NOT NULL,
	[branch] [char](2) NOT NULL,
	[manager] [varchar](30) NOT NULL,
	[phone] [char](9) NOT NULL,
	[address] [varchar](30) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[srwhs] [char](19) NOT NULL,
	[modified] [bit] NOT NULL,
	[lname] [char](20) NOT NULL,
	[fax] [char](20) NOT NULL,
	[prnt_fsh] [bit] NULL,
	[ac_end_prd] [char](19) NULL,
	[cstcode] [char](4) NULL,
	[no_autosales] [bit] NULL,
	[sc_code] [char](6) NULL,
	[suspended] [bit] NULL,
	[binsrlno] [char](6) NULL,
	[xfrfm_mustbinnno] [bit] NULL,
	[xfrto_mustbinnno] [bit] NULL,
 CONSTRAINT [PK_stwhous] PRIMARY KEY CLUSTERED 
(
	[whno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stwhracks]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stwhracks](
	[branch] [char](2) NOT NULL,
	[whno] [char](2) NOT NULL,
	[rk_zoneid] [char](2) NOT NULL,
	[rk_id] [char](2) NOT NULL,
	[rk_name] [varchar](40) NULL,
	[rk_lname] [varchar](40) NULL,
	[rk_height] [numeric](10, 2) NULL,
	[rk_width] [numeric](10, 2) NULL,
	[rk_length] [numeric](10, 2) NULL,
	[lastupdt] [char](8) NULL,
	[rk_autocreate] [bit] NULL,
	[rk_bincounts] [numeric](2, 0) NULL,
	[rk_binbegin] [numeric](2, 0) NULL,
	[rk_equalbins] [bit] NULL,
	[bn_height] [numeric](10, 2) NULL,
	[bn_width] [numeric](10, 2) NULL,
	[bn_length] [numeric](10, 2) NULL,
	[bn_direction] [char](4) NULL,
 CONSTRAINT [PK_stwhracks] PRIMARY KEY CLUSTERED 
(
	[branch] ASC,
	[whno] ASC,
	[rk_zoneid] ASC,
	[rk_id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stwhzones]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stwhzones](
	[branch] [char](2) NOT NULL,
	[whno] [char](2) NOT NULL,
	[zn_id] [char](2) NOT NULL,
	[zn_name] [varchar](40) NULL,
	[zn_lname] [varchar](40) NULL,
	[zn_nobinused] [bit] NULL,
	[lastupdt] [char](8) NULL,
	[zn_autocreate] [bit] NULL,
	[zn_rackcounts] [numeric](2, 0) NULL,
	[zn_rackbegin] [numeric](2, 0) NULL,
	[zn_equalracks] [bit] NULL,
	[zn_height] [numeric](10, 2) NULL,
	[zn_width] [numeric](10, 2) NULL,
	[zn_length] [numeric](10, 2) NULL,
 CONSTRAINT [PK_orzones_1] PRIMARY KEY CLUSTERED 
(
	[branch] ASC,
	[whno] ASC,
	[zn_id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stwmaloc_dt]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stwmaloc_dt](
	[branch] [char](2) NOT NULL,
	[alctype] [char](2) NOT NULL,
	[alcref] [int] NOT NULL,
	[cn_id] [char](20) NOT NULL,
	[alc_location] [char](12) NULL,
	[whno] [char](2) NULL,
	[alc_zoneid] [char](2) NULL,
	[alc_rackid] [char](2) NULL,
	[alc_binno] [char](2) NULL,
	[alc_direction] [char](4) NULL,
	[folio] [int] NULL,
	[xwhno] [char](2) NULL,
 CONSTRAINT [PK_stwmaloc_dt] PRIMARY KEY CLUSTERED 
(
	[branch] ASC,
	[alctype] ASC,
	[alcref] ASC,
	[cn_id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stwmaloc_hd]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stwmaloc_hd](
	[branch] [char](2) NOT NULL,
	[alctype] [char](2) NOT NULL,
	[alcref] [int] NOT NULL,
	[multiloctn] [bit] NULL,
	[whno] [char](2) NOT NULL,
	[alcdate] [char](8) NULL,
	[alctext] [varchar](70) NULL,
	[alc_location] [char](12) NULL,
	[lastupdt] [char](8) NULL,
	[entries] [int] NULL,
	[usrid] [varchar](10) NULL,
	[posted] [bit] NULL,
	[brreturned] [bit] NULL,
 CONSTRAINT [PK_stwmaloc_hd] PRIMARY KEY CLUSTERED 
(
	[branch] ASC,
	[alctype] ASC,
	[alcref] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stwmcntnr_dt]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stwmcntnr_dt](
	[cn_id] [char](20) NOT NULL,
	[barcode] [char](20) NOT NULL,
	[cmbkey] [char](24) NULL,
	[qty] [numeric](12, 3) NULL,
	[pack] [char](1) NULL,
	[pkqty] [numeric](10, 3) NULL,
	[itemno] [char](16) NULL,
	[unicode] [char](6) NULL,
	[folio] [int] NULL,
 CONSTRAINT [PK_stcontainer_dt] PRIMARY KEY CLUSTERED 
(
	[cn_id] ASC,
	[barcode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stwmcntnr_hd]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stwmcntnr_hd](
	[cn_id] [char](20) NOT NULL,
	[branch] [char](2) NULL,
	[whno] [char](2) NULL,
	[cn_zoneid] [char](2) NULL,
	[cn_rackid] [char](2) NULL,
	[cn_binno] [char](2) NULL,
	[cn_direction] [char](4) NULL,
	[cn_item_count] [int] NULL,
	[cn_location] [char](12) NULL,
	[cn_status] [char](1) NULL,
	[cn_crtdate] [char](8) NULL,
	[lastupdt] [char](8) NULL,
	[pu_order] [varchar](20) NULL,
	[usrid] [varchar](10) NULL,
	[cn_length] [numeric](9, 3) NULL,
	[cn_width] [numeric](9, 3) NULL,
	[cn_height] [numeric](9, 3) NULL,
	[cn_ttlqty] [numeric](13, 3) NULL,
 CONSTRAINT [PK_stcontainer_hd] PRIMARY KEY CLUSTERED 
(
	[cn_id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stwmcntnrtrx_dt]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stwmcntnrtrx_dt](
	[branch] [char](2) NOT NULL,
	[refno] [int] NOT NULL,
	[barcode] [char](20) NOT NULL,
	[cmbkey] [char](24) NULL,
	[cn_id] [char](20) NOT NULL,
	[to_cn_id] [char](20) NOT NULL,
	[qty] [numeric](13, 3) NULL,
	[itemno] [char](16) NULL,
	[unicode] [char](6) NULL,
	[folio] [int] NULL,
	[rtn_cnstatus] [char](1) NULL,
 CONSTRAINT [PK_stwmcntnrtrx_dt] PRIMARY KEY CLUSTERED 
(
	[branch] ASC,
	[refno] ASC,
	[barcode] ASC,
	[cn_id] ASC,
	[to_cn_id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stwmcntnrtrx_hd]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stwmcntnrtrx_hd](
	[branch] [char](2) NOT NULL,
	[refno] [int] NOT NULL,
	[trtype] [char](2) NULL,
	[grn_code] [varchar](20) NULL,
	[trdate] [char](8) NULL,
	[usrid] [varchar](10) NULL,
	[entries] [int] NULL,
	[posted] [bit] NULL,
	[lastupdt] [char](8) NULL,
	[ttlqty] [numeric](12, 3) NULL,
	[trxtext] [varchar](50) NULL,
 CONSTRAINT [PK_stwmcntnrtrx_hd] PRIMARY KEY CLUSTERED 
(
	[branch] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stwmtrx_dt]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stwmtrx_dt](
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[branch] [char](2) NOT NULL,
	[trtype] [char](2) NOT NULL,
	[qty] [float] NULL,
	[fqty] [numeric](11, 3) NOT NULL,
	[whno] [char](2) NOT NULL,
	[binno] [char](6) NOT NULL,
	[lcost] [float] NOT NULL,
	[trdate] [char](8) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[sysdate] [char](8) NOT NULL,
	[src] [char](2) NOT NULL,
	[lprice] [float] NOT NULL,
	[fcost] [float] NULL,
	[fprice] [numeric](11, 2) NULL,
	[expdate] [char](8) NULL,
	[towhno] [char](2) NULL,
	[tobinno] [char](6) NULL,
	[barcode] [char](20) NOT NULL,
	[cmbkey] [char](24) NOT NULL,
	[discpc] [numeric](6, 2) NULL,
	[pack] [char](1) NULL,
	[shdpk] [numeric](8, 3) NULL,
	[shdqty] [numeric](14, 3) NULL,
	[folio] [numeric](7, 0) NOT NULL,
	[rplct_post] [bit] NULL,
 CONSTRAINT [PK_stwmtrx_dt] PRIMARY KEY CLUSTERED 
(
	[branch] ASC,
	[trtype] ASC,
	[refno] ASC,
	[folio] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[stwmtrx_hd]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[stwmtrx_hd](
	[branch] [char](2) NOT NULL,
	[trtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[trdate] [char](8) NOT NULL,
	[description] [varchar](40) NOT NULL,
	[amnttl] [float] NOT NULL,
	[costttl] [float] NOT NULL,
	[sysdate] [char](8) NULL,
	[src] [char](2) NOT NULL,
	[released] [bit] NOT NULL,
	[posted] [bit] NOT NULL,
	[fcy] [char](3) NOT NULL,
	[fcyrate] [numeric](9, 6) NULL,
	[whno] [char](2) NOT NULL,
	[entries] [numeric](6, 0) NULL,
	[lastupdt] [char](8) NULL,
	[towhno] [char](2) NULL,
	[modified] [bit] NOT NULL,
	[rcvdtrn] [bit] NULL,
	[custno] [char](19) NULL,
	[usrid] [char](10) NOT NULL,
	[brsupp] [char](19) NULL,
	[tobrno] [char](2) NULL,
	[brxref] [numeric](6, 0) NULL,
	[glref] [numeric](6, 0) NULL,
	[isbrtrx] [bit] NULL,
	[asmtype] [numeric](1, 0) NULL,
	[repost] [bit] NULL,
	[items_rcvd] [bit] NULL,
	[trx_printed] [numeric](2, 0) NULL,
 CONSTRAINT [PK_stwmtrx_hd] PRIMARY KEY CLUSTERED 
(
	[branch] ASC,
	[trtype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[supplier]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[supplier](
	[cu_name] [varchar](50) NOT NULL,
	[cu_company] [char](2) NOT NULL,
	[cu_code] [char](6) NOT NULL,
	[cu_class] [char](2) NOT NULL,
	[cu_addrs] [varchar](50) NOT NULL,
	[cu_tel] [varchar](25) NOT NULL,
	[cu_fax] [char](10) NOT NULL,
	[cu_tlx] [char](10) NOT NULL,
	[cu_email] [varchar](30) NOT NULL,
	[cu_cntactp] [char](20) NOT NULL,
	[cu_title] [char](20) NOT NULL,
	[cu_crlmt] [numeric](14, 2) NOT NULL,
	[cu_pymnt] [numeric](3, 0) NOT NULL,
	[cu_status] [numeric](1, 0) NOT NULL,
	[cu_opnbal] [float] NULL,
	[cu_curbal] [float] NULL,
	[cf_fcy] [char](3) NOT NULL,
	[cf_opnfcy] [float] NULL,
	[cf_curfcy] [float] NULL,
	[cu_xrf] [char](6) NOT NULL,
	[cu_alwcr] [bit] NOT NULL,
	[cu_ctlser] [char](19) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[cu_lcaloc] [float] NULL,
	[cu_fcaloc] [float] NULL,
	[modified] [bit] NOT NULL,
	[cmncode] [char](8) NOT NULL,
	[cu_lname] [varchar](40) NOT NULL,
	[cu_city] [char](6) NULL,
	[cu_country] [numeric](3, 0) NOT NULL,
	[cu_laddrs] [varchar](50) NOT NULL,
	[cu_mobile] [varchar](25) NOT NULL,
	[cu_sendsms] [bit] NULL,
	[whno] [char](2) NULL,
	[vndr_taxcode] [varchar](20) NULL,
	[taxFree] [bit] NULL,
	[cu_kind] [char](1) NULL,
	[section] [char](6) NULL,
	[PriceIncludeVat] [bit] NULL,
	[cu_type] [char](1) NULL,
	[usrid] [char](10) NULL,
	[usridchg] [char](10) NULL,
	[Added_date] [char](8) NULL,
 CONSTRAINT [PK_supplier] PRIMARY KEY CLUSTERED 
(
	[cu_company] ASC,
	[cu_code] ASC,
	[cf_fcy] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[supplier_ei]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[supplier_ei](
	[cu_company] [char](2) NOT NULL,
	[cu_code] [char](6) NOT NULL,
	[cf_fcy] [char](3) NOT NULL,
	[district] [varchar](50) NULL,
	[district_l] [varchar](50) NULL,
	[city_text] [varchar](50) NULL,
	[city_text_l] [varchar](50) NULL,
	[country_code] [numeric](3, 0) NULL,
	[postal_code] [varchar](20) NULL,
	[Other_id_SchemeID] [varchar](20) NULL,
	[bldg_no] [varchar](50) NULL,
	[bldg_no_l] [varchar](50) NULL,
	[street_name] [varchar](50) NULL,
	[street_name_l] [varchar](50) NULL,
	[area_name] [varchar](50) NULL,
	[area_name_l] [varchar](50) NULL,
	[extra_address_no] [varchar](50) NULL,
	[extra_address_no_l] [varchar](50) NULL,
	[street_name2] [varchar](50) NULL,
	[street_name2_l] [varchar](50) NULL,
	[Group_VAT_ID] [varchar](30) NULL,
	[Other_Scheme_Type] [varchar](10) NULL,
 CONSTRAINT [PK_supplier_ei] PRIMARY KEY CLUSTERED 
(
	[cu_company] ASC,
	[cu_code] ASC,
	[cf_fcy] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[sysgp]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[sysgp](
	[grpid] [char](10) NOT NULL,
	[groupname] [varchar](30) NOT NULL,
	[formkey] [text] NOT NULL,
	[formsel] [text] NOT NULL,
	[formname] [text] NOT NULL,
	[showcost] [bit] NOT NULL,
	[acssdisc] [bit] NOT NULL,
	[acssfqty] [bit] NOT NULL,
	[chgprice] [bit] NOT NULL,
	[undrcost] [bit] NOT NULL,
	[undrmin] [bit] NOT NULL,
	[belowbal] [bit] NOT NULL,
	[uchgpas] [bit] NOT NULL,
	[shwacprtct] [bit] NOT NULL,
	[useprice1] [bit] NOT NULL,
	[useprice2] [bit] NOT NULL,
	[useprice3] [bit] NOT NULL,
	[maxdsc] [numeric](4, 2) NOT NULL,
	[maxfqty] [numeric](6, 2) NOT NULL,
	[usrbrn] [text] NOT NULL,
	[msuser] [bit] NOT NULL,
	[uspright] [text] NOT NULL,
	[uswhalw] [text] NOT NULL,
	[uscntralw] [text] NOT NULL,
	[usdptalw] [text] NOT NULL,
	[uslatin] [bit] NOT NULL,
	[crdtsales] [bit] NOT NULL,
	[usslcsh] [bit] NOT NULL,
	[usslcrd] [bit] NOT NULL,
	[usslrcsh] [bit] NOT NULL,
	[usslrcrd] [bit] NOT NULL,
	[uspucsh] [bit] NOT NULL,
	[uspucrd] [bit] NOT NULL,
	[uspurcsh] [bit] NOT NULL,
	[uspurcrd] [bit] NOT NULL,
	[usjv] [bit] NOT NULL,
	[usrcv] [bit] NOT NULL,
	[usiss] [bit] NOT NULL,
	[uschqrcv] [bit] NOT NULL,
	[uschqiss] [bit] NOT NULL,
	[ustrnsin] [bit] NOT NULL,
	[ustrnsout] [bit] NOT NULL,
	[usbnkin] [bit] NOT NULL,
	[uscredit] [bit] NOT NULL,
	[usdebit] [bit] NOT NULL,
	[ussuspend] [bit] NOT NULL,
	[actallow] [text] NOT NULL,
	[openallow] [bit] NOT NULL,
	[cstallow] [text] NOT NULL,
	[editothers] [bit] NOT NULL,
	[usalwchgprs] [bit] NOT NULL,
	[dsplyothers] [bit] NOT NULL,
	[chgperiod] [bit] NOT NULL,
	[chgtdate] [bit] NOT NULL,
	[alwprntrpt] [bit] NOT NULL,
	[ussctnalw] [text] NULL,
 CONSTRAINT [PK_sysgp] PRIMARY KEY CLUSTERED 
(
	[grpid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
/****** Object:  Table [dbo].[sysuse]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[sysuse](
	[username] [char](10) NOT NULL,
	[formkey] [text] NULL,
	[formsel] [text] NULL,
	[formname] [text] NULL,
	[password] [char](100) NOT NULL,
	[fullname] [varchar](30) NULL,
	[showcost] [bit] NULL,
	[acssdisc] [bit] NULL,
	[chgprice] [bit] NULL,
	[acssfqty] [bit] NULL,
	[undrcost] [bit] NULL,
	[undrmin] [bit] NULL,
	[belowbal] [bit] NULL,
	[grp] [text] NULL,
	[company] [char](2) NULL,
	[uchgpas] [bit] NULL,
	[shwacprtct] [bit] NULL,
	[useprice1] [bit] NULL,
	[useprice2] [bit] NULL,
	[useprice3] [bit] NULL,
	[maxdsc] [numeric](4, 2) NULL,
	[maxfqty] [numeric](6, 2) NULL,
	[currate] [numeric](6, 3) NULL,
	[usrbrn] [text] NULL,
	[msuser] [bit] NULL,
	[uspright] [text] NULL,
	[uswhalw] [text] NULL,
	[uscntralw] [text] NULL,
	[usdptalw] [text] NULL,
	[uslatin] [bit] NULL,
	[usslcsh] [bit] NULL,
	[usslcrd] [bit] NULL,
	[usslrcsh] [bit] NULL,
	[usslrcrd] [bit] NULL,
	[uspucsh] [bit] NULL,
	[uspucrd] [bit] NULL,
	[uspurcsh] [bit] NULL,
	[uspurcrd] [bit] NULL,
	[usjv] [bit] NULL,
	[usrcv] [bit] NULL,
	[usiss] [bit] NULL,
	[uschqrcv] [bit] NULL,
	[uschqiss] [bit] NULL,
	[ustrnsin] [bit] NULL,
	[ustrnsout] [bit] NULL,
	[usbnkin] [bit] NULL,
	[uscredit] [bit] NULL,
	[usdebit] [bit] NULL,
	[ussuspend] [bit] NULL,
	[actallow] [text] NULL,
	[openallow] [bit] NULL,
	[cstallow] [text] NULL,
	[editothers] [bit] NULL,
	[suspend] [bit] NULL,
	[usalwchgprs] [bit] NULL,
	[dsplyothers] [bit] NULL,
	[chgperiod] [bit] NULL,
	[chgtdate] [bit] NULL,
	[alwprntrpt] [bit] NULL,
	[printinv] [bit] NULL,
	[printtrx] [bit] NULL,
	[printbarcode] [bit] NULL,
	[onlinepost] [bit] NULL,
	[showitmcst] [bit] NULL,
	[usmagnetic] [bit] NULL,
	[sendsms] [bit] NULL,
	[usslprofit] [bit] NULL,
	[posuser] [bit] NULL,
	[inv_form_no] [numeric](2, 0) NULL,
	[ushide_jv] [bit] NULL,
	[uschdlcshinv] [bit] NULL,
	[uschdlcshrcv] [bit] NULL,
	[uschdlchqrcv] [bit] NULL,
	[usshowprofit] [bit] NULL,
	[goblwmnmp] [bit] NULL,
	[usfpalw] [bit] NULL,
	[usfpimage] [text] NULL,
	[mobileuser] [bit] NULL,
	[confirmPurchase] [bit] NULL,
	[noovrdrft] [bit] NULL,
	[onlyactrmt] [bit] NULL,
	[confirmbr] [bit] NULL,
	[passwordPDA] [varbinary](200) NULL,
	[confirmtrnsfr] [bit] NULL,
	[nopriceblwcost] [bit] NULL,
	[mgmtcnfrm] [bit] NULL,
	[mobilNo] [nvarchar](30) NULL,
	[OTP] [int] NULL,
	[web_rights] [nvarchar](254) NULL,
	[NorgstrNoSl] [bit] NULL,
	[ussctnalw] [text] NULL,
	[Noslsblwcst] [bit] NULL,
	[AlwChangeVAT] [bit] NULL,
	[emp_code] [char](10) NULL,
	[blkassmbld] [bit] NULL,
	[usfpimage2] [text] NULL,
	[max_inv_printed] [numeric](2, 0) NULL,
	[max_fsh_printed] [numeric](2, 0) NULL,
	[usissrqst] [bit] NULL,
	[usstiss] [bit] NULL,
	[usstrcv] [bit] NULL,
	[e_invrdy] [bit] NULL,
	[smartsearch] [bit] NULL,
	[e_password] [varbinary](200) NULL,
	[applymnmallprices] [bit] NULL,
	[smartsrch_itemBaltype] [numeric](1, 0) NULL,
	[puinv_cost_notalwd] [bit] NULL,
	[mnmppalw] [numeric](5, 2) NULL,
	[nopostslinv] [bit] NULL,
	[nopostpuinv] [bit] NULL,
	[nopoststtrx] [bit] NULL,
	[nochgmaxlmt] [bit] NULL,
	[no_item_duplicate] [bit] NULL,
	[no_item_srch_in_puinv] [bit] NULL,
	[alwsend_doc] [bit] NULL,
	[alwslfrmslnobal] [bit] NULL,
	[nochngpromo] [bit] NULL,
	[dsplyothersQH] [bit] NULL,
	[hideqhinfo] [bit] NULL,
	[alwchg_slrtn_price] [bit] NULL,
	[noadd_crdt_clnt] [bit] NULL,
	[archv_upload] [bit] NULL,
	[archv_download] [bit] NULL,
	[archv_open] [bit] NULL,
	[archv_delete] [bit] NULL,
	[alw2usewtsapp] [bit] NULL,
	[alw2chgwtsmbl] [bit] NULL,
	[smrtsrch4cmbkey] [bit] NULL,
	[use_dashboard] [bit] NULL,
 CONSTRAINT [PK_sysuse] PRIMARY KEY CLUSTERED 
(
	[username] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tailor_Button_types]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tailor_Button_types](
	[code] [char](2) NOT NULL,
	[name] [varchar](25) NOT NULL,
	[lname] [varchar](25) NOT NULL,
	[ctype] [char](1) NULL,
	[ipicture] [varchar](250) NULL,
	[modified] [bit] NULL,
	[lastupdt] [char](8) NULL,
 CONSTRAINT [PK_tailor_Button_types] PRIMARY KEY CLUSTERED 
(
	[code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tailor_category]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tailor_category](
	[code] [char](3) NOT NULL,
	[name] [varchar](25) NOT NULL,
	[lname] [varchar](25) NOT NULL,
	[intgrtd_record] [bit] NULL,
	[modified] [bit] NULL,
	[lastupdt] [char](8) NULL,
 CONSTRAINT [PK_tailor_category] PRIMARY KEY CLUSTERED 
(
	[code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tailor_Closure_types]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tailor_Closure_types](
	[code] [char](2) NOT NULL,
	[name] [varchar](25) NOT NULL,
	[lname] [varchar](25) NOT NULL,
	[ipicture] [varchar](250) NULL,
	[modified] [bit] NULL,
	[lastupdt] [char](8) NULL,
	[intgrtd_record] [bit] NULL,
	[rcrd_ordr] [numeric](3, 0) NULL,
 CONSTRAINT [PK_tailor_Closure_types] PRIMARY KEY CLUSTERED 
(
	[code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tailor_Collar_types]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tailor_Collar_types](
	[code] [char](2) NOT NULL,
	[name] [varchar](25) NOT NULL,
	[lname] [varchar](25) NOT NULL,
	[ctype] [char](1) NULL,
	[ipicture] [varchar](250) NULL,
	[modified] [bit] NULL,
	[lastupdt] [char](8) NULL,
	[intgrtd_record] [bit] NULL,
	[rcrd_ordr] [numeric](3, 0) NULL,
 CONSTRAINT [PK_tailor_Collar_types] PRIMARY KEY CLUSTERED 
(
	[code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tailor_dflt_sizes]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tailor_dflt_sizes](
	[fm_length] [numeric](6, 2) NOT NULL,
	[to_length] [numeric](6, 2) NOT NULL,
	[single_width_yards] [float] NOT NULL,
	[double_width_yards] [float] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tailor_dlvry]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tailor_dlvry](
	[company] [char](2) NOT NULL,
	[dlvr_ref] [int] NOT NULL,
	[dlvr_type] [char](1) NOT NULL,
	[ordr_ref] [int] NOT NULL,
	[fix_ref] [int] NOT NULL,
	[custno] [char](6) NOT NULL,
	[fcy] [char](3) NOT NULL,
	[fcyrate] [float] NOT NULL,
	[invdate] [char](8) NOT NULL,
	[remarks] [varchar](70) NOT NULL,
	[dlvr_qty] [int] NOT NULL,
	[cashpaid] [float] NOT NULL,
	[ccpayment] [float] NOT NULL,
	[mada_payment] [float] NOT NULL,
	[visa_payment] [float] NOT NULL,
	[master_payment] [float] NOT NULL,
	[othrcard_payment] [float] NOT NULL,
	[ttlpayment] [float] NULL,
	[dscamt] [float] NOT NULL,
	[yrcode] [char](4) NULL,
	[gnrtd_invtype] [char](2) NULL,
	[gnrtd_trno] [numeric](6, 0) NULL,
	[released] [bit] NOT NULL,
	[posted] [bit] NOT NULL,
	[rcvdtrn] [bit] NOT NULL,
	[usrid] [char](10) NULL,
	[trsysdate] [char](8) NULL,
	[lastupdt] [char](8) NULL,
	[modified] [bit] NULL,
 CONSTRAINT [PK_tailor_dlvry] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[dlvr_ref] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tailor_Fill_types]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tailor_Fill_types](
	[code] [char](2) NOT NULL,
	[name] [varchar](25) NOT NULL,
	[lname] [varchar](25) NOT NULL,
	[ctype] [char](1) NULL,
	[modified] [bit] NULL,
	[lastupdt] [char](8) NULL,
 CONSTRAINT [PK_tailor_Fill_types] PRIMARY KEY CLUSTERED 
(
	[code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tailor_fix_dt]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tailor_fix_dt](
	[company] [char](2) NOT NULL,
	[refno] [int] NOT NULL,
	[slcenter] [char](2) NOT NULL,
	[custno] [char](6) NOT NULL,
	[fcy] [char](3) NOT NULL,
	[invdate] [char](8) NOT NULL,
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[qty] [int] NOT NULL,
	[unt_length] [float] NOT NULL,
	[ttl_length] [float] NOT NULL,
	[ttl_amount] [float] NOT NULL,
	[price] [float] NOT NULL,
	[cost] [float] NOT NULL,
	[barcode] [char](20) NOT NULL,
	[whno] [char](2) NOT NULL,
	[cmbkey] [char](24) NOT NULL,
	[folio] [numeric](5, 0) NOT NULL,
	[taxtype] [char](1) NULL,
	[pack] [char](1) NOT NULL,
	[pkqty] [numeric](8, 3) NOT NULL,
	[shadd] [char](1) NOT NULL,
	[shdpk] [numeric](8, 3) NOT NULL,
	[shdqty] [numeric](11, 3) NOT NULL,
	[is_accessory_stk_item] [bit] NULL,
 CONSTRAINT [PK_tailor_fix_dt] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[refno] ASC,
	[folio] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tailor_fix_hd]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tailor_fix_hd](
	[company] [char](2) NOT NULL,
	[refno] [int] NOT NULL,
	[slcenter] [char](2) NOT NULL,
	[branch] [char](2) NOT NULL,
	[is_free] [bit] NOT NULL,
	[no_items_fm_us] [bit] NOT NULL,
	[custno] [char](6) NOT NULL,
	[fix_reason] [char](1) NOT NULL,
	[replaced_ref] [int] NULL,
	[fcy] [char](3) NOT NULL,
	[fcyrate] [float] NOT NULL,
	[invdate] [char](8) NOT NULL,
	[cust_subname] [varchar](20) NOT NULL,
	[dlvrdate] [char](8) NOT NULL,
	[xdesc] [varchar](50) NOT NULL,
	[remarks] [varchar](50) NOT NULL,
	[belowbal] [bit] NOT NULL,
	[ordrd_qty] [int] NOT NULL,
	[ord_amount] [float] NOT NULL,
	[dtls_qty] [int] NOT NULL,
	[invttl] [float] NOT NULL,
	[valafds] [float] NOT NULL,
	[invdspc] [float] NOT NULL,
	[invdsvl] [float] NOT NULL,
	[extser] [char](19) NULL,
	[extamt] [float] NULL,
	[vat_amt_rcvd] [float] NOT NULL,
	[taxfree_sales] [float] NOT NULL,
	[clnt_taxcode] [varchar](20) NULL,
	[clnt_kind] [char](1) NULL,
	[hlldscnt] [float] NOT NULL,
	[advance_payment] [float] NOT NULL,
	[cashpaid] [float] NOT NULL,
	[ccpayment] [float] NOT NULL,
	[mada_payment] [float] NULL,
	[visa_payment] [float] NULL,
	[master_payment] [float] NULL,
	[othrcard_payment] [float] NULL,
	[chkdate] [char](8) NOT NULL,
	[ready_qty] [int] NOT NULL,
	[dlvrd_qty] [int] NOT NULL,
	[rcvd_amount] [float] NOT NULL,
	[rtrnd_qty] [int] NOT NULL,
	[rplsd_qty] [int] NOT NULL,
	[entries] [numeric](5, 0) NOT NULL,
	[ordstatus] [char](1) NOT NULL,
	[send_to_tailoring_date] [char](8) NULL,
	[trcode] [char](3) NULL,
	[remarks_sending] [varchar](50) NULL,
	[rcvd_fm_tailoring_date] [char](8) NULL,
	[remarks_rcving] [varchar](50) NULL,
	[gnrtd_invtype] [char](2) NULL,
	[Gnrtd_invno] [numeric](6, 0) NULL,
	[sub_trtype] [char](2) NULL,
	[sub_trno] [numeric](6, 0) NULL,
	[stk_rcvno] [numeric](6, 0) NULL,
	[modified] [bit] NOT NULL,
	[rcvdtrn] [bit] NOT NULL,
	[slcode] [char](2) NOT NULL,
	[usrid] [char](10) NOT NULL,
	[trsysdate] [char](8) NULL,
	[lastupdt] [char](8) NULL,
	[yrcode] [char](4) NULL,
	[sysno] [numeric](1, 0) NULL,
	[no_round_nm] [bit] NULL,
	[PriceVatType] [numeric](1, 0) NULL,
	[smssent] [bit] NULL,
	[prfrd_trcode] [char](3) NULL,
	[fm_us_qty] [int] NULL,
	[fm_cust_qty] [int] NULL,
	[vat_percent] [numeric](5, 2) NULL,
	[category] [char](3) NULL,
 CONSTRAINT [PK_tailor_fix_hd] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tailor_kabak_types]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tailor_kabak_types](
	[code] [char](2) NOT NULL,
	[name] [varchar](25) NOT NULL,
	[lname] [varchar](25) NOT NULL,
	[ipicture] [varchar](250) NULL,
	[modified] [bit] NULL,
	[lastupdt] [char](8) NULL,
	[intgrtd_record] [bit] NULL,
	[rcrd_ordr] [numeric](3, 0) NULL,
 CONSTRAINT [PK_tailor_kabak_types] PRIMARY KEY CLUSTERED 
(
	[code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tailor_ord_dt]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tailor_ord_dt](
	[company] [char](2) NOT NULL,
	[refno] [int] NOT NULL,
	[slcenter] [char](2) NOT NULL,
	[custno] [char](6) NOT NULL,
	[fcy] [char](3) NOT NULL,
	[invdate] [char](8) NOT NULL,
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[qty] [int] NOT NULL,
	[unt_length] [float] NOT NULL,
	[ttl_length] [float] NOT NULL,
	[ttl_amount] [float] NOT NULL,
	[price] [float] NOT NULL,
	[cost] [float] NOT NULL,
	[barcode] [char](20) NOT NULL,
	[whno] [char](2) NOT NULL,
	[cmbkey] [char](24) NOT NULL,
	[folio] [numeric](5, 0) NOT NULL,
	[taxtype] [char](1) NULL,
	[pack] [char](1) NOT NULL,
	[pkqty] [numeric](8, 3) NOT NULL,
	[shadd] [char](1) NOT NULL,
	[shdpk] [numeric](8, 3) NOT NULL,
	[shdqty] [numeric](11, 3) NOT NULL,
	[unt_size] [float] NULL,
	[agreed_price] [float] NULL,
	[tylrng_srvc_fee] [float] NULL,
	[is_double_width] [bit] NULL,
	[is_accessory_stk_item] [bit] NULL,
 CONSTRAINT [PK_tailor_ord_dt] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[refno] ASC,
	[folio] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tailor_ord_hd]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tailor_ord_hd](
	[company] [char](2) NOT NULL,
	[refno] [int] NOT NULL,
	[slcenter] [char](2) NOT NULL,
	[branch] [char](2) NOT NULL,
	[is_free] [bit] NOT NULL,
	[no_items_fm_us] [bit] NOT NULL,
	[custno] [char](6) NOT NULL,
	[replaced_ref] [int] NULL,
	[fcy] [char](3) NOT NULL,
	[fcyrate] [float] NOT NULL,
	[invdate] [char](8) NOT NULL,
	[cust_subname] [varchar](20) NOT NULL,
	[dlvrdate] [char](8) NOT NULL,
	[remarks] [varchar](50) NOT NULL,
	[belowbal] [bit] NOT NULL,
	[ordrd_qty] [int] NOT NULL,
	[ord_amount] [float] NOT NULL,
	[dtls_qty] [int] NOT NULL,
	[invttl] [float] NOT NULL,
	[valafds] [float] NOT NULL,
	[invdspc] [float] NOT NULL,
	[invdsvl] [float] NOT NULL,
	[extser] [char](19) NULL,
	[extamt] [float] NULL,
	[vat_amt_rcvd] [float] NOT NULL,
	[taxfree_sales] [float] NOT NULL,
	[clnt_taxcode] [varchar](20) NULL,
	[clnt_kind] [char](1) NULL,
	[hlldscnt] [float] NOT NULL,
	[advance_payment] [float] NOT NULL,
	[cashpaid] [float] NOT NULL,
	[ccpayment] [float] NOT NULL,
	[mada_payment] [float] NULL,
	[visa_payment] [float] NULL,
	[master_payment] [float] NULL,
	[othrcard_payment] [float] NULL,
	[chkdate] [char](8) NOT NULL,
	[ready_qty] [int] NOT NULL,
	[dlvrd_qty] [int] NOT NULL,
	[rcvd_amount] [float] NOT NULL,
	[rtrnd_qty] [int] NOT NULL,
	[rplsd_qty] [int] NOT NULL,
	[entries] [numeric](5, 0) NOT NULL,
	[ordstatus] [char](1) NOT NULL,
	[send_to_tailoring_date] [char](8) NULL,
	[trcode] [char](3) NULL,
	[remarks_sending] [varchar](50) NULL,
	[rcvd_fm_tailoring_date] [char](8) NULL,
	[remarks_rcving] [varchar](50) NULL,
	[gnrtd_invtype] [char](2) NULL,
	[Gnrtd_invno] [numeric](6, 0) NULL,
	[sub_trtype] [char](2) NULL,
	[sub_trno] [numeric](6, 0) NULL,
	[stk_rcvno] [numeric](6, 0) NULL,
	[modified] [bit] NOT NULL,
	[rcvdtrn] [bit] NOT NULL,
	[slcode] [char](2) NOT NULL,
	[usrid] [char](10) NOT NULL,
	[trsysdate] [char](8) NULL,
	[lastupdt] [char](8) NULL,
	[yrcode] [char](4) NULL,
	[sysno] [numeric](1, 0) NULL,
	[no_round_nm] [bit] NULL,
	[PriceVatType] [numeric](1, 0) NULL,
	[smssent] [bit] NULL,
	[prfrd_trcode] [char](3) NULL,
	[fm_us_qty] [int] NULL,
	[fm_cust_qty] [int] NULL,
	[vat_percent] [numeric](5, 2) NULL,
	[category] [char](3) NULL,
 CONSTRAINT [PK_tailor_order] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tailor_ord_size]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tailor_ord_size](
	[company] [char](2) NOT NULL,
	[refno] [int] NOT NULL,
	[fcy] [char](3) NOT NULL,
	[custno] [char](6) NOT NULL,
	[cust_subname] [varchar](20) NOT NULL,
	[invdate] [char](8) NOT NULL,
	[tr_type] [char](2) NOT NULL,
	[tr_type2] [char](2) NOT NULL,
	[textile_name] [varchar](50) NULL,
	[front_length] [numeric](6, 2) NOT NULL,
	[back_length] [numeric](6, 2) NOT NULL,
	[shoulder_width] [numeric](6, 2) NOT NULL,
	[shoulder_bent] [numeric](6, 2) NOT NULL,
	[waist_width] [numeric](6, 2) NOT NULL,
	[hip_width] [numeric](6, 2) NOT NULL,
	[front_chest_width] [numeric](6, 2) NOT NULL,
	[back_chest_width] [numeric](6, 2) NOT NULL,
	[sleeve_length_normal] [numeric](6, 2) NOT NULL,
	[sleeve_width_normal] [numeric](6, 2) NOT NULL,
	[sleeve_fold_normal] [numeric](6, 2) NOT NULL,
	[sleeve_length_kbk] [numeric](6, 2) NOT NULL,
	[sleeve_width_kbk] [numeric](6, 2) NOT NULL,
	[kbk_type] [char](2) NOT NULL,
	[kbk_type2] [char](2) NOT NULL,
	[neck_width_normal] [numeric](6, 2) NOT NULL,
	[neck_width_glab] [numeric](6, 2) NOT NULL,
	[collar_type_normal] [char](2) NOT NULL,
	[collar_type_glab] [char](2) NOT NULL,
	[collar_width_normal] [numeric](6, 2) NOT NULL,
	[collar_width_glab] [numeric](6, 2) NOT NULL,
	[button_type_normal] [char](2) NOT NULL,
	[button_type_glab] [char](2) NOT NULL,
	[khshtk_length] [numeric](6, 2) NOT NULL,
	[khshtk_up_width] [numeric](6, 2) NOT NULL,
	[khshtk_down_width] [numeric](6, 2) NOT NULL,
	[filling_type_normal] [char](2) NOT NULL,
	[filling_type_glab] [char](2) NOT NULL,
	[closure_type] [char](2) NOT NULL,
	[closure_length] [numeric](6, 2) NOT NULL,
	[closure_width] [numeric](6, 2) NOT NULL,
	[up_pocket_type] [char](2) NOT NULL,
	[up_pocket_type2] [char](2) NOT NULL,
	[up_pocket_length] [numeric](6, 2) NOT NULL,
	[up_pocket_width] [numeric](6, 2) NOT NULL,
	[up_pocket_depth] [numeric](6, 2) NOT NULL,
	[sd_pocket_type] [char](2) NOT NULL,
	[sd_pocket_type2] [char](2) NOT NULL,
	[mobile_pocket_length] [numeric](6, 2) NOT NULL,
	[mobile_pocket_width] [numeric](6, 2) NOT NULL,
	[down_width] [numeric](6, 2) NOT NULL,
	[down_fold] [numeric](6, 2) NOT NULL,
	[zrar_no] [int] NOT NULL,
	[accessory_no] [int] NOT NULL,
	[tatreeze_no] [int] NOT NULL,
	[model_no] [int] NOT NULL,
	[tatreeze_color] [char](15) NULL,
	[stickers_no] [int] NOT NULL,
	[remarks] [varchar](250) NULL,
	[usrid] [char](10) NOT NULL,
	[person_took_sizes] [varchar](40) NULL,
	[modified] [bit] NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[weight] [numeric](6, 2) NULL,
	[collar_width2_glab] [numeric](6, 2) NULL,
	[sleeve_width2_kbk] [numeric](6, 2) NULL,
	[sleeve_width3_kbk] [numeric](6, 2) NULL,
	[sleeve_height_kbk] [numeric](6, 2) NULL,
	[sleeve_width2_normal] [numeric](6, 2) NULL,
	[category] [char](3) NULL,
	[stickers_type] [char](2) NULL,
 CONSTRAINT [PK_tailor_ord_size] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tailor_pocket_types]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tailor_pocket_types](
	[code] [char](2) NOT NULL,
	[name] [varchar](25) NOT NULL,
	[lname] [varchar](25) NOT NULL,
	[ctype] [char](1) NULL,
	[ipicture] [varchar](250) NULL,
	[modified] [bit] NULL,
	[lastupdt] [char](8) NULL,
	[intgrtd_record] [bit] NULL,
 CONSTRAINT [PK_tailor_pocket_types] PRIMARY KEY CLUSTERED 
(
	[code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tailor_ready_made_sales]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tailor_ready_made_sales](
	[slcenter] [char](2) NOT NULL,
	[company] [char](2) NOT NULL,
	[invtype] [char](2) NOT NULL,
	[refno] [numeric](6, 0) NOT NULL,
	[invdate] [char](8) NOT NULL,
	[custno] [char](6) NOT NULL,
	[custnm] [varchar](50) NOT NULL,
	[fcy] [char](3) NOT NULL,
	[fcyrate] [numeric](6, 3) NOT NULL,
	[ready_made_cmbkey] [char](24) NOT NULL,
	[qty] [float] NOT NULL,
	[price] [float] NOT NULL,
	[valafds] [float] NOT NULL,
	[invdspc] [float] NOT NULL,
	[invdsvl] [float] NOT NULL,
	[posinv] [numeric](1, 0) NOT NULL,
	[released] [bit] NOT NULL,
	[posted] [bit] NOT NULL,
	[pricetp] [char](1) NOT NULL,
	[usrid] [char](10) NOT NULL,
	[yrcode] [char](4) NOT NULL,
	[vat_amt_rcvd] [float] NOT NULL,
	[hlldscnt] [float] NOT NULL,
	[sysno] [numeric](1, 0) NOT NULL,
	[PriceVatType] [numeric](1, 0) NOT NULL,
	[No_round_nm] [bit] NOT NULL,
	[modified] [bit] NOT NULL,
	[rcvdtrn] [bit] NOT NULL,
	[lastupdt] [char](8) NOT NULL,
	[slcode] [char](2) NOT NULL,
	[rtnref] [numeric](6, 0) NOT NULL,
	[rtnqty] [float] NOT NULL,
	[taxfree_sales] [float] NOT NULL,
	[clnt_taxcode] [varchar](20) NOT NULL,
	[clnt_kind] [char](1) NOT NULL,
	[taxtype] [char](1) NOT NULL,
	[caser] [char](19) NOT NULL,
	[whno] [char](2) NOT NULL,
	[cost] [float] NOT NULL,
	[belowbal] [bit] NOT NULL,
	[duedate] [char](8) NOT NULL,
	[vat_percent] [numeric](5, 2) NULL,
 CONSTRAINT [PK_tailor_ready_made_sales] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[invtype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tailor_rtrn_dt]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tailor_rtrn_dt](
	[company] [char](2) NOT NULL,
	[refno] [int] NOT NULL,
	[slcenter] [char](2) NOT NULL,
	[custno] [char](6) NOT NULL,
	[fcy] [char](3) NOT NULL,
	[invdate] [char](8) NOT NULL,
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[qty] [int] NOT NULL,
	[unt_length] [float] NOT NULL,
	[ttl_length] [float] NOT NULL,
	[ttl_amount] [float] NOT NULL,
	[price] [float] NOT NULL,
	[cost] [float] NOT NULL,
	[barcode] [char](20) NOT NULL,
	[whno] [char](2) NOT NULL,
	[cmbkey] [char](24) NOT NULL,
	[folio] [numeric](5, 0) NOT NULL,
	[taxtype] [char](1) NULL,
	[pack] [char](1) NOT NULL,
	[pkqty] [numeric](8, 3) NOT NULL,
	[shadd] [char](1) NOT NULL,
	[shdpk] [numeric](8, 3) NOT NULL,
	[shdqty] [numeric](11, 3) NOT NULL,
	[unt_size] [float] NULL,
	[agreed_price] [float] NULL,
	[tylrng_srvc_fee] [float] NULL,
	[is_double_width] [bit] NULL,
 CONSTRAINT [PK_tailor_rtrn_dt] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[refno] ASC,
	[folio] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tailor_rtrn_hd]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tailor_rtrn_hd](
	[company] [char](2) NOT NULL,
	[refno] [int] NOT NULL,
	[slcenter] [char](2) NOT NULL,
	[branch] [char](2) NOT NULL,
	[is_free] [bit] NOT NULL,
	[no_items_fm_us] [bit] NOT NULL,
	[custno] [char](6) NOT NULL,
	[replaced_ref] [int] NULL,
	[fcy] [char](3) NOT NULL,
	[fcyrate] [float] NOT NULL,
	[invdate] [char](8) NOT NULL,
	[cust_subname] [varchar](20) NOT NULL,
	[dlvrdate] [char](8) NOT NULL,
	[remarks] [varchar](50) NOT NULL,
	[belowbal] [bit] NOT NULL,
	[ordrd_qty] [int] NOT NULL,
	[ord_amount] [float] NOT NULL,
	[dtls_qty] [int] NOT NULL,
	[invttl] [float] NOT NULL,
	[valafds] [float] NOT NULL,
	[invdspc] [float] NOT NULL,
	[invdsvl] [float] NOT NULL,
	[extser] [char](19) NULL,
	[extamt] [float] NULL,
	[vat_amt_rcvd] [float] NOT NULL,
	[taxfree_sales] [float] NOT NULL,
	[clnt_taxcode] [varchar](20) NULL,
	[clnt_kind] [char](1) NULL,
	[hlldscnt] [float] NOT NULL,
	[advance_payment] [float] NOT NULL,
	[cashpaid] [float] NOT NULL,
	[ccpayment] [float] NOT NULL,
	[mada_payment] [float] NULL,
	[visa_payment] [float] NULL,
	[master_payment] [float] NULL,
	[othrcard_payment] [float] NULL,
	[chkdate] [char](8) NOT NULL,
	[ready_qty] [int] NOT NULL,
	[dlvrd_qty] [int] NOT NULL,
	[rcvd_amount] [float] NOT NULL,
	[rtrnd_qty] [int] NOT NULL,
	[rplsd_qty] [int] NOT NULL,
	[entries] [numeric](5, 0) NOT NULL,
	[ordstatus] [char](1) NOT NULL,
	[send_to_tailoring_date] [char](8) NULL,
	[trcode] [char](3) NULL,
	[remarks_sending] [varchar](50) NULL,
	[rcvd_fm_tailoring_date] [char](8) NULL,
	[remarks_rcving] [varchar](50) NULL,
	[gnrtd_invtype] [char](2) NULL,
	[Gnrtd_invno] [numeric](6, 0) NULL,
	[sub_trtype] [char](2) NULL,
	[sub_trno] [numeric](6, 0) NULL,
	[stk_rcvno] [numeric](6, 0) NULL,
	[modified] [bit] NOT NULL,
	[rcvdtrn] [bit] NOT NULL,
	[slcode] [char](2) NOT NULL,
	[usrid] [char](10) NOT NULL,
	[trsysdate] [char](8) NULL,
	[lastupdt] [char](8) NULL,
	[yrcode] [char](4) NULL,
	[sysno] [numeric](1, 0) NULL,
	[no_round_nm] [bit] NULL,
	[PriceVatType] [numeric](1, 0) NULL,
	[smssent] [bit] NULL,
	[rtrn_cmbkey] [char](24) NULL,
	[vat_percent] [numeric](5, 2) NULL,
	[rtrnd_fm_us_qty] [int] NULL,
	[rtrnd_fm_cust_qty] [int] NULL,
 CONSTRAINT [PK_tailor_rtrn_hd] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tailor_setup]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tailor_setup](
	[company] [char](2) NULL,
	[brnno] [char](2) NULL,
	[min_advance_ptg] [float] NULL,
	[ok_free] [bit] NULL,
	[slcenter] [char](2) NULL,
	[free_acct_ser] [char](19) NULL,
	[free_acct_expense] [char](19) NULL,
	[good_cmbkey] [char](24) NULL,
	[due_days] [numeric](3, 0) NULL,
	[orders_price_used] [numeric](1, 0) NULL,
	[modified] [bit] NOT NULL,
	[lastupdt] [char](8) NULL,
	[dsc_acct_ser] [char](19) NULL,
	[our_tylrng_srvc_cmbkey] [char](24) NULL,
	[our_tylrng_srvc_fee] [float] NULL,
	[clnt_tylrng_srvc_cmbkey] [char](24) NULL,
	[clnt_tylrng_srvc_fee] [float] NULL,
	[ok_price_per_length] [bit] NULL,
	[long_starts_fm] [numeric](8, 2) NULL,
	[coat_our_tylrng_srvc_fee] [float] NULL,
	[coat_clnt_tylrng_srvc_fee] [float] NULL,
	[no_xtrnl_prd1_fm] [char](8) NULL,
	[no_xtrnl_prd1_to] [char](8) NULL,
	[no_xtrnl_prd2_fm] [char](8) NULL,
	[no_xtrnl_prd2_to] [char](8) NULL,
	[sc_code] [char](4) NULL,
	[cu_class] [char](2) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tailor_stickers_types]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tailor_stickers_types](
	[code] [char](2) NOT NULL,
	[name] [varchar](25) NOT NULL,
	[lname] [varchar](25) NOT NULL,
	[modified] [bit] NULL,
	[lastupdt] [char](8) NULL,
 CONSTRAINT [PK_tailor_stickers_types] PRIMARY KEY CLUSTERED 
(
	[code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tailor_tailoring_types]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tailor_tailoring_types](
	[code] [char](2) NOT NULL,
	[name] [varchar](25) NOT NULL,
	[lname] [varchar](25) NOT NULL,
	[modified] [bit] NULL,
	[lastupdt] [char](8) NULL,
 CONSTRAINT [PK_tailor_tailoring_types] PRIMARY KEY CLUSTERED 
(
	[code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tailor_trans_dt]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tailor_trans_dt](
	[company] [char](2) NOT NULL,
	[transtype] [char](1) NOT NULL,
	[refno] [int] NOT NULL,
	[transordtype] [char](1) NOT NULL,
	[transdate] [char](8) NOT NULL,
	[taylor_code] [char](3) NOT NULL,
	[ordno] [int] NOT NULL,
	[custno] [char](6) NOT NULL,
	[qty] [int] NOT NULL,
	[remarks] [varchar](50) NOT NULL,
	[folio] [numeric](5, 0) NOT NULL,
 CONSTRAINT [PK_tailor_trans_dt] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[transtype] ASC,
	[refno] ASC,
	[folio] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tailor_trans_hd]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tailor_trans_hd](
	[company] [char](2) NOT NULL,
	[transtype] [char](1) NOT NULL,
	[refno] [int] NOT NULL,
	[transordtype] [char](1) NOT NULL,
	[transdate] [char](8) NOT NULL,
	[remarks] [varchar](50) NOT NULL,
	[entries] [numeric](5, 0) NOT NULL,
	[ttl_qty] [int] NOT NULL,
	[yrcode] [char](4) NULL,
	[posted] [bit] NOT NULL,
	[usrid] [char](10) NOT NULL,
	[rcvdtrn] [bit] NOT NULL,
	[modified] [bit] NOT NULL,
	[transsysdate] [char](8) NOT NULL,
	[lastupdt] [char](8) NOT NULL,
 CONSTRAINT [PK_tailor_trans_hd] PRIMARY KEY CLUSTERED 
(
	[company] ASC,
	[transtype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tailors]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tailors](
	[trcode] [char](3) NOT NULL,
	[trname] [varchar](50) NOT NULL,
	[trlname] [varchar](40) NOT NULL,
	[trmobile] [varchar](30) NOT NULL,
	[country] [numeric](3, 0) NOT NULL,
	[modified] [bit] NOT NULL,
	[lastupdt] [char](8) NOT NULL,
 CONSTRAINT [PK_tailors] PRIMARY KEY CLUSTERED 
(
	[trcode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[taxcategory]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[taxcategory](
	[taxcatID] [numeric](3, 0) NOT NULL,
	[taxcat_name] [varchar](40) NULL,
	[taxcat_lname] [varchar](40) NULL,
	[cat_protected] [bit] NULL,
	[lastupdt] [char](8) NULL,
	[sysname] [char](2) NULL,
	[In_out_tax] [numeric](1, 0) NULL,
	[txdsc_allowed] [bit] NULL,
 CONSTRAINT [PK_taxcategory] PRIMARY KEY CLUSTERED 
(
	[taxcatID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[taxperiod]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[taxperiod](
	[taxprdcalcomp] [char](2) NOT NULL,
	[taxprdyrcode] [char](4) NOT NULL,
	[taxprdcode] [int] NOT NULL,
	[taxprdname] [varchar](50) NULL,
	[taxprdlname] [varchar](50) NULL,
	[taxprdstart] [char](8) NULL,
	[taxprdend] [char](8) NULL,
	[crtdate] [smalldatetime] NULL,
	[lastupdt] [char](8) NULL,
	[lastmodifed] [smalldatetime] NULL,
	[Taxtype] [char](3) NULL,
	[lastusrupdt] [varchar](10) NULL,
	[Jv_Vat_Percent] [numeric](5, 2) NULL,
 CONSTRAINT [PK_taxperiod] PRIMARY KEY CLUSTERED 
(
	[taxprdcalcomp] ASC,
	[taxprdyrcode] ASC,
	[taxprdcode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[trxaddtime]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[trxaddtime](
	[xxbranch] [char](2) NOT NULL,
	[xxtype] [char](2) NOT NULL,
	[xxref] [int] NOT NULL,
	[ac_st] [char](1) NOT NULL,
	[xxusradd] [varchar](10) NULL,
	[xxdatetime] [smalldatetime] NULL,
	[xxmachine] [varchar](40) NULL,
	[xxsrc] [char](2) NULL,
 CONSTRAINT [PK_trxaddtime_1] PRIMARY KEY CLUSTERED 
(
	[xxbranch] ASC,
	[xxtype] ASC,
	[xxref] ASC,
	[ac_st] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ttkfile]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ttkfile](
	[fname] [varchar](45) NOT NULL,
	[whno] [char](2) NOT NULL,
	[binno] [char](6) NOT NULL,
	[ttqty] [float] NULL,
	[ttstatus] [numeric](1, 0) NOT NULL,
	[srl_no] [numeric](8, 0) NOT NULL,
	[mclass] [char](12) NULL,
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[mqty] [float] NULL,
	[expdate] [char](8) NULL,
	[lcost] [float] NOT NULL,
	[fcost] [float] NULL,
	[barcode] [char](20) NOT NULL,
	[cmbkey] [char](24) NOT NULL,
	[pack0] [char](1) NULL,
	[pkqty1] [numeric](12, 3) NULL,
	[pack1] [char](1) NULL,
	[nobin] [bit] NULL,
 CONSTRAINT [PK_ttkfile] PRIMARY KEY CLUSTERED 
(
	[whno] ASC,
	[binno] ASC,
	[itemno] ASC,
	[unicode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ttkfile_hst]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ttkfile_hst](
	[fname] [varchar](45) NOT NULL,
	[whno] [char](2) NOT NULL,
	[binno] [char](6) NOT NULL,
	[ttqty] [float] NULL,
	[ttstatus] [numeric](1, 0) NOT NULL,
	[srl_no] [numeric](8, 0) NOT NULL,
	[mclass] [char](12) NULL,
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[mqty] [float] NULL,
	[expdate] [char](8) NULL,
	[lcost] [float] NOT NULL,
	[fcost] [float] NULL,
	[barcode] [char](20) NOT NULL,
	[cmbkey] [char](24) NOT NULL,
	[pack0] [char](1) NULL,
	[pkqty1] [numeric](12, 3) NULL,
	[pack1] [char](1) NULL,
	[nobin] [bit] NULL,
	[ttk_no] [int] NOT NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ttkhdr]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ttkhdr](
	[ttwhno] [char](2) NOT NULL,
	[ttdate] [char](8) NOT NULL,
	[ttcntr] [numeric](7, 0) NOT NULL,
	[ttcomp] [char](2) NOT NULL,
	[ttsection] [bit] NOT NULL,
	[ttkmanual] [bit] NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ttkhdr_hst]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ttkhdr_hst](
	[ttwhno] [char](2) NOT NULL,
	[ttdate] [char](8) NOT NULL,
	[ttcntr] [numeric](7, 0) NOT NULL,
	[ttcomp] [char](2) NOT NULL,
	[ttsection] [bit] NOT NULL,
	[ttkmanual] [bit] NULL,
	[ttk_no] [int] NOT NULL,
 CONSTRAINT [PK_ttkhdr_hst] PRIMARY KEY CLUSTERED 
(
	[ttwhno] ASC,
	[ttk_no] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ttknfile]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ttknfile](
	[whno] [char](2) NOT NULL,
	[binno] [char](6) NOT NULL,
	[itemno] [char](16) NOT NULL,
	[unicode] [char](6) NOT NULL,
	[q1] [numeric](12, 2) NOT NULL,
	[f1] [numeric](9, 0) NOT NULL,
	[q2] [numeric](12, 2) NOT NULL,
	[f2] [numeric](9, 0) NOT NULL,
	[q3] [numeric](12, 2) NOT NULL,
	[f3] [numeric](9, 0) NOT NULL,
	[q4] [numeric](12, 2) NOT NULL,
	[f4] [numeric](9, 0) NOT NULL,
	[q5] [numeric](12, 2) NOT NULL,
	[f5] [numeric](9, 0) NOT NULL,
	[q6] [numeric](12, 2) NOT NULL,
	[f6] [numeric](9, 0) NOT NULL,
	[q7] [numeric](12, 2) NOT NULL,
	[f7] [numeric](9, 0) NOT NULL,
	[q8] [numeric](12, 2) NOT NULL,
	[f8] [numeric](9, 0) NOT NULL,
	[q9] [numeric](12, 2) NOT NULL,
	[f9] [numeric](9, 0) NOT NULL,
	[q10] [numeric](12, 2) NOT NULL,
	[f10] [numeric](9, 0) NOT NULL,
	[q11] [numeric](12, 2) NOT NULL,
	[f11] [numeric](9, 0) NOT NULL,
	[q12] [numeric](12, 2) NOT NULL,
	[f12] [numeric](9, 0) NOT NULL,
 CONSTRAINT [PK_ttknfile] PRIMARY KEY CLUSTERED 
(
	[whno] ASC,
	[binno] ASC,
	[itemno] ASC,
	[unicode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[ttkusr]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[ttkusr](
	[usrid] [char](10) NULL,
	[col_q] [numeric](2, 0) NOT NULL,
	[whno] [char](2) NULL
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[vender_dtl]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[vender_dtl](
	[vn_company] [char](2) NOT NULL,
	[vn_code] [char](6) NOT NULL,
	[vn_fcy] [char](3) NOT NULL,
	[vn_invdsc] [numeric](7, 3) NULL,
	[vn_paiddsc] [numeric](7, 3) NULL,
	[vn_annualdsc] [numeric](7, 3) NULL,
	[vn_target] [float] NULL,
	[vn_bnkacct] [varchar](30) NULL,
	[vn_bnkdesc] [varchar](70) NULL,
	[lastupdt] [char](8) NULL,
	[usrid] [char](10) NULL,
	[vn_bnkacct2] [varchar](30) NULL,
	[vn_bnkdesc2] [varchar](70) NULL,
	[vn_daysno] [numeric](3, 0) NULL,
 CONSTRAINT [PK_vender_dtl] PRIMARY KEY CLUSTERED 
(
	[vn_company] ASC,
	[vn_code] ASC,
	[vn_fcy] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[websites]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[websites](
	[wcompany] [char](2) NOT NULL,
	[wcode] [int] NOT NULL,
	[wshort] [varchar](20) NULL,
	[wname] [varchar](70) NOT NULL,
	[wcommamt] [numeric](10, 3) NULL,
	[wcommprcnt] [numeric](5, 3) NULL,
	[wtaxable] [bit] NULL,
	[wacct] [varchar](19) NULL,
	[modified] [bit] NULL,
	[wlname] [varchar](70) NULL,
	[lastupdt] [char](8) NULL,
	[wcontact] [varchar](50) NULL,
	[wmobile] [varchar](40) NULL,
	[wurl] [varchar](70) NULL,
	[wfcy] [char](3) NULL,
	[usrid] [char](10) NULL,
	[cmsn_incld_VAT_Trnsp] [bit] NULL,
 CONSTRAINT [PK_websites] PRIMARY KEY CLUSTERED 
(
	[wcompany] ASC,
	[wcode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[whatsapp_log]    Script Date: 2025-11-13 12:21:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[whatsapp_log](
	[wts_id] [int] IDENTITY(1,1) NOT NULL,
	[branch] [char](2) NULL,
	[trtype] [char](2) NULL,
	[refno] [int] NULL,
	[sent_datetime] [datetime] NULL,
	[usrid] [varchar](10) NULL,
	[to_mobile] [varchar](20) NULL,
	[machine_name] [varchar](50) NULL,
	[screen_name] [varchar](50) NULL,
	[screen_title] [varchar](150) NULL,
	[custno] [varchar](50) NULL,
	[fcy] [char](3) NULL,
 CONSTRAINT [PK_whatsapp_log] PRIMARY KEY CLUSTERED 
(
	[wts_id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Index [MSmerge_index_1733581214]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE UNIQUE NONCLUSTERED INDEX [MSmerge_index_1733581214] ON [dbo].[apclass]
(
	[rowguid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [ix_apdtl_aging]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE UNIQUE NONCLUSTERED INDEX [ix_apdtl_aging] ON [dbo].[apdtl]
(
	[dt_company] ASC,
	[dt_cucode] ASC,
	[dt_fcy] ASC,
	[dt_type] ASC,
	[dt_ref] ASC,
	[dt_folio] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
/****** Object:  Index [MSmerge_index_1765581328]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE UNIQUE NONCLUSTERED INDEX [MSmerge_index_1765581328] ON [dbo].[apdtl]
(
	[rowguid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
/****** Object:  Index [MSmerge_index_1781581385]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE UNIQUE NONCLUSTERED INDEX [MSmerge_index_1781581385] ON [dbo].[aphdr]
(
	[rowguid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_aplcrmt_dt]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_aplcrmt_dt] ON [dbo].[aplcrmt_dt]
(
	[cu_company] ASC,
	[ref_id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_Archive_Attachments]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_Archive_Attachments] ON [dbo].[Archive_Attachments]
(
	[Company] ASC,
	[SystemType] ASC,
	[screentype] ASC,
	[t_a_s_g_code] ASC,
	[fcy_ref] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [acctndx]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [acctndx] ON [dbo].[BKBNFCH]
(
	[BCOMPANY] ASC,
	[BGLACT] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [custndx]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [custndx] ON [dbo].[BKBNFCH]
(
	[BCOMPANY] ASC,
	[BCUSTNO] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_brselected]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE UNIQUE NONCLUSTERED INDEX [IX_brselected] ON [dbo].[brselected]
(
	[brnno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_delchgdtl]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_delchgdtl] ON [dbo].[delchgdtl]
(
	[itemno] ASC,
	[unicode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
/****** Object:  Index [IX_delchgdtl_2]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_delchgdtl_2] ON [dbo].[delchgdtl]
(
	[trx_id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
/****** Object:  Index [IX_fsiss_dt]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_fsiss_dt] ON [dbo].[fsiss_dt]
(
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_fsrcv_dt]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_fsrcv_dt] ON [dbo].[fsrcv_dt]
(
	[branch] ASC,
	[trtype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_gljrcost]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_gljrcost] ON [dbo].[gljrcost]
(
	[company] ASC,
	[jdtype] ASC,
	[jdref] ASC,
	[jdfolno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_gljrdtl]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE UNIQUE NONCLUSTERED INDEX [IX_gljrdtl] ON [dbo].[gljrdtl]
(
	[jdcomp] ASC,
	[jdtype] ASC,
	[jdref] ASC,
	[jdfolno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_gljrdtl_1]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_gljrdtl_1] ON [dbo].[gljrdtl]
(
	[jdkey] ASC,
	[jdcurr] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
/****** Object:  Index [MSmerge_index_160719625]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE UNIQUE NONCLUSTERED INDEX [MSmerge_index_160719625] ON [dbo].[gljrdtl]
(
	[rowguid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
/****** Object:  Index [MSmerge_index_1668200993]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE UNIQUE NONCLUSTERED INDEX [MSmerge_index_1668200993] ON [dbo].[gljrhdr]
(
	[rowguid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [NonClusteredIndex_whno_ctr_srlno]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE UNIQUE NONCLUSTERED INDEX [NonClusteredIndex_whno_ctr_srlno] ON [dbo].[inventory]
(
	[whno] ASC,
	[ctr] ASC,
	[srlno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
/****** Object:  Index [IX_invhstry]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_invhstry] ON [dbo].[invhstry]
(
	[company] ASC,
	[contr] ASC,
	[refno] ASC,
	[srlno] ASC,
	[ref_id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_ord_dtl]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_ord_dtl] ON [dbo].[ord_dtl]
(
	[company] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_ord_dtl_1]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_ord_dtl_1] ON [dbo].[ord_dtl]
(
	[itemno] ASC,
	[unicode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [ix_ord_dtl2]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [ix_ord_dtl2] ON [dbo].[ord_dtl]
(
	[company] ASC,
	[refno] ASC,
	[itemno] ASC,
	[unicode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_pos_chdt]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_pos_chdt] ON [dbo].[pos_chdt]
(
	[company] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_pos_chdt_1]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_pos_chdt_1] ON [dbo].[pos_chdt]
(
	[company] ASC,
	[cstcode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [ix_pos_chdt_2]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [ix_pos_chdt_2] ON [dbo].[pos_chdt]
(
	[company] ASC,
	[sc_code] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [ix_pos_dt_barcode]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [ix_pos_dt_barcode] ON [dbo].[pos_dt]
(
	[barcode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_deviceSN]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_deviceSN] ON [dbo].[POS_ei]
(
	[folio] ASC,
	[deviceSN] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [buy_mobile]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [buy_mobile] ON [dbo].[posinstlmnt_trx]
(
	[trx_buyer_mobile] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_posrtninv]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_posrtninv] ON [dbo].[posrtninv]
(
	[company] ASC,
	[contr] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_pricehst]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_pricehst] ON [dbo].[pricehst]
(
	[cmbkey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_pricehst_1]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_pricehst_1] ON [dbo].[pricehst]
(
	[usrid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [ix_pucustom]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [ix_pucustom] ON [dbo].[pucustom]
(
	[company] ASC,
	[invtype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [ix_pucustom_1]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [ix_pucustom_1] ON [dbo].[pucustom]
(
	[company] ASC,
	[custom_code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_Qinvtrk]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_Qinvtrk] ON [dbo].[Qinvtrk]
(
	[company] ASC,
	[refno] ASC,
	[usrid] ASC,
	[acsusrid] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_sales_dd]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_sales_dd] ON [dbo].[sales_dd]
(
	[company] ASC,
	[invtype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_sales_dt]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_sales_dt] ON [dbo].[sales_dt]
(
	[company] ASC,
	[custno] ASC,
	[fcy] ASC,
	[itemno] ASC,
	[unicode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_sales_dt_2]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_sales_dt_2] ON [dbo].[sales_dt]
(
	[itemno] ASC,
	[unicode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_sales_od]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_sales_od] ON [dbo].[sales_od]
(
	[company] ASC,
	[refno] ASC,
	[itemno] ASC,
	[unicode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_sales_od_1]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_sales_od_1] ON [dbo].[sales_od]
(
	[itemno] ASC,
	[unicode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_sales_qd]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_sales_qd] ON [dbo].[sales_qd]
(
	[company] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_sdaad_dt]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_sdaad_dt] ON [dbo].[sdaad_dt]
(
	[company] ASC,
	[sdtype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [ix_slccpayment]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [ix_slccpayment] ON [dbo].[slccpayment]
(
	[company] ASC,
	[invtype] ASC,
	[refno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_stasmbld_1]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_stasmbld_1] ON [dbo].[stasmbld]
(
	[itemno] ASC,
	[unicode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_stbins_1]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_stbins_1] ON [dbo].[stbins]
(
	[itemno] ASC,
	[unicode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_stbranch]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE UNIQUE NONCLUSTERED INDEX [IX_stbranch] ON [dbo].[stbranch]
(
	[brnno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_stbrprice_1]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_stbrprice_1] ON [dbo].[stbrprice]
(
	[itemno] ASC,
	[unicode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [ix_stcosttype]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [ix_stcosttype] ON [dbo].[stcosttype]
(
	[itemno] ASC,
	[unicode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_stcrtpuinv]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_stcrtpuinv] ON [dbo].[stcrtpuinv]
(
	[itemno] ASC,
	[unicode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_stdtl]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_stdtl] ON [dbo].[stdtl]
(
	[itemno] ASC,
	[unicode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [xx200xxtemp]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [xx200xxtemp] ON [dbo].[stdtl]
(
	[branch] ASC,
	[itemno] ASC,
	[unicode] ASC,
	[whno] ASC,
	[binno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_stitembc_1]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_stitembc_1] ON [dbo].[stitembc]
(
	[itemno] ASC,
	[unicode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_stitemnqati]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_stitemnqati] ON [dbo].[stitemnqati]
(
	[cmbkey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_image_name]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE UNIQUE NONCLUSTERED INDEX [IX_image_name] ON [dbo].[stitempictures]
(
	[cmbkey] ASC,
	[picture_name] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_stitemrplsd]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_stitemrplsd] ON [dbo].[stitemrp]
(
	[itemno] ASC,
	[unicode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_modelno]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_modelno] ON [dbo].[stitems]
(
	[modelno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [ix_stPriceByQty]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [ix_stPriceByQty] ON [dbo].[stPriceByQty]
(
	[itemno] ASC,
	[unicode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_stqtybc]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_stqtybc] ON [dbo].[stqtybc]
(
	[cmbkey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [AK_barcode_stunits]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE UNIQUE NONCLUSTERED INDEX [AK_barcode_stunits] ON [dbo].[stunits]
(
	[barcode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [AK_stunits]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE UNIQUE NONCLUSTERED INDEX [AK_stunits] ON [dbo].[stunits]
(
	[cmbkey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [ix_positems]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [ix_positems] ON [dbo].[stunits]
(
	[lastupdt] ASC
)
INCLUDE([name],[unicode],[itemno],[lprice1],[maxdisc1],[barcode],[scnname],[cmbkey],[mnmprice]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_ttkfile]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_ttkfile] ON [dbo].[ttkfile]
(
	[whno] ASC,
	[barcode] ASC,
	[binno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [IX_ttkfile_1]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [IX_ttkfile_1] ON [dbo].[ttkfile]
(
	[whno] ASC,
	[cmbkey] ASC,
	[binno] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [ix_ttkfile_hst]    Script Date: 2025-11-13 12:21:52 PM ******/
CREATE NONCLUSTERED INDEX [ix_ttkfile_hst] ON [dbo].[ttkfile_hst]
(
	[whno] ASC,
	[ttk_no] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO
ALTER TABLE [dbo].[apclass] ADD  CONSTRAINT [DF_apclass_rowguid]  DEFAULT (newsequentialid()) FOR [rowguid]
GO
ALTER TABLE [dbo].[apdtl] ADD  CONSTRAINT [DF_apdtl_rplct_post]  DEFAULT ((0)) FOR [rplct_post]
GO
ALTER TABLE [dbo].[apdtl] ADD  CONSTRAINT [DF_apdtl_rowguid]  DEFAULT (newsequentialid()) FOR [rowguid]
GO
ALTER TABLE [dbo].[aphdr] ADD  CONSTRAINT [DF_aphdr_rowguid]  DEFAULT (newsequentialid()) FOR [rowguid]
GO
ALTER TABLE [dbo].[aphdr] ADD  DEFAULT ('') FOR [bankref]
GO
ALTER TABLE [dbo].[aplcrmt_dt] ADD  DEFAULT ('') FOR [bname]
GO
ALTER TABLE [dbo].[aplcrmt_dt] ADD  DEFAULT ('') FOR [bbkacct]
GO
ALTER TABLE [dbo].[aplcrmt_dt] ADD  DEFAULT ('') FOR [bbank]
GO
ALTER TABLE [dbo].[aplcrmt_dt] ADD  DEFAULT ((0)) FOR [extradsc]
GO
ALTER TABLE [dbo].[aplcrmt_dt] ADD  DEFAULT ('') FOR [desctxt]
GO
ALTER TABLE [dbo].[aplcrmt_dt] ADD  DEFAULT ((0)) FOR [venderbal]
GO
ALTER TABLE [dbo].[aplcrmt_dt] ADD  DEFAULT ((0)) FOR [diffbal2]
GO
ALTER TABLE [dbo].[aplcrmt_dt] ADD  DEFAULT ((0.00)) FOR [adjval]
GO
ALTER TABLE [dbo].[Archive_Attachments] ADD  CONSTRAINT [DF_Archive_Data_FileGUID]  DEFAULT (0x00) FOR [FileGUID]
GO
ALTER TABLE [dbo].[Archive_Attachments] ADD  CONSTRAINT [DF_Archive_Data_FileExtension]  DEFAULT ('') FOR [FileExtension]
GO
ALTER TABLE [dbo].[ardtl] ADD  CONSTRAINT [DF_ardtl_rplct_post]  DEFAULT ((0)) FOR [rplct_post]
GO
ALTER TABLE [dbo].[arhdr] ADD  DEFAULT ((0)) FOR [discountedBill]
GO
ALTER TABLE [dbo].[bkacct] ADD  DEFAULT ((0)) FOR [is_credit_card_acc]
GO
ALTER TABLE [dbo].[bkacct] ADD  DEFAULT ('') FOR [cardcomm]
GO
ALTER TABLE [dbo].[bkacct] ADD  DEFAULT ('') FOR [sc_code]
GO
ALTER TABLE [dbo].[bkacct] ADD  DEFAULT ((0)) FOR [maxpkcntr]
GO
ALTER TABLE [dbo].[bkacct] ADD  DEFAULT ((0)) FOR [maxcomm]
GO
ALTER TABLE [dbo].[bkacct] ADD  DEFAULT ((0)) FOR [chrgprcnt1]
GO
ALTER TABLE [dbo].[bkacct] ADD  DEFAULT ((0)) FOR [chrgprcnt2]
GO
ALTER TABLE [dbo].[bkacct] ADD  DEFAULT ((0)) FOR [chrgprcnt3]
GO
ALTER TABLE [dbo].[bkacct] ADD  DEFAULT ((0)) FOR [chrgprcnt4]
GO
ALTER TABLE [dbo].[bkacct] ADD  DEFAULT ((0)) FOR [frmamt1]
GO
ALTER TABLE [dbo].[bkacct] ADD  DEFAULT ((0)) FOR [frmamt2]
GO
ALTER TABLE [dbo].[bkacct] ADD  DEFAULT ((0)) FOR [frmamt3]
GO
ALTER TABLE [dbo].[bkacct] ADD  DEFAULT ((0)) FOR [frmamt4]
GO
ALTER TABLE [dbo].[bkacct] ADD  DEFAULT ((0)) FOR [toamt1]
GO
ALTER TABLE [dbo].[bkacct] ADD  DEFAULT ((0)) FOR [toamt2]
GO
ALTER TABLE [dbo].[bkacct] ADD  DEFAULT ((0)) FOR [toamt3]
GO
ALTER TABLE [dbo].[bkacct] ADD  DEFAULT ((0)) FOR [toamt4]
GO
ALTER TABLE [dbo].[bkacct] ADD  DEFAULT ((0)) FOR [vat_comm_one_entry]
GO
ALTER TABLE [dbo].[BKBNFCH] ADD  CONSTRAINT [DF_BKBNFCH_dscprsnt]  DEFAULT ((0)) FOR [dscprsnt]
GO
ALTER TABLE [dbo].[BKBNFCH] ADD  CONSTRAINT [df_bkbnfch_bactive]  DEFAULT ((1)) FOR [bactive]
GO
ALTER TABLE [dbo].[BKTRANSFER] ADD  DEFAULT ((0)) FOR [mgmtcnfrm]
GO
ALTER TABLE [dbo].[bktransx] ADD  CONSTRAINT [DF_bktransx_rcvdtrn]  DEFAULT ((0)) FOR [rcvdtrn]
GO
ALTER TABLE [dbo].[bktransx] ADD  CONSTRAINT [DF_bktransx_hide_jv]  DEFAULT ((0)) FOR [hide_jv]
GO
ALTER TABLE [dbo].[bktransx] ADD  CONSTRAINT [DF_bktransx_rcvno]  DEFAULT ((0)) FOR [rcvno]
GO
ALTER TABLE [dbo].[bktransx] ADD  DEFAULT ((0)) FOR [mgmtcnfrm]
GO
ALTER TABLE [dbo].[brselected] ADD  CONSTRAINT [DF_brselected_selectd]  DEFAULT ((0)) FOR [selectd]
GO
ALTER TABLE [dbo].[brselected] ADD  CONSTRAINT [DF_brselected_newbarcode]  DEFAULT ((0)) FOR [newbarcode]
GO
ALTER TABLE [dbo].[brselected] ADD  CONSTRAINT [DF_brselected_priceupdt]  DEFAULT ((0)) FOR [priceupdt]
GO
ALTER TABLE [dbo].[brselected] ADD  CONSTRAINT [DF_brselected_noupdate]  DEFAULT ((0)) FOR [noupdate]
GO
ALTER TABLE [dbo].[brselected] ADD  DEFAULT ((0)) FOR [copydesc]
GO
ALTER TABLE [dbo].[brselected] ADD  DEFAULT ((0)) FOR [updateonlyitems]
GO
ALTER TABLE [dbo].[brxref] ADD  DEFAULT ((0)) FOR [price_2_check]
GO
ALTER TABLE [dbo].[customer] ADD  DEFAULT ('') FOR [clnt_taxcode]
GO
ALTER TABLE [dbo].[customer] ADD  DEFAULT ((0)) FOR [taxFree]
GO
ALTER TABLE [dbo].[customer] ADD  DEFAULT ('') FOR [cu_kind]
GO
ALTER TABLE [dbo].[customer] ADD  DEFAULT ((0)) FOR [ok_free]
GO
ALTER TABLE [dbo].[customer] ADD  DEFAULT ((0)) FOR [ok_no_pay]
GO
ALTER TABLE [dbo].[customer] ADD  DEFAULT ((0)) FOR [ok_no_down_payment]
GO
ALTER TABLE [dbo].[customer] ADD  DEFAULT ((0)) FOR [exduplimit]
GO
ALTER TABLE [dbo].[customer] ADD  DEFAULT ((0)) FOR [individual_clnt]
GO
ALTER TABLE [dbo].[customer] ADD  DEFAULT ((0)) FOR [cu_invdsc]
GO
ALTER TABLE [dbo].[customer] ADD  DEFAULT ('') FOR [slcode]
GO
ALTER TABLE [dbo].[customer] ADD  DEFAULT ((0)) FOR [lst_inv_excd_duedate]
GO
ALTER TABLE [dbo].[customer_ei] ADD  DEFAULT ('') FOR [Other_Scheme_Type]
GO
ALTER TABLE [dbo].[customer_ei] ADD  DEFAULT ('') FOR [client_name]
GO
ALTER TABLE [dbo].[customer_ei] ADD  DEFAULT ('') FOR [client_mobile]
GO
ALTER TABLE [dbo].[delchgdtl] ADD  DEFAULT ('1') FOR [taxtype]
GO
ALTER TABLE [dbo].[delchgdtl] ADD  DEFAULT ((0)) FOR [amtincldvat]
GO
ALTER TABLE [dbo].[delchgdtl] ADD  DEFAULT ('') FOR [vndr_name]
GO
ALTER TABLE [dbo].[delchgdtl] ADD  DEFAULT ((0)) FOR [fld3]
GO
ALTER TABLE [dbo].[delchgdtl] ADD  DEFAULT ((0)) FOR [fld4]
GO
ALTER TABLE [dbo].[delchgdtl] ADD  DEFAULT ((0)) FOR [fld5]
GO
ALTER TABLE [dbo].[delchgdtl] ADD  DEFAULT ((0)) FOR [fld6]
GO
ALTER TABLE [dbo].[delchgdtl] ADD  DEFAULT ((0)) FOR [fld7]
GO
ALTER TABLE [dbo].[delchgdtl] ADD  DEFAULT ((0)) FOR [fld8]
GO
ALTER TABLE [dbo].[delchgdtl] ADD  DEFAULT ((0)) FOR [fld9]
GO
ALTER TABLE [dbo].[delchgdtl] ADD  DEFAULT ((0)) FOR [item_vat]
GO
ALTER TABLE [dbo].[delchgdtl] ADD  DEFAULT ((0)) FOR [item_price_net]
GO
ALTER TABLE [dbo].[delchgdtl] ADD  DEFAULT ((0)) FOR [item_fq_vat]
GO
ALTER TABLE [dbo].[delchghdr] ADD  DEFAULT ((0)) FOR [pricevattype]
GO
ALTER TABLE [dbo].[delchghdr] ADD  DEFAULT ('1') FOR [clnt_kind]
GO
ALTER TABLE [dbo].[delchghdr] ADD  DEFAULT ((0)) FOR [vat_amt_rcvd]
GO
ALTER TABLE [dbo].[delchghdr] ADD  DEFAULT ((0)) FOR [vat_percent]
GO
ALTER TABLE [dbo].[delchghdr] ADD  DEFAULT ((0)) FOR [crtd_fm_batch_ref]
GO
ALTER TABLE [dbo].[delchghdr] ADD  DEFAULT ((0)) FOR [diffamount]
GO
ALTER TABLE [dbo].[delchghdr] ADD  DEFAULT ((0)) FOR [fld1]
GO
ALTER TABLE [dbo].[delchghdr] ADD  DEFAULT ((0)) FOR [fld2]
GO
ALTER TABLE [dbo].[delchghdr] ADD  DEFAULT ((0)) FOR [fld3]
GO
ALTER TABLE [dbo].[delchghdr] ADD  DEFAULT ((0)) FOR [zatca_rounding]
GO
ALTER TABLE [dbo].[expense] ADD  CONSTRAINT [DF_expense_expstatus]  DEFAULT ((1)) FOR [expstatus]
GO
ALTER TABLE [dbo].[expense] ADD  CONSTRAINT [DF_expense_expense]  DEFAULT ((1)) FOR [exptype]
GO
ALTER TABLE [dbo].[exporders_dt] ADD  CONSTRAINT [DF_exporders_dt_expaction]  DEFAULT ((0)) FOR [expaction]
GO
ALTER TABLE [dbo].[exporders_dt] ADD  CONSTRAINT [DF_exporders_dt_transfaction]  DEFAULT ((0)) FOR [transfaction]
GO
ALTER TABLE [dbo].[exporders_dt] ADD  CONSTRAINT [DF_exporders_dt_expfolio]  DEFAULT ((0)) FOR [expfolio]
GO
ALTER TABLE [dbo].[freplicate] ADD  CONSTRAINT [DF_freplicate_cmnbarcode]  DEFAULT ((0)) FOR [cmnbarcode]
GO
ALTER TABLE [dbo].[freplicate] ADD  CONSTRAINT [DF_freplicate_chgprice]  DEFAULT ((0)) FOR [chgprice]
GO
ALTER TABLE [dbo].[freplicate] ADD  CONSTRAINT [DF_freplicate_stopextract]  DEFAULT ((0)) FOR [stopextract]
GO
ALTER TABLE [dbo].[freplicate] ADD  CONSTRAINT [DF_freplicate_stopupdate]  DEFAULT ((0)) FOR [stopupdate]
GO
ALTER TABLE [dbo].[freplicate] ADD  CONSTRAINT [DF_freplicate_brtype]  DEFAULT ((1)) FOR [brtype]
GO
ALTER TABLE [dbo].[freplicate] ADD  CONSTRAINT [DF_freplicate_glnoupdate]  DEFAULT ((0)) FOR [glnoexport]
GO
ALTER TABLE [dbo].[freplicate] ADD  CONSTRAINT [DF_freplicate_arnoupdate]  DEFAULT ((0)) FOR [arnoexport]
GO
ALTER TABLE [dbo].[freplicate] ADD  CONSTRAINT [DF_freplicate_stnoupdate]  DEFAULT ((0)) FOR [stnoexport]
GO
ALTER TABLE [dbo].[freplicate] ADD  CONSTRAINT [DF_freplicate_slnoupdate]  DEFAULT ((0)) FOR [slnoexport]
GO
ALTER TABLE [dbo].[freplicate] ADD  CONSTRAINT [DF_freplicate_punoupdate]  DEFAULT ((0)) FOR [punoexport]
GO
ALTER TABLE [dbo].[freplicate] ADD  CONSTRAINT [DF_freplicate_apnoupdate]  DEFAULT ((0)) FOR [apnoexport]
GO
ALTER TABLE [dbo].[freplicate] ADD  CONSTRAINT [DF_freplicate_chknoupdate]  DEFAULT ((0)) FOR [chknoexport]
GO
ALTER TABLE [dbo].[freplicate] ADD  CONSTRAINT [DF_freplicate_itemupdate]  DEFAULT ((0)) FOR [itemupdate]
GO
ALTER TABLE [dbo].[freplicate] ADD  CONSTRAINT [DF_freplicate_localBranch]  DEFAULT ((0)) FOR [localBranch]
GO
ALTER TABLE [dbo].[fsiss_dt] ADD  CONSTRAINT [DF_fsiss_dt_folio]  DEFAULT ((0)) FOR [folio]
GO
ALTER TABLE [dbo].[fsiss_dt] ADD  CONSTRAINT [DF_fsiss_dt_qtyrcv]  DEFAULT ((0)) FOR [qtyrcv]
GO
ALTER TABLE [dbo].[fsiss_dt] ADD  CONSTRAINT [DF_fsiss_dt_qtysent]  DEFAULT ((0)) FOR [qtysent]
GO
ALTER TABLE [dbo].[fsiss_dt] ADD  CONSTRAINT [DF_fsiss_dt_qtyrsv]  DEFAULT ((0)) FOR [qtyrsv]
GO
ALTER TABLE [dbo].[fsiss_hd] ADD  CONSTRAINT [DF_fsiss_hd_ostatus]  DEFAULT ((0)) FOR [ostatus]
GO
ALTER TABLE [dbo].[fsrcv_dt] ADD  CONSTRAINT [DF_fsrcv_dt_folio]  DEFAULT ((0)) FOR [folio]
GO
ALTER TABLE [dbo].[fsrcv_dt] ADD  CONSTRAINT [DF_fsrcv_dt_qtyrcv]  DEFAULT ((0)) FOR [qtyrcv]
GO
ALTER TABLE [dbo].[fsrcv_hd] ADD  CONSTRAINT [DF_fsrcv_hd_orstatus]  DEFAULT ((0)) FOR [ostatus]
GO
ALTER TABLE [dbo].[fsrcv_hd] ADD  DEFAULT ((0)) FOR [shrt_vchr]
GO
ALTER TABLE [dbo].[fsrcv_hd] ADD  DEFAULT ((0)) FOR [excess_vchr]
GO
ALTER TABLE [dbo].[fsrcv_hd] ADD  DEFAULT ('') FOR [rcvdate]
GO
ALTER TABLE [dbo].[fsrcv_hd] ADD  DEFAULT ((0)) FOR [shrt_vchr_receipt]
GO
ALTER TABLE [dbo].[fsrcv_hd] ADD  DEFAULT ((0)) FOR [excess_vchr_receipt]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_glcurbal]  DEFAULT ((0)) FOR [glcurbal]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_glopnbal]  DEFAULT ((0)) FOR [glopnbal]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_glbal01]  DEFAULT ((0)) FOR [glbal01]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_glbal02]  DEFAULT ((0)) FOR [glbal02]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_glbal03]  DEFAULT ((0)) FOR [glbal03]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_glbal04]  DEFAULT ((0)) FOR [glbal04]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_glbal05]  DEFAULT ((0)) FOR [glbal05]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_glbal06]  DEFAULT ((0)) FOR [glbal06]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_glbal07]  DEFAULT ((0)) FOR [glbal07]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_glbal08]  DEFAULT ((0)) FOR [glbal08]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_glbal09]  DEFAULT ((0)) FOR [glbal09]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_glbal10]  DEFAULT ((0)) FOR [glbal10]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_glbal11]  DEFAULT ((0)) FOR [glbal11]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_glbal12]  DEFAULT ((0)) FOR [glbal12]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_glbal13]  DEFAULT ((0)) FOR [glbal13]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_fccurbal]  DEFAULT ((0)) FOR [fccurbal]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_fcopnbal]  DEFAULT ((0)) FOR [fcopnbal]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_fcbal01]  DEFAULT ((0)) FOR [fcbal01]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_fcbal02]  DEFAULT ((0)) FOR [fcbal02]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_fcbal03]  DEFAULT ((0)) FOR [fcbal03]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_fcbal04]  DEFAULT ((0)) FOR [fcbal04]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_fcbal05]  DEFAULT ((0)) FOR [fcbal05]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_fcbal06]  DEFAULT ((0)) FOR [fcbal06]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_fcbal07]  DEFAULT ((0)) FOR [fcbal07]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_fcbal08]  DEFAULT ((0)) FOR [fcbal08]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_fcbal09]  DEFAULT ((0)) FOR [fcbal09]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_fcbal10]  DEFAULT ((0)) FOR [fcbal10]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_fcbal11]  DEFAULT ((0)) FOR [fcbal11]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_fcbal12]  DEFAULT ((0)) FOR [fcbal12]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_fcbal13]  DEFAULT ((0)) FOR [fcbal13]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_imopnbal]  DEFAULT ((0)) FOR [imopnbal]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_imcurbal]  DEFAULT ((0)) FOR [imcurbal]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_pkey]  DEFAULT ((0)) FOR [pkey]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_chkey]  DEFAULT ((0)) FOR [chkey]
GO
ALTER TABLE [dbo].[glchart] ADD  CONSTRAINT [DF_glchart_glackind]  DEFAULT ('0') FOR [glackind]
GO
ALTER TABLE [dbo].[glcstctr] ADD  CONSTRAINT [DF_glcstctr_rowguid]  DEFAULT (newsequentialid()) FOR [rowguid]
GO
ALTER TABLE [dbo].[glcstctr] ADD  DEFAULT ((0)) FOR [xpercent]
GO
ALTER TABLE [dbo].[glcurr] ADD  DEFAULT ((0)) FOR [curminrate]
GO
ALTER TABLE [dbo].[glcurr] ADD  DEFAULT ((0)) FOR [curmaxrate]
GO
ALTER TABLE [dbo].[glcurr] ADD  DEFAULT ('') FOR [standard_fcy_code]
GO
ALTER TABLE [dbo].[gljrcost] ADD  CONSTRAINT [DF_gljrcost_rplct_post]  DEFAULT ((0)) FOR [rplct_post]
GO
ALTER TABLE [dbo].[gljrdtl] ADD  CONSTRAINT [DF_gljrdtl_rplct_post]  DEFAULT ((0)) FOR [rplct_post]
GO
ALTER TABLE [dbo].[gljrdtl] ADD  CONSTRAINT [DF_gljrdtl_rowguid]  DEFAULT (newsequentialid()) FOR [rowguid]
GO
ALTER TABLE [dbo].[gljrdtl] ADD  DEFAULT ((0)) FOR [taxcatId]
GO
ALTER TABLE [dbo].[gljrhdr] ADD  CONSTRAINT [DF_gljrhdr_jhcomp]  DEFAULT ((0)) FOR [jhcomp]
GO
ALTER TABLE [dbo].[gljrhdr] ADD  CONSTRAINT [DF_gljrhdr_jhlccrttl]  DEFAULT ((0)) FOR [jhlccrttl]
GO
ALTER TABLE [dbo].[gljrhdr] ADD  CONSTRAINT [DF_gljrhdr_jhlcdbttl]  DEFAULT ((0)) FOR [jhlcdbttl]
GO
ALTER TABLE [dbo].[gljrhdr] ADD  CONSTRAINT [DF_gljrhdr_jhfccrttl]  DEFAULT ((0)) FOR [jhfccrttl]
GO
ALTER TABLE [dbo].[gljrhdr] ADD  CONSTRAINT [DF_gljrhdr_jhfcdbttl]  DEFAULT ((0)) FOR [jhfcdbttl]
GO
ALTER TABLE [dbo].[gljrhdr] ADD  CONSTRAINT [DF_gljrhdr_jhimgrate]  DEFAULT ((0)) FOR [jhimgrate]
GO
ALTER TABLE [dbo].[gljrhdr] ADD  CONSTRAINT [DF_gljrhdr_hide_jv]  DEFAULT ((0)) FOR [hide_jv]
GO
ALTER TABLE [dbo].[gljrhdr] ADD  CONSTRAINT [DF_gljrhdr_rowguid]  DEFAULT (newsequentialid()) FOR [rowguid]
GO
ALTER TABLE [dbo].[gljrhdr] ADD  DEFAULT ('') FOR [bankref]
GO
ALTER TABLE [dbo].[gljrhdr] ADD  DEFAULT ((0)) FOR [Vat_Percent]
GO
ALTER TABLE [dbo].[gljrhdr] ADD  DEFAULT ('') FOR [jhtext1]
GO
ALTER TABLE [dbo].[gljrhdr] ADD  DEFAULT ('') FOR [sc_codeyrtp]
GO
ALTER TABLE [dbo].[gljrhdr] ADD  DEFAULT ((0)) FOR [zatca_rounding]
GO
ALTER TABLE [dbo].[glsction] ADD  CONSTRAINT [DF_glsction_sc_nowh]  DEFAULT ((1)) FOR [sc_nowh]
GO
ALTER TABLE [dbo].[glsction] ADD  CONSTRAINT [DF_glsction_sc_m_center]  DEFAULT ((0)) FOR [sc_m_center]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_01]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_02]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_03]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_04]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_05]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_06]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_07]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_08]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_09]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_10]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_11]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_12]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_13]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_14]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_18]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_19]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_20]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_21]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_22]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_23]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_24]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_26]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_27]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_28]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_30]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_31]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_32]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_33]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_34]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_45]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_46]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_16]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_17]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((1)) FOR [sysno]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [No_round_nm]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((1)) FOR [PriceVatType]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [mkt_frc_rounding]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [is_dsc_amt]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [auto_dsc_hll]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [max_dsc_hll]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((1)) FOR [sc_card_srlno]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((1)) FOR [sc_card_jvno]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ('') FOR [ar_dscser]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ('') FOR [ap_dscser]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [sc_lvlno]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ('') FOR [cashser]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [crdt_limit]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ('') FOR [sc_lvl1]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ('') FOR [sc_lvl2]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ('') FOR [sc_lvl3]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [CHKEY]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [PKEY]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_start_year_serial]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ('') FOR [sc_fxdpart]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((0)) FOR [jv_301]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((1)) FOR [jv_60]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((1)) FOR [jv_61]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((1)) FOR [jv_105]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((1)) FOR [jv_106]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((1)) FOR [jv_107]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((1)) FOR [jv_108]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((1)) FOR [jv_109]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((1)) FOR [jv_110]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((1)) FOR [jv_205]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((1)) FOR [jv_209]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((1)) FOR [jv_210]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((1)) FOR [jv_211]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((1)) FOR [jv_212]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((1)) FOR [jv_213]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((1)) FOR [jv_214]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((1)) FOR [jv_215]
GO
ALTER TABLE [dbo].[glsction] ADD  DEFAULT ((1)) FOR [jv_216]
GO
ALTER TABLE [dbo].[installment_cmp] ADD  DEFAULT ((0)) FOR [commp_notrtnd]
GO
ALTER TABLE [dbo].[installment_cmp] ADD  DEFAULT ('') FOR [ins_taxcode]
GO
ALTER TABLE [dbo].[installment_cmp] ADD  DEFAULT ((0)) FOR [api_auto_connect]
GO
ALTER TABLE [dbo].[installment_cmp] ADD  DEFAULT ((0)) FOR [is_it_production]
GO
ALTER TABLE [dbo].[installment_cmp] ADD  DEFAULT ('') FOR [what_company]
GO
ALTER TABLE [dbo].[installment_cmp] ADD  DEFAULT ('') FOR [ins_publickey]
GO
ALTER TABLE [dbo].[installment_cmp] ADD  DEFAULT ('') FOR [ins_merchant_act]
GO
ALTER TABLE [dbo].[installment_trx] ADD  DEFAULT ('') FOR [trx_buyer_name]
GO
ALTER TABLE [dbo].[installment_trx] ADD  DEFAULT ((0)) FOR [trx_commp_notrtnd]
GO
ALTER TABLE [dbo].[inventory] ADD  CONSTRAINT [DF_inventory_date]  DEFAULT (getdate()) FOR [transDate]
GO
ALTER TABLE [dbo].[invhstry] ADD  CONSTRAINT [DF_invhstry_deletedx]  DEFAULT ((0)) FOR [deletedx]
GO
ALTER TABLE [dbo].[invhstry] ADD  CONSTRAINT [DF_invhstry_retreived]  DEFAULT ((0)) FOR [retreived]
GO
ALTER TABLE [dbo].[jccstord_hdr] ADD  DEFAULT ('') FOR [slcode]
GO
ALTER TABLE [dbo].[jchdr] ADD  DEFAULT ((0)) FOR [ch_expentries1]
GO
ALTER TABLE [dbo].[jchdr] ADD  DEFAULT ((0)) FOR [ch_expttlhours1]
GO
ALTER TABLE [dbo].[jchdr] ADD  DEFAULT ((0)) FOR [ch_expttlcost1]
GO
ALTER TABLE [dbo].[jchdr] ADD  DEFAULT ((0)) FOR [ch_expentries2]
GO
ALTER TABLE [dbo].[jchdr] ADD  DEFAULT ((0)) FOR [ch_expttlhours2]
GO
ALTER TABLE [dbo].[jchdr] ADD  DEFAULT ((0)) FOR [ch_expttlcost2]
GO
ALTER TABLE [dbo].[jchdr] ADD  DEFAULT ((0)) FOR [ch_expentries3]
GO
ALTER TABLE [dbo].[jchdr] ADD  DEFAULT ((0)) FOR [ch_expttlhours3]
GO
ALTER TABLE [dbo].[jchdr] ADD  DEFAULT ((0)) FOR [ch_expttlcost3]
GO
ALTER TABLE [dbo].[jchdr] ADD  DEFAULT ('') FOR [fcy]
GO
ALTER TABLE [dbo].[jchdr] ADD  DEFAULT ((0)) FOR [fcyrate]
GO
ALTER TABLE [dbo].[jchdr] ADD  DEFAULT ((0)) FOR [ch_ttlcost_fcy]
GO
ALTER TABLE [dbo].[jchdr] ADD  DEFAULT ((0)) FOR [ch_expttlcost_fcy]
GO
ALTER TABLE [dbo].[jchdr] ADD  DEFAULT ((0)) FOR [ch_matttlcost_fcy]
GO
ALTER TABLE [dbo].[jchdr] ADD  DEFAULT ((0)) FOR [ch_untcost_fcy]
GO
ALTER TABLE [dbo].[jchdr] ADD  DEFAULT ((0)) FOR [ch_expttlcost1_fcy]
GO
ALTER TABLE [dbo].[jchdr] ADD  DEFAULT ((0)) FOR [ch_expttlcost2_fcy]
GO
ALTER TABLE [dbo].[jchdr] ADD  DEFAULT ((0)) FOR [ch_expttlcost3_fcy]
GO
ALTER TABLE [dbo].[jchdr] ADD  DEFAULT ('') FOR [section]
GO
ALTER TABLE [dbo].[jcmatdtl] ADD  DEFAULT ((0)) FOR [fcost]
GO
ALTER TABLE [dbo].[jcresources] ADD  DEFAULT ((1)) FOR [rs_level]
GO
ALTER TABLE [dbo].[jcrsrsdtl] ADD  DEFAULT ((0)) FOR [rd_hourcost_fcy]
GO
ALTER TABLE [dbo].[jcsetup] ADD  CONSTRAINT [DF__jcsetup__jc_addm__63E3BB6D]  DEFAULT ((0)) FOR [jc_addmatitm]
GO
ALTER TABLE [dbo].[jcsetup] ADD  CONSTRAINT [DF__jcsetup__jc_chgm__51C50B32]  DEFAULT ((0)) FOR [jc_chgmatqty]
GO
ALTER TABLE [dbo].[jcsetup] ADD  CONSTRAINT [DF__jcsetup__jc_chgw__52B92F6B]  DEFAULT ((0)) FOR [jc_chgwsptg]
GO
ALTER TABLE [dbo].[jcsetup] ADD  CONSTRAINT [DF__jcsetup__jc_usef__53AD53A4]  DEFAULT ((0)) FOR [jc_usefnlwste]
GO
ALTER TABLE [dbo].[jcsetup] ADD  DEFAULT ((0)) FOR [jc_seplocprdday]
GO
ALTER TABLE [dbo].[jcsetup] ADD  DEFAULT ((0)) FOR [jc_resources_cost_is_fcy]
GO
ALTER TABLE [dbo].[jcsetup] ADD  DEFAULT ('') FOR [brnno]
GO
ALTER TABLE [dbo].[jcsetup] ADD  DEFAULT ('') FOR [sc_code]
GO
ALTER TABLE [dbo].[jcstitems] ADD  DEFAULT ((0)) FOR [days_to_exp_fm_prod]
GO
ALTER TABLE [dbo].[notifyMe] ADD  CONSTRAINT [DF_notification_ref]  DEFAULT ((0)) FOR [refno]
GO
ALTER TABLE [dbo].[notifyMe] ADD  CONSTRAINT [DF_notification_folio]  DEFAULT ((0)) FOR [folio]
GO
ALTER TABLE [dbo].[notifyMe] ADD  CONSTRAINT [DF_notification_mode]  DEFAULT ((0)) FOR [mode]
GO
ALTER TABLE [dbo].[notifyMe] ADD  CONSTRAINT [DF_notification_inactive]  DEFAULT ((1)) FOR [inactive]
GO
ALTER TABLE [dbo].[notifyMe] ADD  CONSTRAINT [DF_notifyMe_smsdone]  DEFAULT ((0)) FOR [smsdone]
GO
ALTER TABLE [dbo].[notifyMe] ADD  CONSTRAINT [DF_notifyMe_emaildone]  DEFAULT ((0)) FOR [emaildone]
GO
ALTER TABLE [dbo].[notifyMe] ADD  CONSTRAINT [DF_notifyMe_ntaction]  DEFAULT ((0)) FOR [autojv]
GO
ALTER TABLE [dbo].[notifyMe] ADD  CONSTRAINT [DF_notifyMe_lastprdgnr]  DEFAULT ((0)) FOR [lastprdgnr]
GO
ALTER TABLE [dbo].[notifyMe] ADD  CONSTRAINT [DF_notifyMe_stop_jv]  DEFAULT ((0)) FOR [stop_jv]
GO
ALTER TABLE [dbo].[notifyMe] ADD  DEFAULT ((0)) FOR [expdays]
GO
ALTER TABLE [dbo].[notifyMe] ADD  DEFAULT (' ') FOR [report_id]
GO
ALTER TABLE [dbo].[notifyMe] ADD  DEFAULT ((0)) FOR [isrecursv]
GO
ALTER TABLE [dbo].[notifyMe] ADD  DEFAULT ((0)) FOR [RecursvNo]
GO
ALTER TABLE [dbo].[notifyMe] ADD  DEFAULT (' ') FOR [lstrptshwn]
GO
ALTER TABLE [dbo].[orcountry] ADD  DEFAULT ('') FOR [standard_country_code]
GO
ALTER TABLE [dbo].[ord_dtl] ADD  CONSTRAINT [DF_ord_dtl_fqty]  DEFAULT ((0)) FOR [fqty]
GO
ALTER TABLE [dbo].[ord_dtl] ADD  DEFAULT ((0)) FOR [folio]
GO
ALTER TABLE [dbo].[ord_dtl] ADD  DEFAULT ('') FOR [splyinv]
GO
ALTER TABLE [dbo].[ord_dtl] ADD  DEFAULT ('') FOR [dlvrydate]
GO
ALTER TABLE [dbo].[ord_dtl] ADD  DEFAULT ('') FOR [caser]
GO
ALTER TABLE [dbo].[ord_dtl] ADD  DEFAULT ((0)) FOR [brqty3]
GO
ALTER TABLE [dbo].[ord_dtl] ADD  DEFAULT ((0)) FOR [brqty4]
GO
ALTER TABLE [dbo].[ord_dtl] ADD  DEFAULT (' ') FOR [shadd]
GO
ALTER TABLE [dbo].[ord_dtl] ADD  DEFAULT ((0)) FOR [shdqty]
GO
ALTER TABLE [dbo].[ord_dtl] ADD  DEFAULT ((0)) FOR [frtqty]
GO
ALTER TABLE [dbo].[ord_dtl] ADD  DEFAULT ((1)) FOR [Taxtype]
GO
ALTER TABLE [dbo].[ord_dtl] ADD  DEFAULT ('') FOR [remarks]
GO
ALTER TABLE [dbo].[ord_dtl] ADD  DEFAULT ((0)) FOR [item_bal]
GO
ALTER TABLE [dbo].[ord_dtl] ADD  DEFAULT ('') FOR [mnpack0]
GO
ALTER TABLE [dbo].[ord_dtl] ADD  DEFAULT ((0)) FOR [last_ord_cost]
GO
ALTER TABLE [dbo].[ord_hdr] ADD  CONSTRAINT [DF_ord_hdr_rcvdtrn]  DEFAULT ((0)) FOR [rcvdtrn]
GO
ALTER TABLE [dbo].[ord_hdr] ADD  CONSTRAINT [df_ord_hdr_usrid]  DEFAULT ('') FOR [usrid]
GO
ALTER TABLE [dbo].[ord_hdr] ADD  DEFAULT ((0)) FOR [vat_amt_paid]
GO
ALTER TABLE [dbo].[ord_hdr] ADD  DEFAULT ((0)) FOR [PriceIncludeVat]
GO
ALTER TABLE [dbo].[ord_hdr] ADD  DEFAULT ((0)) FOR [taxfree_purchase]
GO
ALTER TABLE [dbo].[ord_hdr] ADD  DEFAULT ((0)) FOR [fqtyval]
GO
ALTER TABLE [dbo].[ord_hdr] ADD  DEFAULT ('') FOR [dlvry_date]
GO
ALTER TABLE [dbo].[ord_hdr] ADD  DEFAULT ((0)) FOR [tdscpcs]
GO
ALTER TABLE [dbo].[ord_hdr] ADD  DEFAULT ((0)) FOR [tdscdays]
GO
ALTER TABLE [dbo].[ord_hdr] ADD  DEFAULT ('') FOR [slcenter]
GO
ALTER TABLE [dbo].[ord_hdr] ADD  DEFAULT ('') FOR [slcode]
GO
ALTER TABLE [dbo].[orpacking] ADD  DEFAULT ((0)) FOR [pkwhlsl]
GO
ALTER TABLE [dbo].[orpacking] ADD  DEFAULT ('') FOR [standard_unit_code]
GO
ALTER TABLE [dbo].[orpacktp] ADD  DEFAULT ((1)) FOR [NoOfCartons]
GO
ALTER TABLE [dbo].[poitem_btn] ADD  DEFAULT ('') FOR [grp_id]
GO
ALTER TABLE [dbo].[pos_chdt] ADD  CONSTRAINT [DF__pos_chdt__sc_cod__37B03374]  DEFAULT ('') FOR [sc_code]
GO
ALTER TABLE [dbo].[pos_chhd] ADD  DEFAULT ('') FOR [sc_code]
GO
ALTER TABLE [dbo].[pos_chhd] ADD  DEFAULT ((0)) FOR [glref]
GO
ALTER TABLE [dbo].[pos_chrt] ADD  CONSTRAINT [DF_pos_chrt_saved_halals]  DEFAULT ((0)) FOR [saved_halals]
GO
ALTER TABLE [dbo].[pos_chrt] ADD  DEFAULT ('') FOR [shft_fkey]
GO
ALTER TABLE [dbo].[pos_chrt] ADD  DEFAULT ('') FOR [sc_code]
GO
ALTER TABLE [dbo].[pos_chrt] ADD  DEFAULT ('') FOR [chr_taxcode]
GO
ALTER TABLE [dbo].[pos_ctr] ADD  DEFAULT ((0)) FOR [ctrsaned]
GO
ALTER TABLE [dbo].[pos_ctr] ADD  DEFAULT ('') FOR [ctreftpos]
GO
ALTER TABLE [dbo].[pos_ctr] ADD  DEFAULT ((0)) FOR [ctrsndecrpos]
GO
ALTER TABLE [dbo].[pos_ctr] ADD  DEFAULT ((0)) FOR [eftport]
GO
ALTER TABLE [dbo].[pos_ctr] ADD  DEFAULT ('') FOR [ntk_printer1]
GO
ALTER TABLE [dbo].[pos_ctr] ADD  DEFAULT ('') FOR [ntk_printer2]
GO
ALTER TABLE [dbo].[pos_ctr] ADD  DEFAULT ((0)) FOR [grp_printers]
GO
ALTER TABLE [dbo].[pos_ctr] ADD  DEFAULT ((0)) FOR [grp_prnt_local]
GO
ALTER TABLE [dbo].[pos_ctr] ADD  DEFAULT ((0)) FOR [ctrotherpay]
GO
ALTER TABLE [dbo].[pos_ctr] ADD  DEFAULT ((0)) FOR [cshRtn_f_o_b]
GO
ALTER TABLE [dbo].[pos_ctr] ADD  DEFAULT ((0)) FOR [paybycard]
GO
ALTER TABLE [dbo].[pos_ctr] ADD  DEFAULT ((0)) FOR [CTRBKNQTPAY]
GO
ALTER TABLE [dbo].[pos_ctr] ADD  DEFAULT ('') FOR [UserCode]
GO
ALTER TABLE [dbo].[pos_ctr] ADD  DEFAULT ('') FOR [CashierCode]
GO
ALTER TABLE [dbo].[pos_ctr] ADD  DEFAULT ('') FOR [Usrpassword]
GO
ALTER TABLE [dbo].[pos_ctr] ADD  DEFAULT ('1') FOR [mnfd_system]
GO
ALTER TABLE [dbo].[pos_ctr] ADD  DEFAULT ((0)) FOR [ctrmanafith]
GO
ALTER TABLE [dbo].[pos_ctr] ADD  DEFAULT ((0)) FOR [new_secugen]
GO
ALTER TABLE [dbo].[pos_ctr] ADD  DEFAULT ((0)) FOR [ctrinstlmnt_pay]
GO
ALTER TABLE [dbo].[pos_ctr] ADD  DEFAULT ((0)) FOR [ctrcredit]
GO
ALTER TABLE [dbo].[pos_ctr] ADD  DEFAULT ((0)) FOR [alw_taxed_invoice]
GO
ALTER TABLE [dbo].[pos_dsc] ADD  CONSTRAINT [DF_pos_dsc_dsccompany]  DEFAULT ((0)) FOR [dsccompany]
GO
ALTER TABLE [dbo].[pos_dsc] ADD  CONSTRAINT [DF_pos_dsc_cust_ttlsales]  DEFAULT ((0)) FOR [cust_ttlsales]
GO
ALTER TABLE [dbo].[pos_dsc] ADD  CONSTRAINT [DF_pos_dsc_sales_grantd]  DEFAULT ((0)) FOR [sales_grantd]
GO
ALTER TABLE [dbo].[pos_dsc] ADD  CONSTRAINT [DF_pos_dsc_ttl_grantd]  DEFAULT ((0)) FOR [ttl_grantd]
GO
ALTER TABLE [dbo].[pos_dsc] ADD  CONSTRAINT [DF_pos_dsc_vchr_value]  DEFAULT ((0)) FOR [vchr_value]
GO
ALTER TABLE [dbo].[pos_dsc] ADD  CONSTRAINT [DF_pos_dsc_vchr_used]  DEFAULT ((0)) FOR [vchr_used]
GO
ALTER TABLE [dbo].[pos_dsc] ADD  CONSTRAINT [DF_pos_dsc_nqati_openbal]  DEFAULT ((0)) FOR [nqati_openbal]
GO
ALTER TABLE [dbo].[pos_dsc] ADD  DEFAULT ((0)) FOR [nodsc4promo]
GO
ALTER TABLE [dbo].[pos_dsc] ADD  DEFAULT ((0)) FOR [employees_only]
GO
ALTER TABLE [dbo].[pos_dsc] ADD  DEFAULT ((0)) FOR [no_payment]
GO
ALTER TABLE [dbo].[pos_dsc] ADD  DEFAULT ((0)) FOR [smsvrfycode]
GO
ALTER TABLE [dbo].[pos_dsc] ADD  DEFAULT ((0)) FOR [credit_client]
GO
ALTER TABLE [dbo].[pos_dsc] ADD  DEFAULT ((0)) FOR [credit_limit]
GO
ALTER TABLE [dbo].[pos_dsc] ADD  DEFAULT ((0)) FOR [pay_once_all]
GO
ALTER TABLE [dbo].[pos_dt] ADD  CONSTRAINT [DF_pos_dt_qty]  DEFAULT ((0)) FOR [qty]
GO
ALTER TABLE [dbo].[pos_dt] ADD  CONSTRAINT [DF_pos_dt_dsc_amt]  DEFAULT ((0)) FOR [dsc_amt]
GO
ALTER TABLE [dbo].[pos_dt] ADD  CONSTRAINT [DF_pos_dt_nqati_prcnt]  DEFAULT ((0)) FOR [nqati_prcnt]
GO
ALTER TABLE [dbo].[pos_dt] ADD  DEFAULT ('') FOR [scl_barcode]
GO
ALTER TABLE [dbo].[pos_dt] ADD  DEFAULT ((1)) FOR [Taxtype]
GO
ALTER TABLE [dbo].[pos_dt] ADD  DEFAULT ((0)) FOR [item_vat]
GO
ALTER TABLE [dbo].[pos_dt] ADD  DEFAULT ((0)) FOR [item_price_net]
GO
ALTER TABLE [dbo].[pos_dt] ADD  DEFAULT ((0)) FOR [invdscamt]
GO
ALTER TABLE [dbo].[pos_dtti] ADD  CONSTRAINT [DF_pos_dtti_qty]  DEFAULT ((0)) FOR [qty]
GO
ALTER TABLE [dbo].[pos_dtti] ADD  CONSTRAINT [DF_pos_dtti_rtrnd]  DEFAULT ((0)) FOR [rtrnd]
GO
ALTER TABLE [dbo].[pos_dtti] ADD  CONSTRAINT [DF_pos_dtti_dsc_amt]  DEFAULT ((0)) FOR [dsc_amt]
GO
ALTER TABLE [dbo].[pos_dtti] ADD  CONSTRAINT [DF_pos_dtti_nqati_prcnt]  DEFAULT ((0)) FOR [nqati_prcnt]
GO
ALTER TABLE [dbo].[pos_dtti] ADD  DEFAULT ((1)) FOR [Taxtype]
GO
ALTER TABLE [dbo].[POS_ei] ADD  DEFAULT ((0)) FOR [zatca_conn]
GO
ALTER TABLE [dbo].[POS_ei] ADD  DEFAULT ('') FOR [clnt_taxcode]
GO
ALTER TABLE [dbo].[pos_hd] ADD  DEFAULT ((0)) FOR [frc_rtncash]
GO
ALTER TABLE [dbo].[pos_hd] ADD  DEFAULT ((0)) FOR [saned_amt]
GO
ALTER TABLE [dbo].[pos_hd] ADD  DEFAULT ((0)) FOR [dfvchramt]
GO
ALTER TABLE [dbo].[pos_hd] ADD  DEFAULT ((0)) FOR [vat_amt_rcvd]
GO
ALTER TABLE [dbo].[pos_hd] ADD  DEFAULT ((0)) FOR [taxfree_sales]
GO
ALTER TABLE [dbo].[pos_hd] ADD  DEFAULT ((0)) FOR [discamt]
GO
ALTER TABLE [dbo].[pos_hd] ADD  DEFAULT ((0)) FOR [No_round_nm]
GO
ALTER TABLE [dbo].[pos_hd] ADD  DEFAULT ((1)) FOR [PriceVatType]
GO
ALTER TABLE [dbo].[pos_hd] ADD  DEFAULT ((0)) FOR [CashDsc4RtnPrepaid]
GO
ALTER TABLE [dbo].[pos_hd] ADD  DEFAULT ((0)) FOR [stcpay_amt]
GO
ALTER TABLE [dbo].[pos_hd] ADD  DEFAULT ((0)) FOR [outside_order]
GO
ALTER TABLE [dbo].[pos_hd] ADD  DEFAULT ((0)) FOR [qitaf_amt]
GO
ALTER TABLE [dbo].[pos_hd] ADD  DEFAULT ((0)) FOR [whlslinv]
GO
ALTER TABLE [dbo].[pos_hd] ADD  DEFAULT ((0)) FOR [vat_percent]
GO
ALTER TABLE [dbo].[pos_hd] ADD  DEFAULT ((0)) FOR [usrid]
GO
ALTER TABLE [dbo].[pos_hd] ADD  DEFAULT ((0)) FOR [paybycard]
GO
ALTER TABLE [dbo].[pos_hd] ADD  DEFAULT ((0)) FOR [bk_amount]
GO
ALTER TABLE [dbo].[pos_hd] ADD  DEFAULT ((0)) FOR [deleted_geninv]
GO
ALTER TABLE [dbo].[pos_hd] ADD  DEFAULT ('') FOR [slcode]
GO
ALTER TABLE [dbo].[pos_hd] ADD  DEFAULT ((0)) FOR [inv_copies_no]
GO
ALTER TABLE [dbo].[pos_hd] ADD  DEFAULT ('') FOR [chrty_code]
GO
ALTER TABLE [dbo].[pos_hd] ADD  DEFAULT ((0)) FOR [installment_amt]
GO
ALTER TABLE [dbo].[pos_hd] ADD  DEFAULT ((0)) FOR [zatca_rounding]
GO
ALTER TABLE [dbo].[pos_hdti] ADD  CONSTRAINT [DF__pos_hdti__saned___62CF9BA3]  DEFAULT ((0)) FOR [saned_amt]
GO
ALTER TABLE [dbo].[pos_hdti] ADD  CONSTRAINT [DF__pos_hdti__rtncsh__63C3BFDC]  DEFAULT ((0)) FOR [rtncshamt]
GO
ALTER TABLE [dbo].[pos_hdti] ADD  CONSTRAINT [DF__pos_hdti__dfvchr__64B7E415]  DEFAULT ((0)) FOR [dfvchramt]
GO
ALTER TABLE [dbo].[pos_hdti] ADD  CONSTRAINT [DF_pos_hdti_taken]  DEFAULT ((0)) FOR [invstatus]
GO
ALTER TABLE [dbo].[pos_hdti] ADD  DEFAULT ((0)) FOR [vat_amt_rcvd]
GO
ALTER TABLE [dbo].[pos_hdti] ADD  DEFAULT ((0)) FOR [taxfree_sales]
GO
ALTER TABLE [dbo].[pos_hdti] ADD  DEFAULT ((0)) FOR [hlldscnt]
GO
ALTER TABLE [dbo].[pos_hdti] ADD  DEFAULT ((0)) FOR [discamt]
GO
ALTER TABLE [dbo].[pos_hdti] ADD  DEFAULT ((0)) FOR [No_round_nm]
GO
ALTER TABLE [dbo].[pos_hdti] ADD  DEFAULT ((1)) FOR [PriceVatType]
GO
ALTER TABLE [dbo].[pos_hdti] ADD  DEFAULT ((0)) FOR [stcpay_amt]
GO
ALTER TABLE [dbo].[pos_hdti] ADD  DEFAULT ((0)) FOR [Qitaf_amt]
GO
ALTER TABLE [dbo].[pos_hdti] ADD  DEFAULT ((0)) FOR [outside_order]
GO
ALTER TABLE [dbo].[pos_hdti] ADD  DEFAULT ((0)) FOR [vat_percent]
GO
ALTER TABLE [dbo].[pos_mny] ADD  DEFAULT ((0)) FOR [saned_amt]
GO
ALTER TABLE [dbo].[pos_mny] ADD  DEFAULT ((0)) FOR [scsaned_amt]
GO
ALTER TABLE [dbo].[pos_mny] ADD  DEFAULT ((0)) FOR [fiveh]
GO
ALTER TABLE [dbo].[pos_mny] ADD  DEFAULT ((0)) FOR [tenh]
GO
ALTER TABLE [dbo].[pos_mny] ADD  DEFAULT ((0)) FOR [twntyfiveh]
GO
ALTER TABLE [dbo].[pos_mny] ADD  DEFAULT ((0)) FOR [fiftyh]
GO
ALTER TABLE [dbo].[pos_mny] ADD  DEFAULT ((0)) FOR [stcpay_amt]
GO
ALTER TABLE [dbo].[pos_mny] ADD  DEFAULT ((0)) FOR [Qitaf_amt]
GO
ALTER TABLE [dbo].[pos_slp] ADD  CONSTRAINT [DF_pos_slp_catch_thief]  DEFAULT ((0)) FOR [catch_thief]
GO
ALTER TABLE [dbo].[pos_slp] ADD  CONSTRAINT [DF_pos_slp_sold_once]  DEFAULT ((0)) FOR [sold_once]
GO
ALTER TABLE [dbo].[pos_slp] ADD  CONSTRAINT [DF_pos_slp_only_scan_bc]  DEFAULT ((0)) FOR [only_scan_bc]
GO
ALTER TABLE [dbo].[pos_slp] ADD  CONSTRAINT [DF_pos_slp_stop_item_column]  DEFAULT ((0)) FOR [stop_item_column]
GO
ALTER TABLE [dbo].[pos_slp] ADD  CONSTRAINT [DF_pos_slp_salesquota]  DEFAULT ((0)) FOR [salesquota]
GO
ALTER TABLE [dbo].[pos_slp] ADD  CONSTRAINT [DF_pos_slp_commissionP]  DEFAULT ((0)) FOR [commissionP]
GO
ALTER TABLE [dbo].[pos_slp] ADD  CONSTRAINT [DF_pos_slp_bonus]  DEFAULT ((0)) FOR [bonus]
GO
ALTER TABLE [dbo].[pos_slp] ADD  CONSTRAINT [DF_pos_slp_supervisor]  DEFAULT ((0)) FOR [supervisor]
GO
ALTER TABLE [dbo].[pos_slp] ADD  DEFAULT ((0)) FOR [ReadInvByBarcd]
GO
ALTER TABLE [dbo].[pos_slp] ADD  DEFAULT ((0)) FOR [alwcshcardpay]
GO
ALTER TABLE [dbo].[pos_slp] ADD  DEFAULT ((0)) FOR [alwrtncash]
GO
ALTER TABLE [dbo].[pos_slp] ADD  DEFAULT ((0)) FOR [alwmtchrtn]
GO
ALTER TABLE [dbo].[pos_slp] ADD  DEFAULT ((0)) FOR [alwinvtrnsfr]
GO
ALTER TABLE [dbo].[pos_slp] ADD  DEFAULT ((0)) FOR [alwprnttmpinv]
GO
ALTER TABLE [dbo].[pos_slp] ADD  DEFAULT ((0)) FOR [ignore_mnmprice]
GO
ALTER TABLE [dbo].[pos_slp] ADD  DEFAULT ((0)) FOR [NoExceed_hll]
GO
ALTER TABLE [dbo].[pos_slp] ADD  DEFAULT ((0)) FOR [showallsuspndinv]
GO
ALTER TABLE [dbo].[pos_slp] ADD  DEFAULT ('') FOR [slpfpimage2]
GO
ALTER TABLE [dbo].[pos_slp] ADD  DEFAULT ((0)) FOR [nodelchgmny]
GO
ALTER TABLE [dbo].[pos_slp] ADD  DEFAULT ((0)) FOR [delitmbybrcd]
GO
ALTER TABLE [dbo].[pos_slp] ADD  DEFAULT ((0)) FOR [noinvprint_atsave]
GO
ALTER TABLE [dbo].[pos_slp] ADD  DEFAULT ((0)) FOR [No_item_srch_in_inv]
GO
ALTER TABLE [dbo].[pos_slp] ADD  DEFAULT ((0)) FOR [No_dsc_if_no_mobile]
GO
ALTER TABLE [dbo].[pos_slp] ADD  DEFAULT ((0)) FOR [alwexcdmaxqty]
GO
ALTER TABLE [dbo].[pos_slp] ADD  DEFAULT ((0)) FOR [alwcsh_rtrn_L2yr]
GO
ALTER TABLE [dbo].[poscccard] ADD  CONSTRAINT [DF_poscccard_cardtype]  DEFAULT ((0)) FOR [cardtype]
GO
ALTER TABLE [dbo].[poscccard] ADD  CONSTRAINT [DF_poscccard_ccconus]  DEFAULT ((0)) FOR [ccconus]
GO
ALTER TABLE [dbo].[poscccard] ADD  CONSTRAINT [DF_poscccard_chargepctg]  DEFAULT ((0)) FOR [chargepctg]
GO
ALTER TABLE [dbo].[poscccard] ADD  CONSTRAINT [DF_poscccard_chargeamt]  DEFAULT ((0)) FOR [chargeamt]
GO
ALTER TABLE [dbo].[poschrtinv] ADD  CONSTRAINT [DF_poschrtinv_hllamt]  DEFAULT ((0)) FOR [hllamt]
GO
ALTER TABLE [dbo].[posdlvry] ADD  DEFAULT ((0)) FOR [room_no]
GO
ALTER TABLE [dbo].[posdlvry] ADD  DEFAULT ((0)) FOR [table_no]
GO
ALTER TABLE [dbo].[posfcamt] ADD  CONSTRAINT [DF_posfcamt_fcamt]  DEFAULT ((0)) FOR [fcamt]
GO
ALTER TABLE [dbo].[posfcamt] ADD  CONSTRAINT [DF_posfcamt_fcyrate]  DEFAULT ((0)) FOR [fcyrate]
GO
ALTER TABLE [dbo].[posinstlmnt_trx] ADD  DEFAULT ((0)) FOR [api_auto_connect]
GO
ALTER TABLE [dbo].[posinstlmnt_trx] ADD  DEFAULT ((0)) FOR [installment_amt_rtn]
GO
ALTER TABLE [dbo].[posinstlmnt_trx] ADD  DEFAULT ('') FOR [trx_request_id]
GO
ALTER TABLE [dbo].[posinstlmnt_trx] ADD  DEFAULT ((0)) FOR [trx_send_latin]
GO
ALTER TABLE [dbo].[posinstlmnt_trx] ADD  DEFAULT ((0)) FOR [trx_is_production]
GO
ALTER TABLE [dbo].[posinvoffer] ADD  DEFAULT ((0)) FOR [Max2buy]
GO
ALTER TABLE [dbo].[posinvoffer] ADD  DEFAULT ((0)) FOR [grp_min_qty]
GO
ALTER TABLE [dbo].[posinvoffer] ADD  DEFAULT ((0)) FOR [grp_partial]
GO
ALTER TABLE [dbo].[posinvoffer] ADD  DEFAULT ((0)) FOR [grp_no]
GO
ALTER TABLE [dbo].[posinvoffer] ADD  DEFAULT ((0)) FOR [offer_no]
GO
ALTER TABLE [dbo].[posinvoffer] ADD  DEFAULT ((0)) FOR [grp_flexable]
GO
ALTER TABLE [dbo].[posmnfthcard] ADD  DEFAULT ((0)) FOR [mn_vat_amt]
GO
ALTER TABLE [dbo].[posmnfthcard] ADD  DEFAULT ('') FOR [requestid]
GO
ALTER TABLE [dbo].[posppcard] ADD  CONSTRAINT [DF_posppcard_paytype]  DEFAULT ((0)) FOR [paytype]
GO
ALTER TABLE [dbo].[posppcard] ADD  DEFAULT ((0)) FOR [nodsc4promo]
GO
ALTER TABLE [dbo].[posrtninv] ADD  CONSTRAINT [DF_posrtninv_rtnamt]  DEFAULT ((0)) FOR [rtnamt]
GO
ALTER TABLE [dbo].[pp_leave_settlments] ADD  DEFAULT ((0)) FOR [rqstd_normal_days]
GO
ALTER TABLE [dbo].[pp_leave_settlments] ADD  DEFAULT ((0)) FOR [approved_normal_days]
GO
ALTER TABLE [dbo].[pp_leave_settlments] ADD  DEFAULT (' ') FOR [normal_lv_from]
GO
ALTER TABLE [dbo].[pp_leave_settlments] ADD  DEFAULT (' ') FOR [normal_lv_to]
GO
ALTER TABLE [dbo].[pp_leave_settlments] ADD  DEFAULT ((0)) FOR [rqstd_wopay_days]
GO
ALTER TABLE [dbo].[pp_leave_settlments] ADD  DEFAULT ((0)) FOR [approved_wopay_days]
GO
ALTER TABLE [dbo].[pp_leave_settlments] ADD  DEFAULT (' ') FOR [wopay_lv_from]
GO
ALTER TABLE [dbo].[pp_leave_settlments] ADD  DEFAULT (' ') FOR [wopay_lv_to]
GO
ALTER TABLE [dbo].[ppapsal] ADD  DEFAULT ((0.00)) FOR [no_of_hours]
GO
ALTER TABLE [dbo].[ppbank] ADD  DEFAULT ((0.00)) FOR [b_xfrcomm]
GO
ALTER TABLE [dbo].[ppcgrp] ADD  DEFAULT ('') FOR [namee]
GO
ALTER TABLE [dbo].[ppchld] ADD  DEFAULT ('') FOR [only_group]
GO
ALTER TABLE [dbo].[ppcinstd] ADD  DEFAULT ((0)) FOR [ok_ddct]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d1_sprt_timing]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d1_state_time]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d1_end_time]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d1_l_limit]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d1_maxlatein]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d1_maxearlyout]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d1_h_limit]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d1_freelate]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d1_f_late_lmt]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d2_sprt_timing]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d2_state_time]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d2_end_time]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d2_l_limit]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d2_maxlatein]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d2_maxearlyout]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d2_h_limit]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d2_freelate]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d2_f_late_lmt]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d3_sprt_timing]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d3_state_time]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d3_end_time]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d3_l_limit]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d3_maxlatein]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d3_maxearlyout]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d3_h_limit]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d3_freelate]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d3_f_late_lmt]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d4_sprt_timing]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d4_state_time]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d4_end_time]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d4_l_limit]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d4_maxlatein]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d4_maxearlyout]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d4_h_limit]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d4_freelate]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d4_f_late_lmt]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d5_sprt_timing]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d5_state_time]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d5_end_time]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d5_l_limit]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d5_maxlatein]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d5_maxearlyout]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d5_h_limit]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d5_freelate]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d5_f_late_lmt]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d6_sprt_timing]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d6_state_time]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d6_end_time]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d6_l_limit]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d6_maxlatein]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d6_maxearlyout]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d6_h_limit]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d6_freelate]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d6_f_late_lmt]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d7_sprt_timing]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d7_state_time]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d7_end_time]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d7_l_limit]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d7_maxlatein]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d7_maxearlyout]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d7_h_limit]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d7_freelate]
GO
ALTER TABLE [dbo].[ppcrgt] ADD  DEFAULT ((0)) FOR [d7_f_late_lmt]
GO
ALTER TABLE [dbo].[ppctax] ADD  DEFAULT ('') FOR [taxlname]
GO
ALTER TABLE [dbo].[ppdept] ADD  DEFAULT ('') FOR [entertype]
GO
ALTER TABLE [dbo].[ppdept] ADD  DEFAULT ('') FOR [exittype]
GO
ALTER TABLE [dbo].[ppdept] ADD  DEFAULT ('') FOR [timing_1]
GO
ALTER TABLE [dbo].[ppdept] ADD  DEFAULT ('') FOR [timing_2]
GO
ALTER TABLE [dbo].[ppdept] ADD  DEFAULT ('') FOR [timing_3]
GO
ALTER TABLE [dbo].[ppdept] ADD  DEFAULT ('') FOR [dp_lname]
GO
ALTER TABLE [dbo].[ppdept] ADD  DEFAULT ('') FOR [dp_slrydue_ac]
GO
ALTER TABLE [dbo].[ppdept] ADD  DEFAULT ('') FOR [dp_slryxpns_ac]
GO
ALTER TABLE [dbo].[ppdept] ADD  DEFAULT ('') FOR [dp_allowncxpns_ac]
GO
ALTER TABLE [dbo].[ppdept] ADD  DEFAULT ('') FOR [dp_ovtmxpns_ac]
GO
ALTER TABLE [dbo].[ppdept] ADD  DEFAULT ('') FOR [dp_rwrdsxpns_ac]
GO
ALTER TABLE [dbo].[ppdept] ADD  DEFAULT ('') FOR [dp_socinsurxpns_ac]
GO
ALTER TABLE [dbo].[ppdept] ADD  DEFAULT ('') FOR [dp_absence_ac]
GO
ALTER TABLE [dbo].[ppdept] ADD  DEFAULT ('') FOR [dp_late_ac]
GO
ALTER TABLE [dbo].[ppdept] ADD  DEFAULT ('') FOR [dp_pnshmnt_ac]
GO
ALTER TABLE [dbo].[ppdept] ADD  DEFAULT ('') FOR [dp_socinsurance_ac]
GO
ALTER TABLE [dbo].[ppdhld] ADD  DEFAULT ((0)) FOR [paid_salary_ptg]
GO
ALTER TABLE [dbo].[ppdhld] ADD  DEFAULT ((0)) FOR [public_hdays]
GO
ALTER TABLE [dbo].[ppdhld] ADD  DEFAULT ((0)) FOR [fst_day_hlfdy_lv]
GO
ALTER TABLE [dbo].[ppdloan] ADD  DEFAULT ((0)) FOR [rq_id]
GO
ALTER TABLE [dbo].[ppemp] ADD  DEFAULT (' ') FOR [iq_xfr_dt]
GO
ALTER TABLE [dbo].[ppemp] ADD  DEFAULT ((0.00)) FOR [saned_amt]
GO
ALTER TABLE [dbo].[ppemp] ADD  DEFAULT ('') FOR [sis_comp]
GO
ALTER TABLE [dbo].[ppemp] ADD  DEFAULT ((0)) FOR [punch1_nolate]
GO
ALTER TABLE [dbo].[ppemp] ADD  DEFAULT ('') FOR [timing_3]
GO
ALTER TABLE [dbo].[ppemp] ADD  DEFAULT ((0)) FOR [no_abs_multiple]
GO
ALTER TABLE [dbo].[ppemp] ADD  DEFAULT (' ') FOR [leavopen_stlmnt_date]
GO
ALTER TABLE [dbo].[ppemp] ADD  DEFAULT ((0)) FOR [tickets_amount]
GO
ALTER TABLE [dbo].[ppemp] ADD  DEFAULT ((0)) FOR [tickets_months]
GO
ALTER TABLE [dbo].[ppemp] ADD  DEFAULT (' ') FOR [sal_upto]
GO
ALTER TABLE [dbo].[pphdr] ADD  DEFAULT ((0)) FOR [phcmp_socamt]
GO
ALTER TABLE [dbo].[pphdr] ADD  DEFAULT ((0)) FOR [phttlnet_salry]
GO
ALTER TABLE [dbo].[ppinout] ADD  DEFAULT ((0)) FOR [pos_whours]
GO
ALTER TABLE [dbo].[ppinout] ADD  DEFAULT ((0)) FOR [hour_salary]
GO
ALTER TABLE [dbo].[ppinout] ADD  DEFAULT ('') FOR [emp_day_work]
GO
ALTER TABLE [dbo].[ppinout] ADD  DEFAULT ('') FOR [period_no]
GO
ALTER TABLE [dbo].[ppinout] ADD  DEFAULT ((0)) FOR [no_absmultiple]
GO
ALTER TABLE [dbo].[ppinout] ADD  DEFAULT (' ') FOR [grp]
GO
ALTER TABLE [dbo].[ppinoutm] ADD  DEFAULT ((0)) FOR [f_day_cut]
GO
ALTER TABLE [dbo].[ppinoutm] ADD  DEFAULT ((0)) FOR [f_Hday_cut]
GO
ALTER TABLE [dbo].[ppinoutm] ADD  DEFAULT ((0)) FOR [punch1_halflate]
GO
ALTER TABLE [dbo].[ppinoutm] ADD  DEFAULT ((0)) FOR [f_day_free]
GO
ALTER TABLE [dbo].[ppinoutm] ADD  DEFAULT ((0)) FOR [mnth_days]
GO
ALTER TABLE [dbo].[ppinoutm] ADD  DEFAULT ((0)) FOR [f_allovrtime]
GO
ALTER TABLE [dbo].[ppinoutm] ADD  DEFAULT ((0)) FOR [ok_off_day_attendance]
GO
ALTER TABLE [dbo].[ppsal] ADD  DEFAULT ((0.00)) FOR [saned_amt]
GO
ALTER TABLE [dbo].[ppsal] ADD  DEFAULT ((0)) FOR [late_amt]
GO
ALTER TABLE [dbo].[ppsal] ADD  DEFAULT ((0)) FOR [over_amt]
GO
ALTER TABLE [dbo].[ppsal] ADD  DEFAULT ((0)) FOR [days_abs_join]
GO
ALTER TABLE [dbo].[ppsal] ADD  DEFAULT ((0)) FOR [late_abs]
GO
ALTER TABLE [dbo].[ppsal] ADD  DEFAULT ('') FOR [saldate2]
GO
ALTER TABLE [dbo].[ppsal] ADD  DEFAULT ((0)) FOR [leav_abs_days]
GO
ALTER TABLE [dbo].[ppsal] ADD  DEFAULT ((0)) FOR [normleav_2]
GO
ALTER TABLE [dbo].[ppsal] ADD  DEFAULT ((0.00)) FOR [added_hrs_06]
GO
ALTER TABLE [dbo].[ppsal] ADD  DEFAULT ((0.00)) FOR [added_amt_06]
GO
ALTER TABLE [dbo].[ppsal] ADD  DEFAULT ((0.00)) FOR [added_amt_06_tax]
GO
ALTER TABLE [dbo].[ppsal] ADD  DEFAULT ((0.00)) FOR [added_amt_06_social]
GO
ALTER TABLE [dbo].[ppsal] ADD  DEFAULT ((0.00)) FOR [ddctd_hrs_06]
GO
ALTER TABLE [dbo].[ppsal] ADD  DEFAULT ((0.00)) FOR [ddctd_amt_06]
GO
ALTER TABLE [dbo].[ppsal] ADD  DEFAULT ((0.00)) FOR [ddctd_amt_06_tax]
GO
ALTER TABLE [dbo].[ppsal] ADD  DEFAULT ((0.00)) FOR [ddctd_amt_06_social]
GO
ALTER TABLE [dbo].[ppsetup] ADD  CONSTRAINT [DF__ppsetup__ok_sane__255C790F]  DEFAULT ((0)) FOR [ok_saned]
GO
ALTER TABLE [dbo].[ppsetup] ADD  CONSTRAINT [DF__ppsetup__f_Hday___26509D48]  DEFAULT ((0)) FOR [f_Hday_cut]
GO
ALTER TABLE [dbo].[ppsetup] ADD  CONSTRAINT [DF__ppsetup__punch1___2744C181]  DEFAULT ((0)) FOR [punch1_halflate]
GO
ALTER TABLE [dbo].[ppsetup] ADD  CONSTRAINT [DF__ppsetup__use_dai__2838E5BA]  DEFAULT ((0)) FOR [use_daily_salary]
GO
ALTER TABLE [dbo].[ppsetup] ADD  CONSTRAINT [DF__ppsetup__leave_u__292D09F3]  DEFAULT ((0)) FOR [leave_up_to_185]
GO
ALTER TABLE [dbo].[ppsetup] ADD  CONSTRAINT [DF__ppsetup__three_p__2A212E2C]  DEFAULT ((0)) FOR [three_periods_attendance]
GO
ALTER TABLE [dbo].[ppsetup] ADD  CONSTRAINT [DF__ppsetup__ok_off___2B155265]  DEFAULT ((0)) FOR [ok_off_day_attendance]
GO
ALTER TABLE [dbo].[ppsetup] ADD  CONSTRAINT [DF__ppsetup__res_all__6A5BAED2]  DEFAULT ('') FOR [res_allow_code]
GO
ALTER TABLE [dbo].[ppsetup] ADD  CONSTRAINT [DF__ppsetup__leave_b__6E2C3FB6]  DEFAULT ((0)) FOR [leave_below_bal]
GO
ALTER TABLE [dbo].[ppsetup] ADD  CONSTRAINT [DF__ppsetup__abs_mlt__6F2063EF]  DEFAULT ((0)) FOR [abs_mltiple_max]
GO
ALTER TABLE [dbo].[ppsetup] ADD  CONSTRAINT [DF__ppsetup__trans_a__76C185B7]  DEFAULT ('') FOR [trans_allow_code]
GO
ALTER TABLE [dbo].[ppsetup] ADD  CONSTRAINT [DF__ppsetup__last_at__041B80D5]  DEFAULT ((26)) FOR [last_att_trans_day]
GO
ALTER TABLE [dbo].[ppsetup] ADD  CONSTRAINT [DF__ppsetup__comp_fo__135DC465]  DEFAULT ((0)) FOR [comp_foremp_ptg]
GO
ALTER TABLE [dbo].[ppwarnings] ADD  DEFAULT ((0)) FOR [w_use_vcode]
GO
ALTER TABLE [dbo].[ppwarnings] ADD  DEFAULT ('') FOR [w_vcode]
GO
ALTER TABLE [dbo].[ppwarnings] ADD  DEFAULT ('') FOR [w_pnlty_type]
GO
ALTER TABLE [dbo].[ppwarnings] ADD  DEFAULT ((0)) FOR [w_pnlty_hdptg]
GO
ALTER TABLE [dbo].[ppwarnings] ADD  DEFAULT ('') FOR [gnrtd_maintype]
GO
ALTER TABLE [dbo].[ppwarnings] ADD  DEFAULT ((0)) FOR [gnrtd_ref]
GO
ALTER TABLE [dbo].[ppwarnings] ADD  DEFAULT ((0)) FOR [rcvdtrn]
GO
ALTER TABLE [dbo].[ppwarnings] ADD  DEFAULT ('') FOR [lastupdt]
GO
ALTER TABLE [dbo].[ppwarnings] ADD  DEFAULT ('') FOR [usrid]
GO
ALTER TABLE [dbo].[ppxfr] ADD  DEFAULT ((1)) FOR [xfr_type]
GO
ALTER TABLE [dbo].[ppxfr] ADD  DEFAULT (' ') FOR [usrid]
GO
ALTER TABLE [dbo].[pricehst] ADD  CONSTRAINT [DF_pricehst_promotion]  DEFAULT ((0)) FOR [promotion]
GO
ALTER TABLE [dbo].[pricehst] ADD  DEFAULT ('') FOR [barcode]
GO
ALTER TABLE [dbo].[pudept] ADD  DEFAULT ('') FOR [vat_paid_act]
GO
ALTER TABLE [dbo].[pudept] ADD  DEFAULT ((0)) FOR [chk_serfrt]
GO
ALTER TABLE [dbo].[pudept] ADD  DEFAULT ((0)) FOR [chk_serins]
GO
ALTER TABLE [dbo].[pudept] ADD  DEFAULT ((0)) FOR [chk_sercst]
GO
ALTER TABLE [dbo].[pudept] ADD  DEFAULT ((0)) FOR [chk_serpvl]
GO
ALTER TABLE [dbo].[pudept] ADD  DEFAULT ((0)) FOR [chk_sersmp]
GO
ALTER TABLE [dbo].[pudept] ADD  DEFAULT ((0)) FOR [chk_serfn]
GO
ALTER TABLE [dbo].[pudept] ADD  DEFAULT ((0)) FOR [chk_sertkt]
GO
ALTER TABLE [dbo].[pudept] ADD  DEFAULT ((0)) FOR [chk_serfre]
GO
ALTER TABLE [dbo].[pudept] ADD  DEFAULT ((0)) FOR [chk_sertrn]
GO
ALTER TABLE [dbo].[pudept] ADD  DEFAULT ((0)) FOR [chk_seroth]
GO
ALTER TABLE [dbo].[pudept] ADD  DEFAULT ((0)) FOR [suspended]
GO
ALTER TABLE [dbo].[pudept] ADD  DEFAULT ('') FOR [servndr]
GO
ALTER TABLE [dbo].[pudtl] ADD  CONSTRAINT [DF_pudtl_folio]  DEFAULT ((0)) FOR [folio]
GO
ALTER TABLE [dbo].[pudtl] ADD  CONSTRAINT [DF_pudtl_rplct_post]  DEFAULT ((0)) FOR [rplct_post]
GO
ALTER TABLE [dbo].[pudtl] ADD  DEFAULT ('') FOR [whno]
GO
ALTER TABLE [dbo].[pudtl] ADD  DEFAULT ('') FOR [splyinv]
GO
ALTER TABLE [dbo].[pudtl] ADD  DEFAULT ((0)) FOR [edm_value]
GO
ALTER TABLE [dbo].[pudtl] ADD  DEFAULT ((0)) FOR [garntee_amt]
GO
ALTER TABLE [dbo].[pudtl] ADD  DEFAULT ((1)) FOR [Taxtype]
GO
ALTER TABLE [dbo].[pudtl] ADD  DEFAULT ((0)) FOR [item_vat]
GO
ALTER TABLE [dbo].[pudtl] ADD  DEFAULT ((0)) FOR [item_price_net]
GO
ALTER TABLE [dbo].[pudtl] ADD  DEFAULT ((0)) FOR [item_fq_vat]
GO
ALTER TABLE [dbo].[pudtl] ADD  DEFAULT ((0)) FOR [invdscamt]
GO
ALTER TABLE [dbo].[pudtl] ADD  DEFAULT ((0)) FOR [dsc_amt]
GO
ALTER TABLE [dbo].[puhdr] ADD  DEFAULT ('') FOR [shpdate]
GO
ALTER TABLE [dbo].[puhdr] ADD  DEFAULT ((1)) FOR [edm]
GO
ALTER TABLE [dbo].[puhdr] ADD  DEFAULT ((0)) FOR [gntd_fm_lc]
GO
ALTER TABLE [dbo].[puhdr] ADD  DEFAULT ((0.00)) FOR [lc_ship_no]
GO
ALTER TABLE [dbo].[puhdr] ADD  DEFAULT ((0)) FOR [xfr_amt]
GO
ALTER TABLE [dbo].[puhdr] ADD  DEFAULT ('') FOR [xfr_acc]
GO
ALTER TABLE [dbo].[puhdr] ADD  DEFAULT ((0)) FOR [vat_amt_paid]
GO
ALTER TABLE [dbo].[puhdr] ADD  DEFAULT ((0)) FOR [taxfree_purchase]
GO
ALTER TABLE [dbo].[puhdr] ADD  DEFAULT ((0)) FOR [VatNot4Vender]
GO
ALTER TABLE [dbo].[puhdr] ADD  DEFAULT ('') FOR [vndr_taxcode]
GO
ALTER TABLE [dbo].[puhdr] ADD  DEFAULT ((0)) FOR [expns4vat]
GO
ALTER TABLE [dbo].[puhdr] ADD  DEFAULT ('') FOR [tax_Pd_mthd]
GO
ALTER TABLE [dbo].[puhdr] ADD  DEFAULT ('') FOR [vndr_kind]
GO
ALTER TABLE [dbo].[puhdr] ADD  DEFAULT ((0)) FOR [manulvat]
GO
ALTER TABLE [dbo].[puhdr] ADD  DEFAULT ((0)) FOR [dscamt_type]
GO
ALTER TABLE [dbo].[puhdr] ADD  DEFAULT ((0)) FOR [hlldscnt]
GO
ALTER TABLE [dbo].[puhdr] ADD  DEFAULT ((0)) FOR [PriceIncludeVat]
GO
ALTER TABLE [dbo].[puhdr] ADD  DEFAULT ((0)) FOR [vat_percent]
GO
ALTER TABLE [dbo].[puhdr] ADD  DEFAULT ((0)) FOR [fqtyval]
GO
ALTER TABLE [dbo].[puhdr] ADD  DEFAULT ((0)) FOR [chng_item_price]
GO
ALTER TABLE [dbo].[puhdr] ADD  DEFAULT ((0)) FOR [zatca_rounding]
GO
ALTER TABLE [dbo].[puhdr] ADD  DEFAULT ((0)) FOR [unincld_vndr_expns]
GO
ALTER TABLE [dbo].[puhdr] ADD  DEFAULT ((0)) FOR [is_pu_dsc_amt]
GO
ALTER TABLE [dbo].[puprsnitems] ADD  CONSTRAINT [DF__puprsnite__slcod__3BCADD1B]  DEFAULT ('') FOR [slcode]
GO
ALTER TABLE [dbo].[puprsnitems] ADD  CONSTRAINT [DF_puprsnitems_notified]  DEFAULT ((1)) FOR [notified]
GO
ALTER TABLE [dbo].[re_elec_inv_dt] ADD  DEFAULT ('') FOR [meter_no]
GO
ALTER TABLE [dbo].[re_elec_inv_dt] ADD  DEFAULT ((0)) FOR [loc_cur_bal]
GO
ALTER TABLE [dbo].[re_elec_inv_dt] ADD  DEFAULT ((0)) FOR [price_type_code]
GO
ALTER TABLE [dbo].[re_elec_inv_dt] ADD  DEFAULT ((0)) FOR [Sewage_fees]
GO
ALTER TABLE [dbo].[re_elec_inv_dt] ADD  DEFAULT ((0)) FOR [local_council_fees]
GO
ALTER TABLE [dbo].[re_elec_inv_dt] ADD  DEFAULT ((0)) FOR [meter_rent_amount]
GO
ALTER TABLE [dbo].[re_elec_inv_dt] ADD  DEFAULT ((0)) FOR [city_dvlpmnt_amount]
GO
ALTER TABLE [dbo].[re_elec_inv_dt] ADD  DEFAULT ((0)) FOR [operations_services_amount]
GO
ALTER TABLE [dbo].[re_elec_inv_hd] ADD  DEFAULT ((0)) FOR [Sewage_fees]
GO
ALTER TABLE [dbo].[re_elec_inv_hd] ADD  DEFAULT ((0)) FOR [local_council_fees]
GO
ALTER TABLE [dbo].[re_elec_inv_hd] ADD  DEFAULT ((0)) FOR [meter_rent_amount]
GO
ALTER TABLE [dbo].[re_elec_inv_hd] ADD  DEFAULT ((0)) FOR [city_dvlpmnt_amount]
GO
ALTER TABLE [dbo].[re_elec_inv_hd] ADD  DEFAULT ((0)) FOR [operations_services_amount]
GO
ALTER TABLE [dbo].[re_elec_inv_hd] ADD  DEFAULT ((0)) FOR [inv_only_unit_code]
GO
ALTER TABLE [dbo].[re_elec_meters] ADD  DEFAULT ((0)) FOR [price_type_code]
GO
ALTER TABLE [dbo].[re_entitle_batch_hd] ADD  CONSTRAINT [DF__tr_factor__datet__1ECF7711]  DEFAULT (getdate()) FOR [datetime_stamp]
GO
ALTER TABLE [dbo].[re_fixes_maintenance] ADD  DEFAULT ((0)) FOR [vat_percent]
GO
ALTER TABLE [dbo].[re_spcl_dsc_hd] ADD  DEFAULT ((0)) FOR [Vat_Percent]
GO
ALTER TABLE [dbo].[re_spcl_dsc_hd] ADD  DEFAULT ((0)) FOR [inv_printed]
GO
ALTER TABLE [dbo].[rebrokers] ADD  DEFAULT ('') FOR [traderegno]
GO
ALTER TABLE [dbo].[rebrokers] ADD  DEFAULT ('') FOR [city]
GO
ALTER TABLE [dbo].[rebrokers] ADD  DEFAULT ('') FOR [location]
GO
ALTER TABLE [dbo].[rebrokers] ADD  DEFAULT ('') FOR [llocation]
GO
ALTER TABLE [dbo].[rebrokers] ADD  DEFAULT ('') FOR [national_address]
GO
ALTER TABLE [dbo].[rebrokers] ADD  DEFAULT ('') FOR [mgr_name]
GO
ALTER TABLE [dbo].[rebrokers] ADD  DEFAULT ('') FOR [mgr_lname]
GO
ALTER TABLE [dbo].[recontracts] ADD  DEFAULT ((0)) FOR [un_broker_code]
GO
ALTER TABLE [dbo].[recontracts] ADD  DEFAULT ((0)) FOR [un_re_percent]
GO
ALTER TABLE [dbo].[recontracts] ADD  DEFAULT ('') FOR [end_status_date]
GO
ALTER TABLE [dbo].[recontracts] ADD  DEFAULT ((0)) FOR [last_loc_elect_balance]
GO
ALTER TABLE [dbo].[recontracts] ADD  DEFAULT ((0)) FOR [current_loc_elect_balance]
GO
ALTER TABLE [dbo].[recontracts] ADD  DEFAULT ('') FOR [terminate_reason]
GO
ALTER TABLE [dbo].[recontracts] ADD  DEFAULT ('') FOR [terminate_usrid]
GO
ALTER TABLE [dbo].[recontracts] ADD  DEFAULT ((0)) FOR [srvces_amnt]
GO
ALTER TABLE [dbo].[recontracts] ADD  DEFAULT ('') FOR [Contract_image]
GO
ALTER TABLE [dbo].[recontracts] ADD  DEFAULT ((0)) FOR [rent_amount]
GO
ALTER TABLE [dbo].[recontracts] ADD  DEFAULT ((0)) FOR [cat1_amount]
GO
ALTER TABLE [dbo].[recontracts] ADD  DEFAULT ((0)) FOR [cat2_amount]
GO
ALTER TABLE [dbo].[recontracts] ADD  DEFAULT ((0)) FOR [cat3_amount]
GO
ALTER TABLE [dbo].[recontracts] ADD  DEFAULT ((0)) FOR [cat4_amount]
GO
ALTER TABLE [dbo].[recontracts] ADD  DEFAULT ((0)) FOR [cat5_amount]
GO
ALTER TABLE [dbo].[recontracts] ADD  DEFAULT ((0)) FOR [cat6_amount]
GO
ALTER TABLE [dbo].[recontracts] ADD  DEFAULT ((0)) FOR [cat7_amount]
GO
ALTER TABLE [dbo].[recontracts] ADD  DEFAULT ((0)) FOR [renew_of_contract]
GO
ALTER TABLE [dbo].[recontracts] ADD  DEFAULT ('') FOR [usrid]
GO
ALTER TABLE [dbo].[recontracts_elec_open] ADD  DEFAULT ((0)) FOR [opn_bal]
GO
ALTER TABLE [dbo].[recontracts_elec_open] ADD  DEFAULT ((0)) FOR [loc_opn_bal]
GO
ALTER TABLE [dbo].[recontracts_elec_open] ADD  DEFAULT ((0)) FOR [cur_bal]
GO
ALTER TABLE [dbo].[recontracts_elec_open] ADD  DEFAULT ((0)) FOR [loc_cur_bal]
GO
ALTER TABLE [dbo].[reowners] ADD  CONSTRAINT [DF_reowner_inactive]  DEFAULT ((0)) FOR [inactive]
GO
ALTER TABLE [dbo].[reowners] ADD  DEFAULT ('') FOR [traderegno]
GO
ALTER TABLE [dbo].[reproperty] ADD  DEFAULT ('') FOR [re_tel]
GO
ALTER TABLE [dbo].[reproperty] ADD  DEFAULT ('') FOR [re_fax]
GO
ALTER TABLE [dbo].[reproperty] ADD  DEFAULT ('') FOR [re_email]
GO
ALTER TABLE [dbo].[reproperty] ADD  DEFAULT ('') FOR [re_traderegno]
GO
ALTER TABLE [dbo].[reproperty] ADD  DEFAULT ((0)) FOR [re_ownr_ID]
GO
ALTER TABLE [dbo].[reproperty] ADD  DEFAULT ((0)) FOR [prev_normal_water_reading]
GO
ALTER TABLE [dbo].[reproperty] ADD  DEFAULT ((0)) FOR [last_normal_water_reading]
GO
ALTER TABLE [dbo].[reproperty] ADD  DEFAULT ((0)) FOR [prev_filtrd_water_reading]
GO
ALTER TABLE [dbo].[reproperty] ADD  DEFAULT ((0)) FOR [last_filtrd_water_reading]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [restp_re_un_glser]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [restp_re_dsc_glser]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ((0)) FOR [use_contract_type2]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ((0)) FOR [basic_cur_is_local]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [electricity_cur]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [rent_cur]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ((0)) FOR [allow_cntrct_edit]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ((0)) FOR [use_water_meters]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ((0)) FOR [normal_water_dflt_price_code]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ((0)) FOR [filtrd_water_dflt_price_code]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [sl_dept]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [pu_dept]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [rent_svccmbkey]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [cat1_svccmbkey]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [cat1_income_Ac]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [cat1_expense_Ac]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [cat2_svccmbkey]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [cat2_income_Ac]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [cat2_expense_Ac]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [cat3_svccmbkey]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [cat3_income_Ac]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [cat3_expense_Ac]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [cat4_svccmbkey]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [cat4_income_Ac]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [cat4_expense_Ac]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [cat5_svccmbkey]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [cat5_income_Ac]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [cat5_expense_Ac]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [cat6_svccmbkey]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [cat6_income_Ac]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [cat6_expense_Ac]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [cat7_svccmbkey]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [cat7_income_Ac]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [cat7_expense_Ac]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ((0)) FOR [due_period]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ((0)) FOR [contract_srch_type]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ((0)) FOR [no_currency_diff]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ((0)) FOR [force_contract_modification]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ((0)) FOR [contract_srch_status]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ((0)) FOR [prd1_duedate_is_issdate]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [rent_svccmbkey_tax_exemptd]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [cat1_svccmbkey_tax_exemptd]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [cat2_svccmbkey_tax_exemptd]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [cat3_svccmbkey_tax_exemptd]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [cat4_svccmbkey_tax_exemptd]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [cat5_svccmbkey_tax_exemptd]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [cat6_svccmbkey_tax_exemptd]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ('') FOR [cat7_svccmbkey_tax_exemptd]
GO
ALTER TABLE [dbo].[resetup] ADD  DEFAULT ((0)) FOR [use_Shared_Services]
GO
ALTER TABLE [dbo].[retenants] ADD  CONSTRAINT [DF_rerenter_inactive]  DEFAULT ((0)) FOR [inactive]
GO
ALTER TABLE [dbo].[retenants] ADD  DEFAULT ('') FOR [traderegno]
GO
ALTER TABLE [dbo].[retenants] ADD  DEFAULT ('') FOR [clnt_taxcode]
GO
ALTER TABLE [dbo].[retenants] ADD  DEFAULT ('') FOR [bldg_no]
GO
ALTER TABLE [dbo].[retenants] ADD  DEFAULT ('') FOR [bldg_no_l]
GO
ALTER TABLE [dbo].[retenants] ADD  DEFAULT ('') FOR [street_name]
GO
ALTER TABLE [dbo].[retenants] ADD  DEFAULT ('') FOR [street_name_l]
GO
ALTER TABLE [dbo].[retenants] ADD  DEFAULT ('') FOR [area_name]
GO
ALTER TABLE [dbo].[retenants] ADD  DEFAULT ('') FOR [area_name_l]
GO
ALTER TABLE [dbo].[retenants] ADD  DEFAULT ('') FOR [extra_address_no]
GO
ALTER TABLE [dbo].[retenants] ADD  DEFAULT ('') FOR [extra_address_no_l]
GO
ALTER TABLE [dbo].[retenants] ADD  DEFAULT ('') FOR [district]
GO
ALTER TABLE [dbo].[retenants] ADD  DEFAULT ('') FOR [district_l]
GO
ALTER TABLE [dbo].[retenants] ADD  DEFAULT ('') FOR [city_text]
GO
ALTER TABLE [dbo].[retenants] ADD  DEFAULT ('') FOR [city_text_l]
GO
ALTER TABLE [dbo].[retenants] ADD  DEFAULT ('') FOR [country_text]
GO
ALTER TABLE [dbo].[retenants] ADD  DEFAULT ('') FOR [country_text_l]
GO
ALTER TABLE [dbo].[retenants] ADD  DEFAULT ('') FOR [postal_code]
GO
ALTER TABLE [dbo].[retenants] ADD  DEFAULT ('') FOR [Other_id]
GO
ALTER TABLE [dbo].[retrans_dt] ADD  CONSTRAINT [DF__retrans_d__vat_a__32024716]  DEFAULT ((0)) FOR [vat_amt_paid]
GO
ALTER TABLE [dbo].[retrans_dt] ADD  DEFAULT ((0)) FOR [broker_code]
GO
ALTER TABLE [dbo].[retrans_dt] ADD  DEFAULT ((0)) FOR [re_code]
GO
ALTER TABLE [dbo].[retrans_dt] ADD  DEFAULT ((0)) FOR [un_code]
GO
ALTER TABLE [dbo].[retrans_dt] ADD  DEFAULT ('') FOR [meter_no]
GO
ALTER TABLE [dbo].[retrans_dt] ADD  DEFAULT ((0)) FOR [taxcatId]
GO
ALTER TABLE [dbo].[retrans_hd] ADD  CONSTRAINT [DF__retrans_h__dtltt__34DEB3C1]  DEFAULT ((0)) FOR [dtlttlvatamt]
GO
ALTER TABLE [dbo].[retrans_hd] ADD  CONSTRAINT [DF_retrans_hd_rcvdtrn]  DEFAULT ((0)) FOR [rcvdtrn]
GO
ALTER TABLE [dbo].[retrans_hd] ADD  CONSTRAINT [DF__retrans_h__Vat_P__33EA8F88]  DEFAULT ((0)) FOR [Vat_Percent]
GO
ALTER TABLE [dbo].[retrans_hd] ADD  DEFAULT ((0)) FOR [rcvd_by]
GO
ALTER TABLE [dbo].[retrans_hd] ADD  DEFAULT ((0)) FOR [is_brokr_commsn]
GO
ALTER TABLE [dbo].[retrans_hd] ADD  DEFAULT ((0)) FOR [brokr_percent]
GO
ALTER TABLE [dbo].[retrans_hd] ADD  DEFAULT ((0)) FOR [brokr_commsn_amount]
GO
ALTER TABLE [dbo].[retrans_hd] ADD  DEFAULT ((0)) FOR [inv_printed]
GO
ALTER TABLE [dbo].[retrans_hd] ADD  DEFAULT ((0)) FOR [diffamount]
GO
ALTER TABLE [dbo].[retrans_hd] ADD  DEFAULT ((0)) FOR [crtd_fm_batch_ref]
GO
ALTER TABLE [dbo].[retrans_hd] ADD  DEFAULT ('') FOR [rtntype]
GO
ALTER TABLE [dbo].[retrans_hd] ADD  DEFAULT ((0)) FOR [rtnref]
GO
ALTER TABLE [dbo].[retrans_hd] ADD  DEFAULT ('') FOR [rtndate]
GO
ALTER TABLE [dbo].[reunits] ADD  DEFAULT ((0)) FOR [un_broker_code]
GO
ALTER TABLE [dbo].[reunits] ADD  DEFAULT ((0)) FOR [un_re_percent]
GO
ALTER TABLE [dbo].[reunits] ADD  DEFAULT ((0)) FOR [un_furniture_status]
GO
ALTER TABLE [dbo].[reunits] ADD  DEFAULT ((0)) FOR [un_ktchn_cabnts_instld]
GO
ALTER TABLE [dbo].[salecntr] ADD  CONSTRAINT [DF_salecntr_no_of_invCopies]  DEFAULT ((1)) FOR [no_of_invCopies]
GO
ALTER TABLE [dbo].[salecntr] ADD  DEFAULT ('') FOR [vat_rcvd_act]
GO
ALTER TABLE [dbo].[salecntr] ADD  DEFAULT ('') FOR [stcpay_act]
GO
ALTER TABLE [dbo].[salecntr] ADD  DEFAULT ((0)) FOR [suspended]
GO
ALTER TABLE [dbo].[salecntr] ADD  DEFAULT ('') FOR [qitaf_act]
GO
ALTER TABLE [dbo].[salecntr] ADD  DEFAULT ('') FOR [slscmnact]
GO
ALTER TABLE [dbo].[salecntr] ADD  DEFAULT ('') FOR [webcmnact]
GO
ALTER TABLE [dbo].[salecntr] ADD  DEFAULT ('') FOR [tprtexpact]
GO
ALTER TABLE [dbo].[salecntr] ADD  DEFAULT ('') FOR [bldg_no]
GO
ALTER TABLE [dbo].[salecntr] ADD  DEFAULT ('') FOR [bldg_no_l]
GO
ALTER TABLE [dbo].[salecntr] ADD  DEFAULT ('') FOR [street_name]
GO
ALTER TABLE [dbo].[salecntr] ADD  DEFAULT ('') FOR [street_name_l]
GO
ALTER TABLE [dbo].[salecntr] ADD  DEFAULT ('') FOR [area_name]
GO
ALTER TABLE [dbo].[salecntr] ADD  DEFAULT ('') FOR [area_name_l]
GO
ALTER TABLE [dbo].[salecntr] ADD  DEFAULT ('') FOR [extra_address_no]
GO
ALTER TABLE [dbo].[salecntr] ADD  DEFAULT ('') FOR [extra_address_no_l]
GO
ALTER TABLE [dbo].[salecntr] ADD  DEFAULT ('') FOR [district]
GO
ALTER TABLE [dbo].[salecntr] ADD  DEFAULT ('') FOR [district_l]
GO
ALTER TABLE [dbo].[salecntr] ADD  DEFAULT ('') FOR [city_text]
GO
ALTER TABLE [dbo].[salecntr] ADD  DEFAULT ('') FOR [city_text_l]
GO
ALTER TABLE [dbo].[salecntr] ADD  DEFAULT ('') FOR [street_name2]
GO
ALTER TABLE [dbo].[salecntr] ADD  DEFAULT ('') FOR [street_name2_l]
GO
ALTER TABLE [dbo].[salecntr] ADD  DEFAULT ('') FOR [postal_code]
GO
ALTER TABLE [dbo].[salecntr] ADD  DEFAULT ('') FOR [Other_id_SchemeID]
GO
ALTER TABLE [dbo].[salecntr] ADD  DEFAULT ('') FOR [Group_VAT_ID]
GO
ALTER TABLE [dbo].[salecntr] ADD  DEFAULT ((0)) FOR [country_code]
GO
ALTER TABLE [dbo].[salecntr] ADD  DEFAULT ('') FOR [Other_Scheme_Type]
GO
ALTER TABLE [dbo].[salecntr] ADD  DEFAULT ('') FOR [manafith_api]
GO
ALTER TABLE [dbo].[sales_dd] ADD  CONSTRAINT [DF_sales_dd_rplct_post]  DEFAULT ((0)) FOR [rplct_post]
GO
ALTER TABLE [dbo].[sales_dd] ADD  CONSTRAINT [DF_sales_dd_folio]  DEFAULT ((0)) FOR [folio]
GO
ALTER TABLE [dbo].[sales_dd] ADD  DEFAULT ('') FOR [whqty]
GO
ALTER TABLE [dbo].[sales_dd] ADD  DEFAULT ((0)) FOR [nprice2]
GO
ALTER TABLE [dbo].[sales_dd] ADD  DEFAULT ((0)) FOR [nprice3]
GO
ALTER TABLE [dbo].[sales_dd] ADD  DEFAULT ('') FOR [jvtype]
GO
ALTER TABLE [dbo].[sales_dd] ADD  DEFAULT ((0)) FOR [jvref]
GO
ALTER TABLE [dbo].[sales_dd] ADD  DEFAULT ('') FOR [taxtype]
GO
ALTER TABLE [dbo].[sales_dd] ADD  DEFAULT ((0)) FOR [item_vat]
GO
ALTER TABLE [dbo].[sales_dd] ADD  DEFAULT ((0)) FOR [item_price_net]
GO
ALTER TABLE [dbo].[sales_dd] ADD  DEFAULT ('') FOR [dscpack]
GO
ALTER TABLE [dbo].[sales_dd] ADD  DEFAULT ((0)) FOR [avgcost]
GO
ALTER TABLE [dbo].[sales_dh] ADD  CONSTRAINT [DF_sales_hs_posinv]  DEFAULT ((0)) FOR [posinv]
GO
ALTER TABLE [dbo].[sales_dh] ADD  DEFAULT ((0)) FOR [vat_amt_rcvd]
GO
ALTER TABLE [dbo].[sales_dh] ADD  DEFAULT ((0)) FOR [taxfree_sales]
GO
ALTER TABLE [dbo].[sales_dh] ADD  DEFAULT ((1)) FOR [PriceVatType]
GO
ALTER TABLE [dbo].[sales_dh] ADD  DEFAULT ((0)) FOR [vat_percent]
GO
ALTER TABLE [dbo].[sales_dh] ADD  DEFAULT ('') FOR [clnt_taxcode]
GO
ALTER TABLE [dbo].[sales_dh] ADD  DEFAULT ('') FOR [clnt_kind]
GO
ALTER TABLE [dbo].[sales_dh] ADD  DEFAULT ('') FOR [jvtype]
GO
ALTER TABLE [dbo].[sales_dh] ADD  DEFAULT ((0)) FOR [jvref]
GO
ALTER TABLE [dbo].[sales_dh] ADD  DEFAULT ('') FOR [yrcode]
GO
ALTER TABLE [dbo].[sales_dh] ADD  DEFAULT ((0)) FOR [zatca_rounding]
GO
ALTER TABLE [dbo].[sales_dh] ADD  DEFAULT ((0)) FOR [dsc4allqty]
GO
ALTER TABLE [dbo].[sales_dh] ADD  DEFAULT ('') FOR [invoicelist]
GO
ALTER TABLE [dbo].[sales_dt] ADD  CONSTRAINT [DF_sales_dt_discpc]  DEFAULT ((0)) FOR [discpc]
GO
ALTER TABLE [dbo].[sales_dt] ADD  CONSTRAINT [DF_sales_dt_folio]  DEFAULT ((0)) FOR [folio]
GO
ALTER TABLE [dbo].[sales_dt] ADD  CONSTRAINT [DF_sales_dt_rplct_post]  DEFAULT ((0)) FOR [rplct_post]
GO
ALTER TABLE [dbo].[sales_dt] ADD  DEFAULT ((0)) FOR [sold_item_status]
GO
ALTER TABLE [dbo].[sales_dt] ADD  DEFAULT ((1)) FOR [Taxtype]
GO
ALTER TABLE [dbo].[sales_dt] ADD  DEFAULT ((0)) FOR [ps_item_vat]
GO
ALTER TABLE [dbo].[sales_dt] ADD  DEFAULT ((0)) FOR [dsc_amt]
GO
ALTER TABLE [dbo].[sales_dt] ADD  DEFAULT (' ') FOR [binno]
GO
ALTER TABLE [dbo].[sales_dt] ADD  DEFAULT ((0)) FOR [item_price_net]
GO
ALTER TABLE [dbo].[sales_dt] ADD  DEFAULT ((0)) FOR [invdscamt]
GO
ALTER TABLE [dbo].[sales_dt] ADD  DEFAULT ((0)) FOR [item_fq_vat]
GO
ALTER TABLE [dbo].[sales_dt] ADD  DEFAULT ((0)) FOR [item_vat]
GO
ALTER TABLE [dbo].[sales_dt] ADD  DEFAULT ((0)) FOR [m_sl_ref]
GO
ALTER TABLE [dbo].[sales_ei] ADD  CONSTRAINT [DF_sales_ei_uuid]  DEFAULT (newid()) FOR [uuid]
GO
ALTER TABLE [dbo].[sales_ei] ADD  CONSTRAINT [DF__sales_ei__usr_sl__469D7149]  DEFAULT ((0)) FOR [usr_slct_simple_einv]
GO
ALTER TABLE [dbo].[sales_ei] ADD  CONSTRAINT [DF__sales_ei__invoic__56DEC60A]  DEFAULT ((0)) FOR [invoice_charges]
GO
ALTER TABLE [dbo].[sales_ei] ADD  CONSTRAINT [DF__sales_ei__Exempt__61081A19]  DEFAULT ('') FOR [ExemptionReason]
GO
ALTER TABLE [dbo].[sales_ei] ADD  CONSTRAINT [DF__sales_ei__EXEMPT__0BBD6DF4]  DEFAULT ('') FOR [Exemptioncode]
GO
ALTER TABLE [dbo].[sales_ei] ADD  CONSTRAINT [DF__sales_ei__zatca___0DA5B666]  DEFAULT ('') FOR [zatca_datetime]
GO
ALTER TABLE [dbo].[sales_ei] ADD  CONSTRAINT [DF__sales_ei__is_pro__46DE33C2]  DEFAULT ((0)) FOR [is_production]
GO
ALTER TABLE [dbo].[sales_hd] ADD  CONSTRAINT [DF_sales_hd_posinv]  DEFAULT ((0)) FOR [posinv]
GO
ALTER TABLE [dbo].[sales_hd] ADD  CONSTRAINT [DF_sales_hd_saned_amt]  DEFAULT ((0)) FOR [sanedcrd_amt]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ('') FOR [remarks]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ('') FOR [remarks2]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ((0)) FOR [invlocked]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ((0.00)) FOR [rtncash_dfrpl]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ((0)) FOR [vat_amt_rcvd]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ((0)) FOR [taxfree_sales]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ('') FOR [clnt_taxcode]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ('') FOR [clnt_kind]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ((0)) FOR [hlldscnt]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ((1)) FOR [sysno]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ((0)) FOR [No_round_nm]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ((1)) FOR [PriceVatType]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ((0)) FOR [smssent]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ((0)) FOR [stcpay_amt]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ((0)) FOR [fc2lcamt]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ((0)) FOR [qitaf_amt]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ((0)) FOR [whlslinv]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ((0)) FOR [vat_percent]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ((0)) FOR [fsh_printed]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ((0)) FOR [fqtyval]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ((0)) FOR [discountedBill]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ('') FOR [Fusrprintinv]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ((0)) FOR [almnm_contract_section]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ((0)) FOR [instlmnt_code]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ((0)) FOR [installment_amt]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ('') FOR [mobileNo]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ('') FOR [client_name]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ((0)) FOR [cashpaid]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ((0)) FOR [zatca_rounding]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ((0)) FOR [multi_refund_inv]
GO
ALTER TABLE [dbo].[sales_hd] ADD  DEFAULT ((0)) FOR [refund_no_inv_avl]
GO
ALTER TABLE [dbo].[sales_od] ADD  CONSTRAINT [DF_sales_od_folio]  DEFAULT ((0)) FOR [folio]
GO
ALTER TABLE [dbo].[sales_od] ADD  DEFAULT ('1') FOR [taxtype]
GO
ALTER TABLE [dbo].[sales_od] ADD  DEFAULT ((0)) FOR [item_vat]
GO
ALTER TABLE [dbo].[sales_od] ADD  DEFAULT ((0)) FOR [item_price_net]
GO
ALTER TABLE [dbo].[sales_od] ADD  DEFAULT ((0)) FOR [item_fq_vat]
GO
ALTER TABLE [dbo].[sales_od] ADD  DEFAULT ((0)) FOR [invdscamt]
GO
ALTER TABLE [dbo].[sales_oh] ADD  DEFAULT ((0)) FOR [vat_amt_rcvd]
GO
ALTER TABLE [dbo].[sales_oh] ADD  DEFAULT ((0)) FOR [taxfree_sales]
GO
ALTER TABLE [dbo].[sales_oh] ADD  DEFAULT ('') FOR [clnt_taxcode]
GO
ALTER TABLE [dbo].[sales_oh] ADD  DEFAULT ('') FOR [clnt_kind]
GO
ALTER TABLE [dbo].[sales_oh] ADD  DEFAULT ((0)) FOR [wh_rsvqty]
GO
ALTER TABLE [dbo].[sales_oh] ADD  DEFAULT ((0)) FOR [zatca_rounding]
GO
ALTER TABLE [dbo].[sales_oh] ADD  DEFAULT ((0)) FOR [vat_percent]
GO
ALTER TABLE [dbo].[sales_oh] ADD  DEFAULT ((0)) FOR [pricevattype]
GO
ALTER TABLE [dbo].[sales_qd] ADD  DEFAULT ((0)) FOR [folio]
GO
ALTER TABLE [dbo].[sales_qd] ADD  DEFAULT ('') FOR [whno]
GO
ALTER TABLE [dbo].[sales_qd] ADD  DEFAULT ((0)) FOR [item_Quoted]
GO
ALTER TABLE [dbo].[sales_qd] ADD  DEFAULT ((0)) FOR [dsc_amt]
GO
ALTER TABLE [dbo].[sales_qd] ADD  DEFAULT ((0)) FOR [item_vat]
GO
ALTER TABLE [dbo].[sales_qd] ADD  DEFAULT ((0)) FOR [item_price_net]
GO
ALTER TABLE [dbo].[sales_qd] ADD  DEFAULT ((0)) FOR [item_fq_vat]
GO
ALTER TABLE [dbo].[sales_qd] ADD  DEFAULT ((0)) FOR [invdscamt]
GO
ALTER TABLE [dbo].[sales_qh] ADD  DEFAULT ('') FOR [usrid]
GO
ALTER TABLE [dbo].[sales_qh] ADD  DEFAULT ((0)) FOR [vat_amt_rcvd]
GO
ALTER TABLE [dbo].[sales_qh] ADD  DEFAULT ((0)) FOR [taxfree_sales]
GO
ALTER TABLE [dbo].[sales_qh] ADD  DEFAULT ('') FOR [clnt_taxcode]
GO
ALTER TABLE [dbo].[sales_qh] ADD  DEFAULT ('') FOR [clnt_kind]
GO
ALTER TABLE [dbo].[sales_qh] ADD  DEFAULT ('') FOR [qhtype]
GO
ALTER TABLE [dbo].[sales_qh] ADD  DEFAULT ('') FOR [qhstatus]
GO
ALTER TABLE [dbo].[sales_qh] ADD  DEFAULT ('') FOR [newcstmrname]
GO
ALTER TABLE [dbo].[sales_qh] ADD  DEFAULT ('') FOR [newcstmrcntct]
GO
ALTER TABLE [dbo].[sales_qh] ADD  DEFAULT ('') FOR [cstmrmobile]
GO
ALTER TABLE [dbo].[sales_qh] ADD  DEFAULT ((0)) FOR [fqtyval]
GO
ALTER TABLE [dbo].[sales_qh] ADD  DEFAULT ((0)) FOR [zatca_rounding]
GO
ALTER TABLE [dbo].[sales_qh] ADD  DEFAULT ((0)) FOR [vat_percent]
GO
ALTER TABLE [dbo].[sales_qh] ADD  DEFAULT ((0)) FOR [pricevattype]
GO
ALTER TABLE [dbo].[salesmen] ADD  CONSTRAINT [DF_salesmen_notify_type]  DEFAULT ((0)) FOR [notify_type]
GO
ALTER TABLE [dbo].[salesmen] ADD  CONSTRAINT [DF_salesmen_notify_within]  DEFAULT ((30)) FOR [notify_within]
GO
ALTER TABLE [dbo].[salesmen] ADD  DEFAULT ('') FOR [slscmnact]
GO
ALTER TABLE [dbo].[salesmen] ADD  DEFAULT ((0)) FOR [crdt_limit]
GO
ALTER TABLE [dbo].[salesmen] ADD  DEFAULT ('') FOR [sl_center]
GO
ALTER TABLE [dbo].[sdaad_dt] ADD  DEFAULT ((0)) FOR [vat_amt_paid]
GO
ALTER TABLE [dbo].[sdaad_hd] ADD  CONSTRAINT [DF_sdaad_hd_rcvdtrn]  DEFAULT ((0)) FOR [rcvdtrn]
GO
ALTER TABLE [dbo].[sdaad_hd] ADD  DEFAULT ((0)) FOR [Vat_Percent]
GO
ALTER TABLE [dbo].[sdaad_hd] ADD  DEFAULT ((0)) FOR [sdttlvatamt]
GO
ALTER TABLE [dbo].[sdaad_hd] ADD  DEFAULT ((0)) FOR [vat_included]
GO
ALTER TABLE [dbo].[sdaad_hd] ADD  DEFAULT ((0)) FOR [sdNoVat]
GO
ALTER TABLE [dbo].[sddtl] ADD  CONSTRAINT [DF_sddtl_rplct_post]  DEFAULT ((0)) FOR [rplct_post]
GO
ALTER TABLE [dbo].[sddtl] ADD  CONSTRAINT [DF_sddtl_rowguid]  DEFAULT (newsequentialid()) FOR [rowguid]
GO
ALTER TABLE [dbo].[sddtl] ADD  DEFAULT ((0)) FOR [taxcatId]
GO
ALTER TABLE [dbo].[sddtl] ADD  DEFAULT ((0)) FOR [jdcstval]
GO
ALTER TABLE [dbo].[sddtl] ADD  DEFAULT ('') FOR [cstkey]
GO
ALTER TABLE [dbo].[sddtl] ADD  DEFAULT ('') FOR [vndr_taxcode]
GO
ALTER TABLE [dbo].[sddtl] ADD  DEFAULT ('') FOR [vndr_name]
GO
ALTER TABLE [dbo].[sddtl] ADD  DEFAULT ((0)) FOR [no_chng_col]
GO
ALTER TABLE [dbo].[sddtl] ADD  DEFAULT ((0)) FOR [amtincldvat]
GO
ALTER TABLE [dbo].[sdhdr] ADD  CONSTRAINT [DF_sdhdr_rowguid]  DEFAULT (newsequentialid()) FOR [rowguid]
GO
ALTER TABLE [dbo].[sdhdr] ADD  DEFAULT ((0)) FOR [Vat_Percent]
GO
ALTER TABLE [dbo].[sdhdr] ADD  DEFAULT ((0)) FOR [serial_no]
GO
ALTER TABLE [dbo].[sdhdr] ADD  DEFAULT ('') FOR [brxfrm]
GO
ALTER TABLE [dbo].[sdhdr] ADD  DEFAULT ('') FOR [caser]
GO
ALTER TABLE [dbo].[sdhdr] ADD  DEFAULT ((0)) FOR [ctype]
GO
ALTER TABLE [dbo].[sdhdr] ADD  DEFAULT ('') FOR [clnt_kind]
GO
ALTER TABLE [dbo].[sdhdr] ADD  DEFAULT ((0)) FOR [hide_jv]
GO
ALTER TABLE [dbo].[sdsubscribers] ADD  CONSTRAINT [DF_sdsubscribers_sdinactive]  DEFAULT ((0)) FOR [sdinactive]
GO
ALTER TABLE [dbo].[sdtype] ADD  DEFAULT ((0)) FOR [sdNoVat]
GO
ALTER TABLE [dbo].[slccpayment] ADD  DEFAULT ('') FOR [src]
GO
ALTER TABLE [dbo].[slccpayment] ADD  DEFAULT ('') FOR [bkactcode]
GO
ALTER TABLE [dbo].[slglsscc] ADD  DEFAULT ((0)) FOR [is_tax_applied]
GO
ALTER TABLE [dbo].[slinvexp] ADD  DEFAULT ('') FOR [trans_code]
GO
ALTER TABLE [dbo].[slinvexp] ADD  DEFAULT ((0)) FOR [pricewithtransport]
GO
ALTER TABLE [dbo].[slinvexp] ADD  DEFAULT ((0)) FOR [clnt_cntrct_no]
GO
ALTER TABLE [dbo].[slinvexp] ADD  DEFAULT ((0)) FOR [driver_no]
GO
ALTER TABLE [dbo].[slinvexp] ADD  DEFAULT ((0)) FOR [driver_cntrct_no]
GO
ALTER TABLE [dbo].[slinvexp] ADD  DEFAULT ((0)) FOR [driver_expnseamt]
GO
ALTER TABLE [dbo].[slinvexp] ADD  DEFAULT ((0)) FOR [truck_no]
GO
ALTER TABLE [dbo].[slinvexp] ADD  DEFAULT ((0)) FOR [trans_expnse]
GO
ALTER TABLE [dbo].[slinvexp] ADD  DEFAULT ((0)) FOR [trans_cntrct_no]
GO
ALTER TABLE [dbo].[slinvexp] ADD  DEFAULT ((0)) FOR [trans_cost_per_pack]
GO
ALTER TABLE [dbo].[slinvexp] ADD  DEFAULT ((0)) FOR [from_whno]
GO
ALTER TABLE [dbo].[slinvexp] ADD  DEFAULT ((0)) FOR [trans_pack]
GO
ALTER TABLE [dbo].[slinvexp] ADD  DEFAULT ((0)) FOR [is_vat]
GO
ALTER TABLE [dbo].[slktchndtls] ADD  DEFAULT ('') FOR [contract_second_party]
GO
ALTER TABLE [dbo].[slktchndtls] ADD  DEFAULT ('') FOR [contract_hdr]
GO
ALTER TABLE [dbo].[slktchndtls] ADD  DEFAULT ('') FOR [contract_work_period]
GO
ALTER TABLE [dbo].[slktchndtls] ADD  DEFAULT ('') FOR [contract_waranty]
GO
ALTER TABLE [dbo].[slktchndtls] ADD  DEFAULT ('') FOR [contract_payment]
GO
ALTER TABLE [dbo].[slpaytype] ADD  CONSTRAINT [DF_slpaytype_aprvdamt]  DEFAULT ((0)) FOR [aprvdamt]
GO
ALTER TABLE [dbo].[slpaytype] ADD  CONSTRAINT [DF_slpaytype_cln_amt]  DEFAULT ((0)) FOR [cln_amt]
GO
ALTER TABLE [dbo].[slpaytype] ADD  CONSTRAINT [DF_slpaytype_cln_extra_amt]  DEFAULT ((0)) FOR [cln_extra_amt]
GO
ALTER TABLE [dbo].[slpaytype] ADD  CONSTRAINT [DF_slpaytype_isr_dsc40]  DEFAULT ((0)) FOR [isr_dsc40]
GO
ALTER TABLE [dbo].[slpaytype] ADD  CONSTRAINT [DF_slpaytype_isr_dscextra25]  DEFAULT ((0)) FOR [isr_dscextra25]
GO
ALTER TABLE [dbo].[slpaytype] ADD  CONSTRAINT [DF_slpaytype_isr_crdtamt]  DEFAULT ((0)) FOR [isr_crdtamt]
GO
ALTER TABLE [dbo].[slpaytype] ADD  CONSTRAINT [DF_slpaytype_rmnamt]  DEFAULT ((0)) FOR [rmnamt]
GO
ALTER TABLE [dbo].[slpaytype] ADD  DEFAULT ((0)) FOR [Comp_pay_full]
GO
ALTER TABLE [dbo].[slpu_unused_inv] ADD  CONSTRAINT [DF_unused_invoices_is_used]  DEFAULT ((0)) FOR [is_used]
GO
ALTER TABLE [dbo].[slpu_unused_inv] ADD  CONSTRAINT [DF_Table_1_reason]  DEFAULT ((0)) FOR [reasons]
GO
ALTER TABLE [dbo].[slpuorder_od] ADD  CONSTRAINT [DF_slpuorder_od_qty]  DEFAULT ((0)) FOR [qty]
GO
ALTER TABLE [dbo].[sltrans] ADD  CONSTRAINT [DF_sltrans_pricePerUnit]  DEFAULT ((0)) FOR [pricePerUnit]
GO
ALTER TABLE [dbo].[sltrans] ADD  DEFAULT ('') FOR [tprtexpact]
GO
ALTER TABLE [dbo].[sltrans] ADD  DEFAULT ((0)) FOR [is_vat]
GO
ALTER TABLE [dbo].[slvchrimage] ADD  CONSTRAINT [DF_slvchrimage_No_of_cartons]  DEFAULT ((0)) FOR [No_of_cartons]
GO
ALTER TABLE [dbo].[slvchrimage] ADD  CONSTRAINT [DF_slvchrimage_pricePerUnit]  DEFAULT ((0)) FOR [pricePerUnit]
GO
ALTER TABLE [dbo].[slvchrimage] ADD  CONSTRAINT [DF_slvchrimage_confirmed]  DEFAULT ((0)) FOR [confirmed]
GO
ALTER TABLE [dbo].[slvchrimage] ADD  CONSTRAINT [DF__slvchrima__rtnre__4924D839]  DEFAULT ((0)) FOR [rtnref]
GO
ALTER TABLE [dbo].[stbins] ADD  CONSTRAINT [DF_stbins_lcost]  DEFAULT ((0)) FOR [lcost]
GO
ALTER TABLE [dbo].[stbins] ADD  CONSTRAINT [DF_stbins_fcost]  DEFAULT ((0)) FOR [fcost]
GO
ALTER TABLE [dbo].[stbins] ADD  CONSTRAINT [DF_stbins_openlcost]  DEFAULT ((0)) FOR [openlcost]
GO
ALTER TABLE [dbo].[stbins] ADD  CONSTRAINT [DF_stbins_openfcost]  DEFAULT ((0)) FOR [openfcost]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_bcserial]  DEFAULT ((0)) FOR [bcserial]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_01]  DEFAULT ((0)) FOR [jv_01]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_02]  DEFAULT ((0)) FOR [jv_02]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_03]  DEFAULT ((0)) FOR [jv_03]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_04]  DEFAULT ((0)) FOR [jv_04]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_05]  DEFAULT ((0)) FOR [jv_05]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_06]  DEFAULT ((0)) FOR [jv_06]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_07]  DEFAULT ((0)) FOR [jv_07]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_08]  DEFAULT ((0)) FOR [jv_08]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_09]  DEFAULT ((0)) FOR [jv_09]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_10]  DEFAULT ((0)) FOR [jv_10]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_11]  DEFAULT ((0)) FOR [jv_11]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_12]  DEFAULT ((0)) FOR [jv_12]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_13]  DEFAULT ((0)) FOR [jv_13]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_14]  DEFAULT ((0)) FOR [jv_14]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_18]  DEFAULT ((0)) FOR [jv_18]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_19]  DEFAULT ((0)) FOR [jv_19]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_20]  DEFAULT ((0)) FOR [jv_20]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_21]  DEFAULT ((0)) FOR [jv_21]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_22]  DEFAULT ((0)) FOR [jv_22]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_23]  DEFAULT ((0)) FOR [jv_23]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_24]  DEFAULT ((0)) FOR [jv_24]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_26]  DEFAULT ((0)) FOR [jv_26]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_27]  DEFAULT ((0)) FOR [jv_27]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_28]  DEFAULT ((0)) FOR [jv_28]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_30]  DEFAULT ((0)) FOR [jv_30]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_31]  DEFAULT ((0)) FOR [jv_31]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_32]  DEFAULT ((0)) FOR [jv_32]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_33]  DEFAULT ((0)) FOR [jv_33]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_34]  DEFAULT ((0)) FOR [jv_34]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_calgl]  DEFAULT ((1)) FOR [calgl]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_calar]  DEFAULT ((1)) FOR [calar]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_calap]  DEFAULT ((1)) FOR [calap]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_calst]  DEFAULT ((1)) FOR [calst]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_45]  DEFAULT ((0)) FOR [jv_45]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_17]  DEFAULT ((0)) FOR [jv_17]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_16]  DEFAULT ((0)) FOR [jv_16]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_46]  DEFAULT ((0)) FOR [jv_46]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_jv_101]  DEFAULT ((0)) FOR [jv_101]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF_stbranch_manualser]  DEFAULT ((0)) FOR [manualser]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__fm_pri__7CC477D0]  DEFAULT ((0)) FOR [fm_price1]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__to_pri__7DB89C09]  DEFAULT ((0)) FOR [to_price1]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__doz_pr__7EACC042]  DEFAULT ((0)) FOR [doz_price1]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__ctn_pr__7FA0E47B]  DEFAULT ((0)) FOR [ctn_price1]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__fm_pri__009508B4]  DEFAULT ((0)) FOR [fm_price2]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__to_pri__01892CED]  DEFAULT ((0)) FOR [to_price2]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__doz_pr__027D5126]  DEFAULT ((0)) FOR [doz_price2]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__ctn_pr__0371755F]  DEFAULT ((0)) FOR [ctn_price2]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__fm_pri__04659998]  DEFAULT ((0)) FOR [fm_price3]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__to_pri__0559BDD1]  DEFAULT ((0)) FOR [to_price3]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__doz_pr__064DE20A]  DEFAULT ((0)) FOR [doz_price3]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__ctn_pr__07420643]  DEFAULT ((0)) FOR [ctn_price3]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__pricet__08362A7C]  DEFAULT ((1)) FOR [pricetp]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__sysno__092A4EB5]  DEFAULT ((1)) FOR [sysno]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__No_rou__0A1E72EE]  DEFAULT ((0)) FOR [No_round_nm]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__PriceV__0B129727]  DEFAULT ((1)) FOR [PriceVatType]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__mkt_fr__0C06BB60]  DEFAULT ((0)) FOR [mkt_frc_rounding]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__is_dsc__0CFADF99]  DEFAULT ((0)) FOR [is_dsc_amt]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__auto_d__0DEF03D2]  DEFAULT ((0)) FOR [auto_dsc_hll]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__max_ds__0EE3280B]  DEFAULT ((0)) FOR [max_dsc_hll]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__pos_ty__0FD74C44]  DEFAULT ((0)) FOR [pos_type]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__jv_51__10CB707D]  DEFAULT ((1)) FOR [jv_51]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__sc_lvl__11BF94B6]  DEFAULT ((1)) FOR [sc_lvlno]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__vat_pa__12B3B8EF]  DEFAULT ('') FOR [vat_paid_act]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__jv_105__13A7DD28]  DEFAULT ((0)) FOR [jv_105]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__jv_106__149C0161]  DEFAULT ((0)) FOR [jv_106]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__jv_107__1590259A]  DEFAULT ((0)) FOR [jv_107]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__jv_108__168449D3]  DEFAULT ((0)) FOR [jv_108]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__jv_109__17786E0C]  DEFAULT ((0)) FOR [jv_109]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__jv_110__186C9245]  DEFAULT ((0)) FOR [jv_110]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__Jv_37__1960B67E]  DEFAULT ((0)) FOR [Jv_37]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__jv_55__1A54DAB7]  DEFAULT ((0)) FOR [jv_55]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__jv_56__1B48FEF0]  DEFAULT ((0)) FOR [jv_56]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__JV_60__1C3D2329]  DEFAULT ((1)) FOR [JV_60]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__JV_61__1D314762]  DEFAULT ((1)) FOR [JV_61]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__distri__1E256B9B]  DEFAULT ('') FOR [district]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__distri__1F198FD4]  DEFAULT ('') FOR [district_l]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__city_t__200DB40D]  DEFAULT ('') FOR [city_text]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__city_t__2101D846]  DEFAULT ('') FOR [city_text_l]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__postal__21F5FC7F]  DEFAULT ('') FOR [postal_code]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__bldg_n__22EA20B8]  DEFAULT ('') FOR [bldg_no]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__bldg_n__23DE44F1]  DEFAULT ('') FOR [bldg_no_l]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__street__24D2692A]  DEFAULT ('') FOR [street_name]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__street__25C68D63]  DEFAULT ('') FOR [street_name_l]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__area_n__26BAB19C]  DEFAULT ('') FOR [area_name]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__area_n__27AED5D5]  DEFAULT ('') FOR [area_name_l]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__extra___28A2FA0E]  DEFAULT ('') FOR [extra_address_no]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__extra___29971E47]  DEFAULT ('') FOR [extra_address_no_l]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__crdt_l__2A8B4280]  DEFAULT ((0)) FOR [crdt_limit]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__Street__2B7F66B9]  DEFAULT ('') FOR [Street_Name2]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__Street__2C738AF2]  DEFAULT ('') FOR [Street_Name2_l]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__Group___2D67AF2B]  DEFAULT ('') FOR [Group_VAT_ID]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__Other___2E5BD364]  DEFAULT ('') FOR [Other_id_SchemeID]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__countr__2F4FF79D]  DEFAULT ((0)) FOR [country_code]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__Other___30441BD6]  DEFAULT ('') FOR [Other_Scheme_Type]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__vat_rc__5D8BC399]  DEFAULT ('') FOR [vat_rcvd_act]
GO
ALTER TABLE [dbo].[stbranch] ADD  CONSTRAINT [DF__stbranch__remote__61B15A38]  DEFAULT ('') FOR [remote_br_sqlserver]
GO
ALTER TABLE [dbo].[stbranch] ADD  DEFAULT ('') FOR [rvnuact]
GO
ALTER TABLE [dbo].[stbranch] ADD  DEFAULT ((0)) FOR [jv_301]
GO
ALTER TABLE [dbo].[stbranch] ADD  DEFAULT ((1)) FOR [jv_205]
GO
ALTER TABLE [dbo].[stbranch] ADD  DEFAULT ((1)) FOR [jv_209]
GO
ALTER TABLE [dbo].[stbranch] ADD  DEFAULT ((1)) FOR [jv_210]
GO
ALTER TABLE [dbo].[stbranch] ADD  DEFAULT ((1)) FOR [jv_211]
GO
ALTER TABLE [dbo].[stbranch] ADD  DEFAULT ((1)) FOR [jv_212]
GO
ALTER TABLE [dbo].[stbranch] ADD  DEFAULT ((1)) FOR [jv_213]
GO
ALTER TABLE [dbo].[stbranch] ADD  DEFAULT ((1)) FOR [jv_214]
GO
ALTER TABLE [dbo].[stbranch] ADD  DEFAULT ((1)) FOR [jv_215]
GO
ALTER TABLE [dbo].[stbranch] ADD  DEFAULT ((1)) FOR [jv_216]
GO
ALTER TABLE [dbo].[stbrprice] ADD  CONSTRAINT [DF_stbrprice_slcenter]  DEFAULT ('  ') FOR [slcenter]
GO
ALTER TABLE [dbo].[stbrprice] ADD  CONSTRAINT [DF_stbrprice_lprice1]  DEFAULT ((0)) FOR [lprice1]
GO
ALTER TABLE [dbo].[stbrprice] ADD  CONSTRAINT [DF_stbrprice_lprice2]  DEFAULT ((0)) FOR [lprice2]
GO
ALTER TABLE [dbo].[stbrprice] ADD  CONSTRAINT [DF_stbrprice_lprice3]  DEFAULT ((0)) FOR [lprice3]
GO
ALTER TABLE [dbo].[stbrprice] ADD  CONSTRAINT [DF_stbrprice_maxdisc1]  DEFAULT ((0)) FOR [maxdisc1]
GO
ALTER TABLE [dbo].[stbrprice] ADD  CONSTRAINT [DF_stbrprice_maxdisc2]  DEFAULT ((0)) FOR [maxdisc2]
GO
ALTER TABLE [dbo].[stbrprice] ADD  CONSTRAINT [DF_stbrprice_maxdisc3]  DEFAULT ((0)) FOR [maxdisc3]
GO
ALTER TABLE [dbo].[stbrprice] ADD  CONSTRAINT [DF_stbrprice_mnmprice]  DEFAULT ((0)) FOR [mnmprice]
GO
ALTER TABLE [dbo].[stbrprice] ADD  CONSTRAINT [DF_stbrprice_pprice1]  DEFAULT ((0)) FOR [pprice1]
GO
ALTER TABLE [dbo].[stbrprice] ADD  CONSTRAINT [DF_stbrprice_pprice2]  DEFAULT ((0)) FOR [pprice2]
GO
ALTER TABLE [dbo].[stbrprice] ADD  CONSTRAINT [DF_stbrprice_pprice3]  DEFAULT ((0)) FOR [pprice3]
GO
ALTER TABLE [dbo].[stbrprice] ADD  CONSTRAINT [DF_stbrprice_promotion]  DEFAULT ((0)) FOR [promotion]
GO
ALTER TABLE [dbo].[stbrprice] ADD  CONSTRAINT [DF_stbrprice_slsprsnt]  DEFAULT ((0)) FOR [slsprsnt]
GO
ALTER TABLE [dbo].[stbrprice] ADD  CONSTRAINT [DF_stbrprice_fprice1]  DEFAULT ((0)) FOR [fprice1]
GO
ALTER TABLE [dbo].[stbrprice] ADD  CONSTRAINT [DF_stbrprice_fprice2]  DEFAULT ((0)) FOR [fprice2]
GO
ALTER TABLE [dbo].[stbrprice] ADD  CONSTRAINT [DF_stbrprice_fprice3]  DEFAULT ((0)) FOR [fprice3]
GO
ALTER TABLE [dbo].[stbrprice] ADD  CONSTRAINT [DF_stbrprice_modified]  DEFAULT ((0)) FOR [modified]
GO
ALTER TABLE [dbo].[stclass] ADD  DEFAULT ((0)) FOR [max_sl_limit]
GO
ALTER TABLE [dbo].[stcommission] ADD  CONSTRAINT [DF_stcommission_commtype]  DEFAULT ((1)) FOR [commtype]
GO
ALTER TABLE [dbo].[stcommission] ADD  CONSTRAINT [DF_stcommission_commession]  DEFAULT ((0)) FOR [commission]
GO
ALTER TABLE [dbo].[stcommission] ADD  CONSTRAINT [DF_stcommission_cmtarget]  DEFAULT ((0)) FOR [cmntarget]
GO
ALTER TABLE [dbo].[stcommission] ADD  CONSTRAINT [DF_stcommission_cmnactive]  DEFAULT ((0)) FOR [InActive]
GO
ALTER TABLE [dbo].[stcommission] ADD  CONSTRAINT [DF_stcommission_cmsn_on_qty]  DEFAULT ((0)) FOR [cmsn_onQty]
GO
ALTER TABLE [dbo].[stcommission] ADD  DEFAULT ((0)) FOR [cmsn_calctype]
GO
ALTER TABLE [dbo].[stcommission] ADD  DEFAULT ((0)) FOR [cmsn_perqty]
GO
ALTER TABLE [dbo].[stcommission] ADD  DEFAULT ((0)) FOR [cmsn_payval]
GO
ALTER TABLE [dbo].[stcosttype] ADD  CONSTRAINT [DF_stcosttype_lastlcost]  DEFAULT ((0)) FOR [lastlcost]
GO
ALTER TABLE [dbo].[stcosttype] ADD  CONSTRAINT [DF_stcosttype_highlcost]  DEFAULT ((0)) FOR [highlcost]
GO
ALTER TABLE [dbo].[stcosttype] ADD  CONSTRAINT [DF_stcosttype_lowlcost]  DEFAULT ((0)) FOR [lowlcost]
GO
ALTER TABLE [dbo].[stcosttype] ADD  CONSTRAINT [DF_stcosttype_lastfcost]  DEFAULT ((0)) FOR [lastfcost]
GO
ALTER TABLE [dbo].[stcosttype] ADD  DEFAULT ('') FOR [frstrcvdate]
GO
ALTER TABLE [dbo].[stcosttype] ADD  DEFAULT ('') FOR [frstrcvd01]
GO
ALTER TABLE [dbo].[stcosttype] ADD  DEFAULT ('') FOR [lastrcvd01]
GO
ALTER TABLE [dbo].[stcosttype] ADD  DEFAULT ((0)) FOR [lastlcost01]
GO
ALTER TABLE [dbo].[stcosttype] ADD  DEFAULT ((0)) FOR [frstlcost01]
GO
ALTER TABLE [dbo].[stcosttype] ADD  DEFAULT ((0)) FOR [pufrstlcost]
GO
ALTER TABLE [dbo].[stcosttype] ADD  DEFAULT ('') FOR [brlastissue]
GO
ALTER TABLE [dbo].[stcrtpuinv] ADD  CONSTRAINT [DF_stcrtpuinv_rplct_post]  DEFAULT ((0)) FOR [rplct_post]
GO
ALTER TABLE [dbo].[stcrtpuinv] ADD  DEFAULT ('') FOR [slcode]
GO
ALTER TABLE [dbo].[stdtl] ADD  CONSTRAINT [DF_stdtl_lprice]  DEFAULT ((0)) FOR [lprice]
GO
ALTER TABLE [dbo].[stdtl] ADD  CONSTRAINT [DF_stdtl_fcost]  DEFAULT ((0)) FOR [fcost]
GO
ALTER TABLE [dbo].[stdtl] ADD  CONSTRAINT [DF_stdtl_discpc]  DEFAULT ((0)) FOR [discpc]
GO
ALTER TABLE [dbo].[stdtl] ADD  CONSTRAINT [DF_stdtl_folio]  DEFAULT ((0)) FOR [folio]
GO
ALTER TABLE [dbo].[stdtl] ADD  CONSTRAINT [DF_stdtl_rplct_post]  DEFAULT ((0)) FOR [rplct_post]
GO
ALTER TABLE [dbo].[stdtl] ADD  DEFAULT ((0)) FOR [q_frt]
GO
ALTER TABLE [dbo].[sthdr] ADD  CONSTRAINT [DF_sthdr_entries]  DEFAULT ((0)) FOR [entries]
GO
ALTER TABLE [dbo].[sthdr] ADD  DEFAULT ((0)) FOR [repost]
GO
ALTER TABLE [dbo].[sthdr] ADD  DEFAULT ((0)) FOR [items_rcvd]
GO
ALTER TABLE [dbo].[sthdr] ADD  DEFAULT ((0)) FOR [trx_printed]
GO
ALTER TABLE [dbo].[sthdr] ADD  DEFAULT ('') FOR [pricetp]
GO
ALTER TABLE [dbo].[sthdr] ADD  DEFAULT ((0)) FOR [Damaged]
GO
ALTER TABLE [dbo].[stitembc] ADD  CONSTRAINT [DF_stitembc_pkqty]  DEFAULT ((1)) FOR [pkqty]
GO
ALTER TABLE [dbo].[stitembc] ADD  CONSTRAINT [DF_stitembc_weight]  DEFAULT ((0)) FOR [weight]
GO
ALTER TABLE [dbo].[stitembc] ADD  CONSTRAINT [DF_stitembc_pkorder]  DEFAULT ((0)) FOR [pkorder]
GO
ALTER TABLE [dbo].[stitemnqati] ADD  CONSTRAINT [DF_stitemnqati_nqati_prcnt]  DEFAULT ((0)) FOR [nqati_prcnt]
GO
ALTER TABLE [dbo].[stitemnqati] ADD  CONSTRAINT [DF_stitemnqati_dsc_prcnt]  DEFAULT ((0)) FOR [dsc_prcnt]
GO
ALTER TABLE [dbo].[stitems] ADD  CONSTRAINT [DF_stitems_vprice]  DEFAULT ((0)) FOR [vprice]
GO
ALTER TABLE [dbo].[stitems] ADD  CONSTRAINT [DF_stitems_fix_barcode]  DEFAULT ((1)) FOR [fix_barcode]
GO
ALTER TABLE [dbo].[stitems] ADD  DEFAULT ('') FOR [taxtype]
GO
ALTER TABLE [dbo].[stitmphoto] ADD  DEFAULT ((0)) FOR [ord_qty]
GO
ALTER TABLE [dbo].[stitmphoto] ADD  DEFAULT ('') FOR [mnimumdt]
GO
ALTER TABLE [dbo].[stitmphoto] ADD  DEFAULT ((0)) FOR [cust_pctg]
GO
ALTER TABLE [dbo].[stitmphoto] ADD  DEFAULT ((0)) FOR [is_double_width]
GO
ALTER TABLE [dbo].[stitmphoto] ADD  DEFAULT ((0)) FOR [is_price_per_length]
GO
ALTER TABLE [dbo].[stitmphoto] ADD  DEFAULT ((0)) FOR [is_accessory_stk_item]
GO
ALTER TABLE [dbo].[stitmphoto] ADD  DEFAULT ((0)) FOR [dsc_amt1]
GO
ALTER TABLE [dbo].[stitmphoto] ADD  DEFAULT ((0)) FOR [dsc_amt2]
GO
ALTER TABLE [dbo].[stitmphoto] ADD  DEFAULT ((0)) FOR [dsc_amt3]
GO
ALTER TABLE [dbo].[stitmphoto] ADD  DEFAULT ('') FOR [usrid]
GO
ALTER TABLE [dbo].[stitmphoto] ADD  DEFAULT ('') FOR [usrid_lstchg]
GO
ALTER TABLE [dbo].[stitmphoto] ADD  DEFAULT ('') FOR [exemption_reason_code]
GO
ALTER TABLE [dbo].[stitmphoto] ADD  DEFAULT ((0)) FOR [onlinesales]
GO
ALTER TABLE [dbo].[stitmphoto] ADD  DEFAULT ((0)) FOR [extra_tax_p]
GO
ALTER TABLE [dbo].[stitmphoto] ADD  DEFAULT ('') FOR [startdate]
GO
ALTER TABLE [dbo].[stitmphoto] ADD  DEFAULT ('') FOR [enddate]
GO
ALTER TABLE [dbo].[stoffer_grp_hd] ADD  DEFAULT ((0)) FOR [grp_flexable]
GO
ALTER TABLE [dbo].[stoffers] ADD  CONSTRAINT [DF_stoffers_DiscountP]  DEFAULT ((0)) FOR [DiscountP]
GO
ALTER TABLE [dbo].[stoffers] ADD  CONSTRAINT [DF_stoffers_InActive]  DEFAULT ((0)) FOR [InActive]
GO
ALTER TABLE [dbo].[stoffers] ADD  CONSTRAINT [DF_stoffers_Max2buy]  DEFAULT ((0)) FOR [Max2buy]
GO
ALTER TABLE [dbo].[stoffers] ADD  CONSTRAINT [DF__stoffers__itemgr__01F34141]  DEFAULT ('') FOR [itemgroup]
GO
ALTER TABLE [dbo].[stoffers] ADD  DEFAULT ('') FOR [cmbkey]
GO
ALTER TABLE [dbo].[stoffers] ADD  DEFAULT ((0)) FOR [qty_offer_sold]
GO
ALTER TABLE [dbo].[stoffers] ADD  DEFAULT ((0)) FOR [offer_no]
GO
ALTER TABLE [dbo].[stoffers_dt] ADD  DEFAULT ((0)) FOR [offer_no]
GO
ALTER TABLE [dbo].[streorderQP] ADD  CONSTRAINT [DF_streorderQP_reorderQ]  DEFAULT ((0)) FOR [reorderQ]
GO
ALTER TABLE [dbo].[streorderQP] ADD  DEFAULT ((0)) FOR [reorderD]
GO
ALTER TABLE [dbo].[streorderQP] ADD  DEFAULT ((0)) FOR [reorderP]
GO
ALTER TABLE [dbo].[stunits] ADD  CONSTRAINT [DF_stunits_openlcost]  DEFAULT ((0)) FOR [openlcost]
GO
ALTER TABLE [dbo].[stunits] ADD  CONSTRAINT [DF_stunits_lcost]  DEFAULT ((0)) FOR [lcost]
GO
ALTER TABLE [dbo].[stunits] ADD  CONSTRAINT [DF_stunits_fprice1]  DEFAULT ((0)) FOR [fprice1]
GO
ALTER TABLE [dbo].[stunits] ADD  CONSTRAINT [DF_stunits_maxdisc1]  DEFAULT ((0)) FOR [maxdisc1]
GO
ALTER TABLE [dbo].[stunits] ADD  CONSTRAINT [DF_stunits_fprice2]  DEFAULT ((0)) FOR [fprice2]
GO
ALTER TABLE [dbo].[stunits] ADD  CONSTRAINT [DF_stunits_maxdisc2]  DEFAULT ((0)) FOR [maxdisc2]
GO
ALTER TABLE [dbo].[stunits] ADD  CONSTRAINT [DF_stunits_lprice3]  DEFAULT ((0)) FOR [lprice3]
GO
ALTER TABLE [dbo].[stunits] ADD  CONSTRAINT [DF_stunits_fprice3]  DEFAULT ((0)) FOR [fprice3]
GO
ALTER TABLE [dbo].[stunits] ADD  CONSTRAINT [DF_stunits_maxdisc3]  DEFAULT ((0)) FOR [maxdisc3]
GO
ALTER TABLE [dbo].[stunits] ADD  CONSTRAINT [DF_stunits_openfcost]  DEFAULT ((0)) FOR [openfcost]
GO
ALTER TABLE [dbo].[stunits] ADD  CONSTRAINT [DF_stunits_fcost]  DEFAULT ((0)) FOR [fcost]
GO
ALTER TABLE [dbo].[stunits] ADD  CONSTRAINT [DF_stunits_minstk]  DEFAULT ((0)) FOR [minstk]
GO
ALTER TABLE [dbo].[stunits] ADD  CONSTRAINT [DF_stunits_maxstk]  DEFAULT ((0)) FOR [maxstk]
GO
ALTER TABLE [dbo].[stunits] ADD  CONSTRAINT [DF_stunits_orderlevel]  DEFAULT ((0)) FOR [orderlevel]
GO
ALTER TABLE [dbo].[stunits] ADD  CONSTRAINT [DF_stunits_leadday]  DEFAULT ((0)) FOR [leadday]
GO
ALTER TABLE [dbo].[stunits] ADD  CONSTRAINT [DF_stunits_pkqty1]  DEFAULT ((0)) FOR [pkqty1]
GO
ALTER TABLE [dbo].[stunits] ADD  CONSTRAINT [DF_stunits_pkqty2]  DEFAULT ((0)) FOR [pkqty2]
GO
ALTER TABLE [dbo].[stunits] ADD  CONSTRAINT [DF_stunits_pkqty3]  DEFAULT ((0)) FOR [pkqty3]
GO
ALTER TABLE [dbo].[stunits] ADD  CONSTRAINT [DF_stunits_mnmprice]  DEFAULT ((0)) FOR [mnmprice]
GO
ALTER TABLE [dbo].[stunits] ADD  CONSTRAINT [DF_stunits_invqty]  DEFAULT ((0)) FOR [invqty]
GO
ALTER TABLE [dbo].[stwhous] ADD  DEFAULT ((0)) FOR [no_autosales]
GO
ALTER TABLE [dbo].[stwhous] ADD  DEFAULT ((0)) FOR [suspended]
GO
ALTER TABLE [dbo].[stwhous] ADD  DEFAULT ('A00001') FOR [binsrlno]
GO
ALTER TABLE [dbo].[stwhous] ADD  DEFAULT ((0)) FOR [xfrfm_mustbinnno]
GO
ALTER TABLE [dbo].[stwhous] ADD  DEFAULT ((0)) FOR [xfrto_mustbinnno]
GO
ALTER TABLE [dbo].[stwhzones] ADD  CONSTRAINT [DF_stwhzones_zn_autocreate]  DEFAULT ((0)) FOR [zn_autocreate]
GO
ALTER TABLE [dbo].[stwhzones] ADD  CONSTRAINT [DF_stwhzones_zn_rackcounts]  DEFAULT ((0)) FOR [zn_rackcounts]
GO
ALTER TABLE [dbo].[stwhzones] ADD  CONSTRAINT [DF_stwhzones_zn_startrack]  DEFAULT ((0)) FOR [zn_rackbegin]
GO
ALTER TABLE [dbo].[stwmaloc_dt] ADD  DEFAULT ('') FOR [xwhno]
GO
ALTER TABLE [dbo].[stwmaloc_hd] ADD  CONSTRAINT [DF_stwmputaway_multiloc]  DEFAULT ((0)) FOR [multiloctn]
GO
ALTER TABLE [dbo].[stwmaloc_hd] ADD  DEFAULT ((0)) FOR [brreturned]
GO
ALTER TABLE [dbo].[stwmcntnr_dt] ADD  CONSTRAINT [DF_stcontainer_dt_pkqty]  DEFAULT ((1)) FOR [pkqty]
GO
ALTER TABLE [dbo].[stwmcntnr_hd] ADD  CONSTRAINT [DF_stcontainer_hd_cnt_item_count]  DEFAULT ((0)) FOR [cn_item_count]
GO
ALTER TABLE [dbo].[stwmcntnr_hd] ADD  CONSTRAINT [DF_stwmcntnr_hd_cn_length]  DEFAULT ((0)) FOR [cn_length]
GO
ALTER TABLE [dbo].[stwmcntnr_hd] ADD  CONSTRAINT [DF_stwmcntnr_hd_cn_width]  DEFAULT ((0)) FOR [cn_width]
GO
ALTER TABLE [dbo].[stwmcntnr_hd] ADD  CONSTRAINT [DF_stwmcntnr_hd_cn_height]  DEFAULT ((0)) FOR [cn_height]
GO
ALTER TABLE [dbo].[stwmcntnr_hd] ADD  CONSTRAINT [DF_stwmcntnr_hd_cn_ttlqty]  DEFAULT ((0)) FOR [cn_ttlqty]
GO
ALTER TABLE [dbo].[stwmcntnrtrx_dt] ADD  DEFAULT ('') FOR [rtn_cnstatus]
GO
ALTER TABLE [dbo].[supplier] ADD  CONSTRAINT [DF_supplier_cu_opnbal]  DEFAULT ((0)) FOR [cu_opnbal]
GO
ALTER TABLE [dbo].[supplier] ADD  CONSTRAINT [DF_supplier_cu_curbal]  DEFAULT ((0)) FOR [cu_curbal]
GO
ALTER TABLE [dbo].[supplier] ADD  CONSTRAINT [DF_supplier_cf_opnfcy]  DEFAULT ((0)) FOR [cf_opnfcy]
GO
ALTER TABLE [dbo].[supplier] ADD  CONSTRAINT [DF_supplier_cf_curfcy]  DEFAULT ((0)) FOR [cf_curfcy]
GO
ALTER TABLE [dbo].[supplier] ADD  CONSTRAINT [DF_supplier_cu_lcaloc]  DEFAULT ((0)) FOR [cu_lcaloc]
GO
ALTER TABLE [dbo].[supplier] ADD  CONSTRAINT [DF_supplier_cu_fcaloc]  DEFAULT ((0)) FOR [cu_fcaloc]
GO
ALTER TABLE [dbo].[supplier] ADD  CONSTRAINT [DF__supplier__whno__4D9F7493]  DEFAULT ('') FOR [whno]
GO
ALTER TABLE [dbo].[supplier] ADD  CONSTRAINT [DF__supplier__vndr_t__4E9398CC]  DEFAULT ('') FOR [vndr_taxcode]
GO
ALTER TABLE [dbo].[supplier] ADD  CONSTRAINT [DF__supplier__taxFre__4F87BD05]  DEFAULT ((0)) FOR [taxFree]
GO
ALTER TABLE [dbo].[supplier] ADD  CONSTRAINT [DF__supplier__cu_kin__507BE13E]  DEFAULT ('') FOR [cu_kind]
GO
ALTER TABLE [dbo].[supplier] ADD  CONSTRAINT [DF__supplier__PriceI__526429B0]  DEFAULT ((0)) FOR [PriceIncludeVat]
GO
ALTER TABLE [dbo].[supplier] ADD  CONSTRAINT [DF__supplier__cu_typ__53584DE9]  DEFAULT ('') FOR [cu_type]
GO
ALTER TABLE [dbo].[sysgp] ADD  DEFAULT ('') FOR [ussctnalw]
GO
ALTER TABLE [dbo].[sysuse] ADD  CONSTRAINT [DF_sysuse_suspend]  DEFAULT ((0)) FOR [suspend]
GO
ALTER TABLE [dbo].[sysuse] ADD  CONSTRAINT [DF_sysuse_posuser]  DEFAULT ((0)) FOR [posuser]
GO
ALTER TABLE [dbo].[sysuse] ADD  CONSTRAINT [DF_sysuse_hide_jv]  DEFAULT ((0)) FOR [ushide_jv]
GO
ALTER TABLE [dbo].[sysuse] ADD  CONSTRAINT [DF_sysuse_uschdlcshinv]  DEFAULT ((0)) FOR [uschdlcshinv]
GO
ALTER TABLE [dbo].[sysuse] ADD  CONSTRAINT [DF_sysuse_uschdlcshrcv]  DEFAULT ((0)) FOR [uschdlcshrcv]
GO
ALTER TABLE [dbo].[sysuse] ADD  CONSTRAINT [DF_sysuse_uschdlchqrcv]  DEFAULT ((0)) FOR [uschdlchqrcv]
GO
ALTER TABLE [dbo].[sysuse] ADD  CONSTRAINT [DF_sysuse_us_no_profit]  DEFAULT ((0)) FOR [usshowprofit]
GO
ALTER TABLE [dbo].[sysuse] ADD  CONSTRAINT [DF_sysuse_goblwmnmp]  DEFAULT ((0)) FOR [goblwmnmp]
GO
ALTER TABLE [dbo].[sysuse] ADD  CONSTRAINT [DF_sysuse_mobileuser]  DEFAULT ((0)) FOR [mobileuser]
GO
ALTER TABLE [dbo].[sysuse] ADD  CONSTRAINT [DF_sysuse_confirmPurchase]  DEFAULT ((0)) FOR [confirmPurchase]
GO
ALTER TABLE [dbo].[sysuse] ADD  CONSTRAINT [DF_sysuse_noovrdrft]  DEFAULT ((0)) FOR [noovrdrft]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [onlyactrmt]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [confirmbr]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [confirmtrnsfr]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [nopriceblwcost]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [mgmtcnfrm]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ('') FOR [mobilNo]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [OTP]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ('') FOR [web_rights]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [NorgstrNoSl]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ('') FOR [ussctnalw]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [Noslsblwcst]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [AlwChangeVAT]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ('') FOR [emp_code]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [blkassmbld]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ('') FOR [usfpimage2]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [max_inv_printed]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [max_fsh_printed]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [usissrqst]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [usstiss]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [usstrcv]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((1)) FOR [e_invrdy]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [smartsearch]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [applymnmallprices]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((1)) FOR [smartsrch_itemBaltype]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [puinv_cost_notalwd]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [mnmppalw]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [nopostslinv]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [nopostpuinv]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [nopoststtrx]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [nochgmaxlmt]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [no_item_duplicate]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [no_item_srch_in_puinv]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [alwslfrmslnobal]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [nochngpromo]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [dsplyothersQH]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [hideqhinfo]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [alwchg_slrtn_price]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [noadd_crdt_clnt]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [archv_upload]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [archv_download]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [archv_open]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [archv_delete]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [alw2usewtsapp]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [alw2chgwtsmbl]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [smrtsrch4cmbkey]
GO
ALTER TABLE [dbo].[sysuse] ADD  DEFAULT ((0)) FOR [use_dashboard]
GO
ALTER TABLE [dbo].[tailor_Closure_types] ADD  DEFAULT ((0)) FOR [rcrd_ordr]
GO
ALTER TABLE [dbo].[tailor_Collar_types] ADD  DEFAULT ((0)) FOR [rcrd_ordr]
GO
ALTER TABLE [dbo].[tailor_fix_dt] ADD  DEFAULT ((0)) FOR [is_accessory_stk_item]
GO
ALTER TABLE [dbo].[tailor_fix_hd] ADD  CONSTRAINT [DF__tailor_fi__prfrd__5748DA5E]  DEFAULT (' ') FOR [prfrd_trcode]
GO
ALTER TABLE [dbo].[tailor_fix_hd] ADD  CONSTRAINT [DF__tailor_fi__fm_us__6C43F744]  DEFAULT ((0)) FOR [fm_us_qty]
GO
ALTER TABLE [dbo].[tailor_fix_hd] ADD  CONSTRAINT [DF__tailor_fi__fm_cu__6A5BAED2]  DEFAULT ((0)) FOR [fm_cust_qty]
GO
ALTER TABLE [dbo].[tailor_fix_hd] ADD  DEFAULT ((0)) FOR [vat_percent]
GO
ALTER TABLE [dbo].[tailor_fix_hd] ADD  DEFAULT (' ') FOR [category]
GO
ALTER TABLE [dbo].[tailor_kabak_types] ADD  DEFAULT ((0)) FOR [rcrd_ordr]
GO
ALTER TABLE [dbo].[tailor_ord_dt] ADD  DEFAULT ((0)) FOR [unt_size]
GO
ALTER TABLE [dbo].[tailor_ord_dt] ADD  DEFAULT ((0)) FOR [agreed_price]
GO
ALTER TABLE [dbo].[tailor_ord_dt] ADD  DEFAULT ((0)) FOR [tylrng_srvc_fee]
GO
ALTER TABLE [dbo].[tailor_ord_dt] ADD  DEFAULT ((0)) FOR [is_double_width]
GO
ALTER TABLE [dbo].[tailor_ord_dt] ADD  DEFAULT ((0)) FOR [is_accessory_stk_item]
GO
ALTER TABLE [dbo].[tailor_ord_hd] ADD  CONSTRAINT [DF__tailor_or__prfrd__5654B625]  DEFAULT (' ') FOR [prfrd_trcode]
GO
ALTER TABLE [dbo].[tailor_ord_hd] ADD  CONSTRAINT [DF__tailor_or__fm_us__6B4FD30B]  DEFAULT ((0)) FOR [fm_us_qty]
GO
ALTER TABLE [dbo].[tailor_ord_hd] ADD  CONSTRAINT [DF__tailor_or__fm_cu__69678A99]  DEFAULT ((0)) FOR [fm_cust_qty]
GO
ALTER TABLE [dbo].[tailor_ord_hd] ADD  DEFAULT ((0)) FOR [vat_percent]
GO
ALTER TABLE [dbo].[tailor_ord_hd] ADD  DEFAULT (' ') FOR [category]
GO
ALTER TABLE [dbo].[tailor_ord_size] ADD  DEFAULT ((0)) FOR [weight]
GO
ALTER TABLE [dbo].[tailor_ord_size] ADD  DEFAULT ((0)) FOR [collar_width2_glab]
GO
ALTER TABLE [dbo].[tailor_ord_size] ADD  DEFAULT ((0)) FOR [sleeve_width2_kbk]
GO
ALTER TABLE [dbo].[tailor_ord_size] ADD  DEFAULT ((0)) FOR [sleeve_width3_kbk]
GO
ALTER TABLE [dbo].[tailor_ord_size] ADD  DEFAULT ((0)) FOR [sleeve_height_kbk]
GO
ALTER TABLE [dbo].[tailor_ord_size] ADD  DEFAULT ((0)) FOR [sleeve_width2_normal]
GO
ALTER TABLE [dbo].[tailor_ord_size] ADD  DEFAULT (' ') FOR [category]
GO
ALTER TABLE [dbo].[tailor_ord_size] ADD  DEFAULT (' ') FOR [stickers_type]
GO
ALTER TABLE [dbo].[tailor_ready_made_sales] ADD  CONSTRAINT [DF_tr_ready_made_sales_sysno]  DEFAULT ((1)) FOR [sysno]
GO
ALTER TABLE [dbo].[tailor_ready_made_sales] ADD  DEFAULT ((0)) FOR [vat_percent]
GO
ALTER TABLE [dbo].[tailor_rtrn_dt] ADD  DEFAULT ((0)) FOR [unt_size]
GO
ALTER TABLE [dbo].[tailor_rtrn_dt] ADD  DEFAULT ((0)) FOR [agreed_price]
GO
ALTER TABLE [dbo].[tailor_rtrn_dt] ADD  DEFAULT ((0)) FOR [tylrng_srvc_fee]
GO
ALTER TABLE [dbo].[tailor_rtrn_dt] ADD  DEFAULT ((0)) FOR [is_double_width]
GO
ALTER TABLE [dbo].[tailor_rtrn_hd] ADD  DEFAULT ((0)) FOR [vat_percent]
GO
ALTER TABLE [dbo].[tailor_rtrn_hd] ADD  DEFAULT ((0)) FOR [rtrnd_fm_us_qty]
GO
ALTER TABLE [dbo].[tailor_rtrn_hd] ADD  DEFAULT ((0)) FOR [rtrnd_fm_cust_qty]
GO
ALTER TABLE [dbo].[tailor_setup] ADD  DEFAULT (' ') FOR [dsc_acct_ser]
GO
ALTER TABLE [dbo].[tailor_setup] ADD  DEFAULT (' ') FOR [our_tylrng_srvc_cmbkey]
GO
ALTER TABLE [dbo].[tailor_setup] ADD  DEFAULT ((0)) FOR [our_tylrng_srvc_fee]
GO
ALTER TABLE [dbo].[tailor_setup] ADD  DEFAULT (' ') FOR [clnt_tylrng_srvc_cmbkey]
GO
ALTER TABLE [dbo].[tailor_setup] ADD  DEFAULT ((0)) FOR [clnt_tylrng_srvc_fee]
GO
ALTER TABLE [dbo].[tailor_setup] ADD  DEFAULT ((0)) FOR [ok_price_per_length]
GO
ALTER TABLE [dbo].[tailor_setup] ADD  DEFAULT ((0)) FOR [long_starts_fm]
GO
ALTER TABLE [dbo].[tailor_setup] ADD  DEFAULT ((0)) FOR [coat_our_tylrng_srvc_fee]
GO
ALTER TABLE [dbo].[tailor_setup] ADD  DEFAULT ((0)) FOR [coat_clnt_tylrng_srvc_fee]
GO
ALTER TABLE [dbo].[tailor_setup] ADD  DEFAULT ('') FOR [no_xtrnl_prd1_fm]
GO
ALTER TABLE [dbo].[tailor_setup] ADD  DEFAULT ('') FOR [no_xtrnl_prd1_to]
GO
ALTER TABLE [dbo].[tailor_setup] ADD  DEFAULT ('') FOR [no_xtrnl_prd2_fm]
GO
ALTER TABLE [dbo].[tailor_setup] ADD  DEFAULT ('') FOR [no_xtrnl_prd2_to]
GO
ALTER TABLE [dbo].[tailor_setup] ADD  DEFAULT (' ') FOR [sc_code]
GO
ALTER TABLE [dbo].[tailor_setup] ADD  DEFAULT ('') FOR [cu_class]
GO
ALTER TABLE [dbo].[taxcategory] ADD  CONSTRAINT [DF_Table_1_class_protected]  DEFAULT ((0)) FOR [cat_protected]
GO
ALTER TABLE [dbo].[taxcategory] ADD  CONSTRAINT [DF_taxcategory_In_out_tax]  DEFAULT ((1)) FOR [In_out_tax]
GO
ALTER TABLE [dbo].[taxcategory] ADD  CONSTRAINT [DF_taxcategory_txdsc_allowed]  DEFAULT ((0)) FOR [txdsc_allowed]
GO
ALTER TABLE [dbo].[taxperiod] ADD  DEFAULT ((0)) FOR [Jv_Vat_Percent]
GO
ALTER TABLE [dbo].[ttkfile] ADD  DEFAULT ((0)) FOR [nobin]
GO
ALTER TABLE [dbo].[ttkhdr] ADD  DEFAULT ((0)) FOR [ttkmanual]
GO
ALTER TABLE [dbo].[ttknfile] ADD  CONSTRAINT [DF_ttknfile_q1]  DEFAULT ((0)) FOR [q1]
GO
ALTER TABLE [dbo].[ttknfile] ADD  CONSTRAINT [DF_ttknfile_f1]  DEFAULT ((0)) FOR [f1]
GO
ALTER TABLE [dbo].[ttknfile] ADD  CONSTRAINT [DF_ttknfile_q2]  DEFAULT ((0)) FOR [q2]
GO
ALTER TABLE [dbo].[ttknfile] ADD  CONSTRAINT [DF_ttknfile_f2]  DEFAULT ((0)) FOR [f2]
GO
ALTER TABLE [dbo].[ttknfile] ADD  CONSTRAINT [DF_ttknfile_q3]  DEFAULT ((0)) FOR [q3]
GO
ALTER TABLE [dbo].[ttknfile] ADD  CONSTRAINT [DF_ttknfile_f3]  DEFAULT ((0)) FOR [f3]
GO
ALTER TABLE [dbo].[ttknfile] ADD  CONSTRAINT [DF_ttknfile_q4]  DEFAULT ((0)) FOR [q4]
GO
ALTER TABLE [dbo].[ttknfile] ADD  CONSTRAINT [DF_ttknfile_f4]  DEFAULT ((0)) FOR [f4]
GO
ALTER TABLE [dbo].[ttknfile] ADD  CONSTRAINT [DF_ttknfile_q5]  DEFAULT ((0)) FOR [q5]
GO
ALTER TABLE [dbo].[ttknfile] ADD  CONSTRAINT [DF_ttknfile_f5]  DEFAULT ((0)) FOR [f5]
GO
ALTER TABLE [dbo].[ttknfile] ADD  CONSTRAINT [DF_ttknfile_q6]  DEFAULT ((0)) FOR [q6]
GO
ALTER TABLE [dbo].[ttknfile] ADD  CONSTRAINT [DF_ttknfile_f6]  DEFAULT ((0)) FOR [f6]
GO
ALTER TABLE [dbo].[ttknfile] ADD  CONSTRAINT [DF_ttknfile_q7]  DEFAULT ((0)) FOR [q7]
GO
ALTER TABLE [dbo].[ttknfile] ADD  CONSTRAINT [DF_ttknfile_f7]  DEFAULT ((0)) FOR [f7]
GO
ALTER TABLE [dbo].[ttknfile] ADD  CONSTRAINT [DF_ttknfile_q8]  DEFAULT ((0)) FOR [q8]
GO
ALTER TABLE [dbo].[ttknfile] ADD  CONSTRAINT [DF_ttknfile_f8]  DEFAULT ((0)) FOR [f8]
GO
ALTER TABLE [dbo].[ttknfile] ADD  CONSTRAINT [DF_ttknfile_q9]  DEFAULT ((0)) FOR [q9]
GO
ALTER TABLE [dbo].[ttknfile] ADD  CONSTRAINT [DF_ttknfile_f9]  DEFAULT ((0)) FOR [f9]
GO
ALTER TABLE [dbo].[ttknfile] ADD  CONSTRAINT [DF_ttknfile_q10]  DEFAULT ((0)) FOR [q10]
GO
ALTER TABLE [dbo].[ttknfile] ADD  CONSTRAINT [DF_ttknfile_f10]  DEFAULT ((0)) FOR [f10]
GO
ALTER TABLE [dbo].[ttknfile] ADD  CONSTRAINT [DF_ttknfile_q11]  DEFAULT ((0)) FOR [q11]
GO
ALTER TABLE [dbo].[ttknfile] ADD  CONSTRAINT [DF_ttknfile_f11]  DEFAULT ((0)) FOR [f11]
GO
ALTER TABLE [dbo].[ttknfile] ADD  CONSTRAINT [DF_ttknfile_q12]  DEFAULT ((0)) FOR [q12]
GO
ALTER TABLE [dbo].[ttknfile] ADD  CONSTRAINT [DF_ttknfile_f12]  DEFAULT ((0)) FOR [f12]
GO
ALTER TABLE [dbo].[ttkusr] ADD  CONSTRAINT [DF_ttkusr_col_q]  DEFAULT ((0)) FOR [col_q]
GO
ALTER TABLE [dbo].[websites] ADD  DEFAULT ((0)) FOR [cmsn_incld_VAT_Trnsp]
GO
ALTER TABLE [dbo].[apdtl]  WITH NOCHECK ADD  CONSTRAINT [FK_apdtl_aphdr1] FOREIGN KEY([dt_company], [dt_type], [dt_ref])
REFERENCES [dbo].[aphdr] ([hd_company], [hd_type], [hd_ref])
ON DELETE CASCADE
NOT FOR REPLICATION 
GO
ALTER TABLE [dbo].[apdtl] CHECK CONSTRAINT [FK_apdtl_aphdr1]
GO
ALTER TABLE [dbo].[arch_offers_dt]  WITH CHECK ADD  CONSTRAINT [FK_arch_offers_dt_arch_offers_hd] FOREIGN KEY([company], [slcenter], [refno])
REFERENCES [dbo].[arch_offers_hd] ([company], [slcenter], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[arch_offers_dt] CHECK CONSTRAINT [FK_arch_offers_dt_arch_offers_hd]
GO
ALTER TABLE [dbo].[arch_offers_dt_sub]  WITH CHECK ADD  CONSTRAINT [FK_arch_offers_dt_sub_arch_offers_dt] FOREIGN KEY([company], [slcenter], [refno], [ms_barcode])
REFERENCES [dbo].[arch_offers_dt] ([company], [slcenter], [refno], [barcode])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[arch_offers_dt_sub] CHECK CONSTRAINT [FK_arch_offers_dt_sub_arch_offers_dt]
GO
ALTER TABLE [dbo].[ardtl]  WITH CHECK ADD  CONSTRAINT [FK_ardtl_arhdr1] FOREIGN KEY([dt_company], [dt_type], [dt_ref])
REFERENCES [dbo].[arhdr] ([hd_company], [hd_type], [hd_ref])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[ardtl] CHECK CONSTRAINT [FK_ardtl_arhdr1]
GO
ALTER TABLE [dbo].[delchgdtl]  WITH CHECK ADD  CONSTRAINT [FK_delchgdtl_delchghdr] FOREIGN KEY([trx_id])
REFERENCES [dbo].[delchghdr] ([trx_id])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[delchgdtl] CHECK CONSTRAINT [FK_delchgdtl_delchghdr]
GO
ALTER TABLE [dbo].[exporders_dt]  WITH CHECK ADD  CONSTRAINT [FK_exporders_dt_exporders_hd] FOREIGN KEY([company], [orderid])
REFERENCES [dbo].[exporders_hd] ([company], [orderId])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[exporders_dt] CHECK CONSTRAINT [FK_exporders_dt_exporders_hd]
GO
ALTER TABLE [dbo].[expreplaced_dt]  WITH CHECK ADD  CONSTRAINT [FK_expreplaced_dt_expreplaced_hd] FOREIGN KEY([company], [glref])
REFERENCES [dbo].[expreplaced_hd] ([company], [glref])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[expreplaced_dt] CHECK CONSTRAINT [FK_expreplaced_dt_expreplaced_hd]
GO
ALTER TABLE [dbo].[fadtl]  WITH CHECK ADD  CONSTRAINT [FK_fadtl_fahdr] FOREIGN KEY([fd_company], [fd_type], [fd_ref])
REFERENCES [dbo].[fahdr] ([fh_company], [fh_type], [fh_ref])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[fadtl] CHECK CONSTRAINT [FK_fadtl_fahdr]
GO
ALTER TABLE [dbo].[fahdr]  WITH CHECK ADD  CONSTRAINT [FK_fahdr_fahdr] FOREIGN KEY([fh_company], [fh_type], [fh_ref])
REFERENCES [dbo].[fahdr] ([fh_company], [fh_type], [fh_ref])
GO
ALTER TABLE [dbo].[fahdr] CHECK CONSTRAINT [FK_fahdr_fahdr]
GO
ALTER TABLE [dbo].[fsiss_dt]  WITH CHECK ADD  CONSTRAINT [FK_fsiss_dt_fsiss_hd1] FOREIGN KEY([refno])
REFERENCES [dbo].[fsiss_hd] ([refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[fsiss_dt] CHECK CONSTRAINT [FK_fsiss_dt_fsiss_hd1]
GO
ALTER TABLE [dbo].[fsrcv_dt]  WITH CHECK ADD  CONSTRAINT [FK_fsrcv_dt_fsrcv_hd] FOREIGN KEY([branch], [trtype], [refno])
REFERENCES [dbo].[fsrcv_hd] ([branch], [trtype], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[fsrcv_dt] CHECK CONSTRAINT [FK_fsrcv_dt_fsrcv_hd]
GO
ALTER TABLE [dbo].[gljrcost]  WITH CHECK ADD  CONSTRAINT [FK_gljrcost_gljrdtl] FOREIGN KEY([company], [jdtype], [jdref], [jdfolno])
REFERENCES [dbo].[gljrdtl] ([jdcomp], [jdtype], [jdref], [jdfolno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[gljrcost] CHECK CONSTRAINT [FK_gljrcost_gljrdtl]
GO
ALTER TABLE [dbo].[gljrdtl]  WITH NOCHECK ADD  CONSTRAINT [FK_gljrdtl_gljrhdr] FOREIGN KEY([jdcomp], [jdtype], [jdref])
REFERENCES [dbo].[gljrhdr] ([jhcomp], [jhtype], [jhref])
ON DELETE CASCADE
NOT FOR REPLICATION 
GO
ALTER TABLE [dbo].[gljrdtl] CHECK CONSTRAINT [FK_gljrdtl_gljrhdr]
GO
ALTER TABLE [dbo].[installment_trx]  WITH CHECK ADD  CONSTRAINT [FK_installment_trx_sales_hd] FOREIGN KEY([company], [invtype], [refno])
REFERENCES [dbo].[sales_hd] ([company], [invtype], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[installment_trx] CHECK CONSTRAINT [FK_installment_trx_sales_hd]
GO
ALTER TABLE [dbo].[jccstord_dtl]  WITH CHECK ADD  CONSTRAINT [FK_jccstord_dtl_jccstord_hdr] FOREIGN KEY([company], [refno])
REFERENCES [dbo].[jccstord_hdr] ([company], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[jccstord_dtl] CHECK CONSTRAINT [FK_jccstord_dtl_jccstord_hdr]
GO
ALTER TABLE [dbo].[jcstitems]  WITH CHECK ADD  CONSTRAINT [FK_jcstitems_stunits] FOREIGN KEY([cmbkey])
REFERENCES [dbo].[stunits] ([cmbkey])
ON UPDATE CASCADE
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[jcstitems] CHECK CONSTRAINT [FK_jcstitems_stunits]
GO
ALTER TABLE [dbo].[ord_dtl]  WITH CHECK ADD  CONSTRAINT [FK_ord_dtl_ord_hdr] FOREIGN KEY([company], [refno])
REFERENCES [dbo].[ord_hdr] ([company], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[ord_dtl] CHECK CONSTRAINT [FK_ord_dtl_ord_hdr]
GO
ALTER TABLE [dbo].[poclnt_taxcode]  WITH CHECK ADD  CONSTRAINT [FK_poclnt_taxcode_pos_hd] FOREIGN KEY([company], [contr], [refno])
REFERENCES [dbo].[pos_hd] ([company], [contr], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[poclnt_taxcode] CHECK CONSTRAINT [FK_poclnt_taxcode_pos_hd]
GO
ALTER TABLE [dbo].[ponqatibkinv]  WITH CHECK ADD  CONSTRAINT [FK_ponqatibkinv_pos_hd] FOREIGN KEY([company], [contr], [refno])
REFERENCES [dbo].[pos_hd] ([company], [contr], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[ponqatibkinv] CHECK CONSTRAINT [FK_ponqatibkinv_pos_hd]
GO
ALTER TABLE [dbo].[pos_chdt]  WITH CHECK ADD  CONSTRAINT [FK_pos_chdt_pos_chhd] FOREIGN KEY([company], [refno])
REFERENCES [dbo].[pos_chhd] ([company], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[pos_chdt] CHECK CONSTRAINT [FK_pos_chdt_pos_chhd]
GO
ALTER TABLE [dbo].[pos_dt]  WITH CHECK ADD  CONSTRAINT [FK_pos_dt_pos_hd] FOREIGN KEY([company], [contr], [refno])
REFERENCES [dbo].[pos_hd] ([company], [contr], [refno])
ON UPDATE CASCADE
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[pos_dt] CHECK CONSTRAINT [FK_pos_dt_pos_hd]
GO
ALTER TABLE [dbo].[pos_dtti]  WITH CHECK ADD  CONSTRAINT [FK_pos_dtti_pos_hdti] FOREIGN KEY([company], [contr], [refno])
REFERENCES [dbo].[pos_hdti] ([company], [contr], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[pos_dtti] CHECK CONSTRAINT [FK_pos_dtti_pos_hdti]
GO
ALTER TABLE [dbo].[POS_ei]  WITH CHECK ADD  CONSTRAINT [FK_pos_ei_pos_hd] FOREIGN KEY([company], [contr], [refno])
REFERENCES [dbo].[pos_hd] ([company], [contr], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[POS_ei] CHECK CONSTRAINT [FK_pos_ei_pos_hd]
GO
ALTER TABLE [dbo].[poscccard]  WITH NOCHECK ADD  CONSTRAINT [FK_poscccard_pos_hd] FOREIGN KEY([company], [contr], [refno])
REFERENCES [dbo].[pos_hd] ([company], [contr], [refno])
ON UPDATE CASCADE
ON DELETE CASCADE
NOT FOR REPLICATION 
GO
ALTER TABLE [dbo].[poscccard] CHECK CONSTRAINT [FK_poscccard_pos_hd]
GO
ALTER TABLE [dbo].[poschrtinv]  WITH CHECK ADD  CONSTRAINT [FK_poschrtinv_pos_hd] FOREIGN KEY([company], [contr], [refno])
REFERENCES [dbo].[pos_hd] ([company], [contr], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[poschrtinv] CHECK CONSTRAINT [FK_poschrtinv_pos_hd]
GO
ALTER TABLE [dbo].[posdlvry]  WITH CHECK ADD  CONSTRAINT [FK_posdlvry_pos_hd] FOREIGN KEY([company], [contr], [refno])
REFERENCES [dbo].[pos_hd] ([company], [contr], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[posdlvry] CHECK CONSTRAINT [FK_posdlvry_pos_hd]
GO
ALTER TABLE [dbo].[posfcamt]  WITH CHECK ADD  CONSTRAINT [FK_posfcamt_pos_hd] FOREIGN KEY([company], [contr], [refno])
REFERENCES [dbo].[pos_hd] ([company], [contr], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[posfcamt] CHECK CONSTRAINT [FK_posfcamt_pos_hd]
GO
ALTER TABLE [dbo].[posinstlmnt_trx]  WITH CHECK ADD  CONSTRAINT [FK_posinstlmnt_trx_pos_hd] FOREIGN KEY([company], [contr], [refno])
REFERENCES [dbo].[pos_hd] ([company], [contr], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[posinstlmnt_trx] CHECK CONSTRAINT [FK_posinstlmnt_trx_pos_hd]
GO
ALTER TABLE [dbo].[posinvoffer]  WITH CHECK ADD  CONSTRAINT [FK_posinvoffer_pos_dt] FOREIGN KEY([company], [contr], [refno], [srlno])
REFERENCES [dbo].[pos_dt] ([company], [contr], [refno], [srlno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[posinvoffer] CHECK CONSTRAINT [FK_posinvoffer_pos_dt]
GO
ALTER TABLE [dbo].[posmnfthcard]  WITH NOCHECK ADD  CONSTRAINT [FK_posmnfthcard_pos_hd] FOREIGN KEY([company], [contr], [refno])
REFERENCES [dbo].[pos_hd] ([company], [contr], [refno])
ON DELETE CASCADE
NOT FOR REPLICATION 
GO
ALTER TABLE [dbo].[posmnfthcard] CHECK CONSTRAINT [FK_posmnfthcard_pos_hd]
GO
ALTER TABLE [dbo].[posppcard]  WITH NOCHECK ADD  CONSTRAINT [FK_posppcard_pos_hd] FOREIGN KEY([company], [contr], [refno])
REFERENCES [dbo].[pos_hd] ([company], [contr], [refno])
ON UPDATE CASCADE
ON DELETE CASCADE
NOT FOR REPLICATION 
GO
ALTER TABLE [dbo].[posppcard] CHECK CONSTRAINT [FK_posppcard_pos_hd]
GO
ALTER TABLE [dbo].[posrtninv]  WITH CHECK ADD  CONSTRAINT [FK_posrtninv_pos_hd] FOREIGN KEY([company], [contr], [refno])
REFERENCES [dbo].[pos_hd] ([company], [contr], [refno])
ON UPDATE CASCADE
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[posrtninv] CHECK CONSTRAINT [FK_posrtninv_pos_hd]
GO
ALTER TABLE [dbo].[possanedchrty]  WITH NOCHECK ADD  CONSTRAINT [FK_possanedchrty_pos_hd] FOREIGN KEY([company], [contr], [refno])
REFERENCES [dbo].[pos_hd] ([company], [contr], [refno])
ON DELETE CASCADE
NOT FOR REPLICATION 
GO
ALTER TABLE [dbo].[possanedchrty] CHECK CONSTRAINT [FK_possanedchrty_pos_hd]
GO
ALTER TABLE [dbo].[ppdtl]  WITH CHECK ADD  CONSTRAINT [FK_ppdtl_pphdr] FOREIGN KEY([pdcomp], [pdtype], [pdref])
REFERENCES [dbo].[pphdr] ([phcomp], [phtype], [phref])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[ppdtl] CHECK CONSTRAINT [FK_ppdtl_pphdr]
GO
ALTER TABLE [dbo].[ppjrdtl]  WITH CHECK ADD  CONSTRAINT [FK_ppjrdtl_pphdr] FOREIGN KEY([jdcomp], [jdtype], [jdref])
REFERENCES [dbo].[pphdr] ([phcomp], [phtype], [phref])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[ppjrdtl] CHECK CONSTRAINT [FK_ppjrdtl_pphdr]
GO
ALTER TABLE [dbo].[pudtl]  WITH CHECK ADD  CONSTRAINT [FK_pudtl_puhdr] FOREIGN KEY([company], [invtype], [refno])
REFERENCES [dbo].[puhdr] ([company], [invtype], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[pudtl] CHECK CONSTRAINT [FK_pudtl_puhdr]
GO
ALTER TABLE [dbo].[re_elec_inv_dt]  WITH CHECK ADD  CONSTRAINT [FK_re_elec_inv_dt_re_elec_inv_hd] FOREIGN KEY([company], [refno])
REFERENCES [dbo].[re_elec_inv_hd] ([company], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[re_elec_inv_dt] CHECK CONSTRAINT [FK_re_elec_inv_dt_re_elec_inv_hd]
GO
ALTER TABLE [dbo].[re_entitle_batch_dt]  WITH CHECK ADD  CONSTRAINT [pk_re_entitle_batch_dt_re_entitle_batch_hd] FOREIGN KEY([company], [refno])
REFERENCES [dbo].[re_entitle_batch_hd] ([company], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[re_entitle_batch_dt] CHECK CONSTRAINT [pk_re_entitle_batch_dt_re_entitle_batch_hd]
GO
ALTER TABLE [dbo].[re_spcl_dsc_dt]  WITH CHECK ADD  CONSTRAINT [FK_re_spcl_dsc_dt_re_spcl_dsc_hd] FOREIGN KEY([company], [trtype], [refno])
REFERENCES [dbo].[re_spcl_dsc_hd] ([company], [trtype], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[re_spcl_dsc_dt] CHECK CONSTRAINT [FK_re_spcl_dsc_dt_re_spcl_dsc_hd]
GO
ALTER TABLE [dbo].[recontracts_elec_open]  WITH NOCHECK ADD  CONSTRAINT [FK_recontracts_elec_open_recontracts] FOREIGN KEY([company], [contract])
REFERENCES [dbo].[recontracts] ([company], [contract])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[recontracts_elec_open] CHECK CONSTRAINT [FK_recontracts_elec_open_recontracts]
GO
ALTER TABLE [dbo].[repayments]  WITH NOCHECK ADD  CONSTRAINT [FK_repayments_recontracts] FOREIGN KEY([company], [contract])
REFERENCES [dbo].[recontracts] ([company], [contract])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[repayments] CHECK CONSTRAINT [FK_repayments_recontracts]
GO
ALTER TABLE [dbo].[retenants_ei]  WITH CHECK ADD  CONSTRAINT [FK_retenants_retenants_ei] FOREIGN KEY([company], [Code], [fcy])
REFERENCES [dbo].[retenants] ([company], [code], [fcy])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[retenants_ei] CHECK CONSTRAINT [FK_retenants_retenants_ei]
GO
ALTER TABLE [dbo].[retrans_dt]  WITH CHECK ADD  CONSTRAINT [FK_retrans_dt_retrans_hd] FOREIGN KEY([company], [trtype], [refno])
REFERENCES [dbo].[retrans_hd] ([company], [trtype], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[retrans_dt] CHECK CONSTRAINT [FK_retrans_dt_retrans_hd]
GO
ALTER TABLE [dbo].[reunits_extra]  WITH CHECK ADD  CONSTRAINT [FK_reunits_extra_reunits] FOREIGN KEY([company], [un_code])
REFERENCES [dbo].[reunits] ([company], [un_code])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[reunits_extra] CHECK CONSTRAINT [FK_reunits_extra_reunits]
GO
ALTER TABLE [dbo].[sales_dd]  WITH CHECK ADD  CONSTRAINT [FK_sales_dd_sales_dh] FOREIGN KEY([company], [invtype], [refno])
REFERENCES [dbo].[sales_dh] ([company], [invtype], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[sales_dd] CHECK CONSTRAINT [FK_sales_dd_sales_dh]
GO
ALTER TABLE [dbo].[sales_dt]  WITH CHECK ADD  CONSTRAINT [FK_sales_dt_sales_hd] FOREIGN KEY([company], [invtype], [refno])
REFERENCES [dbo].[sales_hd] ([company], [invtype], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[sales_dt] CHECK CONSTRAINT [FK_sales_dt_sales_hd]
GO
ALTER TABLE [dbo].[sales_gd]  WITH CHECK ADD  CONSTRAINT [FK_sales_gd_sales_gh] FOREIGN KEY([company], [refno])
REFERENCES [dbo].[sales_gh] ([company], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[sales_gd] CHECK CONSTRAINT [FK_sales_gd_sales_gh]
GO
ALTER TABLE [dbo].[sales_od]  WITH CHECK ADD  CONSTRAINT [FK_sales_od_sales_oh] FOREIGN KEY([company], [refno])
REFERENCES [dbo].[sales_oh] ([company], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[sales_od] CHECK CONSTRAINT [FK_sales_od_sales_oh]
GO
ALTER TABLE [dbo].[sales_qd]  WITH CHECK ADD  CONSTRAINT [FK_Sales_qd_Sales_qh] FOREIGN KEY([company], [refno])
REFERENCES [dbo].[sales_qh] ([company], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[sales_qd] CHECK CONSTRAINT [FK_Sales_qd_Sales_qh]
GO
ALTER TABLE [dbo].[sdaad_dt]  WITH NOCHECK ADD  CONSTRAINT [FK_sdaad_dt_sdaad_hd] FOREIGN KEY([company], [sdtype], [refno])
REFERENCES [dbo].[sdaad_hd] ([company], [sdtype], [refno])
ON DELETE CASCADE
NOT FOR REPLICATION 
GO
ALTER TABLE [dbo].[sdaad_dt] CHECK CONSTRAINT [FK_sdaad_dt_sdaad_hd]
GO
ALTER TABLE [dbo].[sddtl]  WITH NOCHECK ADD  CONSTRAINT [FK_sddtl_sdhdr] FOREIGN KEY([dt_company], [dt_type], [dt_ref])
REFERENCES [dbo].[sdhdr] ([hd_company], [hd_type], [hd_ref])
ON DELETE CASCADE
NOT FOR REPLICATION 
GO
ALTER TABLE [dbo].[sddtl] CHECK CONSTRAINT [FK_sddtl_sdhdr]
GO
ALTER TABLE [dbo].[sdsubscriber_dt]  WITH NOCHECK ADD  CONSTRAINT [FK_sdsubscriber_dt_sdsubscribers] FOREIGN KEY([sdcompany], [sdsubscrbNo])
REFERENCES [dbo].[sdsubscribers] ([sdcompany], [sdsubscrbNo])
ON DELETE CASCADE
NOT FOR REPLICATION 
GO
ALTER TABLE [dbo].[sdsubscriber_dt] CHECK CONSTRAINT [FK_sdsubscriber_dt_sdsubscribers]
GO
ALTER TABLE [dbo].[slalmnmglassdtls]  WITH CHECK ADD  CONSTRAINT [FK_slalmnmglassdtls_sales_hd] FOREIGN KEY([company], [invtype], [refno])
REFERENCES [dbo].[sales_hd] ([company], [invtype], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[slalmnmglassdtls] CHECK CONSTRAINT [FK_slalmnmglassdtls_sales_hd]
GO
ALTER TABLE [dbo].[slccpayment]  WITH CHECK ADD  CONSTRAINT [FK_slccpayment_sales_hd] FOREIGN KEY([company], [invtype], [refno])
REFERENCES [dbo].[sales_hd] ([company], [invtype], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[slccpayment] CHECK CONSTRAINT [FK_slccpayment_sales_hd]
GO
ALTER TABLE [dbo].[slfcypay]  WITH CHECK ADD  CONSTRAINT [FK_slfcypay_sales_hd] FOREIGN KEY([company], [invtype], [refno])
REFERENCES [dbo].[sales_hd] ([company], [invtype], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[slfcypay] CHECK CONSTRAINT [FK_slfcypay_sales_hd]
GO
ALTER TABLE [dbo].[slglssgrade]  WITH CHECK ADD  CONSTRAINT [FK_slglssgrade_sales_hd] FOREIGN KEY([company], [invtype], [refno])
REFERENCES [dbo].[sales_hd] ([company], [invtype], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[slglssgrade] CHECK CONSTRAINT [FK_slglssgrade_sales_hd]
GO
ALTER TABLE [dbo].[slktchndtls]  WITH CHECK ADD  CONSTRAINT [FK_slktchndtls_sales_hd] FOREIGN KEY([company], [invtype], [refno])
REFERENCES [dbo].[sales_hd] ([company], [invtype], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[slktchndtls] CHECK CONSTRAINT [FK_slktchndtls_sales_hd]
GO
ALTER TABLE [dbo].[sllinedtls]  WITH CHECK ADD  CONSTRAINT [FK_sllinedtls_sales_hd] FOREIGN KEY([company], [invtype], [refno])
REFERENCES [dbo].[sales_hd] ([company], [invtype], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[sllinedtls] CHECK CONSTRAINT [FK_sllinedtls_sales_hd]
GO
ALTER TABLE [dbo].[slpaytype]  WITH CHECK ADD  CONSTRAINT [FK_bkpaytype_sales_hd] FOREIGN KEY([company], [invtype], [refno])
REFERENCES [dbo].[sales_hd] ([company], [invtype], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[slpaytype] CHECK CONSTRAINT [FK_bkpaytype_sales_hd]
GO
ALTER TABLE [dbo].[slpuorder_od]  WITH NOCHECK ADD  CONSTRAINT [FK_slpuorder_od_sales_oh] FOREIGN KEY([company], [refno])
REFERENCES [dbo].[sales_oh] ([company], [refno])
ON DELETE CASCADE
NOT FOR REPLICATION 
GO
ALTER TABLE [dbo].[slpuorder_od] CHECK CONSTRAINT [FK_slpuorder_od_sales_oh]
GO
ALTER TABLE [dbo].[slqktchndtls]  WITH CHECK ADD  CONSTRAINT [FK_slqktchndtls_sales_qh] FOREIGN KEY([company], [refno])
REFERENCES [dbo].[sales_qh] ([company], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[slqktchndtls] CHECK CONSTRAINT [FK_slqktchndtls_sales_qh]
GO
ALTER TABLE [dbo].[slqlinedtls]  WITH CHECK ADD  CONSTRAINT [FK_slqlinedtls_sales_qh] FOREIGN KEY([company], [refno])
REFERENCES [dbo].[sales_qh] ([company], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[slqlinedtls] CHECK CONSTRAINT [FK_slqlinedtls_sales_qh]
GO
ALTER TABLE [dbo].[slservicecodes]  WITH CHECK ADD  CONSTRAINT [FK_slservicecodes_sales_hd] FOREIGN KEY([company], [invtype], [refno])
REFERENCES [dbo].[sales_hd] ([company], [invtype], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[slservicecodes] CHECK CONSTRAINT [FK_slservicecodes_sales_hd]
GO
ALTER TABLE [dbo].[slverifyinv]  WITH CHECK ADD  CONSTRAINT [FK_slverifyinv_sales_hd] FOREIGN KEY([company], [invtype], [refno])
REFERENCES [dbo].[sales_hd] ([company], [invtype], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[slverifyinv] CHECK CONSTRAINT [FK_slverifyinv_sales_hd]
GO
ALTER TABLE [dbo].[st_slsord_dtl]  WITH CHECK ADD  CONSTRAINT [FK_st_slsord_dtl_sales_oh] FOREIGN KEY([branch], [refno])
REFERENCES [dbo].[sales_oh] ([company], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[st_slsord_dtl] CHECK CONSTRAINT [FK_st_slsord_dtl_sales_oh]
GO
ALTER TABLE [dbo].[stasmbld]  WITH CHECK ADD  CONSTRAINT [FK_stasmbld_stunits] FOREIGN KEY([itemno], [unicode])
REFERENCES [dbo].[stunits] ([itemno], [unicode])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[stasmbld] CHECK CONSTRAINT [FK_stasmbld_stunits]
GO
ALTER TABLE [dbo].[stbins]  WITH CHECK ADD  CONSTRAINT [FK_stbins_stunits] FOREIGN KEY([itemno], [unicode])
REFERENCES [dbo].[stunits] ([itemno], [unicode])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[stbins] CHECK CONSTRAINT [FK_stbins_stunits]
GO
ALTER TABLE [dbo].[stbrprice]  WITH CHECK ADD  CONSTRAINT [FK_stbrprice_stunits] FOREIGN KEY([itemno], [unicode])
REFERENCES [dbo].[stunits] ([itemno], [unicode])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[stbrprice] CHECK CONSTRAINT [FK_stbrprice_stunits]
GO
ALTER TABLE [dbo].[stcommission]  WITH CHECK ADD  CONSTRAINT [FK_stcommission_stunits] FOREIGN KEY([itemno], [unicode])
REFERENCES [dbo].[stunits] ([itemno], [unicode])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[stcommission] CHECK CONSTRAINT [FK_stcommission_stunits]
GO
ALTER TABLE [dbo].[stdtl]  WITH CHECK ADD  CONSTRAINT [FK_stdtl_sthdr] FOREIGN KEY([branch], [trtype], [refno])
REFERENCES [dbo].[sthdr] ([branch], [trtype], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[stdtl] CHECK CONSTRAINT [FK_stdtl_sthdr]
GO
ALTER TABLE [dbo].[stfcyprice]  WITH CHECK ADD  CONSTRAINT [FK_stfcyprice_stunits] FOREIGN KEY([itemno], [unicode])
REFERENCES [dbo].[stunits] ([itemno], [unicode])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[stfcyprice] CHECK CONSTRAINT [FK_stfcyprice_stunits]
GO
ALTER TABLE [dbo].[stitem_mae]  WITH CHECK ADD  CONSTRAINT [FK_stitem_mae_stunits] FOREIGN KEY([itemno], [unicode])
REFERENCES [dbo].[stunits] ([itemno], [unicode])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[stitem_mae] CHECK CONSTRAINT [FK_stitem_mae_stunits]
GO
ALTER TABLE [dbo].[stitembc]  WITH CHECK ADD  CONSTRAINT [FK_stitembc_stunits] FOREIGN KEY([itemno], [unicode])
REFERENCES [dbo].[stunits] ([itemno], [unicode])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[stitembc] CHECK CONSTRAINT [FK_stitembc_stunits]
GO
ALTER TABLE [dbo].[stitembc_brprice]  WITH CHECK ADD  CONSTRAINT [FK_stitembc_brprice_stitembc] FOREIGN KEY([pbarcode])
REFERENCES [dbo].[stitembc] ([pbarcode])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[stitembc_brprice] CHECK CONSTRAINT [FK_stitembc_brprice_stitembc]
GO
ALTER TABLE [dbo].[stitemnqati]  WITH CHECK ADD  CONSTRAINT [FK_stitemnqati_stunits] FOREIGN KEY([cmbkey])
REFERENCES [dbo].[stunits] ([cmbkey])
ON UPDATE CASCADE
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[stitemnqati] CHECK CONSTRAINT [FK_stitemnqati_stunits]
GO
ALTER TABLE [dbo].[stitempictures]  WITH CHECK ADD  CONSTRAINT [FK_stitempictures_stunits] FOREIGN KEY([cmbkey])
REFERENCES [dbo].[stunits] ([cmbkey])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[stitempictures] CHECK CONSTRAINT [FK_stitempictures_stunits]
GO
ALTER TABLE [dbo].[stitemrp]  WITH CHECK ADD  CONSTRAINT [FK_stitemrp_stunits] FOREIGN KEY([itemno], [unicode])
REFERENCES [dbo].[stunits] ([itemno], [unicode])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[stitemrp] CHECK CONSTRAINT [FK_stitemrp_stunits]
GO
ALTER TABLE [dbo].[stitmphoto]  WITH CHECK ADD  CONSTRAINT [FK_stitmphoto_stunits] FOREIGN KEY([itemno], [unicode])
REFERENCES [dbo].[stunits] ([itemno], [unicode])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[stitmphoto] CHECK CONSTRAINT [FK_stitmphoto_stunits]
GO
ALTER TABLE [dbo].[stoffer_grp_dt]  WITH CHECK ADD  CONSTRAINT [FK_stoffer_grp_dt_stoffer_grp_hd] FOREIGN KEY([grp_no])
REFERENCES [dbo].[stoffer_grp_hd] ([grp_no])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[stoffer_grp_dt] CHECK CONSTRAINT [FK_stoffer_grp_dt_stoffer_grp_hd]
GO
ALTER TABLE [dbo].[stoffers]  WITH CHECK ADD  CONSTRAINT [FK_stoffers_stunits] FOREIGN KEY([itemno], [unicode])
REFERENCES [dbo].[stunits] ([itemno], [unicode])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[stoffers] CHECK CONSTRAINT [FK_stoffers_stunits]
GO
ALTER TABLE [dbo].[stPriceByQty]  WITH CHECK ADD  CONSTRAINT [FK_stPriceByQty_stunits] FOREIGN KEY([itemno], [unicode])
REFERENCES [dbo].[stunits] ([itemno], [unicode])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[stPriceByQty] CHECK CONSTRAINT [FK_stPriceByQty_stunits]
GO
ALTER TABLE [dbo].[streorderQP]  WITH NOCHECK ADD  CONSTRAINT [FK_streorderQP_stunits] FOREIGN KEY([itemno], [unicode])
REFERENCES [dbo].[stunits] ([itemno], [unicode])
ON DELETE CASCADE
NOT FOR REPLICATION 
GO
ALTER TABLE [dbo].[streorderQP] CHECK CONSTRAINT [FK_streorderQP_stunits]
GO
ALTER TABLE [dbo].[stwmaloc_dt]  WITH CHECK ADD  CONSTRAINT [FK_stwmaloc_dt_stwmaloc_hd] FOREIGN KEY([branch], [alctype], [alcref])
REFERENCES [dbo].[stwmaloc_hd] ([branch], [alctype], [alcref])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[stwmaloc_dt] CHECK CONSTRAINT [FK_stwmaloc_dt_stwmaloc_hd]
GO
ALTER TABLE [dbo].[stwmcntnr_dt]  WITH CHECK ADD  CONSTRAINT [FK_stwmcntnr_dt_stwmcntnr_hd] FOREIGN KEY([cn_id])
REFERENCES [dbo].[stwmcntnr_hd] ([cn_id])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[stwmcntnr_dt] CHECK CONSTRAINT [FK_stwmcntnr_dt_stwmcntnr_hd]
GO
ALTER TABLE [dbo].[stwmcntnrtrx_dt]  WITH CHECK ADD  CONSTRAINT [FK_stwmcntntrx_dt_stwmcntnrtrx_hd] FOREIGN KEY([branch], [refno])
REFERENCES [dbo].[stwmcntnrtrx_hd] ([branch], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[stwmcntnrtrx_dt] CHECK CONSTRAINT [FK_stwmcntntrx_dt_stwmcntnrtrx_hd]
GO
ALTER TABLE [dbo].[stwmtrx_dt]  WITH CHECK ADD  CONSTRAINT [FK_stwmtrx_dt_stwmtrx_hd] FOREIGN KEY([branch], [trtype], [refno])
REFERENCES [dbo].[stwmtrx_hd] ([branch], [trtype], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[stwmtrx_dt] CHECK CONSTRAINT [FK_stwmtrx_dt_stwmtrx_hd]
GO
ALTER TABLE [dbo].[supplier_ei]  WITH CHECK ADD  CONSTRAINT [FK_supplier_supplier_ei] FOREIGN KEY([cu_company], [cu_code], [cf_fcy])
REFERENCES [dbo].[supplier] ([cu_company], [cu_code], [cf_fcy])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[supplier_ei] CHECK CONSTRAINT [FK_supplier_supplier_ei]
GO
ALTER TABLE [dbo].[tailor_fix_dt]  WITH CHECK ADD  CONSTRAINT [FK_tailor_fix_dt_tailor_fix_hd] FOREIGN KEY([company], [refno])
REFERENCES [dbo].[tailor_fix_hd] ([company], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[tailor_fix_dt] CHECK CONSTRAINT [FK_tailor_fix_dt_tailor_fix_hd]
GO
ALTER TABLE [dbo].[tailor_ord_dt]  WITH CHECK ADD  CONSTRAINT [FK_tailor_ord_dt_tailor_ord_hd] FOREIGN KEY([company], [refno])
REFERENCES [dbo].[tailor_ord_hd] ([company], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[tailor_ord_dt] CHECK CONSTRAINT [FK_tailor_ord_dt_tailor_ord_hd]
GO
ALTER TABLE [dbo].[tailor_rtrn_dt]  WITH CHECK ADD  CONSTRAINT [FK_tailor_rtrn_dt_tailor_rtrn_hd] FOREIGN KEY([company], [refno])
REFERENCES [dbo].[tailor_rtrn_hd] ([company], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[tailor_rtrn_dt] CHECK CONSTRAINT [FK_tailor_rtrn_dt_tailor_rtrn_hd]
GO
ALTER TABLE [dbo].[tailor_trans_dt]  WITH CHECK ADD  CONSTRAINT [FK_tailor_trans_dt_tailor_trans_hd] FOREIGN KEY([company], [transtype], [refno])
REFERENCES [dbo].[tailor_trans_hd] ([company], [transtype], [refno])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[tailor_trans_dt] CHECK CONSTRAINT [FK_tailor_trans_dt_tailor_trans_hd]
GO
ALTER TABLE [dbo].[ttkfile_hst]  WITH CHECK ADD  CONSTRAINT [FK_ttkfile_hst_ttkhdr_hst] FOREIGN KEY([whno], [ttk_no])
REFERENCES [dbo].[ttkhdr_hst] ([ttwhno], [ttk_no])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[ttkfile_hst] CHECK CONSTRAINT [FK_ttkfile_hst_ttkhdr_hst]
GO
ALTER TABLE [dbo].[vender_dtl]  WITH CHECK ADD  CONSTRAINT [FK_vender_dtl_supplier] FOREIGN KEY([vn_company], [vn_code], [vn_fcy])
REFERENCES [dbo].[supplier] ([cu_company], [cu_code], [cf_fcy])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[vender_dtl] CHECK CONSTRAINT [FK_vender_dtl_supplier]
GO
/****** Object:  StoredProcedure [dbo].[Add_To_Pos_Dsc]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[Add_To_Pos_Dsc] 
@dsccompany char(2) , @dsccard char(20) , @dscname varchar(30) , @dscaddress varchar(30) ,
@dscprtg float , @dscstatus numeric(1,0) , @dscnote varchar(30) , @modified bit , @mnth_target numeric(12,3) ,
@trgt_prcnt numeric(4,2) , @prepaidamt numeric(10,3) , @cardtype numeric(1,0) , @cardused bit ,
@expdate char(8) , @crtdate char(8) , @crtyear char(4) 
 
as 
Begin

INSERT INTO [dbo].[pos_dsc]
           ([dsccompany]
           ,[dsccard]
           ,[dscname]
           ,[dscaddress]
           ,[dscprtg]
           ,[dscstatus]
           ,[dscnote]
           ,[modified]
		   ,[mnth_target]
           ,[trgt_prcnt]
           ,[prepaidamt]
           ,[cardtype]
           ,[cardused]
           ,[expdate]
           ,[crtdate]
           ,[crtyear]
           )
     VALUES
           (@dsccompany, @dsccard , @dscname , @dscaddress , @dscprtg , @dscstatus , @dscnote , @modified ,@mnth_target ,
		   @trgt_prcnt , @prepaidamt , @cardtype , @cardused , @expdate , @crtdate , @crtyear);
		   
End











GO
/****** Object:  StoredProcedure [dbo].[addup_monthval_2date]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[addup_monthval_2date]

 @lhjdate char(8) output,
 @errstatus int  output,
 @lvalue int, -- use to add or substract from the hjdate
 @Force_mldy bit ,
 @yr_end varchar(8),
 @dummy bit
 	
AS
BEGIN		
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
		SET NOCOUNT ON;
		declare @dbc varchar(20),
				@is_it_hij bit=0

		declare @lcdate char(8),
		        @lgrdate date,
				@fndate varchar(10)='',
				@DateConvertFactor int=112,
				@days_to_add int=0

		set @errstatus  =0
		set @lvalue=isnull(@lvalue,0)
		
		if @lvalue=0 return
		set @lcdate=@lhjdate

		exec dbo.date_hijjri @lcdate output,@Force_mldy,@yr_end, @days_to_add,@dummy
		if @lcdate='' or len(@lcdate)=0
		begin
		     set @lhjdate=''
		     return
		end
		
		SET @is_it_hij=iif(substring(@lcdate,1,2)='14',1,0) 
		set @DateConvertFactor=iif(substring(@lcdate,1,2)='14',131,112)		
			
		begin try
				--set @lgrdate= convert(date,@lcdate,@DateConvertFactor)
				if  @is_it_hij=1
				begin
				     --exec dbo.get_correct_hijjri_date @lcdate output,@lgrdate output
					 exec dbo.validate_date @lcdate output,@errstatus output,@lgrdate output
					 if @lgrdate is not null and @errstatus in (0,-1)
					 begin
					      set @lgrdate=dateadd(MM,@lvalue,@lgrdate)
						  set @lhjdate=FORMAT(@lgrdate,'yyyyMMdd','ar')
						  set @errstatus=0
				     end
			    end
				else
				begin
				     set @lgrdate= convert(date,@lcdate,@DateConvertFactor)
				     set @fndate=convert(varchar(10),dateadd(MM,@lvalue,@lgrdate),@DateConvertFactor)
					 set @lhjdate=@fndate
				end
		end try
		begin catch
				set @errstatus  =-1
				set @lhjdate=''
		end catch		
END




GO
/****** Object:  StoredProcedure [dbo].[addup_val2date]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2023-11-25@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[addup_val2date]
-------- 
 @lhjdate char(8) output,
 @errstatus int  output,
 @lvalue int, -- use to add or substract from the hjdate
 @Force_mldy bit ,
 @yr_end varchar(8),
 @dummy bit=0 	
AS
BEGIN
----    Added on 2023-11-20 AA Added new code to solve the problem adding value to date when the date is in bad hijiri date
----    Added on 2023-11-20 AA Added new code & removed the old code
----    Added on 2023-11-20 AA Added new variable named @strictdate
----    Added on 2023-11-20 AA Removed the @dummy paramter
----    Modified  on 2022-07-20 KAN. it was very old in some customer databases like step by step and causes error		
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
		SET NOCOUNT ON;
		declare @dbc varchar(20),
				@is_it_hij bit=0

		declare @lcdate char(8),
		        @lgrdate date,
				@fndate varchar(10)='',
				@DateConvertFactor int=112,
				@days_to_add int=0,
				@strictdate bit=0 -- Added on 2023-11-20 AA


		set @errstatus  =0
		set @lvalue=isnull(@lvalue,0)
		
		if @lvalue=0 return
		set @lcdate=@lhjdate

		exec dbo.date_hijjri @lcdate output,@Force_mldy,@yr_end, @days_to_add,@strictdate
		if @lcdate='' or len(@lcdate)=0
		begin
		     set @lhjdate=''
		     return
		end
		
		SET @is_it_hij=iif(substring(@lcdate,1,2)='14',1,0) 
		set @DateConvertFactor=iif(substring(@lcdate,1,2)='14',131,112)	
------- Added on 2023-11-20 AA --------------------------------------------------			
		exec dbo.validate_date @lcdate output,@errstatus output,@lgrdate output
		if @lgrdate is not null and @errstatus in (0,-1)
		begin
			set @lgrdate=dateadd(dd,@lvalue,@lgrdate)
			set @errstatus=0
			if  @is_it_hij=1
			begin
---------------- Added on 2023-11-20 AA --------------------------------------------------------------------------------------
				 set @fndate=ltrim(replace(convert(varchar(10),dateadd(dd,@lvalue,convert(date,@lcdate,131)),131),'/',''))
				 if len(@fndate)=7 set @fndate='0'+@fndate
				 set @lhjdate=substring(@fndate,5,4)+substring(@fndate,3,2)+substring(@fndate,1,2)
-------------------------------------------------------------------------------------------------------------------------------
		    end
			else set @lhjdate=FORMAT(@lgrdate,'yyyyMMdd','en-gb')
		end
		else
		begin
			set @errstatus  =-1
			set @lhjdate=''
		end
------------------------------------------------------------------------------------
	
END



GO
/****** Object:  StoredProcedure [dbo].[alter_messing_columns]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[alter_messing_columns]
 
 @errstatus int = 0 output
	
AS
BEGIN
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
		SET NOCOUNT ON
--        declare @
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'STDTL' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.stdtl ADD  rplct_post  bit NULL default (0) with values
			if @@error<>0
			begin
				set @errstatus=-1
				return @errstatus
			end
		end
--
--       Add To Sales_dt Table
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'SALES_DT' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.sales_dt ADD  rplct_post  bit NULL default 0 with values
			if @@error<>0
			begin
				set @errstatus=-3
				return @errstatus
			end
		end
--
--       Add To Gljrdtl Table
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'gljrdtl' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.gljrdtl ADD  rplct_post  bit NULL default 0 with values
			if @@error<>0
			begin
				set @errstatus=-5
				return @errstatus
			end
		end
--
--       Add To Pudtl Table
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pudtl' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.pudtl ADD  rplct_post  bit NULL default 0 with values
			if @@error<>0
			begin
				set @errstatus=-7
				return @errstatus
			end
		end
--
--       Add To apdtl Table
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'apdtl' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.apdtl ADD  rplct_post  bit NULL default 0 with values
			if @@error<>0
			begin
				set @errstatus=-9
				return @errstatus
			end
		end
--
--       Add To ardtl Table
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'ardtl' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.ardtl ADD  rplct_post  bit NULL default 0 with values
			if @@error<>0
			begin
				set @errstatus=-11
				return @errstatus
			end
		end
--
--       Add To stcrtpuinv Table  7
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stcrtpuinv' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.stcrtpuinv ADD  rplct_post  bit NULL default 0 with values
			if @@error<>0
			begin
				set @errstatus=-11
				return @errstatus
			end
		end
--
--       Add To gljrcost Table 8
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'gljrcost' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.gljrcost ADD  rplct_post  bit NULL default 0 with values
			if @@error<>0
			begin
				set @errstatus=-11
				return @errstatus
			end
		end
--
--       Add To bkbnfch Table 9
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bkbnfch' and COLUMN_NAME='bmemid')
		begin 
		    ALTER TABLE dbo.bkbnfch ADD  bmemid  char(20) NULL default '' with values
			if @@error<>0
			begin
				set @errstatus=-12
				return @errstatus
			end
		end
      if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bkbnfch' and COLUMN_NAME='brepname')
		begin 
		    ALTER TABLE dbo.bkbnfch ADD  brepname  char(40) NULL default '' with values
			if @@error<>0
			begin
				set @errstatus=-13
				return @errstatus
			end
		end
--
--       Add To bktransx Table 10
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='bcode')
		begin 
		    ALTER TABLE dbo.bktransx ADD  bcode  char(4) NULL default '' with values
			if @@error<>0
			begin
				set @errstatus=-14
				return @errstatus
			end
		end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='bal')
		begin 
		    ALTER TABLE dbo.bktransx ADD  bal  numeric(13, 3) NULL default 0 with values
			if @@error<>0
			begin
				set @errstatus=-15
				return @errstatus
			end
		end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='stk')
		begin 
		    ALTER TABLE dbo.bktransx ADD  stk  numeric(13, 3) NULL default 0 with values
			if @@error<>0
			begin
				set @errstatus=-16
				return @errstatus
			end
		end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='dscac')
		begin 
		    ALTER TABLE dbo.bktransx ADD  dscac  char(19) NULL default '' with values
			if @@error<>0
			begin
				set @errstatus=-17
				return @errstatus
			end
		end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='dscamt')
		begin 
		    ALTER TABLE dbo.bktransx ADD  dscamt  numeric(13, 3) NULL default 0 with values
			if @@error<>0
			begin
				set @errstatus=-18
				return @errstatus
			end
		end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='dscptg')
		begin 
		    ALTER TABLE dbo.bktransx ADD  dscptg  numeric(10, 3) NULL default 0 with values
			if @@error<>0
			begin
				set @errstatus=-19
				return @errstatus
			end
		end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='dscdesc')
		begin 
		    ALTER TABLE dbo.bktransx ADD  dscdesc  char(70) NULL default '' with values
			if @@error<>0
			begin
				set @errstatus=-20
				return @errstatus
			end
		end		
--
--       Add To Sales_dd Table 11
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'SALES_DD' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.sales_dd ADD  rplct_post  bit NULL default 0 with values
			if @@error<>0
			begin
				set @errstatus=-3
				return @errstatus
			end
		end
		return @errstatus
end














GO
/****** Object:  StoredProcedure [dbo].[alter_messing_columns_MAE]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- alter date: <alter Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[alter_messing_columns_MAE]

 @errstatus int = 0 output

AS
BEGIN
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
		SET NOCOUNT ON
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='fm_price1')
		begin 
		    ALTER TABLE dbo.stbranch ADD  fm_price1  numeric(6,0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='to_price1')
		begin 
		    ALTER TABLE dbo.stbranch ADD  to_price1  numeric(6,0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-102
				return @errstatus
			end
		end
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='doz_price1')
		begin 
		    ALTER TABLE dbo.stbranch ADD  doz_price1  numeric(6,0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-103
				return @errstatus
			end
		end
--       
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='ctn_price1')
		begin 
		    ALTER TABLE dbo.stbranch ADD  ctn_price1  numeric(6,0) NULL default 0
			if @@error<>0
			begin
				set @errstatus=-104
				return @errstatus
			end
		end
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='fm_price2')
		begin 
		    ALTER TABLE dbo.stbranch ADD  fm_price2  numeric(6,0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-105
				return @errstatus
			end
		end
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='to_price2')
		begin 
		    ALTER TABLE dbo.stbranch ADD  to_price2  numeric(6,0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-106
				return @errstatus
			end
		end
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='doz_price2')
		begin 
		    ALTER TABLE dbo.stbranch ADD  doz_price2  numeric(6,0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-107
				return @errstatus
			end
		end
--       
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='ctn_price2')
		begin 
		    ALTER TABLE dbo.stbranch ADD  ctn_price2  numeric(6,0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-108
				return @errstatus
			end
		end
--
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='fm_price3')
		begin 
		    ALTER TABLE dbo.stbranch ADD  fm_price3  numeric(6,0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-109
				return @errstatus
			end
		end
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='to_price3')
		begin 
		    ALTER TABLE dbo.stbranch ADD  to_price3  numeric(6,0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-110
				return @errstatus
			end
		end
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='doz_price3')
		begin 
		    ALTER TABLE dbo.stbranch ADD  doz_price3  numeric(6,0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-111
				return @errstatus
			end
		end
--       
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='ctn_price3')
		begin 
		    ALTER TABLE dbo.stbranch ADD  ctn_price3  numeric(6,0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-112
				return @errstatus
			end
		end

        if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'ord_hdr' and COLUMN_NAME='splyinv')
		begin 
		    ALTER TABLE dbo.ord_hdr alter COLUMN splyinv varchar(20) NULL
			if @@error<>0
			begin
				set @errstatus=-130
				return @errstatus
			end
		end

        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'ord_dtl' and COLUMN_NAME='splyinv')
		begin 
		    ALTER TABLE dbo.ord_dtl add splyinv varchar(20) NULL default ''
			if @@error<>0
			begin
				set @errstatus=-130
				return @errstatus
			end
		end

        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'ord_dtl' and COLUMN_NAME='dlvrydate')
		begin 
		    ALTER TABLE dbo.ord_dtl add dlvrydate char(8) NULL default ''
			if @@error<>0
			begin
				set @errstatus=-130
				return @errstatus
			end
		end
 
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'ord_dtl' and COLUMN_NAME='caser')
		begin 
		    ALTER TABLE dbo.ord_dtl add caser char(19) NULL default ''
			if @@error<>0
			begin
				set @errstatus=-130
				return @errstatus
			end
		end

        if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'puhdr' and COLUMN_NAME='splyinv')
		begin 
		    ALTER TABLE dbo.puhdr alter COLUMN splyinv char(20)
			if @@error<>0
			begin
				set @errstatus=-131
				return @errstatus
			end
		end

        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pudtl' and COLUMN_NAME='whno')
		begin 
		    ALTER TABLE dbo.pudtl add whno char(2) NULL default ''
			if @@error<>0
			begin
				set @errstatus=-132
				return @errstatus
			end
		end

        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pudtl' and COLUMN_NAME='splyinv')
		begin 
		    ALTER TABLE dbo.pudtl add splyinv char(20) NULL default ''
			if @@error<>0
			begin
				set @errstatus=-133
				return @errstatus
			end
		end

-- it has a problem since splyinv is part  of an index
--        if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stcrtpuinv' and COLUMN_NAME='splyinv')
--		begin 
--		    ALTER TABLE dbo.stcrtpuinv alter COLUMN splyinv char(20)
--			if @@error<>0
--			begin
--				set @errstatus=-134
--				return @errstatus
--			end
--		end

      if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'supplier' and COLUMN_NAME='whno')
		begin 
		    ALTER TABLE dbo.supplier add whno char(2) NULL default ''
			if @@error<>0
			begin
				set @errstatus=-135
				return @errstatus
			end
		end

      if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_hd' and COLUMN_NAME='remarks')
		begin 
		    ALTER TABLE dbo.sales_hd add remarks char(1) NULL default ''
			if @@error<>0
			begin
				set @errstatus=-136
				return @errstatus
			end
		end

      if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_hd' and COLUMN_NAME='remarks2')
		begin 
		    ALTER TABLE dbo.sales_hd add remarks2 char(40) NULL default ''
			if @@error<>0
			begin
				set @errstatus=-136
				return @errstatus
			end
		end

      if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_qh' and COLUMN_NAME='usrid')
		begin 
		    ALTER TABLE dbo.sales_qh add usrid char(10) NULL default ''
			if @@error<>0
			begin
				set @errstatus=-137
				return @errstatus
			end
		end

        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'puhdr' and COLUMN_NAME='shpdate')
		begin 
		    ALTER TABLE dbo.puhdr add shpdate char(8) null default ''
			if @@error<>0
			begin
				set @errstatus=-138
				return @errstatus
			end
		end

-- july 23,2016  for check and cash transactions
        if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='cstname')
		begin 
		    ALTER TABLE dbo.bktransx alter COLUMN cstname varchar(60) null
			if @@error<>0
			begin
				set @errstatus=-139
				return @errstatus
			end
		end

        if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_hd' and COLUMN_NAME='remarks2')
		begin 
		    ALTER TABLE dbo.sales_hd alter COLUMN remarks2 varchar(50) null
			if @@error<>0
			begin
				set @errstatus=-140
				return @errstatus
			end
		end

--       if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stitmphoto' and COLUMN_NAME='colors')
--  	 begin 
--	     ALTER TABLE dbo.stitmphoto ADD  colors  varchar(70) NULL default ' ' with values
--			if @@error<>0
--			begin
--				set @errstatus=-113
--				return @errstatus
--			end
--		 end
--
--      if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stitmphoto' and COLUMN_NAME='sizes')
--		begin 
--		    ALTER TABLE dbo.stitmphoto ADD  sizes  varchar(70) NULL default ' ' with values
--			if @@error<>0
--			begin
--				set @errstatus=-114
--				return @errstatus
--			end
--   	end

 --      if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stitmphoto' and COLUMN_NAME='min_slqty')
--		begin 
--		    ALTER TABLE dbo.stitmphoto ADD  min_slqty  numeric(14, 3) NULL default 0 with values
--			if @@error<>0
--			begin
--				set @errstatus=-115
--				return @errstatus
--			end
--		end

--        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stitmphoto' and COLUMN_NAME='splyordno')
--		begin 
--		    ALTER TABLE dbo.stitmphoto ADD  splyordno  char(20) NULL default ' ' with values
--			if @@error<>0
--			begin
--				set @errstatus=-116
--				return @errstatus
--			end
--		end

--        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stitmphoto' and COLUMN_NAME='ordqty')
--		begin 
--		    ALTER TABLE dbo.stitmphoto ADD  ordqty  numeric(14, 3) NULL default 0 with values
--			if @@error<>0
--			begin
--				set @errstatus=-117
--				return @errstatus
--			end
--		end

--        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stitmphoto' and COLUMN_NAME='ordprice')
--		begin 
--		    ALTER TABLE dbo.stitmphoto ADD  ordprice  float NULL default 0 with values
--			if @@error<>0
--			begin
--				set @errstatus=-118
--				return @errstatus
--			end
--		end
        
--		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stitmphoto' and COLUMN_NAME='ordrdlvry')
--		begin 
--		    ALTER TABLE dbo.stitmphoto ADD  ordrdlvry  char(8) NULL default ' ' with values
--			if @@error<>0
--			begin
--				set @errstatus=-119
--				return @errstatus
--			end
--		end
END











GO
/****** Object:  StoredProcedure [dbo].[alter_messing_columns_without_default]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- Batch submitted through debugger: alter_messing_columns_without_default.sql|7|0|C:\Users\sony\Documents\SQL Server Management Studio\alter_messing_columns_without_default.sql





CREATE PROCEDURE [dbo].[alter_messing_columns_without_default]
 
 @errstatus int = 0 output
	
AS
BEGIN
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
		SET NOCOUNT ON
--        declare 1
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'STDTL' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.stdtl ADD  rplct_post  bit NULL default (0) 
			if @@error<>0
			begin
				set @errstatus=-1
				return @errstatus
			end
		end
--
--       Add To Sales_dt Table 2
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'SALES_DT' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.sales_dt ADD  rplct_post  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-3
				return @errstatus
			end
		end
--
--       Add To Gljrdtl Table 3
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'gljrdtl' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.gljrdtl ADD  rplct_post  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-5
				return @errstatus
			end
		end
--
--       Add To Pudtl Table 4
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pudtl' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.pudtl ADD  rplct_post  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-7
				return @errstatus
			end
		end
--
--       Add To apdtl Table 5
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'apdtl' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.apdtl ADD  rplct_post  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-9
				return @errstatus
			end
		end
--
--       Add To ardtl Table  6
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'ardtl' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.ardtl ADD  rplct_post  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-11
				return @errstatus
			end
		end
--
--       Add To stcrtpuinv Table  7
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stcrtpuinv' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.stcrtpuinv ADD  rplct_post  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-11
				return @errstatus
			end
		end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stcrtpuinv' and COLUMN_NAME='slcode')
		begin 
		    ALTER TABLE dbo.stcrtpuinv ADD  slcode  char(2) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-11
				return @errstatus
			end
		end
--
--       Add To gljrcost Table 8
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'gljrcost' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.gljrcost ADD  rplct_post  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-11
				return @errstatus
			end
		end
        if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'gljrcost' and COLUMN_NAME='amt' 
		              AND DATA_TYPE='numeric')
		begin
			ALTER TABLE dbo.gljrcost ALTER column  amt  float NULL
			if @@error<>0
			begin
				set @errstatus=-73
				return @errstatus
			end
		end
--
--       Add To Sales_dd Table 9
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'SALES_DD' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.sales_dd ADD  rplct_post  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-3
				return @errstatus
			end
		end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'SALES_DD' and COLUMN_NAME='folio')
		begin 
		    ALTER TABLE dbo.sales_dd ADD  folio  numeric(4,0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-3
				return @errstatus
			end
			--begin transaction
			--update sales_dd set folio=(next value for seq1)
			--if @@error<>0
			--begin
			--	set @errstatus=-3
			--	rollback transaction
			--	return @errstatus
			--end
			--commit transaction
		end
--
--       Add To bkbnfch Table 10
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bkbnfch' and COLUMN_NAME='bmemid')
		begin 
		    ALTER TABLE dbo.bkbnfch ADD  bmemid  char(20) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-12
				return @errstatus
			end
		end
      if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bkbnfch' and COLUMN_NAME='brepname')
		begin 
		    ALTER TABLE dbo.bkbnfch ADD  brepname  char(40) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-13
				return @errstatus
			end
		end
--
--       Add To bktransx Table 11
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='bcode')
		begin 
		    ALTER TABLE dbo.bktransx ADD  bcode  char(6) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-14
				return @errstatus
			end
		end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='bal')
		begin 
		    ALTER TABLE dbo.bktransx ADD  bal  numeric(13, 3) NULL default 0
			if @@error<>0
			begin
				set @errstatus=-15
				return @errstatus
			end
		end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='stk')
		begin 
		    ALTER TABLE dbo.bktransx ADD  stk  numeric(13, 3) NULL default 0
			if @@error<>0
			begin
				set @errstatus=-16
				return @errstatus
			end
		end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='dscac')
		begin 
		    ALTER TABLE dbo.bktransx ADD  dscac  char(19) NULL default ''
			if @@error<>0
			begin
				set @errstatus=-17
				return @errstatus
			end
		end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='dscamt')
		begin 
		    ALTER TABLE dbo.bktransx ADD  dscamt  numeric(13, 3) NULL default 0
			if @@error<>0
			begin
				set @errstatus=-18
				return @errstatus
			end
		end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='dscptg')
		begin 
		    ALTER TABLE dbo.bktransx ADD  dscptg  numeric(10, 3) NULL default 0
			if @@error<>0
			begin
				set @errstatus=-19
				return @errstatus
			end
		end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='dscdesc')
		begin 
		    ALTER TABLE dbo.bktransx ADD  dscdesc  char(70) NULL default ''
			if @@error<>0
			begin
				set @errstatus=-20
				return @errstatus
			end
		end

       if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='ptodate')
		begin 
		    ALTER TABLE dbo.bktransx ADD  ptodate  char(8) NULL default ''
			if @@error<>0
			begin
				set @errstatus=-21
				return @errstatus
			end
		end	

		if (SELECT character_maximum_length FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'bktransx' AND COLUMN_NAME = 'rcvname')<>45
		begin
			ALTER TABLE dbo.bktransx alter column rcvname  varchar(45) 
			if @@error<>0
			begin
				set @errstatus=-21
				return @errstatus
			end
		end
	   		
--
--       Add To sysuse Table 12 
--
      if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sysuse' and COLUMN_NAME='mobileuser')
		begin 
		    ALTER TABLE dbo.sysuse ADD  mobileuser  bit NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-22
				return @errstatus
			end
		end	
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sysuse' and COLUMN_NAME='confirmPurchase')
		begin 
			ALTER TABLE dbo.sysuse ADD  confirmPurchase  bit NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-22
				return @errstatus
			end
		end	
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sysuse' and COLUMN_NAME='noovrdrft')
		begin 
			ALTER TABLE dbo.sysuse ADD  noovrdrft  bit NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-22
				return @errstatus
			end
		end	
			
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sysuse' and COLUMN_NAME='onlyactrmt')
		begin 
			ALTER TABLE dbo.sysuse ADD  onlyactrmt  bit NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-22
				return @errstatus
			end
		end		

		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sysuse' and COLUMN_NAME='confirmbr')
		begin 
			ALTER TABLE dbo.sysuse ADD  confirmbr  bit NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-22
				return @errstatus
			end
		end									
--
--       Add To stbranch Table 13
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='rebate_act')
		begin 
		    ALTER TABLE dbo.stbranch ADD  rebate_act  char(19) NULL default ''  with values
			if @@error<>0
			begin
				set @errstatus=-23
				return @errstatus
			end
		end		
--
--       Add To glsction Table 14
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'glsction' and COLUMN_NAME='rebate_act')
		begin 
		    ALTER TABLE dbo.glsction ADD  rebate_act  char(19) NULL default ''  with values
			if @@error<>0
			begin
				set @errstatus=-24
				return @errstatus
			end
		end	
--				
       if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'glsction' and COLUMN_NAME='LossRebateAct')
		begin 
		    ALTER TABLE dbo.glsction ADD  LossRebateAct  char(19) NULL default ''  with values
			if @@error<>0
			begin
				set @errstatus=-25
				return @errstatus
			end
		end	
--
--       Add To Salecntr Table 15
--			
       if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'salecntr' and COLUMN_NAME='sanedcrd_act')
		begin 
		    ALTER TABLE dbo.salecntr ADD  sanedcrd_act  char(19) NULL default ''  with values
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
		end	
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'salecntr' and COLUMN_NAME='no_of_invCopies')
		begin 
		    ALTER TABLE dbo.salecntr ADD  no_of_invCopies  numeric(1,0) NULL default 1  with values
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
		end	
--
--       Add To Sales_hd Table 16
--			
       if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Sales_hd' and COLUMN_NAME='sanedcrd_amt')
		begin 
		    ALTER TABLE dbo.Sales_hd ADD  sanedcrd_amt  numeric(12,2) NULL default 0.00  
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
		end	
       if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Sales_hd' and COLUMN_NAME='rtncash_dfrpl')
		begin 
		    ALTER TABLE dbo.Sales_hd ADD  rtncash_dfrpl  numeric(12,2) NULL default 0.00  
			if @@error<>0
			begin
				set @errstatus=-126
				return @errstatus
			end
		end	
--
--       Add To bkbnfch Table 17
--			
       if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bkbnfch' and COLUMN_NAME='dscprsnt')
		begin 
		    ALTER TABLE dbo.bkbnfch ADD  dscprsnt  numeric(5,2) NULL default 0.00  
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
		end	
--
--       Add To SLTRANS Table 20
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'SLTRANS' and COLUMN_NAME='pricePerUnit')
		begin 
			ALTER TABLE dbo.SLTRANS ADD  pricePerUnit  numeric(10,2) NULL default 0.00  
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
		end	
--
--       Add To slvchrimage Table 20
--
        if exists(SELECT table_NAME  FROM INFORMATION_SCHEMA.TABLES  WHERE TABLE_NAME = 'slvchrimage')
		begin
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='voucherNo')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  voucherNo  char(20) NULL default ''  
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end		
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='No_of_cartons')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  No_of_cartons  int NULL default 0  
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end	
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='pricePerUnit')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  pricePerUnit  numeric(10,2) NULL default 0.00 
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end	
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='carrierNo')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  carrierNo  char(3) NULL default ''  
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end	
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='DriverName')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  DriverName  char(30) NULL default ''  
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end	
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='mobileNo')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  mobileNo  nchar(20) NULL default ''  
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end	
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='delivaryDate')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  delivaryDate  char(8) NULL default ''  
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end	
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='rcvdDate')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  rcvdDate  char(8) NULL default ''  
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end	
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='rcvd_person')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  rcvd_person  char(30) NULL default ''  
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end	
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='Pstatus')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  Pstatus  char(1) NULL default ''  
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end	
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='notes')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  notes  text NULL default ''  
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end		
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='src')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  src  char(2) NULL default ''  
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end	
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='vdate')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  vdate  char(8) NULL default ''  
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end		
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='usrid')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  usrid  char(10) NULL default ''  
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end	
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='confirmed')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  confirmed  bit NULL default 0  
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end	

			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='rtnref')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  rtnref  numeric(6,0) NULL default 0
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end	
								  
			IF  not EXISTS(SELECT * FROM sys.indexes WHERE object_id = object_id('dbo.slvchrimage') AND NAME ='pk_slvchrimage')
			begin
				IF EXISTS(SELECT * FROM sys.indexes WHERE object_id = object_id('dbo.slvchrimage') AND NAME ='ix_slvchrimage')
				DROP INDEX IX_slvchrimage ON dbo.slvchrimage
				ALTER TABLE slvchrimage
				ADD CONSTRAINT pk_slvchrimage PRIMARY KEY (company,invtype,ref)
			end

		end
--
--       Add To pos_dt Table 20
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_dt' and COLUMN_NAME='nqati_prcnt')
		begin 
			ALTER TABLE dbo.pos_dt ADD  nqati_prcnt  numeric(3,0) NULL default 0.00  
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
		end		

		if (SELECT NUMERIC_PRECISION FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'Pos_dt' AND COLUMN_NAME = 'offer_amt')=5
		begin
			ALTER TABLE dbo.Pos_dt alter column offer_amt  numeric(8,2) 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end						
--
--       Add To apclass Table 20
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'apclass' and COLUMN_NAME='cstcode')
		begin 
			ALTER TABLE dbo.apclass ADD  cstcode  char(4) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
		end		
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'apclass' and COLUMN_NAME='classkey')
		begin 
			ALTER TABLE dbo.apclass ADD  classkey  char(2) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
		end	
--
--       Add To classfil Table 20   29-08-2014
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'classfil' and COLUMN_NAME='cstcode')
		begin 
			ALTER TABLE dbo.classfil ADD  cstcode  char(4) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
		end	
--
--       Add To glcstctr Table 20   29-08-2014
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'glcstctr' and COLUMN_NAME='cs_code')
		begin 
			ALTER TABLE dbo.glcstctr ADD  cs_code  char(4) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
		end	
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'glcstctr' and COLUMN_NAME='whtype')
		begin 
			ALTER TABLE dbo.glcstctr ADD  whtype  tinyint NULL default 1 
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
		end		
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stwhous' and COLUMN_NAME='cstcode')
		begin 
			ALTER TABLE dbo.stwhous ADD  cstcode  char(4) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
		end		
--		
-- pos_dsc Table 
--

		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_dsc' and COLUMN_NAME='nqati_openbal')
		begin 
			ALTER TABLE dbo.pos_dsc ADD  nqati_openbal  numeric(10,2) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
		end	
		if (SELECT character_maximum_length FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'pos_dsc' AND COLUMN_NAME = 'dsctel')<>21
		begin
			ALTER TABLE dbo.pos_dsc alter column dsctel  varchar(21) 
			if @@error<>0
			begin
				set @errstatus=-67
				return @errstatus
			end
		end
--		
-- sales_dd Table 
--
		IF  not EXISTS(SELECT * FROM sys.indexes WHERE object_id = object_id('dbo.sales_dd') AND NAME ='pk_sales_dd')
		begin
			ALTER TABLE sales_dd
			ADD CONSTRAINT pk_sales_dd PRIMARY KEY (company,invtype,ref,folio)
		end	
--		
-- NotifyMe Table 
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'NotifyMe' and COLUMN_NAME='actcode')
		begin 
			ALTER TABLE dbo.NotifyMe ADD  actcode  char(19) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
			ALTER TABLE dbo.NotifyMe ADD  fcy  char(3) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
		end	
--		
-- puprsnitems Table 
--
        if NOT exists(SELECT table_NAME  FROM INFORMATION_SCHEMA.TABLES  WHERE TABLE_NAME = 'puprsnitems')
		begin
		    create table dbo.puprsnitems(
			 itemno char(16) not null,slcode char(2) null default '', notified  bit NULL default 0			 
			CONSTRAINT [PK_puprsnitems] PRIMARY KEY CLUSTERED 
			(
				[itemno] ASC
			)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
			) ON [PRIMARY]
		end
		else
		begin
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'puprsnitems' and COLUMN_NAME='notified')
			begin 
				ALTER TABLE dbo.puprsnitems ADD notified  bit NULL default 0 
				if @@error<>0
				begin
					set @errstatus=-88
					return @errstatus
				end
			end								
		end	
--		
-- pos_slp Table 
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_slp' and COLUMN_NAME='ReadInvByBarcd')
		begin 
			ALTER TABLE dbo.pos_slp ADD  ReadInvByBarcd  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-88
				return @errstatus
			end
		end	

--		
-- salesmen Table 
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'salesmen' and COLUMN_NAME='usrid')
		begin 
			ALTER TABLE dbo.salesmen ADD  usrid  char(10) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-89
				return @errstatus
			end
		end	
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'salesmen' and COLUMN_NAME='notify_within')
		begin 
			ALTER TABLE dbo.salesmen ADD  notify_within  int NULL default 15 
			if @@error<>0
			begin
				set @errstatus=-90
				return @errstatus
			end
		end	
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'salesmen' and COLUMN_NAME='notify_type')
		begin 
			ALTER TABLE dbo.salesmen ADD  notify_type  int NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-91
				return @errstatus
			end
		end	
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'salesmen' and COLUMN_NAME='slemail')
		begin 
			ALTER TABLE dbo.salesmen ADD  slemail  varchar(60) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-92
				return @errstatus
			end
		end	
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'salesmen' and COLUMN_NAME='slmobile')
		begin 
			ALTER TABLE dbo.salesmen ADD  slmobile  varchar(20) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-93
				return @errstatus
			end
		end	
--		
-- stoffers Table 
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stoffers' and COLUMN_NAME='Max2buy')
		begin 
			ALTER TABLE dbo.stoffers ADD  Max2buy  int NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-95
				return @errstatus
			end
		end	
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stoffers' and COLUMN_NAME='lprice1')
		begin 
			ALTER TABLE dbo.stoffers ADD  lprice1  numeric(11,2) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-95
				return @errstatus
			end
		end	
--		
-- pos_chrt Table 
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_chrt' and COLUMN_NAME='saved_halals')
		begin 
			ALTER TABLE dbo.pos_chrt ADD  saved_halals  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-96
				return @errstatus
			end
	    end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_chrt' and COLUMN_NAME='shft_fkey')
		begin 
			ALTER TABLE dbo.pos_chrt ADD  shft_fkey  char(2) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-97
				return @errstatus
			end
		end					
--  Arhdr & Ardtl change column data type 
        if  exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'arhdr' and COLUMN_NAME='hd_ltotal' 
		              AND DATA_TYPE='numeric')
		begin
			ALTER TABLE dbo.arhdr ALTER column  hd_ltotal  float NULL
			if @@error<>0
			begin
				set @errstatus=-100
				return @errstatus
			end
			ALTER TABLE dbo.arhdr ALTER column  hd_ftotal  float NULL
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
---
			ALTER TABLE dbo.arhdr ALTER column  hd_lcnet  float NULL
			if @@error<>0
			begin
				set @errstatus=-102
				return @errstatus
			end
			ALTER TABLE dbo.arhdr ALTER column  hd_fcnet  float NULL
			if @@error<>0
			begin
				set @errstatus=-103
				return @errstatus
			end
---
			ALTER TABLE dbo.arhdr ALTER column  hd_lccnet  float NULL
			if @@error<>0
			begin
				set @errstatus=-104
				return @errstatus
			end
			ALTER TABLE dbo.arhdr ALTER column  hd_fccnet  float NULL
			if @@error<>0
			begin
				set @errstatus=-105
				return @errstatus
			end	
			ALTER TABLE dbo.arhdr ALTER column  opst_val  float NULL
			if @@error<>0
			begin
				set @errstatus=-106
				return @errstatus
			end							
		end	
---  Ardtl 
       if  exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'ardtl' and COLUMN_NAME='dt_lcamt' 
		              AND DATA_TYPE='numeric')
		begin
			ALTER TABLE dbo.ardtl ALTER column  dt_lcamt  float NULL
			if @@error<>0
			begin
				set @errstatus=-107
				return @errstatus
			end
			ALTER TABLE dbo.ardtl ALTER column  dt_paidamt  float NULL
			if @@error<>0
			begin
				set @errstatus=-108
				return @errstatus
			end
---
			ALTER TABLE dbo.ardtl ALTER column  dt_discamt  float NULL
			if @@error<>0
			begin
				set @errstatus=-109
				return @errstatus
			end
			ALTER TABLE dbo.ardtl ALTER column  dt_fcamt  float NULL
			if @@error<>0
			begin
				set @errstatus=-110
				return @errstatus
			end
---
			ALTER TABLE dbo.ardtl ALTER column  dt_fpydamt  float NULL
			if @@error<>0
			begin
				set @errstatus=-111
				return @errstatus
			end
			ALTER TABLE dbo.ardtl ALTER column  dt_fdscamt  float NULL
			if @@error<>0
			begin
				set @errstatus=-112
				return @errstatus
			end	
			ALTER TABLE dbo.ardtl ALTER column  dt_lcaloc  float NULL
			if @@error<>0
			begin
				set @errstatus=-113
				return @errstatus
			end	
			ALTER TABLE dbo.ardtl ALTER column  dt_fcaloc  float NULL
			if @@error<>0
			begin
				set @errstatus=-114
				return @errstatus
			end											
		end		
--
-- Sales_qd
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'SALES_QD' and COLUMN_NAME='folio')
		begin 
		    ALTER TABLE dbo.sales_qd ADD  folio  numeric(4,0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-115
				return @errstatus
			end
	    end																																				   	   																																				
		

-- To fix the Nchar data type in slvchrimage & stitembc

       if  exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='mobileNo' 
		              AND DATA_TYPE='NCHAR')
		begin
			DECLARE @ConstraintName nvarchar(200),@lcommand nvarchar(200)
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[slvchrimage]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'mobileNo' AND
			object_id = OBJECT_ID(N'[slvchrimage]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[slvchrimage] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
			    set @errstatus=-116			
			 	return @errstatus
				end
			end
--			ALTER TABLE [dbo].[slvchrimage] drop  CONSTRAINT @ConstraintName --DF__slvchrima__mobil__4FD1D5C8

			ALTER TABLE dbo.slvchrimage ALTER column  mobileNo  CHAR(20) NULL
			if @@error<>0
			begin
			    set @errstatus=-116			
			 	return @errstatus
			end
		END
      if  exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stitembc' and COLUMN_NAME='pack' 
		              AND DATA_TYPE='NCHAR')
		begin
			ALTER TABLE dbo.stitembc ALTER column  pack  CHAR(1) NULL
			if @@error<>0
			begin
				set @errstatus=-117
				return @errstatus
			end
		END
--		
-- aplcrmt_dt   
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'aplcrmt_dt' and COLUMN_NAME='bname')
		begin 
		    
			ALTER TABLE dbo.aplcrmt_dt ADD  bname  varchar(60) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-100
				return @errstatus
			end
			ALTER TABLE dbo.aplcrmt_dt ADD  bbkacct  varchar(60) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
			ALTER TABLE dbo.aplcrmt_dt ADD  bbank  varchar(50) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-102
				return @errstatus
			end
			ALTER TABLE dbo.aplcrmt_dt ADD  extradsc  numeric(12,2) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-103
				return @errstatus
			end
			ALTER TABLE dbo.aplcrmt_dt ADD  desctxt  varchar(60) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-104
				return @errstatus
			end
		end	
	    if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'aplcrmt_dt' and COLUMN_NAME='venderbal')
		begin 
			ALTER TABLE dbo.aplcrmt_dt ADD  venderbal  float NULL default 0
			if @@error<>0
			begin
				set @errstatus=-106
				return @errstatus
			end
			ALTER TABLE dbo.aplcrmt_dt ADD  diffbal2  float NULL default 0
			if @@error<>0
			begin
				set @errstatus=-107
				return @errstatus
			end
		end
	    if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'aplcrmt_dt' and COLUMN_NAME='cnfdate')
		begin 
			ALTER TABLE dbo.aplcrmt_dt ADD  cnfdate  char(8) NULL 
			if @@error<>0
			begin
				set @errstatus=-108
				return @errstatus
			end
			ALTER TABLE dbo.aplcrmt_dt ADD  usrcnf  char(10) NULL 
			if @@error<>0
			begin
				set @errstatus=-109
				return @errstatus
			end
		end
--		
-- sales_od table
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'SALES_OD' and COLUMN_NAME='folio')
		begin 
		    ALTER TABLE dbo.sales_od ADD  folio  int NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-110
				return @errstatus
			end
        end

--		
-- Ord_dtl table
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'ord_dtl' and COLUMN_NAME='folio')
		begin 
		    ALTER TABLE dbo.ord_dtl ADD  folio  int NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-111
				return @errstatus
			end
        end
		IF  not EXISTS(SELECT NAME FROM sys.indexes WHERE object_id = object_id('dbo.ord_dtl') AND NAME ='ix_ord_dtl2')
		begin
			create NONCLUSTERED INDEX ix_ord_dtl2 
			ON dbo.ord_dtl (company,ref,itemno,unicode);
		end	
--		
-- pos_hd table
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_hd' and COLUMN_NAME='saned_amt')
		begin 
		    ALTER TABLE dbo.pos_hd ADD  saned_amt  numeric(12,2) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-112
				return @errstatus
			end
        end
	   if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_hd' and COLUMN_NAME='chargeamt' 
		              AND DATA_TYPE='numeric')
		begin
			ALTER TABLE dbo.pos_hd ALTER column  chargeamt  float NULL
			if @@error<>0
			begin
				set @errstatus=-113
				return @errstatus
			end
		end	
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_hd' and COLUMN_NAME='rtncshamt')
		begin 
		    ALTER TABLE dbo.pos_hd ADD  rtncshamt  numeric(12,2) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-120
				return @errstatus
			end
        end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_hd' and COLUMN_NAME='dfvchramt')
		begin 
		    ALTER TABLE dbo.pos_hd ADD  dfvchramt  numeric(12,2) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-121
				return @errstatus
			end
        end

        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_hd' and COLUMN_NAME='frc_rtncash')
		begin 
		    ALTER TABLE dbo.pos_hd ADD  frc_rtncash  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-121
				return @errstatus
			end
        end
--		
-- Pos_mny table
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Pos_mny' and COLUMN_NAME='saned_amt')
		begin 
		    ALTER TABLE dbo.Pos_mny ADD  saned_amt  numeric(12,2) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-116
				return @errstatus
			end
        end
       if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Pos_mny' and COLUMN_NAME='scsaned_amt')
		begin 
		    ALTER TABLE dbo.Pos_mny ADD  scsaned_amt  numeric(12,2) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-117
				return @errstatus
			end
        end
--		
-- Pos_slp table
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_slp' and COLUMN_NAME='alwrtncash')
		begin 
			ALTER TABLE dbo.pos_slp ADD  alwrtncash  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-119
				return @errstatus
			end
		end		
--		
-- Pos_ctr table
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_ctr' and COLUMN_NAME='ctrsaned')
		begin 
			ALTER TABLE dbo.pos_ctr ADD  ctrsaned  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-120
				return @errstatus
			end

		end		
---  stdtl 
       if  exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stdtl' and COLUMN_NAME='qty' 
		              AND DATA_TYPE='numeric')
		begin
			ALTER TABLE dbo.stdtl ALTER column  qty  float NULL
			if @@error<>0
			begin
				set @errstatus=-123
				return @errstatus
			end
        end		
--		
-- aplcrmt_dt   
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'aplcrmt_dt' and COLUMN_NAME='adjval')
		begin 
		    
			ALTER TABLE dbo.aplcrmt_dt ADD  adjval  float NULL default 0.00
			if @@error<>0
			begin
				set @errstatus=-124
				return @errstatus
			end
        end				
--		
-- sales_dt  
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_dt' and COLUMN_NAME='sold_item_status')
		begin 
		    
			ALTER TABLE dbo.sales_dt ADD  sold_item_status  int NULL default 0
			if @@error<>0
			begin
				set @errstatus=-125
				return @errstatus
			end
        end		
--		
-- sthdr   
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sthdr' and COLUMN_NAME='repost')
		begin 
		    
			ALTER TABLE dbo.sthdr ADD  repost  bit NULL default 0
			if @@error<>0
			begin
				set @errstatus=-126
				return @errstatus
			end
        end		
--		
-- Pos_slp table
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_slp' and COLUMN_NAME='alwmtchrtn')
		begin 
			ALTER TABLE dbo.pos_slp ADD  alwmtchrtn  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-127
				return @errstatus
			end
		end	
--		
-- bktransx   
--
		if (SELECT character_maximum_length FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'bktransx' AND COLUMN_NAME = 'bcode')<>6
		begin
			ALTER TABLE dbo.bktransx alter column bcode  char(6) 
			if @@error<>0
			begin
				set @errstatus=-110
				return @errstatus
			end
		end

      if  exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_dt' and COLUMN_NAME='sold_item_status' 
		              AND DATA_TYPE='BIT')
		begin
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[sales_dt]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'sold_item_status' AND
			object_id = OBJECT_ID(N'[sales_dt]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[sales_dt] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
			    set @errstatus=-116			
			 	return @errstatus
				end
			end
			ALTER TABLE dbo.sales_dt ALTER column  sold_item_status  int NULL
			if @@error<>0
			begin
			    set @errstatus=-116			
			 	return @errstatus
			end
		END
--
--       Add To glsction 
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'glsction' and COLUMN_NAME='jv_01')
		begin 
		    ALTER TABLE dbo.glsction ADD  jv_01  numeric(6, 0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-124
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_02  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-125
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_03  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-126
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_04  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-127
				return @errstatus
			end

		    ALTER TABLE dbo.glsction ADD  jv_05  numeric(6, 0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-128
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_06  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-129
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_07  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-130
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_08  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-131
				return @errstatus
			end

		    ALTER TABLE dbo.glsction ADD  jv_09  numeric(6, 0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-132
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_10  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-133
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_11  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-134
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_12  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-135
				return @errstatus
			end

		    ALTER TABLE dbo.glsction ADD  jv_13  numeric(6, 0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-136
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_14  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-137
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_18  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-138
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_19  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-139
				return @errstatus
			end

		    ALTER TABLE dbo.glsction ADD  jv_20  numeric(6, 0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-140
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_21  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-141
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_22  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-142
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_23  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-143
				return @errstatus
			end

		    ALTER TABLE dbo.glsction ADD  jv_24  numeric(6, 0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-144
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_26  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-145
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_27  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-146
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_28  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-147
				return @errstatus
			end

		    ALTER TABLE dbo.glsction ADD  jv_30  numeric(6, 0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-148
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_31  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-149
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_32  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-150
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_33  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-151
				return @errstatus
			end

		    ALTER TABLE dbo.glsction ADD  jv_34  numeric(6, 0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-152
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_45  numeric(10, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-153
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_46  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-154
				return @errstatus
			end

		    ALTER TABLE dbo.glsction ADD  jv_16  numeric(6, 0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-156
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_17  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-157
				return @errstatus
			end
		end
--		
-- stoffers Table 
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stoffers' and COLUMN_NAME='itemgroup')
		begin 
			ALTER TABLE dbo.stoffers ADD  itemgroup  char(1) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-159
				return @errstatus
			end
		end	
--		
-- pos_ctr Table 
--
		if  exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_ctr' and COLUMN_NAME='eftpos')
		begin 
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[pos_ctr]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'eftpos' AND
			object_id = OBJECT_ID(N'[pos_ctr]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[pos_ctr] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
			    set @errstatus=-167			
			 	return @errstatus
				end
			end
			ALTER TABLE dbo.pos_ctr drop  column eftpos 
			if @@error<>0
			begin
				set @errstatus=-163
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_ctr' and COLUMN_NAME='ctreftpos')
		begin 

			ALTER TABLE dbo.pos_ctr ADD  ctreftpos  char(2) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-164
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_ctr' and COLUMN_NAME='ctrsndecrpos')
		begin
			ALTER TABLE dbo.pos_ctr ADD  ctrsndecrpos  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-165
				return @errstatus
			end
		end	

		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_ctr' and COLUMN_NAME='eftport')
		begin 

			ALTER TABLE dbo.pos_ctr ADD  eftport  numeric(2,0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-166
				return @errstatus
			end
		end
--		
-- pos_slp Table 
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_slp' and COLUMN_NAME='alwinvtrnsfr')
		begin 
			ALTER TABLE dbo.pos_slp ADD  alwinvtrnsfr  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-122
				return @errstatus
			end
		end			

--		
-- POS_HD 
--
        if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'POS_HD' and COLUMN_NAME='invdspc' 
		              AND DATA_TYPE='numeric')
		begin
			ALTER TABLE dbo.POS_HD ALTER column  invdspc  float NULL
			if @@error<>0
			begin
				set @errstatus=-160
				return @errstatus
			end
		end
--		
-- POS_HDTI 
--
        if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'POS_HDTI' and COLUMN_NAME='invdspc' 
		              AND DATA_TYPE='numeric')
		begin
			ALTER TABLE dbo.POS_HDTI ALTER column  invdspc  float NULL
			if @@error<>0
			begin
				set @errstatus=-161
				return @errstatus
			end
		end
----------------------------------------------------------------------------------------------------------------------
---
------------  Modification for Dinar currency 
---        
		if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'positems' and COLUMN_NAME='lprice1' 
		              AND DATA_TYPE='numeric')
		begin	
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[positems]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'lprice1' AND
			object_id = OBJECT_ID(N'[positems]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[positems] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
					set @errstatus=-116			
			 		return @errstatus
				end
			end	
			ALTER TABLE dbo.positems ALTER column  lprice1  float NULL 
			if @@error<>0
			begin
			    set @errstatus=-116			
			 	return @errstatus
			end	
		end
		if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'positems' and COLUMN_NAME='lprice2' 
		              AND DATA_TYPE='numeric')
		begin
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[positems]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'lprice2' AND
			object_id = OBJECT_ID(N'[positems]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[positems] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
					set @errstatus=-116			
			 		return @errstatus
				end
			end	
			ALTER TABLE dbo.positems ALTER column  lprice2  float NULL 
			if @@error<>0
			begin
			    set @errstatus=-116			
			 	return @errstatus
			end	
		end
		if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'positems' and COLUMN_NAME='lprice3' 
		              AND DATA_TYPE='numeric')
		begin

			ALTER TABLE dbo.positems ALTER column  lprice3  float NULL 
			if @@error<>0
			begin
			    set @errstatus=-116			
			 	return @errstatus
			end	
		end
		if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'positems' and COLUMN_NAME='mnmprice' 
		              AND DATA_TYPE='numeric')
		begin
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[positems]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'mnmprice' AND
			object_id = OBJECT_ID(N'[positems]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[positems] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
					set @errstatus=-116			
			 		return @errstatus
				end
			end	
			ALTER TABLE dbo.positems ALTER column  mnmprice  float NULL 
			if @@error<>0
			begin
			    set @errstatus=-116			
			 	return @errstatus
			end	
		end
------   POS_HD
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'Pos_hd' AND COLUMN_NAME = 'invpaid')=2
		begin
			ALTER TABLE dbo.Pos_hd alter column invpaid  numeric(12,3) 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end		
			
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'Pos_hd' AND COLUMN_NAME = 'cashamt')=2
		begin
			ALTER TABLE dbo.Pos_hd alter column cashamt  numeric(12,3) 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end	


		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'Pos_hd' AND COLUMN_NAME = 'ccpaid')=2
		begin
			ALTER TABLE dbo.Pos_hd alter column ccpaid  numeric(12,3) 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end	

		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'Pos_hd' AND COLUMN_NAME = 'prepaidamt')=2
		begin
			ALTER TABLE dbo.Pos_hd alter column prepaidamt  numeric(12,3) 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end	
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'Pos_hd' AND COLUMN_NAME = 'saned_amt')=2
		begin
			ALTER TABLE dbo.Pos_hd alter column saned_amt  numeric(12,3) 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end	

		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'Pos_hd' AND COLUMN_NAME = 'rtncshamt')=2
		begin
			ALTER TABLE dbo.Pos_hd alter column rtncshamt  numeric(12,3) 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end	

		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'Pos_hd' AND COLUMN_NAME = 'dfvchramt')=2
		begin
			ALTER TABLE dbo.Pos_hd alter column dfvchramt  numeric(12,3) 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end	
--------  POSRTNINV 
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POSTRNINV' AND COLUMN_NAME = 'rtnamt')=2
		begin
			ALTER TABLE dbo.POSTRNINV alter column rtnamt  numeric(12,3) 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end	
--------  POSCCCARD 
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POSCCCARD' AND COLUMN_NAME = 'ccpaid')=2
		begin
			ALTER TABLE dbo.POSCCCARD alter column ccpaid  numeric(12,3) 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end
--------  POSPPCARD 
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POSPPCARD' AND COLUMN_NAME = 'prepaidamt')=2
		begin
			ALTER TABLE dbo.POSPPCARD alter column prepaidamt  numeric(12,3) 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end	

--------  POSPPCARD 
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POSOFFERS' AND COLUMN_NAME = 'GivenAmt')=2
		begin
			ALTER TABLE dbo.POSOFFERS alter column GivenAmt  numeric(9,3) 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end	

       if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POSOFFERS' AND COLUMN_NAME = 'LPRICE1')=2
		begin
			ALTER TABLE dbo.POSOFFERS alter column LPRICE1  numeric(12,3) 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end	

--------  POSFCAMT 
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POSFCAMT' AND COLUMN_NAME = 'lcamt')=2
		begin
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[POSFCAMT]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'lcamt' AND
			object_id = OBJECT_ID(N'[POSFCAMT]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[POSFCAMT] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
					set @errstatus=-116			
			 		return @errstatus
				end
			end	
			ALTER TABLE dbo.POSFCAMT alter column lcamt  FLOAT  
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end

--------  POS_DSC 
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POS_DSC' AND COLUMN_NAME = 'mnth_target')=2
		begin
			ALTER TABLE dbo.POS_DSC alter column mnth_target  numeric(12,3)   
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POS_DSC' AND COLUMN_NAME = 'mnthbal')=2
		begin
			ALTER TABLE dbo.POS_DSC alter column mnthbal  numeric(12,3)   
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POS_DSC' AND COLUMN_NAME = 'prepaidamt')=2
		begin
			ALTER TABLE dbo.POS_DSC alter column prepaidamt  numeric(10,3)   
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POS_DSC' AND COLUMN_NAME = 'cust_ttlsales')=2
		begin
			ALTER TABLE dbo.POS_DSC alter column cust_ttlsales  numeric(12,3)   
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end

		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POS_DSC' AND COLUMN_NAME = 'sales_grantd')=2
		begin
			ALTER TABLE dbo.POS_DSC alter column sales_grantd  numeric(12,3)   
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POS_DSC' AND COLUMN_NAME = 'ttl_grantd')=2
		begin
			ALTER TABLE dbo.POS_DSC alter column ttl_grantd  numeric(12,3)   
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POS_DSC' AND COLUMN_NAME = 'vchr_value')=2
		begin
			ALTER TABLE dbo.POS_DSC alter column vchr_value  numeric(12,3)   
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POS_DSC' AND COLUMN_NAME = 'vchr_used')=2
		begin
			ALTER TABLE dbo.POS_DSC alter column vchr_used  numeric(12,3)   
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POS_DSC' AND COLUMN_NAME = 'nqati_openbal')=2
		begin
			ALTER TABLE dbo.POS_DSC alter column nqati_openbal  numeric(10,3)   
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end
		

--------  INVHSTRY 
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'INVHSTRY' AND COLUMN_NAME = 'qty')=2
		begin
			ALTER TABLE dbo.INVHSTRY alter column qty  FLOAT   
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'INVHSTRY' AND COLUMN_NAME = 'PRICE')=2
		begin
			ALTER TABLE dbo.INVHSTRY alter column PRICE  FLOAT   
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'INVHSTRY' AND COLUMN_NAME = 'OFFER_AMT')=2
		begin

			ALTER TABLE dbo.INVHSTRY alter column OFFER_AMT  numeric(10,3)    
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end

		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'INVHSTRY' AND COLUMN_NAME = 'qtydel')=2
		begin
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[INVHSTRY]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'qtydel' AND
			object_id = OBJECT_ID(N'[INVHSTRY]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[INVHSTRY] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
					set @errstatus=-116			
			 		return @errstatus
				end
			end	
			ALTER TABLE dbo.INVHSTRY alter column qtydel  FLOAT   
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end
------   POS_DT
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POS_DT' AND COLUMN_NAME = 'OFFER_AMT')=2
		begin
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[POS_DT]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'OFFER_AMT' AND
			object_id = OBJECT_ID(N'[POS_DT]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[POS_DT] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
					set @errstatus=-116			
			 		return @errstatus
				end
			end	
			ALTER TABLE dbo.POS_DT alter column OFFER_AMT  numeric(9,3)   
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end
--------------------------------------------  End of Modification for Dinar currency  ----------------------------																					   	   																																				

----------------------------------------------------------------------------------------------------------------------							
--
--       Add To sysuse Table 12 
--
      if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sysuse' and COLUMN_NAME='mobilNo')
		begin 
		    ALTER TABLE dbo.sysuse ADD  mobilNo  nvarchar(30) NULL default ''  with values
			if @@error<>0
			begin
				set @errstatus=-222
				return @errstatus
			end
		end	
     if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sysuse' and COLUMN_NAME='OTP')
		begin 
		    ALTER TABLE dbo.sysuse ADD  OTP  int NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-223
				return @errstatus
			end
		end	
     if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sysuse' and COLUMN_NAME='web_rights')
		begin 
		    ALTER TABLE dbo.sysuse ADD  web_rights  nvarchar(254) NULL default ''  with values
			if @@error<>0
			begin
				set @errstatus=-224
				return @errstatus
			end
		end	
------   poscccard
		if (SELECT CHARACTER_MAXIMUM_LENGTH FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'poscccard' AND COLUMN_NAME = 'TransDate')=4
		begin
			ALTER TABLE dbo.poscccard alter column TransDate  varchar(10)
			if @@error<>0
			begin
				set @errstatus=-225
				return @errstatus
			end
		end		
		if (SELECT CHARACTER_MAXIMUM_LENGTH FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'poscccard' AND COLUMN_NAME = 'TransTime')=6
		begin
			ALTER TABLE dbo.poscccard alter column TransTime  varchar(10)
			if @@error<>0
			begin
				set @errstatus=-226
				return @errstatus
			end
		end		
--------   sthdr fcyrate
		if (SELECT NUMERIC_PRECISION FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'sthdr' AND COLUMN_NAME = 'fcyrate')=6
		begin
			ALTER TABLE dbo.sthdr alter column fcyrate  numeric(9,6) 
			if @@error<>0
			begin
				set @errstatus=-227
				return @errstatus
			end
		end	
--------  Stitmphoto remarks 
		if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Stitmphoto' and COLUMN_NAME='remarks' 
		              AND CHARACTER_MAXIMUM_LENGTH=70)
		begin
			ALTER TABLE dbo.Stitmphoto ALTER column  remarks  varchar(100) NULL 
			if @@error<>0
			begin
			    set @errstatus=-228			
			 	return @errstatus
			end	
		end

-----------------------------------------------------------------------------------------------------------------------------------------
-------------------------------  To alter all needed columns for VAT in some tables ----------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------

		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pudept' and COLUMN_NAME='vat_paid_act')
		begin 
			ALTER TABLE dbo.pudept ADD  vat_paid_act  char(19) NULL default ''  with values
			if @@error<>0
			begin
				set @errstatus=-230
				return @errstatus
			end
		end		
		
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'salecntr' and COLUMN_NAME='vat_rcvd_act')
		begin 
			ALTER TABLE dbo.salecntr ADD  vat_rcvd_act  char(19) NULL default ''  with values
			if @@error<>0
			begin
				set @errstatus=-231
				return @errstatus
			end
		end	
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'puhdr' and COLUMN_NAME='vat_amt_paid')
		begin 
			ALTER TABLE dbo.puhdr ADD  vat_amt_paid  float NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-232
				return @errstatus
			end
		end			
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'puhdr' and COLUMN_NAME='taxfree_purchase')
		begin 
			ALTER TABLE dbo.puhdr ADD  taxfree_purchase  float NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-233
				return @errstatus
			end
		end	
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'puhdr' and COLUMN_NAME='VatNot4Vender')
		begin 
			ALTER TABLE dbo.puhdr ADD  VatNot4Vender  bit NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-234
				return @errstatus
			end
		end	
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'puhdr' and COLUMN_NAME='vndr_taxcode')
		begin 
			ALTER TABLE dbo.puhdr ADD  vndr_taxcode  varchar(20) NULL default ''  with values
			if @@error<>0
			begin
				set @errstatus=-234
				return @errstatus
			end
		end	
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_hd' and COLUMN_NAME='vat_amt_rcvd')
		begin 
			ALTER TABLE dbo.sales_hd ADD  vat_amt_rcvd  float NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-235
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_hd' and COLUMN_NAME='taxfree_sales')
		begin 
			ALTER TABLE dbo.sales_hd ADD  taxfree_sales  float NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-236
				return @errstatus
			end
		end	

		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_qh' and COLUMN_NAME='vat_amt_rcvd')
		begin 
			ALTER TABLE dbo.sales_qh ADD  vat_amt_rcvd  float NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-237
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_qh' and COLUMN_NAME='taxfree_sales')
		begin 
			ALTER TABLE dbo.sales_qh ADD  taxfree_sales  float NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-238
				return @errstatus
			end
		end	
		
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_dh' and COLUMN_NAME='vat_amt_rcvd')
		begin 
			ALTER TABLE dbo.sales_dh ADD  vat_amt_rcvd  float NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-251
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_dh' and COLUMN_NAME='taxfree_sales')
		begin 
			ALTER TABLE dbo.sales_dh ADD  taxfree_sales  float NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-252
				return @errstatus
			end
		end				
				
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stitems' and COLUMN_NAME='taxtype')
		begin 
			ALTER TABLE dbo.stitems ADD  taxtype  char(1) NULL default '1'  with values
			if @@error<>0
			begin
				set @errstatus=-239
				return @errstatus
			end
		end	

		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_hd' and COLUMN_NAME='vat_amt_rcvd')
		begin 
			ALTER TABLE dbo.pos_hd ADD  vat_amt_rcvd  float NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-237
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_hd' and COLUMN_NAME='taxfree_sales')
		begin 
			ALTER TABLE dbo.pos_hd ADD  taxfree_sales  float NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-238
				return @errstatus
			end
		end	

		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_hdti' and COLUMN_NAME='vat_amt_rcvd')
		begin 
			ALTER TABLE dbo.pos_hdti ADD  vat_amt_rcvd  float NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-237
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_hdti' and COLUMN_NAME='taxfree_sales')
		begin 
			ALTER TABLE dbo.pos_hdti ADD  taxfree_sales  float NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-238
				return @errstatus
			end
		end		
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'supplier' and COLUMN_NAME='vndr_taxcode')
		begin 
			ALTER TABLE dbo.supplier ADD  vndr_taxcode  varchar(20) NULL default ''  with values
			if @@error<>0
			begin
				set @errstatus=-239
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'supplier' and COLUMN_NAME='taxfree')
		begin 
			ALTER TABLE dbo.supplier ADD  taxfree  bit NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-240
				return @errstatus
			end
		end	
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'customer' and COLUMN_NAME='clnt_taxcode')
		begin 
			ALTER TABLE dbo.customer ADD  clnt_taxcode  varchar(20) NULL default ''  with values
			if @@error<>0
			begin
				set @errstatus=-241
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'customer' and COLUMN_NAME='taxfree')
		begin 
			ALTER TABLE dbo.customer ADD  taxfree  bit NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-242
				return @errstatus
			end
		end		
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'supplier' and COLUMN_NAME='cu_kind')
		begin 
			ALTER TABLE dbo.supplier ADD  cu_kind  char(1) NULL default '1'  with values
			if @@error<>0
			begin
				set @errstatus=-239
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'customer' and COLUMN_NAME='cu_kind')
		begin 
			ALTER TABLE dbo.customer ADD  cu_kind  char(1) NULL default '1'  with values
			if @@error<>0
			begin
				set @errstatus=-239
				return @errstatus
			end
		end		
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'puhdr' and COLUMN_NAME='tax_Pd_mthd')
		begin 
			ALTER TABLE dbo.puhdr ADD  tax_Pd_mthd  char(1) NULL default ''  with values
			if @@error<>0
			begin
				set @errstatus=-234
				return @errstatus
			end
		end			
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_hd' and COLUMN_NAME='clnt_taxcode')
		begin 
			ALTER TABLE dbo.sales_hd ADD  clnt_taxcode  varchar(20) NULL default ''  with values
			if @@error<>0
			begin
				set @errstatus=-241
				return @errstatus
			end
		end
		IF  not EXISTS(SELECT NAME FROM sys.indexes WHERE object_id = object_id('dbo.stcosttype') AND NAME ='ix_stcosttype')
		begin
			create NONCLUSTERED INDEX ix_stcosttype 
			ON dbo.stcosttype (itemno,unicode);
				--ALTER TABLE dbo.stcosttype
				--ADD CONSTRAINT ix_stcosttype FOREIGN KEY (itemno,unicode);
		end	
------   puhdr 2018-01-20 
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'puhdr' AND COLUMN_NAME = 'fixrate')=3
		begin
			ALTER TABLE dbo.puhdr alter column fixrate  numeric(9,6) 
			if @@error<>0
			begin
				set @errstatus=-242
				return @errstatus
			end
		end	
		if (SELECT NUMERIC_PRECISION FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'puhdr' AND COLUMN_NAME = 'fcyrate')<=8
		begin
			ALTER TABLE dbo.puhdr alter column fcyrate  numeric(9,6) 
			if @@error<>0
			begin
				set @errstatus=-243
				return @errstatus
			end
		end	

		if (SELECT NUMERIC_PRECISION FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'aphdr' AND COLUMN_NAME = 'hd_fcyrate')<=8
		begin
			ALTER TABLE dbo.aphdr alter column hd_fcyrate  numeric(9,6) 
			if @@error<>0
			begin
				set @errstatus=-244
				return @errstatus
			end
		end	
		if (SELECT NUMERIC_PRECISION FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'arhdr' AND COLUMN_NAME = 'hd_fcyrate')<=8
		begin
			ALTER TABLE dbo.arhdr alter column hd_fcyrate  numeric(9,6) 
			if @@error<>0
			begin
				set @errstatus=-245
				return @errstatus
			end
		end			
		if (SELECT NUMERIC_PRECISION FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'sdhdr' AND COLUMN_NAME = 'hd_fcyrate')<=8
		begin
			ALTER TABLE dbo.sdhdr alter column hd_fcyrate  numeric(9,6) 
			if @@error<>0
			begin
				set @errstatus=-246
				return @errstatus
			end
		end																								
-----------------------------  AAXXVAT    ------------------------------------------
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_hd' and COLUMN_NAME='sysno')
		begin 
			ALTER TABLE dbo.sales_hd ADD  sysno  numeric(1,0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_hd' and COLUMN_NAME='no_round_nm')
		begin 
			ALTER TABLE dbo.sales_hd ADD  no_round_nm  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_hd' and COLUMN_NAME='PriceVatType')
		begin 
			ALTER TABLE dbo.sales_hd ADD  PriceVatType  numeric(1,0) NULL default 1  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_hd' and COLUMN_NAME='hlldscnt')
		begin 
			ALTER TABLE dbo.sales_hd ADD  hlldscnt  float NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'puhdr' and COLUMN_NAME='hlldscnt')
		begin 
			ALTER TABLE dbo.puhdr ADD  hlldscnt  float NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end		

		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_dt' and COLUMN_NAME='taxtype')
		begin 
			ALTER TABLE dbo.sales_dt ADD  taxtype  char(1) NULL default '1'  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pudtl' and COLUMN_NAME='taxtype')
		begin 
			ALTER TABLE dbo.pudtl ADD  taxtype  char(1) NULL default '1'  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
---------------------- Stbranch
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='sysno')
		begin 
			ALTER TABLE dbo.stbranch ADD  sysno  numeric(1,0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='no_round_nm')
		begin 
			ALTER TABLE dbo.stbranch ADD  no_round_nm  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='PriceVatType')
		begin 
			ALTER TABLE dbo.stbranch ADD  PriceVatType  numeric(1,0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='mkt_frc_rounding')
		begin 
			ALTER TABLE dbo.stbranch ADD  mkt_frc_rounding  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='is_dsc_amt')
		begin 
			ALTER TABLE dbo.stbranch ADD  is_dsc_amt  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='auto_dsc_hll')
		begin 
			ALTER TABLE dbo.stbranch ADD  auto_dsc_hll  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='max_dsc_hll')
		begin 
			ALTER TABLE dbo.stbranch ADD  max_dsc_hll  numeric(3,2) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
---------------------- glsction
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Glsction' and COLUMN_NAME='sysno')
		begin 
			ALTER TABLE dbo.Glsction ADD  sysno  numeric(1,0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Glsction' and COLUMN_NAME='no_round_nm')
		begin 
			ALTER TABLE dbo.Glsction ADD  no_round_nm  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Glsction' and COLUMN_NAME='PriceVatType')
		begin 
			ALTER TABLE dbo.Glsction ADD  PriceVatType  numeric(1,0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Glsction' and COLUMN_NAME='mkt_frc_rounding')
		begin 
			ALTER TABLE dbo.Glsction ADD  mkt_frc_rounding  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Glsction' and COLUMN_NAME='is_dsc_amt')
		begin 
			ALTER TABLE dbo.Glsction ADD  is_dsc_amt  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Glsction' and COLUMN_NAME='auto_dsc_hll')
		begin 
			ALTER TABLE dbo.Glsction ADD  auto_dsc_hll  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Glsction' and COLUMN_NAME='max_dsc_hll')
		begin 
			ALTER TABLE dbo.Glsction ADD  max_dsc_hll  numeric(3,2) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end

--------------------- POS_MNY
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'POS_MNY' and COLUMN_NAME='fiveh')
		begin 
			ALTER TABLE dbo.POS_MNY ADD  fiveh  numeric(8,0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'POS_MNY' and COLUMN_NAME='tenh')
		begin 
			ALTER TABLE dbo.POS_MNY ADD  tenh  numeric(8,0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'POS_MNY' and COLUMN_NAME='twntyfiveh')
		begin 
			ALTER TABLE dbo.POS_MNY ADD  twntyfiveh  numeric(8,0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'POS_MNY' and COLUMN_NAME='fiftyh')
		begin 
			ALTER TABLE dbo.POS_MNY ADD  fiftyh  numeric(8,0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
--------   Pos_hd table --------------------
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Pos_hd' and COLUMN_NAME='discamt')
		begin 
			ALTER TABLE dbo.Pos_hd ADD  discamt  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Pos_hd' and COLUMN_NAME='no_round_nm')
		begin 
			ALTER TABLE dbo.Pos_hd ADD  no_round_nm  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Pos_hd' and COLUMN_NAME='PriceVatType')
		begin 
			ALTER TABLE dbo.Pos_hd ADD  PriceVatType  numeric(1,0) NULL default 1  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end

--------   Pos_hdti table --------------------
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Pos_hdti' and COLUMN_NAME='discamt')
		begin 
			ALTER TABLE dbo.Pos_hdti ADD  discamt  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Pos_hdti' and COLUMN_NAME='no_round_nm')
		begin 
			ALTER TABLE dbo.Pos_hdti ADD  no_round_nm  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Pos_hdti' and COLUMN_NAME='PriceVatType')
		begin 
			ALTER TABLE dbo.Pos_hdti ADD  PriceVatType  numeric(1,0) NULL default 1  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
--------   Pos_dt 
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Pos_dt' and COLUMN_NAME='taxtype')
		begin 
			ALTER TABLE dbo.Pos_dt ADD  taxtype  char(1) NULL default '1'  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
--------   Pos_dtti 
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Pos_dtti' and COLUMN_NAME='taxtype')
		begin 
			ALTER TABLE dbo.Pos_dtti ADD  taxtype  char(1) NULL default '1'  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
-----------------------------------------------------------------------------------


		return @errstatus
end














GO
/****** Object:  StoredProcedure [dbo].[ap_uncomplete]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-08-03@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[ap_uncomplete]
 @m_cmp char(2),
 @m_type char(2),
 @m_ref  int, 
 @pstmode bit,
 @lsrc char(2),
 @caokmustfc bit,
 @errcode char(4) output
 
	
AS
BEGIN
    -----2024-08-02 AA Added new code and @lsrc<>'33' for fixed assets trx
    -----2024-05-13 AA Added new codes to handle the new column unincld_vndr_expns in puhdr requested by Al-Qarat
    -----2023-12-15 AA Added new code to fit zatca rounding requirement 
    -----2023-11-30 AA fixed the bug when client local , price include vat and there is expenses 
    -----2023-05-14 KAN Added Fixed Asset Codes
    ---- 2022-05-14 AA i have added if @m_type='01' and dbo.value_balanced(@lhd_lccnet,@lhd_lcnet)=0 
    ---- 2022-05-09 AA i have made the @m_ref parameter to be int instead of numeric(6,0)
    ---- 2022-05-09 AA Added dbo.value_balanced(@lhd_lccnet,@lhd_lcnet)=0 
    ---- 2022-05-09 AA Added dbo.value_balanced(@lhd_ltotal,@lhd_lcnet)=0
    ---- 2022-05-09 AA Added semi colon to the end of select statement
    ---- Added on 2022-05-09 AA dbo.value_balanced(@lc_db,@lc_cr)=0
	---- Added on 2022-05-09 AA dbo.value_balanced(@fc_db,@fc_cr)=0
	SET NOCOUNT ON
	declare @ljhamt float=0,
	@lptr int =0,
	@no_entries int=0,
	@lhd_lccnet float,
	@lhd_lcnet float,
	@lhd_ltotal float,
	@lhd_ftotal float,
	@posted bit,
	@src char(2),
	@lhd_fcy char(3)
	set @errcode='';

 	select @posted=hd_posted,@lhd_fcy=isnull(hd_fcy,''),@lhd_lcnet=hd_lcnet,@lhd_lccnet=hd_lccnet,
	@lhd_ftotal=hd_ftotal,
	@lhd_ltotal=hd_ltotal,@src=hd_trxsrc from aphdr with (NOLOCK) where hd_COMPANY=@m_cmp AND hd_TYPE=@m_type AND hd_REF=@m_ref;
    set @lptr=@@rowcount

	declare 
		@llinvttl float,
		@lfinvttl float,
		@llcamt float=0,
		@lfcamt float=0,
		@l_expns_vat numeric(20,7)=0,  --Added  K.A.N Jan 27,2022
		@lunincld_vndr_expns float =0 -- Added on 2024-05-13 AA


	if @lsrc<>'06'
	begin
			if @lptr=0
			begin
				set @errcode='122'
				return
			end
			set @lptr=0
			if @pstmode=1 
			begin
				if  @posted=0
				begin
	  			  set @errcode='136'
				  return
				end
			end
			else 
			if  @posted=1
			begin 
				set @errcode='212'
				return
			end
			if @lsrc='07'
			begin
				set @llcamt=Iif(len(@lhd_fcy)=0,@lhd_ltotal,@lhd_ftotal)
--------------- Added on 2023-12-15 AA -------------------------------------------------------------------------------------------------------------------------
				if COL_LENGTH('dbo.puhdr','zatca_rounding') is not null
				begin 
					select @llinvttl=invttl+iif(vatnot4vender=0 and (isnull(priceincludevat,0)=0 or zatca_rounding=1),vat_amt_paid,0)-isnull(hlldscnt,cast(0 as float)), 
						   @l_expns_vat=iIf(puhdr.vatnot4vender=0 And puhdr.expns4vat<>0 And puhdr.vat_amt_paid<>0,
						   iif(puhdr.PriceIncludeVat=0,iif(@lhd_fcy<>'' and fcyrate>0,expns4vat*fcyrate,expns4vat)*vat_percent/100,round(iif(zatca_rounding=1,
						   iif(@lhd_fcy<>'' and fcyrate>0,expns4vat*fcyrate,expns4vat)*vat_percent/(100+vat_percent),0),2)),0),
						   @lunincld_vndr_expns=isnull(unincld_vndr_expns,0)  -- Added on 2024-05-13 AA
					from puhdr with (NOLOCK) where COMPANY=@m_cmp AND INVTYPE=@m_type AND REF=@m_ref;
				end
				else
				begin
---------------------------------------------------------------------------------------------------------------------------------------------------
					select @llinvttl=invttl+iif(vatnot4vender=0 and isnull(priceincludevat,0)=0,vat_amt_paid,0)-isnull(hlldscnt,cast(0 as float)), --K.A.N APRIL 16,2018 ADDED : -isnull(hlldscnt, cast(0 as float))			
						   @l_expns_vat=iIf(puhdr.vatnot4vender=0 And puhdr.expns4vat<>0 And puhdr.vat_amt_paid<>0,
						   iif(puhdr.PriceIncludeVat=0,iif(@lhd_fcy<>'' and fcyrate>0,expns4vat*fcyrate,expns4vat)*vat_percent/100,0),0), -- Added on 2023-11-29 AA
						    @lunincld_vndr_expns=isnull(unincld_vndr_expns,0) -- Added on 2024-05-13 AA
					from puhdr with (NOLOCK) where COMPANY=@m_cmp AND INVTYPE=@m_type AND REF=@m_ref;
				end
----------------------- Stopped on 2023-11-29 AA bug 
				    --   @l_expns_vat=iIf(puhdr.vatnot4vender=0 And puhdr.expns4vat<>0 And puhdr.vat_amt_paid<>0,
					   --   iif(puhdr.PriceIncludeVat=0,iif(@lhd_fcy<>'' and fcyrate>0,expns4vat*fcyrate,expns4vat)*vat_percent/100
						  --,iif(@lhd_fcy<>'' and fcyrate>0,expns4vat*fcyrate,expns4vat)*vat_percent/(100+vat_percent))
					   --    ,0)
				
				if @@rowcount=0
				begin
					set @errcode='122'
					return
				end
				--if dbo.value_balanced(@llinvttl,@llcamt)=0 K.A.N Jan 27,2022  To Substract vat Of Expenses From Supplier Net So It Will MAtch, We Are not Adding expenses tax On Supplier When Saving Invoice
				--if dbo.value_balanced(@llinvttl-@l_expns_vat,@llcamt)=0 -- Stopped on 2024-05-13 AA
				if dbo.value_balanced(@llinvttl-@l_expns_vat+@lunincld_vndr_expns,@llcamt)=0  -- Added on 2024-05-13 AA
				begin
					set @errcode='216'
					return
				end
			end
			if @lsrc='10'
			begin
			   select ref from bktransx with (NOLOCK) where company=@m_cmp and trtype=@m_type and ref= @m_ref;
				if @@rowcount=0
				begin
					set @errcode='122'
					return
				end
			end
		if @lsrc='23'
		begin
			set @llcamt=@lhd_ltotal
			set @lfcamt=@lhd_ftotal
			select @llinvttl=hd_ltotal,@lfinvttl=hd_ftotal				
			from sdhdr with (NOLOCK) where hd_COMPANY=@m_cmp AND hd_TYPE=@m_type AND hd_REF=@m_ref;
			if @@rowcount=0
			begin
				set @errcode='122'
				return
			end
			if dbo.value_balanced(@llinvttl,@llcamt)=0 --or dbo.value_balanced(@lfinvttl,@lfcamt)=0
			begin
				set @errcode='216'
				return
			end
		end
		-- 2023-05-11 KAN Added Fixed Asset Codes Wich Abo Mohammed Always Overwrites It. LOL
		If @lsrc='33'  --Fixed Assets 
		begin
			    set @llcamt=@lhd_ltotal
			    set @lfcamt=@lhd_ftotal
   			    select @llinvttl=case when fh_fatype='3' then fh_ltotal+fh_ftoteqc+fh_dtlocal+fh_dtfceqc
			                          when fh_fatype='4' then fh_ltotal
			                          when fh_fatype='2' then case when fh_ltotal>fh_dtlocal then fh_ltotal else fh_dtlocal end 
	                                                         +case when fh_ftoteqc>fh_dtfceqc then fh_ftoteqc else fh_dtfceqc end			                                               
														     - hlldscnt + iif(isnull(PriceVatType,1)=1,vat_amt,0)
								      when fh_fatype='1' then fh_ltotal+fh_ftoteqc - hlldscnt + iif(isnull(priceincludevat,0)=0,vat_amt,0)
								      else fh_ltotal+fh_ftoteqc  end														  
			    from fahdr with (NOLOCK) where fh_company=@m_cmp AND fh_type=@m_type AND fh_ref=@m_ref;  
		    	if @@rowcount=0
    			begin
				    set @errcode='122'
				    return
			    end
			    if dbo.value_balanced(@llinvttl,@llcamt)=0 --or dbo.value_balanced(@lfinvttl,@lfcamt)=0
			    begin
				    set @errcode='216'
				    return
			    end
		end
		--end : -- 2023-05-11 KAN Added Fixed Asset Codes Wich Abo Mohammed Always Overwrites It. LOL
	end
    if  @src<>@lsrc
	begin
		set @errcode='124'
		return
	end	
--    If @lhd_ltotal<>@lhd_lcnet -- stopped on 2022-05-09 AA
    if dbo.value_balanced(@lhd_ltotal,@lhd_lcnet)=0  -- Added on 2022-05-09 AA
	begin
		set @errcode='123'
		return
	end	
--	if @m_type='01' and @lhd_lccnet<>@lhd_lcnet -- stopped on 2022-05-09 AA
--    if dbo.value_balanced(@lhd_lccnet,@lhd_lcnet)=0  -- Stopped on 2022-05-14  
    if @m_type='01' and dbo.value_balanced(@lhd_lccnet,@lhd_lcnet)=0 -- Added on 2022-05-14 AA
	begin
		set @errcode='123'
		return
	end	


	declare @lc_db float,@lc_cr float,@fc_db float,@fc_cr float
    select @lptr=sum(1), @lc_db=sum(iif(dt_dbcr='D',dt_lcamt,0)),@fc_db=sum(iif(dt_dbcr='D',dt_fcamt,0)),
       @lc_cr=sum(iif(dt_dbcr='C',dt_lcamt,0)),@fc_cr=sum(iif(dt_dbcr='C',dt_fcamt,0)) from apdtl where 
	   dt_COMPANY=@m_cmp AND dt_TYPE=@m_type AND dt_REF=@m_ref;
	if @@rowcount=0
	begin
		set @errcode='122'
		return
	end
	if @m_type='01' and dbo.value_balanced(@lc_db,@lc_cr)=0 and @lsrc<>'33' -- Added on 2024-08-02 AA and @lsrc<>'33'  -- stopped on 2022-05-09 and @lc_db<>@lc_cr
	begin
		set @errcode='138'
		return
	end	

	if dbo.value_balanced(@lhd_ltotal,Iif(@lc_db<>0,@lc_db,@lc_cr))=0
	begin
		set @errcode='137'
		return
	end	

	if @caokmustfc=1
	begin 
		if  @m_type='01' and dbo.value_balanced(@fc_db,@fc_cr)=0 -- stopped on 2022-05-09 and @fc_db<>@fc_cr
		begin
			set @errcode='139'
			return
		end
		if dbo.value_balanced(@lhd_ftotal,Iif(@fc_db<>0,@fc_db,@fc_cr))=0
		begin
			set @errcode='137'
			return
		end	
	end

end


GO
/****** Object:  StoredProcedure [dbo].[Api_AddNewCustomer]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_AddNewCustomer]
	@cu_name varchar(60) , @cu_company char(2) , @cu_class char(2) , @section char(2), @cu_addrs varchar(50) , @cu_tel varchar(30) , @cu_cntactp varchar(50) , 
	@clnt_taxcode varchar(20) , @cu_crlmt numeric(14, 2) , @cu_onlycsh bit , @cu_alwcr bit , @cu_mobile varchar(50) , @cu_kind char(1)='' , @individual_clnt bit , @location varchar(100) , @username varchar(50) =''
AS
BEGIN
	
	SET NOCOUNT ON;

	declare @cu_code int;
	declare @SctnHasSerial bit;
	declare @comp char(2);
	declare @yrcode char(4);
	declare @dbc char(8);
	declare @slcode char(2);

	set @dbc=db_name()
	set @comp=substring(@dbc,4,2)

	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>40,'14','20')+rtrim(@yrcode)

	set @slcode = (select top 1 slcode from salesmen with(nolock) where slcompany = @cu_company and usrid = @username);
	select @SctnHasSerial=isnull(SctnHasSerial,0) from sysdb.dbo.glcalend with (nolock) where calcomp=@comp and yrcode=@yrcode
	
	 if (@SctnHasSerial = 1)
		begin
			set @cu_code = (select max(cast(cu_code as int)) + 1 from customer with(nolock) where section = @section);
		end
		else
		begin
			set @cu_code = (select max(cast(cu_code as int)) + 1 from customer with(nolock));
		end

    INSERT INTO [dbo].[customer]
           ([cu_name],[cu_company],[cu_code],[cu_class],[cu_addrs],[cu_tel],[cu_fax],[cu_tlx],[cu_email],[cu_cntactp],[cu_title],[cu_crlmt],[cu_pymnt],[cu_status],[cu_opnbal],[cu_curbal],[cf_fcy],[cf_opnfcy]
           ,[cf_curfcy],[cu_xrf],[cu_alwcr],[cu_ctlser],[lastupdt],[cu_lcaloc],[cu_fcaloc],[cu_instlmnt],[cu_instldays],[cu_install],[modified],[cmncode],[cu_lname],[cu_city],[cu_type],[cu_laddrs],[cu_carrier]
           ,[cu_mobile],[section],[cu_sendsms],[cu_onlycsh],[clnt_taxcode],[taxFree],[cu_kind],[exduplimit],[individual_clnt],[location],[slcode])
     VALUES
           (@cu_name,@cu_company,@cu_code,@cu_class,@cu_addrs,@cu_tel,'','','',@cu_cntactp,'',@cu_crlmt,0,1,0,0,'',0,0,'',@cu_alwcr,'', '',0,0,0, 0,0,0,'','','','','','', @cu_mobile,@section,0,@cu_onlycsh,@clnt_taxcode,0,iif(@cu_kind='',1,@cu_kind),0,@individual_clnt,@location,@slcode)

		 merge customer_ei as t

		 using

		(select cu_company,cu_code,cf_fcy from customer ) as s

		on t.cu_company=s.cu_company and t.cu_code=s.cu_code and t.cf_fcy=s.cf_fcy

		when not matched then

		insert (cu_company,cu_code,cf_fcy)

		values (s.cu_company,s.cu_code,s.cf_fcy);

		select @cu_code ;
END









GO
/****** Object:  StoredProcedure [dbo].[Api_AddNewPosDsc]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_AddNewPosDsc]

	@fullname varchar(50) , @adrs varchar(30) , @mobile varchar(21) , @gender bit , @birthday varchar(10) , @email varchar(50) , @pass varchar(10)
AS
BEGIN
	
	SET NOCOUNT ON;

	declare @dsccard varchar(20);
	declare @rtn int = 0;
	set @dsccard = iif((select Max(cast(dsccard as float)) + 1 from pos_dsc) is null ,1,(select Max(cast(dsccard as float)) + 1 from pos_dsc));
	if (select count(*) from pos_dsc where dsctel = @mobile) > 0
	set @rtn = -1;
	if @rtn = 0
	begin
	INSERT INTO [dbo].[pos_dsc]
           ([dsccompany],[dsccard],[dscname],[dscaddress],[dsctel],[dscprtg],[dscstatus],[dscnote],[modified],[mnth_target],[mnthbal],[trgt_prcnt],[prepaidamt]
           ,[cardtype],[cardused],[expdate],[chrcode],[cstpassw],[crtdate],[crtyear],[cust_ttlsales],[sales_grantd],[ttl_grantd],[vchr_value],[vchr_used]
           ,[mothercard],[lastpaycard],[nqati_openbal],[nodsc4promo],[employees_only],[no_payment],[smsvrfycode],[gender],[birthday],[email],[pass])
     VALUES
           ('01',@dsccard,@fullname,@adrs,@mobile,0,1,'App',1,500,0,30,0,1,0,'20211231','','',CAST(DATEPART(YEAR,GETDATE()) as char(4)) + CAST(DATEPART(MONTH,GETDATE()) as char(2)) + CAST(DATEPART(DAY,GETDATE()) as char(2)),
		   CAST(DATEPART(YEAR,GETDATE()) as char(4)),0,0,0,0,0,'','',0,0,0,0,0,@gender,@birthday,@email,@pass)
		    select @dsccard;
	end
	else
	begin
			select @rtn;
	end
END






GO
/****** Object:  StoredProcedure [dbo].[Api_ApClass]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_ApClass]
	@comp char(2) , @Language smallint = 1 
AS
BEGIN
	
	SET NOCOUNT ON;

    Select cl_code , ltrim(rtrim(iif(@Language <> 1 and cl_ldesc <> '' , cl_ldesc, cl_desc))) cl_desc 
	from apclass with (nolock) where cl_company = @comp 
END















GO
/****** Object:  StoredProcedure [dbo].[Api_ApStatement_Of_Account]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Api_ApStatement_Of_Account]
(
@m_Branch_code char(2),@m_supp_code char(6),@fdate char(8) ,@tdate char(8),@fcy as char(3) =''
)
AS BEGIN
		declare @open_bal float =0,
		 @fcopen_bal float =0,
		 @prd_openbal numeric(8,2)
		--@fcy char(3)=@prd_openbal -- can by used as input parameter for FCY and out put parameter as open period balace

		(select @open_bal=(cu_opnbal+sum(isnull(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt)),0))),
		@fcopen_bal=(cf_opnfcy+sum(isnull(iif(dt_dbcr='D',dt_fcamt-dt_fdscamt,-(dt_fcamt-dt_fdscamt)),0)))  
		from supplier with (nolock) Left Outer Join apdtl with (nolock) inner Join aphdr with (nolock)
		on  apdtl.dt_company=aphdr.hd_company and apdtl.dt_type=aphdr.hd_type and apdtl.dt_ref=aphdr.hd_ref
		and hd_date<@fdate
		on cu_company=dt_company and cu_code=dt_cucode and cf_fcy=dt_fcy
		where   cu_company=@m_branch_code and cu_code=@m_supp_code and cf_fcy=@fcy
		group by cu_company,cu_code,cf_fcy,cu_opnbal,cf_opnfcy)

		if len(rtrim(@fcy))>0
		begin
			set @prd_openbal= ROUND(@fcopen_bal,2,1)
			;
			with cte_openbal (cu_company ,cu_code ,cu_name,cf_fcy ,cu_openbal )
			as                                                  
			(select cu_company,cu_code,cu_name,cf_fcy,cf_opnfcy+sum(isnull(iif(dt_dbcr='D',dt_fcamt-dt_discamt,-(dt_fcamt-dt_fdscamt)),0)) as cu_openbal
			from supplier with (nolock) Left Outer Join apdtl with (nolock) inner Join aphdr with (nolock)
			on  apdtl.dt_company=aphdr.hd_company and apdtl.dt_type=aphdr.hd_type and apdtl.dt_ref=aphdr.hd_ref
			and hd_date<@fdate
			on cu_company=dt_company and cu_code=dt_cucode and cf_fcy=dt_fcy
			where   cu_company=@m_branch_code and cu_code=@m_supp_code and cf_fcy=@fcy
			group by cu_company,cu_code,cu_name,cf_fcy,cf_opnfcy)

			select dt_type ,dt_ref ,substring(dt_date,1,4)+'-'+substring(dt_date,5,2)+'-'+substring(dt_date,7,2) as dt_date  ,
			iif(dt_dbcr='D',dt_fcamt-dt_fdscamt,0) as dbtamt,iif(dt_dbcr='C',dt_fcamt-dt_fdscamt,0) as crtamt ,ltrim(rtrim(dt_desc)) ,
			ROUND(cu_openbal+sum(iif(dt_dbcr='D',dt_fcamt-dt_fdscamt,-(dt_fcamt-dt_fdscamt))) over (order by dt_date,dt_type,dt_ref,dt_folio),2,1) as cur_bal,@prd_openbal as prd_openbalance
			from cte_openbal a with (nolock) inner join apdtl b with (nolock) on a.cu_company=b.dt_company and a.cu_code=b.dt_cucode and a.cf_fcy=b.dt_fcy
			where  dt_date between @fdate and @tdate
		end
		else
		begin
			set @prd_openbal=ROUND(@open_bal,2,1)
			;
			with cte_openbal (cu_company ,cu_code ,cu_name,cf_fcy ,cu_openbal )
			as
			(select cu_company,cu_code,cu_name,cf_fcy,cu_opnbal+sum(isnull(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt)),0)) as cu_openbal
			from supplier with (nolock) Left Outer Join apdtl with (nolock) inner Join aphdr with (nolock)
			on  apdtl.dt_company=aphdr.hd_company and apdtl.dt_type=aphdr.hd_type and apdtl.dt_ref=aphdr.hd_ref
			and hd_date<@fdate
			on cu_company=dt_company and cu_code=dt_cucode and cf_fcy=dt_fcy
			where   cu_company=@m_branch_code and cu_code=@m_supp_code and cf_fcy=@fcy
			group by cu_company,cu_code,cu_name,cf_fcy,cu_opnbal)

			select dt_type ,dt_ref ,substring(dt_date,1,4)+'-'+substring(dt_date,5,2)+'-'+substring(dt_date,7,2) as dt_date  ,
			iif(dt_dbcr='D',dt_lcamt-dt_discamt,0) as dbtamt,iif(dt_dbcr='C',dt_lcamt-dt_discamt,0) as crtamt ,dt_desc ,
			ROUND(cu_openbal+sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-dt_lcamt+dt_discamt)) over (order by dt_date,dt_type,dt_ref,dt_folio),2,1) as cur_bal,@prd_openbal as prd_openbalance
			from cte_openbal a with (nolock) inner join apdtl b with (nolock) on a.cu_company=b.dt_company and a.cu_code=b.dt_cucode and a.cf_fcy=b.dt_fcy
			where  dt_date between @fdate and @tdate
		end

END



GO
/****** Object:  StoredProcedure [dbo].[Api_ArStatement_Of_Account]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_ArStatement_Of_Account] 
(
@m_Branch_code char(2),@m_supp_code char(6),@fdate char(8) ,@tdate char(8),@prd_openbal as float  = 0 , @onlyCurbal as bit = 0
)
AS BEGIN
		declare @open_bal float =0

		if @onlyCurbal = 0 
		BEGIN
		--@fcy char(3)=@prd_openbal -- can by used as input parameter for FCY and out put parameter as open period balace

		(select @open_bal=(cu_opnbal+sum(isnull(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt)),0))) 
		from customer with (nolock) Left Outer Join ardtl with (nolock) inner Join arhdr with (nolock)
		on  ardtl.dt_company=arhdr.hd_company and ardtl.dt_type=arhdr.hd_type and ardtl.dt_ref=arhdr.hd_ref
		and hd_date<@fdate
		on cu_company=dt_company and cu_code=dt_cucode and cf_fcy=dt_fcy
		where   cu_company=@m_branch_code and cu_code=@m_supp_code
		group by cu_company,cu_code,cu_name,cu_opnbal)

		set @prd_openbal=@open_bal
		;
		with cte_openbal (cu_company ,cu_code ,cu_name ,cu_openbal )
		as
		(select cu_company,cu_code,cu_name,cu_opnbal+sum(isnull(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt)),0)) as cu_openbal
		from customer with (nolock) Left Outer Join ardtl with (nolock) inner Join arhdr with (nolock)
		on  ardtl.dt_company=arhdr.hd_company and ardtl.dt_type=arhdr.hd_type and ardtl.dt_ref=arhdr.hd_ref
		and hd_date<@fdate
		on cu_company=dt_company and cu_code=dt_cucode and cf_fcy=dt_fcy
		where   cu_company=@m_branch_code and cu_code=@m_supp_code
		group by cu_company,cu_code,cu_name,cu_opnbal)
		
		select dt_type ,dt_ref ,substring(dt_date,1,4)+'-'+substring(dt_date,5,2)+'-'+substring(dt_date,7,2) as dt_date  ,
		round(iif(dt_dbcr='D',dt_lcamt-dt_discamt,0),2,2) as dbtamt,round(iif(dt_dbcr='C',-(dt_lcamt-dt_discamt),0),2,2) as crtamt ,ltrim(rtrim(dt_desc)) dt_desc ,
		Round(cu_openbal+sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))) over (order by dt_date,dt_type,dt_ref,dt_folio),2,2) as cur_bal,
		@prd_openbal as prd_openbalance
		from cte_openbal a with (nolock) inner join ardtl b with (nolock) on a.cu_company=b.dt_company and a.cu_code=b.dt_cucode 
		where  dt_date between @fdate and @tdate

		END

		ELSE

		BEGIN
		
		(select @open_bal=(cu_opnbal+sum(isnull(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt)),0))) 
		from customer with (nolock) Left Outer Join ardtl with (nolock) inner Join arhdr with (nolock)
		on  ardtl.dt_company=arhdr.hd_company and ardtl.dt_type=arhdr.hd_type and ardtl.dt_ref=arhdr.hd_ref
		and hd_date<@fdate
		on cu_company=dt_company and cu_code=dt_cucode and cf_fcy=dt_fcy
		where   cu_company=@m_branch_code and cu_code=@m_supp_code
		group by cu_company,cu_code,cu_name,cu_opnbal)

		set @prd_openbal=@open_bal
		;
		with cte_openbal (cu_company ,cu_code ,cu_name ,cu_openbal )
		as
		(select cu_company,cu_code,cu_name,cu_opnbal+sum(isnull(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt)),0)) as cu_openbal
		from customer with (nolock) Left Outer Join ardtl with (nolock) inner Join arhdr with (nolock)
		on  ardtl.dt_company=arhdr.hd_company and ardtl.dt_type=arhdr.hd_type and ardtl.dt_ref=arhdr.hd_ref
		and hd_date<@fdate
		on cu_company=dt_company and cu_code=dt_cucode and cf_fcy=dt_fcy
		where   cu_company=@m_branch_code and cu_code=@m_supp_code
		group by cu_company,cu_code,cu_name,cu_opnbal)
		
		select Round(cu_openbal+sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))) over (order by dt_date,dt_type,dt_ref,dt_folio),2,2) as cur_bal 
		from cte_openbal a with (nolock) inner join ardtl b with (nolock) on a.cu_company=b.dt_company and a.cu_code=b.dt_cucode 
		where  dt_date between @fdate and @tdate

		END
END












GO
/****** Object:  StoredProcedure [dbo].[Api_ArStatement_Of_AllCustomer]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Api_ArStatement_Of_AllCustomer]

AS BEGIN

	DECLARE  @cuCode VARCHAR(6);
	DECLARE  @cuName VARCHAR(60);
	DECLARE  @cuBal numeric(14,2);
	CREATE TABLE #tbl_cus 
	(
		 cuNo VARCHAR(6),
         cuName VARCHAR(60),
		 cuBal numeric(14,2)
	)

	DECLARE cursor_customer CURSOR
	FOR SELECT 
        cu_code,cu_name
    FROM 
        customer;

OPEN cursor_customer;

FETCH NEXT FROM cursor_customer INTO 
    @cuCode, 
    @cuName;

WHILE @@FETCH_STATUS = 0
    BEGIN
        Exec @cuBal = Api_ArStatement_Of_Account '01', @cuCode ,'14400101','14411230',0 , 1
		insert into #tbl_cus select @cuCode , @cuName , @cuBal
        FETCH NEXT FROM cursor_customer INTO 
            @cuCode, 
            @cuName;
    END;
	CLOSE cursor_customer;    
    DEALLOCATE cursor_customer; 

	select * from #tbl_cus;
END













GO
/****** Object:  StoredProcedure [dbo].[Api_Classfil]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_Classfil]
	@comp char(2) , @Language smallint = 1 
AS
BEGIN
	
	SET NOCOUNT ON;

    Select cl_code , ltrim(rtrim(iif(@Language <> 1 and cl_ldesc <> '' , cl_ldesc, cl_desc))) cl_desc 
	from classfil with (nolock) where cl_company = @comp 
END












GO
/****** Object:  StoredProcedure [dbo].[Api_Customer_Movement_Summary]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Api_Customer_Movement_Summary]
(
@m_Branch_code char(2)='',@m_supp_code char(6)='',@fdate char(8) ,@tdate char(8),
@fcy as varchar(3)='',@vclass char(12)='',@usr_showcost bit = 1 , @Language smallint = 1 
 )
AS BEGIN
		declare @showcost as int=0
		set @showcost=iif(@usr_showcost=1,1,0) 		
		; with cte_clientOpenbal
		as
		(select cu_company,ltrim(rtrim(cu_code)) cu_code,ltrim(rtrim(iif(@Language <> 1 and cu_lname <> '' , cu_lname, cu_name))) cu_name,
		cu_opnbal,sum(isnull(iif(dt_dbcr='D',(dt_lcamt-dt_paidamt-dt_discamt),
		-(dt_lcamt-dt_paidamt-dt_discamt)),0)) as opntrxbal from customer a with (nolock) left outer join ardtl b with (nolock)
		on a.cu_company=b.dt_company and a.cu_code=b.dt_cucode and dt_cucode<>'' and dt_date<@fdate
		where (cu_company=@m_Branch_code Or @m_Branch_code = '') And (cu_code = @m_supp_code Or @m_supp_code = '')
		group by cu_company,cu_code,cu_name,cu_lname,cu_opnbal 
		)
		,cte_client_trx
		as
		(select dt_company,dt_cucode,sum(isnull(iif(dt_trxsrc<>'05',iif(dt_dbcr='C',(dt_lcamt-dt_paidamt-dt_discamt),
		0),0),0.00)) as rcvdbal,
		sum(isnull(iif(dt_trxsrc<>'05',iif(dt_dbcr='D',(dt_lcamt-dt_paidamt-dt_discamt),
		0),0),0.00)) as dbtbal,
		 sum(isnull(iif(dt_trxsrc='05',iif(dt_dbcr='D',(dt_lcamt-dt_paidamt-dt_discamt),
		-(dt_lcamt-dt_paidamt-dt_discamt)),0),0.00)) as slnet
		from ardtl a with (nolock) inner join cte_clientOpenbal b with (nolock) on a.dt_company=b.cu_company and a.dt_cucode=b.cu_code
		where (dt_company=@m_Branch_code Or @m_Branch_code = '') And (cu_code = @m_supp_code Or @m_supp_code = '') and dt_date between @fdate and @tdate
		group by dt_company,dt_cucode
		)
		,cte_slprofit
		as
		(select company,custno,slprofit=sum(iif(invtype='04',(valafds-invdsvl-invcst),-(valafds-invdsvl-invcst)))
		from sales_hd a with (nolock) inner join cte_clientOpenbal b with (nolock)
		on a.company=b.cu_company and a.custno=b.cu_code
		where (company=@m_Branch_code Or @m_Branch_code = '') and invtype in ('04','24') and invdate between @fdate and @tdate
		group by company,custno
		)
		select cu_code ,cu_name ,cu_opnbal+isnull(opntrxbal,0) as openbal,
		slnet ,rcvdbal ,dbtbal as adjustment,round(slprofit,2)*@showcost as slprofit,
		cu_opnbal+isnull(opntrxbal,0)+slnet+dbtbal-rcvdbal cur_bal
		from cte_clientOpenbal a with (nolock) left outer join cte_client_trx b with (nolock)
		on a.cu_company=b.dt_company and a.cu_code=b.dt_cucode
		left outer join cte_slprofit c on a.cu_company=c.company and a.cu_code=c.custno
		order by cast(cu_code as int)

END















GO
/****** Object:  StoredProcedure [dbo].[Api_CustomersBalances]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

---- This variable @m_Branch_code must be retrevied at the login screen level from the branch field
CREATE PROCEDURE [dbo].[Api_CustomersBalances]
(@m_Branch_code char(2)='' ,@m_classcode char(2)=''  ,@Language smallint = 1)
As 
Begin

	select ltrim(rtrim(cu_code)) cu_code ,iif(@language <> 1 And cu_lname <> '',cu_lname,cu_name)cu_name ,cu_mobile ,cu_tel ,cu_opnbal+
	 isnull(sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))),0) as cur_bal
	from customer a with (nolock) left outer join ardtl b with (nolock)
	on a.cu_company=b.dt_company and a.cu_code=b.dt_cucode and a.cf_fcy=b.dt_fcy
	 and dt_cucode<>''
	 where (cu_company=@m_Branch_code Or @m_Branch_code ='') and (cu_class = @m_classcode Or @m_classcode ='')
	group by cu_company,cu_code,cf_fcy,cu_name,cu_lname,cu_mobile,cu_tel,cu_opnbal
	having cu_opnbal+isnull(sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))),0)<>0
	order by cast(cu_code as bigint)
End 











GO
/****** Object:  StoredProcedure [dbo].[Api_CustomersBalancesForSaler]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

---- This variable @m_Branch_code must be retrevied at the login screen level from the branch field
CREATE PROCEDURE [dbo].[Api_CustomersBalancesForSaler]
(@m_Branch_code char(2)='' ,@m_classcode char(2)='', @salecntr char(2) ='' ,@Language smallint = 1)
As 
Begin

declare @dbc varchar(8);
	declare @calcomp varchar(2);
	declare @yrcode varchar(4);
	declare @sction_customr bit;
	declare @sction varchar(4);

	set @dbc=db_name();
	set @calcomp=substring(@dbc,4,2);
	set @yrcode=substring(@dbc,7,2);
	set @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode);

	select @sction_customr=sction_customr from sysdb.dbo.glcalend with(nolock) where calcomp=@calcomp and yrcode=@yrcode;

	if(@sction_customr = 1)
	begin
	select @sction= isnull(s1.sc_code,'') from salecntr s1 with(nolock) inner join glsction s2 with(nolock) 
		on s1.dp_brno = s2.sc_company and s1.dp_dept = s2.sc_whno and s1.sc_code = s2.sc_code 
		where dp_brno = @m_Branch_code and dp_dept = @salecntr ;
	select ltrim(rtrim(cu_code)) cu_code ,iif(@language <> 1 And cu_lname <> '',cu_lname,cu_name)cu_name ,cu_mobile ,cu_tel ,cu_opnbal+
	 isnull(sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))),0) as cur_bal
	from customer a with (nolock) left outer join ardtl b with (nolock)
	on a.cu_company=b.dt_company and a.cu_code=b.dt_cucode and a.cf_fcy=b.dt_fcy and dt_cucode<>''
	 where (cu_company=@m_Branch_code Or @m_Branch_code ='') and (cu_class = @m_classcode Or @m_classcode ='') and section = @sction
	group by cu_company,cu_code,cf_fcy,cu_name,cu_lname,cu_mobile,cu_tel,cu_opnbal
	having cu_opnbal+isnull(sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))),0)<>0
	order by cast(cu_code as bigint)
	end
	--else
	--begin
	/*
	select ltrim(rtrim(cu_code)) cu_code ,iif(@language <> 1 And cu_lname <> '',cu_lname,cu_name)cu_name ,cu_mobile ,cu_tel ,cu_opnbal+
	 isnull(sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))),0) as cur_bal
	from customer a with (nolock) left outer join ardtl b with (nolock)
	on a.cu_company=b.dt_company and a.cu_code=b.dt_cucode and a.cf_fcy=b.dt_fcy and dt_cucode<>''
	 where (cu_company=@m_Branch_code Or @m_Branch_code ='') and (cu_class = @m_classcode Or @m_classcode ='')
	group by cu_company,cu_code,cf_fcy,cu_name,cu_lname,cu_mobile,cu_tel,cu_opnbal
	having cu_opnbal+isnull(sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))),0)<>0
	order by cast(cu_code as bigint)
	*/
	--end
End 











GO
/****** Object:  StoredProcedure [dbo].[Api_CustomersBalancesWithContact]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

---- This variable @m_Branch_code must be retrevied at the login screen level from the branch field
CREATE PROCEDURE [dbo].[Api_CustomersBalancesWithContact]
(@m_Branch_code char(2)='' , @cu_no varchar(6) = '' , @fdate varchar(10) , @tdate varchar(10), @type char(1) = '0' ,@Language smallint = 1)
As 
Begin
if @type = '0'
begin
with cte_tbl(cu_code,cu_name,cur_bal)
as
	(
	select ltrim(rtrim(cu_code)) cu_code ,iif(@language <> 1 And cu_lname <> '',cu_lname,cu_name)cu_name ,cu_opnbal+
	 isnull(sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))),0) as cur_bal
	from customer a with (nolock) left outer join ardtl b with (nolock)
	on a.cu_company=b.dt_company and a.cu_code=b.dt_cucode and a.cf_fcy=b.dt_fcy
	 and dt_cucode<>''
	where (cu_company=@m_Branch_code Or @m_Branch_code ='') and (cu_code = @cu_no or @cu_no = '')
	group by cu_company,cu_code,cf_fcy,cu_name,cu_lname,cu_mobile,cu_tel,cu_opnbal
	having cu_opnbal+isnull(sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))),0)<>0
	)
	select cu_code,cu_name,cur_bal , sum(cast(call as int)) call , sum(cast(visit as int)) visit , sum(cast(sms as int)) sms , sum(cast(whats as int)) whats , sum(cast(email as int)) email , sum(cast(fax as int)) fax 
	from trans s1 inner join cte_tbl s2 on s1.cusNo = s2.cu_code where trnDate between @fdate and @tdate 
	group by cu_code,cu_name,cur_bal order by cast(cu_code as bigint)
end
else
begin
	select ltrim(rtrim(cu_code)) cu_code ,iif(@language <> 1 And cu_lname <> '',cu_lname,cu_name)cu_name ,cu_opnbal+
	 isnull(sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))),0) as cur_bal , 0 as call , 0 as visit, 0 as sms, 0 as whats, 0 as email, 0 as fax
	from customer a with (nolock) left outer join ardtl b with (nolock)
	on a.cu_company=b.dt_company and a.cu_code=b.dt_cucode and a.cf_fcy=b.dt_fcy
	 and dt_cucode<>''
	where (cu_company=@m_Branch_code Or @m_Branch_code ='') and (cu_code = @cu_no or @cu_no = '') 
	and cu_code not in(select cusNo from trans where trnDate between @fdate and @tdate)
	group by cu_company,cu_code,cf_fcy,cu_name,cu_lname,cu_mobile,cu_tel,cu_opnbal
	having cu_opnbal+isnull(sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))),0)<>0
end
End 








GO
/****** Object:  StoredProcedure [dbo].[Api_ExportInventoryToXls]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_ExportInventoryToXls] @whno varchar(2) , @ctr varchar(2)
AS
BEGIN
	SET NOCOUNT ON ;
-------------------------------------------------------------------
declare 
	@dbc nvarchar(14),
	@lcalcomp char(2),
	@yrcode char(4),
	@sysno int,
	@caalwngtvs bit

	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
	select @sysno=sysno,@caalwngtvs=caalwngtvs  from sysdb.dbo.glcalend 
	       where calcomp=@lcalcomp and yrcode=@yrcode
-------------------------------------------------------------------	

	If (@sysno = 6)
     begin
	    select modelno , lprice1 , barcode , qty , pkqty , (qty * pkqty) as ttlqty , name  
		from inventory s1 inner join stitembc s2 on s1.barcode = s2.pbarcode inner join stitems s3 on s2.itemno = s3.itemno
		where whno = @whno and ctr = @ctr
	 end
	 else
	 begin
	 select s1.srlno ,  s2.modelno , s1.binno , s2.lprice1 , s2.barcode , s1.qty , s2.pkqty1 , FLOOR(s1.qty / s2.pkqty1) as tard , (s1.qty % s2.pkqty1) as fart , s3.name  
		from inventory s1 inner join stunits s2 on s1.itemno = s2.cmbkey inner join stitems s3 on s2.itemno = s3.itemno
		where whno = @whno and ctr = @ctr order by srlno
	 end
END




GO
/****** Object:  StoredProcedure [dbo].[Api_GET_ITEM_BR_SUMMARY]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Api_GET_ITEM_BR_SUMMARY]
(
@m_cmbkey char(24),
@m_barcode char(20),
@Language smallint = 1
)
AS BEGIN
	;with cte_Openbal (whno,name,openbal)
	as
	(select a.whno as whno,ltrim(rtrim(iif(@Language <> 1 And a.lname <>'',a.lname, a.name))) as [name],
	Sum(isnull(d.openbal,0)) as openbal
	from stwhous a with (nolock) left outer join stbins d with (nolock) 
	on a.whno=d.whno inner join stunits c
	on d.itemno=c.itemno and d.unicode=c.unicode and (c.cmbkey=@m_cmbkey  or c.barcode = @m_barcode)
	group by a.whno,a.name,a.lname
	)
	
	,ctr_trxbal
	as
	(select stdtl.whno,
		   rcvtrx=sum(case when stdtl.trtype in ('01','02','11','10','31','30') then (case when stdtl.trtype in ('01','11','10')
		   then qty+fqty else -(qty+fqty) end) else 0.00 end),
		   rtntrx=sum(case  when stdtl.trtype in ('24','26') then qty+fqty else 0.00 end),
		   slstrx=sum(case  when stdtl.trtype in ('04','06') then qty+fqty else 0.00 end),
		   isstrx=sum(case when stdtl.trtype in ('05','09') then (case when stdtl.trtype='09' then qty+fqty else -(qty+fqty) end) else 0.00 end),
		   adjtrx=sum(case when stdtl.trtype in ('13','20','12','46') then (case when stdtl.trtype='20' and tobinno<>'+' 
		   then -qty else qty end) else 0.00 end)
		   from stitems with (nolock) inner Join stunits with (nolock) inner join stdtl with (nolock) inner Join sthdr with (nolock)
		   on stdtl.branch=sthdr.branch and stdtl.trtype=sthdr.trtype and stdtl.ref=sthdr.ref
		   on stunits.itemno=stdtl.itemno and stunits.Unicode=stdtl.Unicode
		   on stitems.itemno=stunits.itemno
		   where stdtl.cmbkey=@m_cmbkey or stdtl.barcode = @m_barcode
		   group by stdtl.whno
	)

	select a.whno,name,isnull(openbal,0) as prdopenbal,isnull(rcvtrx,0) as purchase_qty,isnull(rtntrx,0) as sales_rtn_qty,
	isnull(isstrx,0) as Isstrx_qty,isnull(slstrx,0) as sales_qty,
	isnull(adjtrx,0) as adjustment,
	openbal+isnull(rcvtrx,0)+isnull(rtntrx,0)-isnull(slstrx,0)+isnull(adjtrx,0)-isnull(isstrx,0) as current_balance
	from cte_openbal a with (nolock) left outer join ctr_trxbal b with (nolock) on a.whno=b.whno 
END














GO
/****** Object:  StoredProcedure [dbo].[Api_Get_Supplier_Top20_items]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Api_Get_Supplier_Top20_items]
(
@m_Branch_code char(2),@m_supp_code char(6),@fcy as char(3),@fdate char(8) ,@tdate char(8) , @Language smallint = 1
)
AS BEGIN
	select top 20  ltrim(rtrim(v.cmbkey)) cmbkey , ltrim(rtrim(iif(@Language <> 1 And x.lname <> '' , x.lname,x.name))) name ,
	sum(iif(src='05' and trdate between @fdate and @tdate,iif(trtype in ('04','06'),(qty+fqty),-(qty+fqty)),0)) as Top_sales ,
	openbal+
	 sum(iif(trtype in ('05','01','12','13','10','11','24','26'),(qty+fqty),-(qty+fqty))) as cur_bal
	from (supplier a with (nolock) inner join stitems x with (nolock) on a.cu_code= cast(rtrim(x.splycode) as char(6)) and a.cf_fcy=x.fcy
	and a.cu_company=@m_Branch_code
	inner join stunits v on x.itemno=v.itemno)
	left outer join stdtl b on v.itemno=b.itemno and b.unicode=b.unicode and b.branch=@m_Branch_code and trtype not in ('14','20')
	and trdate <= @tdate
	where cu_company=@m_branch_code and cu_code=@m_supp_code and cf_fcy=@fcy
	group by  v.cmbkey,x.name,x.lname,openbal having sum(iif(src='05',iif(trtype in ('04','06'),(qty+fqty),-(qty+fqty)),0))>0
	order by Top_sales desc 
END












GO
/****** Object:  StoredProcedure [dbo].[Api_GetBranches]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_GetBranches] 
	(@username char(10),@Language smallint = 1 )
AS
BEGIN
	Select brnno , ltrim(rtrim(iif(@Language <> 1 And Lname <> '' , Lname ,  name ))) name 
	from stbranch with (nolock)
	where (select usrbrn from sysuse with(nolock) where username = @username)like '%'+ltrim(rtrim(brnno))+'%' Order by cast(brnno as bigint)
END





GO
/****** Object:  StoredProcedure [dbo].[Api_GetBranchesByCmncode]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_GetBranchesByCmncode] 
	(@cmncode char(6) )
AS
BEGIN
	select cu_code brnno , ltrim(rtrim(cu_name)) name from customer with(nolock) where cmncode = @cmncode ;
END













GO
/****** Object:  StoredProcedure [dbo].[Api_GetCurrency]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_GetCurrency] 
	(@Language smallint = 1 )
AS
BEGIN
	Select curcode , ltrim(rtrim(iif(@Language <> 1 And curlname <> '' , curlname ,  curname))) name 
	from glcurr with (nolock) Order by curcode
END












GO
/****** Object:  StoredProcedure [dbo].[Api_GetCustomerData]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_GetCustomerData]
	(@branch char(2) = '' , @cu_code Char(6) = '' , @Language smallint =1)

AS
BEGIN
	
	SET NOCOUNT ON;
	select * from customer where cu_company = @branch and cu_code = @cu_code ;
    
END






GO
/****** Object:  StoredProcedure [dbo].[Api_GetCustomers]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Api_GetCustomers]
	(@branchNo Char(2) = '' , @salecntr char(2) , @Language smallint =1)
AS
BEGIN
	declare @dbc varchar(8);
	declare @calcomp varchar(2);
	declare @yrcode varchar(4);
	declare @sction_customr bit;
	declare @sction varchar(4);

	set @dbc=db_name();
	set @calcomp=substring(@dbc,4,2);
	set @yrcode=substring(@dbc,7,2);
	set @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode);

	select @sction_customr=sction_customr from sysdb.dbo.glcalend with(nolock) where calcomp=@calcomp and yrcode=@yrcode;

	if(@sction_customr = 1)
	begin
		select @sction= isnull(s1.sc_code,'') from salecntr s1 with(nolock) inner join glsction s2 with(nolock) 
		on s1.dp_brno = s2.sc_company and s1.dp_dept = s2.sc_whno and s1.sc_code = s2.sc_code 
		where dp_brno = @branchNo and dp_dept = @salecntr ;
		Select cu_company , cu_code , ltrim(rtrim(IIF(@Language <> 1 and cu_lname <> '' , cu_lname ,  cu_name))) cu_name , cu_curbal , cu_status , 
		cu_crlmt , cu_alwcr , clnt_taxcode , ISNULL(individual_clnt,0) individual_clnt, cu_onlycsh
		from customer with (nolock) Where (cu_company = @branchNo Or @branchNo = '') and section = @sction
		Order by cu_company , cast(cu_code as bigint)
	end
	else
	begin
		Select cu_company , cu_code , ltrim(rtrim(IIF(@Language <> 1 and cu_lname <> '' , cu_lname ,  cu_name))) cu_name , cu_curbal , cu_status , 
		cu_crlmt , cu_alwcr , clnt_taxcode , ISNULL(individual_clnt,0) individual_clnt, cu_onlycsh
		from customer with (nolock) Where (cu_company = @branchNo Or @branchNo = '') 
		Order by cu_company , cast(cu_code as bigint)
	end
END





GO
/****** Object:  StoredProcedure [dbo].[Api_GetItemCardData]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_GetItemCardData]
	@itemCode varchar(20) ,@username varchar(20), @isBarcode bit
AS
BEGIN
	SET NOCOUNT ON ;	
	declare @sysno numeric(1,0)  ;
	declare @compCode char(2) ;
	declare @yrCode char(2) ;
	declare @multibarcode bit ;
	declare @showcost tinyint;

	set @compCode = substring(DB_NAME(),4,2) ; 
	set @yrCode = substring(DB_NAME(),7,2) ; 

	set @sysno = (select sysno from sysdb.dbo.glcalend with(nolock) where calcomp = @compCode And substring(yrcode,3,2) = @yrCode) ;
	set @multibarcode= (select multibarcode from sysdb.dbo.glcalend with(nolock) where calcomp = @compCode And substring(yrcode,3,2) = @yrCode);
	set @showcost = (select isnull(showcost,0) from sysuse with(nolock) where username = @username);

	if (@sysno = '6' or @multibarcode = 1)
	begin

	    select top 1 s1.cmbkey , s3.pbarcode , s2.name ,s3.lprice1, s4.pkname, s3.pkqty,cast(s1.lcost * @showcost as numeric(10,3)) as lcost, 
		s1.curbal , cast(s5.highlcost * @showcost as numeric(10,3)) as highlcost, cast(s5.lowlcost * @showcost as numeric(10,3)) as lowlcost, 
		cast(s5.lastlcost * @showcost as numeric(10,3)) as lastlcost, s5.lstrcvdate , s5.frstrcvdate
		FROM stunits s1 
		inner join stitems s2 on s1.itemno = s2.itemno 
		inner join stitembc s3 on s1.itemno = s3.itemno 
		inner join orpacking s4 on s3.pack = s4.pack_id
		left join stcosttype s5 on s1.itemno = s5.itemno
		where s3.cmbkey =@itemCode Or s3.pbarcode = @itemCode ;
		
	end
	else
	begin

		select top 1 s1.cmbkey , s1.barcode as pbarcode, s2.name ,s1.lprice1, s4.pkname, s1.pkqty1 as pkqty,cast(s1.lcost * @showcost as numeric(10,3)) as lcost, 
		s1.curbal , cast(s5.highlcost * @showcost as numeric(10,3)) as highlcost, cast(s5.lowlcost * @showcost as numeric(10,3)) as lowlcost, 
		cast(s5.lastlcost * @showcost as numeric(10,3)) as lastlcost, s5.lstrcvdate , s5.frstrcvdate
		FROM stunits s1 
		inner join stitems s2 on s1.itemno = s2.itemno 
		inner join orpacking s4 on s1.pack0 = s4.pack_id
		left join stcosttype s5 on s1.itemno = s5.itemno
		where s1.cmbkey =@itemCode Or s1.barcode =@itemCode ;

	end
END








GO
/****** Object:  StoredProcedure [dbo].[Api_GetItemData]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_GetItemData]
	@itemCode varchar(20) , @isBarcode bit , @salecntr char(2) , @cusno varchar(20),@branchno char(2),@userName varchar(50)
AS
BEGIN
	SET NOCOUNT ON ;	
	declare @sysno numeric(1,0)  ;
	declare @compCode char(2) ;
	declare @yrCode char(2) ;
	declare @multibarcode bit ;
	declare @whno char(2);
	declare @lastprice numeric(10,2);
	declare @useprice int;

	set @compCode = substring(DB_NAME(),4,2) ; 
	set @yrCode = substring(DB_NAME(),7,2) ; 

	set @sysno = (select sysno from sysdb.dbo.glcalend with(nolock) where calcomp = @compCode And substring(yrcode,3,2) = @yrCode) ;
	set @multibarcode= (select multibarcode from sysdb.dbo.glcalend with(nolock) where calcomp = @compCode And substring(yrcode,3,2) = @yrCode);
	set @whno = (select dp_mainwh from salecntr with(nolock) where dp_brno = @branchno and dp_dept = @salecntr);
	set @lastprice = (select top 1 price from sales_dt with(nolock) where custno = @cusno and (cmbkey= @itemCode or barcode = @itemCode) order by invdate desc);

	select @useprice = iif(useprice1=1,1,iif(useprice2=1,2,iif(useprice3=1,3,1))) from sysuse with(nolock) where username = @userName;
	
	if (@sysno = '6' or @multibarcode = 1)
	begin
		if (@isBarcode = 1)
		begin
		 ;with tbl(cmbkey,barcode,itemno,unicode,name,lprice1,pkqty1,taxtype,mnmprice,isdecimal,dsctype,maxdisc1)
	    as
	    (
		select top 1 s2.cmbkey , s2.pbarcode as barcode , s2.itemno , s2.unicode, s1.name ,iif(@useprice=1,s2.lprice1,s2.lprice2) as lprice1, s2.pkqty as pkqty1 , iif(s1.taxtype = '',1,s1.taxtype) taxtype , s2.mnmprice , s3.Xdecimal as isdecimal,s1.dsctype,s3.maxdisc1
		from stitems s1 with(nolock) inner join stitembc s2 with(nolock) on s1.itemno = s2.itemno inner join stunits s3 on s1.itemno = s3.itemno
		where s2.pbarcode = @itemCode
	    )
		select ltrim(rtrim(cmbkey))cmbkey , ltrim(rtrim(barcode))barcode, name,iif(@lastprice is null,lprice1,@lastprice) lprice1,pkqty1,ISNULL(sum(qty-rsvqty),0) qty , taxtype , mnmprice , isdecimal,dsctype,maxdisc1
		from tbl s1 with(nolock) left join stbins s2 with(nolock) on  s1.itemno = s2.itemno and s1.unicode = s2.unicode and s2.whno = @whno
		group by cmbkey,barcode,name,lprice1,pkqty1,taxtype,mnmprice,isdecimal,dsctype,maxdisc1
		end
		else
		begin
		 ;with tbl(cmbkey,barcode,itemno,unicode,name,lprice1,pkqty1,taxtype,mnmprice,isdecimal,dsctype,maxdisc1)
	    as
	    (
		select top 1 s2.cmbkey , s2.pbarcode as barcode , s2.itemno , s2.unicode, s1.name , iif(@useprice=1,s2.lprice1,s2.lprice2) as lprice1 , s2.pkqty as pkqty1 , iif(s1.taxtype = '',1,s1.taxtype) taxtype , s2.mnmprice , s3.Xdecimal as isdecimal,s1.dsctype,s3.maxdisc1
		from stitems s1 with(nolock) inner join stitembc s2 with(nolock) on s1.itemno = s2.itemno inner join stunits s3 on s1.itemno = s3.itemno
		where s2.cmbkey =@itemCode Or s2.pbarcode = @itemCode
	    )
		select ltrim(rtrim(cmbkey))cmbkey , ltrim(rtrim(barcode))barcode, name,iif(@lastprice is null,lprice1,@lastprice) lprice1,pkqty1,ISNULL(sum(qty-rsvqty),0) qty , taxtype , mnmprice , isdecimal,dsctype,maxdisc1
		from tbl s1 with(nolock) left join stbins s2 with(nolock) on  s1.itemno = s2.itemno and s1.unicode = s2.unicode and s2.whno = @whno
		group by cmbkey,barcode,name,lprice1,pkqty1,taxtype,mnmprice,isdecimal,dsctype,maxdisc1
		end
	end
	else
	begin

		;with tbl(cmbkey,barcode,itemno,unicode,name,lprice1,pkqty1,taxtype,mnmprice,isdecimal,dsctype,maxdisc1)
		as
		(
		select top 1 s2.cmbkey , s2.barcode , s2.itemno , s2.unicode, s1.name , iif(@useprice=1,s2.lprice1,iif(@useprice=2,s2.lprice2,s2.lprice3)) as lprice1 , s2.pkqty1 , iif(s1.taxtype = '',1,s1.taxtype) taxtype , s2.mnmprice , Xdecimal as isdecimal,s1.dsctype,s2.maxdisc1
		from stitems s1 with(nolock) inner join stunits s2 with(nolock) on s1.itemno = s2.itemno 
		where s2.cmbkey =@itemCode Or s2.barcode = @itemCode
	    )
		select ltrim(rtrim(cmbkey))cmbkey , ltrim(rtrim(barcode))barcode, name,iif(@lastprice is null,lprice1,@lastprice) lprice1,pkqty1,ISNULL(sum(qty-rsvqty),0) qty,taxtype,mnmprice,isdecimal,dsctype,maxdisc1
		from tbl s1 with(nolock) left join stbins s2 with(nolock) on  s1.itemno = s2.itemno and s1.unicode = s2.unicode and s2.whno = @whno
		group by cmbkey,barcode,name,lprice1,pkqty1,taxtype,mnmprice,isdecimal,dsctype,maxdisc1

	end
END


GO
/****** Object:  StoredProcedure [dbo].[Api_GetItemData_Transfer]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_GetItemData_Transfer]
	@itemCode varchar(20) , @isBarcode bit , @whno char(2)
AS
BEGIN
	SET NOCOUNT ON ;	
	declare @sysno numeric(1,0)  ;
	declare @compCode char(2) ;
	declare @yrCode char(2) ;
	declare @multibarcode bit ;

	set @compCode = substring(DB_NAME(),4,2) ; 
	set @yrCode = substring(DB_NAME(),7,2) ; 

	set @sysno = (select sysno from sysdb.dbo.glcalend with(nolock) where calcomp = @compCode And substring(yrcode,3,2) = @yrCode) ;
	set @multibarcode= (select multibarcode from sysdb.dbo.glcalend with(nolock) where calcomp = @compCode And substring(yrcode,3,2) = @yrCode);
	
	if	@sysno = '6'
	begin
	;with tbl(cmbkey,barcode , itemno , unicode,name,lprice1,pkqty1 , pkID , pkname ,taxtype,isdecimal)
	as
	(
		select top 1 s2.cmbkey , s2.pbarcode , s2.itemno , s2.unicode, s1.name , s2.lprice1 , s2.pkqty as pkqty1 , s2.pack as pkID , s3.pkname , iif(s1.taxtype = '',1,s1.taxtype), s4.Xdecimal as isdecimal
		from stitems s1 with(nolock) 
		inner join stitembc s2 with(nolock) on s1.itemno = s2.itemno 
		inner join orpacking s3 with(nolock) on s2.pack = s3.pack_id 
		inner join stunits s4 with(nolock) on s1.itemno = s4.itemno
		where s2.pbarcode = @itemCode or s2.cmbkey = @itemCode 
	)
	select ltrim(rtrim(cmbkey))cmbkey , ltrim(rtrim(barcode))barcode , name , lprice1 , pkqty1 , ISNULL(sum(qty),0) qty ,
		   ISNULL(sum(rsvqty),0) rsvqty , taxtype , max(lcost) lcost ,  pkID , pkname, isdecimal
	from tbl s1 with(nolock) left join stbins s2 with(nolock) on  s1.itemno = s2.itemno and s1.unicode = s2.unicode and s2.whno = @whno
	group by cmbkey,barcode,name,lprice1,pkqty1,taxtype,pkID,pkname,isdecimal
	end
	else
	begin
    ;with tbl(cmbkey,barcode , itemno , unicode,name,lprice1,pkqty1,taxtype,isdecimal)
	as
	(
		select s2.cmbkey , s2.barcode , s2.itemno , s2.unicode, s1.name , s2.lprice1 , s2.pkqty1 , iif(s1.taxtype = '',1,s1.taxtype) , Xdecimal as isdecimal
		from stitems s1 with(nolock) inner join stunits s2 with(nolock) on s1.itemno = s2.itemno 
		where s2.cmbkey =@itemCode Or s2.barcode = @itemCode
	)
	select ltrim(rtrim(cmbkey))cmbkey , ltrim(rtrim(barcode))barcode , name , lprice1 , pkqty1 , ISNULL(sum(qty),0) qty ,
		   ISNULL(sum(rsvqty),0) rsvqty , taxtype , max(lcost) lcost,isdecimal
	from tbl s1 with(nolock) left join stbins s2 with(nolock) on  s1.itemno = s2.itemno and s1.unicode = s2.unicode and s2.whno = @whno
	group by cmbkey,barcode,name,lprice1,pkqty1,taxtype,isdecimal
	end
END






GO
/****** Object:  StoredProcedure [dbo].[Api_GetItems]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_GetItems]
	@numOfdays int , @whno varchar(2) = ''
AS
BEGIN
	SET NOCOUNT ON ;	
	declare @sysno numeric(1,0)  ;
	declare @compCode char(2) ;
	declare @yrCode char(2) ;
	declare @lastupdt char(8) ;
	declare @multibarcode bit;

	set @lastupdt = convert(char(8),DATEADD(DAY , -@numOfdays , GETDATE()),112) ;
	set @compCode = substring(DB_NAME(),4,2) ; 
	set @yrCode = substring(DB_NAME(),7,2) ; 

	select @sysno = sysno , @multibarcode = multibarcode  from sysdb.dbo.glcalend with(nolock) where calcomp = @compCode And substring(yrcode,3,2) = @yrCode ;
	
	if @sysno = 6 or @multibarcode = 1
	if @numOfdays = -1
	begin
	;with stbs(itemno,qty) as
	(
		select itemno , sum(qty) from stbins with(nolock) where whno = @whno or @whno = '' group by itemno
	)
	select rtrim(s1.pbarcode) as itemno , rtrim(s2.name) as name , rtrim(s1.pbarcode) as barcode , s1.lprice1 , s1.lprice1 as lcost , s1.pkqty as pkqty1 
	from stitembc s1 with(nolock) inner join stitems s2 with(nolock) on s1.itemno = s2.itemno 
	left join stbs s3 on s2.itemno = s3.itemno where s2.itemtype <> '5' ;
	end
	else
	begin
	;with stbs(itemno,qty) as
	(
		select itemno , sum(qty) from stbins with(nolock) where whno = @whno or @whno = '' group by itemno
	)
	select rtrim(s1.pbarcode) as itemno , rtrim(s2.name) as name , rtrim(s1.pbarcode) as barcode , s1.lprice1 , s1.lprice1 as lcost , s1.pkqty as pkqty1 
	from stitembc s1 with(nolock) inner join stitems s2 with(nolock) on s1.itemno = s2.itemno 
	left join stbs s3 with(nolock) on s2.itemno = s3.itemno where s2.itemtype <> '5' and s1.itemno in(select itemno from stunits where lastupdt > @lastupdt);
	end
	else if @sysno = 99
	begin
	select ITEMID as itemno , name , price as lprice1 , ITEMBARCODE as barcode from MasterData with(nolock)
	end
	else
	if @numOfdays = -1
	begin
	;with stbs(itemno,qty) as
	(
		select itemno , sum(qty) from stbins with(nolock) where whno = @whno or @whno = '' group by itemno
	)
	select rtrim(s1.cmbkey) as itemno , rtrim(s2.name) as name , rtrim(s1.barcode) as barcode , s1.lprice1 , s1.lcost , s1.pkqty1 , ISNULL(s3.qty ,0) as qty
	from stunits s1 with(nolock) inner join stitems s2 with(nolock) on s1.itemno = s2.itemno left join stbs s3 with(nolock) on s2.itemno = s3.itemno ;
	end
	else
	begin
	;with stbs(itemno,qty) as
	(
		select itemno , sum(qty) from stbins with(nolock) where whno = @whno or @whno = '' group by itemno
	)
	select rtrim(s1.cmbkey) as itemno , rtrim(s2.name) as name , rtrim(s1.barcode) as barcode , s1.lprice1 , s1.lcost , s1.pkqty1 , ISNULL(s3.qty ,0) as qty
	from stunits s1 with(nolock) inner join stitems s2 with(nolock) on s1.itemno = s2.itemno left join stbs s3 with(nolock) on s2.itemno = s3.itemno where s1.lastupdt > @lastupdt ;
	end
END











GO
/****** Object:  StoredProcedure [dbo].[Api_GetItems_x]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

create PROCEDURE [dbo].[Api_GetItems_x]
	@numOfdays int

AS
BEGIN
	SET NOCOUNT ON ;	
	declare @sysno numeric(1,0)  ;
	declare @compCode char(2) ;
	declare @yrCode char(2) ;
	declare @lastupdt char(8) ;
	
	set @lastupdt = convert(char(8),DATEADD(DAY , -@numOfdays , GETDATE()),112) ;
	set @compCode = substring(DB_NAME(),4,2) ; 
	set @yrCode = substring(DB_NAME(),7,2) ; 

	set @sysno = (select sysno from sysdb.dbo.glcalend where calcomp = @compCode And substring(yrcode,3,2) = @yrCode) ;

	if @sysno = 6
	if @numOfdays = -1
	select rtrim(s1.cmbkey) as itemno , rtrim(s2.name) as name , rtrim(s1.pbarcode) as barcode , s1.lprice1 , s1.lprice1 as lcost , s1.pkqty as pkqty1 from stitembc s1 inner join stitems s2 on s1.itemno = s2.itemno where s2.itemtype <> '5';
	else
	select rtrim(s1.cmbkey) as itemno , rtrim(s2.name) as name , rtrim(s1.pbarcode) as barcode , s1.lprice1 , s1.lprice1 as lcost , s1.pkqty as pkqty1 from stitembc s1 inner join stitems s2 on s1.itemno = s2.itemno where s2.itemtype <> '5' and s1.itemno in(select itemno from stunits where lastupdt > @lastupdt);
	else
	if @numOfdays = -1
	select rtrim(s1.cmbkey) as itemno , rtrim(s2.name) as name , rtrim(s1.barcode) as barcode , s1.lprice1 , s1.lcost , s1.pkqty1 from stunits s1 inner join stitems s2 on s1.itemno = s2.itemno where s2.itemtype <> '5' ;
	else
	select rtrim(s1.cmbkey) as itemno , rtrim(s2.name) as name , rtrim(s1.barcode) as barcode , s1.lprice1 , s1.lcost , s1.pkqty1 from stunits s1 inner join stitems s2 on s1.itemno = s2.itemno where s2.itemtype <> '5' and s1.lastupdt > @lastupdt ;

END









GO
/****** Object:  StoredProcedure [dbo].[Api_GetLeav]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_GetLeav] 

				@empNo char(6)

AS
BEGIN
	
	SET NOCOUNT ON;

    
	SELECT leavdays , leavopen , leavbal  from ppemp where empno = @empNo
END








GO
/****** Object:  StoredProcedure [dbo].[Api_GetSaleCenter]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_GetSaleCenter] 
	(@Language smallint = 1 , @username varchar(50))
AS
BEGIN
	declare @gratSalcenter varchar(500) = '';
	set @gratSalcenter = (select uscntralw  from sysuse where username = @username)
	;with slcntr(dp_brno , dp_dept , dp_name , dp_cashser , dp_crdcardac,sc_code, glname)
	as(
	Select dp_brno , dp_dept , ltrim(rtrim(iif(@Language <> 1 And dp_name <> '' , dp_name ,  dp_name ))) dp_name , dp_cashser , dp_crdcardac , sc_code , glname
	from salecntr with (nolock) left join glchart with (nolock) on 
	salecntr.dp_brno = glchart.glcomp and salecntr.dp_cashser = glchart.glkey
	where @gratSalcenter like '%' + dp_brno + dp_dept +  '%' and ltrim(rtrim(glcurrency)) = '') 
	select slcntr.*, ISNULL(glchart.glname,' ') as glnamebnk from slcntr left join glchart with (nolock) on 
	slcntr.dp_brno = glchart.glcomp and glchart.glactive = 1 and slcntr.dp_crdcardac = glchart.glkey and glchart.glcurrency = ''
END





GO
/****** Object:  StoredProcedure [dbo].[Api_GetSection]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_GetSection] 
	(@compno char(2) ,@username char(10), @Language smallint = 1 )
AS
BEGIN
	Select sc_code , ltrim(rtrim(iif(@Language <> 1 And sc_lname <> '' , sc_lname ,  sc_name ))) name 
	from glsction with (nolock) 
	where sc_company = @compno and (select ussctnalw from sysuse with(nolock) where username =@username) like '%'+ltrim(rtrim(sc_company+sc_code))+'%' Order by cast(sc_company as bigint)
END









GO
/****** Object:  StoredProcedure [dbo].[Api_GetStclass]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_GetStclass] 
	(@cmbkey varchar(10) , @Language smallint = 1 )
AS
BEGIN
if @cmbkey = ''
	Select ltrim(rtrim(iif(@Language <> 1 And Lname <> '' , Lname ,  name ))) name , rtrim(cmbkey) cmbkey
	from stclass with (nolock) Where cmbkey = mgroup Order by cmbkey
else
	Select ltrim(rtrim(iif(@Language <> 1 And Lname <> '' , Lname ,  name ))) name , rtrim(cmbkey) cmbkey
	from stclass with (nolock) Where cmbkey like @cmbkey + '%' and cmbkey <> mgroup and cmbkey <> @cmbkey  Order by cmbkey
END
















GO
/****** Object:  StoredProcedure [dbo].[Api_GetStockBalance]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_GetStockBalance]
	@whno varchar(2) ,@username varchar(20), @language int
AS
BEGIN
	SET NOCOUNT ON ;	
	declare @sysno numeric(1,0)  ;
	declare @compCode char(2) ;
	declare @yrCode char(2) ;
	declare @multibarcode bit ;
	declare @showcost tinyint;

	set @showcost = (select isnull(showcost,0) from sysuse with(nolock) where username = @username);

	select ltrim(rtrim(s1.itemno)) as itemno, ltrim(rtrim(s2.name)) as name, (s3.qty - s3.rsvqty) as qty,
	cast(s3.lcost * @showcost as numeric(10,3)) as cost, cast((s3.qty - s3.rsvqty) * s3.lcost as numeric(13,3)) * @showcost as total, s1.lprice1
	from stunits s1 with(nolock)
	inner join stitems s2 with(nolock) on s1.itemno = s2.itemno 
	inner join stbins  s3 with(nolock) on s1.itemno = s3.itemno and s1.unicode = s3.unicode 
	where s3.whno = @whno order by qty desc
END





GO
/****** Object:  StoredProcedure [dbo].[Api_GetStWhouse]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_GetStWhouse] 
	(@Language smallint = 1 , @username varchar(50))
AS
BEGIN

	if	@username = '*'
	begin
	Select whno , ltrim(rtrim(iif(@Language <> 1 And name <> '' , name ,  name ))) name
	from stwhous with (nolock)
	end
	else
	begin
	declare @gratWhno varchar(500) = '';
	set @gratWhno = (select uswhalw  from sysuse where username = @username)
	Select whno , ltrim(rtrim(iif(@Language <> 1 And name <> '' , name ,  name ))) name , branch
	from stwhous with (nolock) where @gratWhno like '%' + whno +  '%'   Order by cast(whno as bigint)
	end
END





GO
/****** Object:  StoredProcedure [dbo].[Api_GetSuppliers]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_GetSuppliers] 
	(@branchNo Char(2) = '' , @Language smallint =1)
AS
BEGIN
	Select cu_company , cu_code , ltrim(rtrim(IIF(@Language <> 1 and cu_lname <> '' , cu_lname ,  cu_name))) cu_name , cf_fcy
	  from supplier with (nolock)
	  Where (cu_company = @branchNo Or @branchNo = '') Order by cu_company , cast(cu_code as bigint)
END















GO
/****** Object:  StoredProcedure [dbo].[Api_GetUnits]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Api_GetUnits]
	@itemCode varchar(20),@username varchar(20)
	
AS
BEGIN
	
	SET NOCOUNT ON;

	declare @sysno numeric(1,0)  ;
	declare @compCode char(2) ;
	declare @yrCode char(2) ;
	declare @multibarcode bit ;
	declare @useprice int;

	set @compCode = substring(DB_NAME(),4,2) ; 
	set @yrCode = substring(DB_NAME(),7,2) ; 


	select @useprice = iif(useprice1=1,1,iif(useprice2=1,2,iif(useprice3=1,3,1))) from sysuse with(nolock) where username = @userName;
	set @sysno = (select sysno from sysdb.dbo.glcalend with(nolock) where calcomp = @compCode And substring(yrcode,3,2) = @yrCode) ;
	set @multibarcode= (select multibarcode from sysdb.dbo.glcalend with(nolock) where calcomp = @compCode And substring(yrcode,3,2) = @yrCode);
	IF OBJECT_ID('tempdb..#ApiUnits') IS NOT NULL DROP TABLE #ApiUnits ;
	
	declare @itemCode1 varchar(50);
	set @itemCode1 = (select top 1 cmbkey from stunits with(nolock) where cmbkey = @itemCode or barcode = @itemCode)

	CREATE TABLE #ApiUnits ( pack varchar(2) , packname varchar(50) , pkqty float , price float , pbarcode char(20) ) ;
	
	if (@sysno = '6' or @multibarcode = 1)
	begin

	set @itemCode = (select top 1 cmbkey from stitembc where cmbkey = @itemCode or pbarcode = @itemCode);

	insert into #ApiUnits select s1.pack as pack, s2.pkname as packname , s1.pkqty as pkqty, s1.lprice1 as price, s1.pbarcode as pbarcode 
	from stitembc s1 , orpacking s2 where s1.cmbkey = @itemCode and s1.pack = s2.pack_id

	end

	else

	begin

	insert into #ApiUnits select pack0 as pack,ltrim(rtrim(pkname)) as packname,1 as pkqty , iif(@useprice = 1, lprice1,iif(@useprice = 2, lprice2, lprice3)) as price , '' as pbarcode from stunits s1 with(nolock) inner join orpacking s2 with(nolock) on s1.pack0 = s2.pack_id where cmbkey = @itemCode1
	
	insert into #ApiUnits select pack1 as pack,ltrim(rtrim(pkname)) as packname,pkqty1 as pkqty , fprice1 as price , '' as pbarcode from stunits s1 with(nolock) inner join orpacking s2 with(nolock) on s1.pack1 = s2.pack_id where cmbkey =  @itemCode1

	insert into #ApiUnits select pack2 as pack,ltrim(rtrim(pkname)) as packname,pkqty2 as pkqty , fprice2 as price , '' as pbarcode from stunits s1 with(nolock) inner join orpacking s2 with(nolock) on s1.pack2 = s2.pack_id where cmbkey = @itemCode1

	end

	select * from #ApiUnits
	
END


GO
/****** Object:  StoredProcedure [dbo].[Api_HrSig]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Api_HrSig]
	@empNo char(6) , @deviceId varchar(200) 
AS
BEGIN
	
	SET NOCOUNT ON;
	begin try
	declare @dt datetime = convert(varchar(16), getdate(), 121) 
	if((select count(*) from pp_emp_device where empNo = @empNo) > 0)
	begin
	if((select count(*) from pp_emp_device where empNo = @empNo and deviceId = @deviceId) > 0)
	begin
	 insert into pp_att_all select @empNo , convert(varchar, @dt, 3) , convert(varchar(5), @dt, 108) , convert(varchar(20), @dt, 120) 
	    select convert(varchar(16) ,@dt,120);
	end
	else
	begin
	-- تم التحضير من جهاز اخر
		select '-1';
	end
	end
	else
	begin
	if((select count(*) from pp_emp_device where deviceId = @deviceId) > 0)
	begin
		select '-1';
	end
	else
	begin
	 insert into pp_emp_device select @empNo , @deviceId
	 insert into pp_att_all select @empNo , convert(varchar, @dt, 3) , convert(varchar(5), @dt, 108) , convert(varchar(20), @dt, 120) 
	    select convert(varchar(16) ,@dt,120);
	end
	end
   
	end try
	begin catch
		select '0';
	end catch
END






GO
/****** Object:  StoredProcedure [dbo].[Api_ImportSalInv]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Api_ImportSalInv]
@STR_MSG NVARCHAR(1000) OUT,
@RET_ID INT OUT,
@PDAXFR xml,
@SLCNTR Nchar(2),
@SLPRSN Nchar(2),
@BRANCH Nchar(2),
@USRID Nchar(10)

AS BEGIN 
   set lock_timeout 2000
BEGIN TRY
	DECLARE @shdpk NUMERIC(10,3)
	DECLARE @pack0 NVARCHAR(1)
	DECLARE @pack_0 char(1)
	DECLARE @lprice decimal(11,3)=0
	DECLARE @cmbkey NVARCHAR(24)
	DECLARE @itemno CHAR(16)
	DECLARE @unicode CHAR(6)
	DECLARE @lcost float
	declare @Trdate varchar(20)
	DECLARE @handle INT	
	DECLARE @barcode NVARCHAR(20)
	DECLARE @lcustcode nCHAR(6)
	DECLARE @lbinno CHAR(6)
	DECLARE @qty float
	declare @ltrtype nchar(2)
	DECLARE @comp char(2),
	@binno_found bit =0
	


	declare @ss as varchar(10),
	@srlno as int =0,
	@lshdqty as float=0,
	@lfrtqty as float =0,
	@ttlqty as float =0,
	@avail_qty float =0,
	@ttlcost as float =0,
	@ttlinv as float =0

	declare @dbc varchar(20),
	@lusing_hij_date bit =0,
	@ldate varchar(10),
	@lfdate varchar(8)='',
	@errstatus int =0,
	@stunits_lcost float=0,
	@lwhno as char(2)=''

	SET @ltrtype =substring(@STR_MSG,1,2)
	set @lcustcode=substring(@STR_MSG,4,6)

	set @STR_MSG=''
	set @RET_ID=0
	set @dbc=db_name()
	SET @lusing_hij_date=iif(cast(substring(@dbc,7,2) as int)>30,1,0)
	set @comp=substring(@dbc,4,2)
	if @lusing_hij_date=1
	begin
		set @ldate =convert(varchar(10),getdate(),131)
		set @lfdate=substring(@ldate,7,4)+substring(@ldate,4,2)+iif(substring(@ldate,1,1)=' ','0'+substring(@ldate,2,1),substring(@ldate,1,2))
	end
	else
	begin
		set @ldate = convert(varchar(10),getdate(),112)
		set @lfdate=@ldate		
	end
	declare @lcaalwngtvs bit =0,
	        @yrcode varchar(4),
	        @syscode int =2

	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
------------------------------------------------------
	declare @lslcenter char(2),
		@linvorrtrn char(1),
		@lentries int ,        
		@linvttl float,
		@linvcst float,
		@linvdsvl float,
		@lvalafds float,
		@lfcamt float,
		@lprpaid numeric(13,3),
		@lcash numeric(13,3),
		@lccpayment numeric(13,3),
		@lcsanedcrdamt numeric(13,3),
		@lcharges numeric(13,3),
		@lcccommision float,
		@ljhfcflag numeric(1,0)=2,
		@lt_qty numeric(13,3),
		@lxq numeric(13,3),
		@ldummy char(24),
		@arr_ptr int =0,
		@subttlcost float=0,
		@lpack1 char(1)=''
-------------------------------------------------------
	---
	---   sales_dt declarations
	---
	declare @litemno char(16),
		@lunicode char(6) ,
		@lqty  numeric(13,3),
		@lfqty  numeric(13,3),
		@ldiscpc float,
		@lds_acfm numeric(1,0),
		@lsl_acfm numeric(1,0),
		@lgclass char(8),
		@lbarcode char(20),
		@limfcval float,
		@lpack char(1),
		@lpkqty numeric(8,3),
		@lcmbkey char(24),
		@litemtype char(1),
		@llcost float,
		@blcost float,
		@lfcost float,
		@lstfcy char(3),
		@lclasskey char(12),
		@cl_slser char(19),
		@lslptr int=0,
		@lstptr int=0,
		@lttl_inv float=0
		
	--
	--   Stbins declaration 
	--
	declare @bwhno char(2),
		@bbinno char(6),
		@brmnqty numeric(13,3),
		@lnobinno bit=1,
		@lastbinno char(6)
    
	-- variables for sales_hd
	declare @hslcenter char(2),
		@hbranch char(2),
		@hcompany char(2),
		@hinvtype char(2),
		@href numeric(6,0),
		@hinvdate char(8) ,        
		@hcustno char(6), 
		@hfcy char(3)='',
		@hfcyrate float=0,
		@hinvttl float,
		@hinvcst float,
		@hinvdspc float,
		@hinvdsvl float,
		@hvalafds float,
		@hinvpaid numeric(13,3),
		@hextamt numeric(13,3),
		@hextser char(19),
		@hcccommsn float,
		@hbelowbal bit=0,
		@hccpayment numeric(13,3),
		@hsanedcrdamt numeric(12,3),
		@hrplsamt numeric(13,3),
		@hprpaidamt numeric(13,3),
		@husrid char(8),
		@hfxrate float =0,
		@hINSTFLAG bit,
		@hposinv numeric(1,0)=1	

	Declare @lbelowbal bit =0
------------------------------  Get Data From Sysuse ---------------------------------------------------------------
		select @lbelowbal=belowbal 
			 from sysuse with (NOLOCK)
			where username=@USRID 
------------------------------  Get Data From salecntr ---------------------------------------------------------------
	declare @ldp_cashser char(19),
		@ldp_okdiff bit ,
		@ldp_mainwh char(2),
		@ldp_expser char(19),
		@ldp_oslser char(19),
		@ldp_cardcomm char(19),
		@ldp_rplsac char(19),
		@ldp_diffser char(19),
		@lDP_CSLSER char(19),
		@lDP_RCSLSER char(19),
		@lprpaidcrdac char(19),
		@ltdate char(8),
		@lglacct char(19),
		@lexacct char(19),
		@ldp_slser char(19),
		@lsanedcrd_act char(19),
		@lcstctr char(4)=''

	declare @xttl_cost float=0,
		@inv_lmtt  float=0,
		@inv_lftt  float=0,
		@m_vl      float=0,
		@m_fc      float=0,
		@inv_stk   float=0,
		@m_lccntr  float=0,
		@m_fccntr  float=0,
		@pd_lc     float =0,
		@opstval varchar(50),
		@diff_amt float=0,
		@new_rate float=0,
		@match_image bit ,
		@fc_to_lc_ttl float=0,
		@ch_cnt int =0,
		@l_crtot float=0,
		@f_crtot float=0,
		@l_dbtot float=0,
		@f_dbtot float=0,
		@m_sign int =1,
		@m_value float=0,
		@m_fcval float=0,
		@plcamt float ,
		@pfcamt float ,
		@fcfcy char (3),
		@lcurname char(20),
		@replication bit =0,
		@xclkey char(12)='',
		@clsname char(20)='',
		@cstcode char(4)='',
		@dscact char(19)='',
		@dscclassamt float=0,
		@dsc_ptr int =0,
		@ttl_class_dsc float=0

	declare @hcustnm varchar(50)='',
	    @hcaser varchar(19)='',
		@haddress varchar(50)=''
		

		select @ldp_cashser=dp_cashser,@ldp_okdiff=dp_okdiff,@ldp_mainwh=dp_mainwh,@ldp_expser=dp_expser,
		@ldp_oslser=dp_oslser,@ldp_cardcomm=dp_cardcomm,@ldp_rplsac=dp_rplsac,@ldp_diffser=dp_diffser,
		@lDP_CSLSER=DP_CSLSER,@lDP_RCSLSER=DP_RCSLSER,@lprpaidcrdac=prpaidcrdac,@lsanedcrd_act=sanedcrd_act,@lcstctr=isnull(cstcode,'')
			from salecntr with (NOLOCK)
		where dp_brno=@BRANCH and dp_dept=@SLCNTR
------------------------------------------------------------------------------------------------------------------------	
------------------------  Get Customer Info  
----
        declare @cstaddrs varchar(60)='',
		@cstclass char(2)='',
		@cstcu_ctlser varchar(19)='',
		@dbtglacct char(19)='',
		@cstmaxlimit numeric(11,3)=0,
		@ldudate char(10)='',
		@ldudays int =0,
		@lcu_name varchar(50)=''

		set @lwhno=@ldp_mainwh
		if len(rtrim(@lcustcode))>0
		begin
			select @lcu_name=cu_name,@cstaddrs=cu_addrs,@cstclass=cu_class,@cstcu_ctlser=cu_ctlser,@cstmaxlimit=isnull(cu_crlmt,0),
			@ldudays=isnull(cu_pymnt,0) from customer where cu_company=@branch and cu_code=@lcustcode
			if len(isnull(@cstcu_ctlser,''))>0  set @dbtglacct=@cstcu_ctlser
			else
			begin
			   select @dbtglacct=cl_crlser from classfil where cl_company=@BRANCH and cl_code=@cstclass
			end
		end
--dateadd(dd,-1,getdate())
		set @hcaser=''
		set @ldp_slser=''
		if @ltrtype ='06'
		begin
			set @hcaser=@ldp_cashser
			set @dbtglacct=@hcaser
			set @ldp_slser=@lDP_CSLSER
			set @hcustnm='مبيعات نقدية تمت عن طريق جهاز PDA'				
		end
		else
		begin
			set @ldp_slser=@ldp_oslser
			set @hcustnm='مبيعات آجلة تمت عن طريق جهاز PDA'
-------------------------- To calculate Due date
			if @ldudays>0
			begin
				if @lusing_hij_date=1
				begin
					set @ldate =convert(varchar(10),dateadd(dd,@ldudays,getdate()),131)
					set @ldudate=substring(@ldate,7,4)+substring(@ldate,4,2)+iif(substring(@ldate,1,1)=' ','0'+substring(@ldate,2,1),substring(@ldate,1,2))
				end
				else
				begin
					set @ldate = convert(varchar(10),dateadd(dd,@ldudays,getdate()),112)
					set @ldudate=@ldate		
				end
			end
			else set @ldudate=@lfdate
		end

------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
    declare @lcaokcstctr bit =0
	select @syscode=sysno,@lcaalwngtvs=isnull(caalwngtv ,0),@lcaokcstctr=isnull(caokcstctr,0)
	       from sysdb.dbo.glcalend with (nolock)
	       where calcomp=@comp and yrcode=@yrcode

--------------------------------------------------------------------------------------------------------------------------- 
	IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[#TEMPSLINV_PDA]') AND type in (N'U'))
	DROP TABLE [dbo].[#TEMPSLINV_PDA]

	EXEC sp_xml_preparedocument @handle OUTPUT, @PdaXfr

	select  barcode,shdqty,frtqty,price
	into #TEMPSLINV_PDA FROM OPENXML (@handle, 'NewDataSet/Table1', 2) WITH
	(barcode nvarCHAR(20),
	shdqty float,
	frtqty float,
	price decimal(11,3))

	declare @ref int=0

	EXEC sp_xml_removedocument @handle
	


    DECLARE @j INT=1
	set @ref =0
	--set @Trdate=CONVERT(VARCHAR(10), getdate(), 112)
	select @ref =dbo.get_last_ref(@ltrtype, @branch)

---------------------------- Calculate the customer max limit 
  declare @tmp_ttl_inv float =0,
          @cst_curbal float =0,
		  @lposted bit =0,
		  @lfcy char(3)=space(3)

  if @cstmaxlimit>0 and @ltrtype='04'
  begin
        if @syscode<>6
      		Select @tmp_ttl_inv=sum((frtqty+(shdqty*pkqty1))*price)
			From #TEMPSLINV_PDA a inner join stunits b on a.barcode=b.barcode
		else
			Select @tmp_ttl_inv=sum(shdqty*price)
			From #TEMPSLINV_PDA 

		exec dbo.get_client_bal @BRANCH,@lcustcode,@lfcy,@lposted,@cst_curbal output
		if @cst_curbal+@tmp_ttl_inv>@cstmaxlimit
		begin
			SET @RET_ID = -55
			SET @STR_MSG ='العميل'+' '+@lcu_name+' '+'تجاوز الحد الاعلى للمديونية'
			set @errstatus =-1			
			goto jumplbl
		end
  end
  
---------------------------------------------------------------------
 -- DECLARE ARRAY HOLDING THE ITEM CLASS AND ACCOUNT
	    declare @class_arr table( p_ptr int,clkey char(12) not null , act char(19) not null,lcamt float ,
		clsname char(20),cstcode char(4),dscact char(19))

        --declare @dsc_class_val table(classkey char(12) not null,dscclassamt float default 0)   


		
------------------------------------------------------------------------------
        begin transaction

		if @ltrtype='06' update stbranch set jv_06=@ref+1 where brnno=@BRANCH
		else update stbranch set jv_04=@ref+1 where brnno=@BRANCH
		if @@error<>0
		begin
			rollback transaction
			SET @RET_ID = -1
			SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
			set @errstatus =-1
			goto jumplbl
		end

		insert into sales_hd 
		(slcenter,branch ,company ,invtype ,ref ,invdate,custno ,custnm ,glser,dsctype ,pstmode
		,fcy,fcyrate,duedate ,invttl,invcst,invdspc ,invdsvl ,valafds ,invpaid ,caser ,entries
		,released,posted ,fixrate ,extamt,extser ,pricetp,ischeque ,chkno ,chkdate ,lastupdt,jvgenrt
		,cccommsn ,belowbal,fcy2,ccpayment ,rplsamt,pdother ,slcode,prpaidamt,instldays ,instflag
		,slcmnd ,inv_printed ,bendit ,modified ,rqstorder ,rqststld ,carrier ,rcvdtrn ,usrid ,address
		,suspend ,rtnref,ispurchase ,stkjvno ,posinv ,sanedcrd_amt)
		values (@SLCNTR,'Q',@BRANCH,@ltrtype,@ref,@lfdate,@lcustcode ,@hcustnm,'','',0,
		'',0,@ldudate,0,0,0,0,0,0,@hcaser,0,
		0,0,0,0,'','1',0,'','',@lfdate,0,
		0,0,'',0,0,0,@SLPRSN ,0,0,0,
		0,0,0,1,0,0,'',0,@USRID ,@haddress,
		0,0,0,0,4,0)
		if @@error<>0
		begin
			rollback transaction
			SET @RET_ID = -2
			SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))    
			set @errstatus =-2
			goto jumplbl
		end
-----------------------------------------------------------------------------
	--
	--- insert one record in STHDR
	-- 

	 insert into sthdr (branch, trtype, ref, trdate, text, amnttl, costttl, sysdate, src, released,
	 posted, fcy, fcyrate, whno, entries, lastupdt, towhno, modified, rcvdtrn, custno, usrid, brsupp,
	 tobrno, brxref, glref, isbrtrx, asmtype, repost )
	 values(@branch ,@ltrtype,@ref ,@lfdate,@hcustnm,0,0,@lfdate,'05',0,
	       0,'',0,'',0,@lfdate,'',0,0,@lcustcode ,@usrid,'',
		   '',0,0,0,0,0)

		if @@error<>0
		begin
			rollback transaction
			SET @RET_ID = -3
			SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))    
			set @errstatus =-3
			goto jumplbl
		end
		--
		-- Insert One Record in GLJRHR
		--
		set @ljhfcflag=2
		insert into gljrhdr (jhcomp,jhtype,jhref,jhcurr,jhamt,jhdate,jhrate,jhtext,jhsrc,jhfcflag,jhreleased,jhposted,
		jhsysdate,modified,[Suspend],usrid,lastupdt,rcvdtrn,isbrtrx,brxref,brxfrm,jhcustno) 
		values (@branch,@ltrtype,@ref,'',0,@lfdate,0,@hcustnm,'05',
		@ljhfcflag,0,0,@lfdate,1,0,@USRID ,@lfdate,0,0,'','','')
		if @@error<>0
		begin
			rollback transaction
			SET @RET_ID = -4
			SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
			set @errstatus =-4
			goto jumplbl
		end  
	-------------------------------------get_client_bal

    if @errstatus=0
	begin
	    if @syscode <> 6
		begin
			DECLARE Cursdtl CURSOR LOCAL FAST_FORWARD FOR
			Select a.barcode,shdqty,frtqty,price,pack0,pkqty1,lcost,substring(c.classkey,1,2) as classkey,
			cmbkey,b.itemno,b.unicode,pack1
			From #TEMPSLINV_PDA a inner join stunits b on a.barcode=b.barcode 
			inner join stitems c on b.itemno=c.itemno
		end
		else
		begin
			DECLARE Cursdtl CURSOR LOCAL FAST_FORWARD FOR
			Select a.barcode,shdqty,frtqty,price,pack0,d.pkqty as pkqty1,lcost,substring(c.classkey,1,2) as classkey,
			b.cmbkey,b.itemno,b.unicode,d.pack as pack1
			From #TEMPSLINV_PDA a inner join stitembc d on a.barcode=d.pbarcode 
			inner join stunits b on d.itemno=b.itemno and d.unicode=b.unicode
			inner join stitems c on b.itemno=c.itemno
		end
		open Cursdtl 
		Fetch Next From Cursdtl Into @lbarcode,@lshdqty,@lfrtqty,@lprice,@lpack,@lpkqty,@llcost,@lclasskey,
									@lcmbkey,@litemno,@lunicode,@lpack1
	
	  	set @ch_cnt  =0
		set @l_crtot =0
		set @f_crtot =0
		set @l_dbtot =0
		set @f_dbtot =0
		set @m_value=0
		set @m_fcval=0
		set @xttl_cost=0
		set @lslptr=0
		set @lstptr=0
		set @lttl_inv=0
				
		set @ttl_class_dsc=0
		set @dsc_ptr=0
		set @xttl_cost=0
		set @inv_stk=0
		set @inv_lftt=0
		set @inv_lmtt=0
		set @m_lccntr=0
		set @m_fccntr=0
		set @arr_ptr=0
		WHILE dbo.FetchStatusOfCursorNamed('Cursdtl') = 0 
		begin
		    set @lnobinno=1
			set @lastbinno=space(6)
		    set @lpkqty=isnull(@lpkqty,1)
			set @lpkqty=iif(@lpkqty=0,1,@lpkqty)
			set @qty=@lfrtqty+(@lshdqty*@lpkqty)
			set @avail_qty=0
			set @lcost=0
			set @lclasskey=iif(isnull(@lclasskey,'')='','',@lclasskey)
			set @lclasskey=rtrim(@lclasskey)+replicate(space(1),12-datalength(rtrim(@lclasskey)))	
			set @cl_slser=''		 
			select @cl_slser=iif(@ltrtype='06',SERCSH,SERCRD),@clsname=name,@cstcode=cstcode,@dscact=serdsc
				from slclass with (NOLOCK) where company=@BRANCH and cmbkey=@lclasskey
			if rtrim(isnull(@cl_slser,''))='' 
			begin
				set @lsl_acfm=3
				set @lds_acfm=3
				set @lgclass=''
			end
			else
			begin
				set @lsl_acfm=2
				set @lds_acfm=2
				set @lgclass=rtrim(@lclasskey)
			end
			set @m_vl=-iif(@syscode<>6,(@qty*@lprice),@lshdqty*@lprice)
			set @m_fc=0.00
			set @inv_lftt=@inv_lftt+abs(@m_vl)
			set @inv_lmtt=@inv_lmtt+Abs(@m_vl)   
			set @inv_stk=@inv_stk+Abs(@m_vl) 
			if @lsl_acfm=2
			begin 
				set @xclkey=''
				select @xclkey=clkey from  @class_arr where clkey=@lclasskey
				if rtrim(isnull(@xclkey,''))=''
				begin
					set @arr_ptr+=1
					insert into @class_arr values (@arr_ptr,@lclasskey,@cl_slser,@m_vl,@clsname,@cstcode,@dscact)
				end
				else update @class_arr set lcamt=lcamt+@m_vl where clkey=@lclasskey
			end
			if @lsl_acfm=3
			begin
				set @m_lccntr=@m_lccntr+@m_vl
				set @m_fccntr=@m_fccntr+@m_fc
			end

			set @lttl_inv=@lttl_inv+abs(@m_vl)
			set @avail_qty=0

			if @lbelowbal = 0 and @lcaalwngtvs=0
			begin
				select @avail_qty=sum(qty-rsvqty) from stbins where branch=@BRANCH and itemno=@litemno and unicode=@lunicode
				and whno=@lwhno 
				set @avail_qty=isnull(@avail_qty,0)
				if @qty>@avail_qty
				begin
					rollback transaction
					SET @RET_ID = -5
					SET @STR_MSG = 'الكمية تجاوزت الرصيد المتاح للصنف '+' '+@lcmbkey
					set @errstatus =-5
					break
				end
			end
			set @subttlcost=0
			set @lt_qty=@qty
            DECLARE lstbins CURSOR LOCAL FAST_FORWARD FOR
			select binno,qty-rsvqty as qty,lcost from stbins where branch=@branch and
			itemno=@litemno and unicode=@lunicode and whno=@lwhno
			open lstbins;
			fetch next from lstbins into @bbinno,@brmnqty,@blcost
			WHILE dbo.FetchStatusOfCursorNamed('lstbins') = 0 and @lt_qty>0
			begin
				set @lnobinno=0
				set @lastbinno=@bbinno
				if @brmnqty>0
				begin
					if @lt_qty>@brmnqty set @lxq=@brmnqty
					else set @lxq=@lt_qty
					set @lstptr=@lstptr+1
					insert into stdtl (itemno, unicode, branch, trtype, qty, fqty, whno, binno, lcost, trdate, ref,
						sysdate, src, lprice, fcost, fprice, expdate, towhno, tobinno, barcode, cmbkey, discpc, pack,
						shdpk, shdqty, folio, rplct_post)
					values(@litemno,@lunicode,@BRANCH,@ltrtype,@lxq,0,@lwhno,@bbinno,@blcost,@lfdate,
					@ref,@lfdate,'05',@lprice,0,0,'','','',@lbarcode,@lcmbkey,0,@lpack,1,@lxq,@lstptr,0)
					if @@error<>0
					begin
						rollback transaction
						SET @RET_ID = -6
						SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))    
						set @errstatus =-6
						break
					end
					set @subttlcost=@subttlcost+(@blcost*@lxq)
					set @lt_qty=@lt_qty-@lxq
	--
	-- Update the RSVQTY of stbins
	--
					update stbins set rsvqty=rsvqty+@lxq where branch=@BRANCH and
							itemno=@litemno and unicode=@lunicode and whno=@lwhno and binno=@bbinno
					if @@error<>0
					begin
						rollback transaction
						SET @RET_ID = -7
						SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
						set @errstatus =-7
						break
					end
				end
				if @lt_qty<=0 break					
				fetch next from lstbins into @bbinno,@brmnqty,@blcost
			end				  
			close lstbins
			deallocate lstbins
			if @errstatus<0 break

			if @lt_qty>0
			begin
			    set @hbelowbal = 1
				if @lnobinno=1
				begin
					set @ldummy=''
					select @ldummy=cmbkey from stunits with (NOLOCK) where itemno=@litemno and unicode=@lunicode
					if RTRIM(isnull(@ldummy,''))<>''
					begin
						insert into stbins (itemno,unicode,lcost,whno,branch,binno,fcost,openlcost,openfcost,openbal,qty,rsvqty,expdate) values
						(@litemno,@lunicode,@llcost,@ldp_mainwh,@BRANCH,@lastbinno,0,0,0,0,0,0,' ')
			    		if @@error<>0
						begin
							rollback transaction
							SET @RET_ID = -8
							SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
							set @errstatus =-8
							break
						end
					end						                           
				end
				set @lstptr=@lstptr+1
				set @lxq=@lt_qty
				if @lnobinno=0 and @blcost>0 set @llcost=@blcost
				insert into stdtl (itemno, unicode, branch, trtype, qty, fqty, whno, binno, lcost, trdate, ref,
						sysdate, src, lprice, fcost, fprice, expdate, towhno, tobinno, barcode, cmbkey, discpc, pack,
						shdpk, shdqty, folio, rplct_post)
				values(@litemno,@lunicode,@BRANCH,@ltrtype,@lxq,0,@lwhno,@lastbinno,
				@llcost,@lfdate,
				@ref,@lfdate,'05',@lprice,0,0,'','','',@lbarcode,@lcmbkey,0,@lpack,1,@lxq,@lstptr,0)
			    if @@error<>0
				begin
					rollback transaction
					SET @RET_ID = -9
					SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))    
					set @errstatus =-9
					break
				end
				set @subttlcost=@subttlcost+(@llcost*@lxq)
				update stbins set rsvqty=rsvqty+@lxq where branch=@BRANCH and
					itemno=@litemno and unicode=@lunicode and whno=@lwhno and binno=@lastbinno
			    if @@error<>0
				begin
					rollback transaction
					SET @RET_ID = -10
					SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
					set @errstatus =-10
					break
				end
			end   -- end of @lt_qty>0

			update stunits set rsvqty=rsvqty+@qty where itemno=@litemno and unicode=@lunicode	
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -11
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
				set @errstatus =-11
				break
			end
---------------------------------------------------------------------------------------------------------------------
            set @ldiscpc=0
			set @llcost=@subttlcost/(@qty)
			set @xttl_cost=@xttl_cost+(@qty*@llcost)
			set @lslptr=@lslptr+1
			if @syscode in (4,5,8,9)
				insert into sales_dt (slcenter, company, invtype, ref, invdate, itemno, unicode, qty, fqty, price, discpc,
					cost, ds_acfm, sl_acfm, gclass, custno, fcy, barcode, imfcval, pack, pkqty, shadd, shdpk, shdqty, frtqty, rtnqty, whno, 
					cmbkey, folio, rplct_post, sold_item_status)
				values(@SLCNTR,@BRANCH,@ltrtype,@ref,@lfdate,@litemno,@lunicode,
				@qty,0,@lprice,@ldiscpc,@llcost,@lds_acfm,@lsl_acfm,@lgclass,'','',@lbarcode,0,@lpack,1,
				@lpack1,@lpkqty,@lshdqty,@lfrtqty,0,@lwhno,@lcmbkey,@lslptr,0,0)
			else
			    if @syscode=6
				    insert into sales_dt (slcenter, company, invtype, ref, invdate, itemno, unicode, qty, fqty, price, discpc,
						cost, ds_acfm, sl_acfm, gclass, custno, fcy, barcode, imfcval, pack, pkqty, shadd, shdpk, shdqty, frtqty, rtnqty, whno, 
						cmbkey, folio, rplct_post, sold_item_status)
					values(@SLCNTR,@BRANCH,@ltrtype,@ref,@lfdate,@litemno,@lunicode,
					@lshdqty,0,@lprice,@ldiscpc,@llcost,@lds_acfm,@lsl_acfm,@lgclass,'','',@lbarcode,0,@lpack1,@lpkqty,
					'',0,0,0,0,@lwhno,@lcmbkey,@lslptr,0,0)
				else
				insert into sales_dt (slcenter, company, invtype, ref, invdate, itemno, unicode, qty, fqty, price, discpc,
					cost, ds_acfm, sl_acfm, gclass, custno, fcy, barcode, imfcval, pack, pkqty, shadd, shdpk, shdqty, frtqty, rtnqty, whno, 
					cmbkey, folio, rplct_post, sold_item_status)
				values(@SLCNTR,@BRANCH,@ltrtype,@ref,@lfdate,@litemno,@lunicode,
				@qty,0,@lprice,@ldiscpc,@llcost,@lds_acfm,@lsl_acfm,@lgclass,'','',@lbarcode,0,@lpack,1,
				'',0,0,0,0,@lwhno,@lcmbkey,@lslptr,0,0)
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -12
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
				set @errstatus =-12
				break
			end
---------------------------------------------------------------------------------------------------------------------			
		    Fetch Next From Cursdtl Into @lbarcode,@lshdqty,@lfrtqty,@lprice,@lpack,@lpkqty,@llcost,@lclasskey,
									@lcmbkey,@litemno,@lunicode,@lpack1
		END
		CLOSE Cursdtl 
		DEALLOCATE Cursdtl

		if @errstatus =0 and @lslptr>0
		begin
				
			set @pd_lc=@lttl_inv
			set @opstval=''
			set @diff_amt=0
			set @new_rate=0
			set @match_image=0
			set @hinvpaid=0
			set @hvalafds = @lttl_inv
			if @ltrtype='06' set @hinvpaid=@lttl_inv
				
				    
					
            set @opstval=@hcustnm

			--
			-- Process GLJRDTL entries
			--
			set @ch_cnt +=1
			set @m_value=@pd_lc
			set @m_fcval=0
			insert into gljrdtl 
			(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
			values (@BRANCH,@ltrtype,@ref,@dbtglacct,@lfdate,@opstval,
			abs(@pd_lc),iif(@m_sign*@pd_lc<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@lfdate,'05',0,0,'','','',0,0,0)	
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -13
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
				set @errstatus =-13
				goto jumplbl
			end
			If @m_value<0
			begin
				set @l_crtot=@l_crtot+Abs(@m_value)
				set @f_crtot=@f_crtot+Abs(@m_fcval)
			end
			Else
			begin
				set @l_dbtot=@l_dbtot+Abs(@m_value)
				set @f_dbtot=@f_dbtot+Abs(@m_fcval)
			End	
------------------------------------  Process GLdtl on the class level  ----------------------------------
            if @arr_ptr>0
			begin
				while @arr_ptr>0
				begin
					set @cl_slser=''
					set @dscact=''
					set @cstcode=''
					set @m_vl=0
					select @cl_slser=act,@m_vl=lcamt,@clsname=clsname,@cstcode=cstcode,@dscact=dscact,@xclkey=clkey
					from @class_arr
					where p_ptr=@arr_ptr
					if isnull(@cl_slser,'')<>'' and isnull(@m_vl,0)<>0
					begin
						set @m_value=@m_vl
						set @m_fcval=0
						set @opstval='مبيعات قسم'+' '+rtrim(@clsname)
						set @ch_cnt +=1
						insert into gljrdtl 
						(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                        ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
						values (@BRANCH,@ltrtype,@ref,@cl_slser,@lfdate,@opstval,
						abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@lfdate,'05',0,0,'','','',0,0,0)	
						if @@error<>0
						begin
							rollback transaction
							SET @RET_ID = -14
							SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
							set @errstatus =-14
							goto jumplbl
						end
						if @lcaokcstctr=1 and isnull(@cstcode,'')<>''
						begin
							insert into gljrcost (company,jdtype,jdref,cstcode,jdkey,jdcurr,Xpercent,amt,jddbcr
							,jdfc_imgval,jdfolno,rplct_post)
							values (@BRANCH,@ltrtype,@ref,@cstcode,@cl_slser,'',0,abs(@m_value),
							iif(@m_sign*@m_value<0,'C','D'),0,@ch_cnt,0)
							if @@error<>0
							begin
								rollback transaction
								SET @RET_ID = -15
								SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
								set @errstatus =-15
								goto jumplbl
							end
						end
						If @m_value<0
						begin
							set @l_crtot=@l_crtot+Abs(@m_value)	
							set @f_crtot=@f_crtot+Abs(@m_fcval)					
						end
						Else
						begin
							set @l_dbtot=@l_dbtot+Abs(@m_value)	
							set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
						End	
					end
					set @arr_ptr-=1
				end  -- end of @arr_ptr loop
            end  ----  end of @arr_ptr
----------------------------------------------------------------------------------------------------------------					
				
			If @m_lccntr<>0 Or @m_fccntr<>0
			begin
				set @m_value=@m_lccntr
				set @m_fcval=@m_fccntr
				set @opstval='مبيعات نقدية'
				set @ch_cnt +=1
				insert into gljrdtl 
				(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                        ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
				values (@BRANCH,@ltrtype,@ref,@ldp_slser,@lfdate,@opstval,
				abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@lfdate,'05',0,0,'','','',0,0,0)	
				if @@error<>0
				begin
					rollback transaction
					SET @RET_ID = -16
					SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
					set @errstatus =-16
					goto jumplbl
				end
--					
----------- For Cost center process
--
				if @lcaokcstctr=1 and isnull(@lcstctr,'')<>''
				begin
					insert into gljrcost (company,jdtype,jdref,cstcode,jdkey,jdcurr,Xpercent,amt,jddbcr
					,jdfc_imgval,jdfolno,rplct_post)
					values (@BRANCH,@ltrtype,@ref,@lcstctr,@ldp_slser,'',0,abs(@m_value),
					iif(@m_sign*@m_value<0,'C','D'),0,@ch_cnt,0)
					if @@error<>0
					begin
						rollback transaction
						SET @RET_ID = -17
						SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
						set @errstatus =-17
						goto jumplbl
					end
				end
				If @m_value<0
				begin
					set @l_crtot=@l_crtot+Abs(@m_value)	
					set @f_crtot=@f_crtot+Abs(@m_fcval)					
				end
				Else
				begin
					set @l_dbtot=@l_dbtot+Abs(@m_value)	
					set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
				End	
			end  -- end of @m_lccntr
--------------------------------------------------------------------------
		-----------------Update gljrhdr


			update gljrhdr set jhfcflag=2,jhentries=@ch_cnt,jhlccrttl = @l_crtot,
			jhfccrttl= @f_crtot,jhlcdbttl = @l_dbtot,jhfcdbttl = @f_dbtot,
			jhamt = Iif(@inv_lmtt>@l_dbtot,@inv_lmtt,@l_dbtot) where jhcomp=@BRANCH  and jhtype=@ltrtype and
			jhref=@ref
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -18
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
				set @errstatus =-18
				goto jumplbl
			end
				
	--------- Update sthdr
			If @lstptr>0
			begin
				update sthdr set entries=@lstptr,amnttl = @inv_stk,costttl = @xttl_cost where branch=@BRANCH 
				and trtype=@ltrtype and ref=@ref
			end
			else  delete from sthdr where branch=@BRANCH and trtype=@ltrtype and ref=@ref
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -19
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
				set @errstatus =-19
				goto jumplbl
			end
	--    Update sales_hd
			update sales_hd set entries=@lslptr,valafds = @lttl_inv,invttl=@lttl_inv,invcst=@xttl_cost,belowbal=@hbelowbal
			where company=@BRANCH and invtype=@ltrtype and ref=@ref
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -20
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
				set @errstatus =-20
				goto jumplbl
			end
			if @ltrtype='04'
			begin
			     insert into arhdr
			     (hd_company, hd_type, hd_ref, hd_date, hd_fcy, hd_ftotal, hd_fcyrate, hd_ltotal, hd_cucode, 
				 hd_desc1, hd_ser, hd_rlsd, hd_posted, hd_trxsrc, hd_sysdate, hd_lcnet, hd_fcnet, hd_lccnet,
				 hd_fccnet, isit_opst, opst_val, opst_fcy, lastupdt, modified, rcvdtrn, usrid, clcode, clcmnd,
				 dscamt, payinv) 
				 values (@BRANCH,@ltrtype,@ref,@lfdate,'',0,0,@lttl_inv,@lcustcode,
				 @hcustnm,'',0,0,'05',@lfdate,@lttl_inv,0,0,
				 0,0,0,'',@lfdate,1,0,@USRID,'',0,0,0)
				if @@error<>0
				begin
					rollback transaction
					SET @RET_ID = -21
					SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
					set @errstatus =-21
					goto jumplbl
				end

				insert into ardtl 
				(dt_company, dt_type, dt_ref, dt_date, dt_lcamt, dt_paidamt, dt_discamt, dt_cucode, dt_fcy,
				 dt_trxsrc, dt_fcamt, dt_fpydamt, dt_fdscamt, dt_lcaloc, dt_fcaloc, dt_aloctd, dt_pdinv, dt_duedate,
                 dt_desc, dt_chkno, dt_chkdate, dt_chkbnk, dt_dbcr, dt_ackey, dt_folio, dt_rcvno, dt_lstdate,
				 tdscdays, tdscpcs, match, rplct_post)
				 values(@BRANCH,@ltrtype,@ref,@lfdate,@lttl_inv,0,0,@lcustcode,'',
				 '05',0,0,0,0,0,'0',0,@lfdate,
				 @hcustnm,'','','','D','',1,0,'',
				 0,0,0,0)
				 if @@error<>0
				begin
					rollback transaction
					SET @RET_ID = -22
					SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
					set @errstatus =-22
					goto jumplbl
				end
			end
		end
	end
	jumplbl:
	if @errstatus=0 commit transaction
	IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'#TEMPSLINV_PDA'))
	DROP TABLE [#TEMPSLINV_PDA]
    return @errstatus
END TRY
	BEGIN CATCH
	    if @@TRANCOUNT>0 ROLLBACK TRANSACTION
		SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  

		SET @RET_ID = -99
		IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'#TEMPSLINV_PDA'))
		DROP TABLE [#TEMPSLINV_PDA]
		--insert into TMP(FLD)values(@STR_MSG)
		RETURN -99
END CATCH
	
END





















GO
/****** Object:  StoredProcedure [dbo].[Api_Insert_ar_cashrcvd]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Api_Insert_ar_cashrcvd]

@STR_MSG NVARCHAR(1000) out, ---- return text error
@branch char(2), 
@ltrtype char(2),       ----- transaction type 02 cash received 09 cheque received  28 Transfer received money
@lsc_code char(6),      ----- Section code 
@lcustcode varchar(6),  ----- Client number
@lcashacc varchar(19),  ----- Cash account / Bank account 
@lvchramt float,        ----- Received amount
@lvchrdesc varchar(70), ----- Description
@RET_ID INT out,        ----- error return code
@USRID varchar(10)      ----- user id

AS BEGIN 
   set lock_timeout 2000
	declare 
	@dbc nvarchar(14),
	@lcalcomp char(2),
	@yrcode char(4),
	@syscode int =2,
	@lPVT_level numeric(1,0) =0,
	@lSctnHasSerial bit =0,
	@loksctions bit =0,
	@lcu_name varchar(50),
	@cstclass char(2),
	@cstcu_ctlser varchar(19),
	@crtglacct varchar(19),
	@ref int ,
	@lfdate char(8),
	@ldbcr char(1),
	@ldate varchar(10),
	@lusing_hij_date bit

	set @RET_ID=0
	set @STR_MSG=''

	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
	SET @lusing_hij_date=iif(cast(substring(@dbc,7,2) as int)>40,1,0)

	declare @usrcv bit=0,@uschqrcv bit=0;

	select @usrcv=usrcv,@uschqrcv=uschqrcv from sysuse with(nolock) where username = @USRID;
	if @usrcv = 0 or @uschqrcv = 0
	begin
		SET @RET_ID = -10
		SET @STR_MSG = 'ERROR INFO:- NUMBER : -10 , MESSAGE : لا تملك صلاحية, ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
		select @RET_ID;
		return
	end

	if @lusing_hij_date=1
	begin
		set @ldate =convert(varchar(10),getdate(),131)
		set @lfdate=substring(@ldate,7,4)+substring(@ldate,4,2)+iif(substring(@ldate,1,1)=' ','0'+substring(@ldate,2,1),substring(@ldate,1,2))
	end
	else
	begin
		set @ldate = convert(varchar(10),getdate(),112)
		set @lfdate=@ldate		
	end

	select @syscode=isnull(sysno,2),
    @lPVT_level=isnull(SysNo_PVT_level,0),@loksctions=isnull(oksctions,0),@lSctnHasSerial=isnull(SctnHasSerial,0)
    from sysdb.dbo.glcalend where calcomp=@lcalcomp and yrcode=@yrcode

    -- take values from glsction
	declare @ltmpsccode char(6)
	set @ltmpsccode=''
	if len(@lsc_code)>0 and @loksctions=1 and @lSctnHasSerial=1
	begin
		select @ltmpsccode=sc_code from glsction where sc_company=@branch and sc_code=@lsc_code
		if @ltmpsccode is null set @lsc_code=''
	end	

	if len(@lsc_code)>0 and @loksctions=1 and @lSctnHasSerial=1 set @ref=dbo.get_last_ref_section(@ltrtype,@branch,@lsc_code)
	else set @ref=dbo.get_last_ref(@ltrtype,@branch)
					 
	begin transaction   
	if len(@lsc_code)>0 and @loksctions=1 and @lSctnHasSerial=1
	begin
		if @ltrtype='02' update glsction set jv_02=@ref+1 where sc_company=@branch and sc_code=@lsc_code
		else 
		if @ltrtype='09' update glsction set jv_09=@ref+1 where sc_company=@branch and sc_code=@lsc_code
		else
		if @ltrtype='28' update glsction set jv_28=@ref+1 where sc_company=@branch and sc_code=@lsc_code
		else
		begin
			rollback transaction
			set  @RET_ID = -1
			return
		end
	end
	else
	if @ltrtype='02' update stbranch set jv_02=@ref+1 where brnno=@branch
	else 
	if @ltrtype='09' update stbranch set jv_09=@ref+1 where brnno=@branch
	else
	if @ltrtype='28' update stbranch set jv_28=@ref+1 where brnno=@branch
	else
	begin
		rollback transaction
		set  @RET_ID = -2
		return
	end

	if @@error<>0
	begin
		rollback transaction
		set  @RET_ID = -3
        SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
		return
	end
	commit transaction   								

	set @ldbcr=iif(@ltrtype in ('02','09','28'),'C','D')
	set @lcu_name=''
	if len(rtrim(@lcustcode))>0
	begin
		select @lcu_name=cu_name,@cstclass=cu_class,@cstcu_ctlser=cu_ctlser
		from customer where cu_company=@branch and cu_code=@lcustcode
		if len(isnull(@cstcu_ctlser,''))>0  set @crtglacct=@cstcu_ctlser
		else
		begin
			select @crtglacct=cl_crlser from classfil where cl_company=@BRANCH and cl_code=@cstclass
		end
	end

	begin transaction

	set  @RET_ID = @ref;
	
	insert into arhdr
	(hd_company, hd_type, hd_ref, hd_date, hd_fcy, hd_ftotal, hd_fcyrate, hd_ltotal, hd_cucode, 
	hd_desc1, hd_ser, hd_rlsd, hd_posted, hd_trxsrc, hd_sysdate, hd_lcnet, hd_fcnet, hd_lccnet,
	hd_fccnet, isit_opst, opst_val, opst_fcy, lastupdt, modified, rcvdtrn, usrid, clcode, clcmnd,
	dscamt, payinv) 
	values (@BRANCH,@ltrtype,@ref,@lfdate,'',0,0,@lvchramt,@lcustcode,
	@lvchrdesc,@lcashacc,0,0,'02',@lfdate,@lvchramt,0,0,
	0,0,0,'',@lfdate,1,0,@USRID,'',0,0,0)
	if @@error<>0
	begin
		rollback transaction
		SET @RET_ID = -5
		SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
	    return
		--goto jumplbl
	end

	insert into ardtl 
	(dt_company, dt_type, dt_ref, dt_date, dt_lcamt, dt_paidamt, dt_discamt, dt_cucode, dt_fcy,
		dt_trxsrc, dt_fcamt, dt_fpydamt, dt_fdscamt, dt_lcaloc, dt_fcaloc, dt_aloctd, dt_pdinv, dt_duedate,
        dt_desc, dt_chkno, dt_chkdate, dt_chkbnk, dt_dbcr, dt_ackey, dt_folio, dt_rcvno, dt_lstdate,
		tdscdays, tdscpcs, match, rplct_post)
		values(@BRANCH,@ltrtype,@ref,@lfdate,@lvchramt,0,0,@lcustcode,'',
		'02',0,0,0,0,0,'0',0,@lfdate,
		@lcu_name,'','','',@ldbcr,'',1,0,'',
		0,0,0,0)
		if @@error<>0
	begin
		rollback transaction
		SET @RET_ID = -6
		SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
--		set @errstatus =-22
		return
	end

		--
		-- Insert One Record in GLJRHR
		--
	
	insert into gljrhdr (jhcomp,jhtype,jhref,jhcurr,jhamt,jhdate,jhrate,jhtext,jhsrc,jhfcflag,jhreleased,jhposted,
	jhsysdate,modified,[Suspend],usrid,lastupdt,rcvdtrn,isbrtrx,brxref,brxfrm,jhcustno,jhentries,jhlccrttl,jhlcdbttl) 
	values (@branch,@ltrtype,@ref,'',@lvchramt,@lfdate,0,@lvchrdesc,'02',
	2,0,0,@lfdate,1,0,@USRID ,@lfdate,0,0,'','','',2,@lvchramt,@lvchramt)
	if @@error<>0
	begin
		rollback transaction
		SET @RET_ID = -7
		SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
		--set @errstatus =-4
		return
	end 
-------- First entry line in gljrdtl ---------------------------------------------------------------------------
	insert into gljrdtl 
	(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
        ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post,taxcatId )
	values (@BRANCH,@ltrtype,@ref,@crtglacct,@lfdate,@lvchrdesc,
	@lvchramt,'C',0,'',1,1,@lfdate,'02',0,0,'','','',0,0,0,0)	
	if @@error<>0
	begin
		rollback transaction
		SET @RET_ID = -8
		SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
		--set @errstatus =-13
		return
	end
-------- Second entry line in gljrdtl ---------------------------------------------------------------------------
	insert into gljrdtl 
	(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
        ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post,taxcatId )
	values (@BRANCH,@ltrtype,@ref,@lcashacc,@lfdate,@lvchrdesc,
	@lvchramt,'D',0,'',2,2,@lfdate,'02',0,0,'','','',0,0,0,0)	
	if @@error<>0
	begin
		rollback transaction
		SET @RET_ID = -9
		SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
		--set @errstatus =-13
		select @RET_ID;
		return
	end
	else
	begin
	commit transaction;
	select @RET_ID;
	end
end





GO
/****** Object:  StoredProcedure [dbo].[Api_InsertPO]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_InsertPO] 

	@slcenter char(2) , @branch char(2) , @invtype char(2) , @company char(2) , @rref numeric(6,0) , @invdate char(8) , @custno char(6) , @custnm varchar(50) , @glser char(19) ,
	@dsctype char(2) , @pstmode numeric(1,0) , @fcy char(3) , @fcyrate numeric(7,2) , @duedate char(8) , @invttl float , @invcst float , @invdspc float , @invdsvl float ,
	@valafds float , @invpaid numeric(14,2) , @caser char(19) , @entries numeric(5,0) , @released bit , @posted bit , @fixrate numeric(7,2) , @extamt float , @extser char(19) ,
	@pricetp char(1) , @ischeque bit , @chkno char(8) , @chkdate char(8) , @lastupdt char(8) , @jvgenrt bit , @imfcval numeric(14,5) , @slcode char(2) , @modified bit,
	@rcvdtrn bit , @remarks varchar(65) , @remarks2 varchar(65) , @usrid char(10) , @vat_amt_rcvd float , @taxfree_sales float , @clnt_taxcode varchar(20) , @clnt_kind char(1) ,
	@PriceVatType numeric(1,0) , @qhtype char(1) , @qhstatus char(1) , @newcstmrname varchar(50) , @newcstmrcntct varchar(50) , @cstmrmobile varchar(50) , @ord_dtl varchar(max)
	AS
		declare @rowno int ;
	Begin
		exec sp_xml_preparedocument @rowno output , @ord_dtl ;
		IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[#TEMPSLINV_ANDROID]') AND type in (N'U'))
			begin
			DROP TABLE [dbo].[#TEMPSLINV_ANDROID]
			end

		------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
		declare @syscode int ;
		declare @comp char(2) , @yrcode varchar(4) ;
		set @comp=substring(db_name(),4,2);
		set @yrcode=substring(db_name(),7,2);
		set @yrcode=iif(cast(@yrcode as int)>40,'14','20')+rtrim(@yrcode)

		select	@syscode=sysno	from sysdb.dbo.glcalend with (nolock) where calcomp=@comp and yrcode=@yrcode;
		--------------------------------------------------------------------------------------------------------------------------- 
		select @clnt_taxcode = clnt_taxcode , @clnt_kind = cu_kind from customer where cu_company = @branch and cu_code = @custno
		
	Begin Try
		Begin TRANSACTION
		
		declare @ref numeric(6,0) ;
		declare @isl_c bit ;
		declare @splyinv varchar(20);
		declare @closed bit;
		declare @processed bit;
		declare @vat_amt_paid float;

		set @ref = (select max(ref) from ord_hdr with(nolock) where company = @company and branch = @branch) + 1;
		set @ref = IIF(@ref is null or @ref =0 ,1,@ref);

		

				
			INSERT INTO [dbo].[ord_hdr]
				([branch],[company],[ref],[invdate],[custno],[custnm],[glser],[fcy],[fcyrate],[invttl],[invcst],[invdspc],[invdsvl],[valafds]
				,[invpaid],[caser],[entries],[fixrate],[lastupdt],[isl_c],[modified],[splyinv].[closed],[processed],[rcvdtrn],[usrid],[vat_amt_paid])
			VALUES
				(@branch , @company , @ref , @invdate , @custno , @custnm , @glser , @fcy , @fcyrate , @invttl , @invcst ,@invdspc , @invdsvl ,@valafds , @invpaid 
				, @caser , @entries , @fixrate , @isl_c, @modified ,@splyinv , @closed , @processed , @rcvdtrn, @usrid , @vat_amt_paid);

		select branch /*was slcenter*/ , company , rref , invdate , itemno , unicode , itemdesc , qty , fqty , price , discpc , cost , ds_acfm , sl_acfm , gclass ,
		custno ,fcy , barcode , imfcval , pack , pkqty , shadd , shdpk , shdqty , frtqty , cmbkey , folio , slqtn_item_status , whno
		into [dbo].[#TEMPSLINV_ANDROID]
		from openxml(@rowno , 'Root/ord_dtl',2)
		with (branch char(2) , company char(2) , rref numeric(6,0) , invdate char(8) , itemno char(16) , unicode char(6) , itemdesc char(30),
		qty float , fqty numeric(10,3) , price float , discpc numeric(6,2) , cost float ,  ds_acfm numeric(1,0) , sl_acfm numeric(1,0) , gclass char(8) , custno char(6),
		fcy char(3) , barcode char(20) , imfcval float , pack char(1) , pkqty numeric(9,3) , shadd char(1) , shdpk numeric(9,3) ,shdqty numeric(9,3) ,
		frtqty numeric(12,3), cmbkey char(24) , folio numeric(4,0) , slqtn_item_status numeric(1,0) , whno char(2) );
		
		if @syscode = 6
		begin
			update [dbo].[#TEMPSLINV_ANDROID] set branch = @branch , company = @company , rref = @ref , itemno = s1.itemno , unicode = s1.unicode ,
			cost = s2.lcost , pack = s1.pack , pkqty = s1.pkqty , shadd = s2.pack1 , shdpk = s2.pkqty1 , qty = (shdqty * s1.pkqty) + frtqty 
			from stitembc s1 inner join stunits s2 on s1.itemno = s2.itemno and s1.unicode = s2.unicode 
			where s1.pbarcode = [dbo].[#TEMPSLINV_ANDROID].[barcode];
			
			insert into ord_dtl 
			select *,0 from [dbo].[#TEMPSLINV_ANDROID] ;
		end
		else
		begin
			update [dbo].[#TEMPSLINV_ANDROID] set branch = @branch , company = @company , rref = @ref , itemno = s1.itemno , unicode = s1.unicode ,
			cost = s1.lcost , pack = s1.pack0 , shadd = s1.pack1 , shdpk = s1.pkqty1 , qty = (shdqty * s1.pkqty1) + frtqty , barcode = s1.barcode
			from stunits s1 where s1.cmbkey = [dbo].[#TEMPSLINV_ANDROID].cmbkey
			insert into ord_dtl 
			select *,0 from [dbo].[#TEMPSLINV_ANDROID] 
		end

		DROP TABLE [dbo].[#TEMPSLINV_ANDROID]
		Commit Tran;
	End Try
	begin catch
			 ROLLBACK TRANSACTION;
			 INSERT INTO dbo.DB_Errors VALUES (SUSER_SNAME(),   ERROR_NUMBER(),   ERROR_STATE(),   ERROR_SEVERITY(),   ERROR_LINE(),   ERROR_PROCEDURE(),   ERROR_MESSAGE(),   GETDATE());
	end catch
			select ref from ord_dtl with(nolock) where ref  = @ref;
End









GO
/****** Object:  StoredProcedure [dbo].[Api_InsertQh]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Api_InsertQh] 

	@slcenter char(2) , @branch char(2) , @invtype char(2) , @company char(2) , @rref numeric(6,0) , @invdate char(8) , @custno char(6) , @custnm varchar(50) , @glser char(19) ,
	@dsctype char(2) , @pstmode numeric(1,0) , @fcy char(3) , @fcyrate numeric(7,2) , @duedate char(8) , @invttl float , @invcst float , @invdspc float , @invdsvl float ,
	@valafds float , @invpaid numeric(14,2) , @caser char(19) , @entries numeric(5,0) , @released bit , @posted bit , @fixrate numeric(7,2) , @extamt float , @extser char(19) ,
	@pricetp char(1) , @ischeque bit , @chkno char(8) , @chkdate char(8) , @lastupdt char(8) , @jvgenrt bit , @imfcval numeric(14,5) , @slcode char(2) , @modified bit,
	@rcvdtrn bit , @remarks varchar(65) , @remarks2 varchar(65) , @usrid char(10) , @vat_amt_rcvd float , @taxfree_sales float , @clnt_taxcode varchar(20) , @clnt_kind char(1) ,
	@PriceVatType numeric(1,0) , @qhtype char(1) , @qhstatus char(1) , @newcstmrname varchar(50) , @newcstmrcntct varchar(50) , @cstmrmobile varchar(50) , @sales_qd varchar(max)
	AS
		declare @rowno int ;
	Begin
		exec sp_xml_preparedocument @rowno output , @sales_qd ;
		IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[#TEMPSLINV_ANDROID]') AND type in (N'U'))
			begin
			DROP TABLE [dbo].[#TEMPSLINV_ANDROID]
			end

		------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
		declare @syscode int ;
		declare @comp char(2) , @yrcode varchar(4) ;
		set @comp=substring(db_name(),4,2);
		set @yrcode=substring(db_name(),7,2);
		set @yrcode=iif(cast(@yrcode as int)>40,'14','20')+rtrim(@yrcode)

		select	@syscode=sysno	from sysdb.dbo.glcalend with (nolock) where calcomp=@comp and yrcode=@yrcode;
		--------------------------------------------------------------------------------------------------------------------------- 
		select @clnt_taxcode = clnt_taxcode , @clnt_kind = cu_kind from customer where cu_company = @branch and cu_code = @custno
		
	Begin Try
		Begin TRANSACTION
		
		declare @ref numeric(6,0) ;
		

		set @ref = (select max(ref) from sales_qh with(nolock) where company = @company) + 1;
		set @ref = IIF(@ref is null or @ref =0 ,1,@ref);

		

				
			INSERT INTO [dbo].[sales_qh]
				([slcenter],[branch],[invtype],[company],[ref],[invdate],[custno],[custnm],[glser],[dsctype],[pstmode],[fcy],[fcyrate],[duedate],[invttl],[invcst],[invdspc],[invdsvl],[valafds]
				,[invpaid],[caser],[entries],[released],[posted],[fixrate],[extamt],[extser],[pricetp],[ischeque],[chkno],[chkdate],[lastupdt],[jvgenrt],[imfcval],[slcode],[modified]
				,[rcvdtrn],[remarks],[remarks2],[usrid],[vat_amt_rcvd],[taxfree_sales],[clnt_taxcode],[clnt_kind],[qhtype],[qhstatus],[newcstmrname],[newcstmrcntct],[cstmrmobile])
			VALUES
				(@slcenter , @branch , @invtype , @company , @ref , @invdate , @custno , @custnm , @glser , @dsctype , @pstmode , @fcy , @fcyrate , @duedate , @invttl , @invcst ,
				@invdspc , @invdsvl ,@valafds , @invpaid , @caser , @entries , @released , @posted , @fixrate , @extamt , @extser , @pricetp , @ischeque , @chkno , @chkdate   , 
				@lastupdt , @jvgenrt , @imfcval , @slcode , @modified ,@rcvdtrn , @remarks , @remarks2 , @usrid , @vat_amt_rcvd , @taxfree_sales , @clnt_taxcode , @clnt_kind  ,
				@qhtype , @qhstatus , @newcstmrname , @newcstmrcntct , @cstmrmobile);

		select slcenter , invtype , company , rref , invdate , itemno , unicode , itemdesc , qty , fqty , price , discpc , cost , ds_acfm , sl_acfm , gclass ,
		custno ,fcy , barcode , imfcval , pack , pkqty , shadd , shdpk , shdqty , frtqty , cmbkey , folio , slqtn_item_status , whno
		into [dbo].[#TEMPSLINV_ANDROID]
		from openxml(@rowno , 'Root/sales_qd',2)
		with (slcenter char(2) , invtype char(2) , company char(2) , rref numeric(6,0) , invdate char(8) , itemno char(16) , unicode char(6) , itemdesc char(30),
		qty float , fqty numeric(10,3) , price float , discpc numeric(6,2) , cost float ,  ds_acfm numeric(1,0) , sl_acfm numeric(1,0) , gclass char(8) , custno char(6),
		fcy char(3) , barcode char(20) , imfcval float , pack char(1) , pkqty numeric(9,3) , shadd char(1) , shdpk numeric(9,3) ,shdqty numeric(9,3) ,
		frtqty numeric(12,3), cmbkey char(24) , folio numeric(4,0) , slqtn_item_status numeric(1,0) , whno char(2) );
		
		if @syscode = 6
		begin
		update [dbo].[#TEMPSLINV_ANDROID] set slcenter = @slcenter , invtype = @invtype , company = @company , rref = @ref , itemno = s1.itemno , unicode = s1.unicode ,
			cost = s2.lcost , pack = s1.pack , pkqty = s1.pkqty , shadd = s2.pack1 , shdpk = s2.pkqty1 ,qty = (shdqty * s1.pkqty) + frtqty , cmbkey = s1.cmbkey
			from stitembc s1 inner join stunits s2 on s1.itemno = s2.itemno and s1.unicode = s2.unicode 
			where s1.pbarcode = [dbo].[#TEMPSLINV_ANDROID].[barcode];
			
			insert into sales_qd 
			select *,0 from [dbo].[#TEMPSLINV_ANDROID] ;
		end
		if @syscode = 9
		begin
			update [dbo].[#TEMPSLINV_ANDROID] set slcenter = @slcenter , invtype = @invtype , company = @company , rref = @ref , itemno = s1.itemno , unicode = s1.unicode ,
			cost = s1.lcost , pack = s1.pack0 , shadd = s1.pack1 , shdpk = s1.pkqty1 , qty = (shdqty + (frtqty / s1.pkqty1)) , barcode = s1.barcode
			from stunits s1 where s1.cmbkey = [dbo].[#TEMPSLINV_ANDROID].cmbkey
			insert into sales_qd 
			select *,0 from [dbo].[#TEMPSLINV_ANDROID]
		end
		if @syscode not in(6,9)
		begin
			update [dbo].[#TEMPSLINV_ANDROID] set slcenter = @slcenter , invtype = @invtype , company = @company , rref = @ref , itemno = s1.itemno , unicode = s1.unicode ,
			cost = s1.lcost , pack = s1.pack0 , shadd = s1.pack1 , shdpk = s1.pkqty1 , qty = (shdqty * s1.pkqty1) + frtqty , barcode = s1.barcode
			from stunits s1 where s1.cmbkey = [dbo].[#TEMPSLINV_ANDROID].cmbkey
			insert into sales_qd 
			select *,0 from [dbo].[#TEMPSLINV_ANDROID] 
		end
		
		DROP TABLE [dbo].[#TEMPSLINV_ANDROID]
		Commit Tran;
	End Try
	begin catch
			 ROLLBACK TRANSACTION;
			 INSERT INTO dbo.DB_Errors VALUES (SUSER_SNAME(),   ERROR_NUMBER(),   ERROR_STATE(),   ERROR_SEVERITY(),   ERROR_LINE(),   ERROR_PROCEDURE(),   ERROR_MESSAGE(),   GETDATE());
	end catch
			select ref from sales_qd with(nolock) where ref  = @ref;
End





GO
/****** Object:  StoredProcedure [dbo].[Api_InsertSales]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Api_InsertSales]

@STR_MSG NVARCHAR(1000) out,
@ltrtype char(2),
@lcustcode varchar(6),
@hinvdsvl float,
@hinvdspc float,
@lbelowbal bit,
@hvat_amt_rcvd float,
@htaxfree_sales float,
@RET_ID INT out,
@API_Inv nvarchar(max),
@SLCNTR char(2),
@SLPRSN char(2),
@BRANCH char(2),
@USRID varchar(10),
---- Added on 2022-03-18 AA ------
@Description varchar(50),
@Taxno varchar(20),
@datetime_stamp datetime
--------------------------------------

AS BEGIN 
   set lock_timeout 2000
BEGIN TRY
	DECLARE @shdpk NUMERIC(10,3)
	DECLARE @pack0 NVARCHAR(1)
	DECLARE @pack_0 char(1)
	DECLARE @lprice decimal(11,3)=0
	DECLARE @cmbkey NVARCHAR(24)
	DECLARE @itemno CHAR(16)
	DECLARE @unicode CHAR(6)
	DECLARE @lcost float
	declare @Trdate varchar(20)
	DECLARE @handle INT	
	DECLARE @barcode NVARCHAR(20)
--	DECLARE @lcustcode nCHAR(6)
	DECLARE @lbinno CHAR(6)
	DECLARE @qty float
--	declare @ltrtype nchar(2)
	DECLARE @comp char(2),
	@binno_found bit =0,
	@m_freeqty_vat float =0 -- Added on 2022-03-18 AA
	
	


	declare @ss as varchar(10),
	@srlno as int =0,
	@lshdqty as float=0,
	@lfrtqty as float =0,
	@ttlqty as float =0,
	@avail_qty float =0,
	@ttlcost as float =0,
	@ttlinv as float =0

	declare @dbc varchar(20),
	@lusing_hij_date bit =0,
	@ldate varchar(10),
	@lfdate varchar(8)='',
	@errstatus int =0,
	@stunits_lcost float=0,
	@lwhno as char(2)=''



	set @STR_MSG=''
	set @RET_ID=0
	set @dbc=db_name()
	SET @lusing_hij_date=iif(cast(substring(@dbc,7,2) as int)>30,1,0)
	set @comp=substring(@dbc,4,2)
	if @lusing_hij_date=1
	begin
		set @ldate =convert(varchar(10),getdate(),131)
		set @lfdate=substring(@ldate,7,4)+substring(@ldate,4,2)+iif(substring(@ldate,1,1)=' ','0'+substring(@ldate,2,1),substring(@ldate,1,2))
	end
	else
	begin
		set @ldate = convert(varchar(10),getdate(),112)
		set @lfdate=@ldate		
	end
	declare @lcaalwngtvs bit =0,
	        @yrcode varchar(4),
	        @syscode int =2

	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>40,'14','20')+rtrim(@yrcode)
------------------------------------------------------
	declare @lslcenter char(2),
		@linvorrtrn char(1),
		@lentries int ,        
		@linvttl float,
		@linvcst float,
		@linvdsvl float,
		@lvalafds float,
		@lfcamt float,
		@lprpaid numeric(13,3),
		@lcash numeric(13,3),
		@lccpayment numeric(13,3),
		@lcsanedcrdamt numeric(13,3),
		@lcharges numeric(13,3),
		@lcccommision float,
		@ljhfcflag numeric(1,0)=2,
		@lt_qty numeric(13,3),
		@lxq numeric(13,3),
		@ldummy char(24),
		@arr_ptr int =0,
		@subttlcost float=0,
		@lpack1 char(1)=''
-------------------------------------------------------
	---
	---   sales_dt declarations
	---
	declare @litemno char(16),
		@lunicode char(6) ,
		@lqty  numeric(13,3),
		@lfqty  numeric(13,3),
		@ldiscpc float,
		@lds_acfm numeric(1,0),
		@lsl_acfm numeric(1,0),
		@lgclass char(8),
		@lbarcode char(20),
		@limfcval float,
		@lpack char(1),
		@lpkqty numeric(8,3),
		@lcmbkey char(24),
		@litemtype char(1),
		@llcost float,
		@blcost float,
		@lfcost float,
		@lstfcy char(3),
		@lclasskey char(12),
		@cl_slser char(19),
		@lslptr int=0,
		@lstptr int=0,
		@lttl_inv float=0,
		@lshadd char(1),
		@lshdpk numeric(9,3),
		@lfolio int,
		@ltaxtype char(1),
		@lfcy char(3),
		@ldsc_amt float




	--
	--   Stbins declaration 
	--
	declare @bwhno char(2),
		@bbinno char(6),
		@brmnqty numeric(13,3),
		@lnobinno bit=1,
		@lastbinno char(6)
    
	-- variables for sales_hd
	declare @hslcenter char(2),
		@hbranch char(2),
		@hcompany char(2),
		@hinvtype char(2),
		@href numeric(6,0),
		@hinvdate char(8) ,        
		@hcustno char(6), 
		@hfcy char(3)='',
		@hfcyrate float=0,
		@hinvttl float,
		@hinvcst float,
		@hvalafds float,
		@hinvpaid numeric(13,3),
		@hextamt numeric(13,3),
		@hextser char(19),
		@hcccommsn float,
		@hbelowbal bit=0,
		@hccpayment numeric(13,3),
		@hsanedcrdamt numeric(12,3),
		@hrplsamt numeric(13,3),
		@hprpaidamt numeric(13,3),
		@husrid char(8),
		@hfxrate float =0,
		@hINSTFLAG bit,
		@hposinv numeric(1,0)=1	

	Declare @xbelowbal bit =0
------------------------------  Get Data From Sysuse ---------------------------------------------------------------
		select @xbelowbal=belowbal 
			 from sysuse with (NOLOCK)
			where username=@USRID 
		if @lbelowbal=1 and isnull(@xbelowbal,0)=0 
		begin
		   set @RET_ID=-7
		   return
		end
------------------------------  Get Data From salecntr ---------------------------------------------------------------
	declare @ldp_cashser char(19),
		@ldp_okdiff bit ,
		@ldp_mainwh char(2),
		@ldp_expser char(19),
		@ldp_oslser char(19),
		@ldp_roslser char(19),
		@ldp_cardcomm char(19),
		@ldp_rplsac char(19),
		@ldp_diffser char(19),
		@lDP_CSLSER char(19),
		@lDP_RCSLSER char(19),
		@lprpaidcrdac char(19),
		@ltdate char(8),
		@lglacct char(19),
		@lexacct char(19),
		@ldp_slser char(19),
		@lsanedcrd_act char(19),
		@lcstctr char(4)=''

	declare @xttl_cost float=0,
		@inv_lmtt  float=0,
		@inv_lftt  float=0,
		@m_vl      float=0,
		@m_fc      float=0,
		@inv_stk   float=0,
		@m_lccntr  float=0,
		@m_fccntr  float=0,
		@pd_lc     float =0,
		@opstval varchar(50),
		@diff_amt float=0,
		@new_rate float=0,
		@match_image bit ,
		@fc_to_lc_ttl float=0,
		@ch_cnt int =0,
		@l_crtot float=0,
		@f_crtot float=0,
		@l_dbtot float=0,
		@f_dbtot float=0,
		@m_sign int =0,
		@m_value float=0,
		@m_fcval float=0,
		@plcamt float ,
		@pfcamt float ,
		@fcfcy char (3),
		@lcurname char(20),
		@replication bit =0,
		@xclkey char(12)='',
		@clsname char(20)='',
		@cstcode char(4)='',
		@dscact char(19)='',
		@dscclassamt float=0,
		@dsc_ptr int =0,
		@ttl_class_dsc float=0

	declare @hcustnm varchar(50)='',
	    @hcaser varchar(19)='',
		@haddress varchar(50)='',
		@lvat_rcvd_act varchar(19)='',
		@lsc_code char(6)

------- Added on 2021-10-21 AA -------------------		
		set @m_sign=iif(@ltrtype in ('04','06'),1,-1)

		select @ldp_cashser=dp_cashser,@ldp_okdiff=dp_okdiff,@ldp_mainwh=dp_mainwh,@ldp_expser=dp_expser,
		@ldp_oslser=dp_oslser,@ldp_roslser=dp_roslser,@ldp_cardcomm=dp_cardcomm,@ldp_rplsac=dp_rplsac,@ldp_diffser=dp_diffser,
		@lDP_CSLSER=DP_CSLSER,@lDP_RCSLSER=DP_RCSLSER,@lprpaidcrdac=prpaidcrdac,@lsanedcrd_act=sanedcrd_act,@lcstctr=isnull(cstcode,''),
		@lvat_rcvd_act=vat_rcvd_act,@lsc_code=isnull(sc_code,'')
			from salecntr with (NOLOCK)
		where dp_brno=@BRANCH and dp_dept=@SLCNTR
------------------------------------------------------------------------------------------------------------------------	
------------------------  Get Customer Info  
----
        declare @cstaddrs varchar(60)='',
		@cstclass char(2)='',
		@cstcu_ctlser varchar(19)='',
		@dbtglacct char(19)='',
		@cstmaxlimit numeric(11,3)=0,
		@ldudate char(10)='',
		@ldudays int =0,
		@lcu_name varchar(50)=''

		Declare @hpricevattype numeric(1,0),@hNo_round_nm bit,@hvat_percent numeric(5,2),
		@hclnt_taxcode varchar(20),@hclnt_kind char(1)
		
		set @lwhno=@ldp_mainwh
		if len(rtrim(@lcustcode))>0
		begin
			select @lcu_name=cu_name,@cstaddrs=cu_addrs,@cstclass=cu_class,@cstcu_ctlser=cu_ctlser,@cstmaxlimit=isnull(cu_crlmt,0),
			@ldudays=isnull(cu_pymnt,0),@hclnt_taxcode=isnull(clnt_taxcode,''),@hclnt_kind=isnull(cu_kind,'') from customer where cu_company=@branch and cu_code=@lcustcode
			if len(isnull(@cstcu_ctlser,''))>0  set @dbtglacct=@cstcu_ctlser
			else
			begin
			   select @dbtglacct=cl_crlser from classfil where cl_company=@BRANCH and cl_code=@cstclass
			end
		end

		set @hcaser=''
		set @ldp_slser=''
		if @ltrtype ='06'
		begin
			set @hcaser=@ldp_cashser
			set @dbtglacct=@hcaser
			set @ldp_slser=@lDP_CSLSER
			set @hcustnm='مبيعات نقدية تمت عن طريق الجوال'				
		end
------- Added on 2021-10-21 AA -------------------
		else
		if @ltrtype ='26'
		begin
			set @hcaser=@ldp_cashser
			set @dbtglacct=@hcaser
			set @ldp_slser=@lDP_RCSLSER
			set @hcustnm=' مرتجع مبيعات نقدية تمت عن طريق الجوال'	
		end
		else
		if @ltrtype ='04'
		begin
			set @ldp_slser=@ldp_oslser
			set @hcustnm='مبيعات آجلة تمت عن طريق الجوال'
-------------------------- To calculate Due date
			if @ldudays>0
			begin
				if @lusing_hij_date=1
				begin
					set @ldate =convert(varchar(10),dateadd(dd,@ldudays,getdate()),131)
					set @ldudate=substring(@ldate,7,4)+substring(@ldate,4,2)+iif(substring(@ldate,1,1)=' ','0'+substring(@ldate,2,1),substring(@ldate,1,2))
				end
				else
				begin
					set @ldate = convert(varchar(10),dateadd(dd,@ldudays,getdate()),112)
					set @ldudate=@ldate		
				end
			end
			else set @ldudate=@lfdate
		end
------- Added on 2021-10-21 AA -------------------
		else
		if @ltrtype ='24'
		begin		
			set @ldp_slser=@ldp_roslser
			set @hcustnm='مرتجع مبيعات آجلة تمت عن طريق الجوال'
		end

------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
    declare @lcaokcstctr bit =0,
	@loksctions bit =0,
	@lSctnHasSerial bit=0

	select @syscode=sysno,@lcaalwngtvs=isnull(caalwngtv ,0),@lcaokcstctr=isnull(caokcstctr,0),@hpricevattype=isnull(pricevattype,0),
	       @hNo_round_nm=isnull(No_round_nm,0),@hvat_percent=vat_percent,@loksctions=isnull(oksctions,0),@lSctnHasSerial=isnull(SctnHasSerial,0)
	       from sysdb.dbo.glcalend with (nolock)
	       where calcomp=@comp and yrcode=@yrcode

--------------------------------------------------------------------------------------------------------------------------- 


	declare @ref int=0,
	        @l_vt float=0,
			@ltmpsccode char(6)
	

	--EXEC sp_xml_removedocument @handle
	


    DECLARE @j INT=1
	set @ref =0

	set @ltmpsccode=''
	if len(@lsc_code)>0 and @loksctions=1 and @lSctnHasSerial=1
	begin
		select @ltmpsccode=sc_code from glsction where sc_company=@BRANCH and sc_code=@lsc_code
		if @ltmpsccode is null set @lsc_code=''
	end
------- Added on 2021-10-21 AA ------------------------------------------------------------		
	if len(@lsc_code)>0 and @loksctions=1 and @lSctnHasSerial=1 set @ref=dbo.get_last_ref_section(@ltrtype,@branch,@lsc_code)
	else set @ref=dbo.get_last_ref(@ltrtype,@branch)
    
--	begin transaction
--	if len(@lsc_code)>0 and @loksctions=1 and @lSctnHasSerial=1
--	begin
--		if @ltrtype='06' update glsction set jv_06=@ref+1 where sc_company=@BRANCH and sc_code = @lsc_code;
--		if @ltrtype='04' update glsction set jv_04=@ref+1 where sc_company=@BRANCH and sc_code = @lsc_code;
--		if @ltrtype='26' update glsction set jv_26=@ref+1 where sc_company=@BRANCH and sc_code = @lsc_code;
--		if @ltrtype='24' update glsction set jv_24=@ref+1 where sc_company=@BRANCH and sc_code = @lsc_code;
--	end
--	else
--	begin
--		if @ltrtype='06' update stbranch set jv_06=@ref+1 where brnno=@BRANCH
--		else if @ltrtype='04' update stbranch set jv_04=@ref+1 where brnno=@BRANCH
--		else if @ltrtype='24' update stbranch set jv_24=@ref+1 where brnno=@BRANCH
--		else if @ltrtype='26' update stbranch set jv_26=@ref+1 where brnno=@BRANCH
--	end

-------------------------------------------------------------------------------------------------------
--	if @@error<>0
--	begin
--		rollback transaction
--		SET @RET_ID = -1
--		SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
--		set @errstatus =-1
--		goto jumplbl
--	end
--	commit transaction
---------------------------- Calculate the customer max limit 
  declare @tmp_ttl_inv float =0,
          @cst_curbal float =0,
		  @lposted bit =0,
		  @lfqtyval float=0,
		  @lvatamt float =0,
		  @p_fqty float =0,  -- Added on 2022-04-19 AA 
		  @lc_fqty float=0 ,  -- Added on 2022-04-19 AA
		  @lc_qty float=0 ,  -- Added on 2022-04-19 AA
		  @org_fqty float =0  -- Added on 2022-04-19 AA 



  --if @cstmaxlimit>0 and @ltrtype='04'
  --begin
  --      if @syscode<>6
  --    		Select @tmp_ttl_inv=sum((frtqty+(shdqty*pkqty1))*price)
		--	From #TEMPSLINV_PDA a inner join stunits b on a.barcode=b.barcode
		--else
		--	Select @tmp_ttl_inv=sum(shdqty*price)
		--	From #TEMPSLINV_PDA 

		--exec dbo.get_client_bal @BRANCH,@lcustcode,@lfcy,@lposted,@cst_curbal output
		--if @cst_curbal+@tmp_ttl_inv>@cstmaxlimit
		--begin
		--	SET @RET_ID = -55
		--	SET @STR_MSG ='العميل'+' '+@lcu_name+' '+'تجاوز الحد الاعلى للمديونية'
		--	set @errstatus =-1			
		--	goto jumplbl
		--end
  --end
  
---------------------------------------------------------------------
 -- DECLARE ARRAY HOLDING THE ITEM CLASS AND ACCOUNT
	    declare @class_arr table( p_ptr int,clkey char(12) not null , act char(19) not null,lcamt float ,
		clsname char(20),cstcode char(4),dscact char(19))

        --declare @dsc_class_val table(classkey char(12) not null,dscclassamt float default 0)   


		begin transaction
------------------------------------------------------------------------------
 
		if LTRIM(RTRIM(@SLPRSN)) = ''
		set @SLPRSN = (select top 1 slcode from salesmen with(nolock) where slcompany = @BRANCH and usrid = @USRID) ;
		set @SLPRSN = ISNULL(@SLPRSN,'');
		insert into sales_hd 
		(slcenter,branch ,company ,invtype ,ref ,invdate,custno ,custnm ,glser,dsctype ,pstmode
		,fcy,fcyrate,duedate ,invttl,invcst,invdspc ,invdsvl ,valafds ,invpaid ,caser ,entries
		,released,posted ,fixrate ,extamt,extser ,pricetp,ischeque ,chkno ,chkdate ,lastupdt,jvgenrt
		,cccommsn ,belowbal,fcy2,ccpayment ,rplsamt,pdother ,slcode,prpaidamt,instldays ,instflag
		,slcmnd ,inv_printed ,bendit ,modified ,rqstorder ,rqststld ,carrier ,rcvdtrn ,usrid ,address
		,suspend ,rtnref,ispurchase ,stkjvno ,posinv ,sanedcrd_amt,
		vat_amt_rcvd,taxfree_sales,	clnt_taxcode,clnt_kind,hlldscnt,sysno,No_round_nm,
		PriceVatType,vat_percent,fqtyval,datetime_stamp)
		values (@SLCNTR,'Q',@BRANCH,@ltrtype,@ref,@lfdate,@lcustcode ,iif(len(@Description)=0,@hcustnm,@Description),'','',0,
		'',0,@ldudate,0,0,@hinvdspc,@hinvdsvl,0,0,@hcaser,0,
		0,0,0,0,'','1',0,'',@lfdate,@lfdate,0,
		0,0,'',0,0,0,@SLPRSN ,0,0,0,
		0,0,0,1,0,0,'',0,@USRID ,@haddress,
		0,0,0,0,4,0,
		@hvat_amt_rcvd,@htaxfree_sales,iif(len(@hclnt_taxcode)=0,@Taxno,@hclnt_taxcode),@hclnt_kind,0,@syscode,
		@hNo_round_nm,@hpricevattype,@hvat_percent,@lfqtyval,@datetime_stamp)
		if @@error<>0
		begin
			rollback transaction
			SET @RET_ID = -2
			SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))    
			set @errstatus =-2
			goto jumplbl
		end
-----------------------------------------------------------------------------
	--
	--- insert one record in STHDR
	-- 
	declare @mainwh char(2) ;
	set @mainwh = (select dp_mainwh from salecntr with(nolock) where dp_dept = @SLCNTR and dp_brno = @BRANCH);

	 insert into sthdr (branch, trtype, ref, trdate, text, amnttl, costttl, sysdate, src, released,
	 posted, fcy, fcyrate, whno, entries, lastupdt, towhno, modified, rcvdtrn, custno, usrid, brsupp,
	 tobrno, brxref, glref, isbrtrx, asmtype, repost )
	 values(@branch ,@ltrtype,@ref ,@lfdate,iif(len(@Description)=0,@hcustnm,@Description),0,0,@lfdate,'05',0,
	       0,'',0,@mainwh,0,@lfdate,'',0,0,@lcustcode ,@usrid,'','',0,0,0,0,0)

		if @@error<>0
		begin
			rollback transaction
			SET @RET_ID = -3
			SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))    
			set @errstatus =-3
			goto jumplbl
		end
		--
		-- Insert One Record in GLJRHR
		--
		set @ljhfcflag=2
		insert into gljrhdr (jhcomp,jhtype,jhref,jhcurr,jhamt,jhdate,jhrate,jhtext,jhsrc,jhfcflag,jhreleased,jhposted,
		jhsysdate,modified,[Suspend],usrid,lastupdt,rcvdtrn,isbrtrx,brxref,brxfrm,jhcustno) 
		values (@branch,@ltrtype,@ref,'',0,@lfdate,0,iif(len(@Description)=0,@hcustnm,@Description),'05',
		@ljhfcflag,0,0,@lfdate,1,0,@USRID ,@lfdate,0,0,'','','')
		if @@error<>0
		begin
			rollback transaction
			SET @RET_ID = -4
			SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
			set @errstatus =-4
			goto jumplbl
		end  
	-------------------------------------get_client_bal

    if @errstatus=0
	begin
	 --   if @syscode <> 6
		--begin
		--	DECLARE Cursdtl CURSOR LOCAL FAST_FORWARD FOR
		--	Select a.barcode,shdqty,frtqty,price,pack0,pkqty1,lcost,substring(c.classkey,1,2) as classkey,
		--	cmbkey,b.itemno,b.unicode,pack1
		--	From #TEMPSLINV_PDA a inner join stunits b on a.barcode=b.barcode 
		--	inner join stitems c on b.itemno=c.itemno
		--end
		--else
		--begin
		--	DECLARE Cursdtl CURSOR LOCAL FAST_FORWARD FOR
		--	Select a.barcode,shdqty,frtqty,price,pack0,d.pkqty as pkqty1,lcost,substring(c.classkey,1,2) as classkey,
		--	b.cmbkey,b.itemno,b.unicode,d.pack as pack1
		--	From #TEMPSLINV_PDA a inner join stitembc d on a.barcode=d.pbarcode 
		--	inner join stunits b on d.itemno=b.itemno and d.unicode=b.unicode
		--	inner join stitems c on b.itemno=c.itemno
		--end
		EXEC sp_xml_preparedocument @handle OUTPUT, @API_Inv

		IF CURSOR_STATUS('global','Cursdtl')>=-1
			BEGIN
				DEALLOCATE Cursdtl
			END

		Declare Cursdtl Cursor For
		SELECT    *  
		FROM      OPENXML (@handle, '/Root/sales_dt',2)  with
		(cmbkey varchar(24),barcode varchar(20),
		qty float,fqty float,price float,discpc float,
		 pack char(1),pkqty numeric(9, 3),shdpk numeric(9, 3),shdqty float,frtqty float,
		 Taxtype char(1))
		open Cursdtl 
		Fetch Next From Cursdtl Into @lcmbkey,@lbarcode,@lqty,@lfqty,@lprice,@ldiscpc,@lpack,@lpkqty,@lshdpk,@lshdqty,@lfrtqty,@ltaxtype
        
	    EXEC sp_xml_removedocument @handle

	  	set @ch_cnt  =0
		set @l_crtot =0
		set @f_crtot =0
		set @l_dbtot =0
		set @f_dbtot =0
		set @m_value=0
		set @m_fcval=0
		set @xttl_cost=0
		set @lslptr=0
		set @lstptr=0
		set @lttl_inv=0
				
		set @ttl_class_dsc=0
		set @dsc_ptr=0
		set @xttl_cost=0
		set @inv_stk=0
		set @inv_lftt=0
		set @inv_lmtt=0
		set @m_lccntr=0
		set @m_fccntr=0
		set @arr_ptr=0
		set @lfqtyval=0
		WHILE dbo.FetchStatusOfCursorNamed('Cursdtl') = 0 
		begin
		    set @lnobinno=1
			set @lastbinno=space(6)
		    set @lpkqty=isnull(@lpkqty,1)
			set @lpkqty=iif(@lpkqty=0,1,@lpkqty)
			set @lpack=iif(isnull(@lpack,'')='','',@lpack)
			if  @syscode in (4,5)
			begin
			    set @lshdqty=isnull(@lshdqty,0)
				set @lfrtqty=isnull(@lfrtqty,0)
				set @lshdpk=isnull(@lshdpk,1)
				set @lshdpk=iif(@lshdpk=0,1,@lshdpk)
			    set @qty=@lfrtqty+(@lshdqty*@lshdpk)
			end
		    else
		    begin
			    set @p_fqty=@lfqty*@lpkqty -- Added on 2022-04-19 AA
				set @org_fqty=@p_fqty
			    set @qty=@lqty*@lpkqty
			end

            set @ltaxtype=isnull(@ltaxtype,'1')
			if @ltaxtype='0' or rtrim(@ltaxtype)='' set @ltaxtype='1'
			
			select @lclasskey=substring(a.classkey,1,2),@litemno=b.itemno,@lunicode=b.unicode,@litemtype=itemtype,@pack0=pack0,@lpack1=pack1,
			@llcost=lcost
			from stitems a inner join stunits b
			on a.itemno=b.itemno where b.cmbkey=@lcmbkey

			if	@syscode = 6
			begin
				select @pack0 = pack , @shdpk = pkqty from stitembc where pbarcode = @lbarcode ;
			end
---------- Added on 2022-03-18 AA ------------------------------------------
           if not (@ltaxtype in ('2','3') or (len(@lcustcode)>0 and @hclnt_kind in ('2','3','7','8')))
			   set @lfqtyval=@lfqtyval+(@lfqty*(@lprice-(@lprice*@ldiscpc/100)))			

			set @avail_qty=0
			set @lcost=0
			set @lclasskey=iif(isnull(@lclasskey,'')='','',@lclasskey)
			set @lclasskey=rtrim(@lclasskey)+replicate(space(1),12-datalength(rtrim(@lclasskey)))	
			set @cl_slser=''	

------------ Added on 2021-10-21 AA -------------------				 
			select @cl_slser=iif(@ltrtype='06',SERCSH,iif(@ltrtype='26',SERRCH,iif(@ltrtype='04',SERCRD,serrcr))),@clsname=name,@cstcode=cstcode,@dscact=serdsc
				from slclass with (NOLOCK) where company=@BRANCH and cmbkey=@lclasskey
			if rtrim(isnull(@cl_slser,''))='' 
			begin
				set @lsl_acfm=3
				set @lds_acfm=3
				set @lgclass=''
			end
			else
			begin
				set @lsl_acfm=2
				set @lds_acfm=2
				set @lgclass=rtrim(@lclasskey)
			end
			set @l_vt=0
			set @m_vl=-iif(@syscode not in (4,5),(@lqty*(@lprice-(@lprice*@ldiscpc/100))),@qty*@lprice)
            if @hpricevattype>1 and @hvat_amt_rcvd>0 and @ltaxtype='1' --and @lnvp_vat_percent>0
			begin
			    set @l_vt=@m_vl*@hvat_percent/(@hvat_percent+100)
			--	set @m_vl=@m_vl+@l_vt
			end
			set @m_fc=0.00
			set @inv_lftt=@inv_lftt+abs(@m_vl)
			set @inv_lmtt=@inv_lmtt+Abs(@m_vl)   
			set @inv_stk=@inv_stk+Abs(@m_vl) 
			if @lsl_acfm=2
			begin 
				set @xclkey=''
				select @xclkey=clkey from  @class_arr where clkey=@lclasskey
				if rtrim(isnull(@xclkey,''))=''
				begin
					set @arr_ptr+=1
					insert into @class_arr values (@arr_ptr,@lclasskey,@cl_slser,@m_vl,@clsname,@cstcode,@dscact)
				end
				else update @class_arr set lcamt=lcamt+@m_vl where clkey=@lclasskey
			end
			if @lsl_acfm=3
			begin
				set @m_lccntr=@m_lccntr+@m_vl
				set @m_fccntr=@m_fccntr+@m_fc
			end

			set @lttl_inv=@lttl_inv+abs(@m_vl)
			set @avail_qty=0

			if @lbelowbal = 0 and @lcaalwngtvs=0 and @ltrtype in ('04','06')
			begin
				select @avail_qty=sum(qty-abs(rsvqty)) from stbins where branch=@BRANCH and itemno=@litemno and unicode=@lunicode
				and whno=@lwhno 
				set @avail_qty=isnull(@avail_qty,0)
				if @qty+@p_fqty>@avail_qty -- Added on 2022-04-19 AA
				begin
					rollback transaction
					SET @RET_ID = -5
					SET @STR_MSG = 'الكمية تجاوزت الرصيد المتاح للصنف '+' '+@lcmbkey
					set @errstatus =-5
					break
				end
			end
			set @subttlcost=0
			if @litemtype not in ('5','6')
			begin
			    set @lt_qty=@qty+@p_fqty -- Added on 2022-04-19 AA
			    if @ltrtype in ('04','06')
				begin
				--	set @lt_qty=@qty
					DECLARE lstbins CURSOR LOCAL FAST_FORWARD FOR
					select binno,qty-rsvqty as qty,lcost from stbins where branch=@branch and
					itemno=@litemno and unicode=@lunicode and whno=@lwhno
					open lstbins;
					fetch next from lstbins into @bbinno,@brmnqty,@blcost
					WHILE dbo.FetchStatusOfCursorNamed('lstbins') = 0 and @lt_qty>0
					begin
				    
						set @lnobinno=0
						set @lastbinno=@bbinno
						if @brmnqty>0
						begin
							if @lt_qty>@brmnqty set @lxq=@brmnqty
							else set @lxq=@lt_qty
							set @lstptr=@lstptr+1
---------------------------- Added on 2022-04-19 AA ---------------------------------------------
						    set @lc_fqty=0
							set @lc_qty=@lxq
							if @p_fqty>0
							if @lc_qty>=@p_fqty
							begin
							    set @lc_fqty=@p_fqty
								set @lc_qty=@lxq-@p_fqty
								set @p_fqty=0
							end
--------------------------------------------------------------------------------------------------
							if	@syscode <> 6
							begin
								insert into stdtl (itemno, unicode, branch, trtype, qty, fqty, whno, binno, lcost, trdate, ref,
									sysdate, src, lprice, fcost, fprice, expdate, towhno, tobinno, barcode, cmbkey, discpc, pack,
									shdpk, shdqty, folio, rplct_post)
								values(@litemno,@lunicode,@BRANCH,@ltrtype,@lc_qty,@lc_fqty,@lwhno,@bbinno,@blcost,@lfdate, --Added on 2022-04-19 AA
								@ref,@lfdate,'05',@lprice/iif(@lpkqty=0,1,@lpkqty),0,0,'','','',@lbarcode,@lcmbkey,0,@pack0,1,@lxq,@lstptr,0)
							end
							else
							begin
								insert into stdtl (itemno, unicode, branch, trtype, qty, fqty, whno, binno, lcost, trdate, ref,
									sysdate, src, lprice , fcost, fprice, expdate, towhno, tobinno, barcode, cmbkey, discpc, pack,
									shdpk, shdqty, folio, rplct_post)
								values(@litemno,@lunicode,@BRANCH,@ltrtype,@lc_qty,@lc_fqty,@lwhno,@bbinno,@blcost,@lfdate, --Added on 2022-04-19 AA
								@ref,@lfdate,'05',@lprice/@shdpk,0,0,'','','',@lbarcode,@lcmbkey,0,@pack0,@shdpk,@lxq/@shdpk,@lstptr,0)
							end
							if @@error<>0
							begin
								rollback transaction
								SET @RET_ID = -6
								SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))    
								set @errstatus =-6
								break
							end
							set @subttlcost=@subttlcost+(@blcost*@lxq)
							set @lt_qty=@lt_qty-@lxq
			--
			-- Update the RSVQTY of stbins
			--
							update stbins set rsvqty=rsvqty+@lxq where branch=@BRANCH and
									itemno=@litemno and unicode=@lunicode and whno=@lwhno and binno=@bbinno
							if @@error<>0
							begin
								rollback transaction
								SET @RET_ID = -7
								SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
								set @errstatus =-7
								break
							end
						end
						if @lt_qty<=0 break					
						fetch next from lstbins into @bbinno,@brmnqty,@blcost
					end				  
					close lstbins
					deallocate lstbins
					if @errstatus<0 break

					if @lt_qty>0  
					if (@lbelowbal=1 or (@syscode in (2,3,6) and @lcaalwngtvs=1))
					begin
						--set @hbelowbal = 1
						if @lnobinno=1
						begin
							set @ldummy=''
							select @ldummy=cmbkey from stunits with (NOLOCK) where itemno=@litemno and unicode=@lunicode
							if RTRIM(isnull(@ldummy,''))<>''
							begin
								insert into stbins (itemno,unicode,lcost,whno,branch,binno,fcost,openlcost,openfcost,openbal,qty,rsvqty,expdate) values
								(@litemno,@lunicode,@llcost,@ldp_mainwh,@BRANCH,@lastbinno,0,0,0,0,0,0,' ')
			    				if @@error<>0
								begin
									rollback transaction
									SET @RET_ID = -8
									SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
									set @errstatus =-8
									break
								end
							end						                           
						end
						set @lstptr=@lstptr+1
						set @lxq=@lt_qty
---------------------------- Added on 2022-04-19 AA ---------------------------------------------
						set @lc_fqty=0
						set @lc_qty=@lxq
						if @p_fqty>0
						if @lc_qty>=@p_fqty
						begin
							set @lc_fqty=@p_fqty
							set @lc_qty=@lxq-@p_fqty
							set @p_fqty=0
						end
-------------------------------------------------------------------------------------------------
						if @lnobinno=0 and @blcost>0 set @llcost=@blcost
						insert into stdtl (itemno, unicode, branch, trtype, qty, fqty, whno, binno, lcost, trdate, ref,
								sysdate, src, lprice, fcost, fprice, expdate, towhno, tobinno, barcode, cmbkey, discpc, pack,
								shdpk, shdqty, folio, rplct_post)
						values(@litemno,@lunicode,@BRANCH,@ltrtype,@lc_qty,@lc_fqty,@lwhno,@lastbinno, -- Added on 2022-04-19 AA
						@llcost,@lfdate,
						@ref,@lfdate,'05',@lprice/iif(@lpkqty=0,1,@lpkqty),0,0,'','','',@lbarcode,@lcmbkey,0,@pack0,1,@lxq,@lstptr,0)
						if @@error<>0
						begin
							rollback transaction
							SET @RET_ID = -9
							SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))    
							set @errstatus =-9
							break
						end
						set @subttlcost=@subttlcost+(@llcost*@lxq)
						update stbins set rsvqty=rsvqty+@lxq where branch=@BRANCH and
							itemno=@litemno and unicode=@lunicode and whno=@lwhno and binno=@lastbinno
						if @@error<>0
						begin
							rollback transaction
							SET @RET_ID = -10
							SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
							set @errstatus =-10
							break
						end
					end   -- end of @lt_qty>0
					else
					begin
					   rollback transaction
					   SET @RET_ID = -99
					   set @errstatus =-99
					   SET @STR_MSG = 'الكمية تجاوزت الرصيد المتاح للصنف '+' '+@lcmbkey
					   break
					end

					update stunits set rsvqty=rsvqty+@qty where itemno=@litemno and unicode=@lunicode	
					if @@error<>0
					begin
						rollback transaction
						SET @RET_ID = -11
						SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
						set @errstatus =-11
						break
					end
				end -- end of type 04 & 06
				else
				begin
					select @lastbinno=binno,@blcost=lcost from stbins where branch=@branch and
					itemno=@litemno and unicode=@lunicode and whno=@ldp_mainwh
					if isnull(@lastbinno,'')='' set @lastbinno=space(6)
					if isnull(@blcost,0)=0 set @blcost=@llcost
					set @lxq=@lt_qty
					set @lstptr=@lstptr+1
---------------------------- Added on 2022-04-19 AA ---------------------------------------------
					set @lc_fqty=0
					set @lc_qty=@lxq
					if @p_fqty>0
					if @lc_qty>=@p_fqty
					begin
						set @lc_fqty=@p_fqty
						set @lc_qty=@lxq-@p_fqty
						set @p_fqty=0
					end
-------------------------------------------------------------------------------------------------
					if	@syscode <> 6
					begin
					insert into stdtl (itemno, unicode, branch, trtype, qty, fqty, whno, binno, lcost, trdate, ref,
						sysdate, src, lprice, fcost, fprice, expdate, towhno, tobinno, barcode, cmbkey, discpc, pack,
						shdpk, shdqty, folio, rplct_post)
					values(@litemno,@lunicode,@BRANCH,@ltrtype,@lc_qty,@lc_fqty,@lwhno,@lastbinno,@blcost,@lfdate,
					@ref,@lfdate,'05',@lprice/iif(@lpkqty=0,1,@lpkqty),0,0,'','','',@lbarcode,@lcmbkey,0,@pack0,1,@lxq,@lstptr,0)
					end
					else
					begin
					insert into stdtl (itemno, unicode, branch, trtype, qty, fqty, whno, binno, lcost, trdate, ref,
						sysdate, src, lprice , fcost, fprice, expdate, towhno, tobinno, barcode, cmbkey, discpc, pack,
						shdpk, shdqty, folio, rplct_post)
					values(@litemno,@lunicode,@BRANCH,@ltrtype,@lc_qty,@lc_fqty,@lwhno,@lastbinno,@blcost,@lfdate,
					@ref,@lfdate,'05',@lprice/iif(@shdpk=0,1,@shdpk),0,0,'','','',@lbarcode,@lcmbkey,0,@pack0,@shdpk,@lxq/iif(@shdpk=0,1,@shdpk),@lstptr,0)
					end
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-11
						break
					end
					set @subttlcost=@subttlcost+(@blcost*@lxq)
				end  -- end of
			end
---------------------------------------------------------------------------------------------------------------------
         --   set @ldiscpc=0
		    
			set @llcost=@subttlcost/(@qty+@org_fqty) -- Added on 2022-04-19 AA
			set @xttl_cost=@xttl_cost+((@qty+@org_fqty)*@llcost)  -- Added on 2022-04-19 AA
			set @lslptr=@lslptr+1
			if @syscode in (4,5,8,9)
				insert into sales_dt (slcenter, company, invtype, ref, invdate, itemno, unicode, qty, fqty, price, discpc,
					cost, ds_acfm, sl_acfm, gclass, custno, fcy, barcode, imfcval, pack, pkqty, shadd, shdpk, shdqty, frtqty, rtnqty, whno, 
					cmbkey, folio, rplct_post, sold_item_status,taxtype)
				values(@SLCNTR,@BRANCH,@ltrtype,@ref,@lfdate,@litemno,@lunicode,
				@qty,@lfqty,@lprice,@ldiscpc,@llcost,@lds_acfm,@lsl_acfm,@lgclass,'','',@lbarcode,0,@pack0,1,
				@lpack1,@lshdpk,@lshdqty,@lfrtqty,0,@lwhno,@lcmbkey,@lslptr,0,0,@ltaxtype)
			else
			    --if @syscode=6
				    insert into sales_dt (slcenter, company, invtype, ref, invdate, itemno, unicode, qty, fqty, price, discpc,
						cost, ds_acfm, sl_acfm, gclass, custno, fcy, barcode, imfcval, pack, pkqty, shadd, shdpk, shdqty, frtqty, rtnqty, whno, 
						cmbkey, folio, rplct_post, sold_item_status,taxtype)
					values(@SLCNTR,@BRANCH,@ltrtype,@ref,@lfdate,@litemno,@lunicode,
					@lqty,@lfqty,@lprice,@ldiscpc,@llcost,@lds_acfm,@lsl_acfm,@lgclass,'','',@lbarcode,0,@lpack,@lpkqty,
					'',0,0,0,0,@lwhno,@lcmbkey,@lslptr,0,0,@ltaxtype)
				--else
				--insert into sales_dt (slcenter, company, invtype, ref, invdate, itemno, unicode, qty, fqty, price, discpc,
				--	cost, ds_acfm, sl_acfm, gclass, custno, fcy, barcode, imfcval, pack, pkqty, shadd, shdpk, shdqty, frtqty, rtnqty, whno, 
				--	cmbkey, folio, rplct_post, sold_item_status,taxtype)
				--values(@SLCNTR,@BRANCH,@ltrtype,@ref,@lfdate,@litemno,@lunicode,
				--@qty,0,@lprice,@ldiscpc,@llcost,@lds_acfm,@lsl_acfm,@lgclass,'','',@lbarcode,0,@lpack,1,
				--'',0,0,0,0,@lwhno,@lcmbkey,@lslptr,0,0,@ltaxtype)
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -12
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
				set @errstatus =-12
				break
			end
---------------------------------------------------------------------------------------------------------------------	
            Fetch Next From Cursdtl Into @lcmbkey,@lbarcode,@lqty,@lfqty,@lprice,@ldiscpc,@lpack,@lpkqty,@lshdpk,@lshdqty,@lfrtqty,@ltaxtype		
									
		END
		CLOSE Cursdtl 
		DEALLOCATE Cursdtl

		if @errstatus =0 and @lslptr>0
		begin
				
			set @pd_lc=@lttl_inv
			set @opstval=''
			set @diff_amt=0
			set @new_rate=0
			set @match_image=0
			set @hinvpaid=0
			set @hvalafds = @lttl_inv
			------- Added on 2021-10-21 AA -------------------
			if @ltrtype in ('06','26')  set @hinvpaid=@lttl_inv
				
			----------------- Calculate the vat	    
			set @lvatamt=@hvalafds-@hinvdsvl-@htaxfree_sales+@lfqtyval	
			if @hpricevattype>1 set @hvat_amt_rcvd=	@lvatamt*@hvat_percent/(@hvat_percent+100)
			else set @hvat_amt_rcvd=@lvatamt*@hvat_percent/100
------------ Added on 2022-04-19 AA ------------------------
            set @m_freeqty_vat=0
			if @hpricevattype>1 and @lfqtyval>0 set @m_freeqty_vat=	@lfqtyval*@hvat_percent/(@hvat_percent+100)		
			------------------------------------------------------------------------------
            set @opstval=@hcustnm

			--
			-- Process GLJRDTL entries
			--
			set @ch_cnt +=1
			set @m_value=@pd_lc-@hinvdsvl+iif(@hpricevattype<=1,@hvat_amt_rcvd,0)+@m_freeqty_vat  -- Added on 2022-04-19 AA
			set @pd_lc=@pd_lc+iif(@hpricevattype<=1,@hvat_amt_rcvd,0)+@m_freeqty_vat -- Added on 2022-04-19 AA
			set @m_fcval=0
			insert into gljrdtl 
			(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post,taxcatId )
			values (@BRANCH,@ltrtype,@ref,@dbtglacct,@lfdate,@opstval,
			abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@lfdate,'05',0,0,'','','',0,0,0,0)	
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -13
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
				set @errstatus =-13
				goto jumplbl
			end
			If @m_value<0
			begin
				set @l_crtot=@l_crtot+Abs(@m_value)
				set @f_crtot=@f_crtot+Abs(@m_fcval)
			end
			Else
			begin
				set @l_dbtot=@l_dbtot+Abs(@m_value)
				set @f_dbtot=@f_dbtot+Abs(@m_fcval)
			End	
------------------------------------  Process GLdtl on the class level  ----------------------------------
            if @arr_ptr>0
			begin
				while @arr_ptr>0
				begin
					set @cl_slser=''
					set @dscact=''
					set @cstcode=''
					set @m_vl=0
					select @cl_slser=act,@m_vl=lcamt,@clsname=clsname,@cstcode=cstcode,@dscact=dscact,@xclkey=clkey
					from @class_arr
					where p_ptr=@arr_ptr
					if isnull(@cl_slser,'')<>'' and isnull(@m_vl,0)<>0
					begin
						set @m_value=@m_vl
						set @m_fcval=0
						set @opstval='مبيعات قسم'+' '+rtrim(@clsname)
						set @ch_cnt +=1
						insert into gljrdtl 
						(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                        ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post,taxcatId )
						values (@BRANCH,@ltrtype,@ref,@cl_slser,@lfdate,@opstval,
						abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@lfdate,'05',0,0,'','','',0,0,0,0)	
						if @@error<>0
						begin
							rollback transaction
							SET @RET_ID = -14
							SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
							set @errstatus =-14
							goto jumplbl
						end
						if @lcaokcstctr=1 and isnull(@cstcode,'')<>''
						begin
							insert into gljrcost (company,jdtype,jdref,cstcode,jdkey,jdcurr,Xpercent,amt,jddbcr
							,jdfc_imgval,jdfolno,rplct_post)
							values (@BRANCH,@ltrtype,@ref,@cstcode,@cl_slser,'',0,abs(@m_value),
							iif(@m_sign*@m_value<0,'C','D'),0,@ch_cnt,0)
							if @@error<>0
							begin
								rollback transaction
								SET @RET_ID = -15
								SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
								set @errstatus =-15
								goto jumplbl
							end
						end
						If @m_value<0
						begin
							set @l_crtot=@l_crtot+Abs(@m_value)	
							set @f_crtot=@f_crtot+Abs(@m_fcval)					
						end
						Else
						begin
							set @l_dbtot=@l_dbtot+Abs(@m_value)	
							set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
						End	
					end
					set @arr_ptr-=1
				end  -- end of @arr_ptr loop
            end  ----  end of @arr_ptr
----------------------------------------------------------------------------------------------------------------					
				
			If @m_lccntr<>0 Or @m_fccntr<>0
			begin
				set @m_value=@m_lccntr+iif(@hpricevattype>1,@hvat_amt_rcvd,0)-@m_freeqty_vat -- Added on 2022-04-19 AA
				set @m_fcval=@m_fccntr
				set @opstval=@hcustnm
				set @ch_cnt +=1
				insert into gljrdtl 
				(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                        ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post,taxcatId )
				values (@BRANCH,@ltrtype,@ref,@ldp_slser,@lfdate,@opstval,
				abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@lfdate,'05',0,0,'','','',0,0,0,0)	
				if @@error<>0
				begin
					rollback transaction
					SET @RET_ID = -16
					SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
					set @errstatus =-16
					goto jumplbl
				end
--					
----------- For Cost center process
--
				if @lcaokcstctr=1 and isnull(@lcstctr,'')<>''
				begin
					insert into gljrcost (company,jdtype,jdref,cstcode,jdkey,jdcurr,Xpercent,amt,jddbcr
					,jdfc_imgval,jdfolno,rplct_post)
					values (@BRANCH,@ltrtype,@ref,@lcstctr,@ldp_slser,'',0,abs(@m_value),
					iif(@m_sign*@m_value<0,'C','D'),0,@ch_cnt,0)
					if @@error<>0
					begin
						rollback transaction
						SET @RET_ID = -17
						SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
						set @errstatus =-17
						goto jumplbl
					end
				end
				If @m_value<0
				begin
					set @l_crtot=@l_crtot+Abs(@m_value)	
					set @f_crtot=@f_crtot+Abs(@m_fcval)					
				end
				Else
				begin
					set @l_dbtot=@l_dbtot+Abs(@m_value)	
					set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
				End	
			end  -- end of @m_lccntr
			if @hinvdsvl>0 --dbo.value_balanced(@hinvdsvl,@ttl_class_dsc)=0 and @lNoDsc4SlPuJv=0 -- Added on 2020-11-23 AA
			begin
				set @m_value=@hinvdsvl-@ttl_class_dsc
				set @m_fcval=0
				set @opstval='خصومات المبيعات'
				set @ch_cnt +=1
				insert into gljrdtl 
				(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                        ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post,taxcatId )
				values (@BRANCH,@ltrtype,@ref,@ldp_expser,@lfdate,@opstval,
				abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@lfdate,'05',0,0,'','','',0,0,0,0)	
				if @@error<>0
				begin
					rollback transaction
					SET @RET_ID = -16
					SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
					set @errstatus =-16
					goto jumplbl
				end
--					
----------- For Cost center process
--
				if @lcaokcstctr=1 and isnull(@lcstctr,'')<>''
				begin
					insert into gljrcost (company,jdtype,jdref,cstcode,jdkey,jdcurr,Xpercent,amt,jddbcr
					,jdfc_imgval,jdfolno,rplct_post)
					values (@BRANCH,@ltrtype,@ref,@lcstctr,@ldp_expser,'',0,abs(@m_value),
					iif(@m_sign*@m_value<0,'C','D'),0,@ch_cnt,0)
					if @@error<>0
					begin
						rollback transaction
						SET @RET_ID = -16
						SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
						set @errstatus =-16
						goto jumplbl
					end
				end
				If @m_value<0
				begin
					set @l_crtot=@l_crtot+Abs(@m_value)	
					set @f_crtot=@f_crtot+Abs(@m_fcval)					
				end
				Else
				begin
					set @l_dbtot=@l_dbtot+Abs(@m_value)	
					set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
				End	
			end  -- end of @hinvdsvl
		-- *----  Processing the Value Added Tax paid by client 

				if @hvat_amt_rcvd<>0
				begin
					set @m_value=-@hvat_amt_rcvd 
					set @m_fcval=0
					set @opstval='ضريبة القيمة المضافة'
					set @ch_cnt +=1
					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post,taxcatId )
					values (@BRANCH,@ltrtype,@ref,@lvat_rcvd_act,@lfdate,@opstval,
					abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@lfdate,'05',0,0,'','','',0,0,0,1)	
					if @@error<>0
					begin
						rollback transaction
						SET @RET_ID = -16
						SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
						set @errstatus =-16
						goto jumplbl
					end
--					
----------- For Cost center process
--
					if @lcaokcstctr=1 and isnull(@lcstctr,'')<>''
					begin
						insert into gljrcost (company,jdtype,jdref,cstcode,jdkey,jdcurr,Xpercent,amt,jddbcr
						,jdfc_imgval,jdfolno,rplct_post)
						values (@BRANCH,@ltrtype,@ref,@lcstctr,@lvat_rcvd_act,'',0,abs(@m_value),
						iif(@m_sign*@m_value<0,'C','D'),0,@ch_cnt,0)
						if @@error<>0
						begin
							rollback transaction
							SET @RET_ID = -16
							SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
							set @errstatus =-16
							goto jumplbl
						end
					end
					if not(@hpricevattype>1 and @hvat_amt_rcvd>0   ) --and @m_invtype='26'
						set @inv_lmtt=@inv_lmtt+Abs(@m_value)
					If @m_value<0
					begin
						set @l_crtot=@l_crtot+Abs(@m_value)	
						set @f_crtot=@f_crtot+Abs(@m_fcval)					
					end
					Else
					begin
						set @l_dbtot=@l_dbtot+Abs(@m_value)	
						set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
					End	
					
				end
				------  End of VAT process
--------------------------------------------------------------------------
		-----------------Update gljrhdr


			update gljrhdr set jhfcflag=2,jhentries=@ch_cnt,jhlccrttl = @l_crtot,
			jhfccrttl= @f_crtot,jhlcdbttl = @l_dbtot,jhfcdbttl = @f_dbtot,
			jhamt = Iif(@inv_lmtt>@l_dbtot,@inv_lmtt,@l_dbtot) where jhcomp=@BRANCH  and jhtype=@ltrtype and
			jhref=@ref
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -18
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
				set @errstatus =-18
				goto jumplbl
			end
				
	--------- Update sthdr
			If @lstptr>0
			begin
				update sthdr set entries=@lstptr,amnttl = @inv_stk,costttl = @xttl_cost where branch=@BRANCH 
				and trtype=@ltrtype and ref=@ref
			end
			else  delete from sthdr where branch=@BRANCH and trtype=@ltrtype and ref=@ref
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -19
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
				set @errstatus =-19
				goto jumplbl
			end
	--    Update sales_hd
			update sales_hd set entries=@lslptr,valafds=@lttl_inv,invcst=@xttl_cost,belowbal=@lbelowbal,
			invttl=@lttl_inv+iif(@hpricevattype>1,0,@hvat_amt_rcvd),fqtyval=@lfqtyval,vat_amt_rcvd=@hvat_amt_rcvd
			where company=@BRANCH and invtype=@ltrtype and ref=@ref
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -20
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
				set @errstatus =-20
				goto jumplbl
			end
			if @ltrtype in ('04','24')
			begin
			     insert into arhdr
			     (hd_company, hd_type, hd_ref, hd_date, hd_fcy, hd_ftotal, hd_fcyrate, hd_ltotal, hd_cucode, 
				 hd_desc1, hd_ser, hd_rlsd, hd_posted, hd_trxsrc, hd_sysdate, hd_lcnet, hd_fcnet, hd_lccnet,
				 hd_fccnet, isit_opst, opst_val, opst_fcy, lastupdt, modified, rcvdtrn, usrid, clcode, clcmnd,
				 dscamt, payinv) 
				 values (@BRANCH,@ltrtype,@ref,@lfdate,'',0,0,@pd_lc,@lcustcode,
				 iif(len(@Description)=0,@hcustnm,@Description),'',0,0,'05',@lfdate,@pd_lc,0,0,
				 0,0,0,'',@lfdate,1,0,@USRID,'',0,0,0)
				if @@error<>0
				begin
					rollback transaction
					SET @RET_ID = -21
					SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
					set @errstatus =-21
					goto jumplbl
				end

				insert into ardtl 
				(dt_company, dt_type, dt_ref, dt_date, dt_lcamt, dt_paidamt, dt_discamt, dt_cucode, dt_fcy,
				 dt_trxsrc, dt_fcamt, dt_fpydamt, dt_fdscamt, dt_lcaloc, dt_fcaloc, dt_aloctd, dt_pdinv, dt_duedate,
                 dt_desc, dt_chkno, dt_chkdate, dt_chkbnk, dt_dbcr, dt_ackey, dt_folio, dt_rcvno, dt_lstdate,
				 tdscdays, tdscpcs, match, rplct_post)
				 values(@BRANCH,@ltrtype,@ref,@lfdate,@pd_lc,0,@hinvdsvl,@lcustcode,'', -- Added on 2022-04-19 AA @hinvdsvl
				 '05',0,0,0,0,0,'0',0,@lfdate,
				 @hcustnm,'','','',iif(@ltrtype='04','D','C'),'',1,0,'',
				 0,0,0,0)
				 if @@error<>0
				begin
					rollback transaction
					SET @RET_ID = -22
					SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
					set @errstatus =-22
					goto jumplbl
				end
			end
		end
	end
	jumplbl:
	if @errstatus=0 commit transaction
--	select @ref
---- Added on 2022-04-04 AA ----------------------------------------------------------------
    if  @errstatus=0 and @ref>0
	begin
		begin transaction
		if len(@lsc_code)>0 and @loksctions=1 and @lSctnHasSerial=1
		begin
			if @ltrtype='06' update glsction set jv_06=@ref+1 where sc_company=@BRANCH and sc_code = @lsc_code;
			if @ltrtype='04' update glsction set jv_04=@ref+1 where sc_company=@BRANCH and sc_code = @lsc_code;
			if @ltrtype='26' update glsction set jv_26=@ref+1 where sc_company=@BRANCH and sc_code = @lsc_code;
			if @ltrtype='24' update glsction set jv_24=@ref+1 where sc_company=@BRANCH and sc_code = @lsc_code;
		end
		else
		begin
			if @ltrtype='06' update stbranch set jv_06=@ref+1 where brnno=@BRANCH
			else if @ltrtype='04' update stbranch set jv_04=@ref+1 where brnno=@BRANCH
			else if @ltrtype='24' update stbranch set jv_24=@ref+1 where brnno=@BRANCH
			else if @ltrtype='26' update stbranch set jv_26=@ref+1 where brnno=@BRANCH
		end
		if @@error<>0
		begin
			rollback transaction
			SET @RET_ID = -1
			SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
			set @errstatus =-1
		end
		else 
		begin
		set @RET_ID = @ref ;
		commit transaction
		end
	end
	-----------------------------------------------------------------------------------------------------
    --return --@errstatus
END TRY
	BEGIN CATCH
	    if @@TRANCOUNT>0 ROLLBACK TRANSACTION
		SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
		select @STR_MSG
		SET @RET_ID = -99
		RETURN ---99
END CATCH
end	
















GO
/****** Object:  StoredProcedure [dbo].[Api_InsertTransfer]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Api_InsertTransfer]
@branch char(2),
@trtype char(2),
@trdate varchar(10),
@text varchar(60),
@userid varchar(10),
@STR_MSG NVARCHAR(1000) OUT,
@RET_ID INT OUT,
@API_Trans nvarchar(max)
AS BEGIN 
    BEGIN TRANSACTION
	BEGIN TRY
		DECLARE @qty float 
		DECLARE @whno CHAR(2),@binno char(6)
		DECLARE @towhno CHAR(2),@tobinno char(6)
		DECLARE @barcode VARCHAR(20)
		declare @cmbkey char(24),@pack char(1)
		DECLARE @shdpk numeric(15,5),@shdqty float

		DECLARE @ttlqty float=0
		DECLARE @ttllcost float=0
		DECLARE @lprice float =0
		declare @fcost float =0
		DECLARE @itemno VARCHAR(16)
		DECLARE @unicode VARCHAR(6)
		DECLARE @lcost float
		DECLARE @handle INT	, @entries int=0
		declare @ss as varchar(10)
		declare @ref int,
		        @rmnqty float
-------------------------------------------------------------------
declare 
	@dbc nvarchar(14),
	@lcalcomp char(2),
	@yrcode char(4),
	@sysno int,
	@caalwngtvs bit

	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
	select @sysno=sysno,@caalwngtvs=caalwngtvs  from sysdb.dbo.glcalend 
	       where calcomp=@lcalcomp and yrcode=@yrcode
-------------------------------------------------------------------
		EXEC sp_xml_preparedocument @handle OUTPUT, @API_Trans

		Declare Curs Cursor For
		SELECT    *  
		FROM      OPENXML (@handle, '/ROOT/stdtl',2)  with
		(qty float,
		 whno char(2),binno char(6),
		towhno char(2),tobinno char(6),barcode char(20),cmbkey char(24),pack char(1),shdpk numeric(15,5),shdqty float)
		open Curs 
		Fetch Next From Curs Into @qty,@whno,@binno,@towhno,@tobinno,@barcode,@cmbkey,@pack,@shdpk,@shdqty

		set @entries=0

		SET @RET_ID =0

		SET @STR_MSG =''
		EXEC sp_xml_removedocument @handle
		DECLARE @j INT=1
		set @ref =0
	--			set @Trdate=CONVERT(VARCHAR(10), getdate(), 112)
		set @ref =dbo.get_last_ref('20', @branch)
		begin transaction
		update stbranch   set   jv_20 =@ref+1  WHERE   BRNNO=@branch 
		if @@error<>0
		begin
			rollback transaction
			SET @RET_ID = -4
		end
		else
		begin
		 commit transaction ;
		 select @ref ;
		end
		set @ss ='1'
		if @RET_ID=0
		begin
			set @ttllcost=0
			set @ttlqty=0
			set @trdate=replace(@trdate,'-','')
			SET @STR_MSG =cast(@ref as nvarchar(20))
			insert into sthdr (branch ,trtype,ref ,trdate ,text ,posted,whno ,towhno,usrid,asmtype, 
			amnttl,costttl,sysdate,src,released,fcy,fcyrate,entries,lastupdt,
			modified,rcvdtrn,custno,brsupp,tobrno,brxref,glref,isbrtrx )
			values(@branch ,'20',@ref ,@Trdate,@text,0,@whno,@towhno,@userid,0,0,0 , @Trdate,'03',1,'',0,0,@Trdate,
			0,0,'','','',0,0,0)
			
			WHILE @@FETCH_STATUS = 0  
			begin
				set @itemno =''
				set @unicode =''
				set @lcost =0
				set @lprice =0
				
				set @ttlqty=@ttlqty+@qty
				set @entries=@entries+1
				If (@sysno in (6))
				begin
					select @itemno =a.itemno,@unicode =a.UNICODE  ,@rmnqty=qty-b.rsvqty,
					@fcost =b.fcost,@lcost=b.lcost   from stitembc a inner join stbins b on a.itemno=b.itemno and a.unicode=b.unicode
					where cmbkey=@cmbkey and branch=@branch and whno=@whno and binno=@binno
				end
				else
				begin
					select @itemno =a.itemno,@unicode =a.UNICODE  ,@rmnqty=qty-b.rsvqty, @barcode = a.barcode ,
					@fcost =b.fcost,@lcost=b.lcost   from stunits a inner join stbins b on a.itemno=b.itemno and a.unicode=b.unicode
					where cmbkey=@cmbkey and branch=@branch and whno=@whno and binno=@binno
				end
				

				If (@sysno not in (2,3,6) Or (@sysno in (2,3,6) And @caalwngtvs=0)) and @qty>isnull(@rmnqty,0)
				begin
				    rollback transaction
				    SET @RET_ID = -9;
					SET @STR_MSG = 'fdf';
					break
				end
				set @ttllcost=@ttllcost+(@qty*@lcost)
		
				INSERT INTO STDTL (itemno,unicode,trtype,qty,whno,lcost,trdate,ref,sysdate ,src ,
				lprice,towhno ,barcode,binno,tobinno,branch ,cmbkey,fqty,fcost,fprice ,pack,shdpk ,shdqty ,folio)values(
				@itemno,@unicode,'20',@qty ,@whno ,@lcost ,@Trdate,@ref ,@Trdate,'03', @lprice,@towhno ,@barcode ,
				@binno,@tobinno,@branch ,@cmbkey,0,@fcost,0,@pack,@shdpk,@shdqty ,@j)
				SET @j=@j +1

				INSERT INTO STDTL (itemno,unicode,trtype,qty,whno,lcost,trdate,ref,sysdate ,src ,
				lprice,towhno ,barcode,binno,tobinno,branch ,cmbkey,fqty,fcost,fprice ,pack,shdpk ,shdqty ,folio)values(
				@itemno,@unicode,'20',@qty ,@towhno ,@lcost ,@Trdate,@ref ,@Trdate,'03', @lprice,'' ,@barcode ,
				@tobinno,'+',@branch ,@cmbkey,0,@fcost,0,@pack,@shdpk,@shdqty ,@j)

		

				update stbins set rsvqty =rsvqty+@qty  where branch =@branch  and whno =@whno and binno=@binno
				and itemno =@itemno  and unicode =@unicode 
				if @@error<>0
				begin
					rollback transaction
					SET @RET_ID = -5
					break
				end
				set @j=@j+1

				Fetch Next From Curs Into @qty,@whno,@binno,@towhno,@tobinno,@barcode,@cmbkey,@pack,@shdpk,@shdqty
			END
			update sthdr   set   entries =@entries,amnttl=@ttlqty,costttl=@ttllcost  WHERE   branch=@branch  and trtype=20 and ref=@ref 
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -6
			end
		end
		CLOSE Curs 
		DEALLOCATE Curs
		if @RET_ID=0
		begin
			
			COMMIT TRANSACTION
			SET @RET_ID = 1
		--	RETURN 	@@ROWCOUNT
		end
		else set @entries=0

	END TRY
	BEGIN CATCH
 	    ROLLBACK TRANSACTION
		SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  + CONVERT (VARCHAR, @ss) 

		SET @RET_ID = -21
		set @entries=0
	END CATCH
	
	
    if @@TRANCOUNT>0 
	  if @RET_ID<0 
	  begin
	  ROLLBACK TRANSACTION 
	  end
	  else
	  begin
	   COMMIT TRANSACTION ;
	   select @ref ;
	  end
	-- return --@entries 
END





GO
/****** Object:  StoredProcedure [dbo].[Api_InvoiceDt]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_InvoiceDt] (@branch char(2),@slcntr char(2), @invtype char(2),@refno bigint , @usrname char(10))
AS
BEGIN
	Declare @dbc varchar(20) , @comp char(2) , @yrcode char(4) , @calname varchar(100) , @taxcode varchar(50) , @sysno char(2) ;

	set @dbc=db_name();
	set @comp=substring(@dbc,4,2);
	set @yrcode=substring(@dbc,7,2);
	set @yrcode=iif(cast(@yrcode as int)>40,'14','20')+rtrim(@yrcode);

	------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @calname = calname , @taxcode = taxcode , @sysno = sysno from sysdb.dbo.glcalend with (nolock) where calcomp=@comp and yrcode=@yrcode
	--------------------------------------------------------------------------------------------------------------------------- 
	
	select @calname as companyname , @taxcode as taxcode ,slh.ref as refno , slh.invtype ,slh.custno ,slh.custnm ,slh.clnt_taxcode ,slh.invdate ,slh.valafds ,
	slh.invdsvl ,slh.invdspc ,slh.extamt ,slh.vat_amt_rcvd , slh.datetime_stamp, slh.PriceVatType as pricevattype ,cut.cu_name ,slc.dp_name,sld.folio,sld.cmbkey , sld.qty , sld.barcode , sld.price ,
	(sld.qty * sld.price) * (iif(discpc > 0 , discpc/100 , 1)) as total , sti.name as itemname, orp.pkname
	from sales_hd slh with (nolock)
	left join sales_dt sld with (nolock) on slh.slcenter = sld.slcenter and slh.company = sld.company and slh.invtype = sld.invtype and slh.ref = sld.ref 
	left join stitems sti  with (nolock) on sld.cmbkey = sti.modelno
	left join customer cut with (nolock) on slh.custno = cut.cu_code and slh.company = cut.cu_company
	left join salecntr slc with (nolock) on slh.slcenter = slc.dp_dept and slh.company = slc.dp_brno
	left join orpacking orp with (nolock) on sld.pack =  orp.pack_id
	where slh.company = @branch and slh.invtype = @invtype and slh.ref = @refno and slh.slcenter = @slcntr and slh.usrid = @usrname ;
	
END







GO
/****** Object:  StoredProcedure [dbo].[Api_InvoiceItem_Balance]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Api_InvoiceItem_Balance]
(@m_Branch_code char(2),@m_supp_code char(6),@m_splyinv char(10),@Language smallint = 1)
AS BEGIN

;with cte_splyinv (splyinv,splycode,invdate,cmbkey,company,lcost,qty,invtype,ref,itemno,unicode)
as
(select  a.splyinv,a.custno as splycode,a.invdate ,b.cmbkey,a.company,lcost,
sum(iif(b.invtype in ('10','11'),(b.qty+b.fqty),-(b.qty+b.fqty))*pkqty) as qty
,a.invtype,a.ref,b.itemno,b.unicode
 from puhdr a with (nolock) inner join pudtl b with (nolock)
 on a.company=b.company and a.invtype=b.invtype and a.ref=b.ref
 inner join stdtl c on b.company=c.branch and b.invtype=c.trtype and b.ref=c.ref and b.itemno=c.itemno 
 and b.unicode=c.unicode and b.folio = c.folio
 where a.company=@m_Branch_code and a.custno=@m_supp_code and a.splyinv=@m_splyinv
 group by a.company,a.custno,a.splyinv,b.cmbkey,a.invtype,a.ref,b.itemno,b.unicode,a.invdate,lcost
)
,cte_solditems 
as
(select d.itemno,d.unicode,sum(iif(d.invtype in ('04','06'),d.qty+d.fqty,-(d.qty+d.fqty))*pkqty) as slqty,
 sum(iif(d.invtype in ('04','06'),d.qty,-d.qty)*d.price) as ttlprice,
 sum(iif(d.invtype in ('04','06'),d.qty+d.fqty,-(d.qty+d.fqty))*d.cost) as ttlcost
 from sales_dt d with (nolock) inner join cte_splyinv with (nolock)
 on d.itemno=cte_splyinv.itemno and d.unicode=cte_splyinv.unicode
 where d.invdate>=cte_splyinv.invdate
 group by d.itemno,d.unicode
)
select ltrim(rtrim(cmbkey))cmbkey,ltrim(rtrim(iif(@Language = 1 and stitems.lname <> '' , stitems.lname ,  stitems.name))) name,
cast(qty as numeric(12,2)) as purchase_qty,round(lcost,3) as Purchase_price,
round(qty*lcost,3) as Total_purchase,cast(iif(slqty>qty,qty,slqty) as numeric(12,2)) as SoldQty,
cast(ttlprice/iif(slqty<>0,slqty,1) as numeric(12,2)) as UnitPrice,
cast((ttlprice/iif(slqty<>0,slqty,1))*iif(slqty>qty,qty,slqty) as numeric(12,2)) as totalSales,
cast(qty-iif(isnull(slqty,0)>qty,qty,isnull(slqty,0)) as numeric(12,2)) balance,
cast(((ttlprice/iif(slqty<>0,slqty,1))-lcost)*iif(slqty>qty,qty,slqty) as numeric(12,2))as profit,
round(cast(qty-iif(slqty>qty,qty,slqty) as numeric(12,2))*round(lcost,3),2) as CostRemaining
from cte_splyinv v with (nolock) left outer join cte_solditems x with (nolock)
on v.itemno=x.itemno and v.unicode=x.unicode
left outer join stitems on stitems.itemno=v.itemno
END 















GO
/****** Object:  StoredProcedure [dbo].[Api_loginPosDsc]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_loginPosDsc] @mobileno varchar(21) , @password varchar(10)
AS
BEGIN
	SET NOCOUNT ON;
	if	(Select count(*) from pos_dsc with (nolock) where (dsccard = @mobileno or dsctel = @mobileno) and pass = @password) > 0
	begin
	select dsccard,dsctel,cust_ttlsales,FLOOR(cust_ttlsales*(trgt_prcnt/100)) as ryl from pos_dsc with (nolock) 
	where (dsccard = @mobileno or dsctel = @mobileno) and pass = @password ;
	end
	else
	select -1;
END






GO
/****** Object:  StoredProcedure [dbo].[Api_post_xfr_trx]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[Api_post_xfr_trx]
 @m_cmp char(2),
 @m_type char(2),
 @m_ref  numeric(6,0), 
 @errstatus int = 0 output
	
AS
BEGIN
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
		SET NOCOUNT ON


		
		merge stbins as t
		using (select distinct branch,a.itemno,a.unicode,whno,binno,a.lcost,a.fcost from stdtl a inner join stunits b on a.itemno=b.itemno 
			and a.unicode=b.unicode where a.branch=@m_cmp and a.trtype=@m_type and a.ref=@m_ref ) as s
		on t.branch=s.branch and t.itemno=s.itemno and t.unicode=s.unicode and t.whno=s.whno and t.binno=s.binno
		when not matched then
		insert values (s.branch,s.itemno,s.unicode,s.whno,s.binno,0,0,0,s.lcost,s.fcost,0,0,'');
		if @@error<>0
		begin
			set @errstatus=-1	
			return --@errstatus			 				
		end
	---
	--- Update Curbal & Rsvqty in STUNITS
	---
		--update  stunits set rsvqty=iif((rsvqty+iif(@m_type in ('04','06'),-a.ttlrsvqty,0))>0,
		--		rsvqty+iif(@m_type in ('04','06'),-a.ttlrsvqty,0),0),
		--		curbal=curbal+iif(@m_type in ('04','06'),-a.ttlrsvqty,a.ttlrsvqty),lcost=iif(lcost<=0,a.cost,lcost),
		--		moved=1,LASTISSUE=iif(LASTISSUE<a.invdate,a.invdate,LASTISSUE)
		--from stunits as b
		--join 
		--(select c.itemno,[unicode],sum(qty*iif(pkqty=0,1,pkqty)) as ttlrsvqty,cost,invdate 
		--	from sales_dt c inner join stitems on c.itemno=stitems.itemno
		--	where  c.company=@m_cmp and INVTYPE=@m_type and ref=@m_ref and itemtype<>'5' 
		--	group by c.itemno,c.unicode,cost,invdate) a
		--on a.itemno=b.itemno and a.unicode=b.unicode
		--if @@error<>0
		--begin
		--	set @errstatus=-1
		--	return @errstatus
		--end
	---
	--- Update Qty & Rsvqty in STBINS
	---
		update  stbins set rsvqty=iif(rsvqty+ttlrsvqty>=0,rsvqty+ttlrsvqty,0),
				qty=qty+ttlqty,lcost=iif(lcost<=0,a.cost,lcost)
		from stbins as b
		join 
		(select branch,itemno,unicode,whno,binno,sum(iif(len(towhno)>0,-qty,qty)) as ttlqty,lcost as cost,
		 sum(iif(len(towhno)>0,-qty,0)) as ttlrsvqty from stdtl
		 where  branch=@m_cmp and trTYPE=@m_type and ref=@m_ref 
			group by  branch,itemno,unicode,whno,binno,lcost) a
		on a.branch=b.branch and a.itemno=b.itemno and a.unicode=b.unicode and a.whno=b.whno and a.binno=b.binno
		if @@error<>0
		begin
			set @errstatus=-2
			return @errstatus
		end
		update sthdr set posted= '1' ,RELEASED = '1' where branch=@m_cmp and trTYPE=@m_type and ref=@m_ref 
		if @@error<>0
		begin
			set @errstatus=-3
		end
		return @errstatus
end










GO
/****** Object:  StoredProcedure [dbo].[Api_PriceChecker]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_PriceChecker]
	@barcode varchar(20)
AS
BEGIN
	SET NOCOUNT ON ;	
	declare @sysno numeric(1,0)  ;
	declare @compCode char(2) ;
	declare @yrCode char(2) ;
	declare @multibarcode bit ;
	

	set @compCode = substring(DB_NAME(),4,2) ; 
	set @yrCode = substring(DB_NAME(),7,2) ; 

	set @sysno = (select sysno from sysdb.dbo.glcalend where calcomp = @compCode And substring(yrcode,3,2) = @yrCode) ;
	set @multibarcode= (select multibarcode from sysdb.dbo.glcalend with(nolock) where calcomp = @compCode And substring(yrcode,3,2) = @yrCode);
	
	if(@sysno = '6' or @multibarcode = '1')
	begin
	
	select case a.itext when ''  then ltrim(rtrim(b.name)) else  ltrim(rtrim(b.name)) +' '+  ltrim(rtrim( a.itext)) end as itemName, case b.lname  when ''  then ltrim(rtrim( b.Lname)) else  ltrim(rtrim( b.Lname)) +' '+  ltrim(rtrim( a.itext)) end as itemNameEn , a.lprice1  as price 
	from stitembc A inner join stitems B on A.itemno=b.itemno where pbarcode=@Barcode

	end

	else

	begin

	select ltrim(rtrim(a.name)) as itemName , ltrim(rtrim(a.lname)) as itemNameEn, b.lprice1  as price 
	from stitems  A	 inner join stunits B on A.itemno=b.itemno where barcode=@Barcode
	
	end

END






GO
/****** Object:  StoredProcedure [dbo].[Api_PrintCashRcvd]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_PrintCashRcvd] (@company char(2), @refno bigint , @usrname char(10))
AS
BEGIN
	Declare @dbc varchar(20) , @comp char(2) , @yrcode char(4) , @calname varchar(100) , @taxcode varchar(50) , @sysno char(2) , @fullname varchar(30);

	set @dbc=db_name();
	set @comp=substring(@dbc,4,2);
	set @yrcode=substring(@dbc,7,2);
	set @yrcode=iif(cast(@yrcode as int)>40,'14','20')+rtrim(@yrcode);

	------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @calname = calname from sysdb.dbo.glcalend with (nolock) where calcomp=@comp and yrcode=@yrcode
	select @fullname = fullname from sysuse where username = @usrname ;
	--------------------------------------------------------------------------------------------------------------------------- 
	select @calname as companyname,@fullname as fullname, hd_ref , hd_type , hd_date , hd_desc1 , hd_lcnet , hd_ser , cu_code  , cu_name
	from arhdr s1 with(nolock) inner join ardtl s2 with(nolock) on 
	s1.hd_company = s2.dt_company and s1.hd_type = s2.dt_type and s1.hd_ref = s2.dt_ref
	left join customer s3 on s2.dt_company = s3.cu_company and s2.dt_cucode = s3.cu_code where hd_type = '02' and s1.hd_company = @company and s1.hd_ref = @refno ;
END





GO
/****** Object:  StoredProcedure [dbo].[Api_PrintQH]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_PrintQH] (@slcntr char(2), @invtype char(2),@refno bigint , @usrname char(10))
AS
BEGIN
	Declare @dbc varchar(20) , @comp char(2) , @yrcode char(4) , @calname varchar(100) , @taxcode varchar(50) , @sysno char(2) ;

	set @dbc=db_name();
	set @comp=substring(@dbc,4,2);
	set @yrcode=substring(@dbc,7,2);
	set @yrcode=iif(cast(@yrcode as int)>40,'14','20')+rtrim(@yrcode);

	------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @calname = calname , @taxcode = taxcode , @sysno = sysno from sysdb.dbo.glcalend with (nolock) where calcomp=@comp and yrcode=@yrcode
	--------------------------------------------------------------------------------------------------------------------------- 

	select @calname as companyname , @taxcode as taxcode ,slh.ref as refno , slh.invtype ,slh.custno ,slh.custnm ,slh.clnt_taxcode ,
	slh.invdate ,slh.valafds ,slh.invdsvl ,slh.invdspc ,slh.extamt ,slh.vat_amt_rcvd ,cut.cu_name ,slc.dp_name
	,sld.folio,sld.cmbkey , sld.qty , sld.barcode , sld.price , (sld.qty * sld.price) * (iif(discpc > 0 , discpc/100 , 1)) as total , sti.name as itemname , orp.pkname 
	from sales_qh slh with (nolock)
	left join sales_qd sld with (nolock) on slh.slcenter = sld.slcenter and slh.company = sld.company and slh.ref = sld.ref 
	left join stitems sti  with (nolock) on sld.cmbkey = sti.modelno
	left join customer cut with (nolock) on slh.custno = cut.cu_code and slh.company = cut.cu_company
	left join salecntr slc with (nolock) on slh.slcenter = slc.dp_dept and slh.company = slc.dp_brno
	left join orpacking orp with (nolock) on sld.pack = orp.pack_id
	where slh.invtype = @invtype and slh.ref = @refno and slh.slcenter = @slcntr and slh.usrid = @usrname ;
	
END








GO
/****** Object:  StoredProcedure [dbo].[Api_PrintSales]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_PrintSales] (@branch char(2), @slcntr char(2), @invtype char(2),@refno bigint , @usrname char(10))
AS
BEGIN
	Declare @dbc varchar(20) , @comp char(2) , @yrcode char(4) , @calname varchar(100) , @taxcode varchar(50) , @sysno char(2) ;

	set @dbc=db_name();
	set @comp=substring(@dbc,4,2);
	set @yrcode=substring(@dbc,7,2);
	set @yrcode=iif(cast(@yrcode as int)>40,'14','20')+rtrim(@yrcode);

	------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @calname = calname , @taxcode = taxcode , @sysno = sysno from sysdb.dbo.glcalend with (nolock) where calcomp=@comp and yrcode=@yrcode
	--------------------------------------------------------------------------------------------------------------------------- 
	update sales_hd set inv_printed = (select ISNULL(inv_printed,0) + 1 from sales_hd with(nolock) where slcenter =@slcntr and invtype = @invtype and ref = @refno and usrid = @usrname);
	select @calname as companyname , @taxcode as taxcode ,slh.ref as refno , slh.invtype ,slh.custno ,slh.custnm ,slh.clnt_taxcode ,slh.invdate ,slh.valafds ,
	slh.invdsvl ,slh.invdspc ,slh.extamt ,slh.vat_amt_rcvd , slh.datetime_stamp, slh.PriceVatType as pricevattype ,cut.cu_name ,slc.dp_name,sld.folio,sld.cmbkey , sld.qty , sld.barcode , sld.price ,
	(sld.qty * sld.price)-(sld.qty * sld.price) * (iif(discpc > 0 , discpc/100 , 0)) as total , sld.fqty, sld.discpc, sld.frtqty, sld.shdpk, sld.shdqty, sti.name as itemname, orp.pkname
	from sales_hd slh with (nolock)
	left join sales_dt sld with (nolock) on slh.slcenter = sld.slcenter and slh.company = sld.company and slh.invtype = sld.invtype and slh.ref = sld.ref 
	left join stitems sti  with (nolock) on sld.cmbkey = sti.modelno
	left join customer cut with (nolock) on slh.custno = cut.cu_code and slh.company = cut.cu_company
	left join salecntr slc with (nolock) on slh.slcenter = slc.dp_dept and slh.company = slc.dp_brno
	left join orpacking orp with (nolock) on sld.pack =  orp.pack_id
	where slh.invtype = @invtype and slh.ref = @refno and slh.company = @branch and slh.slcenter = @slcntr and slh.usrid = @usrname ;
	
END


GO
/****** Object:  StoredProcedure [dbo].[Api_PrintTransfer]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_PrintTransfer] (@branchno char(2), @type char(2),@refno bigint , @userid char(10))
AS
BEGIN
	
	select s1.ref as refno,s1.trtype,s1.trdate,(select name from stwhous where whno = s1.whno)fwhno,
	(select name from stwhous where whno = s1.towhno)towhno,[text],s1.amnttl,s3.folio,s3.shdqty,s3.shdpk,qty,
	s3.cmbkey,s3.barcode,s4.name,s5.pkname 
	from sthdr s1 
	inner join stwhous s2 on s1.branch = s2.branch and s1.whno = s2.whno 
	inner join stdtl s3 on s1.branch = s3.branch and s1.trtype = s3.trtype and s1.ref= s3.ref 
	inner join stitems s4 on s3.itemno = s4.itemno inner join orpacking s5 on s3.pack = s5.pack_id
	where s3.tobinno = '+' and s1.branch = @branchno and s1.trtype = @type and s1.ref = @refno
	
END





GO
/****** Object:  StoredProcedure [dbo].[Api_Purchase_represtative_Person_Summary]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Api_Purchase_represtative_Person_Summary]
(
@m_Branch_code char(2),@m_supp_code char(6),@purchase_person char(2),@fdate char(8) ,@tdate char(8)
)
AS BEGIN
;with cte_Openbal (cmbkey,name,itemno,unicode,openbal)
as
(select c.cmbkey,b.name,a.itemno,c.unicode,Sum(isnull(d.openbal,0)) as openbal
from puprsnitems a with (nolock) inner join stitems b with (nolock)
on a.itemno=b.itemno inner join stunits c on b.itemno=c.itemno
left outer join stbins d with (nolock) on c.itemno=d.itemno and c.unicode=d.unicode
where slcode=@purchase_person and branch=@m_Branch_code and splycode=@m_supp_code
group by cmbkey,a.itemno,c.unicode,b.name 
)
,cte_trxOpnbal
as
(select d.itemno,d.unicode,topenbal=sum(isnull(iif(trtype in ('05','01','12','13','10','11','24','26'),(qty+fqty),-(qty+fqty)),0))
from  stdtl d with (nolock) inner join cte_Openbal f with (nolock)
on d.itemno=f.itemno and d.unicode=f.unicode
where d.trdate<@fdate
group by d.itemno,d.unicode
)
,ctr_curntbal
as
(select d.itemno,d.unicode,purchasebal=sum(iif(src='07',iif(trtype in ('10','11'),(qty+fqty),-(qty+fqty)),0)),
salesbal=sum(iif(src='05',iif(trtype in ('04','06'),(qty+fqty),-(qty+fqty)),0)),
adjbal=sum(iif(trtype in ('12','13'),(qty+fqty),0)),
inoutbal=sum(iif(trtype in ('05','09','01','02'),iif(trtype in ('05','01'),(qty+fqty),-(qty+fqty)),0))
from  stdtl d with (nolock) inner join cte_Openbal f with (nolock)
on d.itemno=f.itemno and d.unicode=f.unicode
where d.trdate between @fdate and @tdate
group by d.itemno,d.unicode
)
select cmbkey,name,openbal+isnull(topenbal,0) as prdopenbal,isnull(purchasebal,0) purchase_qty,isnull(adjbal,0) as adjustment,
isnull(inoutbal,0) as InOut,isnull(salesbal,0) as sales_qty,openbal+isnull(topenbal,0)+isnull(purchasebal,0)
+isnull(adjbal,0)+isnull(inoutbal,0)-isnull(salesbal,0) as current_balance
from ((cte_openbal a with (nolock) left outer join cte_trxOpnbal b with (nolock) on a.itemno=b.itemno and a.unicode=b.unicode)
left outer join ctr_curntbal c on a.itemno=c.itemno and a.unicode=c.unicode)

END
--declare @m_Branch_code char(2)='01',
--        @m_supp_code char(6)='60',
--		@purchase_person char(2)='7'
--declare @fdate char(8) ='20110101',
--        @tdate char(8)='20150101'














GO
/****** Object:  StoredProcedure [dbo].[Api_PurchasePerson]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_PurchasePerson]
	
AS
BEGIN
	
	Select slcode , ltrim(rtrim(slname)) name from salesmen with (nolock) Where purshman = 1
END












GO
/****** Object:  StoredProcedure [dbo].[Api_SALES_POS]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Api_SALES_POS]
@fdate varchar(20) ,
@tdate varchar(20) ,
@Language smallint = 1 

AS BEGIN
declare @pos_start int ;
select @pos_start = pos_strt_h from sysdb.dbo.glcalend ;

--------------------------------------------------Sales Summary by sales center 1
	select company,slcenter, ROUND(SUM(IIF(invorrtrn='1', valafds -invdsvl - hlldscnt , -(valafds -invdsvl - hlldscnt))),2) as Invtotal ,
	(select iif(@language <> 1 And dp_lname <> '',dp_lname,dp_name) from salecntr s where s.dp_brno = company and s.dp_dept = slcenter) as salescenter_Name
	from pos_hd with (nolock) inner join salecntr with (nolock)
	on pos_hd.company=salecntr.dp_brno and pos_hd.slcenter=salecntr.dp_dept
	where invorrtrn <>'4' and tdatetime between DATEADD(hour,iif(@pos_start = 4 , 4,  5), CAST(@fdate  AS smalldatetime))
	 and DATEADD(hour,iif(@pos_start = 4 , 28,  29), CAST(@tdate  AS smalldatetime))
	group by company,slcenter ORDER BY company,slcenter 

END


 












GO
/****** Object:  StoredProcedure [dbo].[Api_SALES_SUMMARY]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Api_SALES_SUMMARY]
@by_branch bit,
@m_Branch_code char(2) = '',
@fdate char(8) ,
@tdate char(8),
@usr_showcost bit =1,
@cmb_wth_last_year bit = 0 ,
@Language smallint = 1 

AS BEGIN
--------------------------------------------------Sales Summary by sales center 1
declare @showcost as int=0,
 @dynamicSQL as nvarchar(max)
 declare @dbc varchar(40),
 @paralist nvarchar(400)
 declare @yrcode char(2)
 DECLARE @lastYearCursor CURSOR
 declare @lfdate char(8),@ltdate char(8)
 set @showcost=iif(@usr_showcost=1,1,0) 
 set @dbc=DB_NAME()	

   declare @ldp_brno char(2)='', @yrfolio int ,
   @ldp_dept char(2)='',
   @ldp_name varchar(40),
   @lslnet float = 0,
   @recnos int=0,
   @error int = 0
	if @cmb_wth_last_year = 1
	begin
	      set @showcost=1
		  set @yrfolio = (select max(yrfolio) from sysdb.dbo.glcalend with(nolock) where calcomp = substring(DB_NAME(),4,2)) ;
		  set @yrcode= (select substring(yrcode,3,2) from sysdb.dbo.glcalend with(nolock) where yrfolio = @yrfolio - 1) ;
		  set @dbc= substring(DB_NAME() ,1,6) + @yrcode;
		  set @lfdate=substring(@fdate,1,2)+str(cast(substring(@fdate,3,2) as int)-1,2)+substring(@fdate,5,4)
		  set @ltdate=substring(@tdate,1,2)+str(cast(substring(@tdate,3,2) as int)-1,2)+substring(@tdate,5,4)
		  if ((select yrcode from sysdb.dbo.glcalend with(nolock) where yrfolio = @yrfolio - 1) < 2000)
			begin	
		  set @lfdate = (SELECT FORMAT ( cast(@lfdate as date), 'yyyyMMdd', 'ar-SA' ))
		  set @ltdate = (SELECT FORMAT ( cast(@ltdate as date), 'yyyyMMdd', 'ar-SA' ))
			end
	end
if @by_branch=0
begin
   create table dbo.#crntYear
   (
     dp_brno char(2)  null,
	 bran_name varchar(40)  null default '',
     dp_dept char(2)  null,
	 dp_name varchar(40)  null,
	 slnet float null default 0,
	 slcst float null default 0,
	 Profit float null default 0
   )


   
   insert into dbo.#crntYear
	select dp_brno ,
	(select ltrim(rtrim(iif(@language<>1 and lname <> '', lname , name)))name 
	from stbranch with (nolock) where brnno = dp_brno) ,
	dp_dept ,iif(@language <> 1 and dp_lname <> '' , dp_lname , dp_name) dp_name ,slnet=sum(iif(invtype in ('04','06'),
	valafds-((invdsvl+iif(hlldscnt is null , 0 , hlldscnt)) + iif(priceVatType = 1,0, vat_amt_rcvd)) ,
	-(valafds-((invdsvl+iif(hlldscnt is null , 0 , hlldscnt)) + iif(priceVatType = 1,0, vat_amt_rcvd))))),
	slcst=round(sum(iif(invtype in ('04','06'),invcst,-invcst)),2)*@showcost,
	Profit=(sum(iif(invtype in ('04','06'),valafds-invdsvl,-(valafds-invdsvl)))-round(sum(iif(invtype in ('04','06'),
	invcst,-invcst)),2))*@showcost
	
	from salecntr a with (nolock) inner join sales_hd b with (nolock)
	on a.dp_brno=b.company and a.dp_dept=b.slcenter
	where invdate between  @fdate and @tdate and (dp_brno=@m_branch_code or @m_Branch_code = '')
	group by dp_brno,dp_dept,dp_name,dp_lname

	if @cmb_wth_last_year = 1
	begin
	
		  if exists(SELECT name FROM sys.databases where name=@dbc)
		  begin
		      set @paralist=N'@lastYearCursor CURSOR OUTPUT'
	          SET @dynamicSQL = 'SET @lastYearCursor = CURSOR FORWARD_ONLY STATIC FOR  
			    select dp_brno ,dp_dept ,dp_name ,slnet=sum(iif(invtype in (''04'',''06''),
				valafds-((invdsvl+iif(hlldscnt is null , 0 , hlldscnt)) + iif(priceVatType = 1,0, vat_amt_rcvd)) ,
				-(valafds-((invdsvl+iif(hlldscnt is null , 0 , hlldscnt)) + iif(priceVatType = 1,0, vat_amt_rcvd)))))
				from '+@dbc+'.dbo.salecntr a with (nolock) inner join '+@dbc+'.dbo.sales_hd b with (nolock)
				on a.dp_brno=b.company and a.dp_dept=b.slcenter
				where invdate between '''+ @lfdate+''' and '''+@ltdate+''' and (dp_brno='''+@m_branch_code+''' or ''' + @m_branch_code + '''='''')
				group by dp_brno,dp_dept,dp_name ; OPEN @lastYearCursor'

				EXECUTE sp_executesql @dynamicSQL ,
				   N'@lastYearCursor CURSOR OUTPUT',
				   @lastYearCursor output
				   
				FETCH NEXT FROM @lastYearCursor INTO @ldp_brno,@ldp_dept,@ldp_name,@lslnet
				WHILE @@FETCH_STATUS = 0
				BEGIN
					set @recnos=0
					select @recnos=count(*) from dbo.#crntYear where dp_brno= @ldp_brno and dp_dept=@ldp_dept;
				
					
					
					set @recnos=isnull(@recnos,0)
					if @recnos=0
						insert into dbo.#crntYear (dp_brno,dp_dept,dp_name,slcst,Profit)
						values (@ldp_brno,@ldp_dept,@ldp_name,@lslnet,-@lslnet)
					else
						update dbo.#crntYear set slcst=@lslnet,Profit=slnet-slcst where dp_brno= @ldp_brno and dp_dept=@ldp_dept 
					if @@error<>0 
					begin
					    set @error = -1
						break
					end
					FETCH NEXT FROM @lastYearCursor INTO @ldp_brno,@ldp_dept,@ldp_name,@lslnet
				end
		        CLOSE @lastYearCursor
                DEALLOCATE @lastYearCursor
		  end
	end
	if @error=0 select * from dbo.#crntYear order by dp_brno,dp_dept
    DROP TABLE dbo.#crntYear
end
---------------------------------------------------Sales Summary by branches 
else
	begin
		create table dbo.#crntYearB
	   (dp_brno char(2) not null,
		 bran_name varchar(40) not null,
		 slnet float null default 0,
		 slcst float null default 0,
		 Profit float null default 0
	   )	
      insert into dbo.#crntYearB	
		select brnno ,ltrim(rtrim(iif(@language<>1 and lname <> '', lname , name)))name ,slnet=sum(iif(invtype in ('04','06'),
		valafds-((invdsvl+iif(hlldscnt is null , 0 , hlldscnt)) + iif(b.priceVatType = 1,0, vat_amt_rcvd)) ,-(valafds-((invdsvl+iif(hlldscnt is null , 0 , hlldscnt)) + iif(b.priceVatType = 1,0, vat_amt_rcvd))))),
		slcst=round(sum(iif(invtype in ('04','06'),invcst,-invcst)),2)*@showcost,
		Profit=(sum(iif(invtype in ('04','06'),valafds-invdsvl,-(valafds-invdsvl)))-round(sum(iif(invtype in ('04','06'),invcst,-invcst)),2))*@showcost 
		from stbranch a with (nolock) inner join sales_hd b with (nolock) on a.brnno=b.company 
		where invdate between  @fdate and @tdate and (b.company = @m_Branch_code or @m_Branch_code = '')
		group by brnno,name,lname
		
		if @cmb_wth_last_year = 1
		begin
			if exists(SELECT name FROM sys.databases where name=@dbc)
			begin
				set @paralist=N'@lastYearCursor CURSOR OUTPUT'
				SET @dynamicSQL = 'SET @lastYearCursor = CURSOR FORWARD_ONLY STATIC FOR  
				select brnno  ,name ,slnet=sum(iif(invtype in (''04'',''06''),valafds-invdsvl,-(valafds-invdsvl)))
				from '+@dbc+'.dbo.stbranch a with (nolock) inner join '+@dbc+'.dbo.sales_hd b with (nolock)
				on a.brnno=b.company
				where invdate between '''+ @lfdate+''' and '''+@ltdate+'''
				group by brnno,name ; OPEN @lastYearCursor'

				EXECUTE sp_executesql @dynamicSQL ,
					N'@lastYearCursor CURSOR OUTPUT',
					@lastYearCursor output

				FETCH NEXT FROM @lastYearCursor INTO @ldp_brno,@ldp_name,@lslnet
				WHILE @@FETCH_STATUS = 0
				BEGIN
					set @recnos=0
					select @recnos=count(*) from dbo.#crntYearB where dp_brno= @ldp_brno 
					set @recnos=isnull(@recnos,0)
					if @recnos=0
						insert into dbo.#crntYearB (brnno,name,slnet,slcst,Profit)
						values (@ldp_brno,@ldp_name,0,@lslnet,-@lslnet)
					else
						update dbo.#crntYearB set slcst=@lslnet,Profit=slnet-@lslnet where dp_brno= @ldp_brno  
					if @@error<>0 
					begin
						set @error = -1
						break
					end
					FETCH NEXT FROM @lastYearCursor INTO @ldp_brno,@ldp_name,@lslnet
				end
				CLOSE @lastYearCursor
				DEALLOCATE @lastYearCursor
			end
		end
		if @error=0 select * from dbo.#crntYearB order by dp_brno
		DROP TABLE dbo.#crntYearB
	END
end













GO
/****** Object:  StoredProcedure [dbo].[Api_Sales_Summary_by_Categories]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE  [dbo].[Api_Sales_Summary_by_Categories]
(
	@fdate char(8),@tdate char(8), @cmbkey varchar(12), @branch char(2) ='' , @class_level int = 0, @usr_showcost bit=1 , @Language smallint = 1
)
AS 
BEGIN

declare @showcost as int=0,
        @lsyscode int=1
set @showcost=iif(@usr_showcost=1,1,0) 
declare 
	@dbc nvarchar(14),
	@lcalcomp char(2),
	@yrcode char(4)

	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
--------------------------------------------------
declare
	@class_len int,
	@lSysno_PVT_level int=0,
	@lvat_percent numeric(10,3)=5.00,
	@lno_round_nm bit = 0,
	@lpercent_rslt float=0,
	@mlvl int =0

    if @class_level=0 set @class_level=1


------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @lSysno_PVT_level=isnull(Sysno_PVT_level,0),@lvat_percent=isnull(vat_percent,0),@lsyscode=sysno,@lno_round_nm=isnull(no_round_nm,0)
	from sysdb.dbo.glcalend  where calcomp=@lcalcomp and yrcode=@yrcode
  
    set @lpercent_rslt=@lvat_percent/(100+@lvat_percent)


	if len(@cmbkey) = 0 
	begin
		if @class_level<4
		set @class_len=@class_level*2
		else if @class_level=4 set @class_len=9
		else set @class_len=12
		;with cte_table
		as (
		select Substring(stitems.classkey,1,@class_len) as ClassKey,
		ltrim(rtrim((select iif(@language <> 1 And lname <> '',lname,name) from stclass where rtrim(cmbkey)=Substring(stitems.classkey,1,@class_len))))name,
		SellPrice=sum(iif(@lSysno_PVT_level in (1,2,3),iif(sales_hd.no_round_nm=1,
		((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)),
		iif(@lsyscode in (1,4,5,6,8,9) or @lno_round_nm=1,((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)))*iif(sales_hd.invtype in ('04','06'),1,-1)),
		sl_salesvat=sum(iif(isnull(sales_dt.taxtype,'1')<='1' and
		((len(sales_hd.custno)>0 and isnull(sales_hd.clnt_kind,'1')<='1') or
		(len(sales_hd.custno)=0 and isnull(sales_hd.clnt_kind,'0') not in ('C','I'))) and isnull(sales_hd.vat_amt_rcvd,0)>0 
		and isnull(sales_hd.pricevattype,1)>1 ,(iif(@lSysno_PVT_level in (1,2,3),iif(sales_hd.no_round_nm=1,
		((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)),
		iif(@lsyscode in (1,4,5,6,8,9) or @lno_round_nm=1,((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)))) -iif(invdsvl>0 and valafds>0 ,(invdsvl/valafds)
		 *(iif(@lSysno_PVT_level in (1,2,3),iif(sales_hd.no_round_nm=1,
		((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)),
		iif(@lsyscode in (1,4,5,6,8,9) or @lno_round_nm=1,((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval))))
		,0.00),0.00)*iif(sales_hd.invtype in ('04','06'),1,-1)),
		SellCost=sum(case when sales_dt.invtype in ('04','06') then sales_dt.cost*(qty+fqty)*pkqty else -sales_dt.cost*(qty+fqty)*pkqty end)*@showcost,
		Discount= sum((invdsvl/valafds)*iif(@lSysno_PVT_level in (1,2,3),iif(sales_hd.no_round_nm=1,
		((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)),
		iif(@lsyscode in (1,4,5,6,8,9) or @lno_round_nm=1,((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)))*(case when sales_hd.invtype in ('04','06') then 1 else -1 end)),
		sl_hlldscnt=sum(iif(isnull(hlldscnt,0)=0 or valafds=0,0.00,iif(@lSysno_PVT_level in (1,2,3),iif(sales_hd.no_round_nm=1,
		((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)),
		iif(@lsyscode in (1,4,5,6,8,9) or @lno_round_nm=1,((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)))*(hlldscnt/valafds)
		*iif(sales_hd.invtype in ('04','06'),1,-1)))
		FROM  STITEMS inner join stunits inner Join sales_dt inner Join sales_hd
		on sales_dt.company=sales_hd.company and sales_dt.invtype=sales_hd.invtype and sales_dt.ref=sales_hd.ref
		on stunits.itemno=sales_dt.itemno and stunits.Unicode=sales_dt.Unicode
		on stitems.itemno=stunits.itemno
		where  valafds<> 0 and sales_hd.invdate between  @fdate and @tdate and (sales_hd.company=@branch Or @branch = '') 
		group by Substring(stitems.classkey,1,@class_len)) 

		select classkey,name,sellprice-Discount-(sl_salesvat*@lpercent_rslt)-sl_hlldscnt as sellprice,SellCost , Discount from cte_table order by classkey
    End
    else
	begin
	    set @mlvl=len(rtrim(@cmbkey))
		set @class_len=(case when @mlvl<=2 then 4
		                     when @mlvl>2 and @mlvl<=4 then 6
							 when @mlvl>4 and @mlvl<=6 then 9
							 when @mlvl>6 and @mlvl<=9 then 12
							 end)
		;with cte_table
		as (
		select Substring(stitems.classkey,1,@class_len) as ClassKey,
		ltrim(rtrim((select iif(@language <> 1 And lname <> '',lname,name) from stclass where rtrim(cmbkey)=Substring(stitems.classkey,1,@class_len))))name,
		SellPrice=sum(iif(@lSysno_PVT_level in (1,2,3),iif(sales_hd.no_round_nm=1,
		((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)),
		iif(@lsyscode in (1,4,5,6,8,9) or @lno_round_nm=1,((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)))*iif(sales_hd.invtype in ('04','06'),1,-1)),
		sl_salesvat=sum(iif(isnull(sales_dt.taxtype,'1')<='1' and
		((len(sales_hd.custno)>0 and isnull(sales_hd.clnt_kind,'1')<='1') or
		(len(sales_hd.custno)=0 and isnull(sales_hd.clnt_kind,'0') not in ('C','I'))) and isnull(sales_hd.vat_amt_rcvd,0)>0 
		and isnull(sales_hd.pricevattype,1)>1 ,(iif(@lSysno_PVT_level in (1,2,3),iif(sales_hd.no_round_nm=1,
		((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)),
		iif(@lsyscode in (1,4,5,6,8,9) or @lno_round_nm=1,((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)))) -iif(invdsvl>0 and valafds>0 ,(invdsvl/valafds)
		 *(iif(@lSysno_PVT_level in (1,2,3),iif(sales_hd.no_round_nm=1,
		((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)),
		iif(@lsyscode in (1,4,5,6,8,9) or @lno_round_nm=1,((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval))))
		,0.00),0.00)*iif(sales_hd.invtype in ('04','06'),1,-1)),
		SellCost=sum(case when sales_dt.invtype in ('04','06') then sales_dt.cost*(qty+fqty)*pkqty else -sales_dt.cost*(qty+fqty)*pkqty end)*@showcost,
		Discount= sum((invdsvl/valafds)*iif(@lSysno_PVT_level in (1,2,3),iif(sales_hd.no_round_nm=1,
		((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)),
		iif(@lsyscode in (1,4,5,6,8,9) or @lno_round_nm=1,((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)))*(case when sales_hd.invtype in ('04','06') then 1 else -1 end)),
		sl_hlldscnt=sum(iif(isnull(hlldscnt,0)=0 or valafds=0,0.00,iif(@lSysno_PVT_level in (1,2,3),iif(sales_hd.no_round_nm=1,
		((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)),
		iif(@lsyscode in (1,4,5,6,8,9) or @lno_round_nm=1,((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)))*(hlldscnt/valafds)
		*iif(sales_hd.invtype in ('04','06'),1,-1)))
		FROM  STITEMS inner join stunits inner Join sales_dt inner Join sales_hd
		on sales_dt.company=sales_hd.company and sales_dt.invtype=sales_hd.invtype and sales_dt.ref=sales_hd.ref
		on stunits.itemno=sales_dt.itemno and stunits.Unicode=sales_dt.Unicode
		on stitems.itemno=stunits.itemno
		where  valafds<> 0 and sales_hd.invdate between  @fdate and @tdate and (sales_hd.company=@branch Or @branch = '') 
		and Substring(stitems.classkey,1,@mlvl)=rtrim(@cmbkey)
		and  len(rtrim(stitems.classkey))>=cast(@mlvl as varchar(2))
		group by Substring(stitems.classkey,1,@class_len))

		select classkey,name,sellprice-Discount-(sl_salesvat*@lpercent_rslt)-sl_hlldscnt as sellprice,SellCost , Discount from cte_table order by classkey
    End
	
End










GO
/****** Object:  StoredProcedure [dbo].[Api_Sales_Summary_by_Categories_new]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE  [dbo].[Api_Sales_Summary_by_Categories_new]
(
	@m_branch_code char(2) , @class_level int, @fdate char(8),@tdate char(8), @cmbkey varchar(12), @usr_showcost bit=1 , @Language smallint = 1
)
AS 
BEGIN

declare @showcost as int=0,
        @lsyscode int=1
set @showcost=iif(@usr_showcost=1,1,0) 
declare 
	@dbc nvarchar(14),
	@lcalcomp char(2),
	@yrcode char(4)

	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
--------------------------------------------------
declare
	@class_len int,
	@lSysno_PVT_level int=0,
	@lvat_percent numeric(10,3)=5.00,
	@lno_round_nm bit = 0,
	@lpercent_rslt float=0,
	@mlvl int =0

    if @class_level=0 set @class_level=1


------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @lSysno_PVT_level=isnull(Sysno_PVT_level,0),@lvat_percent=isnull(vat_percent,0),@lsyscode=sysno,@lno_round_nm=isnull(no_round_nm,0)
	from sysdb.dbo.glcalend  where calcomp=@lcalcomp and yrcode=@yrcode
  
    set @lpercent_rslt=@lvat_percent/(100+@lvat_percent)


	if len(@cmbkey) = 0 
	begin
		if @class_level<4
		set @class_len=@class_level*2
		else if @class_level=4 set @class_len=9
		else set @class_len=12
		;with cte_table
		as (
		select Substring(stitems.classkey,1,@class_len) as ClassKey,
		ltrim(rtrim((select iif(@language <> 1 And lname <> '',lname,name) from stclass where rtrim(cmbkey)=Substring(stitems.classkey,1,@class_len))))name,
		SellPrice=sum(iif(@lSysno_PVT_level in (1,2,3),iif(sales_hd.no_round_nm=1,
		((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)),
		iif(@lsyscode in (1,4,5,6,8,9) or @lno_round_nm=1,((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)))*iif(sales_hd.invtype in ('04','06'),1,-1)),
		sl_salesvat=sum(iif(isnull(sales_dt.taxtype,'1')<='1' and
		((len(sales_hd.custno)>0 and isnull(sales_hd.clnt_kind,'1')<='1') or
		(len(sales_hd.custno)=0 and isnull(sales_hd.clnt_kind,'0') not in ('C','I'))) and isnull(sales_hd.vat_amt_rcvd,0)>0 
		and isnull(sales_hd.pricevattype,1)>1 ,(iif(@lSysno_PVT_level in (1,2,3),iif(sales_hd.no_round_nm=1,
		((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)),
		iif(@lsyscode in (1,4,5,6,8,9) or @lno_round_nm=1,((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)))) -iif(invdsvl>0 and valafds>0 ,(invdsvl/valafds)
		 *(iif(@lSysno_PVT_level in (1,2,3),iif(sales_hd.no_round_nm=1,
		((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)),
		iif(@lsyscode in (1,4,5,6,8,9) or @lno_round_nm=1,((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval))))
		,0.00),0.00)*iif(sales_hd.invtype in ('04','06'),1,-1)),
		SellCost=sum(case when sales_dt.invtype in ('04','06') then sales_dt.cost*(qty+fqty)*pkqty else -sales_dt.cost*(qty+fqty)*pkqty end)*@showcost,
		Discount= sum((invdsvl/valafds)*iif(@lSysno_PVT_level in (1,2,3),iif(sales_hd.no_round_nm=1,
		((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)),
		iif(@lsyscode in (1,4,5,6,8,9) or @lno_round_nm=1,((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)))*(case when sales_hd.invtype in ('04','06') then 1 else -1 end)),
		sl_hlldscnt=sum(iif(isnull(hlldscnt,0)=0 or valafds=0,0.00,iif(@lSysno_PVT_level in (1,2,3),iif(sales_hd.no_round_nm=1,
		((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)),
		iif(@lsyscode in (1,4,5,6,8,9) or @lno_round_nm=1,((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)))*(hlldscnt/valafds)
		*iif(sales_hd.invtype in ('04','06'),1,-1)))
		FROM  STITEMS inner join stunits inner Join sales_dt inner Join sales_hd
		on sales_dt.company=sales_hd.company and sales_dt.invtype=sales_hd.invtype and sales_dt.ref=sales_hd.ref
		on stunits.itemno=sales_dt.itemno and stunits.Unicode=sales_dt.Unicode
		on stitems.itemno=stunits.itemno
		where  valafds<> 0 and sales_hd.invdate between  @fdate and @tdate and (sales_hd.company=@m_branch_code Or @m_branch_code = '') 
		group by Substring(stitems.classkey,1,@class_len)) 

		select classkey,name,sellprice-Discount-(sl_salesvat*@lpercent_rslt)-sl_hlldscnt as sellprice,SellCost from cte_table
    End
    else
	begin
	    set @mlvl=len(rtrim(@cmbkey))
		set @class_len=(case when @mlvl<=2 then 4
		                     when @mlvl>2 and @mlvl<=4 then 6
							 when @mlvl>4 and @mlvl<=6 then 9
							 when @mlvl>6 and @mlvl<=9 then 12
							 end)
		;with cte_table
		as (
		select Substring(stitems.classkey,1,@class_len) as ClassKey,
		ltrim(rtrim((select iif(@language <> 1 And lname <> '',lname,name) from stclass where rtrim(cmbkey)=Substring(stitems.classkey,1,@class_len))))name,
		SellPrice=sum(iif(@lSysno_PVT_level in (1,2,3),iif(sales_hd.no_round_nm=1,
		((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)),
		iif(@lsyscode in (1,4,5,6,8,9) or @lno_round_nm=1,((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)))*iif(sales_hd.invtype in ('04','06'),1,-1)),
		sl_salesvat=sum(iif(isnull(sales_dt.taxtype,'1')<='1' and
		((len(sales_hd.custno)>0 and isnull(sales_hd.clnt_kind,'1')<='1') or
		(len(sales_hd.custno)=0 and isnull(sales_hd.clnt_kind,'0') not in ('C','I'))) and isnull(sales_hd.vat_amt_rcvd,0)>0 
		and isnull(sales_hd.pricevattype,1)>1 ,(iif(@lSysno_PVT_level in (1,2,3),iif(sales_hd.no_round_nm=1,
		((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)),
		iif(@lsyscode in (1,4,5,6,8,9) or @lno_round_nm=1,((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)))) -iif(invdsvl>0 and valafds>0 ,(invdsvl/valafds)
		 *(iif(@lSysno_PVT_level in (1,2,3),iif(sales_hd.no_round_nm=1,
		((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)),
		iif(@lsyscode in (1,4,5,6,8,9) or @lno_round_nm=1,((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval))))
		,0.00),0.00)*iif(sales_hd.invtype in ('04','06'),1,-1)),
		SellCost=sum(case when sales_dt.invtype in ('04','06') then sales_dt.cost*(qty+fqty)*pkqty else -sales_dt.cost*(qty+fqty)*pkqty end)*@showcost,
		Discount= sum((invdsvl/valafds)*iif(@lSysno_PVT_level in (1,2,3),iif(sales_hd.no_round_nm=1,
		((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)),
		iif(@lsyscode in (1,4,5,6,8,9) or @lno_round_nm=1,((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)))*(case when sales_hd.invtype in ('04','06') then 1 else -1 end)),
		sl_hlldscnt=sum(iif(isnull(hlldscnt,0)=0 or valafds=0,0.00,iif(@lSysno_PVT_level in (1,2,3),iif(sales_hd.no_round_nm=1,
		((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)),
		iif(@lsyscode in (1,4,5,6,8,9) or @lno_round_nm=1,((sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval),
		((sales_dt.QTY*(sales_dt.price-Floor(sales_dt.price*sales_dt.discpc/100)))-sales_dt.imfcval)))*(hlldscnt/valafds)
		*iif(sales_hd.invtype in ('04','06'),1,-1)))
		FROM  STITEMS inner join stunits inner Join sales_dt inner Join sales_hd
		on sales_dt.company=sales_hd.company and sales_dt.invtype=sales_hd.invtype and sales_dt.ref=sales_hd.ref
		on stunits.itemno=sales_dt.itemno and stunits.Unicode=sales_dt.Unicode
		on stitems.itemno=stunits.itemno
		where  valafds<> 0 and sales_hd.invdate between  @fdate and @tdate and (sales_hd.company=@m_branch_code Or @m_branch_code = '') 
		and Substring(stitems.classkey,1,@mlvl)=rtrim(@cmbkey)
		and  len(rtrim(stitems.classkey))>=cast(@mlvl as varchar(2))
		group by Substring(stitems.classkey,1,@class_len))

		select classkey,name,sellprice-Discount-(sl_salesvat*@lpercent_rslt)-sl_hlldscnt as sellprice,SellCost from cte_table
    End
	
End










GO
/****** Object:  StoredProcedure [dbo].[Api_SalesMan]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_SalesMan]
	
AS
BEGIN
	
	Select slcode , ltrim(rtrim(slname)) name from salesmen with (nolock) Where purshman = 0
END





GO
/****** Object:  StoredProcedure [dbo].[Api_SupplierMovementSummary]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-05-10@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROC [dbo].[Api_SupplierMovementSummary]
(
@m_Branch_code char(2),@m_supp_code char(6),@fdate char(8) ,@tdate char(8),
@fcy as varchar(3)='',@vclass char(12)='',@usr_showcost bit = 1 , @Language smallint = 1 
 )
AS BEGIN
----- Added on 2024-05-09 AA many codes to make match with account system result
		declare @showcost as int=0
		set @showcost=iif(@usr_showcost=1,1,0) 	
		declare @lcaloccost bit=0,
		        @dbc varchar(20)='',
				@yrcode varchar(4)='',
				@comp char(2)

		set @dbc=db_name()
		set @yrcode=substring(@dbc,7,2)
		SET @yrcode=iif(cast(@yrcode as int)>40,'14','20')+rtrim(@yrcode)
		set @comp=substring(@dbc,4,2)

		select @lcaloccost=caloccost
	       from sysdb.dbo.glcalend with (nolock)  where calcomp=@comp and yrcode=@yrcode

		
		
		; with cte_clientOpenbal
		as
		(select cu_company,ltrim(rtrim(cu_code)) cu_code,ltrim(rtrim(iif(@Language <> 1 and cu_lname <> '' , cu_lname, cu_name))) cu_name,
		cu_opnbal,sum(isnull(iif(dt_dbcr='D',(dt_lcamt-dt_paidamt-dt_discamt),
		-(dt_lcamt-dt_paidamt-dt_discamt)),0)) as opntrxbal from supplier a with (nolock) left outer join apdtl b with (nolock)
		on a.cu_company=b.dt_company and a.cu_code=b.dt_cucode and dt_cucode<>'' and dt_date<@fdate
		where (cu_company=@m_Branch_code Or @m_Branch_code = '') And (cu_code = @m_supp_code Or @m_supp_code = '')
		group by cu_company,cu_code,cu_name,cu_lname,cu_opnbal 
		)
		,cte_client_trx
		as
		(select dt_company,dt_cucode,sum(isnull(iif(dt_trxsrc<>'07',iif(dt_dbcr='C',(dt_lcamt-dt_paidamt-dt_discamt),
		0),0),0.00)) as rcvdbal,
		sum(isnull(iif(dt_trxsrc<>'07',iif(dt_dbcr='D',(dt_lcamt-dt_paidamt-dt_discamt),
		0),0),0.00)) as dbtbal,
		 sum(isnull(iif(dt_trxsrc='07',iif(dt_dbcr='D',(dt_lcamt-dt_paidamt-dt_discamt),
		-(dt_lcamt-dt_paidamt-dt_discamt)),0),0.00)) as slnet
		from apdtl a with (nolock) inner join cte_clientOpenbal b with (nolock) on a.dt_company=b.cu_company and a.dt_cucode=b.cu_code
		where (dt_company=@m_Branch_code Or @m_Branch_code = '') And (cu_code = @m_supp_code Or @m_supp_code = '') and dt_date between @fdate and @tdate
		group by dt_company,dt_cucode
		) 
		
-------- Added on 2024-05-09 AA -----------------------------------------------------------------------------------------------------------------
		,cte_posted_stock_bal
		as
		(Select branch ,rtrim(splycode)+replicate(space(1),6-len(rtrim(splycode))) As cu_code, 
		whval=Sum(qty*iif(@lcaloccost=1,stbins.lcost,stunits.lcost)) From STITEMS inner Join stunits inner Join stbins
        ON stunits.itemno=stbins.itemno and stunits.unicode=stbins.Unicode
        ON STITEMS.itemno=stunits.itemno
        where stbins.branch=@m_Branch_code and splylcact='0' and fcy=@fcy
        Group By branch,splycode,fcy )

		,cte_slprofit
		as
		(select cu_company,cu_code,cf_fcy, 
		 slprice=sum(case when a.invtype in ('04','06') then ((a.QTY*(a.price-(a.price*a.discpc/100)))-a.imfcval) 
		 else -((a.QTY*(a.price-(a.price*a.discpc/100)))-a.imfcval) end),
         slcost=sum(case when a.invtype in ('04','06') then (a.cost*pkqty*(qty+fqty)) else -(a.cost*pkqty*(qty+fqty)) end),
         dsc= sum((invdsvl/valafds)*((a.QTY*(a.price-(a.price*a.discpc/100)))-a.imfcval)*(case when a.invtype in ('04','06') then 1 else -1 end))
         from supplier inner Join STITEMS inner Join sales_dt a inner Join sales_hd b
         on a.company=b.company and a.invtype=b.invtype and a.ref=b.ref
         on STITEMS.itemno=a.itemno
         on RTRIM(supplier.cu_code)=RTRIM(STITEMS.splycode) and cf_fcy=stitems.fcy
         where  cu_company=@m_Branch_code and cf_fcy=@fcy and valafds<>0 and b.invdate between @fdate and @tdate 
         group By cu_company,cu_code,cf_fcy
		)
--------------------------------------------------------------------------------------------------------------------------------------------------
		select a.cu_code ,cu_name ,cu_opnbal+isnull(opntrxbal,0) as openbal,
		slnet as punet ,rcvdbal ,dbtbal as adjustment,
		cu_opnbal+isnull(opntrxbal,0)+slnet+dbtbal-rcvdbal cur_bal,x.whval as wh_posted_val,slprice-dsc as slnet,slcost,
		(slprice-dsc-slcost)*@showcost as slprofit
		from cte_clientOpenbal a with (nolock) left outer join cte_client_trx b with (nolock)
		on a.cu_company=b.dt_company and a.cu_code=b.dt_cucode
		left outer join cte_slprofit c on a.cu_company=c.cu_company and a.cu_code=c.cu_code
		left outer join cte_posted_stock_bal x on c.cu_company=x.branch and c.cu_code=x.cu_code
		order by cast(a.cu_code as int)

END

GO
/****** Object:  StoredProcedure [dbo].[Api_SuppliersBalances]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

---- This variable @m_Branch_code must be retrevied at the login screen level from the branch field
CREATE PROCEDURE [dbo].[Api_SuppliersBalances]
(@m_Branch_code char(2) = '',@m_classcode char(2) = '' , @fcy char(2) = '' , @Language smallint = 1)
as begin
	select cu_code ,ltrim(rtrim(iif(@Language <> 1 and cu_lname <> '' , cu_lname ,  cu_name))) cu_name ,
	(cu_opnbal+
	 isnull(sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))),0)) cur_bal,
	 (cf_opnfcy+
	 isnull(sum(iif(dt_dbcr='D',dt_fcamt-dt_discamt,-(dt_fcamt-dt_discamt))),0)) cur_fbal,ltrim(rtrim(cu_tel)),vndr_taxcode ,
	 format(cast(max(iif(dt_dbcr='D' and dt_type<>'30',dt_date,'')) as int),'####-##-##') lastrcvdate
	from supplier a with (nolock) left outer join apdtl b with (nolock)
	on a.cu_company=b.dt_company and a.cu_code=b.dt_cucode and a.cf_fcy=b.dt_fcy and dt_cucode<>''
	where (cu_company=@m_Branch_code or @m_Branch_code = '' ) and (cu_class=@m_classcode or @m_classcode = '') and cf_fcy=@fcy
	group by  cu_company,cu_code,cu_name,cu_lname,cu_mobile,cu_tel,cu_opnbal,cf_opnfcy,vndr_taxcode
	having a.cu_opnbal+isnull(sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))),0)<>0
	order by a.cu_name
end












GO
/****** Object:  StoredProcedure [dbo].[Api_UpdateBarcode]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[Api_UpdateBarcode] (@cmbkey varchar(24) , @barcode varchar(20))
	
AS
BEGIN
	
	SET NOCOUNT ON;
	Update stunits set barcode = @barcode where cmbkey = @cmbkey;
	select @@ROWCOUNT;
END







GO
/****** Object:  StoredProcedure [dbo].[Api_UpdateInventory]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Api_UpdateInventory] 
	@invNo varchar(2), @whNo char(2)
AS
BEGIN
	SET NOCOUNT ON ;	
	Declare @sql varchar(max);
	IF (EXISTS (SELECT * 
                 FROM INFORMATION_SCHEMA.TABLES 
                 WHERE TABLE_SCHEMA = 'dbo' 
                 AND  TABLE_NAME = '#tmpTbl'))
	BEGIN
				drop table #tmpTbl
	END
	BEGIN TRY
            BEGIN TRANSACTION;
	select ctr , whno , itemno , sum(qty) qty into #tmpTbl from inventory where whno = @whno and ctr = @invNo group by ctr , whno , itemno 
	set @sql = 'update ttknfile set q' + @invNo + ' =0 where whno=''' + @whNo + ''''
	EXEC (@SQL)
	set @sql = 'update ttknfile set q' + @invNo + ' = s1.qty from #tmpTbl s1 where ttknfile.whno = s1.whno and ltrim(rtrim(ttknfile.itemno)) + ltrim(rtrim(ttknfile.unicode)) = ltrim(rtrim(s1.itemno))'
	EXEC (@SQL)
			IF @@TRANCOUNT > 0
			begin
			COMMIT;
			declare @i bigint = 0 ;
			declare @sql2 nvarchar(500) = N'select @i = sum(q' + @invNo + ') from ttknfile where whno =''' + @whNo + '''';
			EXEC sp_executesql @sql2, N'@i bigint OUTPUT', @i OUTPUT;
			select @i;
			end
	END TRY
	BEGIN CATCH
	IF @@TRANCOUNT > 0
	ROLLBACK;
	select -1;
	END CATCH
END








GO
/****** Object:  StoredProcedure [dbo].[ar_uncomplete]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-01-17@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[ar_uncomplete]
 @m_cmp char(2),
 @m_type char(2),
 @m_ref  int, 
 @pstmode bit,
 @lsrc char(2),
 @caokmustfc bit,
 @errcode char(4) output
 
	
AS
BEGIN
-- 2023-12-11 AA Added 3 more variables vat_percent & lextamt_vat 
-- 2023-12-11 AA Added code to fit zatca rounding requirement 
-- 2023-12-11 AA Added the new variable for zatca rounding 
-- 2023-07-22 AA Fixed the bug when external client & pricevattype=2 & extamt>0
-- 2023-05-14 KAN Added Fixed Asset Codes
-- 2022-05-09 AA i have made the @m_ref parameter to be int instead of numeric(6,0)
-- 2022-05-09 AA Added semi colon to the end of select statement 
-- 2022-02-23 AA Revised the whole procedure and fixed many bugs
-- 2022-02-23 AA New varibale name @linvpaid is Added 
-- 2022-02-23 AA New varibale name @linvdsvl is Added   
-- 2021-12-04 AA Convert numeric(20,7) to float 
-- Added on 2020-11-25 to handle the free qty invoice
-- Added on 2020-04-02 dbo.value_balanced on error 123
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.posted,trdate,src,AMNTTL,costttl,entries
	SET NOCOUNT ON
	declare @ljhamt float=0,
	@lptr int =0,
	@no_entries int=0,
	@lhd_lccnet float,
	@lhd_lcnet float,
	@lhd_ltotal float,
	@lhd_ftotal float,
	@posted bit,
	@src char(2),
	@lhd_fcy char(3),
	@lsmsuser int=0 -- Added on 2022-02-23 AA
	set @errcode='';

--------- Added on 2022-02-23 AA  ---------------------------
    select @lsmsuser=smsuser from stbranch where brnno=@m_cmp; 
	set @lsmsuser=isnull(@lsmsuser,0)
-------------------------------------------------------------

 	select @posted=hd_posted,@lhd_fcy=isnull(hd_fcy,''),@lhd_lcnet=hd_lcnet,@lhd_lccnet=hd_lccnet,
	@lhd_ftotal=hd_ftotal,
	@lhd_ltotal=hd_ltotal,@src=hd_trxsrc from arhdr with (NOLOCK) where hd_COMPANY=@m_cmp AND hd_TYPE=@m_type AND hd_REF=@m_ref;
    set @lptr=@@rowcount

	declare 
		@llinvttl float,
		@lfinvttl float,
		@llcamt float=0,
		@lfcamt float=0,
		@fqtyvat float=0,
		@extamt_vat float =0 --Added on 2023-07-22 AA einvphs2

------------------ Added on 2022-02-23 AA -------
	declare
		@linvdsvl float=0,   
		@linvpaid float=0, 
		@ltrprt_amt float=0,
		@ltrprt_vatamt float=0,
		@ltrprt_onus bit=0,
		@lttl_ar float=0
--------------------------------------------------
--- Added on 2023-12-11 AA Variables for zatca rounding-----	
	declare
	@lzatca_rounding bit=0, 
	@l_extamt_vat numeric(12,3)=0 ,
	@llextamt float =0,
	@lvat_percent numeric(5,2),
	@lpricevattype numeric(1,0)=1
---------------------------------------------------------
	if @lsrc<>'02'
	begin
-----------------------------
        if @lsrc<>'05' --Added  on 2022-02-23 AA 
		begin
			if @lptr=0
			begin
				set @errcode='122'
				return
			end
			set @lptr=0
		end  --Added  on 2022-02-23 AA 
----------------------------------------------
		if @pstmode=1 
		begin
			if  @posted=0
			begin
				set @errcode='136'
				return
			end
		end
		else 
		if  @posted=1
		begin 
			set @errcode='212'
			return
		end
		if @lsrc='05'
		begin
--------------- Added on 2023-12-11 AA ----------------------------------------------------------------------------------------------------------
            set @l_extamt_vat=0
			set @lzatca_rounding=0
			set @lvat_percent=0
			set @llextamt=0
			set @lpricevattype=1

			if COL_LENGTH('dbo.sales_hd','zatca_rounding') is not null
			begin 
				select @lzatca_rounding=isnull(zatca_rounding,0),@llextamt=extamt,@lvat_percent=vat_percent,@lpricevattype=pricevattype
				from sales_hd with (NOLOCK) 
				where COMPANY=@m_cmp AND INVTYPE=@m_type AND REF=@m_ref;
				 
				if @@rowcount>0 and @llextamt>0 and @lzatca_rounding=1 and @lpricevattype>1 and @lvat_percent>0 
				set @l_extamt_vat=round(@llextamt*@lvat_percent/(100+@lvat_percent),2)
			end
---------------------------------------------------------------------------------------------------------------------------------------------------
			set @llcamt=Iif(rtrim(@lhd_fcy)='',@lhd_ltotal,@lhd_ftotal)
			select @llinvttl=invttl-isnull(hlldscnt,cast(0 as float)), --K.A.N APRIL 13,2018 ADDED : -isnull(hlldscnt, cast(0 as float))
			@fqtyvat=iif(pricevattype>1 and isnull(fqtyval,0)>0 and @lzatca_rounding=0,isnull(fqtyval,0)*vat_percent/(100+vat_percent),0), -- Added on 2020-11-25 AA
			@linvdsvl=invdsvl,@linvpaid=invpaid, -- Added on 2022-02-23 AA 
			@extamt_vat=iif(pricevattype>1 and clnt_kind in ('2','3') and extamt>0,extamt*vat_percent/(100+vat_percent),0) -- Added on 2023-07-22 AA
			from sales_hd with (NOLOCK) where COMPANY=@m_cmp AND INVTYPE=@m_type AND REF=@m_ref;
			if @@rowcount=0
			begin
				set @errcode='122'
				return
			end
--------------- Added on 2022-02-23 AA  ----------------
            if @lsmsuser<>288 -- Jood 
			begin
			   select @ltrprt_amt=isnull(transportamt,0),@ltrprt_vatamt=isnull(transport_vat,0),@ltrprt_onus=isnull(transportOnUs,0) 
			   from slinvexp with (NOLOCK) 
			   where COMPANY=@m_cmp AND INVTYPE=@m_type AND REF=@m_ref; 
			   set @ltrprt_amt=isnull(@ltrprt_amt,0)
			   set @ltrprt_vatamt=isnull(@ltrprt_vatamt,0)
			   set @ltrprt_onus=isnull(@ltrprt_onus,0)

			   set @lttl_ar=@llinvttl-@linvdsvl-@linvpaid+@fqtyvat+iif(@ltrprt_onus=0,@ltrprt_amt+@ltrprt_vatamt,0)
			   if dbo.value_balanced(@lttl_ar,0.00)>0    return
			end
			if @lptr=0
			begin
				set @errcode='122'
				return
			end
			set @lptr=0			
--------------------------------------------------------
			-- Added on 2020-11-25 AA
			set @llinvttl=@llinvttl+@fqtyvat+iif(@ltrprt_onus=0,@ltrprt_amt+@ltrprt_vatamt,0) -- Modified on 2022-02-23 AA
      set @llinvttl=@llinvttl-iif(@lzatca_rounding=0,@extamt_vat,round(@extamt_vat,2)) -- Added on 2023-12-11 AA
			if dbo.value_balanced(@llinvttl,@llcamt)=0
			begin
				set @errcode='214'
				return
			end
		end
		if @lsrc='10'
		begin
			select ref from bktransx with (NOLOCK) where company=@m_cmp and trtype=@m_type and ref= @m_ref;
			if @@rowcount=0
			begin
				set @errcode='122'
				return
			end
		end
		if @lsrc='23'
		begin
			set @llcamt=@lhd_ltotal
			set @lfcamt=@lhd_ftotal
			select @llinvttl=hd_ltotal,@lfinvttl=hd_ftotal				
			from sdhdr with (NOLOCK) where hd_COMPANY=@m_cmp AND hd_TYPE=@m_type AND hd_REF=@m_ref;
			if @@rowcount=0
			begin
				set @errcode='122'
				return
			end
			if dbo.value_balanced(@llinvttl,@llcamt)=0 --or dbo.value_balanced(@lfinvttl,@lfcamt)=0
			begin
				set @errcode='214'
				return
			end
		end
		-- 2023-05-14 KAN Added Fixed Asset Codes Wich Abo Mohammed Always Overwrites It. LOL
		If @lsrc='33'  --Fixed Assets
		begin
			set @llcamt=@lhd_ltotal
			set @lfcamt=@lhd_ftotal

			select @llinvttl=case when fh_fatype='3' then fh_ltotal+fh_ftoteqc+fh_dtlocal+fh_dtfceqc
			                      when fh_fatype='4' then fh_ltotal
			                      when fh_fatype='2' then case when fh_ltotal>fh_dtlocal then fh_ltotal else fh_dtlocal end 
	                                                     +case when fh_ftoteqc>fh_dtfceqc then fh_ftoteqc else fh_dtfceqc end			                                               
														 - hlldscnt + iif(isnull(PriceVatType,1)=1,vat_amt,0)
								  when fh_fatype='1' then fh_ltotal+fh_ftoteqc - hlldscnt + iif(isnull(priceincludevat,0)=0,vat_amt,0)
								  else fh_ltotal+fh_ftoteqc  end														  
			from fahdr with (NOLOCK) where fh_company=@m_cmp AND fh_type=@m_type AND fh_ref=@m_ref;  
			if @@rowcount=0
			begin
				set @errcode='122'
				return
			end
			if dbo.value_balanced(@llinvttl,@llcamt)=0 --or dbo.value_balanced(@lfinvttl,@lfcamt)=0
			begin
				set @errcode='216'
				return
			end
		end
		--end : -- 2023-05-13 KAN Added Fixed Asset Codes Wich Abo Mohammed Always Overwrites It. LOL		
	end
    if  @src<>@lsrc
	begin
		set @errcode='124'
		return
	end	
    If dbo.value_balanced(@lhd_ltotal,@lhd_lcnet)=0
	begin
		set @errcode='123'
		return
	end	
	if @m_type='01' and dbo.value_balanced(@lhd_lccnet,@lhd_lcnet)=0
	begin
		set @errcode='123'
		return
	end	


	declare @lc_db float,@lc_cr float,@fc_db float,@fc_cr float
    select @lptr=sum(1), @lc_db=sum(iif(dt_dbcr='D',dt_lcamt,0)),@fc_db=sum(iif(dt_dbcr='D',dt_fcamt,0)),
       @lc_cr=sum(iif(dt_dbcr='C',dt_lcamt,0)),@fc_cr=sum(iif(dt_dbcr='C',dt_fcamt,0)) from ardtl with (NOLOCK) where 
	   dt_COMPANY=@m_cmp AND dt_TYPE=@m_type AND dt_REF=@m_ref;
	if @@rowcount=0
	begin
		set @errcode='122'
		return
	end

	if @m_type='01' and dbo.value_balanced(@lc_db,@lc_cr)=0
	begin
		set @errcode='139'
		return
	end	
	if dbo.value_balanced(@lhd_ltotal,Iif(@lc_db<>0,@lc_db,@lc_cr))=0
	begin
		set @errcode='137'
		return
	end	

	if @caokmustfc=1
	begin 
		if  @m_type='01' and @fc_db<>@fc_cr
		begin
			set @errcode='139'
			return
		end
		if dbo.value_balanced(@lhd_ftotal,Iif(@fc_db<>0,@fc_db,@fc_cr))=0
		begin
			set @errcode='137'
			return
		end	
	end

end

GO
/****** Object:  StoredProcedure [dbo].[arab_center_sp]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[arab_center_sp]
	 @lcomp char(2),
	 @whno char(2),
	 @fdate char(8),
	 @tdate char(8),
	 @ftrxno int,
	 @ttrxno int,
	 @fcstno char(19),
	 @NoOfRecords int output
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON

	set @NoOfRecords=0

	if len(@fcstno)=0
	begin
		;with cte_rcvd (branch,trtype,to_ref,to_whno,brxref,to_qty,to_lcost,to_fcost,itemno,folio,custno)
		as
		(select a.branch,'09' as trtype,a.ref,b.whno,brxref,qty,lcost,fcost,itemno,folio,custno from sthdr a inner join stdtl b
		on a.branch=b.branch and a.trtype=b.trtype and a.ref=b.ref
		where a.branch=@lcomp and a.isbrtrx=0 and brxref>0 and a.trtype='01' )

		select a.branch,a.trtype ,a.ref,b.whno,b.itemno,b.unicode,b.qty,b.lcost,b.fcost,c.custno,a.trdate,to_ref,
		to_whno,to_qty,to_lcost,to_fcost,x.name as fulname
		from sthdr a inner join stdtl b
		on a.branch=b.branch and a.trtype=b.trtype and a.ref=b.ref
		inner join  cte_rcvd c  on b.branch=c.branch and b.trtype=c.trtype and b.ref=c.brxref and b.itemno=c.itemno and b.folio=c.folio
		inner join stitems x on c.itemno=x.itemno
		where a.branch=@lcomp and a.isbrtrx=0 and a.trtype='09' and a.whno=@whno  and a.trdate between @fdate and @tdate and a.ref between @ftrxno and @ttrxno
		order by to_whno,a.ref,b.folio
	end
	else
	begin
		;with cte_rcvd (branch,trtype,to_ref,to_whno,brxref,to_qty,to_lcost,to_fcost,itemno,folio,custno)
		as
		(select a.branch,'09' as trtype,a.ref,b.whno,brxref,qty,lcost,fcost,itemno,folio,custno from sthdr a inner join stdtl b
		on a.branch=b.branch and a.trtype=b.trtype and a.ref=b.ref
		where a.branch=@lcomp and a.isbrtrx=0 and brxref>0 and a.trtype='01' and a.custno=@fcstno )

		select a.branch ,a.ref,b.whno,b.itemno,b.unicode,b.qty,b.lcost,b.fcost,c.custno,a.trdate,to_ref,
		to_whno,to_qty,to_lcost,to_fcost,x.name as fulname
		from sthdr a inner join stdtl b
		on a.branch=b.branch and a.trtype=b.trtype and a.ref=b.ref
		inner join  cte_rcvd c  on b.branch=c.branch and b.trtype=c.trtype and b.ref=c.brxref and b.itemno=c.itemno and b.folio=c.folio
		inner join stitems x on c.itemno=x.itemno
		where a.branch=@lcomp and a.isbrtrx=0 and a.trtype='09' and a.whno=@whno  and a.trdate between @fdate and @tdate  and a.ref between @ftrxno and @ttrxno
		order by to_whno,a.ref,b.folio
	end
	if @@error<>0 set @NoOfRecords=-1 
	ELSE set @NoOfRecords=@@ROWCOUNT
end










GO
/****** Object:  StoredProcedure [dbo].[Auto_Import_PORPLS_invoices_from_POS_2_server]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Auto_Import_PORPLS_invoices_from_POS_2_server]
 @errstatus int = 0 output
AS
BEGIN
	declare @sqlmsg nvarchar(max)='',
	@dbc nvarchar(14),
	@lcalcomp char(2),
	@yrcode char(4),
	@syscode int =2,
	@lcauseslctr bit=0,
	@it_is_pos bit=0,
	@whr_condn char(20)='modified=1 and invorrtrn=''2''',
	@brlinksrvr nvarchar(15)
---------------------------------------------------------------------------------------------
	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
	
    set @errstatus=0
 
------------------------------ Get Yrcode & Calcomp from Branch Boteequ  ----------------------------------------------
		declare @dynsql nvarchar(300),
				@params nvarchar(100),
				@lctrcode numeric(4,0),
				@lctrcompany char(2),
				@lpos_ctr cursor
				set @lpos_ctr = cursor for
        select ctrcompany,ctrcode from pos_ctr where rptype=1 
        open @lpos_ctr;
		
		fetch next from @lpos_ctr into @lctrcompany,@lctrcode
		WHILE @@FETCH_STATUS = 0
        BEGIN
			set @yrcode=''
			set @lcalcomp=''
			set @brlinksrvr='POLNKSRVR'+@lctrcompany+ltrim(str(@lctrcode))
			set @dynsql='select top 1 @yrcd=yrcode,@lclcmp=calcomp  from '+@brlinksrvr+'.posysdb.dbo.glcalend'
			+ ' order by yrcode desc';
			set @params='@yrcd char(4) output,@lclcmp char(2) output';
			exec sp_executesql @dynsql,@params,@yrcd=@yrcode output,@lclcmp=@lcalcomp output
			if @@error<>0 or @@rowcount=0
			begin
		  		set @errstatus=-1
				break 
			end
			if @yrcode<>'' and @lcalcomp<>'' set @dbc='.pos'+@lcalcomp+'y'+substring(@yrcode,3,2)+'.dbo.'
			else
			begin
		  		set @errstatus=-2
				break 		  
			end
			set @it_is_pos=1
------------------------------------------------------------------------------------------------------------------------
	
			set @sqlmsg='merge pos_hd as t '
			+ ' using '
			+ ' (select * from '+@brlinksrvr+@dbc+'pos_hd b where '+@whr_condn+') as s'
			+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
			+ ' when not matched then '
			+ ' insert values (s.company,s.contr,s.ref,s.invdate,s.entries,s.slperson ,s.paytype,s.chargepctg,s.chargeamt'
			+ ' ,s.invdspc ,s.disccard ,s.cardtype ,s.invttl,s.invcst,s.invdsvl,s.valafds ,s.invpaid,s.pricetp,s.slcenter'
			+ ' ,s.invorrtrn ,s.cashamt,s.modified ,s.salinvno ,s.salctrno ,s.tdatetime ,s.cktype ,s.geninv ,s.rref'
			+ ' ,s.rcontr ,s.ccpaid ,s.ccconus,s.prepaidamt ,s.fmbranch,s.mobile ,s.fcamt ,s.custtype ,s.paycard);'	
	
			begin transaction
			exec sp_executesql @sqlmsg			
			if @@error<>0 or @@ROWCOUNT=0
			begin
			    if @@ROWCOUNT=0 set @errstatus=0
				else set @errstatus=-3
				rollback transaction
				break 
			end	       
	
			set @sqlmsg='merge pos_dt as t '
			+ ' using '
			+ ' (select a.* from '+@brlinksrvr+@dbc+'pos_dt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
			+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
			+ ' where '+@whr_condn+') as s'
			+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
			+ ' when not matched then '
			+ ' insert values (s.company ,s.contr ,s.ref,s.cmbkey ,s.qty,s.price ,s.barcode ,s.dscprsnt ,s.srlno,s.rtrnd,'
			+ ' s.dsc_amt,s.offer_amt,s.nqati_prcnt);'


			exec sp_executesql @sqlmsg
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-4
				break 
			end
			commit transaction
			fetch next from @lpos_ctr into @lctrcompany,@lctrcode
	  end
	  if @errstatus=0 and @@TRANCOUNT>0 commit transaction
	  
	  close @lpos_ctr
	  deallocate @lpos_ctr
end













GO
/****** Object:  StoredProcedure [dbo].[bld_1_deduction_previous_values]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[bld_1_deduction_previous_values] 
 @m_cmp char(2),
 @m_ref  numeric(6,0), 
 @m_date char(8),
 @m_cust char(6),
 @errstatus int = 0 output
AS
BEGIN

	SET NOCOUNT ON
	
	begin transaction
	update sales_dd set qty=0,frtqty=0,shdqty=0 where invtype='21' and company=@m_cmp and ref=@m_ref

	update sales_dd set qty=ttlval 
	from sales_dd a
	join 
	(select cmbkey,ttlval=sum(iif(hh.posted='1',dd.dscprice*dd.dscqty,0))
			from sales_dh hh inner join sales_dd dd
		on hh.company=dd.company and hh.invtype=dd.invtype and hh.ref=dd.ref
        where hh.company=@m_cmp and hh.invtype='21' and hh.ref<>@m_ref and hh.invdate<@m_date and hh.custno=@m_cust
		group by cmbkey) b
		on a.cmbkey=b.cmbkey
		where a.company=@m_cmp and a.ref=@m_ref and a.invtype='21'

		if @@error<>0
		begin
		    rollback transaction
			set @errstatus=-1
			return @errstatus
		end

		if @errstatus=0 
		 begin 
		   update sales_dd set frtqty=isnull(ttlsales,0),shdqty=isnull(ttlrtrns,0)
		    from sales_dd y
			join 
			(select d.cmbkey,ttlsales=sum(case when d.invtype in ('04','06') then d.qty*d.pkqty else 0 end),
		                  ttlrtrns=sum(case when d.invtype in ('24','26') then d.qty*d.pkqty else 0 end) 
			from sales_dt d inner join sales_hd h 
			on h.company=d.company and h.invtype=d.invtype and h.ref=d.ref 
			   and h.custno=@m_cust and h.invdate<=@m_date and h.company=@m_cmp
			group by d.cmbkey) ll
			on y.cmbkey=ll.cmbkey
			where y.custno=@m_cust and y.company=@m_cmp and y.invdate<=@m_date and y.ref=@m_ref and y.invtype='21'			
		end

		--set @errstatus=@@error  --@@rowcount  --for debug 
		if @@error<>0
		begin
		    rollback transaction
			set @errstatus=-5
			return @errstatus
		end
		else
		--if @errstatus=0 
		 begin
		    commit transaction
		    return @errstatus
		 end	
end














GO
/****** Object:  StoredProcedure [dbo].[bld_accts_balances]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[bld_accts_balances]
  
 @errstatus int = 0 output
	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
	declare @dbc nvarchar(13),
	        @sqlmsg nvarchar(max),
			@lcalcomp char(2),
			@yrcode char(4)

    declare @prd1_strt date,@prd1_end date,
	        @prd2_strt date,@prd2_end date,
			@prd3_strt date,@prd3_end date,
	        @prd4_strt date,@prd4_end date,
			@prd5_strt date,@prd5_end date,
	        @prd6_strt date,@prd6_end date,
			@prd7_strt date,@prd7_end date,
	        @prd8_strt date,@prd8_end date,
			@prd9_strt date,@prd9_end date,
			@prd10_strt date,@prd10_end date,
	        @prd11_strt date,@prd11_end date,
			@prd12_strt date,@prd12_end date,
			@yrend date,@calvlno int =4

	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)

    select @prd1_strt=cast(cal01 as date),@prd2_strt=cast(cal02 as date),@prd3_strt=cast(cal03 as date),
	@prd4_strt=cast(cal04 as date),@prd5_strt=cast(cal05 as date),@prd6_strt=cast(cal06 as date),
    @prd7_strt=cast(cal07 as date),@prd8_strt=cast(cal08 as date),@prd9_strt=cast(cal09 as date)
	,@prd10_strt=cast(cal10 as date),
	@prd11_strt=cast(cal11 as date),@prd12_strt=cast(cal12 as date),@yrend=cast(calend as date),@calvlno=calvlno
    from sysdb.dbo.glcalend where calcomp=@lcalcomp and yrcode=@yrcode

	set @prd1_end=DATEADD(DAY, -1, @prd2_strt) 
	set @prd2_end=DATEADD(DAY, -1, @prd3_strt)
	set @prd3_end=DATEADD(DAY, -1, @prd4_strt) 
	set @prd4_end=DATEADD(DAY, -1, @prd5_strt)
	set @prd5_end=DATEADD(DAY, -1, @prd6_strt) 
	set @prd6_end=DATEADD(DAY, -1, @prd7_strt)
	set @prd7_end=DATEADD(DAY, -1, @prd8_strt) 
	set @prd8_end=DATEADD(DAY, -1, @prd9_strt)
	set @prd9_end=DATEADD(DAY, -1, @prd10_strt)
	set @prd10_end=DATEADD(DAY, -1, @prd11_strt) 
	set @prd11_end=DATEADD(DAY, -1, @prd12_strt)
	set @prd12_end=@yrend

	begin transaction
	update glchart set glcurbal=glopnbal,fccurbal=fcopnbal,glbal01=0,glbal02=0,glbal03=0,glbal04=0,
	                   glbal05=0,glbal06=0,glbal07=0,glbal08=0,glbal09=0,glbal10=0,glbal11=0,glbal12=0,
                       fcbal01=0,fcbal02=0,fcbal03=0,fcbal04=0,
	                   fcbal05=0,fcbal06=0,fcbal07=0,fcbal08=0,fcbal09=0,fcbal10=0,fcbal11=0,fcbal12=0
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-1
		return				
	end
    update glchart set glcurbal=isnull(lc_bal,0)+glopnbal,fccurbal=isnull(fc_bal,0)+fcopnbal,
	       glbal01=isnull(prd1_bal,0),glbal02=isnull(prd2_bal,0),glbal03=isnull(prd3_bal,0),glbal04=isnull(prd4_bal,0),
		   glbal05=isnull(prd5_bal,0),glbal06=isnull(prd6_bal,0),glbal07=isnull(prd7_bal,0),glbal08=isnull(prd8_bal,0),
		   glbal09=isnull(prd9_bal,0),glbal10=isnull(prd10_bal,0),glbal11=isnull(prd11_bal,0),glbal12=isnull(prd12_bal,0),
	       fcbal01=isnull(fprd1_bal,0),fcbal02=isnull(fprd2_bal,0),fcbal03=isnull(fprd3_bal,0),fcbal04=isnull(fprd4_bal,0),
		   fcbal05=isnull(fprd5_bal,0),fcbal06=isnull(fprd6_bal,0),fcbal07=isnull(fprd7_bal,0),fcbal08=isnull(fprd8_bal,0),
		   fcbal09=isnull(fprd9_bal,0),fcbal10=isnull(fprd10_bal,0),fcbal11=isnull(fprd11_bal,0),fcbal12=isnull(fprd12_bal,0)
	from glchart t
	join 
	(select jdcomp,jdkey,jdcurr,
	prd1_bal=sum(iif(cast(jddate as date) between @prd1_strt and @prd1_end,iif(jddbcr='C',-jdlcamt,jdlcamt),0)),
	prd2_bal=sum(iif(cast(jddate as date) between @prd2_strt and @prd2_end,iif(jddbcr='C',-jdlcamt,jdlcamt),0)),
	prd3_bal=sum(iif(cast(jddate as date) between @prd3_strt and @prd3_end,iif(jddbcr='C',-jdlcamt,jdlcamt),0)),
	prd4_bal=sum(iif(cast(jddate as date) between @prd4_strt and @prd4_end,iif(jddbcr='C',-jdlcamt,jdlcamt),0)),
	prd5_bal=sum(iif(cast(jddate as date) between @prd5_strt and @prd5_end,iif(jddbcr='C',-jdlcamt,jdlcamt),0)),
	prd6_bal=sum(iif(cast(jddate as date) between @prd6_strt and @prd6_end,iif(jddbcr='C',-jdlcamt,jdlcamt),0)),
	prd7_bal=sum(iif(cast(jddate as date) between @prd7_strt and @prd7_end,iif(jddbcr='C',-jdlcamt,jdlcamt),0)),
	prd8_bal=sum(iif(cast(jddate as date) between @prd8_strt and @prd8_end,iif(jddbcr='C',-jdlcamt,jdlcamt),0)),
	prd9_bal=sum(iif(cast(jddate as date) between @prd9_strt and @prd9_end,iif(jddbcr='C',-jdlcamt,jdlcamt),0)),
	prd10_bal=sum(iif(cast(jddate as date) between @prd10_strt and @prd10_end,iif(jddbcr='C',-jdlcamt,jdlcamt),0)),
	prd11_bal=sum(iif(cast(jddate as date) between @prd11_strt and @prd11_end,iif(jddbcr='C',-jdlcamt,jdlcamt),0)),
	prd12_bal=sum(iif(cast(jddate as date) between @prd12_strt and @prd12_end,iif(jddbcr='C',-jdlcamt,jdlcamt),0)),
	lc_bal=sum(iif(jddbcr='C',-jdlcamt,jdlcamt)),
	fprd1_bal=sum(iif(cast(jddate as date) between @prd1_strt and @prd1_end,iif(jddbcr='C',-jdfcamt,jdfcamt),0)),
	fprd2_bal=sum(iif(cast(jddate as date) between @prd2_strt and @prd2_end,iif(jddbcr='C',-jdfcamt,jdfcamt),0)),
	fprd3_bal=sum(iif(cast(jddate as date) between @prd3_strt and @prd3_end,iif(jddbcr='C',-jdfcamt,jdfcamt),0)),
	fprd4_bal=sum(iif(cast(jddate as date) between @prd4_strt and @prd4_end,iif(jddbcr='C',-jdfcamt,jdfcamt),0)),
	fprd5_bal=sum(iif(cast(jddate as date) between @prd5_strt and @prd5_end,iif(jddbcr='C',-jdfcamt,jdfcamt),0)),
	fprd6_bal=sum(iif(cast(jddate as date) between @prd6_strt and @prd6_end,iif(jddbcr='C',-jdfcamt,jdfcamt),0)),
	fprd7_bal=sum(iif(cast(jddate as date) between @prd7_strt and @prd7_end,iif(jddbcr='C',-jdfcamt,jdfcamt),0)),
	fprd8_bal=sum(iif(cast(jddate as date) between @prd8_strt and @prd8_end,iif(jddbcr='C',-jdfcamt,jdfcamt),0)),
	fprd9_bal=sum(iif(cast(jddate as date) between @prd9_strt and @prd9_end,iif(jddbcr='C',-jdfcamt,jdfcamt),0)),
	fprd10_bal=sum(iif(cast(jddate as date) between @prd10_strt and @prd10_end,iif(jddbcr='C',-jdfcamt,jdfcamt),0)),
	fprd11_bal=sum(iif(cast(jddate as date) between @prd11_strt and @prd11_end,iif(jddbcr='C',-jdfcamt,jdfcamt),0)),
	fprd12_bal=sum(iif(cast(jddate as date) between @prd12_strt and @prd12_end,iif(jddbcr='C',-jdfcamt,jdfcamt),0)),
	fc_bal=sum(iif(jddbcr='C',-jdfcamt,jdfcamt)) from gljrdtl inner join gljrhdr 
	on jdcomp=jhcomp and jdtype=jhtype and jdref=jhref 
	where jhposted=1
	group by jdcomp,jdkey,jdcurr
	) c
	on t.glcomp=c.jdcomp and t.glkey=c.jdkey and t.glcurrency=c.jdcurr
	where t.actlvl=@calvlno
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-1				
	end
	else commit transaction
end












GO
/****** Object:  StoredProcedure [dbo].[bld_ap_alocation]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-01-07@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[bld_ap_alocation]
 @p_compcode char(2),
 @p_class char(2),
 @p_fmcstcd char(6),
 @p_tocstcd char(6),
 @p_fcy char(3),
 @errstatus int = 0 output
	
AS
BEGIN
---  Added on 2023-11-26 AA Changed data type of numeric(6,0) to int
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
	set @errstatus =0
    declare @l_company char(2),
	        @l_cucode char(6),
			@lfcy char(3),
			@lopnbal float,
			@lfopnbal float,
			@llcaloc float,
			@lfcaloc float,
			@lcu_alocamt float=0

     declare @ttlpay float =0,
	         @orgrcv float =0,
	         @pay_opn float=0,
			 @inv_opn float=0,
			 @opnval float=0,
			 @lpayamt float=0,
			 @lalocamt float=0,
			 @linvamt float =0

     declare @ldt_company char(2),
	         @ldt_cucode  char(6),
			 @ldt_fcy char(3),
			 @ldt_type char(2),
			 @ldt_ref  int,
			 @ldt_folio int ,
			 @ldt_lcaloc float=0,
			 @ldt_fcaloc float=0,
			 @linvval float =0,
			 @ldt_aloctd char(1)='1'

			 set @p_fcy=isnull(@p_fcy,'   ')
			 set @p_class=isnull(@p_class,'  ')
	
	if isnull(@p_compcode,'')<>''
	begin
		set @p_fmcstcd= isnull(@p_fmcstcd,'')
		set @p_tocstcd= isnull(@p_tocstcd,'')
		if len(@p_fmcstcd)=0 set @p_fmcstcd='     1'
		if len(@p_tocstcd)=0 set @p_tocstcd='999999'
	end

	--must clear old allocation
	begin transaction
	if isnull(@p_compcode,'')=''
	   begin
	      update supplier set cu_lcaloc=0, cu_fcaloc =0 where cu_code<>'' and cf_fcy=@p_fcy
		  if @@error<>0
		  begin
		     rollback transaction
			 set @errstatus=-70
			 return @errstatus
	      end
		  update apdtl set dt_lcaloc=0, dt_fcaloc=0,dt_aloctd='1'
		  if @@error<>0
		  begin
		     rollback transaction
			 set @errstatus=-71
			 return @errstatus
	      end
	   end
	else
	   begin
	      if isnull(@p_class,'')=''
		     begin
		        update supplier set cu_lcaloc=0, cu_fcaloc =0 where
				cu_company=@p_compcode and replicate(space(1),6-len(rtrim(cu_code)))+rtrim(cu_code) between @p_fmcstcd and @p_tocstcd 
				and cf_fcy=@p_fcy
				if @@error<>0
				begin
				  rollback transaction
				  set @errstatus=-80
				  return @errstatus
				end
				update apdtl set dt_lcaloc=0, dt_fcaloc=0,dt_aloctd='1' from apdtl inner join supplier on dt_company=cu_company and dt_cucode=cu_code and dt_fcy=cf_fcy
				where cu_company=@p_compcode and replicate(space(1),6-len(rtrim(cu_code)))+rtrim(cu_code) between @p_fmcstcd and @p_tocstcd 
				and cf_fcy=@p_fcy
				if @@error<>0
				begin
				  rollback transaction
				  set @errstatus=-81
				  return @errstatus
				end
		     end
		  else
		     begin
			    update supplier set cu_lcaloc=0, cu_fcaloc =0 where 
				cu_company=@p_compcode and replicate(space(1),6-len(rtrim(cu_code)))+rtrim(cu_code) between @p_fmcstcd and @p_tocstcd 
				and cf_fcy=@p_fcy and cu_class=@p_class
				if @@error<>0
				begin
				  rollback transaction
				  set @errstatus=-81
				  return @errstatus
				end
				update apdtl set dt_lcaloc=0, dt_fcaloc=0,dt_aloctd='1' from apdtl inner join supplier on dt_company=cu_company and dt_cucode=cu_code and dt_fcy=cf_fcy
				where cu_company=@p_compcode and replicate(space(1),6-len(rtrim(cu_code)))+rtrim(cu_code) between @p_fmcstcd and @p_tocstcd 
				and cf_fcy=@p_fcy and cu_class=@p_class
				if @@error<>0
				begin
				  rollback transaction
				  set @errstatus=-81
				  return @errstatus
				end
			 end
	   end
	   if @@trancount>0 
	   if @errstatus<0 rollback transaction
	   else commit transaction 
	   --end clear old allocation
    
	if isnull(@p_compcode,'')=''
		DECLARE crssupp0 CURSOR LOCAL FAST_FORWARD FOR
		select cu_company,cu_code,cf_fcy,cu_opnbal,cu_lcaloc,cf_opnfcy,cu_fcaloc from supplier where cu_code<>''
		order by cu_company,replicate(space(1),6-len(rtrim(cu_code)))+rtrim(cu_code),cf_fcy
	else
	begin
	    if isnull(@p_class,'')=''
			DECLARE crssupp0 CURSOR LOCAL FAST_FORWARD FOR
			select cu_company,cu_code,cf_fcy,cu_opnbal,cu_lcaloc,cf_opnfcy,cu_fcaloc from supplier where 
			cu_company=@p_compcode and replicate(space(1),6-len(rtrim(cu_code)))+rtrim(cu_code) between @p_fmcstcd and @p_tocstcd 
			and cf_fcy=@p_fcy
			order by cu_company,cu_code,cf_fcy
		else
			DECLARE crssupp0 CURSOR LOCAL FAST_FORWARD FOR
			select cu_company,cu_code,cf_fcy,cu_opnbal,cu_lcaloc,cf_opnfcy,cu_fcaloc from supplier where 
			cu_company=@p_compcode and replicate(space(1),6-len(rtrim(cu_code)))+rtrim(cu_code) between @p_fmcstcd and @p_tocstcd 
			and cf_fcy=@p_fcy and cu_class=@p_class
			order by cu_company,cu_code,cf_fcy
	end;
	open crssupp0;
	fetch next from crssupp0 into @l_company,@l_cucode,@lfcy,@lopnbal,@llcaloc,@lfopnbal,@lfcaloc
	WHILE dbo.FetchStatusOfCursorNamed('crssupp0') = 0
    BEGIN
	     set @pay_opn=0
		 set @inv_opn=0
		 set @lpayamt=0
		 set @orgrcv=0
		 set @ttlpay=0
		 set @opnval=0
		 set @lalocamt=0
		 set @linvamt=0
		 set @lcu_alocamt=0
	     set @opnval=iif(len(@lfcy)=0,@lopnbal-@llcaloc,@lfopnbal-@lfcaloc)
		 if @opnval<0
		    set @inv_opn =abs(@opnval)
		 else  set @pay_opn = @opnval

		 select @lpayamt=sum(iif(len(@lfcy)=0,dt_lcamt-dt_discamt-dt_lcaloc,dt_fcamt-dt_fdscamt-dt_fcaloc)) 
		 from apdtl where dt_company=@l_company and dt_cucode = @l_cucode and dt_fcy= @lfcy and
		 dt_aloctd = '1' And (dt_type in ('03','08','27','30','22') Or (dt_type='01' And dt_dbcr='D'))

		 set @ttlpay=isnull(@lpayamt,0)+@pay_opn
		 if @ttlpay>0 
		 begin
  			 select @linvamt=sum(iif(len(@lfcy)=0,dt_lcamt-dt_discamt-dt_lcaloc,dt_fcamt-dt_fdscamt-dt_fcaloc)) 
			 from apdtl where dt_company=@l_company and dt_cucode = @l_cucode and dt_fcy= @lfcy and
			 dt_aloctd = '1' And (dt_type in ('10','02','09','21','28') Or (dt_type='01' And dt_dbcr='C'))

			 set @linvamt=isnull(@linvamt,0)
		     begin transaction
		     set @orgrcv = @ttlpay
			 if @inv_opn>0
			 begin
			      if @ttlpay>=@inv_opn
				  begin
				      set @lalocamt=iif(len(@lfcy)=0,@llcaloc,@lfcaloc)+@inv_opn
					  set @ttlpay=@ttlpay-@inv_opn
				  end
				  else
				  begin
				      set @lalocamt=iif(len(@lfcy)=0,@llcaloc,@lfcaloc)+@ttlpay
					  set @ttlpay=0
				  end
				  if len(@lfcy)=0
					   update supplier set cu_lcaloc=-@lalocamt where cu_company=@l_company and cu_code=@l_cucode and
					   cf_fcy=@lfcy
				  else
				  	   update supplier set cu_fcaloc=-@lalocamt where cu_company=@l_company and cu_code=@l_cucode and
					   cf_fcy=@lfcy

		 		  if @@error<>0
				  begin
					  rollback transaction
					  set @errstatus=-1
					  break
				  end
				  set @lcu_alocamt=@lalocamt
			 end
			 if @ttlpay>0 and @linvamt>0
			 begin
			      set @lalocamt=0
				  set @ldt_company=''
				  set @ldt_cucode =''
				  set @ldt_fcy =''
				  set @ldt_type =''
				  set @ldt_ref  =0
				  set @ldt_folio =0
				  set @ldt_lcaloc =0
				  set @ldt_fcaloc =0
				  set @linvval =0

			      DECLARE crdtapdtl CURSOR LOCAL FAST_FORWARD FOR
				  select dt_company,dt_cucode,dt_fcy,dt_type, dt_ref,dt_folio,dt_lcaloc,dt_fcaloc,
				  iif(len(@lfcy)=0,dt_lcamt-dt_discamt-dt_lcaloc,dt_fcamt-dt_fdscamt-dt_fcaloc) as invval
				  from apdtl where dt_company=@l_company and dt_cucode = @l_cucode and dt_fcy= @lfcy and
			      dt_aloctd = '1' And (dt_type in ('10','02','09','21','28') Or (dt_type='01' And dt_dbcr='C'))
				  order by dt_date;
				  open crdtapdtl; 
				  fetch next from crdtapdtl into @ldt_company,@ldt_cucode,@ldt_fcy,@ldt_type,@ldt_ref,@ldt_folio,
				  @ldt_lcaloc,@ldt_fcaloc,@linvval
				  WHILE dbo.FetchStatusOfCursorNamed('crdtapdtl') = 0
                  BEGIN
				      set @ldt_aloctd='1'
				      if @ttlpay>=@linvval
					  begin
			              set @lalocamt=iif(len(@lfcy)=0,@ldt_lcaloc,@ldt_fcaloc)+@linvval
					      set @ttlpay=@ttlpay-@linvval
						  set @ldt_aloctd='2'
					  end
					  else
					  begin
			              set @lalocamt=iif(len(@lfcy)=0,@ldt_lcaloc,@ldt_fcaloc)+@ttlpay
					      set @ttlpay=0
					  end
					  if len(@lfcy)=0
						update apdtl set dt_lcaloc=@lalocamt,dt_aloctd = @ldt_aloctd where dt_company=@l_company and
						dt_cucode = @l_cucode and dt_fcy= @lfcy and dt_type=@ldt_type and dt_ref=@ldt_ref and
						dt_folio=@ldt_folio
					  else
						update apdtl set dt_fcaloc=@lalocamt,dt_aloctd = @ldt_aloctd where dt_company=@l_company and
						dt_cucode = @l_cucode and dt_fcy= @lfcy and dt_type=@ldt_type and dt_ref=@ldt_ref and
						dt_folio=@ldt_folio

		 			  if @@error<>0
					  begin
						  rollback transaction
						  set @errstatus=-1
						  break
					  end
					  if @ttlpay<=0 break

					  fetch next from crdtapdtl into @ldt_company,@ldt_cucode,@ldt_fcy,@ldt_type,@ldt_ref,@ldt_folio,
					  @ldt_lcaloc,@ldt_fcaloc,@linvval
				  end  -- End of crdtapdtl inner loop
				  CLOSE crdtapdtl
				  DEALLOCATE crdtapdtl
				  if  @errstatus<0 break
			 end  -- End of  @ttlpay>0 and @linvamt>0
			 if  @errstatus<0 break
---  setteled the received jv
		     set @ttlpay = @orgrcv-@ttlpay 
			 if @ttlpay>0
			 begin
			      if @pay_opn>0
				  begin
					  if @ttlpay>=@pay_opn
					  begin
						  set @lalocamt=@lcu_alocamt-@pay_opn
						  set @ttlpay=@ttlpay-@pay_opn
					  end
					  else
					  begin
						  set @lalocamt=@lcu_alocamt-@ttlpay
						  set @ttlpay=0
					  end
					  if len(@lfcy)=0
						   update supplier set cu_lcaloc=@lalocamt where cu_company=@l_company and cu_code=@l_cucode and
						   cf_fcy=@lfcy
					  else
				  		   update supplier set cu_fcaloc=@lalocamt where cu_company=@l_company and cu_code=@l_cucode and
						   cf_fcy=@lfcy

		 			  if @@error<>0
					  begin
						  rollback transaction
						  set @errstatus=-1
						  break
					  end
				  end
				  if @ttlpay>0
				  begin
----------------------------------------------------------------------------------------------------
					  set @lalocamt=0
					  set @ldt_company=''
					  set @ldt_cucode =''
					  set @ldt_fcy =''
					  set @ldt_type =''
					  set @ldt_ref  =0
					  set @ldt_folio =0
					  set @ldt_lcaloc =0
					  set @ldt_fcaloc =0
					  set @linvval =0

					  DECLARE payapdtl CURSOR LOCAL FAST_FORWARD FOR
					  select dt_company,dt_cucode,dt_fcy,dt_type, dt_ref,dt_folio,dt_lcaloc,dt_fcaloc,
					  iif(len(@lfcy)=0,dt_lcamt-dt_discamt-dt_lcaloc,dt_fcamt-dt_fdscamt-dt_fcaloc) as invval
					  from apdtl where dt_company=@l_company and dt_cucode = @l_cucode and dt_fcy= @lfcy and
					  dt_aloctd = '1' And (dt_type in ('03','08','27','30','22') Or (dt_type='01' And dt_dbcr='D'))
					  order by dt_date;
					  open payapdtl; 
					  fetch next from payapdtl into @ldt_company,@ldt_cucode,@ldt_fcy,@ldt_type,@ldt_ref,@ldt_folio,
					  @ldt_lcaloc,@ldt_fcaloc,@linvval
					  WHILE dbo.FetchStatusOfCursorNamed('payapdtl') = 0
					  BEGIN
					      set @ldt_aloctd='1'
						  if @ttlpay>=@linvval
						  begin
							  set @lalocamt=iif(len(@lfcy)=0,@ldt_lcaloc,@ldt_fcaloc)+@linvval
							  set @ttlpay=@ttlpay-@linvval
							  set @ldt_aloctd='2'
						  end
						  else
						  begin
							  set @lalocamt=iif(len(@lfcy)=0,@ldt_lcaloc,@ldt_fcaloc)+@ttlpay
							  set @ttlpay=0
						  end
						  if len(@lfcy)=0
							update apdtl set dt_lcaloc=@lalocamt,dt_aloctd = @ldt_aloctd where dt_company=@l_company and
							dt_cucode = @l_cucode and dt_fcy= @lfcy and dt_type=@ldt_type and dt_ref=@ldt_ref and
							dt_folio=@ldt_folio
						  else
							update apdtl set dt_fcaloc=@lalocamt,dt_aloctd = @ldt_aloctd where dt_company=@l_company and
							dt_cucode = @l_cucode and dt_fcy= @lfcy and dt_type=@ldt_type and dt_ref=@ldt_ref and
							dt_folio=@ldt_folio

		 				  if @@error<>0
						  begin
							  rollback transaction
							  set @errstatus=-1
							  break
						  end
						  if @ttlpay<=0 break

						  fetch next from payapdtl into @ldt_company,@ldt_cucode,@ldt_fcy,@ldt_type,@ldt_ref,@ldt_folio,
						  @ldt_lcaloc,@ldt_fcaloc,@linvval
					  end  -- End of payapdtl loop
					  CLOSE payapdtl
					  DEALLOCATE payapdtl
					  if  @errstatus<0 break
-----------------------------------------------------------------------------------------------------
				  end
			 end
		 end -- End of outter @ttlpay>0
		 if  @errstatus<0 break
		 if @@trancount>0 commit transaction


		 fetch next from crssupp0 into @l_company,@l_cucode,@lfcy,@lopnbal,@llcaloc,@lfopnbal,@lfcaloc
	end  -- End of outter loop
	CLOSE crssupp0
	DEALLOCATE crssupp0
	if @@trancount>0 
	if @errstatus<0 rollback transaction
	else commit transaction
end

GO
/****** Object:  StoredProcedure [dbo].[bld_ar_alocation]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-01-07@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[bld_ar_alocation]
 @p_compcode char(2),
 @p_class char(2),
 @p_fmcstcd char(6),
 @p_tocstcd char(6),
 @p_fcy char(3),
 @errstatus int = 0 output
	
AS
BEGIN
---- Added on 2023-11-25 AA Changed data type of numeric(6,0) to int
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
	set @errstatus =0
    declare @l_company char(2),
	        @l_cucode char(6),
			@lfcy  char(3),
			@lopnbal float,
			@lfopnbal float,
			@llcaloc float,
			@lfcaloc float,
			@lcu_alocamt float=0

     declare @ttlrcv float =0,
	         @orgrcv float =0,
	         @rcv_opn float=0,
			 @inv_opn float=0,
			 @opnval float=0,
			 @lrcvamt float=0,
			 @lalocamt float=0,
			 @linvamt float =0

     declare @ldt_company char(2),
	         @ldt_cucode  char(6),
			 @ldt_fcy char(3),
			 @ldt_type char(2),
			 @ldt_ref  int,
			 @ldt_folio int ,
			 @ldt_lcaloc float=0,
			 @ldt_fcaloc float=0,
			 @linvval float =0,
			 @ldt_aloctd char(1)='1'

			 set @p_fcy=isnull(@p_fcy,'   ')
			 set @p_class=isnull(@p_class,'  ')

	if isnull(@p_compcode,'')<>''
	begin
		set @p_fmcstcd= isnull(@p_fmcstcd,'')
		set @p_tocstcd= isnull(@p_tocstcd,'')
		if len(@p_fmcstcd)=0 set @p_fmcstcd='     1'
		if len(@p_tocstcd)=0 set @p_tocstcd='999999'
	end
    if isnull(@p_compcode,'')=''
		DECLARE crscust0 CURSOR LOCAL FAST_FORWARD FOR
		select cu_company,cu_code,cf_fcy,cu_opnbal,cu_lcaloc,cf_opnfcy,cu_fcaloc from customer where cu_onlycsh=0
		order by cu_company,replicate(space(1),6-len(rtrim(cu_code)))+rtrim(cu_code),cf_fcy
	else
	begin
	    if isnull(@p_class,'')=''
			DECLARE crscust0 CURSOR LOCAL FAST_FORWARD FOR
			select cu_company,cu_code,cf_fcy,cu_opnbal,cu_lcaloc,cf_opnfcy,cu_fcaloc from customer where 
			cu_company=@p_compcode and replicate(space(1),6-len(rtrim(cu_code)))+rtrim(cu_code) between @p_fmcstcd and @p_tocstcd 
			and cf_fcy=@p_fcy and cu_onlycsh=0
			order by cu_company,cu_code,cf_fcy
		else
			DECLARE crscust0 CURSOR LOCAL FAST_FORWARD FOR
			select cu_company,cu_code,cf_fcy,cu_opnbal,cu_lcaloc,cf_opnfcy,cu_fcaloc from customer where 
			cu_company=@p_compcode and replicate(space(1),6-len(rtrim(cu_code)))+rtrim(cu_code) between @p_fmcstcd and @p_tocstcd 
			and cf_fcy=@p_fcy and cu_onlycsh=0 and cu_class=@p_class
			order by cu_company,cu_code,cf_fcy
	end;
	open crscust0;
	fetch next from crscust0 into @l_company,@l_cucode,@lfcy,@lopnbal,@llcaloc,@lfopnbal,@lfcaloc
	WHILE dbo.FetchStatusOfCursorNamed('crscust0') = 0
    BEGIN
	     set @rcv_opn=0
		 set @inv_opn=0
		 set @lrcvamt=0
		 set @orgrcv=0
		 set @ttlrcv=0
		 set @opnval=0
		 set @lalocamt=0
		 set @linvamt=0
		 set @lcu_alocamt=0
	     set @opnval=iif(len(@lfcy)=0,@lopnbal-@llcaloc,@lfopnbal-@lfcaloc)
		 if @opnval<0
		    set @rcv_opn =abs(@opnval)
		 else  set @inv_opn = @opnval

		 select @lrcvamt=sum(iif(len(@lfcy)=0,dt_lcamt-dt_discamt-dt_lcaloc,dt_fcamt-dt_fdscamt-dt_fcaloc)) 
		 from ardtl where dt_company=@l_company and dt_cucode = @l_cucode and dt_fcy= @lfcy and
		 dt_aloctd = '1' And (dt_type in ('02','09','28','24','21') Or (dt_type='01' And dt_dbcr='C'))

		 set @ttlrcv=isnull(@lrcvamt,0)+@rcv_opn
		 if @ttlrcv>0 
		 begin
  			 select @linvamt=sum(iif(len(@lfcy)=0,dt_lcamt-dt_discamt-dt_lcaloc,dt_fcamt-dt_fdscamt-dt_fcaloc)) 
			 from ardtl where dt_company=@l_company and dt_cucode = @l_cucode and dt_fcy= @lfcy and
			 dt_aloctd = '1' And (dt_type in ('04','03','08','22','27') Or (dt_type='01' And dt_dbcr='D'))

			 set @linvamt=isnull(@linvamt,0)
		     begin transaction
		     set @orgrcv = @ttlrcv
			 if @inv_opn>0
			 begin
			      if @ttlrcv>=@inv_opn
				  begin
				      set @lalocamt=iif(len(@lfcy)=0,@llcaloc,@lfcaloc)+@inv_opn
					  set @ttlrcv=@ttlrcv-@inv_opn
				  end
				  else
				  begin
				      set @lalocamt=iif(len(@lfcy)=0,@llcaloc,@lfcaloc)+@ttlrcv
					  set @ttlrcv=0
				  end
				  if len(@lfcy)=0
					   update customer set cu_lcaloc=@lalocamt where cu_company=@l_company and cu_code=@l_cucode and
					   cf_fcy=@lfcy
				  else
				  	   update customer set cu_fcaloc=@lalocamt where cu_company=@l_company and cu_code=@l_cucode and
					   cf_fcy=@lfcy

		 		  if @@error<>0
				  begin
					  rollback transaction
					  set @errstatus=-1
					  break
				  end
				  set @lcu_alocamt=@lalocamt
			 end
			 if @ttlrcv>0 and @linvamt>0
			 begin
			      set @lalocamt=0
				  set @ldt_company=''
				  set @ldt_cucode =''
				  set @ldt_fcy =''
				  set @ldt_type =''
				  set @ldt_ref  =0
				  set @ldt_folio =0
				  set @ldt_lcaloc =0
				  set @ldt_fcaloc =0
				  set @linvval =0

			      DECLARE dbtardtl CURSOR LOCAL FAST_FORWARD FOR
				  select dt_company,dt_cucode,dt_fcy,dt_type, dt_ref,dt_folio,dt_lcaloc,dt_fcaloc,
				  iif(len(@lfcy)=0,dt_lcamt-dt_discamt-dt_lcaloc,dt_fcamt-dt_fdscamt-dt_fcaloc) as invval
				  from ardtl where dt_company=@l_company and dt_cucode = @l_cucode and dt_fcy= @lfcy and
			      dt_aloctd = '1' And (dt_type in ('04','03','08','22','27') Or (dt_type='01' And dt_dbcr='D'))
				  order by dt_date;
				  open dbtardtl; 
				  fetch next from dbtardtl into @ldt_company,@ldt_cucode,@ldt_fcy,@ldt_type,@ldt_ref,@ldt_folio,
				  @ldt_lcaloc,@ldt_fcaloc,@linvval
				  WHILE dbo.FetchStatusOfCursorNamed('dbtardtl') = 0
                  BEGIN
				      set @ldt_aloctd='1'
				      if @ttlrcv>=@linvval
					  begin
			              set @lalocamt=iif(len(@lfcy)=0,@ldt_lcaloc,@ldt_fcaloc)+@linvval
					      set @ttlrcv=@ttlrcv-@linvval
						  set @ldt_aloctd='2'
					  end
					  else
					  begin
			              set @lalocamt=iif(len(@lfcy)=0,@ldt_lcaloc,@ldt_fcaloc)+@ttlrcv
					      set @ttlrcv=0
					  end
					  if len(@lfcy)=0
						update ardtl set dt_lcaloc=@lalocamt,dt_aloctd = @ldt_aloctd where dt_company=@l_company and
						dt_cucode = @l_cucode and dt_fcy= @lfcy and dt_type=@ldt_type and dt_ref=@ldt_ref and
						dt_folio=@ldt_folio
					  else
						update ardtl set dt_fcaloc=@lalocamt,dt_aloctd = @ldt_aloctd where dt_company=@l_company and
						dt_cucode = @l_cucode and dt_fcy= @lfcy and dt_type=@ldt_type and dt_ref=@ldt_ref and
						dt_folio=@ldt_folio

		 			  if @@error<>0
					  begin
						  rollback transaction
						  set @errstatus=-1
						  break
					  end
					  if @ttlrcv<=0 break

					  fetch next from dbtardtl into @ldt_company,@ldt_cucode,@ldt_fcy,@ldt_type,@ldt_ref,@ldt_folio,
					  @ldt_lcaloc,@ldt_fcaloc,@linvval
				  end  -- End of dbtardtl inner loop
				  CLOSE dbtardtl
				  DEALLOCATE dbtardtl
				  if  @errstatus<0 break
			 end  -- End of  @ttlrcv>0 and @linvamt>0
			 if  @errstatus<0 break
---  setteled the received jv
		     set @ttlrcv = @orgrcv-@ttlrcv 
			 if @ttlrcv>0
			 begin
			      if @rcv_opn>0
				  begin
					  if @ttlrcv>=@rcv_opn
					  begin
						  set @lalocamt=@lcu_alocamt-@rcv_opn
						  set @ttlrcv=@ttlrcv-@rcv_opn
					  end
					  else
					  begin
						  set @lalocamt=@lcu_alocamt-@ttlrcv
						  set @ttlrcv=0
					  end
					  if len(@lfcy)=0
						   update customer set cu_lcaloc=@lalocamt where cu_company=@l_company and cu_code=@l_cucode and
						   cf_fcy=@lfcy
					  else
				  		   update customer set cu_fcaloc=@lalocamt where cu_company=@l_company and cu_code=@l_cucode and
						   cf_fcy=@lfcy

		 			  if @@error<>0
					  begin
						  rollback transaction
						  set @errstatus=-1
						  break
					  end
				  end
				  if @ttlrcv>0
				  begin
----------------------------------------------------------------------------------------------------
					  set @lalocamt=0
					  set @ldt_company=''
					  set @ldt_cucode =''
					  set @ldt_fcy =''
					  set @ldt_type =''
					  set @ldt_ref  =0
					  set @ldt_folio =0
					  set @ldt_lcaloc =0
					  set @ldt_fcaloc =0
					  set @linvval =0

					  DECLARE rcvardtl CURSOR LOCAL FAST_FORWARD FOR
					  select dt_company,dt_cucode,dt_fcy,dt_type, dt_ref,dt_folio,dt_lcaloc,dt_fcaloc,
					  iif(len(@lfcy)=0,dt_lcamt-dt_discamt-dt_lcaloc,dt_fcamt-dt_fdscamt-dt_fcaloc) as invval
					  from ardtl where dt_company=@l_company and dt_cucode = @l_cucode and dt_fcy= @lfcy and
					  dt_aloctd = '1' And (dt_type in ('02','09','28','24','21') Or (dt_type='01' And dt_dbcr='C'))
					  order by dt_date;
					  open rcvardtl; 
					  fetch next from rcvardtl into @ldt_company,@ldt_cucode,@ldt_fcy,@ldt_type,@ldt_ref,@ldt_folio,
					  @ldt_lcaloc,@ldt_fcaloc,@linvval
					  WHILE dbo.FetchStatusOfCursorNamed('rcvardtl') = 0
					  BEGIN
					      set @ldt_aloctd='1'
						  if @ttlrcv>=@linvval
						  begin
							  set @lalocamt=iif(len(@lfcy)=0,@ldt_lcaloc,@ldt_fcaloc)+@linvval
							  set @ttlrcv=@ttlrcv-@linvval
							  set @ldt_aloctd='2'
						  end
						  else
						  begin
							  set @lalocamt=iif(len(@lfcy)=0,@ldt_lcaloc,@ldt_fcaloc)+@ttlrcv
							  set @ttlrcv=0
						  end
						  if len(@lfcy)=0
							update ardtl set dt_lcaloc=@lalocamt,dt_aloctd = @ldt_aloctd where dt_company=@l_company and
							dt_cucode = @l_cucode and dt_fcy= @lfcy and dt_type=@ldt_type and dt_ref=@ldt_ref and
							dt_folio=@ldt_folio
						  else
							update ardtl set dt_fcaloc=@lalocamt,dt_aloctd = @ldt_aloctd where dt_company=@l_company and
							dt_cucode = @l_cucode and dt_fcy= @lfcy and dt_type=@ldt_type and dt_ref=@ldt_ref and
							dt_folio=@ldt_folio

		 				  if @@error<>0
						  begin
							  rollback transaction
							  set @errstatus=-1
							  break
						  end
						  if @ttlrcv<=0 break

						  fetch next from rcvardtl into @ldt_company,@ldt_cucode,@ldt_fcy,@ldt_type,@ldt_ref,@ldt_folio,
						  @ldt_lcaloc,@ldt_fcaloc,@linvval
					  end  -- End of rcvardtl loop
					  CLOSE rcvardtl
					  DEALLOCATE rcvardtl
					  if  @errstatus<0 break
-----------------------------------------------------------------------------------------------------
				  end
			 end
		 end -- End of outter @ttlrcv>0
		 if  @errstatus<0 break
		 if @@trancount>0 commit transaction


		 fetch next from crscust0 into @l_company,@l_cucode,@lfcy,@lopnbal,@llcaloc,@lfopnbal,@lfcaloc
	end  -- End of outter loop
	CLOSE crscust0
	DEALLOCATE crscust0
	if @@trancount>0 
	if @errstatus<0 rollback transaction
	else commit transaction
end


GO
/****** Object:  StoredProcedure [dbo].[bld_bal_and_cost_4_one_trx]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-01-07@@$$##  Important : must have this line as first line which contains the last update date for the this file
CREATE PROCEDURE [dbo].[bld_bal_and_cost_4_one_trx]
 @m_cmp char(2),
 @m_type char(2),
 @m_ref  int, 
 @m_pass2 bit,
 @errstatus int = 0 output

AS
BEGIN
---- 2023-11-26 AA Changed the data type of all numeric(6,0) to int
---- 2022-12-21 Fixed the bug when and inventory transaction has JV (glref>0) do not build cost
---- 2022-12-21 AA  semi colons are added to the end of eash select statements
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
-- 
-- This section is used to addup new entries for stbins
--
declare @lcurbal float ,
        @lrunbal float,
        @inbal float,
        @lopenbal float,
		@llprice float,
		@llcost float,
		@lfcost float,
		@lopenlcost float,
		@lopenfcost float,
		@trxlcost float,
		@trxfcost float,
		@trxqty float,
		@lbranch char(2),
        @litemno char(16),
		@lunicode char(6) ,
		@lwhno char(2) ,
		@lbinno char(6),
		@lttlqty float=0,
		@lmnopenlcost float,
		@stk_lcost float,
		@costchg int=0,
		@lastcost float,
		@stk_fcost float,
		@lmnopenfcost float,
		@lrcvdtrn bit
		



declare 
	@dbc nvarchar(14),
	@lcalcomp char(2),
	@yrcode char(4),
	@lbrxautojv bit=0
	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)

	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @lbrxautojv=brxautojv  from sysdb.dbo.glcalend 
	       where calcomp=@lcalcomp and yrcode=@yrcode
    set @lbrxautojv=isnull(@lbrxautojv,0)
--------------------------------------------------------------------------------------------------------------------------- 
      
		begin transaction 
		--if @m_pass2=0
		--begin
		--	delete from stbins  where openbal=0 and openlcost=0 and
		--	exists(select distinct itemno from stdtl k
		--	where stbins.itemno=k.itemno and stbins.unicode=k.unicode 
		--	and k.branch=@m_cmp and k.trtype=@m_type and k.ref=@m_ref)
		--	if @@error<>0
		--	begin
		--		rollback transaction
		--		set @errstatus=-1		
		--		return		 
		--	end
		--end
		update stbins set qty=openbal,lcost=openlcost,fcost=openfcost where 
		exists(select distinct itemno from stdtl k
		where stbins.itemno=k.itemno and stbins.unicode=k.unicode 
		and k.branch=@m_cmp and k.trtype=@m_type and k.ref=@m_ref)

		if @@error<>0
			begin
			  rollback transaction
			  set @errstatus=-1		
			  return		 
			end
			
		update stunits set curbal=openbal,lcost=openlcost,fcost=openfcost where 
		exists(select distinct itemno from stdtl k
		where stunits.itemno=k.itemno and stunits.unicode=k.unicode and k.branch=@m_cmp and k.trtype=@m_type and k.ref=@m_ref)

		if @@error<>0
			begin
			  rollback transaction
			  set @errstatus=-1		
			  return		 
			end
		--commit transaction
-----------------------------------------------------------------------------------------------
     if @m_pass2=0
	 begin
        --begin transaction
		merge stbins as t
		using (select distinct branch,a.itemno,a.unicode,whno,binno from stdtl a inner join stunits b 
		   on a.itemno=b.itemno and a.unicode=b.unicode
		   inner join stitems c
		   on b.itemno=c.itemno
		where c.itemtype not in ('5','6') and exists(select distinct itemno from stdtl k
		where b.itemno=k.itemno and b.unicode=k.unicode and k.branch=@m_cmp and k.trtype=@m_type and k.ref=@m_ref)) as s		
		on t.branch=s.branch and t.itemno=s.itemno and t.unicode=s.unicode and t.whno=s.whno and t.binno=s.binno
		when not matched then
			insert values (s.branch,s.itemno,s.unicode,s.whno,s.binno,0,0,0,0,0,0,0,'');
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-1	
				return --@errstatus			 				
			end			

	 end
-----------------------------------------------------------------------------------------------
--  Building stbins items qty balances & cost
--
     declare @ltrtype char(2),
	         @ltrdate char(8),
	         @lref int,
			 @lqty float,
			 @lfolio int,
			 @lisbrtrx bit,
			 @lposted bit,
			 @ltowhno char(2),
			 @ltobinno char(6),
			 @lfcy char(3),
			 @lfcyrate float,
			 @ttp int,
			 @dont_check_cost int=0,
			 @xdate char(8),
			 @lcurfixrate float=0,
			 @lglref int=0; -- Added on 2022-12-21 AA

     set @errstatus=0;
     DECLARE crs0 CURSOR LOCAL FAST_FORWARD FOR
     select distinct a.branch,a.itemno,a.unicode,a.whno,a.binno,a.openbal,a.openlcost,a.openfcost,b.fcy,c.openlcost as mnopenlcost,
	 c.openfcost as mnopenfcost from  stbins a inner join stunits c 
	 on a.itemno=c.itemno and a.unicode=c.unicode
	 inner join stitems b
	 on c.itemno=b.itemno 
	 where 	exists(select distinct itemno from stdtl k
		where a.itemno=k.itemno and a.unicode=k.unicode and k.branch=@m_cmp and k.trtype=@m_type and k.ref=@m_ref)
	 order by a.itemno;
	
	 
  	 open crs0;

------------------------------------
		fetch next from crs0 into @lbranch,@litemno,@lunicode,@lwhno,@lbinno,@lopenbal,@lopenlcost,@lopenfcost,@lfcy,
		@lmnopenlcost,@lmnopenfcost;

		--begin transaction
		WHILE dbo.FetchStatusOfCursorNamed('crs0') = 0
        BEGIN
		    set @lrunbal=@lopenbal
			set @dont_check_cost=0
			set @stk_lcost=@lopenlcost
	--		print '******************'+' '+str(@stk_lcost)+' '+@litemno+' '+@lwhno
			set @stk_fcost=@lopenfcost
			--if @stk_lcost=0 and @lmnopenlcost>0 set @stk_lcost=@lmnopenlcost 
			--if @stk_fcost=0 and @lmnopenfcost>0 set @stk_fcost=@lmnopenfcost 
			set @lcurfixrate=0
			if len(@lfcy)>0 select @lcurfixrate=curfix from glcurr where curcode=@lfcy

            DECLARE crs1 CURSOR LOCAL FAST_FORWARD FOR
			select a.trtype,a.ref,a.folio,qty+fqty as qty,lcost,fcost,isbrtrx,posted,a.towhno,a.tobinno,fcyrate,a.trdate,rcvdtrn,
			b.glref -- Added on 2022-12-21 AA
			from sthdr b inner join stdtl a
	    	on b.branch=a.branch and b.trtype=a.trtype and b.ref=a.ref 
	    	where a.branch=@lbranch and a.itemno=@litemno and a.unicode=@lunicode and a.whno=@lwhno and binno=@lbinno
			order by a.trdate ,Iif(a.trtype in ('10','11','01','13','46','12','14'),'01','02'),a.ref,folio;

			open crs1;

			fetch next from crs1 into @ltrtype,@lref,@lfolio,@lqty,@llcost,@lfcost,@lisbrtrx,@lposted,@ltowhno
			,@ltobinno,@lfcyrate,@ltrdate,@lrcvdtrn,@lglref; -- Added on 2022-12-21 AA @lglref

			WHILE dbo.FetchStatusOfCursorNamed('crs1') = 0
            BEGIN
			    set @trxlcost=0
				set @trxfcost=0
			    set @ttp=cast(@ltrtype as int)
				if @lposted=1
				begin
				   if @ttp in (4,6,9,30,31,2)
				   begin
				       set @lrunbal=@lrunbal-@lqty
				   end
				   if @ttp in (5,24,26,13,12) or (@ttp=46 And @lqty<0)  
				   begin
				       set @lrunbal=@lrunbal+@lqty
        --               If @lqty>0 And @stk_lcost=0 
					   --begin  
        --                 set @stk_lcost=@llcost
        --                 set @stk_fcost=@lfcost
        --               end
				   end
	               if @ttp in (1,10,11) or (@ttp=46 And @lqty>0) 
				   begin
				      if @lrunbal>0
					  begin
							-- added on 2018-04-04
							if @stk_lcost>0
							set @stk_lcost=Abs(((@stk_lcost*@lrunbal)+Abs(@lqty*@llcost))/(@lrunbal+@lqty))
							else set @stk_lcost=@llcost

						  if isnull(@lfcost,0)<>0
						  begin 
						       if @stk_fcost>0
						          set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*@lfcost))/(@lrunbal+@lqty))
							   else set @stk_fcost=@lfcost
						  end
						  else 
						  if isnull(@lfcy,'')<>''
						  begin
							   if  isnull(@lfcyrate,0)>0
							     if @stk_fcost>0
								   set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*(@llcost/@lfcyrate)))/(@lrunbal+@lqty))
								 else set @stk_fcost=(@llcost/@lfcyrate)
							   else 
							   if isnull(@lcurfixrate,0)>0
							        if @stk_fcost>0
									  set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*(@llcost/@lcurfixrate)))/(@lrunbal+@lqty))
									else set @stk_fcost=(@llcost/@lcurfixrate)
						  end
					  end
					  else
					  begin
							set @stk_lcost=@llcost
							if isnull(@lfcost,0)<>0  set @stk_fcost=@lfcost
							else if isnull(@lfcy,'')<>'' 
							begin
								if  isnull(@lfcyrate,0)>0 set @stk_fcost=@llcost/@lfcyrate
								else  if isnull(@lcurfixrate,0)>0 set @stk_fcost=@llcost/@lcurfixrate
							end
					  end
					  set @lrunbal=@lrunbal+@lqty
				   end
                   if @ttp=20
				   begin
				       if rtrim(@ltowhno)=''
					   begin
						   if @stk_lcost=0
						   begin
							 set @stk_lcost=@llcost
							 set @stk_fcost=@lfcost
						   end
						   else
						   if @lrunbal>0
						   begin
							   set @stk_lcost=Abs(((@stk_lcost*@lrunbal)+Abs(@lqty*@llcost))/(@lrunbal+@lqty))
							   if isnull(@lfcost,0)<>0 
								   set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*@lfcost))/(@lrunbal+@lqty))
						   end
						   else
						   begin
							 set @stk_lcost=@llcost
							 set @stk_fcost=@lfcost
						   end
					   end
				       set @lrunbal = @lrunbal + Iif(rtrim(@ltowhno)<>'',-@lqty,@lqty)
				   end
				   if @ttp=14
				   begin
					   set @stk_lcost=@llcost
					   set @stk_fcost=@lfcost
				   end
			    end  -- end of @lposted

				---------- beginning of stdtl lcost update
		--		print 'dd'+' '+str(@stk_lcost)+' type='+@ltrtype+' ref='+str(@lref)+' '+@litemno
		        If not (@ttp in (1,10,11,14,30,31,20) or (@ttp=46 And @lqty>0) or @lisbrtrx=1
				      or @lglref>0) -- Added on 2022-12-21 AA
--				((@lrcvdtrn=1 or @lposted=1 or @lbrxautojv=1) and @lisbrtrx=1 ))
				begin
				    if @stk_lcost=0 and  @dont_check_cost<3  ----runbal<0 And !okpurchaseinvoice And !T_NOT_POSTED.
					begin
						if @ttp<>'20'
						begin
						     set @dont_check_cost +=1
							 set @xdate=@ltrdate
							 Select top 1 @trxlcost=lcost,@trxfcost=fcost,@trxqty=qty+fqty From stdtl where
							 branch=@lbranch and itemno=@litemno and unicode=@lunicode and whno=@lwhno and
							 binno=@lbinno and --trdate>=@xdate and 
							 (trtype in ('01','10','11') or (trtype='46' And qty>0) or (trtype='20' And @ltowhno=''))
							 order by trdate,iif(trtype in ('01','10','11'),1,2),stdtl.ref,folio;

							 if isnull(@trxlcost,0)=0
							 begin
							     set @dont_check_cost +=1
								 Select top 1 @trxlcost=lcost,@trxfcost=fcost From stdtl where
								 branch=@lbranch and itemno=@litemno and unicode=@lunicode and whno=@lwhno
								  and --trdate>=@xdate and 
								 (trtype in ('01','10','11') or (trtype='46' And qty>0) or (trtype='20' And @ltowhno=''))
								 order by trdate,iif(trtype in ('01','10','11'),1,2),stdtl.ref,folio;
								 --print '3'+str(isnull(@trxlcost,0))+' type='+@ltrtype+' ref='+str(@lref)
								 if isnull(@trxlcost,0)=0 --is null
								 begin
								     set @dont_check_cost +=1
									 Select top 1 @trxlcost=lcost,@trxfcost=fcost From stdtl where
									 branch=@lbranch and itemno=@litemno and unicode=@lunicode 
									  and  
									 (trtype in ('01','10','11') or (trtype='46' And qty>0) or 
									 (trtype='20' And @ltowhno=''))
									 order by trdate,iif(trtype in ('01','10','11'),1,2),stdtl.ref,folio;
									 if isnull(@trxlcost,0)=0 --is null
									 begin
										 set @dont_check_cost +=1
										 Select top 1 @trxlcost=lcost,@trxfcost=fcost From stdtl where
										 itemno=@litemno and unicode=@lunicode 
										  and  
										 (trtype in ('01','10','11') or (trtype='46' And qty>0)) 
										 order by trdate,iif(trtype in ('01','10','11'),1,2),stdtl.ref,folio;

										 if isnull(@trxlcost,0)=0 --is null
										 begin
											set @trxlcost=0
											set @trxfcost=0
											select @trxlcost=lastlcost,@trxfcost=lastfcost from stcosttype 
											where branch=@lbranch  and itemno=@litemno and unicode=@lunicode;
											if isnull(@trxlcost,0)=0
											begin
												select top 1 @trxlcost=lastlcost,@trxfcost=lastfcost from stcosttype 
												where  itemno=@litemno and unicode=@lunicode order by lstrcvdate desc,branch; 
											end
										 end	

									 end
								 end
							 end
						end
						--else
						--if @ttp=20 and rtrim(@ltowhno)<>''
						--begin
						--	 set @xdate=@ltrdate
						--	 Select top 1 @trxlcost=lcost,@trxfcost=fcost,@trxqty=qty+fqty From stdtl where
						--	 branch=@lbranch  and itemno=@litemno and unicode=@lunicode and whno=@lwhno and
						--	 binno=@lbinno and trdate>=@xdate and 
						--	 (trtype in ('01','10','11') or (trtype='46' And qty>0))
						--	 order by trdate,iif(trtype in ('01','10','11'),1,2)
						--end
						if not(@ttp=20) -- and rtrim(@ltowhno)='')
						begin
							if isnull(@trxlcost,0)>0
							begin
								set @stk_lcost=@trxlcost
								set @stk_fcost=isnull(@trxfcost,0)
							end
							else
							begin
								if @stk_lcost=0 and @lmnopenlcost>0 set @stk_lcost=ABS(@lmnopenlcost)
								if @stk_fcost=0 and @lmnopenfcost>0 set @stk_fcost=ABS(@lmnopenfcost)
							end
						end
						--print '5'+str(@stk_lcost)+' type='+@ltrtype+' ref='+str(@lref)+'  '+@litemno
					end  -- end of @stk_lcost=0
					if not(@ttp=20) --and rtrim(@ltowhno)='')
					begin
					    if @stk_lcost>0 
						begin
						   -- print '6'+str(@stk_lcost)+' type='+@ltrtype+' ref='+str(@lref)+'  '+@litemno
						    update stdtl set lcost=@stk_lcost,fcost=@stk_fcost where branch=@lbranch and trtype=@ltrtype and
							ref=@lref and folio=@lfolio;
			         	    if @@error<>0
						    begin
							    rollback transaction
							    set @errstatus=-1
							    break
						    end
						end 
					end
					if @ttp=20 and @stk_lcost=0 and @llcost>0
					begin
					   set @stk_lcost=@llcost
					end
					--if @ttp=20 and rtrim(@ltowhno)<>''
					--begin
		   --             if @stk_lcost>0
					--	    update stdtl set lcost=@stk_lcost,fcost=@stk_fcost where branch=@lbranch and trtype=@ltrtype and
					--	    ref=@lref and itemno=@litemno and unicode=@lunicode and whno=@ltowhno and binno=@ltobinno
					--	else
					--       update stdtl set lcost=@llcost,fcost=@lfcost where branch=@lbranch and trtype=@ltrtype and
					--	   ref=@lref and itemno=@litemno and unicode=@lunicode and whno=@ltowhno and binno=@ltobinno

					-- --   update stdtl set lcost=@llcost,fcost=@lfcost where branch=@lbranch and trtype=@ltrtype and
					--	--ref=@lref and itemno=@litemno and unicode=@lunicode and whno=@ltowhno and binno=@ltobinno
			  --       	if @@error<>0
					--	begin
					--		rollback transaction
					--		set @errstatus=-1
					--		break
					--	end
					--end
				end -- end of stdtl lcost update
				fetch next from crs1 into @ltrtype,@lref,@lfolio,@lqty,@llcost,@lfcost,@lisbrtrx,@lposted,@ltowhno
			    ,@ltobinno,@lfcyrate,@ltrdate,@lrcvdtrn,@lglref; -- Added on 2022-12-21 AA @lglref
			end  -- end of crs1 inner loop
            CLOSE crs1
            DEALLOCATE crs1
			if @errstatus<=-1
			break;

------------------------------------------------------

-----
------          update stbins qty & lcost
------

            if @lrunbal<>0 and  @stk_lcost=0
			if exists(SELECT table_name  FROM INFORMATION_SCHEMA.tables  WHERE TABLE_NAME = 'stcosttype')
			begin
			    select @trxlcost=lastlcost,@trxfcost=lastfcost from stcosttype 
				where branch=@lbranch  and itemno=@litemno and unicode=@lunicode;
				if isnull(@trxlcost,0)>0
				begin
					set @stk_lcost=@trxlcost
					set @stk_fcost=isnull(@trxfcost,0)
				end
			end

			  if @stk_lcost=0
			  if @lopenlcost>0 
			  begin
			       set @stk_lcost=@lopenlcost
				   set @stk_fcost=@lopenfcost
			  end
			  else if @lmnopenlcost>0
			  begin
			       set @stk_lcost=@lmnopenlcost
				   set @stk_fcost=@lmnopenfcost
			  end
			  else if @lastcost>0 set @stk_lcost=@lastcost

            update stbins set qty=@lrunbal,lcost=@stk_lcost,fcost=@stk_fcost where 
			branch=@lbranch and itemno=@litemno and unicode=@lunicode and whno=@lwhno and binno=@lbinno;
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-1
				break
			end
			fetch next from crs0 into @lbranch,@litemno,@lunicode,@lwhno,@lbinno,@lopenbal,@lopenlcost,@lopenfcost,@lfcy,
			@lmnopenlcost,@lmnopenfcost;
		end  -- end of crs0 ourter loop
		CLOSE crs0;
        DEALLOCATE crs0;
		if @errstatus<=-1 
		begin
		    rollback transaction
			return
	    end
		
---
----------------  Update stunits curbal & lcost
---

       --begin transaction
	   update stunits set curbal=xcurbal,lcost=iif(xcurbal<>0,abs(ttllcost/xcurbal),iif(lcost<>0,lcost,xxlcost)),
	   fcost=iif(xcurbal<>0,abs(ttlfcost/xcurbal),iif(fcost<>0,fcost,xxfcost))
	   from stunits as v
	   join
	   (select itemno,unicode,xcurbal=sum(qty),ttllcost=sum(qty*lcost),ttlfcost=sum(qty*isnull(fcost,0)),
	    xxlcost=avg(lcost),xxfcost=avg(fcost)
	    from stbins
		where exists(select distinct itemno from stdtl k
		where stbins.itemno=k.itemno and stbins.unicode=k.unicode 
		and k.branch=@m_cmp and k.trtype=@m_type and k.ref=@m_ref)
	    group by itemno,unicode) c
		on v.itemno=c.itemno and v.unicode=c.unicode;
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-1
			return --@errstatus
		end

		commit transaction
		
end


GO
/****** Object:  StoredProcedure [dbo].[bld_charity_card_bal]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-04-07@@$$##  Important : must have this line as first line which contains the last update date for the this file 
--- Added on 2024-04-05 AA fixed the bug if the cards in the company level
--- Added on 2020-12-21 AA joined posppcard with pos_hd
CREATE PROCEDURE [dbo].[bld_charity_card_bal]
  
 @errstatus int = 0 output
	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
--- Added on 2024-04-05 AA ----------------------
	declare @lppcard_cmp_lvl bit =0
	set @lppcard_cmp_lvl=cast(@errstatus as bit)
------------------------------------------------
    begin transaction
	update pos_dsc set mnth_target=mnthbal where cardtype=4
			if @@error<>0 
			begin		  
				rollback transaction
				set @errstatus=-1
				return 
			end
	update pos_dsc set mnth_target=mnthbal+isnull(netrcv,0)
		 from pos_dsc t
		 join 
		(Select a.company,a.cstcode,netrcv=Sum(a.lcamt) From pos_chdt a inner Join pos_chhd b 
		 On  a.company=b.company and a.ref=b.ref
		 Where  posted=1
		 group by a.company,a.cstcode) s
		 on t.dsccompany=s.company and t.dsccard=s.cstcode
		 where t.cardtype=4
			if @@error<>0 
			begin		  
				rollback transaction
				set @errstatus=-2
				return  
			end
--        commit transaction
    if @lppcard_cmp_lvl=0
	begin
		update pos_dsc set mnth_target=mnth_target-isnull(netsales,0)
			 from pos_dsc t
			 join 
			 (Select b.company,b.disccard,netsales=Sum((b.prepaidamt)*Iif(invorrtrn='1',1,-1)) 
				From pos_hd inner join posppcard b on pos_hd.company=b.company and pos_hd.contr=b.contr and pos_hd.ref=b.ref
				where  invorrtrn<>'4' and b.paytype=4
				group by b.company,b.disccard) s
				on t.dsccompany=s.company and t.dsccard=s.disccard
				where t.cardtype=4
	end
--- Added on 2024-04-05 AA --------------------------------------------------------------------------------------------------------
	else
	begin
		update pos_dsc set mnth_target=mnth_target-isnull(netsales,0)
			 from pos_dsc t
			 join 
			 (Select b.disccard,netsales=Sum((b.prepaidamt)*Iif(invorrtrn='1',1,-1)) 
				From pos_hd inner join posppcard b on pos_hd.company=b.company and pos_hd.contr=b.contr and pos_hd.ref=b.ref
				where  invorrtrn<>'4' and b.paytype=4
				group by b.disccard) s
				on t.dsccard=s.disccard
				where t.cardtype=4
	end
--------------------------------------------------------------------------------------------------------------------------------------
	if @@error<>0 
	begin		  
		rollback transaction
		set @errstatus=-3
		return 
	end
	commit transaction
			
end


GO
/****** Object:  StoredProcedure [dbo].[bld_charity_card_bal_swdruh]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[bld_charity_card_bal_swdruh]
 @lsc_code char(6), 
 @errstatus int = 0 output
	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
    begin transaction
	update pos_dsc set mnth_target=mnthbal where cardtype=4 and substring(dsccard,1,6)=@lsc_code
			if @@error<>0 
			begin		  
				rollback transaction
				set @errstatus=-1
				return 
			end
	update pos_dsc set mnth_target=mnthbal+isnull(netrcv,0)
		 from pos_dsc t
		 join 
		(Select a.company,a.cstcode,netrcv=Sum(a.lcamt) From pos_chdt a inner Join pos_chhd b 
		 On  a.company=b.company and a.sc_code=b.sc_code and a.ref=b.ref
		 Where  posted=1 and b.sc_code=@lsc_code
		 group by a.company,a.cstcode) s
		 on t.dsccompany=s.company and t.dsccard=s.cstcode
		 where t.cardtype=4
			if @@error<>0 
			begin		  
				rollback transaction
				set @errstatus=-2
				return  
			end
--        commit transaction
	update pos_dsc set mnth_target=mnth_target-isnull(netsales,0)
		 from pos_dsc t
		 join 
		 (Select company,disccard,netsales=Sum((prepaidamt)*Iif(invorrtrn='1',1,-1)) 
			From pos_hd 
			where  invorrtrn<>'4' and paytype=4
			group by company,disccard) s
			on t.dsccompany=s.company and t.dsccard=s.disccard
			where t.cardtype=4
			if @@error<>0 
			begin		  
				rollback transaction
				set @errstatus=-3
				return 
			end
			commit transaction
			
end














GO
/****** Object:  StoredProcedure [dbo].[bld_cost_4_all_isbrtrx]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-01-07@@$$##  Important : must have this line as first line which contains the last update date for the this file
CREATE PROCEDURE [dbo].[bld_cost_4_all_isbrtrx]
 @errstatus int = 0 output
AS
BEGIN
---- 2023-10-26 AA Force to select the proper openlcost for each binno at beginning
---- 2023-10-25 AA Even the @stk_lcost>0 put openbal<=0 , now forcing to search for any purchase for the item
---- 2023-10-25 AA Added new variable @item_received to track if the item already has received qty & has lcost
---- 2023-10-25 AA enhenced the search for lcost when ever the stk_lcost =0
---- 2023-08-16 AA convert numeric(6,0) to int for @lref & @lglref
---- Added on 2023-05-31 AA Many codes are stopped & some new codes are added to fix discripincy cost of trx between branches
---- Added on 2023-05-31 AA used @trsnfer_recs=count(*) instead of top 1 @trsnfer_recs=ref
---- Added on 2023-05-31 AA used @no_transactions=count(*) instead of top 1 @no_transactions=ref
---- 2022-12-21 Fixed the bug when and inventory transaction has JV (glref>0) do not build cost
---- Added on 2022-05-23 AA to check if there is no transactions between branchs then return
---- Added on 2022-05-23 AA stop creating index xx100xxtemp
---- Added on 2022-05-23 AA semi colons are added to the end of eash select statements
---- Added on 2022-05-23 AA Fixed the bug of converting float to numeric(20,12)
	SET NOCOUNT ON
-- 

declare @lcurbal float ,
        @lrunbal float,
        @inbal float,
        @lopenbal float,
		@llprice float,
		@llcost float,
		@lfcost float,
		@lopenlcost float,
		@lopenfcost float,
		@trxlcost float,
		@trxfcost float,
		@trxqty float,
		@lbranch char(2),
        @litemno char(16),
		@lunicode char(6) ,
		@lwhno char(2) ,
		@lbinno char(6),
		@lttlqty float=0,
		@lmnopenlcost float,
		@stk_lcost float,
		@costchg int=0,
		@lastcost float,
		@lastfcost float=0,
		@stk_fcost float,
		@lmnopenfcost float,
		@trsnfer_recs int=0,
		@trx_lastcost float=0
		

declare @l_ttlcost float=0,
        @l_item_count int =0,
		@l_pcslcost float =0,
		@l_fcttlcost float =0,
		@l_pcsfcost float =0


---
---   Prepair for deletion and updating to openbal vaalues
---
      
		
	
	
		--commit transaction

-----------------------------------------------------------------------------------------------
--  Building stbins items qty balances & cost
--
     declare @ltrtype char(2),
	         @ltrdate char(8),
	         @lref int,
			 @lqty float,
			 @lfolio int,
			 @lisbrtrx bit,
			 @lposted bit,
			 @ltowhno char(2),
			 @ltobinno char(6),
			 @lfcy char(3),
			 @lfcyrate float,
			 @ttp int,
			 @dont_check_cost int=0,
			 @xdate char(8),
			 @lcurfixrate float =0,
			 @ltobrno char(2)='',
			 @lbrxref int =0,
			 @lclient_is_shobra int =0,
			 @lglref int=0,
			 @item_received bit =0 -- Added on 2023-10-25 AA 
			 
declare 
	@dbc nvarchar(14),
	@lcalcomp char(2),
	@yrcode char(4),
	@lbrxautojv bit=0
	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)

    set @errstatus=0;	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @lbrxautojv=isnull(brxautojv,0)  from sysdb.dbo.glcalend 
	       where calcomp=@lcalcomp and yrcode=@yrcode;
    set @lbrxautojv=isnull(@lbrxautojv,0)

	if  @lbrxautojv=1 return @errstatus
----- Modification for shobra 2018-06-29  --------------------------
  select @lclient_is_shobra=count(*) from stbranch where smsuser in (142,143);
---------------------------------------------------------------------
---- Added on 2022-05-23 AA ------------------------------------
    declare @no_transactions int 
	set @no_transactions=0
---- Stopped on 2023-05-31 AA -------------------------------------
	--select top 1 @no_transactions=ref from sthdr where isbrtrx=1;
---- Added on 2023-05-31 AA -------------------------------------
    select  @no_transactions=count(*) from sthdr where isbrtrx=1;
	if isnull(@no_transactions,0)=0 return @errstatus
--------------------------------------------------------------------
     
     DECLARE crs0 CURSOR LOCAL FAST_FORWARD FOR
	 select branch,a.itemno,a.unicode,whno,binno,a.openbal,a.openlcost,a.openfcost,b.fcy,c.openlcost as mnopenlcost,
	 c.openfcost as mnopenfcost from stbins a inner join stunits c 
	 on a.itemno=c.itemno and a.unicode=c.unicode
	 inner join stitems b
	 on c.itemno=b.itemno 
	 order by itemno;
	
	 
  	 open crs0;

------------------------------------
		fetch next from crs0 into @lbranch,@litemno,@lunicode,@lwhno,@lbinno,@lopenbal,@lopenlcost,@lopenfcost,@lfcy,
		@lmnopenlcost,@lmnopenfcost;

 

		
		WHILE dbo.FetchStatusOfCursorNamed('crs0') = 0
        BEGIN
			set @stk_lcost=abs(@lopenlcost) -- modified on 2023-10-25 AA abs
			set @stk_fcost=abs(@lopenfcost) -- modified on 2023-10-25 AA abs
			set @lrunbal=@lopenbal
----------- Added on 2023-10-26 AA -------------------------------------
			if @lrunbal<=0 and @stk_lcost>0 and @lmnopenlcost>0
			if @lmnopenlcost<@stk_lcost 
			begin 
			   set @stk_lcost=@lmnopenlcost
			   set @stk_fcost=@lmnopenfcost
			end
------------------------------------------------------------------------			
			set @lastcost =0
			set @lastfcost =0
			set @trx_lastcost=0
			set @item_received=iif(@lrunbal>0 and @stk_lcost>0,1,0) -- Added on 2023-10-25 AA
----------- Stopped on 2023-05-31 AA --------------------------------------------
			--select top 1 @trsnfer_recs=b.ref from sthdr b inner join stdtl a
----------- Added on 2023-05-31 AA -----------------------------------------------
			select  @trsnfer_recs=count(*) from sthdr b inner join stdtl a
	    		on b.branch=a.branch and b.trtype=a.trtype and b.ref=a.ref  
			where a.branch=@lbranch and itemno=@litemno and unicode=@lunicode
			and a.whno=@lwhno and binno=@lbinno and  (a.trtype='09' and isbrtrx=1 );
			if isnull(@trsnfer_recs,0)>0
			begin
			    set @lcurfixrate=0
			    if len(@lfcy)>0 select @lcurfixrate=curfix from glcurr where curcode=@lfcy;

				DECLARE crs1 CURSOR LOCAL FAST_FORWARD FOR
				select a.branch,a.trtype,a.ref,a.folio,qty+fqty as qty,lcost,fcost,isbrtrx,posted,
				a.towhno,a.tobinno,fcyrate,a.trdate,tobrno,brxref,b.glref
				from sthdr b inner join stdtl a
	    		on b.branch=a.branch and b.trtype=a.trtype and b.ref=a.ref 
	    		where  a.branch=@lbranch and a.itemno=@litemno and a.unicode=@lunicode and a.whno=@lwhno and binno=@lbinno
				order by a.branch,a.trdate ,Iif(a.trtype in ('10','11','14') or (a.trtype='01' and isbrtrx=0) 
				,'01','02'),a.ref,folio;
				open crs1;

				fetch next from crs1 into @lbranch,@ltrtype,@lref,@lfolio,@lqty,@llcost,@lfcost,@lisbrtrx,@lposted,@ltowhno
				,@ltobinno,@lfcyrate,@ltrdate,@ltobrno,@lbrxref,@lglref; -- Added on 2022-12-21 AA @lglref
		        begin transaction
				WHILE dbo.FetchStatusOfCursorNamed('crs1') = 0
				BEGIN
					set @trxlcost=0
					set @trxfcost=0			    
					set @ttp=cast(@ltrtype as int)
					if @stk_lcost=0 and @llcost>0 set @trx_lastcost=@llcost -- Added on 2023-05-31 AA
					if @lposted=1
					begin
					   if @ttp in (4,6,9,30,31,2)
					   begin
						   set @lrunbal=@lrunbal-@lqty
						   --if @ttp<>9 and @stk_lcost=0 and @llcost>0 set @trx_lastcost=@llcost -- Stopped on 2023-05-31 AA
					   end
					   if @ttp in (5,24,26,13,12) or (@ttp=46 And @lqty<0) -- -Stopped on 2023-05-31 AA or (@ttp=1 and @lisbrtrx=1) 
					   begin
						   set @lrunbal=@lrunbal+@lqty
						   If @lqty>0 And @stk_lcost=0  -- Stopped on 2023-05-31 AA and not (@ttp=1 and @lisbrtrx=1) 
						   begin  
							 set @trx_lastcost=@llcost
							 --set @stk_fcost=@lfcost
						   end
						   --if  @stk_lcost=0 and @llcost>0 set @trx_lastcost=@llcost -- Stopped on 2023-05-31 AA
					   end
					   if @ttp in (1,10,11) or (@ttp=46 And @lqty>0) -- Added on 2023-05-31 AA
					   --if @ttp in (10,11) or (@ttp=46 And @lqty>0) or (@ttp=1 and @lisbrtrx=0) -- Stopped on 2023-05-31 AA
					   begin
					     set @item_received=1 --Added on 2023-10-25 AA
						  if @lrunbal>0
						  begin
							  -- added on 2018-04-04
						      if @stk_lcost>0
							  set @stk_lcost=Abs(((@stk_lcost*@lrunbal)+Abs(@lqty*@llcost))/(@lrunbal+@lqty))
							  else set @stk_lcost=@llcost

							  if isnull(@lfcost,0)<>0
							  begin 
								   if @stk_fcost>0
									  set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*@lfcost))/(@lrunbal+@lqty))
								   else set @stk_fcost=@lfcost
							  end
							  else 
							  if isnull(@lfcy,'')<>''
							  begin
								   if  isnull(@lfcyrate,0)>0
									 if @stk_fcost>0
									   set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*(@llcost/@lfcyrate)))/(@lrunbal+@lqty))
									 else set @stk_fcost=(@llcost/@lfcyrate)
								   else 
								   if isnull(@lcurfixrate,0)>0
										if @stk_fcost>0
										  set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*(@llcost/@lcurfixrate)))/(@lrunbal+@lqty))
										else set @stk_fcost=(@llcost/@lcurfixrate)
							  end
						  end
						  else
						  begin
								set @stk_lcost=@llcost
								if isnull(@lfcost,0)<>0  set @stk_fcost=@lfcost
								else if isnull(@lfcy,'')<>'' 
								begin
									if  isnull(@lfcyrate,0)>0 set @stk_fcost=@llcost/@lfcyrate
									else  if isnull(@lcurfixrate,0)>0 set @stk_fcost=@llcost/@lcurfixrate
								end
						  end
						  set @lrunbal=@lrunbal+@lqty
					   end

					   if @ttp=20
					   begin
						   if rtrim(@ltowhno)=''
						   begin
						     set @item_received=1 --Added on 2023-10-25 AA
							   if @stk_lcost=0
							   begin
								 set @stk_lcost=@llcost
								 set @stk_fcost=@lfcost
							   end
							   else
							   if @lrunbal>0
							   begin
								  -- added on 2018-04-04
								  if @stk_lcost>0
								  set @stk_lcost=Abs(((@stk_lcost*@lrunbal)+Abs(@lqty*@llcost))/(@lrunbal+@lqty))
								  else set @stk_lcost=@llcost
							   
								   if isnull(@lfcost,0)<>0 
									   if @stk_fcost>0
									   set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*@lfcost))/(@lrunbal+@lqty))
									   else set @stk_fcost=@lfcost
							   end
							   else
							   begin
								 set @stk_lcost=@llcost
								 set @stk_fcost=@lfcost
							   end
						   end
						   set @lrunbal = @lrunbal + Iif(rtrim(@ltowhno)<>'',-@lqty,@lqty)
					   end
					   if @ttp=14
					   begin
						   set @stk_lcost=@llcost
						   set @stk_fcost=@lfcost
						   set @item_received=1 --Added on 2023-10-25 AA
					   end
					end  -- end of @lposted

					if (@ttp=9 and @lisbrtrx=1 and @lglref=0) -- Added on 2022-12-21 AA @lglref=0
					begin
						--if @stk_lcost=0 
						if (@stk_lcost=0 or @item_received=0 )  -- Added on 2023-10-25 AA or @item_received=0 
						begin
							set @xdate=@ltrdate
							set @trxlcost=0
							Select top 1 @trxlcost=lcost,@trxfcost=fcost from sthdr b inner join stdtl a
	    					on b.branch=a.branch and b.trtype=a.trtype and b.ref=a.ref   
							where a.branch=@lbranch and itemno=@litemno and unicode=@lunicode and a.whno=@lwhno and binno=@lbinno
							and  (a.trtype in ('10','11','14') or (a.trtype='01' and isbrtrx=0) or (a.trtype='20' and rtrim(a.towhno)='')) 
							and a.trdate>=@ltrdate
							order by a.trdate,iif(a.trtype in ('01','10','11','20'),1,2),a.ref,folio;

							if isnull(@trxlcost,0)=0
							begin
								Select top 1 @trxlcost=lcost,@trxfcost=fcost from sthdr b inner join stdtl a
	    						on b.branch=a.branch and b.trtype=a.trtype and b.ref=a.ref   
								where a.branch=@lbranch and itemno=@litemno and unicode=@lunicode and a.whno=@lwhno 
								and  (a.trtype in ('10','11','14') or (a.trtype='01' and isbrtrx=0) or (a.trtype='20' and rtrim(a.towhno)='')) 
								order by a.trdate,iif(a.trtype in ('01','10','11','20'),1,2),a.ref,folio;
							end
							if isnull(@trxlcost,0)=0 --is null
							begin
								Select top 1 @trxlcost=lcost,@trxfcost=fcost from sthdr b inner join stdtl a
	    						on b.branch=a.branch and b.trtype=a.trtype and b.ref=a.ref   
								where a.branch=@lbranch and itemno=@litemno and unicode=@lunicode  
								and  (a.trtype in ('10','11','14') or (a.trtype='01' and isbrtrx=0) or (a.trtype='20' and rtrim(a.towhno)='')) and lcost>0
								order by a.trdate desc,iif(a.trtype in ('01','10','11','20'),1,2),a.ref,folio;
                            end
							if isnull(@trxlcost,0)=0 --is null
							begin
								Select top 1 @trxlcost=lcost,@trxfcost=fcost from sthdr b inner join stdtl a
	    						on b.branch=a.branch and b.trtype=a.trtype and b.ref=a.ref   
								where  itemno=@litemno and unicode=@lunicode  
								and  (a.trtype in ('10','11','14') or (a.trtype='01' and isbrtrx=0) or (a.trtype='20' and rtrim(a.towhno)='')) and lcost>0
								order by a.trdate desc,A.BRANCH,iif(a.trtype in ('01','10','11','20'),1,2),a.ref,folio;
                            end
							if isnull(@trxlcost,0)>0 --is null
							begin
								set @stk_lcost=isnull(@trxlcost,0)
								set @stk_fcost=isnull(@trxfcost,0)
							end

							if isnull(@stk_lcost,0)=0
							begin
							    set @trxlcost=0
								set @trxfcost=0
							    select @trxlcost=lastlcost,@trxfcost=lastfcost from stcosttype 
								where branch=@lbranch  and itemno=@litemno and unicode=@lunicode;
								if isnull(@trxlcost,0)=0
								begin
									select top 1 @trxlcost=lastlcost,@trxfcost=lastfcost from stcosttype 
									where  itemno=@litemno and unicode=@lunicode order by lstrcvdate desc,branch ;
								end
								if isnull(@trxlcost,0)>0 --is null
								begin
									set @stk_lcost=isnull(@trxlcost,0)
									set @stk_fcost=isnull(@trxfcost,0)
								end
							end

							if isnull(@stk_lcost,0)=0 and @lmnopenlcost>0 --is null
							begin
								set @stk_lcost=@lmnopenlcost
								set @stk_fcost=@lmnopenfcost
							end

							if isnull(@stk_lcost,0)=0 and @llcost>0
							begin
							   set @stk_lcost=@llcost
							   set @stk_fcost=@lfcost
							end
							if isnull(@stk_lcost,0)=0 and @trx_lastcost>0
							begin
							   set @stk_lcost=@trx_lastcost
						--	   set @stk_fcost=@lfcost
							end
							
						end -- end of @stk_lcost=0
					
					    --if (@ttp=9 and @lisbrtrx=1 )
						if (@ttp=9 and @lisbrtrx=1 and @lglref=0) -- Added on 2022-12-21 AA @lglref=0
						begin
							update stdtl set lcost = @stk_lcost,fcost=@stk_fcost where branch=@lbranch and trtype=@ltrtype and ref=@lref and folio=@lfolio
							if @@error<>0
							begin
								rollback transaction
								set @errstatus=-1
								break
							end
							if @lclient_is_shobra=0
							update stdtl set lcost = @stk_lcost,fcost=@stk_fcost where branch=@ltobrno and trtype='01' and ref=@lbrxref 
							and folio=@lfolio
							else 
							begin
							    set @l_ttlcost =0
								set @l_fcttlcost=0
                                set @l_item_count  =0
		                        set @l_pcslcost =@stk_lcost
								set @l_pcsfcost =@stk_fcost
								set @lttlqty =0
							    select @lttlqty=sum(qty),@l_ttlcost=sum(qty*lcost),@l_fcttlcost=sum(qty*fcost),
								@l_item_count=count(*) from stdtl where branch=@lbranch and trtype=@ltrtype and ref=@lref
								and itemno=@litemno and unicode=@lunicode group by branch,trtype,ref,itemno,unicode having count(*)>1;
								if isnull(@l_item_count,0)>1 and isnull(@lttlqty,0)>0
								begin
								   set @l_pcslcost = @l_ttlcost/@lttlqty
								   if @l_fcttlcost>0 set @l_pcsfcost = @l_fcttlcost/@lttlqty
								end
								update stdtl set lcost = @l_pcslcost,fcost=@l_pcsfcost where branch=@ltobrno and trtype='01' and ref=@lbrxref 
								and itemno=@litemno and unicode=@lunicode
							end
							if @@error<>0
							begin
								rollback transaction
								set @errstatus=-1
								break
							end							
						end				
					end	-- End of ttp=20			
					
					fetch next from crs1 into @lbranch, @ltrtype,@lref,@lfolio,@lqty,@llcost,@lfcost,@lisbrtrx,@lposted,@ltowhno
					,@ltobinno,@lfcyrate,@ltrdate,@ltobrno,@lbrxref,@lglref; -- Added on 2022-12-21 AA @lglref
				end  -- end of crs1 inner loop
				CLOSE crs1
				DEALLOCATE crs1
				if @errstatus=-1 
				begin
				   break;
				end
			    else commit transaction
			end   --- end of @transfer_recs
			fetch next from crs0 into @lbranch,@litemno,@lunicode,@lwhno,@lbinno,@lopenbal,@lopenlcost,@lopenfcost,@lfcy,
			@lmnopenlcost,@lmnopenfcost;
		end  -- end of crs0 ourter loop
		CLOSE crs0;
        DEALLOCATE crs0;
		if @errstatus=-1 
		begin
		   if @@TRANCOUNT>0   rollback transaction
--			return @errstatus
	    end
		else if @@TRANCOUNT>0 commit transaction
			
		return @errstatus	
end


GO
/****** Object:  StoredProcedure [dbo].[bld_cost_4_all_transfers]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-01-07@@$$##  Important : must have this line as first line which contains the last update date for the this file
CREATE PROCEDURE [dbo].[bld_cost_4_all_transfers]
 @errstatus int = 0 output
AS
BEGIN
------ 2023-10-26 AA Force to select the proper openlcost for each binno at beginning
------ 2023-10-25 AA Even the @stk_lcost>0 put openbal<=0 , now forcing to search for any purchase for the item
------ 2023-10-25 AA Added new variable @item_received to track if the item already has received qty & has lcost
------ 2023-10-25 AA enhenced the search for lcost when stk_lcost=0
------ 2023-08-16 AA convert numeric(6,0) to int for @lref & @lglref
------ Added on 2023-05-28 AA used @trsnfer_recs=count(*) instead of top 1 @trsnfer_recs=ref
------ Added on 2023-05-28 AA used @no_transactions=count(*) instead of top 1 @no_transactions=ref
------ Added on 2022-05-23 AA to check if there is no transfer transactions then return
------ Added on 2022-05-23 AA stop creating index xx100xxtemp
------ Added on 2022-05-23 AA semi colons are added to the end of eash select statements
------ Added on 2022-05-23 AA Fixed the bug of converting float to numeric(20,12)
	SET NOCOUNT ON
-- 
-- This section is used to addup new entries for stbins
--

declare @lcurbal float ,
        @lrunbal float,
        @inbal float,
        @lopenbal float,
		@llprice float,
		@llcost float,
		@lfcost float,
		@lopenlcost float,
		@lopenfcost float,
		@trxlcost float,
		@trxfcost float,
		@trxqty float,
		@lbranch char(2),
        @litemno char(16),
		@lunicode char(6) ,
		@lwhno char(2) ,
		@lbinno char(6),
		@lttlqty float=0,
		@lmnopenlcost float,
		@stk_lcost float,
		@costchg int=0,
		@lastcost float,
		@lastfcost float=0,
		@stk_fcost float,
		@lmnopenfcost float,
		@trsnfer_recs int=0
		



---
---   Prepair for deletion and updating to openbal vaalues
---
      
		
	
	
		--commit transaction

-----------------------------------------------------------------------------------------------
--  Building stbins items qty balances & cost
--
     declare @ltrtype char(2),
	         @ltrdate char(8),
	         @lref int,
			 @lqty float,
			 @lfolio int,
			 @lisbrtrx bit,
			 @lposted bit,
			 @ltowhno char(2),
			 @ltobinno char(6),
			 @lfcy char(3),
			 @lfcyrate numeric(10,5),
			 @ttp int,
			 @dont_check_cost int=0,
			 @xdate char(8),
			 @lcurfixrate float =0,
			 @item_received bit =0 -- Added on 2023-10-25 AA 

------------- Added on 2021-06-22 AA ------------------------
   declare @lprocessed bit =0;

	
-----------------------------------------------------------

     set @errstatus=0;
---- Added on 2022-05-23 AA ------------------------------------
    declare @no_transactions int 
	set @no_transactions=0
---- Stopped on 2023-05-28 AA -------------------------------------
---- select top 1 @no_transactions=ref from sthdr where trtype='20'
---- Added on 2023-05-28 AA -------------------------------------
    select @no_transactions=count(*) from sthdr where trtype='20';
	if isnull(@no_transactions,0)=0 return @errstatus
--------------------------------------------------------------------

     DECLARE crs0 CURSOR LOCAL FAST_FORWARD FOR
	 select branch,a.itemno,a.unicode,whno,binno,a.openbal,a.openlcost,a.openfcost,b.fcy,c.openlcost as mnopenlcost,
	 c.openfcost as mnopenfcost from stbins a inner join stunits c 
	 on a.itemno=c.itemno and a.unicode=c.unicode
	 inner join stitems b
	 on c.itemno=b.itemno 
	 order by itemno;
	
	 
  	 open crs0;

------------------------------------
		fetch next from crs0 into @lbranch,@litemno,@lunicode,@lwhno,@lbinno,@lopenbal,@lopenlcost,@lopenfcost,@lfcy,
		@lmnopenlcost,@lmnopenfcost;

 

		
		WHILE dbo.FetchStatusOfCursorNamed('crs0') = 0
        BEGIN

			set @stk_lcost=abs(@lopenlcost) -- modified on 2023-10-25 AA abs
			set @stk_fcost=abs(@lopenfcost) -- modified on 2023-10-25 AA abs
			set @lrunbal=@lopenbal
----------- Added on 2023-10-26 AA -------------------------------------
			if @lrunbal<=0 and @stk_lcost>0 and @lmnopenlcost>0
			if @lmnopenlcost<@stk_lcost 
			begin 
			   set @stk_lcost=@lmnopenlcost
			   set @stk_fcost=@lmnopenfcost
			end
------------------------------------------------------------------------			
			set @lastcost =0
			set @lastfcost =0
			set @item_received=iif(@lrunbal>0 and @stk_lcost>0,1,0) -- Added on 2023-10-25 AA 
			-- Stopped on 2023-05-28 AA ------------------------------------------------------------------------------
			--select top 1 @trsnfer_recs=ref from stdtl where branch=@lbranch and itemno=@litemno and unicode=@lunicode
			-- Added on 2023-05-28 AA ------------------------------------------------------------------------------
			select  @trsnfer_recs=count(*) from stdtl where branch=@lbranch and itemno=@litemno and unicode=@lunicode
			and whno=@lwhno and binno=@lbinno and trtype='20' and rtrim(towhno)<>'';
			if isnull(@trsnfer_recs,0)>0
			begin
			    set @lcurfixrate=0
			    if len(@lfcy)>0 select @lcurfixrate=curfix from glcurr where curcode=@lfcy;

				DECLARE crs1 CURSOR LOCAL FAST_FORWARD FOR
				select a.branch,a.trtype,a.ref,a.folio,qty+fqty as qty,lcost,fcost,isbrtrx,posted,
				a.towhno,a.tobinno,fcyrate,a.trdate,a.rplct_post
				from sthdr b inner join stdtl a
	    		on b.branch=a.branch and b.trtype=a.trtype and b.ref=a.ref 
	    		where  a.itemno=@litemno and a.unicode=@lunicode and a.whno=@lwhno and binno=@lbinno
				--and not (a.trtype='20' and rtrim(a.towhno)='') && omitted on 2021-06-22 AA
				order by a.branch,a.trdate ,Iif(a.trtype in ('10','11','01','14') or (a.trtype='20' and len(a.towhno)=0)
				,'01','02'),a.ref,folio;
				open crs1;

				fetch next from crs1 into @lbranch,@ltrtype,@lref,@lfolio,@lqty,@llcost,@lfcost,@lisbrtrx,@lposted,@ltowhno
				,@ltobinno,@lfcyrate,@ltrdate,@lprocessed;
		        begin transaction
				WHILE dbo.FetchStatusOfCursorNamed('crs1') = 0
				BEGIN
					set @trxlcost=0
					set @trxfcost=0			    
					set @ttp=cast(@ltrtype as int)
					if @lposted=1
					begin
					   if @ttp in (4,6,9,30,31,2)
					   begin
						   set @lrunbal=@lrunbal-@lqty
					   end
					   if @ttp in (5,24,26,13,12) or (@ttp=46 And @lqty<0)  
					   begin
						   set @lrunbal=@lrunbal+@lqty
						  -- If @lqty>0 And @stk_lcost=0 
						  -- begin  
							 --set @stk_lcost=@llcost
							 --set @stk_fcost=@lfcost
						  -- end
					   end
					   if @ttp in (1,10,11) or (@ttp=46 And @lqty>0) 
					   begin
					    set @item_received=1 --Added on 2023-10-25 AA
						  if @lrunbal>0
						  begin
							  -- added on 2018-04-04
						      if @stk_lcost>0
							  set @stk_lcost=Abs(((@stk_lcost*@lrunbal)+Abs(@lqty*@llcost))/(@lrunbal+@lqty))
							  else set @stk_lcost=@llcost

							  if isnull(@lfcost,0)<>0
							  begin 
								   if @stk_fcost>0
									  set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*@lfcost))/(@lrunbal+@lqty))
								   else set @stk_fcost=@lfcost
							  end
							  else 
							  if isnull(@lfcy,'')<>''
							  begin
								   if  isnull(@lfcyrate,0)>0
									 if @stk_fcost>0
									   set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*(@llcost/@lfcyrate)))/(@lrunbal+@lqty))
									 else set @stk_fcost=(@llcost/@lfcyrate)
								   else 
								   if isnull(@lcurfixrate,0)>0
										if @stk_fcost>0
										  set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*(@llcost/@lcurfixrate)))/(@lrunbal+@lqty))
										else set @stk_fcost=(@llcost/@lcurfixrate)
							  end
						  end
						  else
						  begin
								set @stk_lcost=@llcost
								if isnull(@lfcost,0)<>0  set @stk_fcost=@lfcost
								else if isnull(@lfcy,'')<>'' 
								begin
									if  isnull(@lfcyrate,0)>0 set @stk_fcost=@llcost/@lfcyrate
									else  if isnull(@lcurfixrate,0)>0 set @stk_fcost=@llcost/@lcurfixrate
								end
						  end
						  set @lrunbal=@lrunbal+@lqty
					   end

					   if @ttp=20
					   begin
------------------- Added on 2021-06-22 AA ------------------------
					       if len(@ltowhno)=0 and @lprocessed=1
						   begin
						      set @item_received=1 --Added on 2023-10-25 AA
						      if @lrunbal>0
							  begin
								  if @stk_lcost>0 
								  set @stk_lcost=Abs(((@stk_lcost*@lrunbal)+Abs(@lqty*@llcost))/(@lrunbal+@lqty))
								  else set @stk_lcost=@llcost
								  if isnull(@lfcost,0)<>0
								  begin 
									   if @stk_fcost>0
										  set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*@lfcost))/(@lrunbal+@lqty))
									   else set @stk_fcost=@lfcost
								  end
								  else
								  if isnull(@lfcy,'')<>''
								  begin
									   if  isnull(@lfcyrate,0)>0
										 if @stk_fcost>0
										   set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*(@llcost/@lfcyrate)))/(@lrunbal+@lqty))
										 else set @stk_fcost=(@llcost/@lfcyrate)
									   else 
									   if isnull(@lcurfixrate,0)>0
											if @stk_fcost>0
											  set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*(@llcost/@lcurfixrate)))/(@lrunbal+@lqty))
											else set @stk_fcost=(@llcost/@lcurfixrate)
								  end
							  end
							  else
							  begin 
									set @stk_lcost=@llcost
									if isnull(@lfcost,0)<>0  set @stk_fcost=@lfcost
									else if isnull(@lfcy,'')<>'' 
									begin
										if  isnull(@lfcyrate,0)>0 set @stk_fcost=@llcost/@lfcyrate
										else  if isnull(@lcurfixrate,0)>0 set @stk_fcost=@llcost/@lcurfixrate
									end
							  end
						   end
---------------------------------------------------------------------
						   set @lrunbal = @lrunbal + Iif(rtrim(@ltowhno)<>'',-@lqty,@lqty)
					   end
					   if @ttp=14
					   begin
						   set @stk_lcost=@llcost
						   set @stk_fcost=@lfcost
						   set @item_received=1 --Added on 2023-10-25 AA
					   end
					end  -- end of @lposted
					if @ttp=20 and len(@ltowhno)>0
					begin
						--if @stk_lcost=0 
						if (@stk_lcost=0 or @item_received=0 )  -- Added on 2023-10-25 AA or @item_received=0 
						begin
							set @xdate=@ltrdate
							set @trxlcost=0
							Select top 1 @trxlcost=lcost,@trxfcost=fcost From stdtl where
							branch=@lbranch and itemno=@litemno and unicode=@lunicode and whno=@lwhno and binno=@lbinno
							and  trtype in ('10','11','01','14') --and trdate>=@ltrdate
							order by trdate,iif(trtype in ('01','10','11'),1,2),stdtl.ref,folio;

							if isnull(@trxlcost,0)=0
							begin
							     
								Select top 1 @trxlcost=lcost,@trxfcost=fcost From stdtl where
								branch=@lbranch and itemno=@litemno and unicode=@lunicode and  whno=@lwhno
								and  trtype in ('10','11','01','14') --and lcost>0								 
								order by trdate,iif(trtype in ('01','10','11'),1,2),stdtl.ref,folio;
							end
							if isnull(@trxlcost,0)=0 --is null
							begin
								Select top 1 @trxlcost=lcost,@trxfcost=fcost From stdtl where
								branch=@lbranch and itemno=@litemno and unicode=@lunicode 
								and  trtype in ('10','11','01','14') --AND lcost>0								 
								order by trdate ,iif(trtype in ('01','10','11'),1,2),stdtl.ref,folio;
							end
							if isnull(@trxlcost,0)=0 --is null
							begin
								Select top 1 @trxlcost=lcost,@trxfcost=fcost From stdtl where
								itemno=@litemno and unicode=@lunicode 
								and  trtype in ('10','11','01','14') --AND lcost>0								 
								order by trdate ,branch,iif(trtype in ('01','10','11'),1,2),stdtl.ref,folio;
							end
							if isnull(@trxlcost,0)>0 --is null
							begin
								set @stk_lcost=isnull(@trxlcost,0)
								set @stk_fcost=isnull(@trxfcost,0)
							end


							if isnull(@stk_lcost,0)=0
							begin
							    set @trxlcost=0
								set @trxfcost=0
							    select @trxlcost=lastlcost,@trxfcost=lastfcost from stcosttype 
								where branch=@lbranch  and itemno=@litemno and unicode=@lunicode;
								if isnull(@trxlcost,0)=0
								begin
									select top 1 @trxlcost=lastlcost,@trxfcost=lastfcost from stcosttype 
									where  itemno=@litemno and unicode=@lunicode order by lstrcvdate desc,branch ;
								end
								if isnull(@trxlcost,0)>0 --is null
								begin
									set @stk_lcost=isnull(@trxlcost,0)
									set @stk_fcost=isnull(@trxfcost,0)
								end
							end

							if isnull(@stk_lcost,0)=0 and @lmnopenlcost>0 --is null
							begin
								set @stk_lcost=@lmnopenlcost
								set @stk_fcost=@lmnopenfcost
							end

							if isnull(@stk_lcost,0)=0
							begin
							   set @stk_lcost=@llcost
							   set @stk_fcost=@lfcost
							end
						end -- end of @stk_lcost=0	
										
						update stdtl set lcost = @stk_lcost,fcost=@stk_fcost where branch=@lbranch and trtype=@ltrtype and ref=@lref and folio=@lfolio
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-1
							break
						end
						update stdtl set lcost = @stk_lcost,fcost=@stk_fcost,rplct_post =1 where branch=@lbranch and trtype=@ltrtype and ref=@lref 
						and itemno=@litemno and unicode=@lunicode and whno=@ltowhno and binno=@ltobinno
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-1
							break
						end
					end  -- End of @ttp=20

					fetch next from crs1 into @lbranch, @ltrtype,@lref,@lfolio,@lqty,@llcost,@lfcost,@lisbrtrx,@lposted,@ltowhno
					,@ltobinno,@lfcyrate,@ltrdate,@lprocessed;
				end  -- end of crs1 inner loop
				CLOSE crs1
				DEALLOCATE crs1
				if @errstatus=-1 
				begin
				   break;
				end
			    else commit transaction
			end   --- end of @transfer_recs
			fetch next from crs0 into @lbranch,@litemno,@lunicode,@lwhno,@lbinno,@lopenbal,@lopenlcost,@lopenfcost,@lfcy,
			@lmnopenlcost,@lmnopenfcost;
		end  -- end of crs0 ourter loop
		CLOSE crs0;
        DEALLOCATE crs0;
		if @errstatus=0
		begin
		    begin transaction
			update sthdr set costttl=ttlcost
			from sthdr t
			join
			(select branch,trtype,ref,ttlcost=sum(qty*lcost)  from stdtl where 
			trtype='20' and len(stdtl.towhno)>0 group by branch,trtype,ref) c
			on t.branch=c.branch and t.trtype=c.trtype and t.ref=c.ref
			where t.trtype='20'	;
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-1
			end	
			else  commit transaction			
		end 
		if @errstatus=-1 
		begin
		   if @@TRANCOUNT>0   rollback transaction
			return @errstatus
	    end
		else if @@TRANCOUNT>0 commit transaction
			
		return @errstatus	
end


GO
/****** Object:  StoredProcedure [dbo].[bld_cost_4_all_transfersxx]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[bld_cost_4_all_transfersxx]
 @errstatus int = 0 output
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
-- 
-- This section is used to addup new entries for stbins
--

declare @lcurbal numeric(12,3) ,
        @lrunbal numeric(12,3),
        @inbal numeric(12,3),
        @lopenbal numeric(12,3),
		@llprice numeric (12,3),
		@llcost float,
		@lfcost float,
		@lopenlcost float,
		@lopenfcost float,
		@trxlcost float,
		@trxfcost float,
		@trxqty numeric(13,3),
		@lbranch char(2),
        @litemno char(16),
		@lunicode char(6) ,
		@lwhno char(2) ,
		@lbinno char(6),
		@lttlqty numeric(13,3)=0,
		@lmnopenlcost float,
		@stk_lcost float,
		@costchg int=0,
		@lastcost float,
		@lastfcost float=0,
		@stk_fcost float,
		@lmnopenfcost float,
		@trsnfer_recs int=0
		



---
---   Prepair for deletion and updating to openbal vaalues
---
      
		
	
	
		--commit transaction

-----------------------------------------------------------------------------------------------
--  Building stbins items qty balances & cost
--
     declare @ltrtype char(2),
	         @ltrdate char(8),
	         @lref numeric(6,0),
			 @lqty numeric (15,4),
			 @lfolio int,
			 @lisbrtrx bit,
			 @lposted bit,
			 @ltowhno char(2),
			 @ltobinno char(6),
			 @lfcy char(3),
			 @lfcyrate numeric(10,5),
			 @ttp int,
			 @dont_check_cost int=0,
			 @xdate char(8),
			 @lcurfixrate float =0,
			 @ltobrno char(2)='',
			 @lbrxref int =0;
			 
declare 
	@dbc nvarchar(14),
	@lcalcomp char(2),
	@yrcode char(4),
	@lbrxautojv bit=0
	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)

	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @lbrxautojv=isnull(brxautojv,0)  from sysdb.dbo.glcalend 
	       where calcomp=@lcalcomp and yrcode=@yrcode
    set @lbrxautojv=isnull(@lbrxautojv,0)
---------------------------------------------------------------------


     set @errstatus=0;
     DECLARE crs0 CURSOR LOCAL FAST_FORWARD FOR
	 select branch,a.itemno,a.unicode,whno,binno,a.openbal,a.openlcost,a.openfcost,b.fcy,c.openlcost as mnopenlcost,
	 c.openfcost as mnopenfcost from stbins a inner join stunits c 
	 on a.itemno=c.itemno and a.unicode=c.unicode
	 inner join stitems b
	 on c.itemno=b.itemno 
	 order by itemno;
	
	 
  	 open crs0;

------------------------------------
		fetch next from crs0 into @lbranch,@litemno,@lunicode,@lwhno,@lbinno,@lopenbal,@lopenlcost,@lopenfcost,@lfcy,
		@lmnopenlcost,@lmnopenfcost;

 

		
		WHILE dbo.FetchStatusOfCursorNamed('crs0') = 0
        BEGIN

			set @stk_lcost=@lopenlcost
			set @stk_fcost=@lopenfcost
			set @lrunbal=@lopenbal
			set @lastcost =0
			set @lastfcost =0
			select top 1 @trsnfer_recs=b.ref from sthdr b inner join stdtl a
	    		on b.branch=a.branch and b.trtype=a.trtype and b.ref=a.ref  
			where a.branch=@lbranch and itemno=@litemno and unicode=@lunicode
			and a.whno=@lwhno and binno=@lbinno and ((a.trtype='20' and rtrim(a.towhno)<>'') or (a.trtype='09' and isbrtrx=1 and @lbrxautojv=0))
			if isnull(@trsnfer_recs,0)>0
			begin
			    set @lcurfixrate=0
			    if len(@lfcy)>0 select @lcurfixrate=curfix from glcurr where curcode=@lfcy

				DECLARE crs1 CURSOR LOCAL FAST_FORWARD FOR
				select a.branch,a.trtype,a.ref,a.folio,qty+fqty as qty,lcost,fcost,isbrtrx,posted,
				a.towhno,a.tobinno,fcyrate,a.trdate,tobrno,brxref
				from sthdr b inner join stdtl a
	    		on b.branch=a.branch and b.trtype=a.trtype and b.ref=a.ref 
	    		where  a.itemno=@litemno and a.unicode=@lunicode and a.whno=@lwhno and binno=@lbinno				
				order by a.branch,a.trdate ,Iif(a.trtype in ('10','11','01','14') 
				,'01','02'),a.ref,folio
				open crs1;
--and not ((a.trtype='20' and rtrim(a.towhno)='') or (a.trtype='01' and isbrtrx=1))
				fetch next from crs1 into @lbranch,@ltrtype,@lref,@lfolio,@lqty,@llcost,@lfcost,@lisbrtrx,@lposted,@ltowhno
				,@ltobinno,@lfcyrate,@ltrdate,@ltobrno,@lbrxref;
		        begin transaction
				WHILE dbo.FetchStatusOfCursorNamed('crs1') = 0
				BEGIN
					set @trxlcost=0
					set @trxfcost=0			    
					set @ttp=cast(@ltrtype as int)
					if @lposted=1
					begin
					   if @ttp in (4,6,9,30,31,2)
					   begin
						   set @lrunbal=@lrunbal-@lqty
					   end
					   if @ttp in (5,24,26,13,12) or (@ttp=46 And @lqty<0) or (@ttp=1 and @lisbrtrx=1) 
					   begin
						   set @lrunbal=@lrunbal+@lqty
						   If @lqty>0 And @stk_lcost=0 and not (@ttp='01' and @lisbrtrx=1) 
						   begin  
							 set @stk_lcost=@llcost
							 set @stk_fcost=@lfcost
						   end
					   end
					   if @ttp in (10,11) or (@ttp=46 And @lqty>0) or (@ttp=1 and @lisbrtrx=0) 
					   begin
						  if @lrunbal>0
						  begin
							  set @stk_lcost=Abs(((@stk_lcost*@lrunbal)+Abs(@lqty*@llcost))/(@lrunbal+@lqty))

							  if isnull(@lfcost,0)<>0
							  begin 
								   if @stk_fcost>0
									  set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*@lfcost))/(@lrunbal+@lqty))
								   else set @stk_fcost=@lfcost
							  end
							  else 
							  if isnull(@lfcy,'')<>''
							  begin
								   if  isnull(@lfcyrate,0)>0
									 if @stk_fcost>0
									   set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*(@llcost/@lfcyrate)))/(@lrunbal+@lqty))
									 else set @stk_fcost=(@llcost/@lfcyrate)
								   else 
								   if isnull(@lcurfixrate,0)>0
										if @stk_fcost>0
										  set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*(@llcost/@lcurfixrate)))/(@lrunbal+@lqty))
										else set @stk_fcost=(@llcost/@lcurfixrate)
							  end
						  end
						  else
						  begin
								set @stk_lcost=@llcost
								if isnull(@lfcost,0)<>0  set @stk_fcost=@lfcost
								else if isnull(@lfcy,'')<>'' 
								begin
									if  isnull(@lfcyrate,0)>0 set @stk_fcost=@llcost/@lfcyrate
									else  if isnull(@lcurfixrate,0)>0 set @stk_fcost=@llcost/@lcurfixrate
								end
						  end
						  set @lrunbal=@lrunbal+@lqty
					   end

					   if @ttp=20
					   begin
						   set @lrunbal = @lrunbal + Iif(rtrim(@ltowhno)<>'',-@lqty,@lqty)
					   end
					   if @ttp=14
					   begin
						   set @stk_lcost=@llcost
						   set @stk_fcost=@lfcost
					   end
					end  -- end of @lposted

					if (@ttp=20 and len(rtrim(@ltowhno))>0) or (@ttp=9 and @lisbrtrx=1 and @lbrxautojv=0)
					begin
						if @stk_lcost=0 
						begin
							set @xdate=@ltrdate
							set @trxlcost=0
							Select top 1 @trxlcost=lcost,@trxfcost=fcost from sthdr b inner join stdtl a
	    					on b.branch=a.branch and b.trtype=a.trtype and b.ref=a.ref   
							where a.branch=@lbranch and itemno=@litemno and unicode=@lunicode and a.whno=@lwhno and binno=@lbinno
							and  (a.trtype in ('10','11','14') or (a.trtype='01' and isbrtrx=0)) and a.trdate>=@ltrdate
							order by a.trdate,iif(a.trtype in ('01','10','11'),1,2),a.ref,folio

							if isnull(@trxlcost,0)=0
							begin
								Select top 1 @trxlcost=lcost,@trxfcost=fcost from sthdr b inner join stdtl a
	    						on b.branch=a.branch and b.trtype=a.trtype and b.ref=a.ref   
								where a.branch=@lbranch and itemno=@litemno and unicode=@lunicode and a.whno=@lwhno 
								and  (a.trtype in ('10','11','14') or (a.trtype='01' and isbrtrx=0)) 
								order by a.trdate,iif(a.trtype in ('01','10','11'),1,2),a.ref,folio
							end
							if isnull(@trxlcost,0)=0 --is null
							begin
								Select top 1 @trxlcost=lcost,@trxfcost=fcost from sthdr b inner join stdtl a
	    						on b.branch=a.branch and b.trtype=a.trtype and b.ref=a.ref   
								where a.branch=@lbranch and itemno=@litemno and unicode=@lunicode  
								and  (a.trtype in ('10','11','14') or (a.trtype='01' and isbrtrx=0)) 
								order by a.trdate,iif(a.trtype in ('01','10','11'),1,2),a.ref,folio

								if isnull(@trxlcost,0)=0 --is null
								begin
									set @stk_lcost=@lmnopenlcost
									set @stk_fcost=@lmnopenfcost
								end
							end
							else
							begin
								set @stk_lcost=@trxlcost
								set @stk_fcost=isnull(@trxfcost,0)
							end
						end -- end of @stk_lcost=0
					
					    if @ttp=20
						begin
							update stdtl set lcost = @stk_lcost,fcost=@stk_fcost where branch=@lbranch and trtype=@ltrtype and ref=@lref and folio=@lfolio
							if @@error<>0
							begin
								rollback transaction
								set @errstatus=-1
								break
							end
							update stdtl set lcost = @stk_lcost,fcost=@stk_fcost where branch=@lbranch and trtype=@ltrtype and ref=@lref and folio=@lfolio+1
							--and itemno=@litemno and unicode=@lunicode and whno=@ltowhno and binno=@ltobinno
							if @@error<>0
							begin
								rollback transaction
								set @errstatus=-1
								break
							end	
						end	
						else 
						begin
							update stdtl set lcost = @stk_lcost,fcost=@stk_fcost where branch=@lbranch and trtype=@ltrtype and ref=@lref and folio=@lfolio
							if @@error<>0
							begin
								rollback transaction
								set @errstatus=-1
								break
							end
							update stdtl set lcost = @stk_lcost,fcost=@stk_fcost where branch=@ltobrno and trtype='01' and ref=@lbrxref 
							and folio=@lfolio
							if @@error<>0
							begin
								rollback transaction
								set @errstatus=-1
								break
							end							
						end				
					end	-- End of ttp=20			
					
					fetch next from crs1 into @lbranch, @ltrtype,@lref,@lfolio,@lqty,@llcost,@lfcost,@lisbrtrx,@lposted,@ltowhno
					,@ltobinno,@lfcyrate,@ltrdate,@ltobrno,@lbrxref;
				end  -- end of crs1 inner loop
				CLOSE crs1
				DEALLOCATE crs1
				if @errstatus=-1 
				begin
				   break;
				end
			    else commit transaction
			end   --- end of @transfer_recs
			fetch next from crs0 into @lbranch,@litemno,@lunicode,@lwhno,@lbinno,@lopenbal,@lopenlcost,@lopenfcost,@lfcy,
			@lmnopenlcost,@lmnopenfcost;
		end  -- end of crs0 ourter loop
		CLOSE crs0;
        DEALLOCATE crs0;
		if @errstatus=-1 
		begin
		   if @@TRANCOUNT>0   rollback transaction
			return @errstatus
	    end
		else if @@TRANCOUNT>0 commit transaction	
		return @errstatus	
end











GO
/****** Object:  StoredProcedure [dbo].[bld_cost_transfers_4_one_trx]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[bld_cost_transfers_4_one_trx]
 @m_cmp char(2),
 @m_type char(2),
 @m_ref  numeric(6,0), 
 @errstatus int = 0 output
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
-- 
-- This section is used to addup new entries for stbins
--

declare @lcurbal numeric(12,3) ,
        @lrunbal numeric(12,3),
        @inbal numeric(12,3),
        @lopenbal numeric(12,3),
		@llprice numeric (12,3),
		@llcost float,
		@lfcost float,
		@lopenlcost float,
		@lopenfcost float,
		@trxlcost float,
		@trxfcost float,
		@trxqty numeric(13,3),
		@lbranch char(2),
        @litemno char(16),
		@lunicode char(6) ,
		@lwhno char(2) ,
		@lbinno char(6),
		@lttlqty numeric(13,3)=0,
		@lmnopenlcost float,
		@stk_lcost float,
		@costchg int=0,
		@lastcost float,
		@stk_fcost float,
		@lmnopenfcost float,
		@trsnfer_recs int=0,
	    @lcurfixrate float =0;
		



---
---   Prepair for deletion and updating to openbal vaalues
---
      
		
	
	
		--commit transaction

-----------------------------------------------------------------------------------------------
--  Building stbins items qty balances & cost
--
     declare @ltrtype char(2),
	         @ltrdate char(8),
	         @lref numeric(6,0),
			 @lqty numeric (15,4),
			 @lfolio int,
			 @lisbrtrx bit,
			 @lposted bit,
			 @ltowhno char(2),
			 @ltobinno char(6),
			 @lfcy char(3),
			 @lfcyrate numeric(10,5),
			 @ttp int,
			 @dont_check_cost int=0,
			 @xdate char(8);
     set @errstatus=0;
     DECLARE crs0 CURSOR LOCAL FAST_FORWARD FOR
	 select branch,a.itemno,a.unicode,whno,binno,a.openbal,a.openlcost,a.openfcost,b.fcy,c.openlcost as mnopenlcost,
	 c.openfcost as mnopenfcost from stbins a inner join stunits c 
	 on a.itemno=c.itemno and a.unicode=c.unicode
	 inner join stitems b
	 on c.itemno=b.itemno 
	 where exists(select distinct itemno from stdtl k
		where c.itemno=k.itemno and c.unicode=k.unicode 
		and k.branch=@m_cmp and k.trtype=@m_type and k.ref=@m_ref)
	 order by itemno;
	
	 
  	 open crs0;

------------------------------------
		fetch next from crs0 into @lbranch,@litemno,@lunicode,@lwhno,@lbinno,@lopenbal,@lopenlcost,@lopenfcost,@lfcy,
		@lmnopenlcost,@lmnopenfcost;

 

		
		WHILE dbo.FetchStatusOfCursorNamed('crs0') = 0
        BEGIN

			set @stk_lcost=@lopenlcost
			set @stk_fcost=@lopenfcost

			select top 1 @trsnfer_recs=ref from stdtl where branch=@lbranch and itemno=@litemno and unicode=@lunicode
			and whno=@lwhno and binno=@lbinno and trtype='20' and rtrim(towhno)<>''
			if isnull(@trsnfer_recs,0)>0
			begin
			    set @lcurfixrate=0
			    if len(@lfcy)>0 select @lcurfixrate=curfix from glcurr where curcode=@lfcy

				DECLARE crs1 CURSOR LOCAL FAST_FORWARD FOR
				select a.branch,a.trtype,a.ref,a.folio,qty+fqty as qty,lcost,fcost,isbrtrx,posted,
				a.towhno,a.tobinno,fcyrate,a.trdate
				from sthdr b inner join stdtl a
	    		on b.branch=a.branch and b.trtype=a.trtype and b.ref=a.ref 
	    		where  a.itemno=@litemno and a.unicode=@lunicode and a.whno=@lwhno and binno=@lbinno
				order by a.branch,a.trdate ,Iif(a.trtype in ('10','11','01','14') 
				,'01','02'),a.ref,folio
				open crs1;

				fetch next from crs1 into @lbranch,@ltrtype,@lref,@lfolio,@lqty,@llcost,@lfcost,@lisbrtrx,@lposted,@ltowhno
				,@ltobinno,@lfcyrate,@ltrdate;
		        begin transaction
				WHILE dbo.FetchStatusOfCursorNamed('crs1') = 0
				BEGIN
					set @trxlcost=0
					set @trxfcost=0			    
					set @ttp=cast(@ltrtype as int)

					if @lposted=1
					begin
					   if @ttp in (4,6,9,30,31,2)
					   begin
						   set @lrunbal=@lrunbal-@lqty
					   end
					   if @ttp in (5,24,26,13,12) or (@ttp=46 And @lqty<0)  
					   begin
						   set @lrunbal=@lrunbal+@lqty
						  -- If @lqty>0 And @stk_lcost=0 
						  -- begin  
							 --set @stk_lcost=@llcost
							 --set @stk_fcost=@lfcost
						  -- end
					   end
					   if @ttp in (1,10,11) or (@ttp=46 And @lqty>0) 
					   begin
						  if @lrunbal>0
						  begin
							  -- added on 2018-04-04
						      if @stk_lcost>0
							  set @stk_lcost=Abs(((@stk_lcost*@lrunbal)+Abs(@lqty*@llcost))/(@lrunbal+@lqty))
							  else set @stk_lcost=@llcost

							  if isnull(@lfcost,0)<>0
							  begin 
								   if @stk_fcost>0
									  set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*@lfcost))/(@lrunbal+@lqty))
								   else set @stk_fcost=@lfcost
							  end
							  else 
							  if isnull(@lfcy,'')<>''
							  begin
								   if  isnull(@lfcyrate,0)>0
									 if @stk_fcost>0
									   set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*(@llcost/@lfcyrate)))/(@lrunbal+@lqty))
									 else set @stk_fcost=(@llcost/@lfcyrate)
								   else 
								   if isnull(@lcurfixrate,0)>0
										if @stk_fcost>0
										  set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*(@llcost/@lcurfixrate)))/(@lrunbal+@lqty))
										else set @stk_fcost=(@llcost/@lcurfixrate)
							  end
						  end
						  else
						  begin
								set @stk_lcost=@llcost
								if isnull(@lfcost,0)<>0  set @stk_fcost=@lfcost
								else if isnull(@lfcy,'')<>'' 
								begin
									if  isnull(@lfcyrate,0)>0 set @stk_fcost=@llcost/@lfcyrate
									else  if isnull(@lcurfixrate,0)>0 set @stk_fcost=@llcost/@lcurfixrate
								end
						  end
						  set @lrunbal=@lrunbal+@lqty
					   end
					   if @ttp=20
					   begin
						   set @lrunbal = @lrunbal + Iif(rtrim(@ltowhno)<>'',-@lqty,@lqty)
					   end
					   if @ttp=14
					   begin
						   set @stk_lcost=@llcost
						   set @stk_fcost=@lfcost
					   end
					end  -- end of @lposted
					if @ttp=20 and len(@ltowhno)>0
					begin
						if @stk_lcost=0 
						begin
							set @xdate=@ltrdate
							set @trxlcost=0
							Select top 1 @trxlcost=lcost,@trxfcost=fcost From stdtl where
							branch=@lbranch and itemno=@litemno and unicode=@lunicode and whno=@lwhno and binno=@lbinno
							and  trtype in ('10','11','01','14') and trdate>=@ltrdate
							order by trdate,iif(trtype in ('01','10','11'),1,2),stdtl.ref,folio

							if isnull(@trxlcost,0)=0
							begin
							     
								Select top 1 @trxlcost=lcost,@trxfcost=fcost From stdtl where
								branch=@lbranch and itemno=@litemno and unicode=@lunicode and  whno=@lwhno
								and  trtype in ('10','11','01','14')								 
								order by trdate,iif(trtype in ('01','10','11'),1,2),stdtl.ref,folio
							end
							if isnull(@trxlcost,0)=0 --is null
							begin
								Select top 1 @trxlcost=lcost,@trxfcost=fcost From stdtl where
								branch=@lbranch and itemno=@litemno and unicode=@lunicode 
								and  trtype in ('10','11','01','14') and lcost>0								 
								order by trdate desc,iif(trtype in ('01','10','11'),1,2),stdtl.ref,folio
							end
							if isnull(@trxlcost,0)=0 --is null
							begin
								Select top 1 @trxlcost=lcost,@trxfcost=fcost From stdtl where
								itemno=@litemno and unicode=@lunicode 
								and  trtype in ('10','11','01','14') AND lcost>0								 
								order by trdate DESC,branch,iif(trtype in ('01','10','11'),1,2),stdtl.ref,folio
							end
							if isnull(@trxlcost,0)>0 --is null
							begin
								set @stk_lcost=isnull(@trxlcost,0)
								set @stk_fcost=isnull(@trxfcost,0)
							end


							if isnull(@stk_lcost,0)=0
							begin
							    set @trxlcost=0
								set @trxfcost=0
							    select @trxlcost=lastlcost,@trxfcost=lastfcost from stcosttype 
								where branch=@lbranch  and itemno=@litemno and unicode=@lunicode
								if isnull(@trxlcost,0)=0
								begin
									select top 1 @trxlcost=lastlcost,@trxfcost=lastfcost from stcosttype 
									where  itemno=@litemno and unicode=@lunicode order by lstrcvdate desc,branch 
								end
								if isnull(@trxlcost,0)>0 --is null
								begin
									set @stk_lcost=isnull(@trxlcost,0)
									set @stk_fcost=isnull(@trxfcost,0)
								end
							end

							if isnull(@stk_lcost,0)=0 and @lmnopenlcost>0 --is null
							begin
								set @stk_lcost=@lmnopenlcost
								set @stk_fcost=@lmnopenfcost
							end

							if isnull(@stk_lcost,0)=0
							begin
							   set @stk_lcost=@llcost
							   set @stk_fcost=@lfcost
							end
						end -- end of @stk_lcost=0

						update stdtl set lcost = @stk_lcost,fcost=@stk_fcost where branch=@lbranch and trtype=@ltrtype and ref=@lref and folio=@lfolio
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-1
							break
						end
						update stdtl set lcost = @stk_lcost,fcost=@stk_fcost where branch=@lbranch and trtype=@ltrtype and ref=@lref and folio=@lfolio+1
--						and itemno=@litemno and unicode=@lunicode and whno=@ltowhno and binno=@ltobinno
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-1
							break
						end
					end
					fetch next from crs1 into @lbranch, @ltrtype,@lref,@lfolio,@lqty,@llcost,@lfcost,@lisbrtrx,@lposted,@ltowhno
					,@ltobinno,@lfcyrate,@ltrdate;
				end  -- end of crs1 inner loop
				CLOSE crs1
				DEALLOCATE crs1
				if @errstatus=-1 
				begin
				   break;
				end
			    else commit transaction
			end   --- end of @transfer_recs
			fetch next from crs0 into @lbranch,@litemno,@lunicode,@lwhno,@lbinno,@lopenbal,@lopenlcost,@lopenfcost,@lfcy,
			@lmnopenlcost,@lmnopenfcost;
		end  -- end of crs0 ourter loop
		CLOSE crs0;
        DEALLOCATE crs0;
		if @errstatus=0
		begin
		    begin transaction
			update sthdr set costttl=ttlcost
			from sthdr t
			join
			(select branch,trtype,ref,ttlcost=sum(qty*lcost)  from stdtl where 
			branch=@lbranch and trtype=@ltrtype and ref=@lref and len(stdtl.towhno)>0 group by branch,trtype,ref) c
			on t.branch=c.branch and t.trtype=c.trtype and t.ref=c.ref
			where t.trtype='20'	
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-1
			end	
			else  commit transaction			
		end 
		if @errstatus=-1 
		begin
		   if @@TRANCOUNT>0   rollback transaction
			return @errstatus
	    end
		else if @@TRANCOUNT>0 commit transaction	
		return @errstatus	
end











GO
/****** Object:  StoredProcedure [dbo].[bld_cst_sal]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[bld_cst_sal]
  
 @errstatus int = 0 output
	
AS
BEGIN

------ Modified on 2020-10-08 build sales_dt cost was wrong and fixed 

	SET NOCOUNT ON
-- 
-- This section is used to addup new entries for stbins
--
declare @curbal numeric(12,3) ,
        @ltype char(2),
        @lref numeric(6,0),
		@llcost float,
		@lfcost float,
		@lbranch char(2),
        @litemno char(16),
		@lunicode char(6) ,
		@lttllcost float,
		@lttlfcost float,
		@lstdtl cursor,
		@lcursor cursor ;

--
--  Build the cost of Sales_hd & Sthdr
--
       begin transaction
       update sales_hd set invcst=ttl_cst 
	   from sales_hd t
	   join
	   (        select branch,trtype,ref,sum((qty+fqty)*lcost) as ttl_cst from stdtl where src='05' group by branch,trtype,ref        
	   ) c
	   on t.company=c.branch and t.invtype=c.trtype and t.ref=c.ref
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-1
			return
		end	
	   commit transaction

	   begin transaction
       update sthdr set costttl=ttl_cst 
	   from sthdr t
	   join
	   (        select branch,trtype,ref,sum((qty+fqty)*lcost) as ttl_cst from stdtl where src='05' group by branch,trtype,ref
	   ) c
	   on t.branch=c.branch and t.trtype=c.trtype and t.ref=c.ref
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-2
			return
		end	
		commit transaction
------------------------------------------------------------------------------------------------------
------------------  build sales_dt cost from stdtl lcost when sales_dt.whno is empty
   begin transaction
    update sales_dt set cost=ttlcost/ttlqty
	from sales_dt t
	join
	(select branch,trtype,b.ref,b.itemno,b.unicode,sum((b.qty+b.fqty)*lcost) as ttlcost,sum(b.qty+b.fqty) as ttlqty
	 from sales_dt a inner join  stdtl b on a.company=b.branch and a.invtype=b.trtype and a.ref=b.ref and a.itemno=b.itemno and a.unicode=b.unicode
	 where src='05' and len(a.whno)=0 group by b.itemno,b.unicode,branch,trtype,b.ref ) c
	on t.company=c.branch and t.invtype=c.trtype and t.ref=c.ref and t.itemno=c.itemno and t.unicode=c.unicode
	where len(t.whno)=0

	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-3
		return
	end	
	commit transaction
------------------  build sales_dt cost from stdtl lcost when sales_dt.whno is NOT empty
    begin transaction
    update sales_dt set cost=ttlcost/ttlqty
	from sales_dt t
	join
	(
     select branch,trtype,b.ref,b.itemno,b.unicode,b.whno,sum((b.qty+b.fqty)*lcost) as ttlcost,sum(b.qty+b.fqty) as ttlqty
	 from sales_dt a inner join  stdtl b on a.company=b.branch and a.invtype=b.trtype and a.ref=b.ref and a.itemno=b.itemno and a.unicode=b.unicode
	 where src='05' and len(a.whno)>0 group by b.itemno,b.unicode,b.whno,branch,trtype,b.ref  ) c
 	 on t.company=c.branch and t.invtype=c.trtype and t.ref=c.ref and t.itemno=c.itemno and t.unicode=c.unicode
	 AND t.whno=c.whno
	where len(t.whno)>0

	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-4
		return
	end
	commit transaction	
end







GO
/****** Object:  StoredProcedure [dbo].[bld_customers_balances]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2022-06-18@@$$##  Important : must have this line as first line which contains the last update date for the this file 
--CREATE PROCEDURE [dbo].[bld_customer_ei_frm_customer]
--@errstatus int=0 output
--AS
--BEGIN
--	SET NOCOUNT ON
--	declare @lcolumn_name varchar(25)='bldg_no',
--			@ltable_name varchar(20)='customer',
--			@lcounter int=0,
--			@ldatatype varchar(20),
--			@sp int =0

--	if exists(SELECT table_name  FROM INFORMATION_SCHEMA.tables  with (NOLOCK) WHERE TABLE_NAME ='customer_ei')
--	if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME =  @ltable_name  and COLUMN_NAME=@lcolumn_name)
--	begin
--	   begin transaction
--	   merge customer_ei as t
--	   using
--	   (select cu_company,cu_code,cf_fcy,district, district_l, city_text, city_text_l, 000 as country_code, postal_code,Other_id as Other_id_SchemeID,
--		bldg_no, bldg_no_l, street_name, street_name_l, area_name, area_name_l, extra_address_no, extra_address_no_l from customer) as s
--	   on t.cu_company = s.cu_company  and t.cu_code=s.cu_code and t.cf_fcy=s.cf_fcy
--	   when matched then
--	   update set t.district=s.district,t.district_l=s.district_l,t.city_text=s.city_text,t.city_text_l=s.city_text_l,t.postal_code=s.postal_code,
--	              t.Other_id_SchemeID=s.Other_id_SchemeID,t.bldg_no=s.bldg_no,t.bldg_no_l=s.bldg_no_l,t.street_name=s.street_name,
--				  t.area_name=s.area_name,t.area_name_l=s.area_name_l,t.extra_address_no=s.extra_address_no
--	   when not matched then
--	   insert(cu_company,cu_code,cf_fcy,district, district_l, city_text, city_text_l, country_code, postal_code, Other_id_SchemeID,
--		bldg_no, bldg_no_l, street_name, street_name_l, area_name, area_name_l, extra_address_no, extra_address_no_l,
--		street_name2, street_name2_l,Group_VAT_ID)
--		values (s.cu_company,s.cu_code,s.cf_fcy,isnull(s.district,''), isnull(s.district_l,''), isnull(s.city_text,''), isnull(s.city_text_l,''),
--		 isnull(s.country_code,''),isnull(s.postal_code,''), isnull(s.Other_id_SchemeID,''),isnull(s.bldg_no,''), isnull(s.bldg_no_l,''),
--		 isnull(s.street_name,''), isnull(s.street_name_l,''), isnull(s.area_name,''), isnull(s.area_name_l,''), 
--		 isnull(s.extra_address_no,''), isnull(s.extra_address_no_l,''),
--		'','','');
--		if @@error<>0 
--		begin
--			rollback transaction
--			set @errstatus=-1
--			return 
--		end
--		commit transaction
--		set @errstatus=1
--	end

--end
--GO
--/****** Object:  StoredProcedure [dbo].[bld_customers_balances]    Script Date: 08-12-2022 11:08:34 ص ******/
--SET ANSI_NULLS ON
--GO
--SET QUOTED_IDENTIFIER ON
--GO



CREATE PROCEDURE [dbo].[bld_customers_balances]
  
 @errstatus int = 0 output
	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON

	begin transaction
	update customer set cu_curbal=cu_opnbal,cf_curfcy=cf_opnfcy
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-1
		return				
	end
    update customer set cu_curbal=cu_opnbal+isnull(lc_bal,0),cf_curfcy=cf_opnfcy+isnull(fc_bal,0)
	from customer t
	join 
	(select dt_company,dt_cucode,dt_fcy,
	lc_bal=sum(iif(dt_dbcr='C',-(dt_lcamt-dt_paidamt-dt_discamt),dt_lcamt-dt_paidamt-dt_discamt)),
	fc_bal=sum(iif(dt_dbcr='C',-(dt_fcamt-dt_fpydamt-dt_fdscamt),dt_fcamt-dt_fpydamt-dt_fdscamt))
	from ardtl inner join arhdr 
	on dt_company=hd_company and dt_type=hd_type and dt_ref=hd_ref 
	where hd_posted=1
	group by dt_company,dt_cucode,dt_fcy
	) c
	on t.cu_company=c.dt_company and t.cu_code=c.dt_cucode and t.cf_fcy=c.dt_fcy
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-1	
		return			
	end
;
--   Build GL Control Accounts Balances
	with cte_cust (cu_company,cf_fcy,cu_ackey,cu_curbal,cf_curfcy)
	as 
	(
	select cu_company,cf_fcy,iif(cu_ctlser='' or cu_ctlser is null,cl_crlser,cu_ctlser) as cu_ackey,
		cu_curbal,cf_curfcy from customer left outer join classfil
		on cu_company=cl_company and cu_class=cl_code
		where iif(cu_ctlser='' or cu_ctlser is null,cl_crlser,cu_ctlser) is not null)

	update glchart set glcurbal=isnull(lc_bal,0),fccurbal=isnull(fc_bal,0)
	from glchart t
	join
	(select cu_company,cf_fcy,cu_ackey,lc_bal=sum(cu_curbal),fc_bal=sum(cf_curfcy)
	  from cte_cust group by cu_company,cu_ackey,cf_fcy) c
	  on t.glcomp=c.cu_company and t.glkey=c.cu_ackey and t.glcurrency=c.cf_fcy
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-1			
	end
	else commit transaction
end












GO
/****** Object:  StoredProcedure [dbo].[bld_gljrhdr_vat_percent]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create procedure [dbo].[bld_gljrhdr_vat_percent]
 @errstatus int = 0 output
AS
BEGIN
    SET NOCOUNT ON
	declare @lbad_vatP int=0
	set @errstatus=0
	select @lbad_vatP=count(*) from gljrhdr a inner join gljrdtl b on a.jhcomp=b.jdcomp and a.jhtype=b.jdtype and a.jhref=b.jdref
	where  vat_percent=0 and taxcatId>0;
	if isnull(@lbad_vatP,0)>0
	begin
		begin transaction
		update gljrhdr set vat_percent=lvat_p
		from gljrhdr t
		join
		(select company,invtype,ref,lvat_p=vat_percent from sales_hd ) s
		on t.jhcomp=s.company and t.jhtype=s.invtype and t.jhref=s.ref
		where t.jhsrc='05';
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-1
			return
		end
		update gljrhdr set vat_percent=lvat_p
		from gljrhdr t
		join
		(select company,invtype,ref,lvat_p=vat_percent from puhdr ) s
		on t.jhcomp=s.company and t.jhtype=s.invtype and t.jhref=s.ref
		where t.jhsrc='07';
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-2
			return
		end
		commit transaction
	end
end




GO
/****** Object:  StoredProcedure [dbo].[bld_item_status_for_returns]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[bld_item_status_for_returns] 
 @m_cmp char(2),
 @m_type char(2),
 @m_ref  numeric(6,0), 
 @m_cust char(6),
 @fcy char(3),
 @up_to_date char(8),
 @errstatus int = 0 output
AS
BEGIN
    -- if not return  or no customer  dont do anything
	if @m_cust='' or @m_type not in ('24','26')
	   return @errstatus

	SET NOCOUNT ON
	
	begin transaction
	--update sales_dt set qty=0 where invtype='21' and company=@m_cmp and ref=@m_ref

	update sales_dt set sold_item_status=iif(isnull(curyrsales,0)>0,0,4)
	from sales_dt a
	join 
	(select d.cmbkey,curyrsales=sum(case when d.invtype in ('04','06') then qty*pkqty else 0 end),
	                  curyrrtrns=sum(case when d.invtype in ('24','26') then qty*pkqty else 0 end)
		   from sales_dt d inner join sales_hd h on h.company=d.company and h.invtype=d.invtype and h.ref=d.ref
		   where h.custno=@m_cust and h.fcy=@fcy and h.company=@m_cmp and h.invdate<=@up_to_date
		   group by cmbkey) b
		on a.cmbkey=b.cmbkey
		where a.company=@m_cmp and a.ref=@m_ref and a.invtype=@m_type

		if @@error<>0
		begin
		    rollback transaction
			set @errstatus=-1
			return @errstatus
		end

	    if @errstatus=0 
		begin
		    commit transaction
		    return @errstatus
		end	
end















GO
/****** Object:  StoredProcedure [dbo].[bld_jhttl_fm_jdlcamt]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[bld_jhttl_fm_jdlcamt]
  
 @errstatus int = 0 output
	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON

	begin transaction
	update gljrhdr set jhlcdbttl=lljhlcdbttl,jhlccrttl=lljhlccrttl,jhfcdbttl=lljhfcdbttl,jhfccrttl=lljhfccrttl,
					   jhentries=lljhentries
	from gljrhdr t
	join
	(select jdcomp,jdtype,jdref,lljhlcdbttl=sum(iif(jddbcr='D', jdlcamt,0)),lljhlccrttl=sum(iif(jddbcr='C', jdlcamt,0)),
	lljhfcdbttl=sum(iif(jddbcr='D', jdfcamt,0)),lljhfccrttl=sum(iif(jddbcr='C', jdfcamt,0)),lljhentries=sum(1)
	from gljrdtl group by jdcomp,jdtype,jdref
	) c
	on t.jhcomp=c.jdcomp and t.jhtype=c.jdtype and t.jhref=c.jdref
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-1	
		return			
	end
	else commit transaction
/*
update gljrhdr set jhlcdbttl=isnull((select sum(case when jddbcr='D' then jdlcamt else 0 end) from gljrdtl where jhcomp=jdcomp
and jhtype=jdtype and jhref=jdref group by jdcomp,jdtype,jdref),0),jhlccrttl=isnull((select sum(case when jddbcr='C' 
then jdlcamt else 0 end) from gljrdtl where jhcomp=jdcomp
and jhtype=jdtype and jhref=jdref group by jdcomp,jdtype,jdref),0),
jhfcdbttl=isnull((select sum(case when jddbcr='D' then jdfcamt else 0 end) from gljrdtl where jhcomp=jdcomp
and jhtype=jdtype and jhref=jdref group by jdcomp,jdtype,jdref),0),
jhfccrttl=isnull((select sum(case when jddbcr='C' then jdfcamt else 0 end) from gljrdtl where jhcomp=jdcomp
and jhtype=jdtype and jhref=jdref group by jdcomp,jdtype,jdref),0),
jhentries=isnull((select sum(1) from gljrdtl where jhcomp=jdcomp
and jhtype=jdtype and jhref=jdref group by jdcomp,jdtype,jdref),0)

				if @@error<>0
				begin
				  rollback transaction
				  set @errstatus=-1				
				end
				else commit transaction;
*/

	begin transaction
	update gljrhdr set jhamt=(case when jhlcdbttl=jhlccrttl and jhlcdbttl>0 and jhlcdbttl>jhamt then 
	jhlcdbttl else jhamt end)
	if @@error<>0 
	begin
		rollback transaction
		set @errstatus=-1	
	end			
	else commit transaction;

end














GO
/****** Object:  StoredProcedure [dbo].[bld_moved_fld]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[bld_moved_fld]
 
 @errstatus int = 0 output
	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
begin transaction
update stunits set moved='0'
	    	if @@error<>0
		  	begin
		 	  rollback transaction
			  set @errstatus=-1		
			  return	 
			end

commit transaction
--
--  Set the moved field in stunits if it has transaction
--
begin transaction
        update stunits set moved='1' where
		 (exists(select top 1 ref from stdtl where stdtl.itemno=stunits.itemno and stdtl.unicode=stunits.unicode));
	    	if @@error<>0
		  	begin
		 	  rollback transaction
			  set @errstatus=-1		
			  return	 
			end
            commit transaction
end















GO
/****** Object:  StoredProcedure [dbo].[bld_nqati_card_balances]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[bld_nqati_card_balances]
 @errstatus int = 0 output
	
AS
BEGIN
	declare @sqlmsg nvarchar(max)='',
	@dbc nvarchar(14),
	@lcalcomp char(2),
	@yrcode char(4),
	@syscode int =2,
	@lno_round_nm bit=0,
	@lppcard_cmp_lvl bit=0
---------------------------------------------------------------------------------------------
	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)

	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @syscode=sysno,@lno_round_nm=no_round_nm,@lppcard_cmp_lvl=ppcard_cmp_lvl  from sysdb.dbo.glcalend 
	where calcomp=@lcalcomp and yrcode=@yrcode
------------------------------------------------------------------------------------------------------------------------------

---
--- Notes : paytype=5 needs more thinking since it is ignored durring sales ?????
---
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[#posdtl]'))
DROP TABLE [dbo].#posdtl
CREATE TABLE dbo.#posdtl 
   ( 
   company int NOT NULL, 
   contr int not null,
   ref int not null,
   nqati_amt float, 
   nqati_sales float
   ) 
   if @lno_round_nm=1 or @syscode=6 
   begin
	   insert into dbo.#posdtl
	   select a.company,a.contr,a.ref,
	   sum((iif(b.dsc_amt>0,(b.qty*(b.price-b.dsc_amt)),(b.qty*(b.price-(b.price*b.dscprsnt/100))))-b.offer_amt)*
		(isnull(b.nqati_prcnt,0)/100)*iif(invorrtrn='1',1,-1)),
        sum(iif(b.nqati_prcnt>0,(iif(b.dsc_amt>0,(b.qty*(b.price-b.dsc_amt)),(b.qty*(b.price-(b.price*b.dscprsnt/100
		))))-b.offer_amt),0)*iif(invorrtrn='1',1,-1))		
		 from  pos_dsc c inner join POS_HD a inner join pos_dt b 
		on a.company=b.company and a.contr=b.contr and a.ref=b.ref
		on c.dsccompany = a.company and c.dsccard=a.disccard 
		where invorrtrn<>'4' and rtrim(disccard)<>'' and c.cardtype=6 --and a.contr=100 and a.ref=28
		group by a.company,a.contr,a.ref
   end
   else
   begin
	   insert into dbo.#posdtl
	   select a.company,a.contr,a.ref,
	   sum((iif(b.dsc_amt>0,(b.qty*(b.price-b.dsc_amt)),(b.qty*(b.price-floor(b.price*b.dscprsnt/100))))-b.offer_amt)*
		(isnull(b.nqati_prcnt,0)/100)*iif(invorrtrn='1',1,-1)),
        sum(iif(b.nqati_prcnt>0,(iif(b.dsc_amt>0,(b.qty*(b.price-b.dsc_amt)),(b.qty*(b.price-floor(b.price*b.dscprsnt/100
		))))-b.offer_amt),0)*iif(invorrtrn='1',1,-1))		
		 from  pos_dsc c inner join POS_HD a inner join pos_dt b 
		on a.company=b.company and a.contr=b.contr and a.ref=b.ref
		on c.dsccompany = a.company and c.dsccard=a.disccard 
		where invorrtrn<>'4' and rtrim(disccard)<>'' and c.cardtype=6 --and a.contr=100 and a.ref=28
		group by a.company,a.contr,a.ref
    end
    begin transaction
	update pos_dsc set sales_grantd=0,ttl_grantd=0,cust_ttlsales=0 where cardtype=6
	if @@error<>0 
	begin
		set @errstatus=-1
		rollback transaction
		DROP TABLE dbo.#posdtl
		return 
	end
	if isnull(@lppcard_cmp_lvl,0)=0
		update pos_dsc set  cust_ttlsales=nqati_sales,sales_grantd=isnull(nqati_openbal,0)+isnull(nqati_amt,0)-isnull(nqati_grantd,0),
		ttl_grantd=isnull(nqati_grantd,0)
		from pos_dsc t
		join
		(select c.dsccompany,dsccard,nqati_amt=sum(floor(abs(nqati_amt))*iif(nqati_amt>0,1,-1)),nqati_sales=sum(nqati_sales),
		nqati_grantd=(select sum(vchr_value) from pos_dsc where pos_dsc.mothercard=c.dsccard and pos_dsc.cardtype=5 and crtyear=@yrcode)
		From pos_dsc c left outer join  POS_HD a inner join dbo.#posdtl b on a.company=b.company and a.contr=b.contr and a.ref=b.ref
		and invorrtrn<>'4'
		on c.dsccompany = a.company and c.dsccard=a.disccard 
		where c.cardtype=6 
		group by c.dsccompany,dsccard) s
		on t.dsccompany=s.dsccompany and t.dsccard=s.dsccard;
	else
		update pos_dsc set  cust_ttlsales=nqati_sales,sales_grantd=isnull(nqati_openbal,0)+isnull(nqati_amt,0)-isnull(nqati_grantd,0),
		ttl_grantd=isnull(nqati_grantd,0)
		from pos_dsc t
		join
		(select dsccard,nqati_amt=sum(floor(abs(nqati_amt))*iif(nqati_amt>0,1,-1)),nqati_sales=sum(nqati_sales),
		nqati_grantd=(select sum(vchr_value) from pos_dsc where pos_dsc.mothercard=c.dsccard and pos_dsc.cardtype=5 and crtyear=@yrcode)
		From pos_dsc c left outer join  POS_HD a inner join dbo.#posdtl b on a.company=b.company and a.contr=b.contr and a.ref=b.ref
		and invorrtrn<>'4'
		on  c.dsccard=a.disccard 
		where c.cardtype=6 
		group by dsccard) s
		on  t.dsccard=s.dsccard;

	if @@error<>0 
	begin
		set @errstatus=-1
		rollback transaction
		DROP TABLE dbo.#posdtl
		return 
	end
        	
--
--  Update extra point for the identifier
--
    update pos_dsc set sales_grantd=sales_grantd+isnull(identifier_extra_pont,0)
    from pos_dsc t
	join    	
	(select cstpassw,identifier_extra_pont=sum(mnthbal) from pos_dsc where cardtype=6 and mnthbal>0
	and cstpassw<>'' group by cstpassw ) s
	on t.dsctel=substring(s.cstpassw,1,12)
	if @@error<>0 
	begin
		set @errstatus=-2
		rollback transaction
		DROP TABLE dbo.#posdtl
		return 
	end
	commit transaction
	DROP TABLE dbo.#posdtl
end












GO
/****** Object:  StoredProcedure [dbo].[bld_puordVSslord]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[bld_puordVSslord]
 @m_cmp char(2),
 @errstatus int = 0 output
	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON

declare @lcompany char(2),
        @litemno char(16),
		@lunicode char(6) ,
		@lref numeric(6,0) ,
		@lttlqty numeric(13,3),
		@lqty numeric(13,3),
		@lt_qty numeric(13,3),
		@lqtyrsv numeric(13,3),
		@lptr int = 0

-- 
       begin transaction
		update ord_dtl set qtyrsv = 0 where company=@m_cmp
		if @@error<>0
			begin
			  rollback transaction
			  set @errstatus=-1		
			  return		 
			end
		commit transaction;

DECLARE crsx0 CURSOR LOCAL FAST_FORWARD FOR 
    Select sales_oh.company,sales_od.porder,itemno,Unicode ,
         Sum((qty+fqty)*pkqty) As xqty 
         from sales_oh inner Join sales_od
         on sales_oh.company=sales_od.company and sales_oh.ref=sales_od.ref
         where  sales_oh.company=@m_cmp and sales_oh.isorder='1'
         group By sales_oh.company,sales_od.porder,itemno,Unicode
         order By sales_oh.company,sales_od.porder,itemno,Unicode


					
		open crsx0;
		
		fetch next from crsx0 into @lcompany,@lref,@litemno,@lunicode,@lttlqty
		
		begin transaction
		WHILE dbo.FetchStatusOfCursorNamed('crsx0') = 0
        BEGIN
	      if @lref>0
		  begin
		     update ord_dtl set qtyrsv=qtyrsv + @lttlqty where company=@lcompany and ref=@lref and itemno=@litemno
			 and unicode=@lunicode;
				if @@error<>0
				begin
				  rollback transaction
				  set @errstatus=-1
				  break
				end
		  end
		  else
		  begin
		     set @lt_qty=@lttlqty
		     DECLARE crsx1 CURSOR LOCAL FAST_FORWARD FOR
			 select company,ref,itemno,unicode,qty*pkqty as qty,qtyrsv from ord_dtl where company=@lcompany and itemno=@litemno
			   and unicode=@lunicode and (qty*pkqty)-qtyrsv>0 order by invdate 
	 	     open crsx1;		
		     fetch next from crsx1 into @lcompany,@lref,@litemno,@lunicode,@lqty,@lqtyrsv
		     WHILE dbo.FetchStatusOfCursorNamed('crsx1') = 0 
               BEGIN
			     If @lqty-@lqtyrsv>=@lt_qty
				 begin
		           update ord_dtl set qtyrsv=qtyrsv + @lt_qty where company=@lcompany and ref=@lref and itemno=@litemno
			       and unicode=@lunicode;
				    if @@error<>0
				      begin
				        rollback transaction
				        set @errstatus=-1
				        break
				      end
					  set @lt_qty=0
				  end
				  else
				  begin
				    set @lt_qty=@lt_qty-@lqty+@lqtyrsv
		            update ord_dtl set qtyrsv=@lqty where company=@lcompany and ref=@lref and itemno=@litemno
			        and unicode=@lunicode;
				    if @@error<>0
				      begin
				        rollback transaction
				        set @errstatus=-1
				        break
				      end
				   end
				   if @lt_qty<=0 break;
				   fetch next from crsx1 into @lcompany,@lref,@litemno,@lunicode,@lqty,@lqtyrsv
		       end 
               CLOSE crsx1
               DEALLOCATE crsx1
		  end
		   if  @errstatus<0 break; 
		   fetch next from crsx0 into @lcompany,@lref,@litemno,@lunicode,@lttlqty
		 end
		 if @errstatus=0 
		 commit transaction
close crsx0
deallocate crsx0
end
















GO
/****** Object:  StoredProcedure [dbo].[bld_qty_rsvqty_balances]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2023-01-04@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[bld_qty_rsvqty_balances] 
 @errstatus int = 0 output
	
AS
BEGIN
--- Added on 2023-01-04 AA set curbal & qty to zero if their values 0.0000xxxxx
--- Added on 2022-05-23 AA Fixed the bug of converting float to numeric(20,12)
--- Added on 2020-08-16 AA Made all the qty to be numeric(20,21) instead of float to get red of the long decimal fractions 
	SET NOCOUNT ON
	
	begin transaction
------- Added on 2022-02-17 AA Fix bug ------------------------------------------
    update stunits set curbal=openbal 
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return @errstatus
	end
---------------------------------------------------------------------------------
----Stopped on 2022-05-23 AA update stunits set curbal=cast(openbal+ttlbal as numeric(20,12)) ,rsvqty=cast(ttlrsv as numeric(20,12))
---- Added on 2022-05-23 AA Fixed the bug of numeric 
	update stunits set curbal=openbal+ttlbal ,rsvqty=ttlrsv 
	from stunits a
	join 
	(select itemno,unicode,ttlbal=sum(iif(hh.posted=1,case when (dd.trtype in ('02','04','06','09','30','31')) or (tobinno<>'+' and dd.trtype='20')
		then -(dd.qty+cast(dd.fqty as float)) else dd.qty+cast(dd.fqty as float) end,0)),
		ttlrsv=sum(iif(hh.posted=0,case when (dd.trtype in ('02','04','06','09','30','31') 
		or (dd.trtype in('13','46') And qty<0)) and not (dd.trtype='46' And tobinno='*')
		then abs(dd.qty+cast(dd.fqty as float)) else 0 end,0))
			from sthdr hh inner join stdtl dd
		on hh.branch=dd.branch and hh.trtype=dd.trtype and hh.ref=dd.ref
        where hh.trtype not in ('14','20')
		group by itemno,unicode ) b
		on a.itemno=b.itemno and a.unicode=b.unicode;
		if @@error<>0
		begin
		    rollback transaction
			set @errstatus=-2
			return @errstatus
		end
---- Added on 202--01-04 AA To reset the item balance to zero when the value of it is 0.0000nnnn		
		update stunits set curbal=0 where abs(curbal)<1 and curbal<>0 and cast(curbal as numeric(20,4))=0
		if @@error<>0
		begin
		    rollback transaction
			set @errstatus=-3
			return @errstatus
		end	
-------------------------------------------------------------------------------------------------			
			---
			--- Update qty & rsvqty in STBINS
			---
------- Added on 2022-02-17 AA Fix bug ------------------------------------------
    update stbins set qty=openbal 
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-4
		return @errstatus
	end
---------------------------------------------------------------------------------
----Stopped on 2022-05-23 AA 	update stbins set qty=cast(openbal+ttlbal as numeric(20,12)) ,rsvqty=cast(ttlrsv as numeric(20,12))
    update stbins set qty=openbal+ttlbal ,rsvqty=ttlrsv
	from stbins a
	join 
	(select dd.branch,itemno,unicode,dd.whno,binno,ttlbal=sum(iif(hh.posted=1,case when (dd.trtype in ('02','04','06','09','30','31')) or (tobinno<>'+' and dd.trtype='20')
		then -(dd.qty+cast(dd.fqty as float)) else dd.qty+cast(dd.fqty as float) end,0)),
		ttlrsv=sum(iif(hh.posted=0,case when (dd.trtype in ('02','04','06','09','30','31') 
		or (dd.trtype in('13','46') And qty<0) or (dd.trtype='20' And dd.towhno<>'')) and not (dd.trtype='46' And tobinno='*')
		then abs(dd.qty+cast(dd.fqty as float)) else 0 end,0))
			from sthdr hh inner join stdtl dd
		on hh.branch=dd.branch and hh.trtype=dd.trtype and hh.ref=dd.ref
		where hh.trtype<>'14'
		group by dd.branch,itemno,unicode,dd.whno,binno ) b
		on a.branch=b.branch and a.itemno=b.itemno and a.unicode=b.unicode and a.whno=b.whno and a.binno=b.binno;
		if @@error<>0
		begin
		    rollback transaction
			set @errstatus=-5
			return @errstatus
		end
---- Added on 202--01-04 AA To reset the item balance to zero when the value of it is 0.0000nnnn		
		update stbins set qty=0 where abs(qty)<1 and qty<>0 and cast(qty as numeric(20,4))=0
		if @@error<>0
		begin
		    rollback transaction
			set @errstatus=-6
			return @errstatus
		end	
-------------------------------------------------------------------------------------------------		
		 if @errstatus=0 
		 commit transaction
		return @errstatus
end


GO
/****** Object:  StoredProcedure [dbo].[bld_rebate_whqty2str]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[bld_rebate_whqty2str] 
 @errstatus int = 0 output	
AS
BEGIN
	SET NOCOUNT ON
	set @errstatus=0
    begin transaction
    update sales_dd set whqty=lwhqtystrng 
	from sales_dd t
	join
	(   select company,invtype,ref,folio,lwhqtystrng=cast(fqty as varchar(12))+'/'+cast(shdqty as varchar(12))+'/' +cast(rtnqty as varchar(12))+'/'+cast(dscqty as varchar(12))+'/'+ cast(frtqty as varchar(12))+'/'
	    from sales_dd where invtype='22' and len(isnull(whqty,''))=0) c
	on t.company=c.company and t.invtype=c.invtype and t.ref=c.ref and t.folio=c.folio 
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-1
		return
	end	
	commit transaction
end









GO
/****** Object:  StoredProcedure [dbo].[bld_rsvqty]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2023-01-12@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROC[dbo].[bld_rsvqty]
 
 @errstatus int = 0 output
	
AS
BEGIN
----- Added on 2023-01-12 AA Build the rsvqty from st_slsord_dtl table
		-- SET NOCOUNT ON added to prevent extra result sets from
			SET NOCOUNT ON

        begin transaction

		---
		--- Update rsvqty in STBINS
		---
		update stbins set rsvqty=0;
		if @@error<>0
		begin
		    rollback transaction
			set @errstatus=-2
			return @errstatus
		end
		update  stbins set rsvqty=iif(isnull(ttlrsvqty,0)<0,0,isnull(ttlrsvqty,0))
		from stbins as a
		join 
		(select stdtl.branch,itemno,unicode,stdtl.whno,binno,sum(abs(qty+fqty)) as ttlrsvqty from stdtl inner join sthdr
		on stdtl.branch=sthdr.branch and stdtl.trtype=sthdr.trtype and stdtl.ref=sthdr.ref
		 where  posted='0' and not (sthdr.trtype in ('01','14','05','10','11','24','26') or 
		 (stdtl.trtype='20' and len(stdtl.towhno)=0) or (stdtl.trtype in ('13','46','12') and stdtl.qty>0)) 
			group by  stdtl.branch,itemno,unicode,stdtl.whno,binno) b
		on a.branch=b.branch and a.itemno=b.itemno and a.unicode=b.unicode and a.whno=b.whno and a.binno=b.binno;
		if @@error<>0
		begin
		    rollback transaction
			set @errstatus=-2
			return @errstatus
		end
		---
		--- Update rsvqty in STUNITS
		---
		update stunits set rsvqty=0;
		if @@error<>0
		begin
		    rollback transaction
			set @errstatus=-2
			return @errstatus
		end

		update stunits set rsvqty=ttlrsvqty
		from stunits a
		join 
		(select itemno,unicode,sum(abs(qty+fqty)) as ttlrsvqty
			from sthdr hh inner join stdtl dd
		on hh.branch=dd.branch and hh.trtype=dd.trtype and hh.ref=dd.ref
		 where  posted='0' and not (hh.trtype in ('01','14','05','10','11','24','26','20') or 
		 (dd.trtype in ('13','46','12') and dd.qty>0)) 
		group by itemno,unicode ) b
		on a.itemno=b.itemno and a.unicode=b.unicode;
		if @@error<>0
		begin
		    rollback transaction
			set @errstatus=-2
			return @errstatus
		end
		commit transaction

------- Added on 2023-01-12 AA Build the rsvqty from st_slsord_dtl table -------------------------------------------------------------
        begin transaction
		update  stbins set rsvqty=rsvqty+iif(isnull(ttlrsvqty,0)<0,0,isnull(ttlrsvqty,0))
		from stbins as a
		join 
		(select y.branch,itemno,unicode,y.whno,binno,sum(abs(qty)) as ttlrsvqty from st_slsord_dtl y
		 inner join sales_oh x
		on y.branch=x.company  and y.ref=x.ref
		where  wh_rsvqty=1  
		group by  y.branch,itemno,unicode,y.whno,binno) b
		on a.branch=b.branch and a.itemno=b.itemno and a.unicode=b.unicode and a.whno=b.whno and a.binno=b.binno;
		if @@error<>0
		begin
		    rollback transaction
			set @errstatus=-3
			return @errstatus
		end

		update stunits set rsvqty=rsvqty+ttlrsvqty
		from stunits a
		join 
		(select itemno,unicode,sum(abs(qty)) as ttlrsvqty from st_slsord_dtl y
		 inner join sales_oh x
		on y.branch=x.company  and y.ref=x.ref
		where  wh_rsvqty=1  
		group by  itemno,unicode) b
		on a.itemno=b.itemno and a.unicode=b.unicode;
		if @@error<>0
		begin
		    rollback transaction
			set @errstatus=-4
			return @errstatus
		end
		commit transaction
------------------------------------------------------------------------------------------------
		return @errstatus
end







GO
/****** Object:  StoredProcedure [dbo].[bld_sales_dh_4_einvphs2]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-01-07@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[bld_sales_dh_4_einvphs2]
@errstatus int=0 output
as
begin
----  Added on 2023-12-11 AA Added new code to drop temp_dh & temp_dd
----  Added on 2023-12-11 AA Added new code changing the condition to start processing
----  Added on 2023-11-25 AA Changed the data type of ref from numeric(6,0) to int
	SET NOCOUNT ON
	
	if  exists(SELECT table_name  FROM INFORMATION_SCHEMA.tables WHERE TABLE_NAME ='temp_dh')
	begin
	    drop table dbo.temp_dh;
		drop table dbo.temp_dd;
	end
  if exists(SELECT top 1 invtype  FROM sales_dh WHERE invtype in ('04','10'))
	begin
		select *  into temp_dh from sales_dh where invtype in ('04','10')
		select *  into temp_dd from sales_dd where invtype in ('04','10')

		begin transaction
		delete from  sales_dh where invtype in ('04','10')
		commit transaction 
		declare @lcompany char(2),
				@linvtype char(2),
				@lref int,
				@lrtnref int
				

		begin transaction
		DECLARE crs0 CURSOR LOCAL FAST_FORWARD FOR
		select company,invtype,ref,rtnref from temp_dh 
		open crs0;
		fetch next from crs0 into @lcompany,@linvtype,@lref,@lrtnref
		WHILE dbo.FetchStatusOfCursorNamed('crs0') = 0
		BEGIN
			update temp_dd set jvtype=@linvtype,jvref=@lref,invtype=iif(@linvtype='04','21','22'),ref=@lrtnref where company=@lcompany and 
			invtype=@linvtype and ref=@lref
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-1	
				break 			 				
			end
			fetch next from crs0 into @lcompany,@linvtype,@lref,@lrtnref
		end
		CLOSE crs0
		DEALLOCATE crs0
		update temp_dh set jvtype =invtype,jvref=ref,invtype=iif(invtype='04','21','22'),ref=rtnref
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-2
			return				 				
		end
		insert into sales_dh
		select * from temp_dh
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-3
			return				 				
		end
		insert into sales_dd
		select * from temp_dd
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-4
			return				 				
		end
		commit transaction
--- Added on 2023-12-11 ---		
		drop table dbo.temp_dh;
		drop table dbo.temp_dd;
	end
end


GO
/****** Object:  StoredProcedure [dbo].[bld_slordVSsales]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[bld_slordVSsales]
 @m_cmp char(2),
 @errstatus int = 0 output
	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON

declare @lcompany char(2),
        @litemno char(16),
		@lunicode char(6) ,
		@lref char(2) ,
		@lxqty numeric(13,3),
		@lxfqty numeric(13,3),
		@lptr int = 0,
		@lcursor cursor ;
-- 
       begin transaction
		update sales_od set qtyrcv  = 0,fqtyrcv = 0  where company=@m_cmp
		if @@error<>0
			begin
			  rollback transaction
			  set @errstatus=-1		
			  return		 
			end
		commit transaction;

set @lcursor = cursor for  
     Select sales_hd.company,rqstorder,itemno,Unicode ,
           xqty=sum(case when sales_hd.invtype in ('04','06') then (qty+fqty)*pkqty else -(qty+fqty)*pkqty end)
           from sales_hd inner Join sales_dt
           on sales_hd.company=sales_dt.company and sales_hd.invtype=sales_dt.invtype and sales_hd.ref=sales_dt.ref
           where rqstorder<>0  And sales_hd.company=@m_cmp
           group By sales_hd.company,rqstorder,itemno,Unicode
           order By sales_hd.company,rqstorder,itemno,Unicode
					
		open @lcursor;
		
		fetch next from @lcursor into @lcompany,@lref,@litemno,@lunicode,@lxqty
		
		begin transaction
		WHILE @@FETCH_STATUS = 0
        BEGIN
		     update sales_od set qtyrcv=@lxqty where company=@lcompany and ref=@lref and itemno=@litemno
			 and unicode=@lunicode;
				if @@error<>0
				begin
				  rollback transaction
				  set @errstatus=-1
				  break
				end

		   fetch next from @lcursor into @lcompany,@lref,@litemno,@lunicode,@lxqty
		 end
		 if @errstatus=0 
		 commit transaction
close @lcursor
deallocate @lcursor
end

















GO
/****** Object:  StoredProcedure [dbo].[bld_sthdr_cost]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2022-10-04@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[bld_sthdr_cost]
 
 @errstatus int = 0 output
	
AS
BEGIN
	--- Added on 2022-10-04 AA updated to take care of the  transfer transaction too trtype 20 cost & qty
	--- Modified on 2020-10-08 added trtype '12' 

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.

	SET NOCOUNT ON
	
		begin transaction
		 update sthdr set amnttl=iif(v.trtype='20',llqty,llcost),costttl=iif(v.trtype='20',llcost,ffcost)
		 from sthdr as v
		 join 
		(select branch,trtype,ref,llcost=sum(qty*lcost),ffcost=sum(qty*fcost),llqty=sum(qty) from stdtl
		where trtype in ('09','05','02','01','12') or (trtype='20' and len(towhno)>0) group by branch,trtype,ref) c
		on v.branch=c.branch and v.trtype=c.trtype and v.ref=c.ref
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-1				  
		end
		else commit transaction	
end



GO
/****** Object:  StoredProcedure [dbo].[bld_suppliers_balances]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[bld_suppliers_balances]
  
 @errstatus int = 0 output
	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON

	begin transaction
	update supplier set cu_curbal=cu_opnbal,cf_curfcy=cf_opnfcy
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-1
		return				
	end
    update supplier set cu_curbal=cu_opnbal+isnull(lc_bal,0),cf_curfcy=cf_opnfcy+isnull(fc_bal,0)
	from supplier t
	join 
	(select dt_company,dt_cucode,dt_fcy,
	lc_bal=sum(iif(dt_dbcr='C',-(dt_lcamt-dt_paidamt-dt_discamt),dt_lcamt-dt_paidamt-dt_discamt)),
	fc_bal=sum(iif(dt_dbcr='C',-(dt_fcamt-dt_fpydamt-dt_fdscamt),dt_fcamt-dt_fpydamt-dt_fdscamt)) from apdtl inner join aphdr 
	on dt_company=hd_company and dt_type=hd_type and dt_ref=hd_ref 
	where hd_posted=1
	group by dt_company,dt_cucode,dt_fcy
	) c
	on t.cu_company=c.dt_company and t.cu_code=c.dt_cucode and t.cf_fcy=c.dt_fcy
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-1	
		return			
	end
;
--   Build GL Control Accounts Balances
	with cte_cust (cu_company,cf_fcy,cu_ackey,cu_curbal,cf_curfcy)
	as 
	(
	select cu_company,cf_fcy,iif(cu_ctlser='' or cu_ctlser is null,cl_crlser,cu_ctlser) as cu_ackey,
		cu_curbal,cf_curfcy from supplier left outer join apclass 
		on cu_company=cl_company and cu_class=cl_code
		where iif(cu_ctlser='' or cu_ctlser is null,cl_crlser,cu_ctlser) is not null)

	update glchart set glcurbal=isnull(lc_bal,0),fccurbal=isnull(fc_bal,0)
	from glchart t
	join
	(select cu_company,cf_fcy,cu_ackey,lc_bal=sum(cu_curbal),fc_bal=sum(cf_curfcy)
	  from cte_cust group by cu_company,cu_ackey,cf_fcy) c
	  on t.glcomp=c.cu_company and t.glkey=c.cu_ackey and t.glcurrency=c.cf_fcy
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-1			
	end
	else commit transaction
end












GO
/****** Object:  StoredProcedure [dbo].[BRANCH_TTL]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-10-10@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[BRANCH_TTL]
 @lfmdate varchar(8),
 @ltodate varchar(8),
 @trx_x  nvarchar(1000),
 @itm_x  nvarchar(1000),
 @group_item nvarchar(50),
 @group_factor nvarchar(50),
 @NoOfRecords int output,
 @larabic bit -- Added on 2024-10-10 AA
AS
BEGIN
    -- Added on 2024-10-10 AA new variable @litem_name_txt to hold the item name of the required language
    -- Added on 2024-10-10 AA new paramter for arabic public variable
    -- Added on 2024-08-21 AA punet 
    -- Modified on 2022-12-06 AA Added the stwhous table to allow using the sections
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
    declare @sqlmsg nvarchar(max),
    @whereclause nvarchar(2000)='',
	@lmode int =0
--- Added on 2024-10-10 AA --------------------------
	declare @litem_name_txt varchar(25)=''	
	if @larabic=1 set @litem_name_txt='stitems.name' 
	   else set @litem_name_txt='stitems.lname'
-------------------------------------------------------
	set @lmode=@NoOfRecords
	set @NoOfRecords=0
	set @sqlmsg =''
	if @lmode =0
	begin
	    set @sqlmsg ='select '+@group_item+' as whkey,stunits.modelno as mnkey,'+@litem_name_txt+' as fulname,
			pkqty1,lrcvdate,lastissue,stunits.lcost,stitems.splycode,stitems.msplycode,stitems.fcy,
			stunits.barcode,stunits.lprice1,
			avgprice=sum(iif(sthdr.src=''05'',iif(stdtl.trtype in (''04'',''06''),qty*lprice,-qty*lprice),0.00)),
			avglcost=sum(iif(sthdr.src=''05'',iif(stdtl.trtype in (''04'',''06''),(qty+fqty)*stdtl.lcost,-(qty+fqty)*stdtl.lcost),0.00)),
			punet=SUM(iif(stdtl.src=''07'',iif(stdtl.trtype in (''10'',''11''),qty+fqty,-(qty+fqty)),0)),
			rcvtrx=sum(case when stdtl.trtype in (''01'',''02'',''11'',''10'',''31'',''30'') then 
			(case when stdtl.trtype in (''01'',''11'',''10'')
			then qty+fqty else -(qty+fqty) end) else 0.00 end),
			rtntrx=sum(case  when stdtl.trtype in (''24'',''26'') then qty+fqty else 0.00 end),
			slstrx=sum(case  when stdtl.trtype in (''04'',''06'') then qty+fqty else 0.00 end),
			isstrx=sum(case when stdtl.trtype in (''05'',''09'') then (case when stdtl.trtype=''05'' then
			qty+fqty else -(qty+fqty) end) else 0.00 end),
			adjtrx=sum(case when stdtl.trtype in (''13'',''20'',''12'',''46'') then 
			(case when stdtl.trtype=''20'' and tobinno<>''+'' 
			then -qty else qty end) else 0.00 end),cast(0 as float) as prv_obal'
			if @group_factor is not null and @group_factor<>''
			set @sqlmsg=@sqlmsg+',ISNULL('+@group_factor+',''  '') as whno'
			set @sqlmsg=@sqlmsg+' from  (stitems inner Join stunits on stitems.itemno=stunits.itemno) left outer join 
			(stwhous inner join stdtl  on stwhous.branch=stdtl.branch and stwhous.whno=stdtl.whno inner Join sthdr
			on stdtl.branch=sthdr.branch and stdtl.trtype=sthdr.trtype and stdtl.ref=sthdr.ref
			and sthdr.trdate between '+@lfmdate +' and '+ @ltodate
			if @trx_x is not null and @trx_x<>''
			set @sqlmsg=@sqlmsg+' and '+@trx_x
			set @sqlmsg=@sqlmsg+')'
			set @sqlmsg=@sqlmsg+' on stunits.itemno=stdtl.itemno and stunits.Unicode=stdtl.Unicode '
			if @itm_x is not null and @itm_x<>''
			set @sqlmsg=@sqlmsg+' where '+@itm_x
			set @sqlmsg=@sqlmsg+' group by '+@group_item+','
			if @group_factor is not null and @group_factor<>''
			set @sqlmsg=@sqlmsg+'ISNULL('+@group_factor+',''  ''),'
			set @sqlmsg=@sqlmsg+'stunits.modelno,'+@litem_name_txt+',pkqty1,lrcvdate,
			lastissue,stunits.lcost,stitems.splycode,stitems.msplycode,stitems.fcy,
			stunits.barcode,stunits.lprice1'
	end
	else
	begin
        set @sqlmsg ='select '+@group_item+' as mnkey, sum( stbins.openbal) as PRV_OBAL'
		if @group_factor is not null and @group_factor<>''
		set @sqlmsg=@sqlmsg+','+@group_factor+' as whno'	
		set @sqlmsg=@sqlmsg+' from stitems inner join stunits inner join stbins inner join stwhous
		on stbins.branch=stwhous.branch and stbins.whno=stwhous.whno
        on stunits.itemno=stbins.itemno and stunits.unicode=stbins.unicode
        on stitems.itemno=stunits.itemno'
		if @itm_x is not null and @itm_x<>''
		set @sqlmsg=@sqlmsg+' where '+@itm_x
		set @sqlmsg=@sqlmsg+' group by '+@group_item
		if @group_factor is not null and @group_factor<>''
		set @sqlmsg=@sqlmsg+','+@group_factor
	end;

	exec sp_executesql @sqlmsg;        
	if @@error<>0 set @NoOfRecords=-1 
	ELSE set @NoOfRecords=@@ROWCOUNT

END


GO
/****** Object:  StoredProcedure [dbo].[BRANCH_TTL_LATIN]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[BRANCH_TTL_LATIN]
 @lfmdate varchar(8),
 @ltodate varchar(8),
 @trx_x  nvarchar(1000),
 @itm_x  nvarchar(1000),
 @group_item nvarchar(50),
 @group_factor nvarchar(50),
 @NoOfRecords int output
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
    declare @sqlmsg nvarchar(max),
    @whereclause nvarchar(2000)='',
	@lmode int =0
		 
	set @lmode=@NoOfRecords
	set @NoOfRecords=0
	set @sqlmsg =''
	if @lmode =0
	begin
	    set @sqlmsg ='select '+@group_item+' as whkey,stunits.modelno as mnkey,stitems.lName as fulname,
			pkqty1,lrcvdate,lastissue,stunits.lcost,stitems.splycode,stitems.msplycode,stitems.fcy,
			stunits.barcode,stunits.lprice1,
			avgprice=sum(iif(sthdr.src=''05'',iif(stdtl.trtype in (''04'',''06''),qty*lprice,-qty*lprice),0.00)),
			avglcost=sum(iif(sthdr.src=''05'',iif(stdtl.trtype in (''04'',''06''),(qty+fqty)*stdtl.lcost,-(qty+fqty)*stdtl.lcost),0.00)),
			rcvtrx=sum(case when stdtl.trtype in (''01'',''02'',''11'',''10'',''31'',''30'') then 
			(case when stdtl.trtype in (''01'',''11'',''10'')
			then qty+fqty else -(qty+fqty) end) else 0.00 end),
			rtntrx=sum(case  when stdtl.trtype in (''24'',''26'') then qty+fqty else 0.00 end),
			slstrx=sum(case  when stdtl.trtype in (''04'',''06'') then qty+fqty else 0.00 end),
			isstrx=sum(case when stdtl.trtype in (''05'',''09'') then (case when stdtl.trtype=''05'' then
			qty+fqty else -(qty+fqty) end) else 0.00 end),
			adjtrx=sum(case when stdtl.trtype in (''13'',''20'',''12'',''46'') then 
			(case when stdtl.trtype=''20'' and tobinno<>''+'' 
			then -qty else qty end) else 0.00 end),cast(0 as float) as prv_obal'
			if @group_factor is not null and @group_factor<>''
			set @sqlmsg=@sqlmsg+',ISNULL('+@group_factor+',''  '') as whno'
			set @sqlmsg=@sqlmsg+' from  stitems inner Join stunits left outer join  stdtl inner Join sthdr
			on stdtl.branch=sthdr.branch and stdtl.trtype=sthdr.trtype and stdtl.ref=sthdr.ref
			and sthdr.trdate between '+@lfmdate +' and '+ @ltodate
			if @trx_x is not null and @trx_x<>''
			set @sqlmsg=@sqlmsg+' and '+@trx_x

			set @sqlmsg=@sqlmsg+' on stunits.itemno=stdtl.itemno and stunits.Unicode=stdtl.Unicode
			on stitems.itemno=stunits.itemno'
			if @itm_x is not null and @itm_x<>''
			set @sqlmsg=@sqlmsg+' where '+@itm_x
			set @sqlmsg=@sqlmsg+' group by '+@group_item+','
			if @group_factor is not null and @group_factor<>''
			set @sqlmsg=@sqlmsg+'ISNULL('+@group_factor+',''  ''),'
			set @sqlmsg=@sqlmsg+'stunits.modelno,stitems.lName,pkqty1,lrcvdate,
			lastissue,stunits.lcost,stitems.splycode,stitems.msplycode,stitems.fcy,
			stunits.barcode,stunits.lprice1'
		end
		else
		begin
            set @sqlmsg ='select '+@group_item+' as mnkey, sum( stbins.openbal) as PRV_OBAL'
			if @group_factor is not null and @group_factor<>''
			set @sqlmsg=@sqlmsg+','+@group_factor+' as whno'	
			set @sqlmsg=@sqlmsg+' from stitems inner join stunits inner join stbins 
            on stunits.itemno=stbins.itemno and stunits.unicode=stbins.unicode
            on stitems.itemno=stunits.itemno'
			if @itm_x is not null and @itm_x<>''
			set @sqlmsg=@sqlmsg+' where '+@itm_x
			set @sqlmsg=@sqlmsg+' group by '+@group_item
			if @group_factor is not null and @group_factor<>''
			set @sqlmsg=@sqlmsg+','+@group_factor
		end;

		exec sp_executesql @sqlmsg;        
		if @@error<>0 set @NoOfRecords=-1 
		ELSE set @NoOfRecords=@@ROWCOUNT

END









GO
/****** Object:  StoredProcedure [dbo].[branch_ttl_purchase_only]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[branch_ttl_purchase_only]
 @lfmdate varchar(8),
 @ltodate varchar(8),
 @trx_x  nvarchar(1000),
 @itm_x  nvarchar(1000),
 @group_item nvarchar(50),
 @group_factor nvarchar(50),
 @NoOfRecords int output,
 @purchase_cndn nvarchar(1000)

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
    declare @sqlmsg nvarchar(max),
    @whereclause nvarchar(2000)='',
	@lmode int =0		 
	set @NoOfRecords=0
	set @sqlmsg =''

	    set @sqlmsg ='select '+@group_item+' as whkey,stunits.modelno as mnkey,
			purtrx=sum(case when stdtl.trtype in (''10'',''11'') then qty+fqty else 0.00 end),
			purrtn=sum(case when stdtl.trtype in (''30'',''31'') then qty+fqty else 0.00 end)'
			if @group_factor is not null and @group_factor<>''
			   set @sqlmsg=@sqlmsg+',ISNULL('+@group_factor+',''  '') as whno'
			set @sqlmsg=@sqlmsg+' from stitems inner Join stunits left outer join stdtl inner Join puhdr
			on stdtl.branch=puhdr.company and stdtl.trtype=puhdr.invtype and stdtl.ref=puhdr.ref
			and puhdr.invdate between '+@lfmdate +' and '+ @ltodate
			if @trx_x is not null and @trx_x<>''
			   set @sqlmsg=@sqlmsg+' and '+@trx_x
			if @purchase_cndn is not null and @purchase_cndn<>''
			   set @sqlmsg=@sqlmsg+' and '+@purchase_cndn
			set @sqlmsg=@sqlmsg+' on stunits.itemno=stdtl.itemno and stunits.Unicode=stdtl.Unicode
			on stitems.itemno=stunits.itemno'
			if @itm_x is not null and @itm_x<>''
			   set @sqlmsg=@sqlmsg+' where '+@itm_x
			set @sqlmsg=@sqlmsg+' group by '+@group_item+','
			if @group_factor is not null and @group_factor<>''
			   set @sqlmsg=@sqlmsg+'ISNULL('+@group_factor+',''  ''),'
			set @sqlmsg=@sqlmsg+'stunits.modelno';

		exec sp_executesql @sqlmsg;        
		if @@error<>0 set @NoOfRecords=-1 
		ELSE set @NoOfRecords=@@ROWCOUNT

END












GO
/****** Object:  StoredProcedure [dbo].[branch_ttl_shb]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[branch_ttl_shb]
 @lfmdate varchar(8),
 @ltodate varchar(8),
 @trx_x  nvarchar(1000),
 @itm_x  nvarchar(1000),
 @group_item nvarchar(50),
 @group_factor nvarchar(50),
 @NoOfRecords int output

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
    declare @sqlmsg nvarchar(max),
    @whereclause nvarchar(2000)='',
	@lmode int =0
		 
	set @lmode=@NoOfRecords
	set @NoOfRecords=0
	set @sqlmsg =''
	
	   if @lmode =0
	   begin
	    --K.A.N OCT 02,2020 CHGD MNKEY FROM stunits.modelno   TO  stunits.itemno+stunits.Unicode
		set @sqlmsg ='select '+@group_item+' as whkey,stunits.itemno+stunits.Unicode as mnkey,stitems.name as fulname,
			pkqty1,lrcvdate,lastissue,stunits.lcost,stitems.splycode,stitems.msplycode,stitems.fcy,
			stunits.barcode,stunits.lprice1,stunits.lprice2,stunits.lprice3,stunits.cmbkey,
			avgprice=sum(iif(sthdr.src=''05'',iif(stdtl.trtype in (''04'',''06''),qty*lprice,-qty*lprice),0.00)),
			avglcost=sum(iif(sthdr.src=''05'',iif(stdtl.trtype in (''04'',''06''),(qty+fqty)*stdtl.lcost,-(qty+fqty)*stdtl.lcost),0.00)),
			rcvtrx=sum(case when stdtl.trtype in (''01'') then qty+fqty else 0.00 end),
			rcvrtn=sum(case when stdtl.trtype in (''02'') then qty+fqty else 0.00 end),
			isstrx=sum(case when stdtl.trtype in (''09'') then qty+fqty else 0.00 end),
			issrtn=sum(case when stdtl.trtype in (''05'') then qty+fqty else 0.00 end),
			purtrx=sum(case when stdtl.trtype in (''10'',''11'') then qty+fqty else 0.00 end),
			purrtn=sum(case when stdtl.trtype in (''30'',''31'') then qty+fqty else 0.00 end),
			rtntrx=sum(case when stdtl.trtype in (''24'',''26'') then qty+fqty else 0.00 end),
			slstrx=sum(case when stdtl.trtype in (''04'',''06'') then qty+fqty else 0.00 end),
			adjtrx=sum(case when stdtl.trtype in (''13'',''20'',''12'',''46'') then 
			(case when stdtl.trtype=''20'' and tobinno<>''+'' 
			then -qty else qty end) else 0.00 end),
			cast(0 as float) as prv_obal'
			if @group_factor is not null and @group_factor<>''
			   set @sqlmsg=@sqlmsg+',ISNULL('+@group_factor+',''  '') as whno'
			set @sqlmsg=@sqlmsg+' from stitems inner Join stunits left outer join stdtl inner Join sthdr
			on stdtl.branch=sthdr.branch and stdtl.trtype=sthdr.trtype and stdtl.ref=sthdr.ref
			and sthdr.trdate between '+@lfmdate +' and '+ @ltodate
			if @trx_x is not null and @trx_x<>''
			   set @sqlmsg=@sqlmsg+' and '+@trx_x
			set @sqlmsg=@sqlmsg+' on stunits.itemno=stdtl.itemno and stunits.Unicode=stdtl.Unicode
			on stitems.itemno=stunits.itemno'
			if @itm_x is not null and @itm_x<>''
			   set @sqlmsg=@sqlmsg+' where '+@itm_x
			set @sqlmsg=@sqlmsg+' group by '+@group_item+','
			if @group_factor is not null and @group_factor<>''
			   set @sqlmsg=@sqlmsg+'ISNULL('+@group_factor+',''  ''),'
			set @sqlmsg=@sqlmsg+'stunits.itemno+stunits.Unicode,stitems.name,pkqty1,lrcvdate,
			lastissue,stunits.lcost,stitems.splycode,stitems.msplycode,stitems.fcy,
			stunits.barcode,stunits.lprice1,stunits.lprice2,stunits.lprice3,stunits.cmbkey'
		end
		else
		begin
           set @sqlmsg ='select '+@group_item+' as mnkey, sum(stbins.openbal) as PRV_OBAL'
			if @group_factor is not null and @group_factor<>''
			   set @sqlmsg=@sqlmsg+','+@group_factor+' as whno'	
			set @sqlmsg=@sqlmsg+' from stitems inner join stunits inner join stbins 
            on stunits.itemno=stbins.itemno and stunits.unicode=stbins.unicode
            on stitems.itemno=stunits.itemno'
			if @itm_x is not null and @itm_x<>''
			   set @sqlmsg=@sqlmsg+' where '+@itm_x
			set @sqlmsg=@sqlmsg+' group by '+@group_item
			if @group_factor is not null and @group_factor<>''
			   set @sqlmsg=@sqlmsg+','+@group_factor    
		end ;

		exec sp_executesql @sqlmsg;        
		if @@error<>0 set @NoOfRecords=-1 
		ELSE set @NoOfRecords=@@ROWCOUNT

END












GO
/****** Object:  StoredProcedure [dbo].[change_pudtl_num_to_float]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[change_pudtl_num_to_float]

 @errstatus int = 0 output

AS
BEGIN
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
		SET NOCOUNT ON


        if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pudtl' and COLUMN_NAME='price' AND DATA_TYPE='numeric')
		begin 
		    ALTER TABLE dbo.pudtl alter column price float
			if @@error<>0
			begin
				set @errstatus=-730
				return @errstatus
			end
		end

        if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pudtl' and COLUMN_NAME='cost' AND DATA_TYPE='numeric')
		begin 
		    ALTER TABLE dbo.pudtl alter column cost float
			if @@error<>0
			begin
				set @errstatus=-730
				return @errstatus
			end
		end

END











GO
/****** Object:  StoredProcedure [dbo].[check_barcode]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[check_barcode]
 @l_barcode char(20),
 @l_contr   int = 0 output ,
 @ref_id   int = 0 output ,
 @count_rows int = 0 output
	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
SELECT top 1 @ref_id=b.ref,@l_contr=b.contr FROM pos_dt A INNER JOIN pos_hd B ON a.company = b.company and a.contr =b.contr and a.ref=b.ref
 WHERE A.barcode=@l_barcode and invorrtrn='1'	
 set @count_rows=@@ROWCOUNT 
END



















GO
/****** Object:  StoredProcedure [dbo].[Check_Bfr_Generate_POS_Invoice]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-01-07@@$$##  Important : must have this line as first line which contains the last update date for the this file 
 CREATE PROCEDURE [dbo].[Check_Bfr_Generate_POS_Invoice]
	@m_cmp char(2),
	@p_date char(10),
	@p_slcenter char(2),
	@p_trxtype char(1),
	@p_supermarket bit=0,
	@errstatus int output	
	AS
	BEGIN
-- 2023-11-11 AA Added new codes to fit with zatca rounding 
-- 2023-11-11 AA stopped many old codes not needed anymore
-- 2022-05-07 Stopped changing the value of vat_percent for KSA 
-- 2022-05-07 Added semi colon to the end of select statements 
-- 2022-01-14 Added @lcountry variable to hold the column of country on glcalend 
-- 2021-07-01 Added the start hours after 12 starting from 00 to 08
-- 2021-03-28 Added for sawad al-ryiadh @m_toslcenter='ZZ'  instead of '99'
-- Modified on 2020-12-02 by adding this code IIF(isnull(vat_dsc_invcalc,0)=0 or (isnull(vat_dsc_invcalc,0)=1 and pricevattype<=1) ,invdsvl,0)
-- Added on 2020-07-28 new code to fixed bad vat_amt_rcvd 
-- Modified on 2020-07-28 to fix the bug if vat_percent between 6 and 13 force them to 15
		SET NOCOUNT ON
	    declare @lslcenter char(2),
	  	    @linvorrtrn char(1),
			@lttldtl float =0,
			@lvalafds float =0,
			@lpos_strt_h numeric(1,0)=5,
			@pos_fm_hour char(8),
			@pos_to_hour char(8),
			@is_dsc_amt bit =0,
			@lmultibarcode bit =0,
			@syscode int =0,
			@lpricevattype numeric(1,0)=1

        set @errstatus=0

		declare  @m_type char(2),
				@m_ref  numeric(6,0),
				@fm_datetime datetime,
				@to_datetime datetime,
				@m_fmtrxtype char(1),
				@m_totrxtype char(1),
				@m_fmslcenter char(2),
				@m_toslcenter char(2),
				@m_invtype char(2),
				@ltxt varchar(40),
				@lttltmp float =0,
				@lvat_percent numeric(10,3) =0
		--
		--  prepair the parameters needed for the sql statement
		--
	declare 
	@dbc nvarchar(14),
	@lcalcomp char(2),
	@yrcode char(4),
	@lno_round_nm BIT =0,
	@l_PVT_level numeric(1,0)=0,
	@lno_round bit =0,
	@lcountry int=0, -- Added on 2022-01-14
	@lzatca_rounding bit=0 -- Added on 2023-11-11 AA

	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
----------------------------------------   Modified on 2017-01-25 
    if COL_LENGTH('sysdb.dbo.glcalend','Sysno_PVT_level') is not null
		select @lno_round_nm=isnull(no_round_nm,0),@lpos_strt_h=isnull(pos_strt_h,5),@is_dsc_amt=isnull(is_dsc_amt,0),
		@lmultibarcode=isnull(multibarcode,0),@syscode=sysno,@l_PVT_level=isnull(SysNo_PVT_level,0),
		@lpricevattype=isnull(pricevattype,1),@lvat_percent=isnull(vat_percent,0),@lcountry=isnull(country,0), -- Added on 2022-01-14
		@lzatca_rounding=isnull(zatca_rounding,0) -- Added on 2023-11-11 AA
		from sysdb.dbo.glcalend 
		where calcomp=@lcalcomp and yrcode=@yrcode;
    else
		select @lno_round_nm=isnull(no_round_nm,0),@lpos_strt_h=isnull(pos_strt_h,5),@is_dsc_amt=isnull(is_dsc_amt,0),
		@lmultibarcode=isnull(multibarcode,0),@syscode=sysno,@lvat_percent=isnull(vat_percent,0),@lcountry=isnull(country,0), -- Added on 2022-01-14
		@lzatca_rounding=isnull(zatca_rounding,0) -- Added on 2023-11-11 AA
		from sysdb.dbo.glcalend 
		where calcomp=@lcalcomp and yrcode=@yrcode;
-------------------------------------------------------------------------------------		--
		if @syscode=6 or @lno_round_nm=1  set @p_supermarket = 1
		else set @p_supermarket = 0 

		set @m_fmtrxtype=@p_trxtype
		set @m_totrxtype=@p_trxtype
		if @p_trxtype='5'
		begin
			set @m_fmtrxtype='1'
			set @m_totrxtype='4'
		end
		--- sales center variables
		set @m_fmslcenter=@p_slcenter
		set @m_toslcenter=@p_slcenter
		if @p_slcenter=''
		begin
			set @m_fmslcenter='01'
			set @m_toslcenter='ZZ'  -- 2021-03-28 Added for sawad al-ryiadh 
		end
-------- Added on 2021-07-01 AA -----------------------------
		IF @lpos_strt_h=9 
		begin
		   set @pos_fm_hour='00:00:00'  
		   set @pos_to_hour='23:59:59'  
		end 
		else
		IF @lpos_strt_h=1
		begin
		   set @pos_fm_hour='01:00:00'  
		   set @pos_to_hour='00:59:59'  
		end   
		ELSE
		IF @lpos_strt_h=2
		begin
		   set @pos_fm_hour='02:00:00'  
		   set @pos_to_hour='01:59:59'  
		end   
		ELSE
		IF @lpos_strt_h=3
		begin
		   set @pos_fm_hour='03:00:00'  
		   set @pos_to_hour='02:59:59'  
		end   
		ELSE
		IF @lpos_strt_h=4 --start from 4 clock
		begin
		   set @pos_fm_hour='04:00:00'  
		   set @pos_to_hour='03:59:59'  
		end   
		ELSE
		IF @lpos_strt_h=5 or @lpos_strt_h=0
		begin
		   set @pos_fm_hour='05:00:00'  
		   set @pos_to_hour='04:59:59'  
		end   
		IF @lpos_strt_h=6
		begin
		   set @pos_fm_hour='06:00:00'  
		   set @pos_to_hour='05:59:59'  
		end   
		ELSE
		IF @lpos_strt_h=7
		begin
		   set @pos_fm_hour='07:00:00'  
		   set @pos_to_hour='06:59:59'  
		end   
		ELSE
		IF @lpos_strt_h=8
		begin
		   set @pos_fm_hour='08:00:00'  
		   set @pos_to_hour='07:59:59'  
		end   
----------------------------------------------------------		
		--  Build up the datetime needed
		--
		set @fm_datetime=cast(@p_date+' '+@pos_fm_hour as datetime)
		set @to_datetime=cast(cast(dateadd(dd,1,cast(@p_date as date)) as char(10))+' '+@pos_to_hour as datetime)

--------  Added on 2018-07-09  to update any invoice came from the counter and still working in an old infopos12.exe
        if @l_PVT_level>0
		begin
		    set @lpricevattype=iif(@lpricevattype=0,1,@lpricevattype)
			declare @l_not_uptodate int=0
---- Stopped on 202-11-11 AA ----------------------------------------------------------------------------------------------------
		--	select @l_not_uptodate=count(*) from pos_hd with (NOLOCK) where company=@m_cmp  And ref<>0 And geninv=0 and 
		--	tdatetime  between @fm_datetime and @to_datetime and invorrtrn between  @m_fmtrxtype and @m_totrxtype
		--	and slcenter between @m_fmslcenter and @m_toslcenter and 
		--	(PriceVatType is null or no_round_nm is null or discamt is null);
		--	if isnull(@l_not_uptodate,0)>0
		--	begin
		--		set @p_supermarket = 0
		--		if  @syscode=6
		--		set @p_supermarket = 1
		-----  handle the Pos_hd table 
		--		begin transaction
		--		update pos_hd set discamt=iif(dsc_amt_col>0,1,0),pricevattype=l_Pvt, 
		--		no_round_nm=iif(@p_supermarket = 1 or dsc_amt_col>0,iif(ttl_no_round=cast(c.valafds as numeric(20,5)),1,0),
		--		iif(ttl_round=cast(c.valafds as numeric(20,5)),0,1))
		--		from pos_hd c
		--		join
		--		(
		--		select a.company,a.contr,a.ref,a.valafds,l_Pvt=iif(cast(invttl+invdsvl-vat_amt_rcvd as numeric(20,5))=valafds,1,iif(@lpricevattype in (2,3),@lpricevattype,2)),
		--		ttl_no_round=sum((b.QTY*(b.price-(b.price*b.dscprsnt/100)))-isnull(offer_amt,0)) ,
		--		ttl_round=sum((b.QTY*(b.price-Floor(b.price*b.dscprsnt/100)))-isnull(offer_amt,0)),
		--		dsc_amt_col=sum(dsc_amt)
		--		from pos_hd a inner join pos_dt b
		--		on a.company=b.company and a.contr=b.contr and a.ref=b.ref
		--		where a.company=@m_cmp  And a.ref<>0 And geninv=0 and 
		--		tdatetime  between @fm_datetime and @to_datetime and invorrtrn between  @m_fmtrxtype and @m_totrxtype
		--		and slcenter between @m_fmslcenter and @m_toslcenter and 
		--		(PriceVatType is null or no_round_nm is null or discamt is null)
		--		group by a.company,a.contr,a.ref,a.valafds,invttl,invdsvl,vat_amt_rcvd) d
		--		on c.company=d.company and c.contr=d.contr and c.ref=d.ref;
		--		if @@error<>0
		--		begin
		--			rollback transaction
		--			set @errstatus=-4
		--			return @errstatus
		--		end
		--		else
		--		begin
				
		---  Fill the pos_dt taxtype column 
			begin transaction
			update pos_dt set taxtype=l_taxtype
			from pos_dt a
			join
			(select c.company,c.contr,c.ref,c.srlno,c.cmbkey,l_taxtype=iif(isnull(e.taxtype,'')='' or len(e.taxtype)=0 or e.taxtype='0','1',e.taxtype) from pos_dt c
				inner join stunits d inner join  stitems e
			on d.itemno=e.itemno
			on c.cmbkey=d.cmbkey 
			where c.taxtype is null) b
			on a.company=b.company and a.contr=b.contr and a.ref=b.ref and a.srlno=b.srlno and a.cmbkey=b.cmbkey;  
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-5
				return @errstatus
			end
			else commit transaction
			--	end
			--end

-------------------------------- Stopped on 2023-11-11 -------------------------------------------------------
-------------------------------- Added on 2019-08-29 -------------------------------------------------------
   --         set @l_not_uptodate=0
 		--	select @l_not_uptodate=count(*) from pos_hd with (NOLOCK) where company=@m_cmp  And ref<>0 And geninv=0 and 
			--tdatetime  between @fm_datetime and @to_datetime and invorrtrn between  @m_fmtrxtype and @m_totrxtype
			--and slcenter between @m_fmslcenter and @m_toslcenter and invorrtrn<>'4' 
			--and vat_amt_rcvd>0 and 
   --         cast((valafds-invdsvl-taxfree_sales)*@lvat_percent/iif(pricevattype<=1,100.00+@lvat_percent,100.00) as numeric(20,7))
			--=cast(vat_amt_rcvd as numeric(20,7));
			--if isnull(@l_not_uptodate,0)>0
			--begin
			--    begin transaction
			--	update pos_hd set pricevattype=iif(pricevattype<=1,2,1) where company=@m_cmp  And ref<>0 And geninv=0 and 
			--	tdatetime  between @fm_datetime and @to_datetime and invorrtrn between  @m_fmtrxtype and @m_totrxtype
			--	and slcenter between @m_fmslcenter and @m_toslcenter and invorrtrn<>'4' 
			--	and vat_amt_rcvd>0 and 
			--	cast((valafds-invdsvl-taxfree_sales)*@lvat_percent/iif(pricevattype<=1,100.00+@lvat_percent,100.00) as numeric(20,6))
			--	=cast(vat_amt_rcvd as numeric(20,6))
			--	if @@error<>0
			--	begin
			--		rollback transaction
			--		set @errstatus=-6
			--		return @errstatus
			--	end
			--	else commit transaction
			--end           
---------------------------------------------------------------------------------------
-------------------------------- Added on 2019-11-20 -------------------------------------------------------
            if @p_trxtype in ('1','5')
			begin
				set @l_not_uptodate=0
				select top 1 @l_not_uptodate=count(*)
				from pos_hd a inner join poscccard b 
				on a.company=b.company and a.contr=b.contr and a.ref=b.ref
				where a.company=@m_cmp And a.ref<>0  And geninv=0 and 
				tdatetime  between @fm_datetime and @to_datetime and invorrtrn='1'
				and slcenter between @m_fmslcenter and @m_toslcenter 
				group by a.company,a.contr,a.ref,a.chargeamt 
				having cast(a.chargeamt as numeric(20,6))<>cast(sum(b.chargeamt) as numeric(20,6)); 

				if isnull(@l_not_uptodate,0)>0
				begin
					begin transaction
					update pos_hd set chargeamt=cc_chargeamt
					from pos_hd t
					join
					(select a.company,a.contr,a.ref,a.chargeamt,cc_chargeamt=sum(b.chargeamt)
					from pos_hd a inner join poscccard b 
					on a.company=b.company and a.contr=b.contr and a.ref=b.ref
					where a.company=@m_cmp And a.ref<>0  And geninv=0 and 
					tdatetime  between @fm_datetime and @to_datetime and invorrtrn='1'
					and slcenter between @m_fmslcenter and @m_toslcenter 
					group by a.company,a.contr,a.ref,a.chargeamt 
					having cast(a.chargeamt as numeric(20,6))<>cast(sum(b.chargeamt) as numeric(20,6))) s
					on t.company=s.company and t.contr=s.contr and t.ref=s.ref;
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-7
						return @errstatus
					end
					else commit transaction
				end 
			end          
---------------------------------------------------------------------------------------
		end
------------------------------------------------------------------------------------------
-------------   Handle Pos_hd table 
--       set @l_not_uptodate=0
--	   if @lcountry=0  -- Added on 2022-01-14
--	   begin
--------- Stopped on 2022-05-07 AA ------------------------------
------ Added on 2020-07-28 
--			select @l_not_uptodate=count(*) from pos_hd with (NOLOCK) where company=@m_cmp  And ref<>0 And geninv=0 and 
--					tdatetime  between @fm_datetime and @to_datetime and invorrtrn between  @m_fmtrxtype and @m_totrxtype
--					and slcenter between @m_fmslcenter and @m_toslcenter and invorrtrn<>'4' 
--					and vat_amt_rcvd>0 and  (isnull(vat_percent,0)=0 or round((vat_amt_rcvd*100)/(valafds-invdsvl-taxfree_sales),0) between 6 and 13)
--			if isnull(@l_not_uptodate,0)>0
--			begin
--				begin transaction
--				update Pos_hd set vat_percent=iif(round((vat_amt_rcvd*100)/(valafds-invdsvl-taxfree_sales),0) between 6 and 13,15,round((vat_amt_rcvd*100)/(valafds-invdsvl-taxfree_sales),0))
--				where (valafds-invdsvl-taxfree_sales)>0 and company=@m_cmp  And ref<>0 And geninv=0 and 
--					tdatetime  between @fm_datetime and @to_datetime and invorrtrn between  @m_fmtrxtype and @m_totrxtype
--					and slcenter between @m_fmslcenter and @m_toslcenter and invorrtrn<>'4' 
--					and vat_amt_rcvd>0 and  (isnull(vat_percent,0)=0 or round((vat_amt_rcvd*100)/(valafds-invdsvl-taxfree_sales),0) between 6 and 13) 
--				if @@error<>0
--				begin
--					rollback transaction
--					set @errstatus=-8
--					return @errstatus
--				end	
--				commit transaction
--			end
--		end -- Added on 2022-01-14
---------------------------------------------------------------------------------====
       set @l_not_uptodate=0
---- Stopped on 202-11-11 AA ----------------------------------------------------------------------------------------------------
---- Added on 2020-07-28 
		--select @l_not_uptodate=count(*) from pos_hd with (NOLOCK) where company=@m_cmp  And ref<>0 And geninv=0 and 
		--		tdatetime  between @fm_datetime and @to_datetime and invorrtrn between  @m_fmtrxtype and @m_totrxtype
		--		and slcenter between @m_fmslcenter and @m_toslcenter and invorrtrn<>'4' 
		--		and vat_amt_rcvd>0 and  
		--		pricevattype>1 and cast(vat_amt_rcvd as numeric(20,10))<>cast((valafds-invdsvl-taxfree_sales)*cast(vat_percent as float)/(100+cast(vat_percent as float))  as numeric(20,10));
		--if isnull(@l_not_uptodate,0)>0
		--begin
		--	begin transaction
		--	update Pos_hd set vat_amt_rcvd=(valafds-invdsvl-taxfree_sales)*cast(vat_percent as float)/(100+cast(vat_percent as float))
		--	where company=@m_cmp  And ref<>0 And geninv=0 and 
		--		tdatetime  between @fm_datetime and @to_datetime and invorrtrn between  @m_fmtrxtype and @m_totrxtype
		--		and slcenter between @m_fmslcenter and @m_toslcenter and invorrtrn<>'4' 
		--		and vat_amt_rcvd>0 and  
		--		pricevattype>1 and cast(vat_amt_rcvd as numeric(20,10))<>cast((valafds-invdsvl-taxfree_sales)*cast(vat_percent as float)/(100+cast(vat_percent as float))  as numeric(20,10))
		--	if @@error<>0
		--	begin
		--		rollback transaction
		--		set @errstatus=-9
		--		return @errstatus
		--	end	
		--	commit transaction
		--end
------------------------------------------------------------------------------------------
		DECLARE pogen1 CURSOR LOCAL FAST_FORWARD FOR
		Select slcenter, invorrtrn, sum(valafds) As valafds
		from pos_hd with (NOLOCK) where company=@m_cmp  And ref<>0 And geninv=0 and 
		tdatetime  between @fm_datetime and @to_datetime and invorrtrn between  @m_fmtrxtype and @m_totrxtype
		and slcenter between @m_fmslcenter and @m_toslcenter
		group By slcenter, invorrtrn
		order By slcenter, invorrtrn;

		open pogen1;
		set @errstatus=0;
		fetch next from pogen1 into @lslcenter,@linvorrtrn,@lvalafds;		

		WHILE @@FETCH_STATUS = 0
		BEGIN
		    if @linvorrtrn<>'4'
			begin
			    if @l_PVT_level=0 and @lzatca_rounding=0
				begin
					if @p_supermarket=1 
					begin
						Select @lttldtl=sum(qty*(price-(price*dscprsnt/100))-isnull(offer_amt,0))
						from  pos_hd with (NOLOCK) inner Join pos_dt with (NOLOCK)  
						on  pos_hd.company = pos_dt.company and pos_hd.Contr = pos_dt.Contr and pos_hd.ref = pos_dt.ref
						where pos_hd.company=@m_cmp and pos_hd.slcenter=@lslcenter and invorrtrn=@linvorrtrn
						And pos_hd.geninv=0 And  not (RTRIM(pos_dt.cmbkey)='' Or RTRIM(pos_dt.barcode)='') and
						tdatetime  between @fm_datetime and @to_datetime;
					end
					else
					if @is_dsc_amt = 0
					begin
						Select @lttldtl=sum(qty*(price-cast(price*dscprsnt/100 as int))-isnull(offer_amt,0))
						from  pos_hd with (NOLOCK) inner Join pos_dt with (NOLOCK) 
						on  pos_hd.company = pos_dt.company and pos_hd.Contr = pos_dt.Contr and pos_hd.ref = pos_dt.ref
						where pos_hd.company=@m_cmp and pos_hd.slcenter=@lslcenter and invorrtrn=@linvorrtrn
						And pos_hd.geninv=0 And  not (RTRIM(pos_dt.cmbkey)='' Or RTRIM(pos_dt.barcode)='') and
						tdatetime  between @fm_datetime and @to_datetime;
					end
					else
					begin
						Select @lttldtl=sum(qty*(price-dsc_amt)-isnull(offer_amt,0))
						from  pos_hd with (NOLOCK) inner Join pos_dt with (NOLOCK) 
						on  pos_hd.company = pos_dt.company and pos_hd.Contr = pos_dt.Contr and pos_hd.ref = pos_dt.ref
						where pos_hd.company=@m_cmp and pos_hd.slcenter=@lslcenter and invorrtrn=@linvorrtrn
						And pos_hd.geninv=0 And  not (RTRIM(pos_dt.cmbkey)='' Or RTRIM(pos_dt.barcode)='') and
						tdatetime  between @fm_datetime and @to_datetime;
					end
				end
				else
				begin
				
						Select @lttldtl=sum(iif(isnull(zatca_rounding,0)=0,qty*(price-iif(discamt=1,dsc_amt,iif(no_round_nm=1,(price*dscprsnt/100),
						floor(price*dscprsnt/100))))-isnull(offer_amt,0),qty*item_price_net)),
						@lttltmp=sum(iif(isnull(zatca_rounding,0)=0,iif(discamt=1,qty*(price-(price*dscprsnt/100))-isnull(offer_amt,0),0),0))
						from  pos_hd with (NOLOCK) inner Join pos_dt with (NOLOCK)  
						on  pos_hd.company = pos_dt.company and pos_hd.Contr = pos_dt.Contr and pos_hd.ref = pos_dt.ref
						where pos_hd.company=@m_cmp and pos_hd.slcenter=@lslcenter and invorrtrn=@linvorrtrn
						And pos_hd.geninv=0 And  not (RTRIM(pos_dt.cmbkey)='' Or RTRIM(pos_dt.barcode)='') and
						tdatetime  between @fm_datetime and @to_datetime;
				end
				set @lttldtl=isnull(@lttldtl,0)
				--2019-01-1l fix the bug of matrix
				if dbo.value_balanced(@lttldtl,@lvalafds)=0
				begin
				   if @lttltmp>0
				   begin
						if dbo.value_balanced(@lttltmp,@lvalafds)=0
						begin
						  set @errstatus=-1
						  break
						end
				   end
				   else
				   begin
					  set @errstatus=-1
					  break
				  end
				end
			end  -- end of @linvorrtrn<>'4'
			fetch next from pogen1 into @lslcenter,@linvorrtrn,@lvalafds;
		end  -- end of while loop
		close pogen1
		deallocate pogen1
		return @errstatus
    end


GO
/****** Object:  StoredProcedure [dbo].[chk_due_invbal]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[chk_due_invbal]

 @l_company char(2),
 @l_cucode char(6),
 @l_fcy char(3),
 @l_alwprd int ,
 @l_action bit , -- 0 = only invoice due balace (default) 1= returned cursor with invoices due details
 @l_balrmn float=0 output
 	
AS
BEGIN
		
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
		SET NOCOUNT ON;
		declare @dbc varchar(20),
				@is_it_hij bit=0
		declare @ldate varchar(10)='',
				@lfdate varchar(8)=''
        set @l_balrmn=0

		set @dbc=db_name()
		SET @is_it_hij=iif(cast(substring(@dbc,7,2) as int)>30,1,0)
		if @is_it_hij=1
		begin
			set @ldate =convert(varchar(10),dateadd(dd,-@l_alwprd,getdate()),131)
			set @lfdate=substring(@ldate,7,4)+substring(@ldate,4,2)+iif(substring(@ldate,1,1)=' ','0'+substring(@ldate,2,1),substring(@ldate,1,2))
		end
		else
			set @lfdate = convert(varchar(10),dateadd(dd,-@l_alwprd,getdate()),112)
        if @l_action=0
		begin
			select @l_balrmn=sum(dt_lcamt-dt_discamt-dt_lcaloc)  from ardtl
			where dt_company=@l_company and dt_cucode=@l_cucode and dt_fcy=@l_fcy and dt_type='04'
			and dt_aloctd<'2' and dt_date<@lfdate   
			set @l_balrmn=isnull(@l_balrmn,0)
		end
		else
		begin
			select dt_ref,dt_lcamt-dt_discamt as invttl,dt_date,dt_duedate,dt_lcamt-dt_discamt-dt_lcaloc as invduebal  from ardtl
			where dt_company=@l_company and dt_cucode=@l_cucode and dt_fcy=@l_fcy and dt_type='04'
			and dt_aloctd<'2' and dt_date<@lfdate order by dt_date  
			set @l_balrmn=@@ROWCOUNT		
		end 
END

















GO
/****** Object:  StoredProcedure [dbo].[convert_items2PDA_csv]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[convert_items2PDA_csv]
 @itemsfile varchar(100),
 @STR_MSG varchar(400) output ,
 @errstatus int = 0 output
	
AS
BEGIN
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
			SET NOCOUNT ON
	begin try
		declare @sqlquery varchar(300)
		declare @sql varchar(8000)
		declare @dbc varchar(20)
		set @dbc=db_name()
		--declare @itemscsv varchar(100)='c:\bcp\sysobjects.csv'

		select @sqlquery='select stitems.name,stunits.itemno,unicode,cmbkey,barcode,pkqty1,pack0,lprice1 from stitems  inner join stunits  on stitems.itemno=stunits.itemno'

		select @sql = 'bcp "'+@sqlquery+' " queryout '+@itemsfile+' -c -d '+@dbc+' -w  -t, -U SA -P infocic -S'+ @@servername
		exec master..xp_cmdshell @sql
		return @errstatus
	END TRY
	BEGIN CATCH
	    
		SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () 

		SET @errstatus = -99
		RETURN -99
	END CATCH
end









GO
/****** Object:  StoredProcedure [dbo].[copy_data_from_old_database]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[copy_data_from_old_database]
 @dbc nvarchar(50),
 @errstatus int = 0  output
	
AS
BEGIN
	declare @sqlmsg nvarchar(max)='',
	@tbl nvarchar(50)=''
    set @errstatus=0

	---- 
	---------------------  Move ITEMS from Last year for STITEMS 
	----
	
	set @tbl=@dbc+'STITEMS as s '
	set @sqlmsg='merge STITEMS as t '
	set  @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on  t.itemno=s.itemno'
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+'insert values (s.name,s.itemno,s.mgroup,s.sgroup,s.category,s.fcy,s.classkey,s.exdatealw,s.noofsbitem,s.modified, '	
	set @sqlmsg= @sqlmsg+' s.sgroup3,s.sgroup4,s.company,s.lname,s.country,s.season,s.splycode,s.splylcact,s.itemtype,s.prntasmitm,s.prmdesc,'	
	set @sqlmsg= @sqlmsg+'s.scndesc,s.cmpprcnt,s.dsctype,s.brand_id,s.msplycode,s.modelno,s.nosales,s.vprice,s.fix_barcode,s.taxtype);'	

	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end
	else commit transaction

	

	---- 
	---------------------  Move open balance from Last year for STUNITS 
	----
	set @tbl=@dbc+'stunits as s '
	set @sqlmsg='merge stunits as t '
	set  @sqlmsg= @sqlmsg+' using '+@tbl
	set  @sqlmsg= @sqlmsg+' on  t.itemno=s.itemno and t.unicode=s.unicode '
	set  @sqlmsg= @sqlmsg+' when not matched then '
	set  @sqlmsg= @sqlmsg+' insert values (s.name,s.itemno,s.unicode,s.moved,s.openlcost,s.lcost,'
	   + ' s.lprice1,s.fprice1,s.maxdisc1,s.lprice2,s.fprice2,s.maxdisc2,'
	set  @sqlmsg= @sqlmsg+'s.lprice3,s.fprice3,s.maxdisc3,s.openfcost,s.fcost,s.lrcvdate,s.lastissue,'
	   + ' s.openbal,s.curbal,s.rsvqty,s.minstk,s.maxstk,'
	set  @sqlmsg= @sqlmsg+'s.orderlevel,s.leadday,s.Xdecimal,s.barcode,s.pack1,s.pkqty1,s.pack2,s.pkqty2,'
	   + ' s.pack3,s.pkqty3,s.company,'
	set  @sqlmsg= @sqlmsg+'s.modified,s.pack0,s.packtp,s.scnname,s.crtdate,s.inactive,s.prmcode,s.scncode,'
	   + 's.cmbkey,s.mnmprice,'
	set  @sqlmsg= @sqlmsg+'s.lastupdt,s.modelno,s.splyitemno,s.splyinv,s.invprice,s.invqty,s.invpk,s.pp2,s.pp3);'

		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-6
			return 
		end
		else commit transaction

	set @tbl=@dbc+'stbins as s '
	set @sqlmsg='merge stbins as t '
	set  @sqlmsg= @sqlmsg+' using '+@tbl
	+ ' on t.branch=s.branch and t.itemno=s.itemno and t.unicode=s.unicode and t.whno=s.whno and t.binno=s.binno' 
	+ ' when not matched then '
	+ ' insert values (s.branch,s.itemno,s.unicode,s.whno,s.binno,s.qty,s.rsvqty,s.openbal,s.lcost,s.fcost,s.openlcost,'
	+ ' s.openfcost,s.expdate);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-6
			return 
		end
		else commit transaction
	---- 
	---------------------  Move Photos from Last year for stitmphoto 
	----
	set @tbl=@dbc+'stitmphoto as s '
	set @sqlmsg='merge stitmphoto as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.itemno=s.itemno and t.unicode=s.unicode '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert (itemno,unicode,remarks,ipicture)
	                       values (s.itemno,s.unicode,s.remarks,s.ipicture);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-8
			return 
		end
		else commit transaction

    ---- 
	---------------------  Move records from Last year for stasmbld 
	----
	set @tbl=@dbc+'stasmbld as s '
	set @sqlmsg='merge stasmbld as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.itemno=s.itemno and t.unicode=s.unicode  and t.asmitemno=s.asmitemno and t.asmunicode=s.asmunicode  '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert (itemno,unicode,asmitemno,asmunicode,cmbkey,qtyneeded)
	                       values (s.itemno,s.unicode,s.asmitemno,s.asmunicode,s.cmbkey,s.qtyneeded);'
	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end
	else commit transaction

   ---- 
	---------------------  Move records from Last year for pricehst 
	----
	set @tbl=@dbc+'pricehst as s '
	set @sqlmsg='merge pricehst as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	+ ' on t.cmbkey=s.cmbkey '
	+ ' when not matched then '
	+ ' insert (prcode ,oldprice ,newprice ,tdate ,usrid ,qty ,cmbkey ,company ,xitemkey'
    + ' ,modified ,slcenter ,promotion ,prm_start ,prm_end)
	    values (s.prcode ,s.oldprice ,s.newprice ,s.tdate ,s.usrid ,s.qty ,s.cmbkey ,s.company ,s.xitemkey'
    + ' ,s.modified ,s.slcenter ,s.promotion ,s.prm_start ,s.prm_end);'

	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end
	else commit transaction
	---- 
	---------------------  Move records from Last year for STOFFERS 
	----
	set @tbl=@dbc+'STOFFERS as s '
	set @sqlmsg='merge STOFFERS as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.barcode=s.barcode '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert (itemno,unicode,barcode,DiscountP,disctype,MinQty,GivenAmt,
	                       StartDate,EndDate,InActive,lastupdt,Max2buy,lprice1,itemgroup)
	                       values (s.itemno,s.unicode,s.barcode,s.DiscountP,s.disctype,s.MinQty,s.GivenAmt,
	                       s.StartDate,s.EndDate,s.InActive,s.lastupdt,s.Max2buy,s.lprice1,s.itemgroup);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-10
			return 
		end
		else commit transaction

	---- 
	---------------------  Move records from Last year for STITEMBC 
	----

			set @tbl=@dbc+'STITEMBC as s '
			set @sqlmsg='merge STITEMBC as t '
			set @sqlmsg= @sqlmsg+' using '+@tbl
			set @sqlmsg= @sqlmsg+' on t.pbarcode=s.pbarcode '
			set @sqlmsg= @sqlmsg+' when not matched then '
			set @sqlmsg= @sqlmsg+' insert values (s.pbarcode,s.itemno,s.unicode,s.cmbkey,s.pack,s.pkqty,s.lprice1,s.weight,s.mnmprice,s.itext,s.litext,s.pkorder,s.lastrcvd,s.lprice2);'
				begin transaction
				exec sp_executesql @sqlmsg
				if @@error<>0
				begin
					rollback transaction
					set @errstatus=-11
					return 
				end
				else commit transaction
	

	---- 
	---------------------  Move records from Last year for stbrprice
	----

		set @tbl=@dbc+'stbrprice as s '
		set @sqlmsg='merge stbrprice as t '
		set @sqlmsg= @sqlmsg+' using '+@tbl
		set @sqlmsg= @sqlmsg+' on t.company=s.company and t.slcenter=s.slcenter and t.itemno=s.itemno and t.unicode=s.unicode '
		set @sqlmsg= @sqlmsg+' when not matched then '
		set @sqlmsg= @sqlmsg+' insert values (s.company,s.slcenter,s.itemno,s.unicode,s.lprice1,s.lprice2,s.lprice3,'
		+ 's.maxdisc1,s.maxdisc2,s.maxdisc3,s.mnmprice,s.pprice1,s.pprice2,s.pprice3,s.modelno,s.promotion,s.prm_start,s.prm_end,'
		+ 's.slsprsnt,s.fprice1,s.fprice2,s.fprice3,s.modified,s.lastupdt);'
			begin transaction
			exec sp_executesql @sqlmsg
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-12
				return 
			end
			else commit transaction
	  
	---- 
	---------------------  Move records from Last year for STCOMMISSION 
	----
	set @tbl=@dbc+'STCOMMISSION as s '
	set @sqlmsg='merge STCOMMISSION as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.itemno=s.itemno and t.unicode=s.unicode '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.itemno,s.unicode,s.commtype,s.commission,s.cmntarget,s.InActive,s.cmsn_onQty);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-13
			return 
		end
		else commit transaction
	---- 
	---------------------  Move records from Last year for stitemrp 
	----
	set @tbl=@dbc+'stitemrp as s '
	set @sqlmsg='merge stitemrp as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.itemno=s.itemno and t.unicode=s.unicode  and t.rplitemno=s.rplitemno and t.rplunicode=s.rplunicode  '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.itemno,s.unicode,s.rplitemno,s.rplunicode,s.cmbkey,s.rplorder,s.lastupdt);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-14
			return 
		end
		else commit transaction
	---- 
	---------------------  Move records from Last year for stqtybc 
	----
	set @tbl=@dbc+'stqtybc as s '
	set @sqlmsg='merge stqtybc as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.barcode=s.barcode '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.barcode,s.cmbkey,s.lastupdt);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-15
			return 
		end
		else commit transaction
	---- 
	---------------------  Move records from Last year for stcrtpuinv 
	----
	set @tbl=@dbc+'stcrtpuinv as s '
	set @sqlmsg='merge stcrtpuinv as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.branch=s.branch and t.splycode=s.splycode and t.fcy=s.fcy and t.splyinv=s.splyinv and t.itemno=s.itemno '
	+ ' and t.unicode=s.unicode'
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert (branch, splycode, fcy, splyinv, itemno, unicode, dbxyr, idate, lastupdt, rplct_post,slcode)
	values (s.branch,s.splycode,s.fcy,s.splyinv,s.itemno,s.unicode,s.dbxyr,s.idate,s.lastupdt,s.rplct_post,s.slcode);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-16
			return 
		end
		else commit transaction
	---- 
	---------------------  Move records from Last year for stwhous
	----
	set @tbl=@dbc+'stwhous as s '
	set @sqlmsg='merge stwhous as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.whno=s.whno '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert (name, whno, branch, manager, phone, address, lastupdt, srwhs, modified, lname, fax,
	 prnt_fsh, ac_end_prd, cstcode, no_autosales)
	 values (s.name,s.whno,s.branch,s.manager,s.phone,s.address,s.lastupdt,s.srwhs,s.modified,
	        s.lname,s.fax,s.prnt_fsh,s.ac_end_prd,s.cstcode, s.no_autosales);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-17
			return 
		end
		else commit transaction
	---- 
	---------------------  Move records from Last year for stclass
	----
	set @tbl=@dbc+'stclass as s '
	set @sqlmsg='merge stclass as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.cmbkey=s.cmbkey '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.name,s.cmbkey,s.mgroup,s.sgroup,s.category,s.sercsh,s.sercrd,s.serrch,s.serrcr,
	        s.serdsc,s.serpcsh,s.serpcrd,s.serprch,s.serprcr,s.serpdsc,s.sgroup3,s.sgroup4,s.modified,s.pkey,s.chkey,
			s.lname,s.lastupdt);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-18
			return 
		end
		else commit transaction
    ---- 
	---------------------  Move records from Last year for stprice
	----
	set @tbl=@dbc+'stprice as s '
	set @sqlmsg='merge stprice as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.code=s.code '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.name,s.code,s.disc,s.lprice,s.fprice,s.minsal,s.maxsal,s.modified,s.lname,
			s.lastupdt);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-19
			return 
		end
		else commit transaction
	---- 
	---------------------  Move records from Last year for stbranch
	----
	set @tbl=@dbc+'stbranch as s '
	set @sqlmsg='merge stbranch as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.brnno=s.brnno '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert (name, brnno, govrn, city, area, cmbkey, company, cashser, modified,
			bcserial, jv_01, jv_02, jv_03, jv_04, jv_05, jv_06, jv_07, jv_08, jv_09, jv_10, jv_11, jv_12,
			jv_13, jv_14, jv_18, jv_19, jv_20, jv_21, jv_22, 
			jv_23, jv_24, jv_26, jv_27, jv_28, jv_30, jv_31, jv_32, jv_33, jv_34, calgl, calar, calap,
			calst, srdiff, lname, lastupdt, jv_45, stkxtoser, stkxfmser, baddress, lbaddress, phone, fax,
			jv_17, jv_16, jv_46, dscalwser, 
			dscernser, jv_101, manualser, smsdispname, smsuser, smsfooter, rebate_act,pricetp,rebate_loss)
	values (s.name,s.brnno,s.govrn,s.city,s.area,s.cmbkey,s.company,s.cashser,s.modified,
	        s.bcserial,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
			s.srdiff,s.lname,s.lastupdt,1,s.stkxtoser,s.stkxfmser,s.baddress,s.lbaddress,s.phone,s.fax,1,1,1,
			s.dscalwser,s.dscernser,1,s.manualser,s.smsdispname,s.smsuser,s.smsfooter,s.rebate_act,s.pricetp,s.rebate_loss);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-20
			return 
		end
		else commit transaction
   ---- 
	---------------------  Move records from Last year for starea
	----
	set @tbl=@dbc+'starea as s '
	set @sqlmsg='merge starea as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.cmbkey=s.cmbkey '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.name,s.cmbkey,s.govrn,s.city,s.region,s.modified,s.lname,s.lastupdt,s.pkey,
			s.chkey);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-21
			return 
		end
		else commit transaction
   
    ---- 
	---------------------  Move records from Last year for stbrand
	----
	set @tbl=@dbc+'stbrand as s '
	set @sqlmsg='merge stbrand as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.brand_id=s.brand_id '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.brand_id,s.name,s.lname);'
	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-22
		return 
	end
	else commit transaction

    ---- 
	---------------------  Move records from Last year for SYSUSE
	----
	set @tbl=@dbc+'sysuse as s '
	set @sqlmsg='merge sysuse as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.username=s.username '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert (username, formkey, formsel, formname, password, fullname, showcost, acssdisc,
		chgprice, acssfqty, undrcost, undrmin, belowbal, grp, company, uchgpas, shwacprtct, useprice1, useprice2, 
		useprice3, maxdsc, maxfqty, currate, usrbrn, msuser, uspright, uswhalw, uscntralw, usdptalw,
		uslatin, usslcsh, usslcrd, usslrcsh, usslrcrd, uspucsh, uspucrd, uspurcsh, uspurcrd, usjv,
		usrcv, usiss, uschqrcv, 
		uschqiss, ustrnsin, ustrnsout, usbnkin, uscredit, usdebit, ussuspend, actallow, openallow, 
		cstallow, editothers, suspend, usalwchgprs, dsplyothers, chgperiod, chgtdate, alwprntrpt, printinv,
		printtrx, printbarcode, onlinepost, showitmcst, usmagnetic, sendsms, usslprofit, posuser,
		inv_form_no, ushide_jv, uschdlcshinv, uschdlcshrcv, uschdlchqrcv, usshowprofit, goblwmnmp,
		usfpalw, usfpimage, mobileuser, confirmPurchase, noovrdrft, onlyactrmt, confirmbr, passwordPDA,
		confirmtrnsfr, nopriceblwcost,mobilNo,OTP,web_rights,mgmtcnfrm,NorgstrNoSl)
	values (s.username,s.formkey,s.formsel,s.formname,s.password,s.fullname,s.showcost,s.acssdisc
		,s.chgprice,s.acssfqty,s.undrcost,s.undrmin,s.belowbal,s.grp,s.company,s.uchgpas,s.shwacprtct
		,s.useprice1,s.useprice2,s.useprice3,s.maxdsc,s.maxfqty,s.currate,s.usrbrn,s.msuser,s.uspright
		,s.uswhalw,s.uscntralw,s.usdptalw,s.uslatin,s.usslcsh,s.usslcrd,s.usslrcsh,s.usslrcrd
		,s.uspucsh,s.uspucrd,s.uspurcsh,s.uspurcrd,s.usjv,s.usrcv,s.usiss,s.uschqrcv,s.uschqiss
		,s.ustrnsin,s.ustrnsout,s.usbnkin,s.uscredit,s.usdebit,s.ussuspend,s.actallow,s.openallow
		,s.cstallow,s.editothers,s.suspend,s.usalwchgprs,s.dsplyothers,s.chgperiod,s.chgtdate
		,s.alwprntrpt,s.printinv,s.printtrx,s.printbarcode,s.onlinepost,s.showitmcst
		,s.usmagnetic,s.sendsms,s.usslprofit,s.posuser,s.inv_form_no,s.ushide_jv,s.uschdlcshinv
		,s.uschdlcshrcv,s.uschdlchqrcv,s.usshowprofit,s.goblwmnmp,s.usfpalw,s.usfpimage,
		s.mobileuser, s.confirmPurchase, s.noovrdrft, s.onlyactrmt, s.confirmbr, s.passwordPDA,
		s.confirmtrnsfr, s.nopriceblwcost,s.mobilNo,s.OTP,s.web_rights,s.mgmtcnfrm,s.NorgstrNoSl);'

	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-22
		return 
	end
	else commit transaction	
--------------------------------------------------------------------------------------------------------
----------------------------------  Transaction File Transfer  -----------------------------------------
---------------------------------------------------------------------------------------------------------

	set @tbl=@dbc+'sthdr as s '
	set @sqlmsg='merge sthdr as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	+ ' on t.branch=s.branch and t.trtype=s.trtype and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert (branch,trtype,ref,trdate,text,amnttl,costttl,sysdate,src,released'
    + ' ,posted,fcy,fcyrate,whno,entries,lastupdt,towhno,modified,rcvdtrn,custno'
    + ' ,usrid,brsupp,tobrno,brxref,glref,isbrtrx,asmtype,repost)
	    values (s.branch,s.trtype,s.ref,s.trdate,s.text,s.amnttl,s.costttl,s.sysdate,s.src,s.released'
    + ' ,s.posted,s.fcy,s.fcyrate,s.whno,s.entries,s.lastupdt,s.towhno,s.modified,s.rcvdtrn,s.custno'
    + ' ,s.usrid,s.brsupp,s.tobrno,s.brxref,s.glref,s.isbrtrx,s.asmtype,s.repost);'
	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-23
		return 
	end
	else commit transaction

	set @tbl=@dbc+'stdtl as s '
	set @sqlmsg='merge stdtl as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl	
	+ ' on t.branch=s.branch and t.trtype=s.trtype and t.ref=s.ref and t.folio=s.folio'
	+ ' when not matched then '
	+ ' insert (itemno,unicode ,branch,trtype,qty,fqty,whno ,binno ,lcost,'
	+ ' trdate,ref,sysdate,src,lprice ,fcost,fprice,expdate,towhno ,tobinno,barcode'
    + ' ,cmbkey,discpc,pack,shdpk,shdqty,folio,rplct_post)
	    values (s.itemno,s.unicode ,s.branch,s.trtype,s.qty,s.fqty,s.whno ,s.binno ,s.lcost,'
	+ ' s.trdate,s.ref,s.sysdate,s.src,s.lprice ,s.fcost,s.fprice,s.expdate,s.towhno ,s.tobinno,s.barcode'
    + ' ,s.cmbkey,s.discpc,s.pack,s.shdpk,s.shdqty,s.folio,s.rplct_post);'
	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-24
		return 
	end
	else commit transaction
	
	set @tbl=@dbc+'sales_hd as s '
	set @sqlmsg='merge sales_hd as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl	
	+ ' on t.company=s.company and t.invtype=s.invtype and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert (slcenter,branch,company,invtype,ref,invdate,custno,custnm,glser'
    + ' ,dsctype,pstmode,fcy,fcyrate,duedate,invttl,invcst,invdspc,invdsvl'
    + ' ,valafds,invpaid ,caser ,entries ,released ,posted ,fixrate ,extamt,extser'
    + ' ,pricetp ,ischeque ,chkno ,chkdate,lastupdt,jvgenrt ,cccommsn,belowbal ,fcy2'
    + ' ,ccpayment ,rplsamt,pdother ,slcode ,prpaidamt ,instldays ,instflag ,slcmnd'
    + ' ,inv_printed ,bendit ,modified,rqstorder,rqststld ,carrier,rcvdtrn ,usrid'
    + ' ,address,suspend ,rtnref ,ispurchase ,stkjvno ,posinv,sanedcrd_amt,rtncash_dfrpl
	     ,invlocked,remarks2,remarks,vat_amt_rcvd,taxfree_sales,clnt_taxcode,clnt_kind,hlldscnt,
		 sysno,No_round_nm,PriceVatType)
	    values (s.slcenter,s.branch,s.company,s.invtype,s.ref,s.invdate,s.custno,s.custnm,s.glser'
    + ' ,s.dsctype,s.pstmode,s.fcy,s.fcyrate,s.duedate,s.invttl,s.invcst,s.invdspc,s.invdsvl'
    + ' ,s.valafds,s.invpaid ,s.caser ,s.entries ,s.released ,s.posted ,s.fixrate ,s.extamt,s.extser'
    + ' ,s.pricetp ,s.ischeque ,s.chkno ,s.chkdate,s.lastupdt,s.jvgenrt ,s.cccommsn,s.belowbal ,s.fcy2'
    + ' ,s.ccpayment ,s.rplsamt,s.pdother ,s.slcode ,s.prpaidamt ,s.instldays ,s.instflag ,s.slcmnd'
    + ' ,s.inv_printed ,s.bendit ,s.modified,s.rqstorder,s.rqststld ,s.carrier,s.rcvdtrn ,s.usrid'
    + ' ,s.address,s.suspend ,s.rtnref ,s.ispurchase ,s.stkjvno ,s.posinv,s.sanedcrd_amt,s.rtncash_dfrpl,
	    s.invlocked,s.remarks2,s.remarks,s.vat_amt_rcvd,s.taxfree_sales,s.clnt_taxcode,s.clnt_kind,s.hlldscnt
		,s.sysno,s.No_round_nm,s.PriceVatType);'	
	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-24
		return 
	end
	else commit transaction

	set @tbl=@dbc+'sales_dt as s '
	set @sqlmsg='merge sales_dt as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	+ ' on t.company=s.company and t.invtype=s.invtype and t.ref=s.ref and t.folio=s.folio '
	+ ' when not matched then '
	+ ' insert (slcenter,company,invtype,ref,invdate,itemno,unicode,qty,fqty,price'
    + ' ,discpc,cost,ds_acfm ,sl_acfm ,gclass ,custno ,fcy ,barcode ,imfcval ,pack'
    + ' ,pkqty ,shadd ,shdpk,shdqty,frtqty,rtnqty,whno ,cmbkey,folio,rplct_post,sold_item_status,taxtype)
	    values (s.slcenter,s.company,s.invtype,s.ref,s.invdate,s.itemno,s.unicode,s.qty,s.fqty,s.price'
    + ' ,s.discpc,s.cost,s.ds_acfm ,s.sl_acfm ,s.gclass ,s.custno ,s.fcy ,s.barcode ,s.imfcval ,s.pack'
    + ' ,s.pkqty ,s.shadd ,s.shdpk,s.shdqty,s.frtqty,s.rtnqty,s.whno ,s.cmbkey,s.folio,s.rplct_post,
	    s.sold_item_status,s.taxtype);'
	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-25
		return 
	end
	else commit transaction

	set @tbl=@dbc+'puhdr as s '
	set @sqlmsg='merge puhdr as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	+' on t.company=s.company and t.invtype=s.invtype and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert (slcenter ,branch ,company ,invtype ,ref ,invdate,custno ,custnm ,'
	+ ' glser ,dsctype ,pstmode ,fcy ,fcyrate ,duedate ,invttl ,invcst ,invdspc ,invdsvl,'
	+ ' valafds ,invpaid,caser ,entries ,released ,posted ,fixrate,spply_exp,pricetp ,'
	+ ' isglact ,chkno ,chkdate ,lastupdt,jvgenrt ,imfcval ,lcser ,frieght ,insurexp ,'
	+ ' customfee ,portexp ,samplexp,lcinvexp ,fcinvexp ,lcothrexp ,fineexp ,lcttlexp ,'
	+ ' fcttlexp ,tktexp ,freexp ,transexp'
    + ' ,prodrate ,isl_c ,binno ,aprxcst ,aprxpc ,aprxser ,expser ,modified ,splyinv ,isorder'
    + ' ,settled ,rcvdtrn ,fcothrexp,usrid ,jvdsc ,paylcl ,tdscpcs ,tdscdays ,'
	+ ' orderno,slcode,lccode,EDM, gntd_fm_lc,lc_ship_no, xfr_amt, xfr_acc,vat_amt_paid,VatNot4Vender,
	    taxfree_purchase,vndr_taxcode,expns4vat,tax_Pd_mthd,vndr_kind,manulvat,
		dscamt_type,hlldscnt,PriceIncludeVat) 
	    values (s.slcenter ,s.branch ,s.company ,s.invtype ,s.ref ,s.invdate,s.custno ,s.custnm ,'
	+ ' s.glser ,s.dsctype ,s.pstmode ,s.fcy ,s.fcyrate ,s.duedate ,s.invttl ,s.invcst ,s.invdspc ,s.invdsvl,'
	+ ' s.valafds ,s.invpaid,s.caser ,s.entries ,s.released ,s.posted ,s.fixrate,s.spply_exp,s.pricetp ,'
	+ ' s.isglact ,s.chkno ,s.chkdate ,s.lastupdt,s.jvgenrt ,s.imfcval ,s.lcser ,s.frieght ,s.insurexp ,'
	+ ' s.customfee ,s.portexp ,s.samplexp,s.lcinvexp ,s.fcinvexp ,s.lcothrexp ,s.fineexp ,s.lcttlexp ,'
	+ ' s.fcttlexp ,s.tktexp ,s.freexp ,s.transexp'
    + ' ,s.prodrate ,s.isl_c ,s.binno ,s.aprxcst ,s.aprxpc ,s.aprxser ,s.expser ,s.modified ,s.splyinv ,s.isorder'
    + ' ,s.settled ,s.rcvdtrn ,s.fcothrexp,s.usrid ,s.jvdsc ,s.paylcl ,s.tdscpcs ,s.tdscdays ,'
	+ ' s.orderno,s.slcode,s.lccode,s.EDM,s.gntd_fm_lc,s.lc_ship_no,s.xfr_amt,s.xfr_acc,
	    s.vat_amt_paid,s.VatNot4Vender,s.taxfree_purchase,s.vndr_taxcode,s.expns4vat,s.tax_Pd_mthd,s.vndr_kind,
		s.manulvat,s.dscamt_type,s.hlldscnt,s.PriceIncludeVat);'
	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-26
		return 
	end
	else commit transaction
	
	set @tbl=@dbc+'pudtl as s '
	set @sqlmsg='merge pudtl as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	+ ' on t.company=s.company and t.invtype=s.invtype and t.ref=s.ref and t.folio=s.folio'
	+ ' when not matched then '
	+ ' insert (slcenter,company,invtype,ref, invdate ,itemno ,unicode ,qty ,fqty ,price'
    + ' ,discpc ,cost,ds_acfm ,sl_acfm ,gclass ,custno ,fcy ,barcode ,imfcval ,pack,pkqty'
    + ' ,expdate ,binno ,shdqty,shdpk ,shadd,frtqty ,cmbkey ,folio,rplct_post,edm_value,whno,splyinv,garntee_amt,taxtype)
	    values (s.slcenter,s.company,s.invtype,s.ref, s.invdate ,s.itemno ,s.unicode ,s.qty ,s.fqty ,s.price'
    + ' ,s.discpc ,s.cost,s.ds_acfm ,s.sl_acfm ,s.gclass ,s.custno ,s.fcy ,s.barcode ,s.imfcval ,s.pack,s.pkqty'
    + ' ,s.expdate ,s.binno ,s.shdqty,s.shdpk ,s.shadd,s.frtqty ,s.cmbkey ,s.folio,s.rplct_post,s.edm_value,s.whno,s.splyinv
	    ,s.garntee_amt,s.taxtype);'	
	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-27
		return 
	end
	else commit transaction

	set @tbl=@dbc+'gljrhdr as s '
	set @sqlmsg='merge gljrhdr as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	+ ' on t.jhcomp=s.jhcomp and t.jhtype=s.jhtype and t.jhref=s.jhref '
	+ ' when not matched then '
	+ ' insert (jhcomp ,jhtype ,jhref ,jhdate ,jhtext ,jhamt '
	+ ' ,jhentries ,jhsrc ,jhsysdate,jhcurr'
    + ' ,jhfcflag ,jhrate ,jhreleased ,jhposted ,lastupdt ,jhlccrttl ,jhlcdbttl '
	+ ' ,jhfccrttl ,jhfcdbttl'
    + ' ,jhimgrate ,modified ,serial_no ,rcvdtrn ,suspend ,usrid ,isbrtrx ,brxref ,brxfrm'
    + ' ,jhcustno ,hide_jv)
	    values (s.jhcomp ,s.jhtype ,s.jhref ,s.jhdate ,s.jhtext ,s.jhamt '
	+ ' ,s.jhentries ,s.jhsrc ,s.jhsysdate,s.jhcurr'
    + ' ,s.jhfcflag ,s.jhrate ,s.jhreleased ,s.jhposted ,s.lastupdt ,s.jhlccrttl ,s.jhlcdbttl '
	+ ' ,s.jhfccrttl ,s.jhfcdbttl'
    + ' ,s.jhimgrate ,s.modified ,s.serial_no ,s.rcvdtrn ,s.suspend ,s.usrid ,s.isbrtrx ,s.brxref ,s.brxfrm'
    + ' ,s.jhcustno ,s.hide_jv);'
	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-28
		return 
	end
	else commit transaction

	set @tbl=@dbc+'gljrdtl as s '
	set @sqlmsg='merge gljrdtl as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	+ ' on t.jdcomp=s.jdcomp and t.jdtype=s.jdtype and t.jdref=s.jdref and t.jdfolio=s.jdfolio'
	+ ' when not matched then '
	+ ' insert (jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,'
	+ ' jdfcamt ,jdcurr,jdfolio ,jdfolno ,jdsysdate ,jdsrc ,jdfc_imgval ,jdcstval ,'
	+ ' cstkey ,brnno ,bracc ,brxref,match,rplct_post,taxcatId)
	    values (s.jdcomp ,s.jdtype ,s.jdref ,s.jdkey ,s.jddate ,s.jdtext ,s.jdlcamt ,s.jddbcr ,'
	+ ' s.jdfcamt ,s.jdcurr,s.jdfolio ,s.jdfolno ,s.jdsysdate ,s.jdsrc ,s.jdfc_imgval ,s.jdcstval ,'
	+ ' s.cstkey ,s.brnno ,s.bracc ,s.brxref,s.match,s.rplct_post,s.taxcatId);'
	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-29
		return 
	end
	else commit transaction
	
	set @tbl=@dbc+'pos_hd as s '
	set @sqlmsg='merge pos_hd as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert (company,contr,ref,invdate,entries,slperson ,paytype,chargepctg,chargeamt'
    + ' ,invdspc ,disccard ,cardtype ,invttl,invcst,invdsvl,valafds ,invpaid,pricetp,slcenter'
    + ' ,invorrtrn ,cashamt,modified ,salinvno ,salctrno ,tdatetime ,cktype ,geninv ,rref'
    + ' ,rcontr ,ccpaid ,ccconus,prepaidamt ,fmbranch,mobile ,fcamt ,custtype ,paycard, saned_amt,
	     rtncshamt,dfvchramt,frc_rtncash,vat_amt_rcvd,taxfree_sales,hlldscnt,discamt,
		 No_round_nm,PriceVatType,CashDsc4RtnPrepaid,outside_order)
	    values (s.company,s.contr,s.ref,s.invdate,s.entries,s.slperson ,s.paytype,s.chargepctg,s.chargeamt'
    + ' ,s.invdspc ,s.disccard ,s.cardtype ,s.invttl,s.invcst,s.invdsvl,s.valafds ,s.invpaid,s.pricetp,s.slcenter'
    + ' ,s.invorrtrn ,s.cashamt,s.modified ,s.salinvno ,s.salctrno ,s.tdatetime ,s.cktype ,s.geninv ,s.rref'
    + ' ,s.rcontr ,s.ccpaid ,s.ccconus,s.prepaidamt ,s.fmbranch,s.mobile ,s.fcamt ,s.custtype ,s.paycard,
	    s.saned_amt,s.rtncshamt,s.dfvchramt,s.frc_rtncash,s.vat_amt_rcvd,s.taxfree_sales,s.hlldscnt,s.discamt,
		s.No_round_nm,s.PriceVatType,s.CashDsc4RtnPrepaid,s.outside_order);'	
	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-30
		return 
	end
	else commit transaction

	set @tbl=@dbc+'pos_dt as s '
	set @sqlmsg='merge pos_dt as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert (company ,contr ,ref,cmbkey ,qty,price ,barcode ,dscprsnt ,srlno,'
	+ ' rtrnd ,dsc_amt,offer_amt,nqati_prcnt)
	    values (s.company ,s.contr ,s.ref,s.cmbkey ,s.qty,s.price ,s.barcode ,s.dscprsnt ,s.srlno,'
	+ ' s.rtrnd ,s.dsc_amt,s.offer_amt,s.nqati_prcnt);'
	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-31
		return 
	end
	else commit transaction

	set @tbl=@dbc+'POSRTNINV as s '
	set @sqlmsg='merge POSRTNINV as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	+ ' on t.company=s.company and t.rcontr=s.rcontr and t.rref=s.rref '
	+ ' when not matched then '
	+ ' insert (company,rcontr,rref,Contr,ref,rtnamt)
	    values (s.company,s.rcontr,s.rref,s.Contr,s.ref,s.rtnamt);'

	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-32
		return 
	end
	else commit transaction

	
	set @tbl=@dbc+' POSPPCARD as s '
	set @sqlmsg='merge POSPPCARD as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.disccard=s.disccard'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.disccard,s.paytype,s.prepaidamt,s.paycard);'

	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-33
		return 
	end
	else commit transaction

	set @tbl=@dbc+' POSCCCARD as s '
	set @sqlmsg='merge POSCCCARD as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.cccardno=s.cccardno and t.ccsrlno=s.ccsrlno'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.cccardno,s.ccsrlno,s.cardtype,s.ccpaid,
	    s.ccconus,s.chargepctg,s.chargeamt,s.cctype,s.approvl_no,s.TransDate,s.TransTime,s.TransNo,s.terminal_id);'

    begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-34
		return 
	end
	else commit transaction

	set @tbl=@dbc+' poschrtinv as s '
	set @sqlmsg='merge poschrtinv as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.hllamt,s.chrcode);'

    begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-35
		return 
	end
	else commit transaction

	set @tbl=@dbc+' posfcamt as s '
	set @sqlmsg='merge posfcamt as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.fcy,s.fcamt,s.fcyrate,s.lcamt,s.srlno);'

    begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-36
		return 
	end
	else commit transaction

	set @tbl=@dbc+' pos_mny as s '
	set @sqlmsg='merge pos_mny as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	+ ' on t.company=s.company and t.contr=s.contr and t.mnydate=s.mnydate and t.slpcode=s.slpcode'
    + ' when not matched then '
	+ ' insert (company,contr,mnydate,slpcode,oner,fiver,tenr,twntyr,fiftyr,hundredr,
                twohandr,fivehandr,modified,rtnval,network,prepaidamt,scrtnval,scnetwork,scprepaidamt,
				sccash,saned_amt,scsaned_amt)                
	    values (s.company,s.contr,s.mnydate,s.slpcode,s.oner,s.fiver,s.tenr,s.twntyr,s.fiftyr,s.hundredr,
                s.twohandr,s.fivehandr,s.modified,s.rtnval,s.network,s.prepaidamt,
				s.scrtnval ,s.scnetwork,s.scprepaidamt,s.sccash,s.saned_amt,s.scsaned_amt);'
    begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-37
		return 
	end
	else commit transaction
end












GO
/****** Object:  StoredProcedure [dbo].[Copy_Items_By_TRNX_2_branch]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
;
 CREATE PROCEDURE [dbo].[Copy_Items_By_TRNX_2_branch]
 @lref numeric(6,0),
 @lbranch char(2),
 @ltrtype char(2),
 @lslcenter char(2),
 @lNoOf_items_updated int=0 output,
 @errstatus int = 0 output
	
AS
BEGIN
	declare @dbc nvarchar(13),
	        @sqlmsg nvarchar(max),
			@lcalcomp char(2),
			@multibarcode bit,
			@uniqu_bps bit,  -- multi branch prices
			@yrcode char(4),
			@syscode int =1

---------------------------- variables Initialization 	-----------------------------------------

--	if @lno_of_day is null or @lno_of_day=0 set @lno_of_day=1
--	set @fmdate=replace(dateadd(dd,-@lno_of_day,cast(getdate() as date)),'-','')
	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
	set @dbc=rtrim(@dbc)+'.dbo.'

	set @lslcenter=iif(@lslcenter='',space(2),@lslcenter)

	select @syscode=sysno ,@uniqu_bps= alwbrprice,@multibarcode=multibarcode from sysdb.dbo.glcalend where calcomp=@lcalcomp and yrcode=@yrcode
	---- 
	---------------------  bring iTEMS from main office  STITEMS file
	----
	set @errstatus=0;

	set @sqlmsg='merge STITEMS as t '
	set  @sqlmsg= @sqlmsg+' using '
	+ '(select distinct a.* from [mainserver].'+@dbc+'stitems a inner join [mainserver].'+@dbc+'stdtl b'
	+ ' on a.itemno=b.itemno where b.branch='+@lbranch+' and b.trtype='+@ltrtype+' and b.ref='+str(@lref)+') as s '
	set @sqlmsg= @sqlmsg+' on  t.itemno=s.itemno'
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.name,s.itemno,s.mgroup,s.sgroup,s.category,s.fcy,s.classkey,s.exdatealw,s.noofsbitem,1, '	
	set @sqlmsg= @sqlmsg+' s.sgroup3,s.sgroup4,s.company,s.lname,s.country,s.season,s.splycode,s.splylcact,s.itemtype,s.prntasmitm,s.prmdesc,'	
	set @sqlmsg= @sqlmsg+' s.scndesc,s.cmpprcnt,s.dsctype,s.brand_id,s.msplycode,s.modelno,s.nosales,s.vprice,s.fix_barcode,s.taxtype);'	

	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-1
		return 
	end


	

	---- 
	---------------------  bring iTEMS from main office  stunits file
	----
	
	set @sqlmsg='merge stunits as t '
	set  @sqlmsg= @sqlmsg+' using '
	+ '(select distinct a.* from [mainserver].'+@dbc+'stunits a  inner join [mainserver].'+@dbc+'stdtl b'
	+ ' on a.itemno=b.itemno and a.unicode=b.unicode '
	+ ' where b.branch='+@lbranch+' and b.trtype='+@ltrtype+' and b.ref='+str(@lref)+') as s '
	set  @sqlmsg= @sqlmsg+' on  t.itemno=s.itemno and t.unicode=s.unicode '
	set  @sqlmsg= @sqlmsg+' when matched then '
	set  @sqlmsg= @sqlmsg+' update set t.lprice1=s.lprice1,t.lprice2=s.lprice2,t.lprice3=s.lprice3,t.mnmprice=s.mnmprice, '
	+ ' t.fprice1=s.fprice1,t.fprice2=s.fprice2,t.fprice3=s.fprice3,t.maxdisc1=s.maxdisc1,t.maxdisc2=s.maxdisc2,t.maxdisc3=s.maxdisc3,'
	+ ' t.orderlevel=s.orderlevel,t.pp2=s.pp2,t.Xdecimal=s.Xdecimal,t.minstk=s.minstk,t.maxstk=s.maxstk,t.pack0=s.pack0,'
	+ ' t.pack1=s.pack1,t.pack2=s.pack2,t.pack3=s.pack3,t.pkqty1=s.pkqty1,t.pkqty2=s.pkqty2,t.pkqty3=s.pkqty3 '
	set  @sqlmsg= @sqlmsg+' when not matched then '
	set  @sqlmsg= @sqlmsg+' insert values (s.name,s.itemno,s.unicode,0,s.lcost,s.lcost,s.lprice1,s.fprice1,s.maxdisc1,s.lprice2,s.fprice2,s.maxdisc2,'
	set  @sqlmsg= @sqlmsg+'s.lprice3,s.fprice3,s.maxdisc3,s.fcost,s.fcost,s.lrcvdate,s.lastissue,s.curbal,s.curbal,0,s.minstk,s.maxstk,'
	set  @sqlmsg= @sqlmsg+'s.orderlevel,s.leadday,s.Xdecimal,s.barcode,s.pack1,s.pkqty1,s.pack2,s.pkqty2,s.pack3,s.pkqty3,s.company,'
	set  @sqlmsg= @sqlmsg+'1,s.pack0,s.packtp,s.scnname,s.crtdate,s.inactive,s.prmcode,s.scncode,s.cmbkey,s.mnmprice,'
	set  @sqlmsg= @sqlmsg+'s.lastupdt,s.modelno,s.splyitemno,s.splyinv,s.invprice,s.invqty,s.invpk,s.pp2,s.pp3);'


	exec sp_executesql @sqlmsg
	set @lNoOf_items_updated=@@ROWCOUNT
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-2
		return 
	end

	---- 
	---------------------  bring iTEMS from main office  stbrprice file 
	----
	if @uniqu_bps=1
	  begin
	
		set @sqlmsg='merge stbrprice as t '
		set @sqlmsg= @sqlmsg+' using '
		+ '(select distinct a.* from [mainserver].'+@dbc+'stbrprice a '
		+ ' inner join [mainserver].'+@dbc+'stdtl b '
	    + ' a.itemno=b.itemno and a.unicode=b.unicode '
		+ ' where  a.company='+@lbranch+' and a.slcenter='+@lslcenter
	    + ' and b.branch='+@lbranch+' and b.trtype='+@ltrtype+' and b.ref='+str(@lref)+') as s '		
		set @sqlmsg= @sqlmsg+' on t.company=s.company and t.slcenter=s.slcenter and t.itemno=s.itemno and t.unicode=s.unicode '
		+ '  when matched then '
		+ ' update set t.lprice1=s.lprice1,t.lprice2=s.lprice2,t.lprice3=s.lprice3,t.mnmprice=s.mnmprice, '
	    + ' t.fprice1=s.fprice1,t.fprice2=s.fprice2,t.fprice3=s.fprice3,t.maxdisc1=s.maxdisc1,'
		+ ' t.maxdisc2=s.maxdisc2,t.maxdisc3=s.maxdisc3,t.slsprsnt=s.slsprsnt'
		set @sqlmsg= @sqlmsg+' when not matched then '
		set @sqlmsg= @sqlmsg+' insert values (s.company,s.slcenter,s.itemno,s.unicode,s.lprice1,s.lprice2,s.lprice3,'
		+ 's.maxdisc1,s.maxdisc2,s.maxdisc3,s.mnmprice,s.pprice1,s.pprice2,s.pprice3,s.modelno,s.promotion,s.prm_start,s.prm_end,'
		+ 's.slsprsnt,s.fprice1,s.fprice2,s.fprice3,s.modified,s.lastupdt);'

		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-3
			return 
		end
	  end
	---- 
	---------------------   bring iTEMS from main office  STITEMBC file  
	----
	if @multibarcode=1 or @syscode=6
	  begin
	
			set @sqlmsg='merge STITEMBC as t '
			set @sqlmsg= @sqlmsg+' using '
			+ '(select distinct a.* from [mainserver].'+@dbc+'STITEMBC a inner join [mainserver].'+@dbc+'stdtl b'
			+ ' on a.itemno=b.itemno and a.unicode=b.unicode'
			+ ' where b.branch='+@lbranch+' and b.trtype='+@ltrtype+' and b.ref='+str(@lref)+') as s '
			set @sqlmsg= @sqlmsg+' on t.pbarcode=s.pbarcode '
			+ ' when matched then '
			+ ' update set t.lprice1=s.lprice1,t.mnmprice=s.mnmprice,t.itext=s.itext,t.pack=s.pack,t.pkqty=s.pkqty,'
			+ ' t.pkorder=s.pkorder,t.litext=s.litext '
			set @sqlmsg= @sqlmsg+' when not matched then '
			set @sqlmsg= @sqlmsg+' insert values (s.pbarcode,s.itemno,s.unicode,s.cmbkey,s.pack,s.pkqty,s.lprice1,s.weight,s.mnmprice,s.itext,s.litext,s.pkorder,s.lastrcvd);'

			exec sp_executesql @sqlmsg
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-4
				return 
			end
	   end
	   if @errstatus=0 commit transaction

/*
	---- 
	---------------------  Move open balance from Last year for STBINS 
	----
		
	set @tbl=@dbc+'stbins as s '
	set @sqlmsg='merge stbins as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.branch=s.branch and t.itemno=s.itemno and t.unicode=s.unicode and t.whno=s.whno and t.binno=s.binno '
	set @sqlmsg= @sqlmsg+' when matched then '
	set @sqlmsg= @sqlmsg+' update set t.qty=t.qty-t.openbal+s.qty,t.openbal=s.qty,t.openlcost=s.lcost,t.openfcost=s.fcost '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.branch,s.itemno,s.unicode,s.whno,s.binno,s.qty,0,s.qty,s.lcost,s.fcost,s.lcost,s.fcost,s.expdate);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-3
			return 
		end
		else commit transaction
	---- 
	---------------------  Move Photos from Last year for stitmphoto 
	----
	set @tbl=@dbc+'stitmphoto as s '
	set @sqlmsg='merge stitmphoto as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.itemno=s.itemno and t.unicode=s.unicode '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.itemno,s.unicode,s.remarks,s.ipicture);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-4
			return 
		end
		else commit transaction

	---- 
	---------------------  Move records from Last year for stasmbld 
	----
	set @tbl=@dbc+'stasmbld as s '
	set @sqlmsg='merge stasmbld as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.itemno=s.itemno and t.unicode=s.unicode  and t.asmitemno=s.asmitemno and t.asmunicode=s.asmunicode  '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.itemno,s.unicode,s.asmitemno,s.asmunicode,s.cmbkey,s.qtyneeded);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-5
			return 
		end
		else commit transaction

	---- 
	---------------------  Move records from Last year for STOFFERS 
	----
	set @tbl=@dbc+'STOFFERS as s '
	set @sqlmsg='merge STOFFERS as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.barcode=s.barcode '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.itemno,s.unicode,s.barcode,s.DiscountP,s.disctype,s.MinQty,s.GivenAmt,s.StartDate,s.EndDate,s.InActive,s.lastupdt);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-6
			return 
		end
		else commit transaction



	---- 
	---------------------  Move records from Last year for STCOMMISSION 
	----
	set @tbl=@dbc+'STCOMMISSION as s '
	set @sqlmsg='merge STCOMMISSION as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.itemno=s.itemno and t.unicode=s.unicode '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.itemno,s.unicode,s.commtype,s.commission,s.cmntarget,s.InActive,s.cmsn_onQty);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-9
			return 
		end
		else commit transaction
	---- 
	---------------------  Move records from Last year for stitemrp 
	----
	set @tbl=@dbc+'stitemrp as s '
	set @sqlmsg='merge stitemrp as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.itemno=s.itemno and t.unicode=s.unicode  and t.rplitemno=s.rplitemno and t.rplunicode=s.rplunicode  '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.itemno,s.unicode,s.rplitemno,s.rplunicode,s.cmbkey,s.rplorder,s.lastupdt);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-5
			return 
		end
		else commit transaction
		*/
end













GO
/****** Object:  StoredProcedure [dbo].[Copy_NqatiBankApi_2_branch]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2022-05-16@@$$##  Important : must have this line as first line which contains the last update date for the this file 
 CREATE PROCEDURE [dbo].[Copy_NqatiBankApi_2_branch]
 @lcompany char(2),
 @errstatus int = 0 output
AS
BEGIN
	declare @dbc nvarchar(13),
	        @sqlmsg nvarchar(max)
---------------------------- variables Initialization 	-----------------------------------------
	set @dbc=db_name()
	set @dbc=rtrim(@dbc)+'.dbo.'
	----
	set @errstatus=0

	------------  Added on 2021-08-26 AA -----------------------------

	   set @sqlmsg='merge nqatibankapi as t '
		+ ' using '
		+ '  (select * from [mainserver].'+@dbc+'nqatibankapi where bk_company='+@lcompany +') as s'
		+ ' on t.bk_company=s.bk_company and t.bk_bank_id=s.bk_bank_id'
		+ ' when matched then '
		+ ' update set t.bk_name=s.bk_name,t.bk_lname=s.bk_lname,t.bk_urlToken=s.bk_urlToken,t.bk_urlAuthorization=s.bk_urlAuthorization,'
		+ ' t.bk_client_id=s.bk_client_id,t.bk_client_secret=s.bk_client_secret,t.bk_merchantToken=s.bk_merchantToken,t.bk_grant_type=s.bk_grant_type,'
		+ ' t.bk_scope=s.bk_scope,t.last_updated_date=s.last_updated_date,t.bk_inactive=s.bk_inactive,t.bk_glact=s.bk_glact,'
		+ ' t.bk_urlClientAmt=s.bk_urlClientAmt'
		+ ' when not matched then '
		+ ' insert (bk_company, bk_Bank_ID, bk_name, bk_lname, bk_urlToken, bk_urlAuthorization, bk_client_id, bk_client_secret,
		    bk_merchantToken, bk_grant_type, bk_scope, usrid, last_updated_date, bk_inactive, bk_glact, bk_urlClientAmt)'
		+ ' values (s.bk_company, s.bk_Bank_ID, s.bk_name, s.bk_lname, s.bk_urlToken, s.bk_urlAuthorization, s.bk_client_id, s.bk_client_secret,
		    s.bk_merchantToken, s.bk_grant_type, s.bk_scope, s.usrid, s.last_updated_date, s.bk_inactive, s.bk_glact, s.bk_urlClientAmt);'

		    begin try
				begin transaction
				exec sp_executesql @sqlmsg
				if @@error<>0
				begin
					rollback transaction
					set @errstatus=-1
					return 
				end
			END TRY
			BEGIN CATCH
					if @@TRANCOUNT>0 ROLLBACK TRANSACTION
					set @errstatus=-2
			END CATCH

end



GO
/****** Object:  StoredProcedure [dbo].[Copy_Updated_Items_2_branch]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-08-26@@$$##  Important : must have this line as first line which contains the last update date for the this file 
------- 2024-08-25 AA updated the new 3 columns in stitmphoto table when matched 
------- 2024-08-24 AA Added 3 new columns in stitmphoto table 
------- 2024-04-06 AA fixed many bugs
------- 2024-04-06 AA Added begin transaction command is not good in stoffers table fixed
------- 2024-04-06 AA Added a to stoffers table
------- 2024-04-06 AA Added qouts to slcenter in stoffers table
------- 2024-04-06 AA Removed the begin try in stoffers tables 
------- 2024-04-05 AA fixed bugs when slcenter is empty 
------- 2024-04-04 AA Added new codes to handle the new changes in the new offers in stoffers & stoffers_dt  
------- 2024-04-04 AA Added new tables stoffers_main , stoffer_grp_dt & stoffer_grp_hd to be imported
------- 2024-01-15 AA Added new code to send salecntr table to branch
------- Added on 2023-12-26 AA Added code to prevent improt installmnt_cmp table for yemen
------- Added on 2023-12-26 AA New variable @lcountrycode to be used for yemen
------- Added on 2023-12-26 AA 3 missing column credit_client,credit_limit,pay_once_all in pos_dsc
------- Added on 2023-10-21 AA Modified the stitmphoto sql statement to fix unmatched column
------- Added on 2023-10-19 AA Added the missing column remarks in stitmphoto 
------- Added on 2023-10-18 AA Added code to import stitmphoto table
------- Added on 2023-10-18 AA Added a missing command commit transaction after import POS_DSC  table
------- Added on 2023-10-18 AA Added new codes to import stitembc_brprice 
------- Added on 2023-10-16 AA Fixed the bug of lastupdt column of installment_cmp table  being without s.lastupdt
------- Added on 2023-10-16 AA Fixed the bug of chacct in pos_chrt being used without s.chacct
------- Added on 2023-10-11 AA Fixed the name of pos_chrt instead of pos_chart
------- Added on 2023-10-09 AA allow to update the table pos_chrt  
------- Added on 2023-10-09 AA import the installment_cmp table
------- Added on 2023-06-11 AA ambigous itemno,unicode . Fixed
------- Added on 2023-06-04 AA New codes are added to read the lprice1 & lproce2 from the new table stitembc_brprice when lalwbrmbcprice is tru
------- Added on 2023-06-04 AA new variable named lalwbrmbcprice & updated from glcalend
------- Added on 2020-09-14 made the pos_slp & pos_dsc coping perfect even if missing column.
------- Added on 2020-09-14 to copy poitem_grp & poitem_btn
------- Added on 2020-02-04 to copy the stoffers_dt table to branch
------- Modified on 2019-09-12 to copy stitmphoto table to branch 
-------
 CREATE PROCEDURE [dbo].[Copy_Updated_Items_2_branch]

 @lno_of_day int,
 @lbranch char(2),
 @lslcenter char(2),
 @lNoOf_items_updated int output,
 @errstatus int = 0 output
	
AS
BEGIN
	declare @dbc nvarchar(13),
	        @sqlmsg nvarchar(max),
			@lcalcomp char(2),
			@multibarcode bit,
			@uniqu_bps bit,  -- multi branch prices
			@fmdate varchar(10),
			@yrcode char(4),
			@syscode int =1,
			@import_pos_dsc bit=0,
			@lalwbrmbcprice bit =0 ,-- Added on 2023-06-04 AA 
			@lcountrycode int=0 --Added on 2023-12-26 AA 

---------------------------- variables Initialization 	-----------------------------------------

    if @lNoOf_items_updated=1 set @import_pos_dsc=1
	set @lNoOf_items_updated=0
	if @lno_of_day is null or @lno_of_day=0 set @lno_of_day=1
	--set @fmdate=replace(dateadd(dd,-@lno_of_day,cast(getdate() as date)),'-','')
	set @fmdate=replace(convert(varchar(10),dateadd(dd,-@lno_of_day,getdate()),112),'-','')
	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
	set @dbc=rtrim(@dbc)+'.dbo.'
	set @lslcenter=iif(@lslcenter='',space(2),@lslcenter)

	select @syscode=sysno ,@uniqu_bps= alwbrprice,@multibarcode=multibarcode,@lalwbrmbcprice=isnull(alwbrmbcprice,0),@lcountrycode=country --Added on 2023-12-26 AA 
	 from sysdb.dbo.glcalend where calcomp=@lcalcomp and yrcode=@yrcode;
	---- 
	---------------------  Move iTEMS from HO to branch for STITEMS 
	----
	set @errstatus=0

	set @sqlmsg='merge STITEMS as t '
	set  @sqlmsg= @sqlmsg+' using '
	+ '(select distinct a.* from [mainserver].'+@dbc+'stitems a inner join [mainserver].'+@dbc+'stunits b'
	+ ' on a.itemno=b.itemno where b.lastupdt<>''18991230'' and rtrim(b.lastupdt)<>'''' and b.lastupdt>='+@fmdate+') as s '
	set @sqlmsg= @sqlmsg+' on  t.itemno=s.itemno'
	set @sqlmsg= @sqlmsg+' when matched then 
	                       update set t.name=s.name,t.mgroup=s.mgroup,t.sgroup=s.sgroup,t.category=s.category,
						   t.sgroup3=s.sgroup3,t.sgroup4=s.sgroup4,t.classkey=s.classkey,t.lname=s.lname,
						   t.dsctype=s.dsctype,t.nosales=s.nosales,t.splycode=s.splycode,t.taxtype=s.taxtype,t.taxfree=s.taxfree'
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.name,s.itemno,s.mgroup,s.sgroup,s.category,s.fcy,s.classkey,s.exdatealw,s.noofsbitem,1, '	
	set @sqlmsg= @sqlmsg+' s.sgroup3,s.sgroup4,s.company,s.lname,s.country,s.season,s.splycode,s.splylcact,s.itemtype,s.prntasmitm,s.prmdesc,'	
	set @sqlmsg= @sqlmsg+' s.scndesc,s.cmpprcnt,s.dsctype,s.brand_id,s.msplycode,s.modelno,s.nosales,s.vprice,s.fix_barcode,s.taxtype,s.taxfree);'	

	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-1
		return 
	end
	commit transaction

	

	---- 
	---------------------  Move open balance from HO to branch for STUNITS 
	----
	
	set @sqlmsg='merge stunits as t '
	set  @sqlmsg= @sqlmsg+' using '
	+ '(select distinct * from [mainserver].'+@dbc+'stunits  where lastupdt<>''18991230'' and rtrim(lastupdt)<>'''' and lastupdt>='+@fmdate+') as s '
	set  @sqlmsg= @sqlmsg+' on  t.itemno=s.itemno and t.unicode=s.unicode '
	set  @sqlmsg= @sqlmsg+' when matched then '
	set  @sqlmsg= @sqlmsg+' update set t.lprice1=s.lprice1,t.lprice2=s.lprice2,t.lprice3=s.lprice3,t.mnmprice=s.mnmprice, '
	+ ' t.fprice1=s.fprice1,t.fprice2=s.fprice2,t.fprice3=s.fprice3,t.maxdisc1=s.maxdisc1,t.maxdisc2=s.maxdisc2,t.maxdisc3=s.maxdisc3,'
	+ ' t.orderlevel=s.orderlevel,t.pp2=s.pp2,t.Xdecimal=s.Xdecimal,t.minstk=s.minstk,t.maxstk=s.maxstk,t.pack0=s.pack0,'
	+ ' t.pack1=s.pack1,t.pack2=s.pack2,t.pack3=s.pack3,t.pkqty1=s.pkqty1,t.pkqty2=s.pkqty2,t.pkqty3=s.pkqty3,t.lastupdt=s.lastupdt '
	set  @sqlmsg= @sqlmsg+' when not matched then '
	set  @sqlmsg= @sqlmsg+' insert values (s.name,s.itemno,s.unicode,0,s.lcost,s.lcost,s.lprice1,s.fprice1,s.maxdisc1,s.lprice2,s.fprice2,s.maxdisc2,'
	set  @sqlmsg= @sqlmsg+'s.lprice3,s.fprice3,s.maxdisc3,s.fcost,s.fcost,s.lrcvdate,s.lastissue,s.curbal,s.curbal,0,s.minstk,s.maxstk,'
	set  @sqlmsg= @sqlmsg+'s.orderlevel,s.leadday,s.Xdecimal,s.barcode,s.pack1,s.pkqty1,s.pack2,s.pkqty2,s.pack3,s.pkqty3,s.company,'
	set  @sqlmsg= @sqlmsg+'1,s.pack0,s.packtp,s.scnname,s.crtdate,s.inactive,s.prmcode,s.scncode,s.cmbkey,s.mnmprice,'
	set  @sqlmsg= @sqlmsg+'s.lastupdt,s.modelno,s.splyitemno,s.splyinv,s.invprice,s.invqty,s.invpk,s.pp2,s.pp3);'

	begin transaction
	exec sp_executesql @sqlmsg
	set @lNoOf_items_updated=@@ROWCOUNT
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-2
		return 
	end
	commit transaction
	---- 
	---------------------  Move records HO to branch year for stbrprice
	----
	if @uniqu_bps=1
	  begin
	
		set @sqlmsg='merge stbrprice as t '
		set @sqlmsg= @sqlmsg+' using '
		+ '(select distinct * from [mainserver].'+@dbc+'stbrprice where '
		+ ' company='+@lbranch+' and slcenter='+@lslcenter
		+ ' and lastupdt<>''18991230'' and rtrim(lastupdt)<>'''' and lastupdt>='+@fmdate+') as s '  
		set @sqlmsg= @sqlmsg+' on t.company=s.company and t.slcenter=s.slcenter and t.itemno=s.itemno and t.unicode=s.unicode '
		+ '  when matched then '
		+ ' update set t.lprice1=s.lprice1,t.lprice2=s.lprice2,t.lprice3=s.lprice3,t.mnmprice=s.mnmprice, '
	    + ' t.fprice1=s.fprice1,t.fprice2=s.fprice2,t.fprice3=s.fprice3,t.maxdisc1=s.maxdisc1,'
		+ ' t.maxdisc2=s.maxdisc2,t.maxdisc3=s.maxdisc3,t.slsprsnt=s.slsprsnt'
		set @sqlmsg= @sqlmsg+' when not matched then '
		set @sqlmsg= @sqlmsg+' insert values (s.company,s.slcenter,s.itemno,s.unicode,s.lprice1,s.lprice2,s.lprice3,s.maxdisc1,s.maxdisc2,s.maxdisc3
          ,s.mnmprice,s.pprice1,s.pprice2,s.pprice3,s.modelno,s.promotion,s.prm_start,s.prm_end,s.slsprsnt
          ,s.fprice1,s.fprice2,s.fprice3,s.modified,s.lastupdt);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-3
			return 
		end
		commit transaction
	  end
	---- 
	---------------------  Move records from HO to branch for STITEMBC 
	----
	if @multibarcode=1 or @syscode=6
	begin	        
		set @sqlmsg='merge STITEMBC as t '
		set @sqlmsg= @sqlmsg+' using '
		+ '(select distinct a.* from [mainserver].'+@dbc+'STITEMBC a inner join [mainserver].'+@dbc+'stunits b'
		+ ' on a.itemno=b.itemno and a.unicode=b.unicode'
		+ ' where b.lastupdt<>''18991230'' and rtrim(b.lastupdt)<>'''' and b.lastupdt>='+@fmdate+') as s '  
		set @sqlmsg= @sqlmsg+' on t.pbarcode=s.pbarcode '
		+ ' when matched then '
		+ ' update set t.lprice1=s.lprice1,t.mnmprice=s.mnmprice,t.itext=s.itext,t.pack=s.pack,t.pkqty=s.pkqty,'
		+ ' t.pkorder=s.pkorder,t.litext=s.litext,t.lprice2=s.lprice2'
		set @sqlmsg= @sqlmsg+' when not matched then '
		set @sqlmsg= @sqlmsg+' insert values (s.pbarcode,s.itemno,s.unicode,s.cmbkey,s.pack,s.pkqty,s.lprice1,s.weight,s.mnmprice,s.itext,s.litext,s.pkorder,s.lastrcvd,s.lprice2);'

------- Added on 2023-10-18 AA stitembc_brprice & removed the old codes----------------------------------------------------------------------------------------------------------
        begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-4
			return 
		end
	    if @lalwbrmbcprice=1
		begin
			set @sqlmsg='merge STITEMBC_BRPRICE as t '
			set @sqlmsg= @sqlmsg+' using '
			+ '(select distinct z.* 
				from [mainserver].'+@dbc+'STITEMBC_BRPRICE Z inner join  [mainserver].'+@dbc+'STITEMBC a inner join [mainserver].'+@dbc+'stunits b'
			+ ' on a.itemno=b.itemno and a.unicode=b.unicode
				on z.pbarcode=a.pbarcode and z.cmbkey=z.cmbkey'
			+ ' where z.branch='+@lbranch+' and b.lastupdt<>''18991230'' and rtrim(b.lastupdt)<>'''' and b.lastupdt>='+@fmdate+') as s '  
			set @sqlmsg= @sqlmsg+' on t.branch=s.branch and t.pbarcode=s.pbarcode '
			+ ' when matched then '
			+ ' update set t.lprice1=s.lprice1,t.mnmprice=s.mnmprice,t.lprice2=s.lprice2'
			set @sqlmsg= @sqlmsg+' when not matched then '
			set @sqlmsg= @sqlmsg+' insert values (s.branch,s.pbarcode,s.cmbkey,s.lprice1,s.mnmprice,s.lprice2);'

			exec sp_executesql @sqlmsg
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-17
				return 
			end
		end
----------------------------------------------------------------------------------------------------------------------------------------------------
		commit transaction
	end
	   
	---- 
	---------------------  Move records from HO to branch for STITEMNQATI 
	----

	    
		set @sqlmsg='merge stitemnqati as t '
		set @sqlmsg= @sqlmsg+' using '
		+ '(select distinct a.* from [mainserver].'+@dbc+'stitemnqati a '
		+ ' where a.lastupdt<>''18991230'' and rtrim(a.lastupdt)<>'''' and a.lastupdt>='+@fmdate+') as s '  
		set @sqlmsg= @sqlmsg+' on t.cmbkey=s.cmbkey '
		+ ' when matched then '
		+ ' update set t.nqati_prcnt=s.nqati_prcnt,t.dsc_prcnt=s.dsc_prcnt,t.lastupdt=s.lastupdt'
		set @sqlmsg= @sqlmsg+' when not matched then '
		set @sqlmsg= @sqlmsg+' insert values (s.cmbkey,s.nqati_prcnt,s.dsc_prcnt,s.lastupdt);'

		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-5
			return 
		end
	   
	    commit transaction
	---- 
	---------------------  Move records from HO to branch for stitmphoto 
	
--- Added on 2023-10-18 AA --------------------------------------------------------------------------------------------------------------------------------------
	set @sqlmsg='merge stitmphoto as t '
	set @sqlmsg= @sqlmsg+' using '
	+ '(select a.* from [mainserver].'+@dbc+'stitmphoto a inner join [mainserver].'+@dbc+'stunits b'
	+ ' on a.itemno=b.itemno and a.unicode=b.unicode where b.lastupdt<>''18991230'' and rtrim(b.lastupdt)<>'''' and b.lastupdt>='+@fmdate+') as s '
	set @sqlmsg= @sqlmsg+' on  t.itemno=s.itemno and t.unicode=s.unicode' 
	set @sqlmsg= @sqlmsg+' when matched then '
	+  'update set  t.remarks=s.remarks,t.ipicture=s.ipicture,t.ord_qty=s.ord_qty,t.mnimumdt=s.mnimumdt,t.cust_pctg=s.cust_pctg,
	                t.dsc_amt1=s.dsc_amt1,t.dsc_amt2=s.dsc_amt2,t.dsc_amt3=s.dsc_amt3,t.onlinesales=s.onlinesales,
					t.exemption_reason_code=s.exemption_reason_code,t.extra_tax_p=s.extra_tax_p,t.startdate=s.startdate,t.enddate=s.enddate'
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert  (itemno, unicode, remarks, ipicture, ord_qty, mnimumdt, cust_pctg, is_double_width, is_price_per_length,
	                                is_accessory_stk_item, dsc_amt1,dsc_amt2, dsc_amt3,
									usrid, usrid_lstchg, onlinesales, exemption_reason_code,extra_tax_p,startdate,enddate)
	                       values  (s.itemno, s.unicode,s.remarks, s.ipicture,s.ord_qty,s.mnimumdt,s.cust_pctg,s.is_double_width,s.is_price_per_length,
						            s.is_accessory_stk_item,s.dsc_amt1,s.dsc_amt2,s.dsc_amt3,
	                                s.usrid, s.usrid_lstchg,s.onlinesales, s.exemption_reason_code,s.extra_tax_p,s.startdate,s.enddate);'

   
                              		
	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-6
		return 
	end
	commit transaction
	---- 
	---------------------  Move records from HO to branch for POS_SLP 
	----
  --  set @sqlmsg='merge pos_slp as t '
		--+ ' using '
		--+ '  (select  a.* from [mainserver].'+@dbc+'pos_slp as a where a.slpcompany='+@lbranch +iif(@lslcenter='',' )  as s ',
		--   ' and a.slcenter='+@lslcenter+' ) as s ')
		--+ ' on t.slpcompany=s.slpcompany and t.slpcode=s.slpcode'
		--+ ' when matched then '
		--+ ' update set t.slpname=s.slpname,t.slpaddress=s.slpaddress,t.slptels=s.slptels,t.slppassword=s.lppassword,'
		--	+ ' t.slpchgqty=s.slpchgqty,t.slpchgprice=s.slpchgprice,t.slpdelline=s.slpdelline,'
		--	+ ' t.slpothersinv=s.slpothersinv,t.slpreturn=s.slpreturn,t.slpstatus=s.slpstatus,'
		--	+ ' t.slpalowdisc=s.slpalowdisc,t.slpmaxdisc=s.slpmaxdisc,t.slppricetp=s.slppricetp,'
		--	+ ' t.slpalowcancel=s.slpalowcancel,t.slpalowopdr=s.slpalowopdr,t.modified=s.modified,'
		--	+ ' t.slpalowexit=s.slpalowexit,t.slprtwoinv=s.slprtwoinv,t.slpblowbal=s.slpblowbal,'
		--	+ ' t.scr_open=s.scr_open,t.alwitmdsc=t.alwitmdsc=s.alwitmdsc,t.maxitmdsc=s.maxitmdsc,'
		--	+ ' t.alwuserpls=s.alwuserpls,t.alwuseicrpls=s.alwuseicrpls,t.slpmagnetic=s.slpmagnetic,'
		--	+ ' t.alwusebrrtn=s.alwusebrrtn,t.alwreprint=s.alwreprint,t.frcrplinv=s.frcrplinv,'
		--	+ ' t.catch_thief=s.catch_thief,t.sold_once=s.sold_once,t.only_scan_bc=s.only_scan_bc,'
		--	+ ' t.stop_item_column=s.stop_item_column,t.slpfpalw=s.slpfpalw,t.supervisor=s.supervisor,'
		--	+ ' t.ReadInvByBarcd=s.ReadInvByBarcd,t.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,'
		--	+ ' t.alwinvtrnsfr=s.alwinvtrnsfr,t.alwcshcardpay=s.alwcshcardpay,t.slp_hlldscamtMAX=s.slp_hlldscamtMAX,'
		--	+ ' t.alwprnttmpinv=s.alwprnttmpinv,t.ignore_mnmprice=s.ignore_mnmprice,t.NoExceed_hll=s.NoExceed_hll,'
		--	+ ' t.showallsuspndinv=s.showallsuspndinv,t.slpfpimage2=s.slpfpimage2,t.nodelchgmny=s.nodelchgmny,'
		--	+ ' t.slpfpimage=s.slpfpimage,t.slcenter=s.slcenter,t.salesquota=s.salesquota,'
		--	+ ' t.commissionP=s.commissionP,t.bonus=s.bonus,t.delitmbybrcd=s.delitmbybrcd'
		--+ ' when not matched then '
		--+ ' insert (slpcompany,slpcode,slpname,slpaddress,slptelslppassword,slpchgqty,slpchgprice,slpdelline
  --          ,slpothersinv,slpreturn,slpstatus,slpalowdisc,slpmaxdisc,slppricetp,slpalowcancel
  --          ,slpalowopdr,modified,slpalowexit,slprtwoinv,slpblowbal,scr_open,alwitmdsc,maxitmdsc
  --          ,alwuserpls,alwuseicrpls,slpmagnetic,alwusebrrtn,alwreprint,frcrplinv,catch_thief
  --          ,sold_once,only_scan_bc,stop_item_column,slpfpalw,supervisor,ReadInvByBarcd
  --          ,alwrtncash,alwmtchrtn,alwinvtrnsfr,alwcshcardpay,slp_hlldscamtMAX,alwprnttmpinv
  --          ,ignore_mnmprice,NoExceed_hll,showallsuspndinv,slpfpimage2,nodelchgmny,slpfpimage
  --          ,slcenter,salesquota,commissionP,bonus,delitmbybrcd)'
		--+ ' values (s.slpcompany,s.slpcode,s.slpname,s.slpaddress,s.slptels.slppassword,s.slpchgqty,s.slpchgprice,s.slpdelline
  --          ,s.slpothersinv,s.slpreturn,s.slpstatus,s.slpalowdisc,s.slpmaxdisc,s.slppricetp,s.slpalowcancel
  --          ,s.slpalowopdr,s.modified,s.slpalowexit,s.slprtwoinv,s.slpblowbal,s.scr_open,s.alwitmdsc,s.maxitmdsc
  --          ,s.alwuserpls,s.alwuseicrpls,s.slpmagnetic,s.alwusebrrtn,s.alwreprint,s.frcrplinv,s.catch_thief
  --          ,s.sold_once,s.only_scan_bc,s.stop_item_column,s.slpfpalw,s.supervisor,s.ReadInvByBarcd
  --          ,s.alwrtncash,s.alwmtchrtn,s.alwinvtrnsfr,s.alwcshcardpay,s.slp_hlldscamtMAX,s.alwprnttmpinv
  --          ,s.ignore_mnmprice,s.NoExceed_hll,s.showallsuspndinv,s.slpfpimage2,s.nodelchgmny,s.slpfpimage
  --          ,s.slcenter,s.salesquota,s.commissionP,s.bonus,s.delitmbybrcd);'
		--begin transaction
		--exec sp_executesql @sqlmsg
		--if @@error<>0 
		--begin
		--	rollback transaction
		--	set @errstatus=-11
		--	return 
		--end
		--else commit transaction

	---- 
	---------------------  Move records from HO to branch for POS_DSC 
	----
	
		if @import_pos_dsc=1
		begin
			set @sqlmsg='merge POS_DSC as t '
			+ ' using '
			+ '(select distinct * from [mainserver].'+@dbc+'pos_dsc where dsccompany='+@lbranch+') s'
			+ ' on t.dsccompany=s.dsccompany and t.dsccard=s.dsccard'
			+ ' when matched then '
			+ ' update set t.dscname=s.dscname,t.dscaddress=s.dscaddress,t.dsctel=s.dsctel,t.dscprtg=s.dscprtg,
				t.dscstatus=s.dscstatus,t.dscnote=s.dscnote,t.modified=s.modified,t.mnth_target=s.mnth_target,
				t.mnthbal=s.mnthbal,t.trgt_prcnt=s.trgt_prcnt,t.prepaidamt=s.prepaidamt,t.cardtype=s.cardtype,
				t.cardused=s.cardused,t.expdate=s.expdate,t.chrcode=s.chrcode,t.cstpassw=s.cstpassw,
				t.crtdate=s.crtdate,t.crtyear=s.crtyear,t.cust_ttlsales=s.cust_ttlsales,t.sales_grantd=s.sales_grantd,
				t.ttl_grantd=s.ttl_grantd,t.vchr_value=s.vchr_value,t.vchr_used=s.vchr_used,
				t.mothercard=s.mothercard,t.lastpaycard=s.lastpaycard,t.nqati_openbal=s.nqati_openbal'
			+ ' when not matched then '
			+ ' insert (dsccompany, dsccard, dscname, dscaddress, dsctel, dscprtg, dscstatus, dscnote, modified, mnth_target, mnthbal, trgt_prcnt
			    , prepaidamt, cardtype, cardused, expdate, chrcode, cstpassw, crtdate, crtyear, cust_ttlsales 
                ,sales_grantd, ttl_grantd, vchr_value, vchr_used, mothercard, lastpaycard, nqati_openbal, nodsc4promo, employees_only
				, no_payment,smsvrfycode,credit_client,credit_limit,pay_once_all)
			    values (s.dsccompany,s.dsccard ,s.dscname ,s.dscaddress,s.dsctel,s.dscprtg,s.dscstatus,s.dscnote
				,s.modified,s.mnth_target,s.mnthbal,s.trgt_prcnt,s.prepaidamt,s.cardtype,s.cardused,s.expdate
				,s.chrcode,s.cstpassw,s.crtdate,s.crtyear,s.cust_ttlsales,s.sales_grantd,s.ttl_grantd,s.vchr_value
				,s.vchr_used,s.mothercard,s.lastpaycard,s.nqati_openbal,s.nodsc4promo,s.employees_only,s.no_payment,s.smsvrfycode
				,s.credit_client,s.credit_limit,s.pay_once_all);'

			begin transaction
			exec sp_executesql @sqlmsg
			if @@error<>0 
			begin
				rollback transaction
				set @errstatus=-13
				return 
			end
			commit transaction  --- Added on 2023-10-18 AA  missing Fixed  khalid push it down 

-------------- Stopped on 2023-10-18 AA having many bugs & missing importanant information
			------------------ add by khalid - 07-10-2023	
		--set @sqlmsg='merge pos_chrt as t '
		--+ ' using '
		--+ '(select distinct * from [mainserver].'+@dbc+'pos_chrt where dsccompany='+@lbranch+') s'  
		--+ ' on t.company=s.company and t.chrcode=s.chrcode'
		--+ ' when not matched then '
		--+ ' insert (company,chrcode,chname,chaddress,chtel,chfax,chpcntct,chmobile
  --          ,chacct,saved_halals,shft_fkey,sc_code,chr_taxcode)
		--	values (s.company,s.chrcode,s.chname,s.chaddress,s.chtel,s.chfax,s.chpcntct,s.chmobile,
  --          s.chacct,s.saved_halals,s.shft_fkey,s.sc_code,s.chr_taxcode);'					
		end

------- Added on 2023-10-18 AA moved outside the card condition ----------------------------------------------------------------------
		set @sqlmsg='merge pos_chrt as t '
		+ ' using '
		+ '(select distinct * from [mainserver].'+@dbc+'pos_chrt where company='+@lbranch+') s'  -- Fixed on 2023-10-18 AA a bug using dsccompany instead of company
		+ ' on t.company=s.company and t.chrcode=s.chrcode'
		+ ' when matched then '
		+ ' update set t.chname=s.chname,t.chaddress=s.chaddress,t.chtel=s.chtel,t.chpcntct=s.chpcntct,t.chmobile=s.chmobile,
			t.chacct=s.chacct,t.saved_halals=s.saved_halals,t.shft_fkey=s.shft_fkey,t.sc_code=s.sc_code,t.chr_taxcode=s.chr_taxcode '
		+ ' when not matched then '
		+ ' insert (company,chrcode,chname,chaddress,chtel,chfax,chpcntct,chmobile
            ,chacct,saved_halals,shft_fkey,sc_code,chr_taxcode)
			values (s.company,s.chrcode,s.chname,s.chaddress,s.chtel,s.chfax,s.chpcntct,s.chmobile,
            s.chacct,s.saved_halals,s.shft_fkey,s.sc_code,s.chr_taxcode);'

		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-14
			return 
		end
		else commit transaction
----------------------------------------------------------------------------------------------------------------------------------------------
-------- Added on 2023-10-09 AA to send installment_cmp table --------------------------------------------------------------------
        if @lcountrycode<>1 -- Added on 2023-12-26 AA 
		begin
			set @sqlmsg='merge installment_cmp as t '
			+ ' using '
			+ '(select distinct * from [mainserver].'+@dbc+'installment_cmp where inscompany='+@lbranch+') s'
			+ ' on t.inscompany=s.inscompany and t.inscode=s.inscode '
			+ ' when matched then '
			+ ' update set t.insshort=s.insshort,t.insname=s.insname,t.inscommamt=s.inscommamt,t.inscommprcnt=s.inscommprcnt,
				t.instaxable=s.instaxable,t.insacct=s.insacct,t.inslname=s.inslname,t.inscontact=s.inscontact,t.insmobile=s.insmobile,
				t.insinactive=s.insinactive,t.cmsn_pd_by_buyer=s.cmsn_pd_by_buyer,t.inscmsnacct=s.inscmsnacct,
				t.commp_notrtnd=s.commp_notrtnd,t.ins_taxcode=s.ins_taxcode '
			+ ' when not matched then '
			+ ' insert (inscompany, inscode, insshort, insname, inscommamt, inscommprcnt, instaxable, insacct, modified, inslname,
				lastupdt, inscontact, insmobile, usrid, insinactive, cmsn_pd_by_buyer, inscmsnacct, commp_notrtnd, ins_taxcode)
				values (s.inscompany,s.inscode,s.insshort,s.insname,s.inscommamt,s.inscommprcnt,s.instaxable,s.insacct,s.modified,s.inslname,
				s.lastupdt,s.inscontact,s.insmobile,s.usrid,s.insinactive,s.cmsn_pd_by_buyer,s.inscmsnacct,s.commp_notrtnd,s.ins_taxcode);'

			begin transaction
			exec sp_executesql @sqlmsg
			if @@error<>0 
			begin
				rollback transaction
				set @errstatus=-14
				return 
			end
			else commit transaction
		end
------------------------------------------------------------------------------------------------
	---- 
	---------------------  Move records from HO stoffers table to branch  
	----
--	    begin try
			set @sqlmsg='merge stoffers_main as t '
			set @sqlmsg= @sqlmsg+' using '
			+ '(select distinct * from [mainserver].'+@dbc+'stoffers_main '
			+ ' where company='+@lbranch+' and (slcenter='''+@lslcenter+''' or len(slcenter)=0) and lastupdt<>''18991230'' and rtrim(lastupdt)<>'''' and lastupdt>='+@fmdate+') as s '  
			set @sqlmsg= @sqlmsg+' on t.company=s.company and t.slcenter=s.slcenter and t.offer_no=s.offer_no '
			+ ' when matched then '
			+ ' update set t.disctype=s.disctype,t.grp_min_qty=s.grp_min_qty,t.grp_GivenAmt=s.grp_GivenAmt,t.StartDate=s.StartDate,'
			+ ' t.EndDate=s.EndDate,t.InActive=s.InActive,t.grp_no=s.grp_no,t.dstrbute_type=s.dstrbute_type,t.itemgroup=s.itemgroup,t.lastupdt =s.lastupdt,
			    t.offer_desc=s.offer_desc,t.offer_date=s.offer_date,t.entries=s.entries '
			set @sqlmsg= @sqlmsg+' when not matched then '
			set @sqlmsg= @sqlmsg+' insert (company, slcenter, offer_no, offer_date, offer_desc, disctype, itemgroup, StartDate, EndDate, StartTime,
			                               EndTime, InActive, lastupdt, added_date, usrid, usridchg, grp_no, grp_givenamt, grp_min_qty, entries, pricetp, 
                                           offer_expired, dstrbute_type)
			    values (s.company, s.slcenter, s.offer_no, s.offer_date, s.offer_desc, s.disctype, s.itemgroup, s.StartDate, s.EndDate, s.StartTime,
			                               s.EndTime, s.InActive, s.lastupdt, s.added_date, s.usrid, s.usridchg, s.grp_no, s.grp_givenamt, s.grp_min_qty, s.entries, s.pricetp, 
                                           s.offer_expired, s.dstrbute_type);'
			begin transaction
			exec sp_executesql @sqlmsg
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-15
				return 
			end


			set @sqlmsg='merge stoffers as t '
			set @sqlmsg= @sqlmsg+' using '
			+ '(select distinct a.* from [mainserver].'+@dbc+'stoffers a inner join [mainserver].'+@dbc+'stoffers_main b 
			    on a.company=b.company and a.slcenter=b.slcenter and a.offer_no=b.offer_no'
			+ ' where b.company='+@lbranch+' and (b.slcenter='''+@lslcenter+''' or len(b.slcenter)=0) and b.lastupdt<>''18991230'' and rtrim(b.lastupdt)<>'''' and b.lastupdt>='+@fmdate+') as s '  
			set @sqlmsg= @sqlmsg+' on t.company=s.company and t.slcenter=s.slcenter and t.offer_no=s.offer_no and t.barcode=s.barcode '
			+ ' when matched then '
			+ ' update set t.DiscountP=s.DiscountP,t.disctype=s.disctype,t.MinQty=s.MinQty,t.GivenAmt=s.GivenAmt,t.StartDate=s.StartDate,'
			+ ' t.EndDate=s.EndDate,t.InActive=s.InActive,t.Max2buy=s.Max2buy,t.lprice1=s.lprice1,t.itemgroup=s.itemgroup,t.lastupdt =s.lastupdt,
			    t.cmbkey=s.cmbkey,t.qty_offer_sold=s.qty_offer_sold '
			set @sqlmsg= @sqlmsg+' when not matched then '
			set @sqlmsg= @sqlmsg+' insert ( company,slcenter,itemno,unicode,barcode, DiscountP, disctype, 
			    MinQty, GivenAmt, StartDate, EndDate, InActive,lastupdt, Max2buy, lprice1, itemgroup,cmbkey,qty_offer_sold,offer_no)
			    values (s.company,s.slcenter,s.itemno,s.unicode,s.barcode,s.DiscountP,s.disctype,s.MinQty,s.GivenAmt,s.StartDate
                     ,s.EndDate,s.InActive,s.lastupdt,s.Max2buy,s.lprice1,s.itemgroup,s.cmbkey,s.qty_offer_sold,s.offer_no);'
			--begin transaction
			exec sp_executesql @sqlmsg
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-15
				return 
			end

------------ Added to copy the stoffers_dt table to branch -------------------------------------------
			set @sqlmsg='merge stoffers_dt as t '
			set @sqlmsg= @sqlmsg+' using '
			+ '(select distinct b.* from [mainserver].'+@dbc+'stoffers a inner join [mainserver].'+@dbc+'stoffers_dt b'
			+ ' on a.company=b.company and a.slcenter=b.slcenter and a.barcode=b.ms_barcode '
			+ ' where a.company='+@lbranch+' and (a.slcenter='''+@lslcenter+''' or len(a.slcenter)=0) and a.disctype=''9'' and lastupdt<>''18991230'' and rtrim(lastupdt)<>'''' and lastupdt>='+@fmdate+') as s '  
			set @sqlmsg= @sqlmsg+' on t.company=s.company and t.slcenter=s.slcenter and t.offer_no=s.offer_no and t.ms_barcode=s.ms_barcode and t.barcode=s.barcode '
			+ ' when matched then '
			+ ' update set t.price=s.price,t.givenqty=s.givenqty'
			set @sqlmsg= @sqlmsg+' when not matched then '
			set @sqlmsg= @sqlmsg+' insert (company,slcenter,ms_barcode,barcode,price,givenqty,offer_no)
			    values (s.company,s.slcenter,s.ms_barcode,s.barcode,s.price,s.givenqty,s.offer_no);'

			exec sp_executesql @sqlmsg
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-16
				return 
			end
			commit transaction

------- Added on 2024-04-03 AA -----------------------------------------------------
			set @sqlmsg='merge stoffer_grp_hd as t '
			set @sqlmsg= @sqlmsg+' using '
			+ '(select distinct * from [mainserver].'+@dbc+'stoffer_grp_hd ) as s'
			set @sqlmsg= @sqlmsg+' on t.grp_no=s.grp_no  '
			+ ' when matched then '
			+ ' update set t.grp_name=s.grp_name,t.grp_lname=s.grp_lname,t.grp_entries=s.grp_entries,t.amt_dstrbut_type=s.amt_dstrbut_type,
			    t.grp_inactive=s.grp_inactive,t.lastupdt=s.lastupdt,t.usridchg=s.usridchg'
			set @sqlmsg= @sqlmsg+' when not matched then '
			set @sqlmsg= @sqlmsg+' insert (grp_no, grp_name, grp_lname, grp_entries, amt_dstrbut_type, grp_inactive, Added_date, lastupdt, usrid, usridchg)
			                       values (s.grp_no, s.grp_name, s.grp_lname, s.grp_entries, s.amt_dstrbut_type, s.grp_inactive, s.Added_date, 
								   s.lastupdt, s.usrid, s.usridchg);'
			begin transaction
			exec sp_executesql @sqlmsg
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-88
				return 
			end
			set @sqlmsg='merge stoffer_grp_dt as t '
			set @sqlmsg= @sqlmsg+' using '
			+ '(select distinct a.* from [mainserver].'+@dbc+'stoffer_grp_dt a inner join [mainserver].'+@dbc+'stoffer_grp_hd b'
			+ ' on a.grp_no=b.grp_no '
			+ ' where lastupdt<>''18991230'' and rtrim(lastupdt)<>'''' and lastupdt>='+@fmdate+') as s '  
			set @sqlmsg= @sqlmsg+' on t.grp_no=s.grp_no and t.barcode=s.barcode '
			+ ' when matched then '
			+ ' update set t.dstrb_percent=s.dstrb_percent,t.minqty=s.minqty'
			set @sqlmsg= @sqlmsg+' when not matched then '
			set @sqlmsg= @sqlmsg+' insert (grp_no, barcode, dstrb_percent, minqty)
			    values (s.grp_no, s.barcode, s.dstrb_percent, s.minqty);'

			exec sp_executesql @sqlmsg
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-89
				return 
			end
------------------------------------------------------------------------------------------------------------------------
			commit transaction
		--END TRY
		--BEGIN CATCH
		--		if @@TRANCOUNT>0 ROLLBACK TRANSACTION
		--		--SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  

		--		set @errstatus=0
				
		--END CATCH

	---- 
	---------------------  Move records from HO Poitem_grp table to branch  
	----
	    begin try
			set @sqlmsg='merge Poitem_grp as t '
			set @sqlmsg= @sqlmsg+' using '
			+ '(select distinct * from [mainserver].'+@dbc+'Poitem_grp ) as s'
			set @sqlmsg= @sqlmsg+' on t.company=s.company and t.grp_id=s.grp_id  '
			+ ' when matched then '
			+ ' update set t.grp_name=s.grp_name,t.grp_lname=s.grp_lname,t.net_printer_name=s.net_printer_name'
			set @sqlmsg= @sqlmsg+' when not matched then '
			set @sqlmsg= @sqlmsg+' insert ( company,grp_id,grp_name,grp_lname,net_printer_name)
			                       values (s.company,s.grp_id,s.grp_name,s.grp_lname,s.net_printer_name);'
			begin transaction
			exec sp_executesql @sqlmsg
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-17
				return 
			end
			commit transaction
------------ Added to copy the poitem_btn table to branch -------------------------------------------
			set @sqlmsg='merge poitem_btn as t '
			set @sqlmsg= @sqlmsg+' using '
			+ '(select distinct * from [mainserver].'+@dbc+'poitem_btn ) as s'
			set @sqlmsg= @sqlmsg+' on t.company=s.company and t.button_no=s.button_no and t.grp_id=s.grp_id  '
			+ ' when matched then '
			+ ' update set t.barcode=s.barcode,t.short_name=s.short_name,t.short_lname=s.short_lname,t.cmbkey=s.cmbkey'
			set @sqlmsg= @sqlmsg+' when not matched then '
			set @sqlmsg= @sqlmsg+' insert ( company,button_no,barcode,short_name,short_lname,cmbkey,grp_id)
			    values (s.company,s.button_no,s.barcode,s.short_name,s.short_lname,s.cmbkey,s.grp_id);'
			begin transaction
			exec sp_executesql @sqlmsg
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-18
				return 
			end
			commit transaction
		END TRY
		BEGIN CATCH
				if @@TRANCOUNT>0 ROLLBACK TRANSACTION
				--SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  

				set @errstatus=0
				
		END CATCH
-------- Added on 2024-01-15 AA to send salecntr table --------------------------------------------------------------------
        if @lcountrycode=0  
		begin
			set @sqlmsg='merge salecntr as t '
			+ ' using '
			+ '(select distinct * from [mainserver].'+@dbc+'salecntr where dp_brno='+@lbranch+') s'  
			+ ' on t.dp_brno=s.dp_brno and t.dp_dept=s.dp_dept'
			+ ' when matched then '
			+ ' update set t.bldg_no=s.bldg_no , t.bldg_no_l=s.bldg_no_l , t.street_name=s.street_name , t.street_name_l=s.street_name_l,
			t.area_name=s.area_name , t.area_name_l=s.area_name_l, t.extra_address_no=s.extra_address_no,t.extra_address_no_l=s.extra_address_no_l,
			t.district=s.district,t.district_l=s.district_l,t.city_text=s.city_text,t.city_text_l=s.city_text_l,t.postal_code=s.postal_code,
			t.Other_id_SchemeID=s.Other_id_SchemeID,t.country_code=s.country_code,t.Other_Scheme_Type=s.Other_Scheme_Type'
			+ ' when not matched then
			insert (dp_name, dp_brno, dp_dept, dp_cashser, dp_cslser, dp_oslser, dp_rcslser, dp_roslser, dp_custser, dp_expser, dp_okdiff
			, dp_diffser, dp_mainwh, dp_rtrnwh, lastupdt, dp_comp, dp_fccrdt, nochg_print, modified, srcst, cstcode 
            , dp_crdcardac, dp_rplsac, dp_cardcomm, dp_lname, slwhsrc, prpaidcrdac, FRC_CRSL_FC, inv_form_no, sc_code, sanedcrd_act
			, no_of_invCopies, vat_rcvd_act, custody_ac, stcpay_act, suspended, qitaf_act, slscmnact, webcmnact 
            , tprtexpact, bldg_no, bldg_no_l, street_name, street_name_l, area_name, area_name_l, extra_address_no, extra_address_no_l
			, district, district_l, city_text, city_text_l, street_name2, street_name2_l, postal_code, Other_id_SchemeID 
            , Group_VAT_ID, country_code, Other_Scheme_Type)
			values (s.dp_name,s.dp_brno,s.dp_dept,s.dp_cashser,s.dp_cslser,s.dp_oslser,s.dp_rcslser,s.dp_roslser,s.dp_custser,s.dp_expser,s.dp_okdiff
			,s.dp_diffser,s.dp_mainwh,s.dp_rtrnwh,s.lastupdt,s.dp_comp,s.dp_fccrdt,s.nochg_print,s.modified,s.srcst,s.cstcode 
            ,s.dp_crdcardac,s.dp_rplsac,s.dp_cardcomm,s.dp_lname,s.slwhsrc,s.prpaidcrdac,s.FRC_CRSL_FC,s.inv_form_no,s.sc_code,s.sanedcrd_act
			,s.no_of_invCopies,s.vat_rcvd_act,s.custody_ac,s.stcpay_act,s.suspended,s.qitaf_act,s.slscmnact,s.webcmnact 
            ,s.tprtexpact,s.bldg_no,s.bldg_no_l,s.street_name,s.street_name_l,s.area_name,s.area_name_l,s.extra_address_no,s.extra_address_no_l
			,s.district,s.district_l,s.city_text,s.city_text_l,s.street_name2,s.street_name2_l,s.postal_code,s.Other_id_SchemeID 
            ,s.Group_VAT_ID,s.country_code,s.Other_Scheme_Type);'

			begin transaction
			exec sp_executesql @sqlmsg
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-19
				return 
			end
			commit transaction
		end
end


GO
/****** Object:  StoredProcedure [dbo].[create_messing_columns]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[create_messing_columns]
 
 @errstatus int = 0 output
	
AS
BEGIN
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
		SET NOCOUNT ON
--        declare @
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'STDTL' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.stdtl ADD  rplct_post  bit NULL default (0) with values
			if @@error<>0
			begin
				set @errstatus=-1
				return @errstatus
			end
		end
--
--       Add To Sales_dt Table
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'SALES_DT' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.sales_dt ADD  rplct_post  bit NULL default 0 with values
			if @@error<>0
			begin
				set @errstatus=-3
				return @errstatus
			end
		end
--
--       Add To Gljrdtl Table
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'gljrdtl' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.gljrdtl ADD  rplct_post  bit NULL default 0 with values
			if @@error<>0
			begin
				set @errstatus=-5
				return @errstatus
			end
		end
--
--       Add To Pudtl Table
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pudtl' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.pudtl ADD  rplct_post  bit NULL default 0 with values
			if @@error<>0
			begin
				set @errstatus=-7
				return @errstatus
			end
		end
--
--       Add To apdtl Table
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'apdtl' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.apdtl ADD  rplct_post  bit NULL default 0 with values
			if @@error<>0
			begin
				set @errstatus=-9
				return @errstatus
			end
		end
--
--       Add To ardtl Table
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'ardtl' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.ardtl ADD  rplct_post  bit NULL default 0 with values
			if @@error<>0
			begin
				set @errstatus=-11
				return @errstatus
			end
		end
--
--       Add To stcrtpuinv Table  7
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stcrtpuinv' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.stcrtpuinv ADD  rplct_post  bit NULL default 0 with values
			if @@error<>0
			begin
				set @errstatus=-11
				return @errstatus
			end
		end
--
--       Add To gljrcost Table 8
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'gljrcost' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.gljrcost ADD  rplct_post  bit NULL default 0 with values
			if @@error<>0
			begin
				set @errstatus=-11
				return @errstatus
			end
		end
--
--       Add To bkbnfch Table 9
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bkbnfch' and COLUMN_NAME='bmemid')
		begin 
		    ALTER TABLE dbo.bkbnfch ADD  bmemid  char(20) NULL default '' with values
			if @@error<>0
			begin
				set @errstatus=-12
				return @errstatus
			end
		end
      if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bkbnfch' and COLUMN_NAME='brepname')
		begin 
		    ALTER TABLE dbo.bkbnfch ADD  brepname  char(40) NULL default '' with values
			if @@error<>0
			begin
				set @errstatus=-13
				return @errstatus
			end
		end
--
--       Add To bktransx Table 10
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='bcode')
		begin 
		    ALTER TABLE dbo.bktransx ADD  bcode  char(4) NULL default '' with values
			if @@error<>0
			begin
				set @errstatus=-14
				return @errstatus
			end
		end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='bal')
		begin 
		    ALTER TABLE dbo.bktransx ADD  bal  numeric(13, 3) NULL default 0 with values
			if @@error<>0
			begin
				set @errstatus=-15
				return @errstatus
			end
		end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='stk')
		begin 
		    ALTER TABLE dbo.bktransx ADD  stk  numeric(13, 3) NULL default 0 with values
			if @@error<>0
			begin
				set @errstatus=-16
				return @errstatus
			end
		end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='dscac')
		begin 
		    ALTER TABLE dbo.bktransx ADD  dscac  char(19) NULL default '' with values
			if @@error<>0
			begin
				set @errstatus=-17
				return @errstatus
			end
		end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='dscamt')
		begin 
		    ALTER TABLE dbo.bktransx ADD  dscamt  numeric(13, 3) NULL default 0 with values
			if @@error<>0
			begin
				set @errstatus=-18
				return @errstatus
			end
		end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='dscptg')
		begin 
		    ALTER TABLE dbo.bktransx ADD  dscptg  numeric(10, 3) NULL default 0 with values
			if @@error<>0
			begin
				set @errstatus=-19
				return @errstatus
			end
		end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='dscdesc')
		begin 
		    ALTER TABLE dbo.bktransx ADD  dscdesc  char(70) NULL default '' with values
			if @@error<>0
			begin
				set @errstatus=-20
				return @errstatus
			end
		end		
--
--       Add To Sales_dd Table 11
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'SALES_DD' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.sales_dd ADD  rplct_post  bit NULL default 0 with values
			if @@error<>0
			begin
				set @errstatus=-3
				return @errstatus
			end
		end
		return @errstatus
end














GO
/****** Object:  StoredProcedure [dbo].[create_messing_columns_MAE]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[create_messing_columns_MAE]

 @errstatus int = 0 output

AS
BEGIN
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
		SET NOCOUNT ON
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='fm_price1')
		begin 
		    ALTER TABLE dbo.stbranch ADD  fm_price1  numeric(6,0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='to_price1')
		begin 
		    ALTER TABLE dbo.stbranch ADD  to_price1  numeric(6,0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-102
				return @errstatus
			end
		end
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='doz_price1')
		begin 
		    ALTER TABLE dbo.stbranch ADD  doz_price1  numeric(6,0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-103
				return @errstatus
			end
		end
--       
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='ctn_price1')
		begin 
		    ALTER TABLE dbo.stbranch ADD  ctn_price1  numeric(6,0) NULL default 0
			if @@error<>0
			begin
				set @errstatus=-104
				return @errstatus
			end
		end
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='fm_price2')
		begin 
		    ALTER TABLE dbo.stbranch ADD  fm_price2  numeric(6,0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-105
				return @errstatus
			end
		end
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='to_price2')
		begin 
		    ALTER TABLE dbo.stbranch ADD  to_price2  numeric(6,0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-106
				return @errstatus
			end
		end
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='doz_price2')
		begin 
		    ALTER TABLE dbo.stbranch ADD  doz_price2  numeric(6,0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-107
				return @errstatus
			end
		end
--       
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='ctn_price2')
		begin 
		    ALTER TABLE dbo.stbranch ADD  ctn_price2  numeric(6,0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-108
				return @errstatus
			end
		end
--
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='fm_price3')
		begin 
		    ALTER TABLE dbo.stbranch ADD  fm_price3  numeric(6,0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-109
				return @errstatus
			end
		end
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='to_price3')
		begin 
		    ALTER TABLE dbo.stbranch ADD  to_price3  numeric(6,0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-110
				return @errstatus
			end
		end
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='doz_price3')
		begin 
		    ALTER TABLE dbo.stbranch ADD  doz_price3  numeric(6,0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-111
				return @errstatus
			end
		end
--       
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='ctn_price3')
		begin 
		    ALTER TABLE dbo.stbranch ADD  ctn_price3  numeric(6,0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-112
				return @errstatus
			end
		end

        if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'ord_hdr' and COLUMN_NAME='splyinv')
		begin 
		    ALTER TABLE dbo.ord_hdr alter COLUMN splyinv varchar(20) NULL
			if @@error<>0
			begin
				set @errstatus=-130
				return @errstatus
			end
		end

        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'ord_dtl' and COLUMN_NAME='splyinv')
		begin 
		    ALTER TABLE dbo.ord_dtl add splyinv varchar(20) NULL default ''
			if @@error<>0
			begin
				set @errstatus=-130
				return @errstatus
			end
		end

        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'ord_dtl' and COLUMN_NAME='dlvrydate')
		begin 
		    ALTER TABLE dbo.ord_dtl add dlvrydate char(8) NULL default ''
			if @@error<>0
			begin
				set @errstatus=-130
				return @errstatus
			end
		end
 
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'ord_dtl' and COLUMN_NAME='caser')
		begin 
		    ALTER TABLE dbo.ord_dtl add caser char(19) NULL default ''
			if @@error<>0
			begin
				set @errstatus=-130
				return @errstatus
			end
		end

        if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'puhdr' and COLUMN_NAME='splyinv')
		begin 
		    ALTER TABLE dbo.puhdr alter COLUMN splyinv char(20)
			if @@error<>0
			begin
				set @errstatus=-131
				return @errstatus
			end
		end

        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pudtl' and COLUMN_NAME='whno')
		begin 
		    ALTER TABLE dbo.pudtl add whno char(2) NULL default ''
			if @@error<>0
			begin
				set @errstatus=-132
				return @errstatus
			end
		end

        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pudtl' and COLUMN_NAME='splyinv')
		begin 
		    ALTER TABLE dbo.pudtl add splyinv char(20) NULL default ''
			if @@error<>0
			begin
				set @errstatus=-133
				return @errstatus
			end
		end

-- it has a problem since splyinv is part  of an index
--        if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stcrtpuinv' and COLUMN_NAME='splyinv')
--		begin 
--		    ALTER TABLE dbo.stcrtpuinv alter COLUMN splyinv char(20)
--			if @@error<>0
--			begin
--				set @errstatus=-134
--				return @errstatus
--			end
--		end

      if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'supplier' and COLUMN_NAME='whno')
		begin 
		    ALTER TABLE dbo.supplier add whno char(2) NULL default ''
			if @@error<>0
			begin
				set @errstatus=-135
				return @errstatus
			end
		end

      if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_hd' and COLUMN_NAME='remarks')
		begin 
		    ALTER TABLE dbo.sales_hd add remarks char(1) NULL default ''
			if @@error<>0
			begin
				set @errstatus=-136
				return @errstatus
			end
		end

      if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_hd' and COLUMN_NAME='remarks2')
		begin 
		    ALTER TABLE dbo.sales_hd add remarks2 char(40) NULL default ''
			if @@error<>0
			begin
				set @errstatus=-136
				return @errstatus
			end
		end

      if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_qh' and COLUMN_NAME='usrid')
		begin 
		    ALTER TABLE dbo.sales_qh add usrid char(10) NULL default ''
			if @@error<>0
			begin
				set @errstatus=-137
				return @errstatus
			end
		end

        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'puhdr' and COLUMN_NAME='shpdate')
		begin 
		    ALTER TABLE dbo.puhdr add shpdate char(8) null default ''
			if @@error<>0
			begin
				set @errstatus=-138
				return @errstatus
			end
		end

-- july 23,2016  for check and cash transactions
        if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='cstname')
		begin 
		    ALTER TABLE dbo.bktransx alter COLUMN cstname varchar(60) null
			if @@error<>0
			begin
				set @errstatus=-139
				return @errstatus
			end
		end

        if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_hd' and COLUMN_NAME='remarks2')
		begin 
		    ALTER TABLE dbo.sales_hd alter COLUMN remarks2 varchar(50) null
			if @@error<>0
			begin
				set @errstatus=-140
				return @errstatus
			end
		end

--       if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stitmphoto' and COLUMN_NAME='colors')
--  	 begin 
--	     ALTER TABLE dbo.stitmphoto ADD  colors  varchar(70) NULL default ' ' with values
--			if @@error<>0
--			begin
--				set @errstatus=-113
--				return @errstatus
--			end
--		 end
--
--      if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stitmphoto' and COLUMN_NAME='sizes')
--		begin 
--		    ALTER TABLE dbo.stitmphoto ADD  sizes  varchar(70) NULL default ' ' with values
--			if @@error<>0
--			begin
--				set @errstatus=-114
--				return @errstatus
--			end
--   	end

 --      if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stitmphoto' and COLUMN_NAME='min_slqty')
--		begin 
--		    ALTER TABLE dbo.stitmphoto ADD  min_slqty  numeric(14, 3) NULL default 0 with values
--			if @@error<>0
--			begin
--				set @errstatus=-115
--				return @errstatus
--			end
--		end

--        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stitmphoto' and COLUMN_NAME='splyordno')
--		begin 
--		    ALTER TABLE dbo.stitmphoto ADD  splyordno  char(20) NULL default ' ' with values
--			if @@error<>0
--			begin
--				set @errstatus=-116
--				return @errstatus
--			end
--		end

--        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stitmphoto' and COLUMN_NAME='ordqty')
--		begin 
--		    ALTER TABLE dbo.stitmphoto ADD  ordqty  numeric(14, 3) NULL default 0 with values
--			if @@error<>0
--			begin
--				set @errstatus=-117
--				return @errstatus
--			end
--		end

--        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stitmphoto' and COLUMN_NAME='ordprice')
--		begin 
--		    ALTER TABLE dbo.stitmphoto ADD  ordprice  float NULL default 0 with values
--			if @@error<>0
--			begin
--				set @errstatus=-118
--				return @errstatus
--			end
--		end
        
--		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stitmphoto' and COLUMN_NAME='ordrdlvry')
--		begin 
--		    ALTER TABLE dbo.stitmphoto ADD  ordrdlvry  char(8) NULL default ' ' with values
--			if @@error<>0
--			begin
--				set @errstatus=-119
--				return @errstatus
--			end
--		end
END











GO
/****** Object:  StoredProcedure [dbo].[create_messing_columns_without_default]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- Batch submitted through debugger: create_messing_columns_without_default.sql|7|0|C:\Users\sony\Documents\SQL Server Management Studio\create_messing_columns_without_default.sql





CREATE PROCEDURE [dbo].[create_messing_columns_without_default]
 
 @errstatus int = 0 output
	
AS
BEGIN
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
		SET NOCOUNT ON
--        declare 1
        DECLARE @ConstraintName nvarchar(200),@lcommand nvarchar(200) 

        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'STDTL' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.stdtl ADD  rplct_post  bit NULL default (0) 
			if @@error<>0
			begin
				set @errstatus=-1
				return @errstatus
			end
		end
--
--       Add To Sales_dt Table 2
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'SALES_DT' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.sales_dt ADD  rplct_post  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-3
				return @errstatus
			end
		end
--
--       Add To Gljrdtl Table 3
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'gljrdtl' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.gljrdtl ADD  rplct_post  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-5
				return @errstatus
			end
		end
--
--       Add To Pudtl Table 4
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pudtl' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.pudtl ADD  rplct_post  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-7
				return @errstatus
			end
		end
--
--       Add To apdtl Table 5
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'apdtl' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.apdtl ADD  rplct_post  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-9
				return @errstatus
			end
		end
--
--       Add To ardtl Table  6
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'ardtl' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.ardtl ADD  rplct_post  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-11
				return @errstatus
			end
		end
--
--       Add To stcrtpuinv Table  7
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stcrtpuinv' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.stcrtpuinv ADD  rplct_post  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-11
				return @errstatus
			end
		end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stcrtpuinv' and COLUMN_NAME='slcode')
		begin 
		    ALTER TABLE dbo.stcrtpuinv ADD  slcode  char(2) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-11
				return @errstatus
			end
		end
--
--       Add To gljrcost Table 8
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'gljrcost' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.gljrcost ADD  rplct_post  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-11
				return @errstatus
			end
		end
        if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'gljrcost' and COLUMN_NAME='amt' 
		              AND DATA_TYPE='numeric')
		begin
			ALTER TABLE dbo.gljrcost ALTER column  amt  float NULL
			if @@error<>0
			begin
				set @errstatus=-73
				return @errstatus
			end
		end
--
--       Add To Sales_dd Table 9
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'SALES_DD' and COLUMN_NAME='rplct_post')
		begin 
		    ALTER TABLE dbo.sales_dd ADD  rplct_post  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-3
				return @errstatus
			end
		end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'SALES_DD' and COLUMN_NAME='folio')
		begin 
		    ALTER TABLE dbo.sales_dd ADD  folio  numeric(4,0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-3
				return @errstatus
			end
			--begin transaction
			--update sales_dd set folio=(next value for seq1)
			--if @@error<>0
			--begin
			--	set @errstatus=-3
			--	rollback transaction
			--	return @errstatus
			--end
			--commit transaction
		end
--
--       Add To bkbnfch Table 10
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bkbnfch' and COLUMN_NAME='bmemid')
		begin 
		    ALTER TABLE dbo.bkbnfch ADD  bmemid  char(20) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-12
				return @errstatus
			end
		end
      if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bkbnfch' and COLUMN_NAME='brepname')
		begin 
		    ALTER TABLE dbo.bkbnfch ADD  brepname  char(40) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-13
				return @errstatus
			end
		end
--
--       Add To bktransx Table 11
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='bcode')
		begin 
		    ALTER TABLE dbo.bktransx ADD  bcode  char(6) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-14
				return @errstatus
			end
		end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='bal')
		begin 
		    ALTER TABLE dbo.bktransx ADD  bal  numeric(13, 3) NULL default 0
			if @@error<>0
			begin
				set @errstatus=-15
				return @errstatus
			end
		end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='stk')
		begin 
		    ALTER TABLE dbo.bktransx ADD  stk  numeric(13, 3) NULL default 0
			if @@error<>0
			begin
				set @errstatus=-16
				return @errstatus
			end
		end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='dscac')
		begin 
		    ALTER TABLE dbo.bktransx ADD  dscac  char(19) NULL default ''
			if @@error<>0
			begin
				set @errstatus=-17
				return @errstatus
			end
		end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='dscamt')
		begin 
		    ALTER TABLE dbo.bktransx ADD  dscamt  numeric(13, 3) NULL default 0
			if @@error<>0
			begin
				set @errstatus=-18
				return @errstatus
			end
		end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='dscptg')
		begin 
		    ALTER TABLE dbo.bktransx ADD  dscptg  numeric(10, 3) NULL default 0
			if @@error<>0
			begin
				set @errstatus=-19
				return @errstatus
			end
		end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='dscdesc')
		begin 
		    ALTER TABLE dbo.bktransx ADD  dscdesc  char(70) NULL default ''
			if @@error<>0
			begin
				set @errstatus=-20
				return @errstatus
			end
		end

       if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bktransx' and COLUMN_NAME='ptodate')
		begin 
		    ALTER TABLE dbo.bktransx ADD  ptodate  char(8) NULL default ''
			if @@error<>0
			begin
				set @errstatus=-21
				return @errstatus
			end
		end	

		if (SELECT character_maximum_length FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'bktransx' AND COLUMN_NAME = 'rcvname')<>45
		begin
			ALTER TABLE dbo.bktransx alter column rcvname  varchar(45) 
			if @@error<>0
			begin
				set @errstatus=-21
				return @errstatus
			end
		end
	   		
--
--       Add To sysuse Table 12 
--
      if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sysuse' and COLUMN_NAME='mobileuser')
		begin 
		    ALTER TABLE dbo.sysuse ADD  mobileuser  bit NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-22
				return @errstatus
			end
		end	
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sysuse' and COLUMN_NAME='confirmPurchase')
		begin 
			ALTER TABLE dbo.sysuse ADD  confirmPurchase  bit NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-22
				return @errstatus
			end
		end	
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sysuse' and COLUMN_NAME='noovrdrft')
		begin 
			ALTER TABLE dbo.sysuse ADD  noovrdrft  bit NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-22
				return @errstatus
			end
		end	
			
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sysuse' and COLUMN_NAME='onlyactrmt')
		begin 
			ALTER TABLE dbo.sysuse ADD  onlyactrmt  bit NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-22
				return @errstatus
			end
		end		

		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sysuse' and COLUMN_NAME='confirmbr')
		begin 
			ALTER TABLE dbo.sysuse ADD  confirmbr  bit NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-22
				return @errstatus
			end
		end									
--
--       Add To stbranch Table 13
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='rebate_act')
		begin 
		    ALTER TABLE dbo.stbranch ADD  rebate_act  char(19) NULL default ''  with values
			if @@error<>0
			begin
				set @errstatus=-23
				return @errstatus
			end
		end		
--
--       Add To glsction Table 14
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'glsction' and COLUMN_NAME='rebate_act')
		begin 
		    ALTER TABLE dbo.glsction ADD  rebate_act  char(19) NULL default ''  with values
			if @@error<>0
			begin
				set @errstatus=-24
				return @errstatus
			end
		end	
--				
       if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'glsction' and COLUMN_NAME='LossRebateAct')
		begin 
		    ALTER TABLE dbo.glsction ADD  LossRebateAct  char(19) NULL default ''  with values
			if @@error<>0
			begin
				set @errstatus=-25
				return @errstatus
			end
		end	
--
--       Add To Salecntr Table 15
--			
       if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'salecntr' and COLUMN_NAME='sanedcrd_act')
		begin 
		    ALTER TABLE dbo.salecntr ADD  sanedcrd_act  char(19) NULL default ''  with values
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
		end	
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'salecntr' and COLUMN_NAME='no_of_invCopies')
		begin 
		    ALTER TABLE dbo.salecntr ADD  no_of_invCopies  numeric(1,0) NULL default 1  with values
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
		end	
--
--       Add To Sales_hd Table 16
--			
       if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Sales_hd' and COLUMN_NAME='sanedcrd_amt')
		begin 
		    ALTER TABLE dbo.Sales_hd ADD  sanedcrd_amt  numeric(12,2) NULL default 0.00  
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
		end	
       if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Sales_hd' and COLUMN_NAME='rtncash_dfrpl')
		begin 
		    ALTER TABLE dbo.Sales_hd ADD  rtncash_dfrpl  numeric(12,2) NULL default 0.00  
			if @@error<>0
			begin
				set @errstatus=-126
				return @errstatus
			end
		end	
--
--       Add To bkbnfch Table 17
--			
       if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'bkbnfch' and COLUMN_NAME='dscprsnt')
		begin 
		    ALTER TABLE dbo.bkbnfch ADD  dscprsnt  numeric(5,2) NULL default 0.00  
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
		end	
--
--       Add To SLTRANS Table 20
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'SLTRANS' and COLUMN_NAME='pricePerUnit')
		begin 
			ALTER TABLE dbo.SLTRANS ADD  pricePerUnit  numeric(10,2) NULL default 0.00  
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
		end	
--
--       Add To slvchrimage Table 20
--
        if exists(SELECT table_NAME  FROM INFORMATION_SCHEMA.TABLES  WHERE TABLE_NAME = 'slvchrimage')
		begin
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='voucherNo')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  voucherNo  char(20) NULL default ''  
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end		
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='No_of_cartons')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  No_of_cartons  int NULL default 0  
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end	
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='pricePerUnit')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  pricePerUnit  numeric(10,2) NULL default 0.00 
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end	
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='carrierNo')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  carrierNo  char(3) NULL default ''  
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end	
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='DriverName')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  DriverName  char(30) NULL default ''  
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end	
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='mobileNo')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  mobileNo  nchar(20) NULL default ''  
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end	
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='delivaryDate')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  delivaryDate  char(8) NULL default ''  
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end	
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='rcvdDate')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  rcvdDate  char(8) NULL default ''  
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end	
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='rcvd_person')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  rcvd_person  char(30) NULL default ''  
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end	
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='Pstatus')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  Pstatus  char(1) NULL default ''  
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end	
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='notes')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  notes  text NULL default ''  
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end		
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='src')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  src  char(2) NULL default ''  
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end	
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='vdate')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  vdate  char(8) NULL default ''  
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end		
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='usrid')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  usrid  char(10) NULL default ''  
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end	
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='confirmed')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  confirmed  bit NULL default 0  
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end	

			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='rtnref')
			begin 
				ALTER TABLE dbo.slvchrimage ADD  rtnref  numeric(6,0) NULL default 0
				if @@error<>0
				begin
					set @errstatus=-26
					return @errstatus
				end
			end	
								  
			IF  not EXISTS(SELECT * FROM sys.indexes WHERE object_id = object_id('dbo.slvchrimage') AND NAME ='pk_slvchrimage')
			begin
				IF EXISTS(SELECT * FROM sys.indexes WHERE object_id = object_id('dbo.slvchrimage') AND NAME ='ix_slvchrimage')
				DROP INDEX IX_slvchrimage ON dbo.slvchrimage
				ALTER TABLE slvchrimage
				ADD CONSTRAINT pk_slvchrimage PRIMARY KEY (company,invtype,ref)
			end

		end
--
--       Add To pos_dt Table 20
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_dt' and COLUMN_NAME='nqati_prcnt')
		begin 
			ALTER TABLE dbo.pos_dt ADD  nqati_prcnt  numeric(3,0) NULL default 0.00  
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
		end		

		if (SELECT NUMERIC_PRECISION FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'Pos_dt' AND COLUMN_NAME = 'offer_amt')=5
		begin
			ALTER TABLE dbo.Pos_dt alter column offer_amt  numeric(8,2) 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end						
--
--       Add To apclass Table 20
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'apclass' and COLUMN_NAME='cstcode')
		begin 
			ALTER TABLE dbo.apclass ADD  cstcode  char(4) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
		end		
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'apclass' and COLUMN_NAME='classkey')
		begin 
			ALTER TABLE dbo.apclass ADD  classkey  char(2) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
		end	
--
--       Add To classfil Table 20   29-08-2014
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'classfil' and COLUMN_NAME='cstcode')
		begin 
			ALTER TABLE dbo.classfil ADD  cstcode  char(4) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
		end	
--
--       Add To glcstctr Table 20   29-08-2014
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'glcstctr' and COLUMN_NAME='cs_code')
		begin 
			ALTER TABLE dbo.glcstctr ADD  cs_code  char(4) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
		end	
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'glcstctr' and COLUMN_NAME='whtype')
		begin 
			ALTER TABLE dbo.glcstctr ADD  whtype  tinyint NULL default 1 
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
		end		
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stwhous' and COLUMN_NAME='cstcode')
		begin 
			ALTER TABLE dbo.stwhous ADD  cstcode  char(4) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
		end		
--		
-- pos_dsc Table 
--

		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_dsc' and COLUMN_NAME='nqati_openbal')
		begin 
			ALTER TABLE dbo.pos_dsc ADD  nqati_openbal  numeric(10,2) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
		end	
		if (SELECT character_maximum_length FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'pos_dsc' AND COLUMN_NAME = 'dsctel')<>21
		begin
			ALTER TABLE dbo.pos_dsc alter column dsctel  varchar(21) 
			if @@error<>0
			begin
				set @errstatus=-67
				return @errstatus
			end
		end
--		
-- sales_dd Table 
--
		IF  not EXISTS(SELECT * FROM sys.indexes WHERE object_id = object_id('dbo.sales_dd') AND NAME ='pk_sales_dd')
		begin
			ALTER TABLE sales_dd
			ADD CONSTRAINT pk_sales_dd PRIMARY KEY (company,invtype,ref,folio)
		end	
--		
-- NotifyMe Table 
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'NotifyMe' and COLUMN_NAME='actcode')
		begin 
			ALTER TABLE dbo.NotifyMe ADD  actcode  char(19) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
			ALTER TABLE dbo.NotifyMe ADD  fcy  char(3) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-26
				return @errstatus
			end
		end	
--		
-- puprsnitems Table 
--
        if NOT exists(SELECT table_NAME  FROM INFORMATION_SCHEMA.TABLES  WHERE TABLE_NAME = 'puprsnitems')
		begin
		    create table dbo.puprsnitems(
			 itemno char(16) not null,slcode char(2) null default '', notified  bit NULL default 0			 
			CONSTRAINT [PK_puprsnitems] PRIMARY KEY CLUSTERED 
			(
				[itemno] ASC
			)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
			) ON [PRIMARY]
		end
		else
		begin
			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'puprsnitems' and COLUMN_NAME='notified')
			begin 
				ALTER TABLE dbo.puprsnitems ADD notified  bit NULL default 0 
				if @@error<>0
				begin
					set @errstatus=-88
					return @errstatus
				end
			end								
		end	
--		
-- pos_slp Table 
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_slp' and COLUMN_NAME='ReadInvByBarcd')
		begin 
			ALTER TABLE dbo.pos_slp ADD  ReadInvByBarcd  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-88
				return @errstatus
			end
		end	

--		
-- salesmen Table 
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'salesmen' and COLUMN_NAME='usrid')
		begin 
			ALTER TABLE dbo.salesmen ADD  usrid  char(10) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-89
				return @errstatus
			end
		end	
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'salesmen' and COLUMN_NAME='notify_within')
		begin 
			ALTER TABLE dbo.salesmen ADD  notify_within  int NULL default 15 
			if @@error<>0
			begin
				set @errstatus=-90
				return @errstatus
			end
		end	
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'salesmen' and COLUMN_NAME='notify_type')
		begin 
			ALTER TABLE dbo.salesmen ADD  notify_type  int NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-91
				return @errstatus
			end
		end	
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'salesmen' and COLUMN_NAME='slemail')
		begin 
			ALTER TABLE dbo.salesmen ADD  slemail  varchar(60) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-92
				return @errstatus
			end
		end	
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'salesmen' and COLUMN_NAME='slmobile')
		begin 
			ALTER TABLE dbo.salesmen ADD  slmobile  varchar(20) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-93
				return @errstatus
			end
		end	
--		
-- stoffers Table 
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stoffers' and COLUMN_NAME='Max2buy')
		begin 
			ALTER TABLE dbo.stoffers ADD  Max2buy  int NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-95
				return @errstatus
			end
		end	
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stoffers' and COLUMN_NAME='lprice1')
		begin 
			ALTER TABLE dbo.stoffers ADD  lprice1  numeric(11,2) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-95
				return @errstatus
			end
		end	
--		
-- pos_chrt Table 
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_chrt' and COLUMN_NAME='saved_halals')
		begin 
			ALTER TABLE dbo.pos_chrt ADD  saved_halals  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-96
				return @errstatus
			end
	    end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_chrt' and COLUMN_NAME='shft_fkey')
		begin 
			ALTER TABLE dbo.pos_chrt ADD  shft_fkey  char(2) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-97
				return @errstatus
			end
		end					
--  Arhdr & Ardtl change column data type 
        if  exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'arhdr' and COLUMN_NAME='hd_ltotal' 
		              AND DATA_TYPE='numeric')
		begin
			ALTER TABLE dbo.arhdr ALTER column  hd_ltotal  float NULL
			if @@error<>0
			begin
				set @errstatus=-100
				return @errstatus
			end
			ALTER TABLE dbo.arhdr ALTER column  hd_ftotal  float NULL
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
---
			ALTER TABLE dbo.arhdr ALTER column  hd_lcnet  float NULL
			if @@error<>0
			begin
				set @errstatus=-102
				return @errstatus
			end
			ALTER TABLE dbo.arhdr ALTER column  hd_fcnet  float NULL
			if @@error<>0
			begin
				set @errstatus=-103
				return @errstatus
			end
---
			ALTER TABLE dbo.arhdr ALTER column  hd_lccnet  float NULL
			if @@error<>0
			begin
				set @errstatus=-104
				return @errstatus
			end
			ALTER TABLE dbo.arhdr ALTER column  hd_fccnet  float NULL
			if @@error<>0
			begin
				set @errstatus=-105
				return @errstatus
			end	
			ALTER TABLE dbo.arhdr ALTER column  opst_val  float NULL
			if @@error<>0
			begin
				set @errstatus=-106
				return @errstatus
			end							
		end	
---  Ardtl 
       if  exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'ardtl' and COLUMN_NAME='dt_lcamt' 
		              AND DATA_TYPE='numeric')
		begin
			ALTER TABLE dbo.ardtl ALTER column  dt_lcamt  float NULL
			if @@error<>0
			begin
				set @errstatus=-107
				return @errstatus
			end
			ALTER TABLE dbo.ardtl ALTER column  dt_paidamt  float NULL
			if @@error<>0
			begin
				set @errstatus=-108
				return @errstatus
			end
---
			ALTER TABLE dbo.ardtl ALTER column  dt_discamt  float NULL
			if @@error<>0
			begin
				set @errstatus=-109
				return @errstatus
			end
			ALTER TABLE dbo.ardtl ALTER column  dt_fcamt  float NULL
			if @@error<>0
			begin
				set @errstatus=-110
				return @errstatus
			end
---
			ALTER TABLE dbo.ardtl ALTER column  dt_fpydamt  float NULL
			if @@error<>0
			begin
				set @errstatus=-111
				return @errstatus
			end
			ALTER TABLE dbo.ardtl ALTER column  dt_fdscamt  float NULL
			if @@error<>0
			begin
				set @errstatus=-112
				return @errstatus
			end	
			ALTER TABLE dbo.ardtl ALTER column  dt_lcaloc  float NULL
			if @@error<>0
			begin
				set @errstatus=-113
				return @errstatus
			end	
			ALTER TABLE dbo.ardtl ALTER column  dt_fcaloc  float NULL
			if @@error<>0
			begin
				set @errstatus=-114
				return @errstatus
			end											
		end		
--
-- Sales_qd
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'SALES_QD' and COLUMN_NAME='folio')
		begin 
		    ALTER TABLE dbo.sales_qd ADD  folio  numeric(4,0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-115
				return @errstatus
			end
	    end																																				   	   																																				
		

-- To fix the Nchar data type in slvchrimage & stitembc

       if  exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'slvchrimage' and COLUMN_NAME='mobileNo' 
		              AND DATA_TYPE='NCHAR')
		begin
			
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[slvchrimage]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'mobileNo' AND
			object_id = OBJECT_ID(N'[slvchrimage]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[slvchrimage] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
			    set @errstatus=-116			
			 	return @errstatus
				end
			end
--			ALTER TABLE [dbo].[slvchrimage] drop  CONSTRAINT @ConstraintName --DF__slvchrima__mobil__4FD1D5C8

			ALTER TABLE dbo.slvchrimage ALTER column  mobileNo  CHAR(20) NULL
			if @@error<>0
			begin
			    set @errstatus=-116			
			 	return @errstatus
			end
		END
      if  exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stitembc' and COLUMN_NAME='pack' 
		              AND DATA_TYPE='NCHAR')
		begin
			ALTER TABLE dbo.stitembc ALTER column  pack  CHAR(1) NULL
			if @@error<>0
			begin
				set @errstatus=-117
				return @errstatus
			end
		END
--		
-- aplcrmt_dt   
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'aplcrmt_dt' and COLUMN_NAME='bname')
		begin 
		    
			ALTER TABLE dbo.aplcrmt_dt ADD  bname  varchar(60) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-100
				return @errstatus
			end
			ALTER TABLE dbo.aplcrmt_dt ADD  bbkacct  varchar(60) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
			ALTER TABLE dbo.aplcrmt_dt ADD  bbank  varchar(50) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-102
				return @errstatus
			end
			ALTER TABLE dbo.aplcrmt_dt ADD  extradsc  numeric(12,2) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-103
				return @errstatus
			end
			ALTER TABLE dbo.aplcrmt_dt ADD  desctxt  varchar(60) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-104
				return @errstatus
			end
		end	
	    if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'aplcrmt_dt' and COLUMN_NAME='venderbal')
		begin 
			ALTER TABLE dbo.aplcrmt_dt ADD  venderbal  float NULL default 0
			if @@error<>0
			begin
				set @errstatus=-106
				return @errstatus
			end
			ALTER TABLE dbo.aplcrmt_dt ADD  diffbal2  float NULL default 0
			if @@error<>0
			begin
				set @errstatus=-107
				return @errstatus
			end
		end
	    if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'aplcrmt_dt' and COLUMN_NAME='cnfdate')
		begin 
			ALTER TABLE dbo.aplcrmt_dt ADD  cnfdate  char(8) NULL 
			if @@error<>0
			begin
				set @errstatus=-108
				return @errstatus
			end
			ALTER TABLE dbo.aplcrmt_dt ADD  usrcnf  char(10) NULL 
			if @@error<>0
			begin
				set @errstatus=-109
				return @errstatus
			end
		end
--		
-- sales_od table
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'SALES_OD' and COLUMN_NAME='folio')
		begin 
		    ALTER TABLE dbo.sales_od ADD  folio  int NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-110
				return @errstatus
			end
        end

--		
-- Ord_dtl table
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'ord_dtl' and COLUMN_NAME='folio')
		begin 
		    ALTER TABLE dbo.ord_dtl ADD  folio  int NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-111
				return @errstatus
			end
        end
		IF  not EXISTS(SELECT NAME FROM sys.indexes WHERE object_id = object_id('dbo.ord_dtl') AND NAME ='ix_ord_dtl2')
		begin
			CREATE NONCLUSTERED INDEX ix_ord_dtl2 
			ON dbo.ord_dtl (company,ref,itemno,unicode);
		end	
--		
-- pos_hd table
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_hd' and COLUMN_NAME='saned_amt')
		begin 
		    ALTER TABLE dbo.pos_hd ADD  saned_amt  numeric(12,2) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-112
				return @errstatus
			end
        end
	   if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_hd' and COLUMN_NAME='chargeamt' 
		              AND DATA_TYPE='numeric')
		begin
			ALTER TABLE dbo.pos_hd ALTER column  chargeamt  float NULL
			if @@error<>0
			begin
				set @errstatus=-113
				return @errstatus
			end
		end	
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_hd' and COLUMN_NAME='rtncshamt')
		begin 
		    ALTER TABLE dbo.pos_hd ADD  rtncshamt  numeric(12,2) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-120
				return @errstatus
			end
        end
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_hd' and COLUMN_NAME='dfvchramt')
		begin 
		    ALTER TABLE dbo.pos_hd ADD  dfvchramt  numeric(12,2) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-121
				return @errstatus
			end
        end

        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_hd' and COLUMN_NAME='frc_rtncash')
		begin 
		    ALTER TABLE dbo.pos_hd ADD  frc_rtncash  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-121
				return @errstatus
			end
        end
--		
-- Pos_mny table
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Pos_mny' and COLUMN_NAME='saned_amt')
		begin 
		    ALTER TABLE dbo.Pos_mny ADD  saned_amt  numeric(12,2) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-116
				return @errstatus
			end
        end
       if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Pos_mny' and COLUMN_NAME='scsaned_amt')
		begin 
		    ALTER TABLE dbo.Pos_mny ADD  scsaned_amt  numeric(12,2) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-117
				return @errstatus
			end
        end
--		
-- Pos_slp table
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_slp' and COLUMN_NAME='alwrtncash')
		begin 
			ALTER TABLE dbo.pos_slp ADD  alwrtncash  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-119
				return @errstatus
			end
		end		
--		
-- Pos_ctr table
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_ctr' and COLUMN_NAME='ctrsaned')
		begin 
			ALTER TABLE dbo.pos_ctr ADD  ctrsaned  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-120
				return @errstatus
			end

		end		
---  stdtl 
       if  exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stdtl' and COLUMN_NAME='qty' 
		              AND DATA_TYPE='numeric')
		begin
			ALTER TABLE dbo.stdtl ALTER column  qty  float NULL
			if @@error<>0
			begin
				set @errstatus=-123
				return @errstatus
			end
        end		
--		
-- aplcrmt_dt   
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'aplcrmt_dt' and COLUMN_NAME='adjval')
		begin 
		    
			ALTER TABLE dbo.aplcrmt_dt ADD  adjval  float NULL default 0.00
			if @@error<>0
			begin
				set @errstatus=-124
				return @errstatus
			end
        end				
--		
-- sales_dt  
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_dt' and COLUMN_NAME='sold_item_status')
		begin 
		    
			ALTER TABLE dbo.sales_dt ADD  sold_item_status  int NULL default 0
			if @@error<>0
			begin
				set @errstatus=-125
				return @errstatus
			end
        end		
--		
-- sthdr   
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sthdr' and COLUMN_NAME='repost')
		begin 
		    
			ALTER TABLE dbo.sthdr ADD  repost  bit NULL default 0
			if @@error<>0
			begin
				set @errstatus=-126
				return @errstatus
			end
        end		
--		
-- Pos_slp table
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_slp' and COLUMN_NAME='alwmtchrtn')
		begin 
			ALTER TABLE dbo.pos_slp ADD  alwmtchrtn  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-127
				return @errstatus
			end
		end	
--		
-- bktransx   
--
		if (SELECT character_maximum_length FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'bktransx' AND COLUMN_NAME = 'bcode')<>6
		begin
			ALTER TABLE dbo.bktransx alter column bcode  char(6) 
			if @@error<>0
			begin
				set @errstatus=-110
				return @errstatus
			end
		end

      if  exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_dt' and COLUMN_NAME='sold_item_status' 
		              AND DATA_TYPE='BIT')
		begin
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[sales_dt]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'sold_item_status' AND
			object_id = OBJECT_ID(N'[sales_dt]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[sales_dt] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
			    set @errstatus=-116			
			 	return @errstatus
				end
			end
			ALTER TABLE dbo.sales_dt ALTER column  sold_item_status  int NULL
			if @@error<>0
			begin
			    set @errstatus=-116			
			 	return @errstatus
			end
		END
--
--       Add To glsction 
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'glsction' and COLUMN_NAME='jv_01')
		begin 
		    ALTER TABLE dbo.glsction ADD  jv_01  numeric(6, 0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-124
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_02  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-125
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_03  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-126
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_04  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-127
				return @errstatus
			end

		    ALTER TABLE dbo.glsction ADD  jv_05  numeric(6, 0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-128
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_06  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-129
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_07  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-130
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_08  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-131
				return @errstatus
			end

		    ALTER TABLE dbo.glsction ADD  jv_09  numeric(6, 0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-132
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_10  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-133
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_11  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-134
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_12  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-135
				return @errstatus
			end

		    ALTER TABLE dbo.glsction ADD  jv_13  numeric(6, 0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-136
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_14  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-137
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_18  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-138
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_19  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-139
				return @errstatus
			end

		    ALTER TABLE dbo.glsction ADD  jv_20  numeric(6, 0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-140
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_21  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-141
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_22  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-142
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_23  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-143
				return @errstatus
			end

		    ALTER TABLE dbo.glsction ADD  jv_24  numeric(6, 0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-144
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_26  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-145
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_27  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-146
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_28  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-147
				return @errstatus
			end

		    ALTER TABLE dbo.glsction ADD  jv_30  numeric(6, 0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-148
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_31  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-149
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_32  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-150
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_33  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-151
				return @errstatus
			end

		    ALTER TABLE dbo.glsction ADD  jv_34  numeric(6, 0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-152
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_45  numeric(10, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-153
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_46  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-154
				return @errstatus
			end

		    ALTER TABLE dbo.glsction ADD  jv_16  numeric(6, 0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-156
				return @errstatus
			end
		    ALTER TABLE dbo.glsction ADD  jv_17  numeric(6, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-157
				return @errstatus
			end
		end
--		
-- stoffers Table 
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stoffers' and COLUMN_NAME='itemgroup')
		begin 
			ALTER TABLE dbo.stoffers ADD  itemgroup  char(1) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-159
				return @errstatus
			end
		end	
--		
-- pos_ctr Table 
--
		if  exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_ctr' and COLUMN_NAME='eftpos')
		begin 
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[pos_ctr]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'eftpos' AND
			object_id = OBJECT_ID(N'[pos_ctr]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[pos_ctr] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
			    set @errstatus=-167			
			 	return @errstatus
				end
			end
			ALTER TABLE dbo.pos_ctr drop  column eftpos 
			if @@error<>0
			begin
				set @errstatus=-163
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_ctr' and COLUMN_NAME='ctreftpos')
		begin 

			ALTER TABLE dbo.pos_ctr ADD  ctreftpos  char(2) NULL default '' 
			if @@error<>0
			begin
				set @errstatus=-164
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_ctr' and COLUMN_NAME='ctrsndecrpos')
		begin
			ALTER TABLE dbo.pos_ctr ADD  ctrsndecrpos  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-165
				return @errstatus
			end
		end	

		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_ctr' and COLUMN_NAME='eftport')
		begin 

			ALTER TABLE dbo.pos_ctr ADD  eftport  numeric(2,0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-166
				return @errstatus
			end
		end
--		
-- pos_slp Table 
--
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_slp' and COLUMN_NAME='alwinvtrnsfr')
		begin 
			ALTER TABLE dbo.pos_slp ADD  alwinvtrnsfr  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-122
				return @errstatus
			end
		end			

--		
-- POS_HD 
--
        if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'POS_HD' and COLUMN_NAME='invdspc' 
		              AND DATA_TYPE='numeric')
		begin
			ALTER TABLE dbo.POS_HD ALTER column  invdspc  float NULL
			if @@error<>0
			begin
				set @errstatus=-160
				return @errstatus
			end
		end
--		
-- POS_HDTI 
--
        if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'POS_HDTI' and COLUMN_NAME='invdspc' 
		              AND DATA_TYPE='numeric')
		begin
			ALTER TABLE dbo.POS_HDTI ALTER column  invdspc  float NULL
			if @@error<>0
			begin
				set @errstatus=-161
				return @errstatus
			end
		end
----------------------------------------------------------------------------------------------------------------------
---
------------  Modification for Dinar currency 
---        
		if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'positems' and COLUMN_NAME='lprice1' 
		              AND DATA_TYPE='numeric')
		begin	
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[positems]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'lprice1' AND
			object_id = OBJECT_ID(N'[positems]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[positems] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
					set @errstatus=-116			
			 		return @errstatus
				end
			end	
			ALTER TABLE dbo.positems ALTER column  lprice1  float NULL 
			if @@error<>0
			begin
			    set @errstatus=-116			
			 	return @errstatus
			end	
		end
		if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'positems' and COLUMN_NAME='lprice2' 
		              AND DATA_TYPE='numeric')
		begin
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[positems]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'lprice2' AND
			object_id = OBJECT_ID(N'[positems]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[positems] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
					set @errstatus=-116			
			 		return @errstatus
				end
			end	
			ALTER TABLE dbo.positems ALTER column  lprice2  float NULL 
			if @@error<>0
			begin
			    set @errstatus=-116			
			 	return @errstatus
			end	
		end
		if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'positems' and COLUMN_NAME='lprice3' 
		              AND DATA_TYPE='numeric')
		begin

			ALTER TABLE dbo.positems ALTER column  lprice3  float NULL 
			if @@error<>0
			begin
			    set @errstatus=-116			
			 	return @errstatus
			end	
		end
		if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'positems' and COLUMN_NAME='mnmprice' 
		              AND DATA_TYPE='numeric')
		begin
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[positems]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'mnmprice' AND
			object_id = OBJECT_ID(N'[positems]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[positems] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
					set @errstatus=-116			
			 		return @errstatus
				end
			end	
			ALTER TABLE dbo.positems ALTER column  mnmprice  float NULL 
			if @@error<>0
			begin
			    set @errstatus=-116			
			 	return @errstatus
			end	
		end
------   POS_HD
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'Pos_hd' AND COLUMN_NAME = 'invpaid')=2
		begin
			ALTER TABLE dbo.Pos_hd alter column invpaid  numeric(12,3) 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end		
			
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'Pos_hd' AND COLUMN_NAME = 'cashamt')=2
		begin
			ALTER TABLE dbo.Pos_hd alter column cashamt  numeric(12,3) 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end	


		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'Pos_hd' AND COLUMN_NAME = 'ccpaid')=2
		begin
			ALTER TABLE dbo.Pos_hd alter column ccpaid  numeric(12,3) 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end	

		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'Pos_hd' AND COLUMN_NAME = 'prepaidamt')=2
		begin
			ALTER TABLE dbo.Pos_hd alter column prepaidamt  numeric(12,3) 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end	
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'Pos_hd' AND COLUMN_NAME = 'saned_amt')=2
		begin
			ALTER TABLE dbo.Pos_hd alter column saned_amt  numeric(12,3) 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end	

		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'Pos_hd' AND COLUMN_NAME = 'rtncshamt')=2
		begin
			ALTER TABLE dbo.Pos_hd alter column rtncshamt  numeric(12,3) 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end	

		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'Pos_hd' AND COLUMN_NAME = 'dfvchramt')=2
		begin
			ALTER TABLE dbo.Pos_hd alter column dfvchramt  numeric(12,3) 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end	
--------  POSRTNINV 
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POSTRNINV' AND COLUMN_NAME = 'rtnamt')=2
		begin
			ALTER TABLE dbo.POSTRNINV alter column rtnamt  numeric(12,3) 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end	
--------  POSCCCARD 
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POSCCCARD' AND COLUMN_NAME = 'ccpaid')=2
		begin
			ALTER TABLE dbo.POSCCCARD alter column ccpaid  numeric(12,3) 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end
--------  POSPPCARD 
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POSPPCARD' AND COLUMN_NAME = 'prepaidamt')=2
		begin
			ALTER TABLE dbo.POSPPCARD alter column prepaidamt  numeric(12,3) 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end	

--------  POSPPCARD 
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POSOFFERS' AND COLUMN_NAME = 'GivenAmt')=2
		begin
			ALTER TABLE dbo.POSOFFERS alter column GivenAmt  numeric(9,3) 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end	

       if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POSOFFERS' AND COLUMN_NAME = 'LPRICE1')=2
		begin
			ALTER TABLE dbo.POSOFFERS alter column LPRICE1  numeric(12,3) 
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end	

--------  POSFCAMT 
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POSFCAMT' AND COLUMN_NAME = 'lcamt')=2
		begin
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[POSFCAMT]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'lcamt' AND
			object_id = OBJECT_ID(N'[POSFCAMT]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[POSFCAMT] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
					set @errstatus=-116			
			 		return @errstatus
				end
			end	
			ALTER TABLE dbo.POSFCAMT alter column lcamt  FLOAT  
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end

--------  POS_DSC 
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POS_DSC' AND COLUMN_NAME = 'mnth_target')=2
		begin
			ALTER TABLE dbo.POS_DSC alter column mnth_target  numeric(12,3)   
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POS_DSC' AND COLUMN_NAME = 'mnthbal')=2
		begin
			ALTER TABLE dbo.POS_DSC alter column mnthbal  numeric(12,3)   
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POS_DSC' AND COLUMN_NAME = 'prepaidamt')=2
		begin
			ALTER TABLE dbo.POS_DSC alter column prepaidamt  numeric(10,3)   
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POS_DSC' AND COLUMN_NAME = 'cust_ttlsales')=2
		begin
			ALTER TABLE dbo.POS_DSC alter column cust_ttlsales  numeric(12,3)   
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end

		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POS_DSC' AND COLUMN_NAME = 'sales_grantd')=2
		begin
			ALTER TABLE dbo.POS_DSC alter column sales_grantd  numeric(12,3)   
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POS_DSC' AND COLUMN_NAME = 'ttl_grantd')=2
		begin
			ALTER TABLE dbo.POS_DSC alter column ttl_grantd  numeric(12,3)   
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POS_DSC' AND COLUMN_NAME = 'vchr_value')=2
		begin
			ALTER TABLE dbo.POS_DSC alter column vchr_value  numeric(12,3)   
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POS_DSC' AND COLUMN_NAME = 'vchr_used')=2
		begin
			ALTER TABLE dbo.POS_DSC alter column vchr_used  numeric(12,3)   
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POS_DSC' AND COLUMN_NAME = 'nqati_openbal')=2
		begin
			ALTER TABLE dbo.POS_DSC alter column nqati_openbal  numeric(10,3)   
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end
		

--------  INVHSTRY 
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'INVHSTRY' AND COLUMN_NAME = 'qty')=2
		begin
			ALTER TABLE dbo.INVHSTRY alter column qty  FLOAT   
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'INVHSTRY' AND COLUMN_NAME = 'PRICE')=2
		begin
			ALTER TABLE dbo.INVHSTRY alter column PRICE  FLOAT   
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'INVHSTRY' AND COLUMN_NAME = 'OFFER_AMT')=2
		begin

			ALTER TABLE dbo.INVHSTRY alter column OFFER_AMT  numeric(10,3)    
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end

		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'INVHSTRY' AND COLUMN_NAME = 'qtydel')=2
		begin
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[INVHSTRY]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'qtydel' AND
			object_id = OBJECT_ID(N'[INVHSTRY]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[INVHSTRY] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
					set @errstatus=-116			
			 		return @errstatus
				end
			end	
			ALTER TABLE dbo.INVHSTRY alter column qtydel  FLOAT   
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end
------   POS_DT
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'POS_DT' AND COLUMN_NAME = 'OFFER_AMT')=2
		begin
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[POS_DT]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'OFFER_AMT' AND
			object_id = OBJECT_ID(N'[POS_DT]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[POS_DT] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
					set @errstatus=-116			
			 		return @errstatus
				end
			end	
			ALTER TABLE dbo.POS_DT alter column OFFER_AMT  numeric(9,3)   
			if @@error<>0
			begin
				set @errstatus=-101
				return @errstatus
			end
		end
--------------------------------------------  End of Modification for Dinar currency  ----------------------------																					   	   																																				

----------------------------------------------------------------------------------------------------------------------							
--
--       Add To sysuse Table 12 
--
      if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sysuse' and COLUMN_NAME='mobilNo')
		begin 
		    ALTER TABLE dbo.sysuse ADD  mobilNo  nvarchar(30) NULL default ''  with values
			if @@error<>0
			begin
				set @errstatus=-222
				return @errstatus
			end
		end	
     if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sysuse' and COLUMN_NAME='OTP')
		begin 
		    ALTER TABLE dbo.sysuse ADD  OTP  int NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-223
				return @errstatus
			end
		end	
     if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sysuse' and COLUMN_NAME='web_rights')
		begin 
		    ALTER TABLE dbo.sysuse ADD  web_rights  nvarchar(254) NULL default ''  with values
			if @@error<>0
			begin
				set @errstatus=-224
				return @errstatus
			end
		end	
------   poscccard
		if (SELECT CHARACTER_MAXIMUM_LENGTH FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'poscccard' AND COLUMN_NAME = 'TransDate')=4
		begin
			ALTER TABLE dbo.poscccard alter column TransDate  varchar(10)
			if @@error<>0
			begin
				set @errstatus=-225
				return @errstatus
			end
		end		
		if (SELECT CHARACTER_MAXIMUM_LENGTH FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'poscccard' AND COLUMN_NAME = 'TransTime')=6
		begin
			ALTER TABLE dbo.poscccard alter column TransTime  varchar(10)
			if @@error<>0
			begin
				set @errstatus=-226
				return @errstatus
			end
		end		
--------   sthdr fcyrate
		if (SELECT NUMERIC_PRECISION FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'sthdr' AND COLUMN_NAME = 'fcyrate')=6
		begin
			ALTER TABLE dbo.sthdr alter column fcyrate  numeric(9,6) 
			if @@error<>0
			begin
				set @errstatus=-227
				return @errstatus
			end
		end	
--------  Stitmphoto remarks 
		if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Stitmphoto' and COLUMN_NAME='remarks' 
		              AND CHARACTER_MAXIMUM_LENGTH=70)
		begin
			ALTER TABLE dbo.Stitmphoto ALTER column  remarks  varchar(100) NULL 
			if @@error<>0
			begin
			    set @errstatus=-228			
			 	return @errstatus
			end	
		end

-----------------------------------------------------------------------------------------------------------------------------------------
-------------------------------  To create all needed columns for VAT in some tables ----------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------

		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pudept' and COLUMN_NAME='vat_paid_act')
		begin 
			ALTER TABLE dbo.pudept ADD  vat_paid_act  char(19) NULL default ''  with values
			if @@error<>0
			begin
				set @errstatus=-230
				return @errstatus
			end
		end		
		
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'salecntr' and COLUMN_NAME='vat_rcvd_act')
		begin 
			ALTER TABLE dbo.salecntr ADD  vat_rcvd_act  char(19) NULL default ''  with values
			if @@error<>0
			begin
				set @errstatus=-231
				return @errstatus
			end
		end	
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'puhdr' and COLUMN_NAME='vat_amt_paid')
		begin 
			ALTER TABLE dbo.puhdr ADD  vat_amt_paid  float NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-232
				return @errstatus
			end
		end			
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'puhdr' and COLUMN_NAME='taxfree_purchase')
		begin 
			ALTER TABLE dbo.puhdr ADD  taxfree_purchase  float NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-233
				return @errstatus
			end
		end	
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'puhdr' and COLUMN_NAME='VatNot4Vender')
		begin 
			ALTER TABLE dbo.puhdr ADD  VatNot4Vender  bit NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-234
				return @errstatus
			end
		end	
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'puhdr' and COLUMN_NAME='vndr_taxcode')
		begin 
			ALTER TABLE dbo.puhdr ADD  vndr_taxcode  varchar(20) NULL default ''  with values
			if @@error<>0
			begin
				set @errstatus=-234
				return @errstatus
			end
		end	
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_hd' and COLUMN_NAME='vat_amt_rcvd')
		begin 
			ALTER TABLE dbo.sales_hd ADD  vat_amt_rcvd  float NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-235
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_hd' and COLUMN_NAME='taxfree_sales')
		begin 
			ALTER TABLE dbo.sales_hd ADD  taxfree_sales  float NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-236
				return @errstatus
			end
		end	

		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_qh' and COLUMN_NAME='vat_amt_rcvd')
		begin 
			ALTER TABLE dbo.sales_qh ADD  vat_amt_rcvd  float NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-237
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_qh' and COLUMN_NAME='taxfree_sales')
		begin 
			ALTER TABLE dbo.sales_qh ADD  taxfree_sales  float NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-238
				return @errstatus
			end
		end	
		
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_dh' and COLUMN_NAME='vat_amt_rcvd')
		begin 
			ALTER TABLE dbo.sales_dh ADD  vat_amt_rcvd  float NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-251
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_dh' and COLUMN_NAME='taxfree_sales')
		begin 
			ALTER TABLE dbo.sales_dh ADD  taxfree_sales  float NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-252
				return @errstatus
			end
		end				
				
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stitems' and COLUMN_NAME='taxtype')
		begin 
			ALTER TABLE dbo.stitems ADD  taxtype  char(1) NULL default '1'  with values
			if @@error<>0
			begin
				set @errstatus=-239
				return @errstatus
			end
		end	

		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_hd' and COLUMN_NAME='vat_amt_rcvd')
		begin 
			ALTER TABLE dbo.pos_hd ADD  vat_amt_rcvd  float NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-237
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_hd' and COLUMN_NAME='taxfree_sales')
		begin 
			ALTER TABLE dbo.pos_hd ADD  taxfree_sales  float NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-238
				return @errstatus
			end
		end	

		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_hdti' and COLUMN_NAME='vat_amt_rcvd')
		begin 
			ALTER TABLE dbo.pos_hdti ADD  vat_amt_rcvd  float NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-237
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_hdti' and COLUMN_NAME='taxfree_sales')
		begin 
			ALTER TABLE dbo.pos_hdti ADD  taxfree_sales  float NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-238
				return @errstatus
			end
		end		
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'supplier' and COLUMN_NAME='vndr_taxcode')
		begin 
			ALTER TABLE dbo.supplier ADD  vndr_taxcode  varchar(20) NULL default ''  with values
			if @@error<>0
			begin
				set @errstatus=-239
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'supplier' and COLUMN_NAME='taxfree')
		begin 
			ALTER TABLE dbo.supplier ADD  taxfree  bit NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-240
				return @errstatus
			end
		end	
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'customer' and COLUMN_NAME='clnt_taxcode')
		begin 
			ALTER TABLE dbo.customer ADD  clnt_taxcode  varchar(20) NULL default ''  with values
			if @@error<>0
			begin
				set @errstatus=-241
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'customer' and COLUMN_NAME='taxfree')
		begin 
			ALTER TABLE dbo.customer ADD  taxfree  bit NULL default 0  with values
			if @@error<>0
			begin
				set @errstatus=-242
				return @errstatus
			end
		end		
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'supplier' and COLUMN_NAME='cu_kind')
		begin 
			ALTER TABLE dbo.supplier ADD  cu_kind  char(1) NULL default '1'  with values
			if @@error<>0
			begin
				set @errstatus=-239
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'customer' and COLUMN_NAME='cu_kind')
		begin 
			ALTER TABLE dbo.customer ADD  cu_kind  char(1) NULL default '1'  with values
			if @@error<>0
			begin
				set @errstatus=-239
				return @errstatus
			end
		end		
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'puhdr' and COLUMN_NAME='tax_Pd_mthd')
		begin 
			ALTER TABLE dbo.puhdr ADD  tax_Pd_mthd  char(1) NULL default ''  with values
			if @@error<>0
			begin
				set @errstatus=-234
				return @errstatus
			end
		end			
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_hd' and COLUMN_NAME='clnt_taxcode')
		begin 
			ALTER TABLE dbo.sales_hd ADD  clnt_taxcode  varchar(20) NULL default ''  with values
			if @@error<>0
			begin
				set @errstatus=-241
				return @errstatus
			end
		end
		IF  not EXISTS(SELECT NAME FROM sys.indexes WHERE object_id = object_id('dbo.stcosttype') AND NAME ='ix_stcosttype')
		begin
			CREATE NONCLUSTERED INDEX ix_stcosttype 
			ON dbo.stcosttype (itemno,unicode);
				--ALTER TABLE dbo.stcosttype
				--ADD CONSTRAINT ix_stcosttype FOREIGN KEY (itemno,unicode);
		end	
------   puhdr 2018-01-20 
		if (SELECT NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'puhdr' AND COLUMN_NAME = 'fixrate')=3
		begin
			ALTER TABLE dbo.puhdr alter column fixrate  numeric(9,6) 
			if @@error<>0
			begin
				set @errstatus=-242
				return @errstatus
			end
		end	
		if (SELECT NUMERIC_PRECISION FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'puhdr' AND COLUMN_NAME = 'fcyrate')<=8
		begin
			ALTER TABLE dbo.puhdr alter column fcyrate  numeric(9,6) 
			if @@error<>0
			begin
				set @errstatus=-243
				return @errstatus
			end
		end	

		if (SELECT NUMERIC_PRECISION FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'aphdr' AND COLUMN_NAME = 'hd_fcyrate')<=8
		begin
			ALTER TABLE dbo.aphdr alter column hd_fcyrate  numeric(9,6) 
			if @@error<>0
			begin
				set @errstatus=-244
				return @errstatus
			end
		end	
		if (SELECT NUMERIC_PRECISION FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'arhdr' AND COLUMN_NAME = 'hd_fcyrate')<=8
		begin
			ALTER TABLE dbo.arhdr alter column hd_fcyrate  numeric(9,6) 
			if @@error<>0
			begin
				set @errstatus=-245
				return @errstatus
			end
		end			
		if (SELECT NUMERIC_PRECISION FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'sdhdr' AND COLUMN_NAME = 'hd_fcyrate')<=8
		begin
			ALTER TABLE dbo.sdhdr alter column hd_fcyrate  numeric(9,6) 
			if @@error<>0
			begin
				set @errstatus=-246
				return @errstatus
			end
		end																								
-----------------------------  AAXXVAT    ------------------------------------------
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_hd' and COLUMN_NAME='sysno')
		begin 
			ALTER TABLE dbo.sales_hd ADD  sysno  numeric(1,0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_hd' and COLUMN_NAME='no_round_nm')
		begin 
			ALTER TABLE dbo.sales_hd ADD  no_round_nm  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_hd' and COLUMN_NAME='PriceVatType')
		begin 
			ALTER TABLE dbo.sales_hd ADD  PriceVatType  numeric(1,0) NULL default 1  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_hd' and COLUMN_NAME='hlldscnt')
		begin 
			ALTER TABLE dbo.sales_hd ADD  hlldscnt  float NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'puhdr' and COLUMN_NAME='hlldscnt')
		begin 
			ALTER TABLE dbo.puhdr ADD  hlldscnt  float NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end		

		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_dt' and COLUMN_NAME='taxtype')
		begin 
			ALTER TABLE dbo.sales_dt ADD  taxtype  char(1) NULL default '1'  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pudtl' and COLUMN_NAME='taxtype')
		begin 
			ALTER TABLE dbo.pudtl ADD  taxtype  char(1) NULL default '1'  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
---------------------- Stbranch
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='sysno')
		begin 
			ALTER TABLE dbo.stbranch ADD  sysno  numeric(1,0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='no_round_nm')
		begin 
			ALTER TABLE dbo.stbranch ADD  no_round_nm  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='PriceVatType')
		begin 
			ALTER TABLE dbo.stbranch ADD  PriceVatType  numeric(1,0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='mkt_frc_rounding')
		begin 
			ALTER TABLE dbo.stbranch ADD  mkt_frc_rounding  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='is_dsc_amt')
		begin 
			ALTER TABLE dbo.stbranch ADD  is_dsc_amt  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='auto_dsc_hll')
		begin 
			ALTER TABLE dbo.stbranch ADD  auto_dsc_hll  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbranch' and COLUMN_NAME='max_dsc_hll')
		begin 
			ALTER TABLE dbo.stbranch ADD  max_dsc_hll  numeric(3,2) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
---------------------- glsction
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Glsction' and COLUMN_NAME='sysno')
		begin 
			ALTER TABLE dbo.Glsction ADD  sysno  numeric(1,0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Glsction' and COLUMN_NAME='no_round_nm')
		begin 
			ALTER TABLE dbo.Glsction ADD  no_round_nm  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Glsction' and COLUMN_NAME='PriceVatType')
		begin 
			ALTER TABLE dbo.Glsction ADD  PriceVatType  numeric(1,0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Glsction' and COLUMN_NAME='mkt_frc_rounding')
		begin 
			ALTER TABLE dbo.Glsction ADD  mkt_frc_rounding  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Glsction' and COLUMN_NAME='is_dsc_amt')
		begin 
			ALTER TABLE dbo.Glsction ADD  is_dsc_amt  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Glsction' and COLUMN_NAME='auto_dsc_hll')
		begin 
			ALTER TABLE dbo.Glsction ADD  auto_dsc_hll  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Glsction' and COLUMN_NAME='max_dsc_hll')
		begin 
			ALTER TABLE dbo.Glsction ADD  max_dsc_hll  numeric(3,2) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end

--------------------- POS_MNY
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'POS_MNY' and COLUMN_NAME='fiveh')
		begin 
			ALTER TABLE dbo.POS_MNY ADD  fiveh  numeric(8,0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'POS_MNY' and COLUMN_NAME='tenh')
		begin 
			ALTER TABLE dbo.POS_MNY ADD  tenh  numeric(8,0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'POS_MNY' and COLUMN_NAME='twntyfiveh')
		begin 
			ALTER TABLE dbo.POS_MNY ADD  twntyfiveh  numeric(8,0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'POS_MNY' and COLUMN_NAME='fiftyh')
		begin 
			ALTER TABLE dbo.POS_MNY ADD  fiftyh  numeric(8,0) NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
--------   Pos_hd table --------------------
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Pos_hd' and COLUMN_NAME='discamt')
		begin 
			ALTER TABLE dbo.Pos_hd ADD  discamt  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Pos_hd' and COLUMN_NAME='no_round_nm')
		begin 
			ALTER TABLE dbo.Pos_hd ADD  no_round_nm  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Pos_hd' and COLUMN_NAME='PriceVatType')
		begin 
			ALTER TABLE dbo.Pos_hd ADD  PriceVatType  numeric(1,0) NULL default 1  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end

--------   Pos_hdti table --------------------
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Pos_hdti' and COLUMN_NAME='discamt')
		begin 
			ALTER TABLE dbo.Pos_hdti ADD  discamt  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Pos_hdti' and COLUMN_NAME='no_round_nm')
		begin 
			ALTER TABLE dbo.Pos_hdti ADD  no_round_nm  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Pos_hdti' and COLUMN_NAME='PriceVatType')
		begin 
			ALTER TABLE dbo.Pos_hdti ADD  PriceVatType  numeric(1,0) NULL default 1  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
--------   Pos_dt 
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Pos_dt' and COLUMN_NAME='taxtype')
		begin 
			ALTER TABLE dbo.Pos_dt ADD  taxtype  char(1) NULL default '1'  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
--------   Pos_dtti 
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Pos_dtti' and COLUMN_NAME='taxtype')
		begin 
			ALTER TABLE dbo.Pos_dtti ADD  taxtype  char(1) NULL default '1'  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
-----------------------------------------------------------------------------------
  --------   sales_hd 
     if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_hd' and COLUMN_NAME='extamt' 
		              AND DATA_TYPE='numeric')
		begin
			ALTER TABLE dbo.sales_hd ALTER column  extamt  float NULL
			if @@error<>0
			begin
				set @errstatus=-250
				return @errstatus
			end
		end
 ----------------------------   sales_dt
      if  exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_dt' and COLUMN_NAME='price' 
		              AND DATA_TYPE='NUMERIC')
		begin
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[sales_dt]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'price' AND
			object_id = OBJECT_ID(N'[sales_dt]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[sales_dt] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
			    set @errstatus=-116			
			 	return @errstatus
				end
			end
			ALTER TABLE dbo.sales_dt ALTER column  price  FLOAT  NULL
			if @@error<>0
			begin
			    set @errstatus=-116			
			 	return @errstatus
			end
		END
 ----------------------------   pudtl
      if  exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pudtl' and COLUMN_NAME='price' 
		              AND DATA_TYPE='NUMERIC')
		begin
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[pudtl]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'price' AND
			object_id = OBJECT_ID(N'[pudtl]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[pudtl] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
			    set @errstatus=-116			
			 	return @errstatus
				end
			end
			ALTER TABLE dbo.pudtl ALTER column  price  FLOAT  NULL
			if @@error<>0
			begin
			    set @errstatus=-116			
			 	return @errstatus
			end
		END
----------------------------   sales_hd
      if  exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_hd' and COLUMN_NAME='invpaid' 
		              AND DATA_TYPE='NUMERIC')
		begin
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[sales_hd]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'invpaid' AND
			object_id = OBJECT_ID(N'[sales_hd]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[sales_hd] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
			    set @errstatus=-116			
			 	return @errstatus
				end
			end
			ALTER TABLE dbo.sales_hd ALTER column  invpaid  FLOAT  NULL
			if @@error<>0
			begin
			    set @errstatus=-116			
			 	return @errstatus
			end
		END 
----------------------------   customer
      if  exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'customer' and COLUMN_NAME='cu_name' 
		              AND CHARACTER_MAXIMUM_LENGTH=40)
	  begin
			ALTER TABLE dbo.customer ALTER column  cu_name  varchar(60) not null 
			if @@error<>0
			begin
			    set @errstatus=-116			
			 	return @errstatus
			end
	  end
----------------------------   STUNITS
      if  exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'STUNITS' and COLUMN_NAME='PP2' 
		              AND DATA_TYPE='NUMERIC' and NUMERIC_PRECISION=3)
		begin
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[STUNITS]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'PP2' AND
			object_id = OBJECT_ID(N'[STUNITS]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[STUNITS] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
			    set @errstatus=-116			
			 	return @errstatus
				end
			end
			ALTER TABLE dbo.STUNITS ALTER column  PP2  NUMERIC(6,2)  NULL
			if @@error<>0
			begin
			    set @errstatus=-116			
			 	return @errstatus
			end
		END 

----------------------  PP3

      if  exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'STUNITS' and COLUMN_NAME='PP3' 
		              AND DATA_TYPE='NUMERIC' and NUMERIC_PRECISION=3)
		begin
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[STUNITS]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'PP3' AND
			object_id = OBJECT_ID(N'[STUNITS]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[STUNITS] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
			    set @errstatus=-116			
			 	return @errstatus
				end
			end
			ALTER TABLE dbo.STUNITS ALTER column  PP3  NUMERIC(6,2)  NULL
			if @@error<>0
			begin
			    set @errstatus=-116			
			 	return @errstatus
			end
		END 
-----  add index to apdtl
	IF  not EXISTS(SELECT NAME FROM sys.indexes WHERE object_id = object_id('dbo.apdtl') AND NAME ='ix_apdtl_aging')
		begin
			CREATE UNIQUE NONCLUSTERED INDEX ix_apdtl_aging 
			ON dbo.apdtl (dt_company,dt_cucode,dt_fcy,dt_type,dt_ref,dt_folio);
		end
---  pos_dt 2019-01-04  
       if  exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pos_dt' and COLUMN_NAME='qty' 
		              AND DATA_TYPE='numeric')
		begin
			ALTER TABLE dbo.pos_dt ALTER column  qty  float NULL
			if @@error<>0
			begin
				set @errstatus=-123
				return @errstatus
			end
        end	
---  sales_dt 2019-01-04  
       if  exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_dt' and COLUMN_NAME='qty' 
		              AND DATA_TYPE='numeric')
		begin
			ALTER TABLE dbo.sales_dt ALTER column  qty  float NULL
			if @@error<>0
			begin
				set @errstatus=-123
				return @errstatus
			end
        end	
----------------------------   stunits  2019-01-05  For Top center
      if  exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stunits' and COLUMN_NAME='curbal' 
		              AND DATA_TYPE='NUMERIC')
		begin
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[stunits]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'curbal' AND
			object_id = OBJECT_ID(N'[stunits]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[stunits] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
			    set @errstatus=-116			
			 	return @errstatus
				end
			end
			ALTER TABLE dbo.stunits ALTER column  curbal  FLOAT  NULL
			if @@error<>0
			begin
			    set @errstatus=-116			
			 	return @errstatus
			end
		END 
  if  exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stunits' and COLUMN_NAME='openbal' 
		              AND DATA_TYPE='NUMERIC')
		begin
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[stunits]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'openbal' AND
			object_id = OBJECT_ID(N'[stunits]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[stunits] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
			    set @errstatus=-116			
			 	return @errstatus
				end
			end
			ALTER TABLE dbo.stunits ALTER column  openbal  FLOAT  NULL
			if @@error<>0
			begin
			    set @errstatus=-116			
			 	return @errstatus
			end
		END 
  if  exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stunits' and COLUMN_NAME='rsvqty' 
		              AND DATA_TYPE='NUMERIC')
		begin
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[stunits]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'rsvqty' AND
			object_id = OBJECT_ID(N'[stunits]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[stunits] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
			    set @errstatus=-116			
			 	return @errstatus
				end
			end
			ALTER TABLE dbo.stunits ALTER column  rsvqty  FLOAT  NULL
			if @@error<>0
			begin
			    set @errstatus=-116			
			 	return @errstatus
			end
		END 

----------------------------   stbins 2019-01-05  For Top center
      if  exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbins' and COLUMN_NAME='qty' 
		              AND DATA_TYPE='NUMERIC')
		begin
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[stbins]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'qty' AND
			object_id = OBJECT_ID(N'[stbins]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[stbins] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
			    set @errstatus=-116			
			 	return @errstatus
				end
			end
			ALTER TABLE dbo.stbins ALTER column  qty  FLOAT  NULL
			if @@error<>0
			begin
			    set @errstatus=-116			
			 	return @errstatus
			end
		END 
  if  exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbins' and COLUMN_NAME='openbal' 
		              AND DATA_TYPE='NUMERIC')
		begin
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[stbins]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'openbal' AND
			object_id = OBJECT_ID(N'[stbins]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[stbins] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
			    set @errstatus=-116			
			 	return @errstatus
				end
			end
			ALTER TABLE dbo.stbins ALTER column  openbal  FLOAT  NULL
			if @@error<>0
			begin
			    set @errstatus=-116			
			 	return @errstatus
			end
		END 
  if  exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'stbins' and COLUMN_NAME='rsvqty' 
		              AND DATA_TYPE='NUMERIC')
		begin
			SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID('[stbins]')
			AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = N'rsvqty' AND
			object_id = OBJECT_ID(N'[stbins]'))
			IF @ConstraintName IS NOT NULL
			begin
			   set @lcommand='ALTER TABLE [dbo].[stbins] drop  CONSTRAINT '+@ConstraintName
				exec sp_executesql @lcommand
				if @@error<>0
				begin
			    set @errstatus=-116			
			 	return @errstatus
				end
			end
			ALTER TABLE dbo.stbins ALTER column  rsvqty  FLOAT  NULL
			if @@error<>0
			begin
			    set @errstatus=-116			
			 	return @errstatus
			end
		END 
--------   Pos_hd  2019-01-09  
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Pos_hd' and COLUMN_NAME='outside_order')
		begin 
			ALTER TABLE dbo.Pos_hd ADD  outside_order  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end

--------   Pos_ctr  2019-01-09  
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Pos_ctr' and COLUMN_NAME='ntk_printer1')
		begin 
			ALTER TABLE dbo.Pos_ctr ADD  ntk_printer1  varchar(60) NULL default ''  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end

		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Pos_ctr' and COLUMN_NAME='ntk_printer2')
		begin 
			ALTER TABLE dbo.Pos_ctr ADD  ntk_printer2  varchar(60) NULL default ''  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end

		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Pos_ctr' and COLUMN_NAME='grp_printers')
		begin 
			ALTER TABLE dbo.Pos_ctr ADD  grp_printers  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'Pos_ctr' and COLUMN_NAME='grp_prnt_local')
		begin 
			ALTER TABLE dbo.Pos_ctr ADD  grp_prnt_local  bit NULL default 0  
			if @@error<>0
			begin
				set @errstatus=-247
				return @errstatus
			end
		end



		return @errstatus
end














GO
/****** Object:  StoredProcedure [dbo].[create_messing_columns_without_default_new]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- Batch submitted through debugger: create_messing_columns_without_default.sql|7|0|C:\Users\sony\Documents\SQL Server Management Studio\create_messing_columns_without_default.sql





CREATE PROCEDURE [dbo].[create_messing_columns_without_default_new]
 
 @errstatus int = 0 output
	
AS
BEGIN
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
		SET NOCOUNT ON
--        declare 1
-----------------------------------sales_hd-----------------
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_hd' and COLUMN_NAME='sysno')
		begin 
		    ALTER TABLE dbo.sales_hd ADD  sysno  numeric(1, 0) NULL default (0) 
			if @@error<>0
			begin
				set @errstatus=-1
				return @errstatus
			end
		end
---------------------------sales_hd----
 if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_hd' and COLUMN_NAME='pricevattype')
		begin 
		    ALTER TABLE dbo.sales_hd ADD  pricevattype  numeric(1, 0) NULL default (0) 
			if @@error<>0
			begin
				set @errstatus=-1
				return @errstatus
			end
		end
		------------------------sales_hd-----------------------------------
if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_hd' and COLUMN_NAME='no_round_nm')
		begin 
		    ALTER TABLE dbo.sales_hd ADD  no_round_nm  bit NULL default (0) 
			if @@error<>0
			begin
				set @errstatus=-1
				return @errstatus
			end
		end
		------------------------------------------sales_dt---------------------------
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_dt' and COLUMN_NAME='no_round_nm')
		begin 
		    ALTER TABLE dbo.sales_dt ADD  no_round_nm  bit NULL default (0) 
			if @@error<>0
			begin
				set @errstatus=-1
				return @errstatus
			end
		end

		---------------------------------------------sales_dt-----------------------
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_dt' and COLUMN_NAME='pricevattype')
		begin 
		    ALTER TABLE dbo.sales_dt ADD  pricevattype  numeric(1, 0) NULL default (0) 
			if @@error<>0
			begin
				set @errstatus=-1
				return @errstatus
			end
			end
		---------------------------------sales_dt---------------------------
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'sales_dt' and COLUMN_NAME='taxtype')
		begin 
		    ALTER TABLE dbo.sales_dt ADD  taxtype  numeric(1, 0) NULL default (0) 
			if @@error<>0
			begin
				set @errstatus=-1
				return @errstatus
			end
			end
			---------------------pudtl-------------

			if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'pudtl' and COLUMN_NAME='taxtype')
		begin 
		    ALTER TABLE dbo.pudtl ADD  taxtype  numeric(1, 0) NULL default (0) 
			if @@error<>0
			begin
				set @errstatus=-1
				return @errstatus
			end
			end
		end 







GO
/****** Object:  StoredProcedure [dbo].[create_missing_columns_pp]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[create_missing_columns_pp]

@errstatus int = 0 output

AS
BEGIN
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
		SET NOCOUNT ON
--        declare 1
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'ppemp' and COLUMN_NAME='hist_file')
		begin 
		    ALTER TABLE dbo.ppemp ADD  hist_file  varchar(90) null default ' '
			if @@error<>0
			begin
				set @errstatus=-401
				return @errstatus
			end
		end
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'ppemp' and COLUMN_NAME='iq_xfr_dt')
		begin 
		    ALTER TABLE dbo.ppemp ADD  iq_xfr_dt  char(8) null default ' '
			if @@error<>0
			begin
				set @errstatus=-402
				return @errstatus
			end
		end
--
END











GO
/****** Object:  StoredProcedure [dbo].[create_new_columns_JOB_COSTING]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

create PROCEDURE [dbo].[create_new_columns_JOB_COSTING]

 @errstatus int = 0 output

AS
BEGIN
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
		SET NOCOUNT ON
         if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'jcsetup' and COLUMN_NAME='jc_addmatitm')
		begin 
		    ALTER TABLE dbo.jcsetup ADD  jc_addmatitm  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-501
				return @errstatus
			end
		end
--       
		if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'jcsetup' and COLUMN_NAME='jc_chgmatqty')
		begin 
		    ALTER TABLE dbo.jcsetup ADD  jc_chgmatqty  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-502
				return @errstatus
			end
		end
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'jcsetup' and COLUMN_NAME='jc_chgwsptg')
		begin 
		    ALTER TABLE dbo.jcsetup ADD  jc_chgwsptg  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-503
				return @errstatus
			end
		end
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'jcsetup' and COLUMN_NAME='jc_usefnlwste')
		begin 
		    ALTER TABLE dbo.jcsetup ADD  jc_usefnlwste  bit NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-504
				return @errstatus
			end
		end
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'jcresources' and COLUMN_NAME='rs_level')
		begin 
		    ALTER TABLE dbo.jcresources ADD rs_level  numeric(1,0) NULL default 1 
			if @@error<>0
			begin
				set @errstatus=-505
				return @errstatus
			end
		end
--lvl1 expnses
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'jchdr' and COLUMN_NAME='ch_expentries1')
		begin 
		    ALTER TABLE dbo.jchdr ADD ch_expentries1 numeric(5, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-506
				return @errstatus
			end
		end
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'jchdr' and COLUMN_NAME='ch_expttlhours1')
		begin 
		    ALTER TABLE dbo.jchdr ADD ch_expttlhours1 float NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-507
				return @errstatus
			end
		end
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'jchdr' and COLUMN_NAME='ch_expttlcost1')
		begin 
		    ALTER TABLE dbo.jchdr ADD ch_expttlcost1 float NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-508
				return @errstatus
			end
		end
--lvl2 expenses
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'jchdr' and COLUMN_NAME='ch_expentries2')
		begin 
		    ALTER TABLE dbo.jchdr ADD ch_expentries2 numeric(5, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-509
				return @errstatus
			end
		end
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'jchdr' and COLUMN_NAME='ch_expttlhours2')
		begin 
		    ALTER TABLE dbo.jchdr ADD ch_expttlhours2 float NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-510
				return @errstatus
			end
		end
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'jchdr' and COLUMN_NAME='ch_expttlcost2')
		begin 
		    ALTER TABLE dbo.jchdr ADD ch_expttlcost2 float NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-511
				return @errstatus
			end
		end
--
--lvl3 expenses
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'jchdr' and COLUMN_NAME='ch_expentries3')
		begin 
		    ALTER TABLE dbo.jchdr ADD ch_expentries3 numeric(5, 0) NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-512
				return @errstatus
			end
		end
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'jchdr' and COLUMN_NAME='ch_expttlhours3')
		begin 
		    ALTER TABLE dbo.jchdr ADD ch_expttlhours3 float NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-513
				return @errstatus
			end
		end
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'jchdr' and COLUMN_NAME='ch_expttlcost3')
		begin 
		    ALTER TABLE dbo.jchdr ADD ch_expttlcost3 float NULL default 0 
			if @@error<>0
			begin
				set @errstatus=-514
				return @errstatus
			end
		end
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'jchdr' and COLUMN_NAME='ch_xfr_gnrtdt')
		begin 
		    ALTER TABLE dbo.jchdr ADD ch_xfr_gnrtdt smalldatetime NULL
			if @@error<>0
			begin
				set @errstatus=-515
				return @errstatus
			end
		end
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'jchdr' and COLUMN_NAME='ch_xfr_postdt')
		begin 
		    ALTER TABLE dbo.jchdr ADD ch_xfr_postdt smalldatetime NULL
			if @@error<>0
			begin
				set @errstatus=-516
				return @errstatus
			end
		end
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'jchdr' and COLUMN_NAME='ch_iss_gnrtdt')
		begin 
		    ALTER TABLE dbo.jchdr ADD ch_iss_gnrtdt smalldatetime NULL
			if @@error<>0
			begin
				set @errstatus=-517
				return @errstatus
			end
		end
--
        if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'jchdr' and COLUMN_NAME='ch_iss_postdt')
		begin 
		    ALTER TABLE dbo.jchdr ADD ch_iss_postdt smalldatetime NULL
			if @@error<>0
			begin
				set @errstatus=-518
				return @errstatus
			end
		end
--
       if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'jchdr' and COLUMN_NAME='ch_rcv_gnrtdt')
		begin 
		    ALTER TABLE dbo.jchdr ADD ch_rcv_gnrtdt smalldatetime NULL
			if @@error<>0
			begin
				set @errstatus=-519
				return @errstatus
			end
		end
--
       if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'jchdr' and COLUMN_NAME='ch_rcv_postdt')
		begin 
		    ALTER TABLE dbo.jchdr ADD ch_rcv_postdt smalldatetime NULL
			if @@error<>0
			begin
				set @errstatus=-520
				return @errstatus
			end
		end
--

        if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'jchdr' and COLUMN_NAME='ch_fnlqtyrrcv')
		begin 
		    EXEC sp_rename 'dbo.jchdr.ch_fnlqtyrrcv', 'ch_fnlqtyrcv','COLUMN'
			if @@error<>0
			begin
				set @errstatus=-521
				return @errstatus
			end
		end

--  

       if not exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'jchdr' and COLUMN_NAME='ch_fnlqtyrcv')
		begin 
		    ALTER TABLE dbo.jchdr ADD ch_fnlqtyrcv numeric(12, 3) NULL
			if @@error<>0
			begin
				set @errstatus=-522
				return @errstatus
			end
		end
--

END






GO
/****** Object:  StoredProcedure [dbo].[create_ppcrgt_primary_key]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[create_ppcrgt_primary_key]
as
begin      
   If NOT EXISTS (select * 
              from INFORMATION_SCHEMA.TABLE_CONSTRAINTS 
               where CONSTRAINT_TYPE='PRIMARY KEY' AND  TABLE_NAME='ppcrgt') 
   begin
      alter table ppcrgt DROP COLUMN add_per,value,percentage,spc_from_d,spc_to_d,for_day,per_ampm
           ,sat,sun,mon,tue,wed,thu,fri;
      alter table ppcrgt with NOCHECK  
      ADD CONSTRAINT PK_ppcrgt PRIMARY KEY CLUSTERED (company asc,code asc) 
      WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON)
   end
 end



GO
/****** Object:  StoredProcedure [dbo].[date_convert]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2023-11-25@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[date_convert]
-------- 
 @pdate char(8) output,
 @yr_end varchar(8),
 @alwaysConvert bit,
 @dummy bit
AS
BEGIN
----    Added on 2023-11-19 AA removed the paramter @dummy
----    Added on 2023-11-19 AA Changed the data type of the parameter @pdate from varchar to char . Bug
----    Modified  on 2022-07-20 KAN. it was very old in some customer databases like step by step and causes error		
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
		SET NOCOUNT ON;
		declare	@is_it_hij bit=0

		declare @lcdate varchar(8),
		        @lgrdate date,
				@fndate varchar(10)='',
				@DateConvertFactor int=112,
				@errstatus int =0,
				@db_date_hij bit =0,
				@l_loop_cntr int = 3
				


		set @lcdate=@pdate
		--
		
		SET @db_date_hij=iif(substring(@yr_end,1,2)='14',1,0) 
		SET @is_it_hij=iif(substring(@lcdate,1,2)='14',1,0) 
		set @DateConvertFactor=iif(substring(@lcdate,1,2)='14',131,112)		
		exec dbo.validate_date @lcdate output,@errstatus output	,@lgrdate output
		set @pdate=''
		if  @errstatus in (-1,0)
		begin
		    if @is_it_hij=@db_date_hij or @alwaysConvert=1
			begin
				begin try
						--set @lgrdate= convert(date,@lcdate,@DateConvertFactor)
						if @is_it_hij=1
						begin
							 --set @pdate=convert(varchar(10),@lgrdate,112)
							 --exec dbo.get_correct_hijjri_date @lcdate output,@lgrdate output
							 -- if len(@lcdate)>0
					          set @pdate=FORMAT(@lgrdate,'yyyyMMdd','en-gb')
						end
						else
						begin
						     set @pdate=FORMAT(@lgrdate,'yyyyMMdd','ar')
							--set @fndate=convert(varchar(10),@lgrdate,131)
							--set @pdate=substring(@fndate,7,4)+substring(@fndate,4,2)+iif(substring(@fndate,1,1)=' ','0'+substring(@fndate,2,1),substring(@fndate,1,2))				  
						end
				end try
				begin catch				
						set @pdate=''
				end catch
			end
			else set @pdate=@lcdate
		end
END




GO
/****** Object:  StoredProcedure [dbo].[date_hijjri]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2023-11-25@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[date_hijjri]
--------  Works the same way as VFP function date_hijjri
 @p_date char(8) output,
 @force_melady bit,
 @l_yr_end varchar(8),
 @hjdate_adj int,
 @dummy bit
  	
AS
BEGIN
------- Added on 2023-11-20 AA Added new code to pass the value of @pstrictDate through the variable @errstatus to SP validate_date
------- Added on 2023-11-20 AA when @dummy=0 means if @p_date is 14450430 which is wrong date in hijiri , correct the date & return it as 14450501 
-------                        when @dummy=1 means if @p_date is 14450430 which is wrong date in hijiri , Do not correct the date & return empty string

------- Added on 2023-11-19 AA Changed the data type of the parameter @p_date from varchar to char . Bug
------- Added on 2023-11-15 AA new variable named @hj_today_date
------- Added on 2023-11-15 AA to fixed problem coming from convert function which gives wrong result when convert from hijiri to milady		
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
		SET NOCOUNT ON;
		declare @dbc varchar(20),
				@errstatus int=0
 
        declare @days_to_add int=0,
		@l_loop_cntr int = 3
		

		declare 
		@lcalcomp char(2),
		@yrcode char(4),
		@cal_end varchar(8)=''

		declare @lcdate varchar(8),
		@fndate varchar(10)='',
		@grdate date,
		@lgrgdate date,
		@date_yr char(2),
		@calndr_yr char(2),
		@hj_today_date char(8) --- Added on 2023-11-15 AA
		
-------------  First validate if the passed is correct 		
		set @cal_end=isnull(@l_yr_end,'')
		set @calndr_yr=substring(@cal_end,1,2)

		-- next added K.A.N MAY 18,2018 FRO HIJRI DATE CORRECTION
		if isnull(@hjdate_adj,0)<>0 set @days_to_add=@hjdate_adj
		if @calndr_yr='20' or @force_melady=1 set @days_to_add=0
		-- END OF K.A.N MAY 18,2018

		set @errstatus=0
		set @p_date=isnull(@p_date,'')
		if @p_date='' or len(@p_date)=0
		begin
		    if @calndr_yr='20' or @force_melady=1 set @p_date=convert(char(8),getdate(),112)
			else
			begin
			     --K.A.N MAY 18,2018 FRO HIJRI DATE CORRECTION
				 --set @p_date =FORMAT(getdate(),'yyyyMMdd','ar')
				 set @p_date =FORMAT(DATEADD(day,@hjdate_adj,getdate()),'yyyyMMdd','ar')
			end
			return
		end
------- Added on 2023-11-15 AA to fixed problem coming from convert function which gives wrong result when convert from hijiri to milady
		set @hj_today_date=FORMAT(getdate(),'yyyyMMdd','ar') -- Added on 2023-11-15 AA
		if @calndr_yr='14' and @force_melady=0 and   @hj_today_date=@p_date
		begin
			set @p_date=@hj_today_date
			return
		end
---------------------------------------------------------------------------------------------------------------------------------
        -- i think the problem is in the folloing section it does not get the right date
		-- Not anymore  An shaa Allah . It is fixed

		if @dummy=1 set @errstatus=1 -- Added on 2023-11-20 AA
		 
		set @lcdate=@p_date
		exec dbo.validate_date @lcdate output,@errstatus output,@lgrgdate output
		
		set @date_yr=substring(@lcdate,1,2)
				
		set @p_date=''
		
		if @errstatus in (0,-1) and len(@lcdate)>0
		begin
		    if @force_melady=1
			begin
			    if @date_yr='20' 
				     set @p_date=@lcdate
				else set @p_date=FORMAT(@lgrgdate,'yyyyMMdd','en-gb')
				return
			end
			
			if @date_yr=@calndr_yr 
			begin
				set @p_date=@lcdate
				return
			end

			begin try
				if @calndr_yr='20'
				begin
				    --set @grdate= convert(date,@lcdate,131)
					--exec dbo.get_correct_hijjri_date @lcdate output,@grdate output

					if len(@lcdate)>0
					set @p_date=FORMAT(@lgrgdate,'yyyyMMdd','en-gb')
				end
				else
				begin				    
					--set @grdate= convert(date,@lcdate,112)
					set @p_date=FORMAT(@lgrgdate,'yyyyMMdd','ar')
				end
			end try
			begin catch
			   set @p_date=''
			end catch
		end
END



GO
/****** Object:  StoredProcedure [dbo].[emp_list_with_job]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[emp_list_with_job]
 @x_ms_compcode varchar(2),
 @whereclause  nvarchar(2000),
 @NoOfRecords int output

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
    declare @sqlmsg nvarchar(max)=''

	set @sqlmsg ='with last_job as (
	              select distinct isnull(empno,'''') as empno,isnull( ppdpos.jobno,'''') as jobno from ppdpos where ppdpos.end_date='''')

	              select DISTINCT ppemp.empno,DEPTCODE,first_name,last_name,birth_date,brith_palce,social_state,join_date,
                  id_card, gender, empstatus,DP_NAME,ppemp.id_from,DP_NAME,ppemp.id_date,cast(0.00 as numeric(12,3)) as salary,
                  CAST(0.00 as numeric(12,3)) AS badlat,isnull(ppemp.mobile,'''') as mobile,isnull(bank_acc,'''') as bank_acc,last_job.jobno
                  from ppemp with (NOLOCK) INNER Join PPDEPT with (NOLOCK)
                  on ppemp.company=ppdept.dp_brno and ppemp.deptcode=ppdept.dp_dept and ppdept.dp_comp='+@x_ms_compcode
	set @sqlmsg=@sqlmsg+'inner join last_job with (NOLOCK) on last_job.empno=ppemp.empno
		                 where '+@whereclause ;

		exec sp_executesql @sqlmsg;        
		if @@error<>0 set @NoOfRecords=-1 
		else set @NoOfRecords=@@ROWCOUNT

END




GO
/****** Object:  StoredProcedure [dbo].[fa_uncomplete]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

create PROCEDURE [dbo].[fa_uncomplete]
 @m_cmp char(2),
 @m_type char(2),
 @m_ref  numeric(6,0), 
 @pstmode bit,
 @caokmustfc bit,
 @errcode char(4) output,
 @err_fano char(8) output
 
AS
begin
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
	declare @lptr int =0,
	        @f_total float=0,
	        @l_local float=0,
			@e_local float=0,
			@d_local_db float=0,
			@d_local_cr float=0,
			@d_fcy_db float=0,
			@d_fcy_cr float=0,
			@d_local_eqc_db float=0,
			@d_local_eqc_cr float=0,
			@f_fatyp char(1),
			@f_posted bit,
			@src char(2),
			@f_fcy char(3),
			@f_cyrate numeric(9,6)=0,
			@lcursor cursor,
			@m_fano char(8),
			@m_cucode char(6),
			@m_costtyp char(2),
			@f_dbcr char(1),
			@l_amount float,
			@f_amount float,
			@e_amount float,
			@m_status char(1),
			@f_lcost float,
			@f_lttldep float,
			@f_lyerdep float,
			@f_fcost float,
			@f_fttldep float,
			@f_fyerdep float,
			@f_eqccost float,
			@f_eqcttldep float,
			@f_eqcyerdep float,
			@llcamt float,
			@lfcamt float,
			@leqamt float,
			@m_cost_l_bal float,
			@m_cost_f_bal float,
			@m_cost_e_bal float

	
	set @err_fano=''
	set @errcode='';

 	select @f_posted=fh_posted,@f_fcy=isnull(fh_fcy,''),@f_total=fh_ftotal,@l_local=fh_ltotal,@e_local=fh_ftoteqc,
	       @src=fh_trxsrc,@f_fatyp=fh_fatype,@f_cyrate=fh_fcyrate
	       from fahdr with (NOLOCK) where fh_company=@m_cmp AND fh_type=@m_type AND fh_ref=@m_ref;
    set @lptr=@@rowcount

	if @lptr=0
	begin
		set @errcode='122'
		return
	end
	if @src<>'33'
	begin
		set @errcode='124'
		return
	end
	--if @pstmode=1
	--begin
	--   if  @f_posted=0
	--   begin
	--      set @errcode='122'
	--   end
	--end
	--else
	--begin
	--   if  @f_posted=1
	--   begin
	--  	set @errcode='125'
	--	return
	--   end

    select @d_local_db=sum(case when fd_dbcr='D' then fd_lamount else CAST(0 as float) end),
	       @d_local_cr=sum(case when fd_dbcr='C' then fd_lamount else CAST(0 as float) end),
		   @d_fcy_db=sum(case when fd_dbcr='D' then fd_famount else CAST(0 as float) end),
		   @d_fcy_cr=sum(case when fd_dbcr='C' then fd_famount else CAST(0 as float) end),
		   @d_local_eqc_db=sum(case when fd_dbcr='D' then fd_famteqc else CAST(0 as float) end),
		   @d_local_eqc_cr=sum(case when fd_dbcr='C' then fd_famteqc else CAST(0 as float) end)
		   FROM fadtl with (NOLOCK) WHERE fd_company=@m_cmp AND fd_type=@m_type AND fd_ref=@m_ref
		   group by fd_company,fd_type,fd_ref;

    set @lptr=@@rowcount
	if @lptr=0
	begin
		set @errcode='2047'
		return
	end

	set @errcode='';
    if @f_fatyp='1'  --Cost
	begin
	   -- '1'=Cost local_db+eqv_db==local_cr+eqv_cr  &&from Details
	   if dbo.value_balanced(@l_local,@d_local_db)=0
	   begin
	       set @errcode='2044'
		   return
       end
	   if dbo.value_balanced(@e_local,@d_local_eqc_db)=0
	   begin
	       set @errcode='2046'
		   return
	   end	   

	   if @caokmustfc=1
	   begin
	      if dbo.value_balanced(@f_total,@d_fcy_db)=0
	      begin
	          set @errcode='2045'
		      return
	      end
	   end
	end

   --
    if @f_fatyp='2'--Sales
	begin
	    if (@d_local_db=0 and @d_local_eqc_db=0) or (@l_local=0 and @e_local=0)
		begin
		   set @errcode='2030'
		   return
	    end
	end

    if @f_fatyp='3'  --Scrap
	begin
	    if (@d_local_cr=0 and @d_local_eqc_cr=0) or (@l_local=0 and @e_local=0)
		begin
		   set @errcode='2030'
		   return
	    end
	end

	if @f_fatyp='4' --Adj
	begin
	    if @l_local=0
		begin
		    set @errcode='2047'
			return
		end
		if dbo.value_balanced(@l_local,@d_local_db+@d_local_eqc_db)=0
		begin
		    set @errcode='2048'
			return
		end
        if dbo.value_balanced(@l_local,@d_local_cr+@d_local_eqc_cr)=0
		begin
		    set @errcode='2049'
			return
		end
	end
    if @f_fatyp='9'  --Depretiation
	begin
	    if @l_local=0 and @e_local=0
		begin
		   set @errcode='2047'
		   return
	    end
	end

	set @lcursor = cursor for 
	    select fd_fano,fd_cucode,fd_dbcr,fd_lamount,fd_famount,fd_famteqc,fd_costtyp from fadtl 
		       where fd_company=@m_cmp AND fd_type=@m_type AND fd_ref=@m_ref and fd_fano<>''

        open @lcursor;
		fetch next from @lcursor into @m_fano,@m_cucode,@f_dbcr,@l_amount,@f_amount,@e_amount,@m_costtyp
		while @@FETCH_STATUS = 0
        begin
		    select @m_status=fstatus,@f_lcost=lcost,@f_lttldep=lttldep,@f_lyerdep=lyerdep,
			       @f_fcost=fcost,@f_fttldep=fttldep,@f_fyerdep=fyerdep,
				   @f_eqccost=eqccost,@f_eqcttldep=eqcttldep,@f_eqcyerdep=eqcyerdep
				   from f_assets where company=@m_cmp and fano=@m_fano
			if @@rowcount=0  --if @@error<>0
			begin				  
			    set @errcode='2027'
		        break
			end
		    
			if @m_status<>'1'
			begin
			    set @errcode='2015'
				set @err_fano=@m_fano
		        break
			end

			set @llcamt=IIF(@f_dbcr='D',@l_amount,-@l_amount)
			set @lfcamt=IIF(@f_dbcr='D',@f_amount,-@f_amount)
			set @leqamt=IIF(@f_dbcr='D',@e_amount,-@e_amount)
			
			if @f_fatyp in ('3','4','9')
			begin
			   If @f_lcost-@f_lttldep-@f_lyerdep+@llcamt<0.00 or @f_fcost-@f_fttldep-@f_fyerdep+@lfcamt<0.00 or
			      @f_eqccost-@f_fttldep-@f_eqcyerdep+@leqamt<0.00
			   begin
			       set @err_fano=@m_fano
				   set @errcode='2053'
				   break
			   end
			end

			if @f_fatyp in ('1','4')
			begin
			    if @m_costtyp=''
				begin
				    set @err_fano=@m_fano
					set @errcode='2011'
					break
				end
				
				if @f_dbcr='C'
				begin   
				    select @m_cost_l_bal=lamount,@m_cost_f_bal=famount,@m_cost_e_bal=eqamount
				           from f_cost where company=@m_cmp and fano=@m_fano and costtype=@m_costtyp
				    if @@rowcount=0
                    begin
					    set @err_fano=@m_fano
						set @errcode='2051'  --Can Not Enter Credit Trans For Asset Cost Which Has No Balance
						break
					end
				end
			    if abs(@llcamt)>@m_cost_l_bal or abs(@lfcamt)>@m_cost_f_bal or abs(@leqamt)>@m_cost_e_bal
				begin
				    set @err_fano=@m_fano
					set @errcode='2052'  --Can Not Make Asset Cost Balance Credit 
					break
				end
			end
			fetch next from @lcursor into @m_fano,@m_cucode,@f_dbcr,@l_amount,@f_amount,@e_amount,@m_costtyp
		end
    close @lcursor
    deallocate @lcursor

end












GO
/****** Object:  StoredProcedure [dbo].[fill_tailor_category_initial_data]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[fill_tailor_category_initial_data]
as 
begin
  	begin transaction
    insert [dbo].[tailor_category] ([code], [name], [lname], [intgrtd_record], [modified], [lastupdt]) VALUES ('001','ثوب','Thobe',1,1,'        ')
    insert [dbo].[tailor_category] ([code], [name], [lname], [intgrtd_record], [modified], [lastupdt]) VALUES ('002','كوت','Coat ',1,1,'        ')
    commit transaction
end




GO
/****** Object:  StoredProcedure [dbo].[fill_taxcategory_table]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[fill_taxcategory_table]
as 
begin
	declare @cntr int =0
	select @cntr=count(*) from taxcategory where cat_protected=1
	if isnull(@cntr,0)<>15
	begin
	  begin transaction
	  delete from taxcategory where taxcatID<16
	  commit transaction
  	begin transaction
    insert into taxcategory (taxcatID, taxcat_name, taxcat_lname, cat_protected, lastupdt, [sysname], In_out_tax, txdsc_allowed) values (1,'ضريبة المبيعات المحلية','',1,'','',2,0)
    insert into taxcategory (taxcatID, taxcat_name, taxcat_lname, cat_protected, lastupdt, [sysname], In_out_tax, txdsc_allowed) values (2,'ضريبة مردودات المبيعات','',1,'','',2,0)
    insert into taxcategory (taxcatID, taxcat_name, taxcat_lname, cat_protected, lastupdt, [sysname], In_out_tax, txdsc_allowed) values (3,'اشعارات المبيعات التخفيضات والخصومات','',1,'','',2,0)
    insert into taxcategory (taxcatID, taxcat_name, taxcat_lname, cat_protected, lastupdt, [sysname], In_out_tax, txdsc_allowed) values (4,'ضريبة سلع مستوردة الاحتساب العكسي','',1,'','',2,0)
    insert into taxcategory (taxcatID, taxcat_name, taxcat_lname, cat_protected, lastupdt, [sysname], In_out_tax, txdsc_allowed) values (5,'ضريبة المشتروات المحلية','',1,'','',1,0)
    insert into taxcategory (taxcatID, taxcat_name, taxcat_lname, cat_protected, lastupdt, [sysname], In_out_tax, txdsc_allowed) values (6,'ضريبة مردودات المشتروات','',1,'','',1,0)
    insert into taxcategory (taxcatID, taxcat_name, taxcat_lname, cat_protected, lastupdt, [sysname], In_out_tax, txdsc_allowed) values (7,'اشعارات المشتروات التخفيضات والخصومات','',1,'','',1,0)
    insert into taxcategory (taxcatID, taxcat_name, taxcat_lname, cat_protected, lastupdt, [sysname], In_out_tax, txdsc_allowed) values (8,'ضريبة سلع مستوردة دفعت في الجمارك','',1,'','',1,0)
    insert into taxcategory (taxcatID, taxcat_name, taxcat_lname, cat_protected, lastupdt, [sysname], In_out_tax, txdsc_allowed) values (9,'ضريبة سلع مستوردة الاحتساب العكسي','',1,'','',1,0)
    insert into taxcategory (taxcatID, taxcat_name, taxcat_lname, cat_protected, lastupdt, [sysname], In_out_tax, txdsc_allowed) values (10,'سداد ضريبة القيمة المضافة','Payment of VAT',1,'','',1,0)
    insert into taxcategory (taxcatID, taxcat_name, taxcat_lname, cat_protected, lastupdt, [sysname], In_out_tax, txdsc_allowed) values (11,'ديون معدومة','Dead Debts',1,'','',1,0)
    insert into taxcategory (taxcatID, taxcat_name, taxcat_lname, cat_protected, lastupdt, [sysname], In_out_tax, txdsc_allowed) values (12,'ديون معدومة محصلة','Dead Debts Collected',1,'','',2,0)
    insert into taxcategory (taxcatID, taxcat_name, taxcat_lname, cat_protected, lastupdt, [sysname], In_out_tax, txdsc_allowed) values (13,'تسويات المبيعات','Sales Adustments',1,'','',2,0)
    insert into taxcategory (taxcatID, taxcat_name, taxcat_lname, cat_protected, lastupdt, [sysname], In_out_tax, txdsc_allowed) values (14,'تسويات المشتريات','Procurement adjustments',1,'','',1,0)
    insert into taxcategory (taxcatID, taxcat_name, taxcat_lname, cat_protected, lastupdt, [sysname], In_out_tax, txdsc_allowed) values (15,'ضريبة مشتريات المصاريف الادارية','Purchase tax for administrative expenses',1,'','',1,0)
    commit transaction
	end
end








GO
/****** Object:  StoredProcedure [dbo].[fill_vat_percent_column]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- Modified on 2020-08-23 to fix the bug extamt is added 
-- Modified on 2020-08-23 to fix the bug if vat_percent between 6 and 15 force them to 15
-- Modified on 2020-07-28 to fix the bug if vat_percent between 6 and 13 force them to 15
CREATE PROCEDURE [dbo].[fill_vat_percent_column] 
 @errstatus int = 0 output	
AS
BEGIN
	SET NOCOUNT ON
	set @errstatus=0
---  Modified on 2020-07-27
    begin transaction
    update sales_hd set vat_percent=iif(round((vat_amt_rcvd*100)/(valafds-invdsvl-taxfree_sales+extamt),0) between 6 and 15,15,round((vat_amt_rcvd*100)/(valafds-invdsvl-taxfree_sales+extamt),0))
	 where (valafds-invdsvl-taxfree_sales+extamt)>0 and vat_amt_rcvd>0 
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-1
		return
	end	
	commit transaction
-------------   Handle Pos_hd table 
---  Modified on 2020-07-27
    begin transaction
    update Pos_hd set vat_percent=iif(round((vat_amt_rcvd*100)/(valafds-invdsvl-taxfree_sales),0) between 6 and 15,15,round((vat_amt_rcvd*100)/(valafds-invdsvl-taxfree_sales),0))
	where (valafds-invdsvl-taxfree_sales)>0 and vat_amt_rcvd>0 
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-2
		return
	end	
	commit transaction

---------------   Handle Puhdr table 
--------------- First handle local invoices 
---  Modified on 2020-07-27
    begin transaction
    update Puhdr set vat_percent=iif(round((vat_amt_paid*100)/(valafds-invdsvl-taxfree_purchase+isnull(expns4vat,0)),0) between 6 and 15,15,round((vat_amt_paid*100)/(valafds-invdsvl-taxfree_purchase+isnull(expns4vat,0)),0)) 
    where (valafds-invdsvl-taxfree_purchase+isnull(expns4vat,0))>0 and vat_amt_paid>0 and  isnull(tax_Pd_mthd,0)<>1 and gntd_fm_lc=0
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-3
		return
	end	
	commit transaction

--------------- Second handle  invoices that VAT paid at custom
    begin transaction
	update puhdr set vat_percent=round((vat_amt_paid*100)/iif(len(fcy)>0 and fcyrate>0,ttlsales/fcyrate,ttlsales),0)
	from puhdr as h
	join
	(select a.company,a.invtype,a.ref,ttlsales=sum(garntee_amt) from puhdr a inner join pudtl b on a.company=b.company and a.invtype=b.invtype and a.ref=b.ref
	where isnull(a.tax_Pd_mthd,0)=1 and a.gntd_fm_lc=0
	group by a.company,a.invtype,a.ref having sum(garntee_amt)>0
	) t
	on h.company=t.company and h.invtype=t.invtype and h.ref=t.ref
	where h.tax_Pd_mthd=1 and h.gntd_fm_lc=0
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-4
		return
	end	
	commit transaction
-------------   Handle sales_dh table 
---  Modified on 2020-07-27
    begin transaction
    update sales_dh set vat_percent=iif(round((vat_amt_rcvd*100)/(prpaidamt-taxfree_sales),0) between 6 and 15,15,round((vat_amt_rcvd*100)/(prpaidamt-taxfree_sales),0))
	where prpaidamt>0 and (prpaidamt-taxfree_sales)>0 and vat_amt_rcvd>0 and invtype in ('04','06','10','11')
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return
	end	
---  Modified on 2020-07-27
    update sales_dh set vat_percent=iif(round((vat_amt_rcvd*100)/(valafds-taxfree_sales),0) between 6 and 15,15,round((vat_amt_rcvd*100)/(valafds-taxfree_sales),0))
	where prpaidamt=0 and (valafds-taxfree_sales)>0 and vat_amt_rcvd>0 and invtype not in ('04','06','10','11')
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-6
		return
	end	
	commit transaction
	----------------------------------
 --   begin transaction
	--update puhdr set vat_percent=t.vat_percent
	--from puhdr as h
	--join
	--(select shcompany,shlcno,shshpno,sh_puinvgtd,vat_percent from lcshphdr where sh_puinvgtd<>0) t
	--on h.company=t.shcompany and h.invtype='10' and h.ref=t.sh_puinvgtd and h.lccode=t.shlcno and h.lc_ship_no=t.shshpno
	--where  h.gntd_fm_lc=1 and h.invdate>'20200630'
	--if @@error<>0
	--begin
	--	rollback transaction
	--	set @errstatus=-4
	--	return
	--end	
	--commit transaction


	--------------------------------------
	end








GO
/****** Object:  StoredProcedure [dbo].[fill_vat_percent_column_tayloring]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[fill_vat_percent_column_tayloring] 
 @errstatus int = 0 output	
AS
BEGIN
	SET NOCOUNT ON
	set @errstatus=0
    begin transaction
    update sales_hd set vat_percent=iif(round((vat_amt_rcvd*100)/(valafds-invdsvl-taxfree_sales),0)=13,15,round((vat_amt_rcvd*100)/(valafds-invdsvl-taxfree_sales),0))
	 where (valafds-invdsvl-taxfree_sales)>0 and vat_amt_rcvd>0 
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-1
		return
	end	
	commit transaction
-------------   Handle Pos_hd table 
    begin transaction
    update Pos_hd set vat_percent=iif(round((vat_amt_rcvd*100)/(valafds-invdsvl-taxfree_sales),0)=13,15,round((vat_amt_rcvd*100)/(valafds-invdsvl-taxfree_sales),0))
	where (valafds-invdsvl-taxfree_sales)>0 and vat_amt_rcvd>0 
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-2
		return
	end	
	commit transaction

---------------   Handle Puhdr table 
--------------- First handle local invoices 
    begin transaction
    update Puhdr set vat_percent=iif(round((vat_amt_paid*100)/(valafds-invdsvl-taxfree_purchase+isnull(expns4vat,0)),0)=13,15,round((vat_amt_paid*100)/(valafds-invdsvl-taxfree_purchase+isnull(expns4vat,0)),0)) 
    where (valafds-invdsvl-taxfree_purchase+isnull(expns4vat,0))>0 and vat_amt_paid>0 and  isnull(tax_Pd_mthd,0)<>1
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-3
		return
	end	
	commit transaction

--------------- Second handle  invoices that VAT paid at custom
    begin transaction
	update puhdr set vat_percent=round((vat_amt_paid*100)/iif(len(fcy)>0 and fcyrate>0,ttlsales/fcyrate,ttlsales),0)
	from puhdr as h
	join
	(select a.company,a.invtype,a.ref,ttlsales=sum(garntee_amt) from puhdr a inner join pudtl b on a.company=b.company and a.invtype=b.invtype and a.ref=b.ref
	where isnull(a.tax_Pd_mthd,0)=1
	group by a.company,a.invtype,a.ref
	) t
	on h.company=t.company and h.invtype=t.invtype and h.ref=t.ref
	where isnull(h.tax_Pd_mthd,0)=1
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-4
		return
	end	
	commit transaction
-------------   Handle sales_dh table 
    begin transaction
    update sales_dh set vat_percent=iif(round((vat_amt_rcvd*100)/(prpaidamt-taxfree_sales),0)=13,15,round((vat_amt_rcvd*100)/(prpaidamt-taxfree_sales),0))
	where prpaidamt>0 and (prpaidamt-taxfree_sales)>0 and vat_amt_rcvd>0 and invtype in ('04','06','10','11')
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return
	end	

    update sales_dh set vat_percent=iif(round((vat_amt_rcvd*100)/(valafds-taxfree_sales),0)=13,15,round((vat_amt_rcvd*100)/(valafds-taxfree_sales),0))
	where prpaidamt=0 and (valafds-taxfree_sales)>0 and vat_amt_rcvd>0 and invtype not in ('04','06','10','11')
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-6
		return
	end	
	commit transaction
-------------   Handle tailor_ord_hd table 
    begin transaction
    update tailor_ord_hd set vat_percent=iif(round((vat_amt_rcvd*100)/(valafds-invdsvl-taxfree_sales),0)=13,15,round((vat_amt_rcvd*100)/(valafds-taxfree_sales),0))
	where (valafds-invdsvl-taxfree_sales)>0 and vat_amt_rcvd>0 
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-7
		return
	end	

	update tailor_ord_hd set vat_percent=0 where vat_amt_rcvd<=0 
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-8
		return
	end
	commit transaction
-------------   Handle tailor_fix_hd table 
    begin transaction
    update tailor_fix_hd set vat_percent=iif(round((vat_amt_rcvd*100)/(valafds-invdsvl-taxfree_sales),0)=13,15,round((vat_amt_rcvd*100)/(valafds-invdsvl-taxfree_sales),0))
	where (valafds-invdsvl-taxfree_sales)>0 and vat_amt_rcvd>0 
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return
	end	

	update tailor_fix_hd set vat_percent=0 where vat_amt_rcvd<=0 
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-10
		return
	end
	commit transaction
-------------   Handle tailor_rtrn_hd table 
    begin transaction
    update tailor_rtrn_hd set vat_percent=iif(round((vat_amt_rcvd*100)/(valafds-invdsvl-taxfree_sales),0)=13,15,round((vat_amt_rcvd*100)/(valafds-invdsvl-taxfree_sales),0))
	where (valafds-invdsvl-taxfree_sales)>0 and vat_amt_rcvd>0 
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-11
		return
	end	

	update tailor_rtrn_hd set vat_percent=0 where vat_amt_rcvd<=0 
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-12
		return
	end		
	commit transaction
-------------   Handle tailor_ready_made_sales table 
    begin transaction
    update tailor_ready_made_sales set vat_percent=iif(round((vat_amt_rcvd*100)/(valafds-invdsvl-taxfree_sales),0)=13,15,round((vat_amt_rcvd*100)/(valafds-invdsvl-taxfree_sales),0))
	where (valafds-invdsvl-taxfree_sales)>0 and vat_amt_rcvd>0 
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-13
		return
	end	
	
	update tailor_ready_made_sales set vat_percent=0 where vat_amt_rcvd<=0 
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-14
		return
	end		
	commit transaction

end





GO
/****** Object:  StoredProcedure [dbo].[fix_chargeamt_in_pos_hd]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2023-08-08@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[fix_chargeamt_in_pos_hd]
	@m_cmp char(2),
	@p_date char(10),
	@p_slcenter char(2),
    @lpos_strt_h int ,
	@errstatus int output	
	AS
	BEGIN
---- Added on 2023-08-08 AA list of @lpos_strt_h 
		SET NOCOUNT ON
		-- 
	    declare @lslcenter char(2),
			@pos_fm_hour char(8),
			@pos_to_hour char(8)

        set @errstatus=0

		declare 
				@fm_datetime smalldatetime,
				@to_datetime smalldatetime,
				@m_fmslcenter char(2),
				@m_toslcenter char(2),
				@l_not_uptodate int =0
		set @m_fmslcenter=@p_slcenter
		set @m_toslcenter=@p_slcenter
		if @p_slcenter=''
		begin
			set @m_fmslcenter='01'
			set @m_toslcenter='99'
		end
-------------Added on 2023-08-08 AA  ------
		IF @lpos_strt_h=9 
		begin
		   set @pos_fm_hour='00:00:00'  
		   set @pos_to_hour='23:59:59'  
		end 
		else
		IF @lpos_strt_h=1
		begin
		   set @pos_fm_hour='01:00:00'  
		   set @pos_to_hour='00:59:59'  
		end   
		ELSE
		IF @lpos_strt_h=2
		begin
		   set @pos_fm_hour='02:00:00'  
		   set @pos_to_hour='01:59:59'  
		end   
		ELSE
		IF @lpos_strt_h=3
		begin
		   set @pos_fm_hour='03:00:00'  
		   set @pos_to_hour='02:59:59'  
		end   
		ELSE
		IF @lpos_strt_h=4 --start from 4 clock
		begin
		   set @pos_fm_hour='04:00:00'  
		   set @pos_to_hour='03:59:59'  
		end   
		ELSE
		IF @lpos_strt_h=5 or @lpos_strt_h=0
		begin
		   set @pos_fm_hour='05:00:00'  
		   set @pos_to_hour='04:59:59'  
		end   
		IF @lpos_strt_h=6
		begin
		   set @pos_fm_hour='06:00:00'  
		   set @pos_to_hour='05:59:59'  
		end   
		ELSE
		IF @lpos_strt_h=7
		begin
		   set @pos_fm_hour='07:00:00'  
		   set @pos_to_hour='06:59:59'  
		end   
		ELSE
		IF @lpos_strt_h=8
		begin
		   set @pos_fm_hour='08:00:00'  
		   set @pos_to_hour='07:59:59'  
		end   
----------------------------------------------------------
--------------------------------------------------------
		IF @lpos_strt_h=4 --start from 4 clock
		begin
		   set @pos_fm_hour='04:00:00'  
		   set @pos_to_hour='03:59:00'  
		end   
		ELSE
		begin
		   set @pos_fm_hour='05:00:00'  
		   set @pos_to_hour='04:59:00'  
		end   

		--  Build up the datetime needed
		set @fm_datetime=cast(@p_date+' '+@pos_fm_hour as smalldatetime)
		set @to_datetime=cast(cast(dateadd(dd,1,cast(@p_date as date)) as char(10))+' '+@pos_to_hour as smalldatetime)
          			
		set @l_not_uptodate=0
		select top 1 @l_not_uptodate=count(*)
		from pos_hd a inner join poscccard b 
		on a.company=b.company and a.contr=b.contr and a.ref=b.ref
		where a.company=@m_cmp And a.ref<>0  And geninv=0 and 
		tdatetime  between @fm_datetime and @to_datetime and invorrtrn='1'
		and slcenter between @m_fmslcenter and @m_toslcenter 
		group by a.company,a.contr,a.ref,a.chargeamt 
		having cast(a.chargeamt as numeric(20,6))<>cast(sum(b.chargeamt) as numeric(20,6)) 

		if isnull(@l_not_uptodate,0)>0
		begin
			begin transaction
			update pos_hd set chargeamt=cc_chargeamt
			from pos_hd t
			join
			(select a.company,a.contr,a.ref,a.chargeamt,cc_chargeamt=sum(b.chargeamt)
			from pos_hd a inner join poscccard b 
			on a.company=b.company and a.contr=b.contr and a.ref=b.ref
			where a.company=@m_cmp And a.ref<>0  And geninv=0 and 
			tdatetime  between @fm_datetime and @to_datetime and invorrtrn='1'
			and slcenter between @m_fmslcenter and @m_toslcenter 
			group by a.company,a.contr,a.ref,a.chargeamt 
			having cast(a.chargeamt as numeric(20,6))<>cast(sum(b.chargeamt) as numeric(20,6))) s
			on t.company=s.company and t.contr=s.contr and t.ref=s.ref;
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-7
			end
			else commit transaction
		end 
	   return @errstatus		  
end			   



GO
/****** Object:  StoredProcedure [dbo].[fix_pudtl_topcenter]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[fix_pudtl_topcenter]
 @m_cmp char(2),
 @m_type char(2),
 @m_ref  numeric(6,0), 
 @errstatus int = 0 output

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
		
---
----------------  Update pudtl
---

       begin transaction

	   update pudtl set cmbkey=xcmbkey,itemno=xitemno
	   from pudtl as v
	   join
	   (select xcmbkey=a.cmbkey,xitemno=a.itemno ,a.barcode
	    from stunits a inner join pudtl b on a.barcode=b.barcode
		where b.company=@m_cmp and invtype=@m_type and ref=@m_ref) c
		on v.barcode=c.barcode
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-1
			return --@errstatus
		end

		

	   update stdtl set cmbkey=xcmbkey,itemno=xitemno
	   from stdtl as v
	   join
	   (select xcmbkey=a.cmbkey,xitemno=a.itemno ,a.barcode
	    from stunits a inner join stdtl b on a.barcode=b.barcode
		where b.branch=@m_cmp and trtype=@m_type and ref=@m_ref) c
		on v.barcode=c.barcode
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-2
			return --@errstatus
		end

		commit transaction		
end












GO
/****** Object:  StoredProcedure [dbo].[Generate_Invoice_Frm_POS]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-10-24@@$$##  Important : must have this line as first line which contains the last update date for the this file 
 CREATE PROCEDURE [dbo].[Generate_Invoice_Frm_POS]
	@m_cmp char(2),
	@p_date char(20),
	@p_slcenter char(2),
	@p_trxtype char(1),
	@p_supermarket bit,
	@p_username char(10),
	@p_unq_bc_in_shwrm bit,
	@errstatus int =0 output,
	@no_of_gen_inv int =0 output
	
	AS
	BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
---------------------------------------------------------------------------------------------
------ 2024-10-23 Added new code to deduct the manafith amount from total invoices in case of refunding
------ 2024-10-23 Added new code to caclulate the manafith amount 
------ 2024-10-23 Added new varibale named @manafith_amt to hold amount belong to manafith company
------ 2024-07-27 AA Added taxcatid value for tax commission in the JV entry
------ 2024-04-27 AA Added new code to compare between @lttl_installment & @ltrx_installment_ttl using dbo.value_balanced function
------ 2024-04-27 AA Added new code to check the @@TRANCOUNT varibale to commit or rollback
------ 2024-04-27 AA Stopped code for smsuser=777 to set the varibale @hinvpaid for invorrtrn='3' bug fixed
------ 2024-01-30 AA Added new code -iif(@linvorrtrn='3',@lprpaid,0) when to fix the bug of cash when we have credit client
------ 2024-01-10 AA Added new code to update the lprice of stdtl with @new_lprice
------ 2024-01-10 AA Added new varibale named @new_lprice to hold the net of item_price_net substracted the invdsvl
------ 2023-12-19 AA considerd item_price_net column as single value
------ 2023-12-19 AA Added item_price_net column be grouped in pos_dt sql statement
------ 2023-12-19 AA Added zatca_rounding column to gljrhdr and updated by @zzatca_rounding variable
------ 2023-12-19 AA converted @item_price_net from numeric to float 
------ 2023-12-16 AA Fixed many problems related to zatca rounding
------ 2023-11-11 AA Added codes & varibles to match sales_dt with pos_dt
------ 2023-11-10 AA Added many codes to fit with zatca requirement
------ 2023-10-19 AA Made the text of the installment shorter
------ 2023-10-19 AA update the installment_amt column in sales_hd
------ 2023-10-18 AA Fixed bug when returned invoice JV not balanced
------ 2023-10-17 AA Added new code to check if all installment transactions are moved to the server
------ 2023-10-17 AA Allowing the cash returned to generate JVs for installment 
------ 2023-10-17 AA Added new check code if the commission of the installment is taxable to ALTER jvs
------ 2023-10-17 AA Added new variable @ltrx_instaxable 
------ 2023-10-17 AA Added new variable @ltrx_installment_ttl to compare it with @lttl_installment
------ 2023-10-16 AA Added code to take care of the installment  when invorrtrn=4 
------ 2023-10-16 AA The @lttl_installment variable added to the total of @lhinvpaid 
------ 2023-10-16 AA Fixed a bug of m_sign varibale with installment should not be used
------ 2023-10-14 AA  Added new codes to generate the jv entries for installment
------ 2023-10-14 AA Added many new varibales for installment process
------ 2023-10-07 AA Added new varibales @lchsanedamt,@lttl_chsanedamt for new saned top center
------ 2023-10-07 AA Added  added new code to make new gljrdtl for each charity foundation 
------ 2023-02-28 AA changed @lpkqty size from numeric(8,3) to numeric(10,3)
------ 2022-05-25 AA stopp generating jv for cost center for VAT value BUG
------ 2022-05-07 AA Added semi colon at the end of each select statements
------ 2022-03-27 AA Added the fcost for yemen if fc_wh is set
------ 2021-11-15 Added new column named deleted_geninv in pos_hd to hold the deleted sales invoice and when generate it again it uses it instead of getting new sequence
------ 2021-11-13 calclated the value of ps_item_vat wrong by excluding all pricevattype=2 from the total discount invoice 
------ 2021-09-02 When pos_strt_h=9 do not add 1 to second date todate
------ 2021-07-01 Added the start hours after 12 starting from 00 to 08
------ Added on 2021-03-28 for sawad al-ryiadh @m_toslcenter='ZZ' instead of '99'
------ 2021-02-15 Fixed the bug for smsuser=777 for returned sales
------ 2020-12-02 added new column named vat_dsc_invcalc 
------ 2020-12-02 if invoice has discount and pricevattype>1 , then vat will be calculated without substracting the discount.
------ 2020-11-23 invoice Discount is not show the jv if the column name NoDsc4SlPuJv in glcalend is ON
------ Modified 2020-10-14 Replace numeric(6,0) with Int for &M_ref , @gl_mref & @href
------ 2020-08-22 Added for stbranch when updating it must start with new begin transaction & commit transaction a void locking tabel for stbranch 
------  Modified on 2020-07-28. Added new column to sales_dt called ps_item_vat to hold the vat of the item if pricevattype>1
------  Added new on 2020-06-03 taking vat_percent from pos_hd instead of glcalend.
------  Added new modification for Hamel AlMesk smsuser=222 2019-12-21 AA & added new @lwhlslinv variable for wholesale=1 & retail=0
------  Added the serial transaction to be taken from the glsction table  2019-11-30  by adding new function named get_last_ref_section
------  Change the type of the variable @psoffer_amt from numeric to float 2019-10-16
------  For service items , rsvqty in stunits is updated (Bug) and fixed 2019-09-16
------  Fixed the bug when client using sales on class level pricevattype>1 and has taxfree_sales >0 2019-08-07
------  stcpay & qitaf fields in sales_hd were not updated 2019-04-08 & and not added them to invpaid column
------  when itemtype is service item ,it logs it to stdtl (bug fixed) 2019-04-17 
------  StcPay & Qitaf are added to the script on 2019-04-04
------  Fixed when item does not exist in stitems  2019-03-31 
------  Added on 2019-02-22 For Texture system smsuser = 400 ----------


    declare @lsmsuser int,
	@lpackname varchar(20)='',
	@lvat_paid_act varchar(19) -- Added on 2023-10-14 AA

	set @lsmsuser =0
	select @lsmsuser=isnull(smsuser,0),@lvat_paid_act=isnull(vat_paid_act,'') from stbranch where brnno=@m_cmp;

------  End of addation -------------------------------------------------
	declare 
	@dbc nvarchar(14),
	@lcalcomp char(2),
	@yrcode char(4),
	@syscode int =2,
	@lcauseslctr bit=0,
	@lcaokcstctr bit=0,
	@lrepl_type numeric(1,0)=0,
	@lpos_strt_h numeric(1,0)=5,
	@pos_fm_hour char(8),
	@pos_to_hour char(8),
	@dsc_amt_selected bit =0,
	@lno_round_nm BIT =0,
	@lcntstkon bit =0 ,
	@ldbcr char(1)='',
	@lpricevattype numeric(1,0)=1,
	@lvat_percent numeric(10,3)=0,
	@lhlldscamt float =0,
	@lPVT_level numeric(1,0) =0
------  Added on 2018-07-04	
    declare @o_syscode numeric(2,0)=0,
	        @o_lno_round_nm bit =0,
			@o_lpricevattype numeric(1,0)=1,
			@loksctions bit =0,
			@lNoDsc4SlPuJv bit =0

			set @o_syscode=0
			set @o_lno_round_nm=0
			set @o_lpricevattype=1

	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)

------ New declaration for smsuser=777  added on 2019-11-30 -----------------
    declare @lSctnHasSerial bit =0
-----------------------------------------------------------------------------
	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @syscode=isnull(sysno,2),@lcauseslctr=causeslctr,@lcaokcstctr=isnull(caokcstctr,0),@lrepl_type=repl_type,
	@lpos_strt_h=isnull(pos_strt_h,5),@dsc_amt_selected=isnull(is_dsc_amt,0),@lno_round_nm=isnull(no_round_nm,0),
	@lcntstkon=cntstkon,@lpricevattype=isnull(pricevattype,1),@lvat_percent=vat_percent,
    @lPVT_level=isnull(SysNo_PVT_level,0),@loksctions=isnull(oksctions,0),@lSctnHasSerial=isnull(SctnHasSerial,0),
	@lNoDsc4SlPuJv=isnull(NoDsc4SlPuJv,0)
    from sysdb.dbo.glcalend where calcomp=@lcalcomp and yrcode=@yrcode;

--------- Added on 2022-03-27 AA for Yemen --------------------------------
   declare @lfc_wh char(2)
   set @lfc_wh=''
   if COL_LENGTH('sysdb.dbo.glcalend','fc_wh') is not null
       select @lfc_wh=isnull(fc_wh,'') from sysdb.dbo.glcalend where calcomp=@lcalcomp and yrcode=@yrcode;
   
--------------------------------------------------------------------------
    set @lpricevattype=isnull(@lpricevattype,1)
------------------------------ added 2018-07-04  -------------------------------------------------------------------
    -- take values from stbranch
	set @o_syscode=@syscode
	set @o_lno_round_nm=@lno_round_nm
	set @o_lpricevattype=@lpricevattype
    if @lPVT_level=2
	begin
	    set @syscode=0
		set @lno_round_nm=0
		set @lpricevattype=1
	    select @syscode=sysno,@dsc_amt_selected=isnull(is_dsc_amt,0),@lno_round_nm=no_round_nm,
		@lpricevattype=pricevattype from stbranch where brnno=@m_cmp;	

		if @syscode=0 or @syscode is null set @syscode=@o_syscode
		if @lno_round_nm is null set @lno_round_nm=@o_lno_round_nm	
		if @lpricevattype=0 or @lpricevattype is null set @lpricevattype=@o_lpricevattype
	end

--------------------------------------------------------------------------------------------------------------------------- 
-------- Added on 2021-07-01 AA -----------------------------
		IF @lpos_strt_h=9 
		begin
		   set @pos_fm_hour='00:00:00'  
		   set @pos_to_hour='23:59:59'  
		end 
		else
		IF @lpos_strt_h=1
		begin
		   set @pos_fm_hour='01:00:00'  
		   set @pos_to_hour='00:59:59'  
		end   
		ELSE
		IF @lpos_strt_h=2
		begin
		   set @pos_fm_hour='02:00:00'  
		   set @pos_to_hour='01:59:59'  
		end   
		ELSE
		IF @lpos_strt_h=3
		begin
		   set @pos_fm_hour='03:00:00'  
		   set @pos_to_hour='02:59:59'  
		end   
		ELSE
		IF @lpos_strt_h=4 --start from 4 clock
		begin
		   set @pos_fm_hour='04:00:00'  
		   set @pos_to_hour='03:59:59'  
		end   
		ELSE
		IF @lpos_strt_h=5 or @lpos_strt_h=0
		begin
		   set @pos_fm_hour='05:00:00'  
		   set @pos_to_hour='04:59:59'  
		end   
		IF @lpos_strt_h=6
		begin
		   set @pos_fm_hour='06:00:00'  
		   set @pos_to_hour='05:59:59'  
		end   
		ELSE
		IF @lpos_strt_h=7
		begin
		   set @pos_fm_hour='07:00:00'  
		   set @pos_to_hour='06:59:59'  
		end   
		ELSE
		IF @lpos_strt_h=8
		begin
		   set @pos_fm_hour='08:00:00'  
		   set @pos_to_hour='07:59:59'  
		end   
----------------------------------------------------------

-----------------------         Declaration for Donations  --------------------------------------
    declare @donation_amt numeric(12,3)=0,
			@gl_mref int=0,  
			@lchrcode char(1),
			@lchname varchar(50),
			@lhll_amt float,
			@lchacct char(19)
		
-----------------------------------------------------------------------------------------------
	declare  @m_type char(2),
			@m_ref  int, 
			@fm_datetime datetime,
			@to_datetime datetime,
			@m_fmtrxtype char(1),
			@m_totrxtype char(1),
			@m_fmslcenter char(2),
			@m_toslcenter char(2),
			@m_invtype char(2),
			@ltxt varchar(40),
			@server_is_publisher bit =0,
			@hjdate char(10)='',
			@grdate char(10)='',
			@l_vt float=0,
			@ltmpvalue float=0 --2019-01-15  when pricevattype =2 something wrong 
	--
	--  prepair the parameters needed for the sql statement
	--
	if len(rtrim(@p_date))>10
	begin
	     set @hjdate=substring(@p_date,11,10)
	end
	set @grdate=substring(@p_date,1,10)
	--
	set @m_fmtrxtype=@p_trxtype
	set @m_totrxtype=@p_trxtype
	if @p_trxtype='5'
	begin
		set @m_fmtrxtype='1'
		set @m_totrxtype='4'
	end
	--- sales center variables
	set @m_fmslcenter=@p_slcenter
	set @m_toslcenter=@p_slcenter
	if @p_slcenter=''
	begin
		set @m_fmslcenter='01'
		set @m_toslcenter='ZZ' 
	end

	--  Build up the datetime needed
	--
	set @fm_datetime=cast(@grdate+' '+@pos_fm_hour as datetime)
---  Modified on 2021-09-02 AA
	set @to_datetime=cast(cast(dateadd(dd,iif(@lpos_strt_h=9,0,1),cast(@grdate as date)) as char(10))+' '+@pos_to_hour as datetime)
	--
	if DATALENGTH(rtrim(@hjdate))=10
	   set @grdate=@hjdate
	
	declare @lslcenter char(2),
		@linvorrtrn char(1),
		@lentries int ,        
		@linvttl float,
		@linvcst float,
		@linvdsvl float,
		@lvalafds float,
		@lfcamt float,
		@lprpaid float,
		@lcash float,
		@lccpayment float,
		@lcsanedcrdamt float,
		@lcharges float,
		@lcccommision float,
		@ljhfcflag numeric(1,0),
		@lt_qty float,
		@lxq float,
		@ldummy char(24),
		@arr_ptr int =0,
		@subttlcost float=0,
		@lvat_amt_rcvd float =0,
		@ltaxfree_sales float =0,
		@ltaxcatId int =0,
		@lstcpay_amt float =0,
		@lqitaf_amt float =0,
		@lstcpay_act char(19)='',
		@lqitaf_act char(19)='',
		@lwhlslinv bit =0,
		@lnvp_vat_percent numeric(5,2)=0 --- Added on 2020-06-04
		


	-- declare the array holding text for the transaction type
	declare @trxarr table( chx char(1) not null , v varchar(40) not null )
	insert into @trxarr values ('1','مبيعات نقدية');
	insert into @trxarr values ('2','مرتجع استبدال');
	insert into @trxarr values ('3','مرتجع مبيعات نقدية');
	insert into @trxarr values ('4','سند صرف نقدي مقابل مرتجع مبيعات');

	-- Read field from Salecntr 
	declare @ldp_cashser char(19),
		@ldp_okdiff bit ,
		@ldp_mainwh char(2),
		@ldp_expser char(19),
		@ldp_crdcardac char(19),
		@ldp_cardcomm char(19),
		@ldp_rplsac char(19),
		@ldp_diffser char(19),
		@lDP_CSLSER char(19),
		@lDP_RCSLSER char(19),
		@lprpaidcrdac char(19),
		@ltdate char(8),
		@lglacct char(19),
		@lexacct char(19),
		@ldp_slser char(19),
		@lsanedcrd_act char(19),
		@lcstctr char(4)='',
		@lsrcst char(19)='',
		@lvat_rcvd_act char(19)='',
		@ltaxtype char(1)=''
		
	-- variables for sales_hd
	declare @hslcenter char(2),
		@hbranch char(2),
		@hcompany char(2),
		@hinvtype char(2),
		@href int, ---- Modified 2020-10-14 Replace numeric(6,0) with Int
		@hinvdate char(8) ,        
		@hcustno char(6), 
		@hcustnm varchar(50),
		@hcaser char(19),
		@hfcy char(3)='',
		@hfcyrate float=0,
		@hinvttl float,
		@hinvcst float,
		@hinvdspc float,
		@hinvdsvl float,
		@hvalafds float,
		@hinvpaid float, 
		@hextamt float,
		@hextser char(19),
		@hcccommsn float,
		@hbelowbal bit,
		@hccpayment float,
		@hsanedcrdamt float,
		@hrplsamt float,
		@hprpaidamt float,
		@husrid char(8),
		@hfxrate float =0,
		@hINSTFLAG bit,
		@hposinv numeric(1,0)=1,
		@hvat_amt_rcvd float=0,
		@htaxfree_sales float=0
		

	---
	---   sales_dt declarations
	---
	declare @litemno char(16),
		@lunicode char(6) ,
		@lqty  float,  -- modified on 2019-02-22
		@lfqty  float,
		@lprice float, -- modified on 2019-02-22
		@ldiscpc float,
		@lds_acfm numeric(1,0),
		@lsl_acfm numeric(1,0),
		@lgclass char(8),
		@lbarcode char(20),
		@limfcval float,
		@lpack char(1),
		@lpkqty numeric(10,3), -- Modified on 2023-02-28 AA numeric(8,3)
		@lwhno char(2) ,
		@lcmbkey char(24),
		@litemtype char(1),
		@llcost float,
		@blcost float,
		@lfcost float,
		@bfcost float,  -- Added on 2022-03-27 
		@lttl_fcost float, -- Added on 2022-03-27 
		@lstfcy char(3),
		@lclasskey char(12),
		@cl_slser char(19),
		@lslptr int=0,
		@lstptr int=0,
		@lttl_inv float=0
		
	--
	--   Stbins declaration 
	--
	declare @bwhno char(2),
		@bbinno char(6),
		@brmnqty float,
		@lnobinno bit=1,
		@lastbinno char(6)
	--
	-- Declare variables of ADD_DTLS procedure VFP
	--
	declare @xttl_cost float=0,
	    @xttl_fcost float =0,
		@inv_lmtt  float=0,
		@inv_lftt  float=0,
		@m_vl      float=0,
		@m_fc      float=0,
		@inv_stk   float=0,
		@m_lccntr  float=0,
		@m_fccntr  float=0,
		@pd_lc     float =0,
		@opstval varchar(50),
		@diff_amt float=0,
		@new_rate float=0,
		@match_image bit ,
		@fc_to_lc_ttl float=0,
		@ch_cnt int =0,
		@l_crtot float=0,
		@f_crtot float=0,
		@l_dbtot float=0,
		@f_dbtot float=0,
		@m_sign int =0,
		@m_value float=0,
		@m_fcval float=0,
		@plcamt float ,
		@pfcamt float ,
		@fcfcy char (3),
		@lcurname char(20),
		@replication bit =0,
		@xclkey char(12)='',
		@clsname char(20)='',
		@cstcode char(4)='',
		@dscact char(19)='',
		@dscclassamt float=0,
		@dsc_ptr int =0,
		@ttl_class_dsc float=0,
		@lsc_code char(6)='',
		@ttl_class_sales float=0,
		@ldiscamt bit =0,
		@lcshprpaidrtn float=0,
		@ltmpsccode char(6)='',
		@item_vat float =0, -- Added On2020-07-27 
		@lvat_dsc_invcalc bit =0
		
------ Added on 2023-10-07 AA -----
    declare @lchsanedamt float=0,
	        @lttl_chsanedamt float=0
------ Added on 2023-10-14 AA ------------------
    declare @linsshort varchar(20),
	        @linsacct varchar(19),
			@linscmsnacct varchar(19),
			@linstallment_amt float=0,
			@linscommprcnt numeric(5,2),
			@lcommp_notrtnd numeric(5,2),
			@linscommamt numeric(10,3),
			@ltrx_confirmed_code varchar(10),
			@ltrx_instlmnt_vourcher varchar(20),
			@ltrx_buyer_mobile varchar(15),
			@linstlmnt_commsn float,
			@linstlmnt_vatcmsn float,
			@linstlmnt_amt_val float,
			@lttl_installment float,
			@ltrx_installment_ttl float=0, -- Added on 2023-10-17 AA
			@ltrx_instaxable bit =0, -- Added on 2023-10-17 AA
			@manafith_amt float =0 -- Added on 2024-10-23 AA
---------------------------------------------------
    if exists(select 1 from sys.servers where is_distributor=1)
    set @replication=1
 	else
	begin	  
	  set @replication=isnull(@lrepl_type,0)
    end
   
-------  Added on 2021-11-15 A  New variables added to hold the deleted invoice in pos_hd No	  
    declare @ldeleted_cntr int,
	        @ldeleted_geninv int
	 
	-- DECLARE ARRAY HOLDING THE ITEM CLASS AND ACCOUNT
	declare @class_arr table( p_ptr int,clkey char(12) not null , act char(19) not null,lcamt float ,
	clsname char(20),cstcode char(4),dscact char(19))

    declare @dsc_class_val table(classkey char(12) not null,dscclassamt float default 0)
	declare @pscmbkey char(24),@psqty float,@psprice float,@psdscprsnt float,
  		@psoffer_amt float, @psbarcode char(20),@psitemvat float 
		  
	set @ltdate=replace(cast (GETDATE() as DATE),'-','')
	set @lpricevattype=0
	set @lno_round_nm=0
---- Added new public variables for zatca 
	declare @zzatca_rounding bit=0,
	        @zitem_price_net float,  --- converted to float on 2023-12-19 AA
			@zitem_vat numeric(14,3),
			@zinvdscamt float ,
			@new_lprice float =0  -- Added on 2024-01-10 AA
			
-----------------------------------------------
		DECLARE pogen1 CURSOR LOCAL FAST_FORWARD FOR
		Select slcenter, invorrtrn, sum(entries) As entries,
			sum(invttl) As invttl, Sum(invcst-isnull(dfvchramt,0.00)) As invcst, Sum(invdsvl) As invdsvl,
			sum(valafds) As valafds,fcamt=sum(fcamt),
			sum(prepaidamt) As prpaid,Sum(cashamt) As cash,Sum(ccpaid) As ccpayment,
			charges=sum(iif(ccconus='0', chargeamt, cast(0 as numeric(15,5)))),Sum(chargeamt) As cccommision,
			Sum(isnull(saned_amt,0.00)) As sanedcrdamt,sum(isnull(vat_amt_rcvd,0)) as vat_amt_rcvd,
			sum(isnull(taxfree_sales,0)) as taxfree_sales,sum(isnull(hlldscnt,0)) as hlldscntamt ,
			PriceVatType,No_round_nm,discamt,
			stcpay_amt=sum(isnull(stcpay_amt,0)),qitaf_amt=sum(isnull(qitaf_amt,0)),
			CashDsc4RtnPrepaid=sum(isnull(CashDsc4RtnPrepaid,0)),isnull(whlslinv,0) as whlslinv,isnull(vat_percent,0) as vat_percent,
			sum(iif(isnull(deleted_geninv,0)>0,1,0)) as delinvcntr,sum(isnull(installment_amt,0)) as installment_amt,
			isnull(zatca_rounding,0) as zatca_rounding
			from pos_hd where company=@m_cmp  And ref<>0  And geninv=0 and 
			tdatetime  between @fm_datetime and @to_datetime and invorrtrn between  @m_fmtrxtype and @m_totrxtype
			and slcenter between @m_fmslcenter and @m_toslcenter
			group By slcenter, invorrtrn,PriceVatType,No_round_nm,discamt,isnull(whlslinv,0),isnull(vat_percent,0),isnull(zatca_rounding,0)
			order By slcenter, invorrtrn,PriceVatType,No_round_nm,discamt,isnull(whlslinv,0),isnull(vat_percent,0);

		open pogen1;
		set @errstatus=0;
		
			fetch next from pogen1 into @lslcenter,@linvorrtrn,@lentries,@linvttl,@linvcst,@linvdsvl,@lvalafds,
			@lfcamt,@lprpaid,@lcash,@lccpayment,@lcharges,@lcccommision,@lcsanedcrdamt,@lvat_amt_rcvd,
			@ltaxfree_sales,@lhlldscamt,@lpricevattype,@lno_round_nm,@ldiscamt,@lstcpay_amt,@lqitaf_amt,@lcshprpaidrtn,@lwhlslinv,
			@lnvp_vat_percent,@ldeleted_cntr,@lttl_installment,@zzatca_rounding;
	
		WHILE dbo.FetchStatusOfCursorNamed('pogen1') = 0
		BEGIN

	  		set @ch_cnt  =0
			set @l_crtot =0
			set @f_crtot =0
			set @l_dbtot =0
			set @f_dbtot =0
			set @m_value=0
			set @m_fcval=0
			set @xttl_cost=0
			set @xttl_fcost=0
			set @lsc_code=''
----------- Added on 2024-10-23 AA ---------------------------------------------------------
			set @manafith_amt=0
			if @lcsanedcrdamt>0 and @linvorrtrn in ('2','3')
			begin
				select @manafith_amt=sum(b.paidamt) 
				from pos_hd a inner join posmnfthcard b 
				on a.company=b.company and a.contr=b.contr and a.ref=b.ref
				where a.company=@m_cmp and tdatetime  between @fm_datetime and @to_datetime
				And geninv=0 and invorrtrn=@linvorrtrn and a.slcenter=@lslcenter and
				PriceVatType=@lpricevattype and No_round_nm=@lno_round_nm 
				and a.saned_amt>0 and isnull(a.vat_percent,0)=@lnvp_vat_percent
				and isnull(zatca_rounding,0)=@zzatca_rounding;

				set @manafith_amt=isnull(@manafith_amt,0)
			end
----------------------------------------------------------------------------------------------
			begin transaction
			set @errstatus=0;

----------- Added on 2020-06-04 
            if @lnvp_vat_percent=0 and @lvat_amt_rcvd>0 set @lnvp_vat_percent=@lvat_percent	
					
			select @ldp_cashser=dp_cashser,@ldp_okdiff=dp_okdiff,@ldp_mainwh=dp_mainwh,@ldp_expser=dp_expser,
			@ldp_crdcardac=dp_crdcardac,@ldp_cardcomm=dp_cardcomm,@ldp_rplsac=dp_rplsac,@ldp_diffser=dp_diffser,@lsrcst=srcst,
			@lDP_CSLSER=DP_CSLSER,@lDP_RCSLSER=DP_RCSLSER,@lprpaidcrdac=prpaidcrdac,@lsanedcrd_act=sanedcrd_act,
			@lcstctr=isnull(cstcode,''),@lvat_rcvd_act=vat_rcvd_act,@lsc_code=isnull(sc_code,'') ,
			@lstcpay_act=isnull(stcpay_act,''), @lqitaf_act=isnull(qitaf_act,'')
			 from salecntr with (NOLOCK)
			where dp_brno=@m_cmp and dp_dept=@lslcenter;

------------------------------ added 2018-07-04  -------------------------------------------------------------------
    -- take values from glsction
			if @lPVT_level=3 and len(@lsc_code)>0 and @loksctions=1
			begin
				set @syscode=0
				--set @dsc_amt_selected=0
				--set @lno_round_nm=0
				--set @lpricevattype=1

				select @syscode=sysno from glsction where sc_company=@m_cmp and sc_code=@lsc_code;

				if @syscode=0 or @syscode is null set @syscode=@o_syscode
				--if @lno_round_nm is null set @lno_round_nm=@o_lno_round_nm	
				--if @lpricevattype=0 or @lpricevattype is null set @lpricevattype=@o_lpricevattype							
			end	
			set @ltmpsccode=''
			if len(@lsc_code)>0 and @loksctions=1 and @lSctnHasSerial=1
			begin
			    select @ltmpsccode=sc_code from glsction where sc_company=@m_cmp and sc_code=@lsc_code;
				if @ltmpsccode is null set @lsc_code=''
			end		
------------------------------------------------------------------------------------------------------------------
--------------- Added on 2021-11-15 A to use the REF No for the deleted one
            set @ldeleted_geninv=0
            if @ldeleted_cntr>0
			begin
				select top 1 @ldeleted_geninv=isnull(deleted_geninv,0) from pos_hd 
				where company=@m_cmp and slcenter=@lslcenter and invorrtrn=@linvorrtrn
					and pricevattype=@lpricevattype and No_round_nm=@lno_round_nm and discamt=@ldiscamt
					And isnull(deleted_geninv,0)>0 and
					tdatetime  between @fm_datetime and @to_datetime and isnull(vat_percent,0)=@lnvp_vat_percent
					and isnull(zatca_rounding,0)=@zzatca_rounding -- Added on 2023-11-10 AA
					order by isnull(deleted_geninv,0) desc;
					if @ldeleted_geninv is null or @@ROWCOUNT=0 set @ldeleted_geninv=0
					set @m_ref=0
					if @ldeleted_geninv>0
					if @linvorrtrn in ('1','2','3')
					begin
					   set @m_invtype=iif(@linvorrtrn='1','06','26')
					   select @m_ref=ref from sales_hd where company=@m_cmp and invtype=@m_invtype and ref=@ldeleted_geninv;
					   if isnull(@m_ref,0)>0 set @ldeleted_geninv=0
					end
					else
					begin
					   select @m_ref=jhref from gljrhdr where jhcomp=@m_cmp and jhtype='01' and jhref=@ldeleted_geninv;
					   if isnull(@m_ref,0)>0 set @ldeleted_geninv=0
					end
			end	
			set @m_ref=0  
-----------------------------------------------------------------------------------------------------------------------			          
			if @linvorrtrn<>'4'
			begin
			    if @linvorrtrn in ('1','3') set @hcaser=@ldp_cashser
				else set @hcaser=@ldp_rplsac
				if @linvorrtrn='1' set @ldp_slser=@lDP_CSLSER
				else set @ldp_slser=@lDP_RCSLSER
--				set @hextser=iif(@linvorrtrn='2',@ldp_rplsac,@ldp_cashser)
				set @hextser=iif(@lcharges<>0,@ldp_cardcomm,'')
				set @m_invtype=iif(@linvorrtrn='1','06','26')
				set @ltaxcatId=iif(@m_invtype='06',1,2)
				set @m_sign=iif(@linvorrtrn='1',1,-1)

--------------- Added on 2021-11-15 A to use the REF No for the deleted one
                if @ldeleted_geninv>0  set 	@m_ref=	@ldeleted_geninv
				else		
				if len(@lsc_code)>0 and @loksctions=1 and @lSctnHasSerial=1 set @m_ref=dbo.get_last_ref_section(@m_invtype,@m_cmp,@lsc_code)
				else set @m_ref=dbo.get_last_ref(@m_invtype,@m_cmp)

				set @hINSTFLAG=iif(@lfcamt>0,1,0)
				set @hinvpaid=iif(@m_invtype='06',@lcash-(@lcash+@lccpayment+@lcsanedcrdamt+@linvcst+@lprpaid+@linvdsvl+@lhlldscamt+@lstcpay_amt+@lqitaf_amt+@lttl_installment-(@lvalafds+@lcharges
				+iif(@lpricevattype=1 or @zzatca_rounding=1,@lvat_amt_rcvd,0))), -- Added on 2023-10-16 AA @lttl_installment
					@lvalafds-@linvdsvl+iif(@lpricevattype=1 or @zzatca_rounding=1,@lvat_amt_rcvd,0)-@lhlldscamt-@lttl_installment -- Added on 2023-10-16 AA @lttl_installment
				   -@manafith_amt -- Added on 2024-10-23				
				   -iif(@linvorrtrn='3',@lprpaid,0)) -- Added on 2024-01-30 AA
------------- Stopped on 2024-04-27 AA bug---------------------------------------------------
------------- Added on 2021-02-15 For Sawaed Al-Riyadh -------------------------------------
       --         if @lsmsuser=777 and @linvorrtrn='3' 
			    --begin
				   --if dbo.value_balanced(@hinvpaid,@lprpaid)=1 or @hinvpaid<@lprpaid  set @hinvpaid=0   
				   --else  set @hinvpaid=@hinvpaid-@lprpaid
			    --end
---------------------------------------------------------------------------------------------
				set @hinvdate=replace(@grdate,'-','')
				set @hinvttl=@linvttl+@linvdsvl -- return back the invoice discount to the invttl
				set @hinvdsvl=@linvdsvl
				set @hvalafds=@lvalafds
				set @hextamt=@lcharges
				set @hcccommsn=@lcccommision
				set @hccpayment=@lccpayment
				set @hsanedcrdamt=@lcsanedcrdamt
				set @hrplsamt=@linvcst
				set @hprpaidamt=@lprpaid
				set @hvat_amt_rcvd=@lvat_amt_rcvd
				set @htaxfree_sales=@ltaxfree_sales 
				
				-----  Added on 2019-11-30 
				--------------- Added on 2021-11-15 AA
				if @ldeleted_geninv=0
				begin
					----- Added on 2020-08-22 to prevent table locking 
					begin transaction  -- Added on 2020-08-22 
					if len(@lsc_code)>0 and @loksctions=1 and @lSctnHasSerial=1
					begin
						if @m_invtype='06' update glsction set jv_06=@m_ref+1 where sc_company=@m_cmp and sc_code=@lsc_code
						else update glsction set jv_26=@m_ref+1 where sc_company=@m_cmp and sc_code=@lsc_code
					end
					else
						if @m_invtype='06' update stbranch set jv_06=@m_ref+1 where brnno=@m_cmp
						else update stbranch set jv_26=@m_ref+1 where brnno=@m_cmp

					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-9
						break
					end
					commit transaction  -- Added on 2020-08-22 
				end
				select @hcustnm=v from @trxarr where chx=@linvorrtrn;
				set @hposinv=cast(@linvorrtrn as numeric(1,0))
		--- insert data in sales_hd

		            if @lsmsuser=222 set @hcustnm=@hcustnm+' '+iif(@lwhlslinv=1,'جملة','قطاعي')

					insert into sales_hd 
					(slcenter,branch ,company ,invtype ,ref ,invdate,custno ,custnm ,glser,dsctype ,pstmode
					,fcy,fcyrate,duedate ,invttl,invcst,invdspc ,invdsvl ,valafds ,invpaid ,caser ,entries
					,released,posted ,fixrate ,extamt,extser ,pricetp,ischeque ,chkno ,chkdate ,lastupdt,jvgenrt
					,cccommsn ,belowbal,fcy2,ccpayment ,rplsamt,pdother ,slcode,prpaidamt,instldays ,instflag
					,slcmnd ,inv_printed ,bendit ,modified ,rqstorder ,rqststld ,carrier ,rcvdtrn ,usrid ,address
					,suspend ,rtnref,ispurchase ,stkjvno ,posinv ,sanedcrd_amt,vat_amt_rcvd,taxfree_sales,
					clnt_taxcode,clnt_kind,hlldscnt,sysno,No_round_nm,PriceVatType,stcpay_amt,qitaf_amt,rtncash_dfrpl,whlslinv,
					vat_percent,installment_amt,zatca_rounding) --- Added on 2023-10-19 AA
					values (@lslcenter,'Q',@m_cmp,@m_invtype,@m_ref,@hinvdate,'',
					@hcustnm,'','',0,'',0,'',@hinvttl,0,0,@linvdsvl,@lvalafds,
					@hinvpaid,
					@hcaser,@lentries,0,0,0,@lcharges,@hextser,'1',0,'','',@ltdate,0,@lcccommision,0,
					'',@lccpayment,@linvcst,0,'',@lprpaid,0,@hINSTFLAG,0,0,0,1,0,0,'',@replication,@p_username,
					'',0,0,0,0,@hposinv,@lcsanedcrdamt,@hvat_amt_rcvd,@htaxfree_sales,'','',@lhlldscamt,
					@syscode,@lno_round_nm,@lpricevattype,@lstcpay_amt,@lqitaf_amt,@lcshprpaidrtn,@lwhlslinv,
					@lnvp_vat_percent,@lttl_installment,@zzatca_rounding);

					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-1
						break
					end
		--
		--- insert one record in STHDR
		--   
				insert into sthdr (branch,trtype,ref,trdate,amnttl,[text],fcy,fcyrate,costttl,src,posted,released,
				entries,whno,modified,usrid,sysdate,lastupdt,rcvdtrn,isbrtrx,towhno,custno,brsupp,tobrno,brxref,glref,asmtype) 
				values (@m_cmp,@m_invtype,@m_ref,@hinvdate,0,@hcustnm,@hfcy,0,0,
				'05',0,0,0,@ldp_mainwh,1,@p_username,@ltdate,@ltdate,@replication,0,' ','','','',0,0,0);
				if @@error<>0
				begin
					rollback transaction
					set @errstatus=-2
					break
				end
		--
		-- Insert One Record in GLJRHR
		--
				set @ljhfcflag=iif(@Hfcy='',2,1)
				insert into gljrhdr (jhcomp,jhtype,jhref,jhcurr,jhamt,jhdate,jhrate,jhtext,jhsrc,jhfcflag,jhreleased,jhposted,
				jhsysdate,modified,[Suspend],usrid,lastupdt,rcvdtrn,isbrtrx,brxref,brxfrm,jhcustno,zatca_rounding) -- Added on 2023-12-19 AA zatca_rounding
				values (@m_cmp,@m_invtype,@m_ref,@hfcy,0,@hinvdate,0,@hcustnm,'05',
				@ljhfcflag,0,0,@ltdate,1,0,@p_username,@ltdate,@replication,0,'','','',@zzatca_rounding); -- Added on 2023-12-19 AA @zzatca_rounding
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-3
						break
					end            
				if @p_unq_bc_in_shwrm=1
				begin
					DECLARE pogen2 CURSOR LOCAL FAST_FORWARD FOR
					Select pos_dt.cmbkey,  Sum(pos_dt.qty) As qty, pos_dt.price, pos_dt.dscprsnt,sum(isnull(offer_amt,0)) as offer_amt,
					b.barcode,lcost,b.itemno,b.unicode,substring(c.classkey,1,2) as classkey,pack0 as pack,1 as pkqty,pos_dt.taxtype,itemtype,fcost
					from  (pos_hd inner Join pos_dt  
					on  pos_hd.company = pos_dt.company and pos_hd.Contr = pos_dt.Contr and pos_hd.ref = pos_dt.ref)
					left outer join (stunits b inner join stitems c on b.itemno=c.itemno) 
					on pos_dt.cmbkey=b.cmbkey
					where pos_hd.company=@m_cmp and pos_hd.slcenter=@lslcenter and invorrtrn=@linvorrtrn
					and pos_hd.pricevattype=@lpricevattype and pos_hd.No_round_nm=@lno_round_nm
					And pos_hd.geninv=0 And  not (RTRIM(pos_dt.cmbkey)='' Or RTRIM(pos_dt.barcode)='') and
					tdatetime  between @fm_datetime and @to_datetime 
					and isnull(zatca_rounding,0)=@zzatca_rounding -- Added on 2023-11-10 AA
					group By pos_dt.cmbkey,pos_dt.price,pos_dt.dscprsnt,b.barcode,lcost,b.itemno,b.unicode,classkey,
					pack0,pos_dt.taxtype,itemtype,fcost
					order By pos_dt.cmbkey,pos_dt.price,pos_dt.dscprsnt;
				end
				else
				begin
					if @p_supermarket=1
					begin
		 				DECLARE pogen2 CURSOR LOCAL FAST_FORWARD FOR
						Select pos_dt.cmbkey,  Sum(pos_dt.qty) As qty, pos_dt.price, iif(discamt=0,pos_dt.dscprsnt,(dsc_amt/price)*100) as dscprsnt,
						sum(isnull(offer_amt,0)) as offer_amt,pos_dt.barcode,lcost,b.itemno,b.unicode,substring(f.classkey,1,2) as classkey,
						c.pack,c.pkqty,pos_dt.taxtype,itemtype,
						sum(iif(pos_dt.taxtype<='1',((qty*(price-iif(discamt=1,dsc_amt,iif(no_round_nm=1,(price*dscprsnt/100),
						floor(price*dscprsnt/100))))-isnull(offer_amt,0))-(qty*(price-iif(discamt=1,dsc_amt,iif(no_round_nm=1,(price*dscprsnt/100),
						floor(price*dscprsnt/100))))-isnull(offer_amt,0))*iif(valafds>0,invdsvl/valafds,0))
						*iif(pricevattype>1,cast(vat_percent as float)/(100+cast(vat_percent as float)),cast(vat_percent as float)/100),0)) as itemvat,
						fcost,item_price_net,sum(isnull(item_vat,0.00)) as item_vat,
						sum(isnull(invdscamt,0))as invdscamt 
						from  (pos_hd inner Join pos_dt  
						on  pos_hd.company = pos_dt.company and pos_hd.Contr = pos_dt.Contr and pos_hd.ref = pos_dt.ref)
						left outer join (stitems f inner join stunits b on f.itemno=b.itemno
						inner join stitembc c on b.itemno=c.itemno and b.unicode=c.unicode) 
						on pos_dt.barcode=c.pbarcode
						where pos_hd.company=@m_cmp and pos_hd.slcenter=@lslcenter and invorrtrn=@linvorrtrn
						and pos_hd.pricevattype=@lpricevattype and pos_hd.No_round_nm=@lno_round_nm and discamt=@ldiscamt
						And pos_hd.geninv=0 And  not (RTRIM(pos_dt.cmbkey)='' Or RTRIM(pos_dt.barcode)='') and
						tdatetime  between @fm_datetime and @to_datetime and isnull(whlslinv,0)=@lwhlslinv and isnull(pos_hd.vat_percent,0)=@lnvp_vat_percent
						and isnull(zatca_rounding,0)=@zzatca_rounding -- Added on 2023-11-10 AA
						group By pos_dt.cmbkey,pos_dt.barcode,pos_dt.price,pos_dt.dscprsnt,lcost,b.itemno,b.unicode,classkey,
						c.pack,c.pkqty,pos_dt.taxtype,dsc_amt,discamt,itemtype,fcost,item_price_net -- Added on 2023-12-19 AA
						order By pos_dt.cmbkey,pos_dt.barcode,pos_dt.price,pos_dt.dscprsnt,dsc_amt;
					end
					else
					begin
		 				DECLARE pogen2 CURSOR LOCAL FAST_FORWARD FOR
						Select pos_dt.cmbkey,  Sum(pos_dt.qty) As qty, pos_dt.price, iif(discamt=0,pos_dt.dscprsnt,(dsc_amt/price)*100) as dscprsnt,
						sum(isnull(offer_amt,0)) as offer_amt,pos_dt.barcode,lcost,b.itemno,b.unicode,substring(c.classkey,1,2) as classkey
						,pack0 as pack,1 as pkqty,pos_dt.taxtype,itemtype,
						sum(iif(pos_dt.taxtype<='1',((qty*(price-iif(discamt=1,dsc_amt,iif(no_round_nm=1,(price*dscprsnt/100),
						floor(price*dscprsnt/100))))-isnull(offer_amt,0))-(qty*(price-iif(discamt=1,dsc_amt,iif(no_round_nm=1,(price*dscprsnt/100),
						floor(price*dscprsnt/100))))-isnull(offer_amt,0))*iif(valafds>0,invdsvl/valafds,0))
						*iif(@lpricevattype>1,cast(vat_percent as float)/(100+cast(vat_percent as float)),cast(vat_percent as float)/100),0)) as itemvat,
						fcost,item_price_net,sum(isnull(item_vat,0.00)) as item_vat,
						sum(isnull(invdscamt,0))as invdscamt 
						from  (pos_hd inner Join pos_dt  
						on  pos_hd.company = pos_dt.company and pos_hd.Contr = pos_dt.Contr and pos_hd.ref = pos_dt.ref)
						left outer join (stunits b inner join stitems c on b.itemno=c.itemno) 
						on pos_dt.cmbkey=b.cmbkey
						where pos_hd.company=@m_cmp and pos_hd.slcenter=@lslcenter and invorrtrn=@linvorrtrn
						and pos_hd.pricevattype=@lpricevattype and pos_hd.No_round_nm=@lno_round_nm and discamt=@ldiscamt
						And pos_hd.geninv=0 And  not (RTRIM(pos_dt.cmbkey)='' Or RTRIM(pos_dt.barcode)='') and
						tdatetime  between @fm_datetime and @to_datetime and isnull(pos_hd.vat_percent,0)=@lnvp_vat_percent
						and isnull(zatca_rounding,0)=@zzatca_rounding -- Added on 2023-11-10 AA
						group By pos_dt.cmbkey,pos_dt.barcode,pos_dt.price,pos_dt.dscprsnt,lcost,b.itemno,b.unicode,
						classkey,pack0,pos_dt.taxtype,dsc_amt,discamt,itemtype,fcost,item_price_net -- Added on 2023-12-19 AA
						order By pos_dt.cmbkey,pos_dt.barcode,pos_dt.price,pos_dt.dscprsnt,dsc_amt;
					end
				end
				open pogen2;
				set @lslptr=0
				set @lstptr=0
				set @lttl_inv=0
				set @arr_ptr=0
				set @ttl_class_dsc=0
				set @dsc_ptr=0
				set @xttl_cost=0
				set @xttl_fcost=0 
				set @inv_stk=0
				set @inv_lftt=0
				set @inv_lmtt=0
				set @m_lccntr=0
				set @m_fccntr=0
				set @ltaxtype='1'
				set @psitemvat=0
				fetch next from pogen2 into  @lcmbkey,@lqty ,@lprice ,@ldiscpc,@psoffer_amt, @lbarcode,
				@llcost,@litemno,@lunicode,@lclasskey,@lpack,@lpkqty,@ltaxtype,@litemtype,@psitemvat,@lfcost,
				@zitem_price_net,@zitem_vat,@zinvdscamt;
				WHILE dbo.FetchStatusOfCursorNamed('pogen2') = 0
				BEGIn
------------------- Added on 2024-01-10 AA --------------------------------------------------------------------------------------------------------
					set @new_lprice=@lprice 
					if @zzatca_rounding=1 and @linvdsvl>0 and @lvalafds>0 set @new_lprice=@zitem_price_net-(@zitem_price_net*(@linvdsvl/@lvalafds))
---------------------------------------------------------------------------------------------------------------------------------------------------
		--
		-- insert one line each time in SALES_DT
		--    
		            if len(@lfc_wh)=0 set @lfcost=0 -- Added on 2022-03-27 AA

		            set @lfcost=isnull(@lfcost,0)  -- Added on 2022-03-27 AA
                    set @ltaxtype=isnull(@ltaxtype,'1')
					if @ltaxtype='0' or rtrim(@ltaxtype)='' set @ltaxtype='1' -- Added on 2019-02-22
                    set @llcost=isnull(@llcost,0)
					set @litemno=iif(isnull(@litemno,'')='','',@litemno)
--------- Added on 2019-03-31 to update the itemno if empty from pos_dt.cmbkey
					if len(@litemno)=0 and len(@lcmbkey)>0 and len(@lcmbkey)<17
					set @litemno=replicate(space(1),16-len(rtrim(@lcmbkey)))+rtrim(@lcmbkey)

					set @lunicode=iif(isnull(@lunicode,'')='','',@lunicode)
					set @lpack=iif(isnull(@lpack,'')='','',@lpack)
					set @lpkqty=iif(isnull(@lpkqty,0)=0,1,@lpkqty)
					set @lclasskey=iif(isnull(@lclasskey,'')='','',@lclasskey)
					set @lclasskey=rtrim(@lclasskey)+replicate(space(1),12-len(rtrim(@lclasskey)))	
					set @cl_slser=''		 
					select @cl_slser=iif(@m_invtype='06',SERCSH,SERRCH),@clsname=name,@cstcode=cstcode,@dscact=serdsc
					 from slclass with (NOLOCK) where company=@m_cmp and cmbkey=@lclasskey;
					if rtrim(isnull(@cl_slser,''))='' 
					begin
						set @lsl_acfm=3
						set @lds_acfm=3
						set @lgclass=''
					end
					else
					begin
						set @lsl_acfm=2
						set @lds_acfm=2
						set @lgclass=rtrim(@lclasskey)
					end

-------------------- Added on 2019-02-22 For Texture system --------------------------------
                    if @lsmsuser = 400 and len(@lpack)>0
					begin
					    select @lpackname = isnull(pkname,'') from orpacking where pack_id = @lpack;
						if substring(@lpackname,1,4)='يارد'
						begin
						    set  @lqty        = @lqty/0.9144
							set  @lprice      = @lprice * 0.9144
						end
					end
-------------------- End of Addation --------------------------------------------------------

		--
		-- set up the accumelated values for sum vars
		--
			        if @zzatca_rounding=1 set @m_vl=-@lqty*@zitem_price_net -- Added on 2023-12-19 AA
					else
					if  @lno_round_nm=1  --@syscode=6 or
						set @m_vl=-(@lqty*(@lprice-(@lprice*@ldiscpc/100))-@psoffer_amt)
					Else
					    set @m_vl=-(@lqty*(@lprice-cast(@lprice*@ldiscpc/100 as int))-@psoffer_amt)

-----
--------------------------------  Added on 2017-12-04 -------------------------------
----  Seprate  the sales from the vat
                   if @lpricevattype>1 and @hvat_amt_rcvd>0 and @ltaxtype='1' and @zzatca_rounding=0 -- Added on 2023-11-10 AA and @zzatca_rounding=0 
				   begin
				      set @l_vt =@psitemvat
					  set @m_vl=@m_vl+@l_vt
				   end
-------------------------------------------------------------------------------------
						
					set @m_fc=0.00
					set @inv_lftt=@inv_lftt+abs(@m_vl)
					set @inv_lmtt=@inv_lmtt+Abs(@m_vl)   
					set @inv_stk=@inv_stk+Abs(@m_vl) 
					if @lsl_acfm=2
					begin 
					    set @xclkey=''
						select @xclkey=clkey from  @class_arr where clkey=@lclasskey;
						if rtrim(isnull(@xclkey,''))=''
						begin
							set @arr_ptr+=1
							insert into @class_arr values (@arr_ptr,@lclasskey,@cl_slser,@m_vl,@clsname,@cstcode,@dscact);
						end
							else update @class_arr set lcamt=lcamt+@m_vl where clkey=@lclasskey;
						
					end
					if @lsl_acfm=3
					begin
						set @m_lccntr=@m_lccntr+@m_vl
						set @m_fccntr=@m_fccntr+@m_fc
					end
		--
		--  Update the rsvqty of STUNITS 
		--
		            set @subttlcost=0
					set @lttl_fcost=0

					if @m_invtype in ('06','04') and @litemtype not in ('5','6')  
					begin
						update stunits set rsvqty=rsvqty+(@lqty*@lpkqty) where itemno=@litemno and unicode=@lunicode	
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-6
							break
						end
					end	
					if @zzatca_rounding=1 set @lttl_inv=@lttl_inv+(@lqty*@zitem_price_net)  -- Added on 2023-12-19 AA
					else						
					if  @lno_round_nm=1  -- @syscode=6 or
					   set @lttl_inv=@lttl_inv+(@lqty*(@lprice-(@lprice*@ldiscpc/100)))-@psoffer_amt
					else 
					   set @lttl_inv=@lttl_inv+(@lqty*(@lprice-cast((@lprice*@ldiscpc/100) as int)))-@psoffer_amt

		--
		-- Process the STDTL table 
		--
               
					set @lt_qty=@lqty*@lpkqty
					if @litemtype not in ('5','6')
					begin
						if @m_invtype in ('06','04')
		   				begin
							set @lnobinno=1
							set @lastbinno=space(6)
							DECLARE lstbins CURSOR LOCAL FAST_FORWARD FOR
							select whno,binno,qty-rsvqty as qty,lcost,fcost from stbins where branch=@m_cmp and
							itemno=@litemno and unicode=@lunicode and whno=@ldp_mainwh; 
							open lstbins;
							fetch next from lstbins into @bwhno,@bbinno,@brmnqty,@blcost,@bfcost;
							WHILE dbo.FetchStatusOfCursorNamed('lstbins') = 0 and @lt_qty>0
							begin
								set @lnobinno=0
								set @lastbinno=@bbinno
								if @brmnqty>0
								begin
								    if len(@lfc_wh)=0 set @bfcost=0 -- Added on 2022-03-27 AA
									if @lt_qty>@brmnqty set @lxq=@brmnqty
									else set @lxq=@lt_qty
									set @lstptr=@lstptr+1
									insert into stdtl (itemno, unicode, branch, trtype, qty, fqty, whno, binno, lcost, trdate, ref,
									 sysdate, src, lprice, fcost, fprice, expdate, towhno, tobinno, barcode, cmbkey, discpc, pack,
									 shdpk, shdqty, folio, rplct_post)
									values(@litemno,@lunicode,@m_cmp,@m_invtype,@lxq,0,@bwhno,@bbinno,@blcost,@hinvdate,
									@m_ref,@ltdate,'05',@new_lprice/@lpkqty,iif(len(@lfc_wh)>0,@bfcost,0),0,'','','',@lbarcode,@lcmbkey,@ldiscpc,@lpack,@lpkqty,@lxq/@lpkqty,@lstptr,0);
									if @@error<>0
									begin
										rollback transaction
										set @errstatus=-7
										break
									end
									set @subttlcost=@subttlcost+(@blcost*@lxq)
									set @lttl_fcost=@lttl_fcost+(@bfcost*@lxq) -- Added on 2022-03-27 AA

									set @lt_qty=@lt_qty-@lxq
					--
					-- Update the RSVQTY of stbins
					--
									update stbins set rsvqty=rsvqty+@lxq where branch=@m_cmp and
											itemno=@litemno and unicode=@lunicode and whno=@bwhno and binno=@bbinno
									if @@error<>0
									begin
										rollback transaction
										set @errstatus=-8
										break
									end
								end
								if @lt_qty<=0 break					
								fetch next from lstbins into @bwhno,@bbinno,@brmnqty,@blcost,@bfcost
							end				  
							close lstbins
							deallocate lstbins
							if @errstatus<0 
							break
							if @lt_qty>0
							begin
								if @lnobinno=1
								begin
									set @ldummy=''
									select @ldummy=cmbkey from stunits with (NOLOCK) where itemno=@litemno and unicode=@lunicode;
									if RTRIM(isnull(@ldummy,''))<>''
									begin
										insert into stbins (itemno,unicode,lcost,whno,branch,binno,fcost,openlcost,openfcost,openbal,qty,rsvqty,expdate) values
										(@litemno,@lunicode,@llcost,@ldp_mainwh,@m_cmp,@lastbinno,@lfcost,0,0,0,0,0,' ');
			    						if @@error<>0
										begin
											rollback transaction
											set @errstatus=-9
											break
										end
									end						                           
								end
								set @lstptr=@lstptr+1
								set @lxq=@lt_qty
								if @lnobinno=0 and @blcost>0 set @llcost=@blcost
								if @lnobinno=0 and @bfcost>0 set @lfcost=@bfcost -- Added on 2022-03-27 AA

				 				insert into stdtl (itemno, unicode, branch, trtype, qty, fqty, whno, binno, lcost, trdate, ref,
									 sysdate, src, lprice, fcost, fprice, expdate, towhno, tobinno, barcode, cmbkey, discpc, pack,
									 shdpk, shdqty, folio, rplct_post)
								values(@litemno,@lunicode,@m_cmp,@m_invtype,@lxq,0,@ldp_mainwh,@lastbinno,
								@llcost,@hinvdate,
								@m_ref,@ltdate,'05',@new_lprice/@lpkqty,@lfcost,0,'','','',@lbarcode,@lcmbkey,@ldiscpc,@lpack,@lpkqty,@lxq/@lpkqty,@lstptr,0);
			    				if @@error<>0
								begin
									rollback transaction
									set @errstatus=-9
									break
								end
								set @subttlcost=@subttlcost+(@llcost*@lxq)
								set @lttl_fcost=@lttl_fcost+(@lfcost*@lxq) -- Added on 2022-03-27 AA

								update stbins set rsvqty=rsvqty+@lxq where branch=@m_cmp and
									itemno=@litemno and unicode=@lunicode and whno=@ldp_mainwh and binno=@lastbinno
			    				if @@error<>0
								begin
									rollback transaction
									set @errstatus=-10
									break
								end
							end
						end  -- end of type 06 & 04
						else
						begin
							select @lastbinno=binno,@blcost=lcost,@bfcost=fcost from stbins where branch=@m_cmp and
							itemno=@litemno and unicode=@lunicode and whno=@ldp_mainwh;
							if isnull(@lastbinno,'')='' set @lastbinno=space(6)
							if isnull(@blcost,0)=0 set @blcost=@llcost
							if len(@lfc_wh)=0 set @bfcost=0 -- Added on 2022-03-27 AA
							if isnull(@bfcost,0)=0 set @bfcost=@lfcost
							set @lxq=@lt_qty
							set @lstptr=@lstptr+1
							insert into stdtl (itemno, unicode, branch, trtype, qty, fqty, whno, binno, lcost, trdate, ref,
									 sysdate, src, lprice, fcost, fprice, expdate, towhno, tobinno, barcode, cmbkey, discpc, pack,
									 shdpk, shdqty, folio, rplct_post)
							values(@litemno,@lunicode,@m_cmp,@m_invtype,@lxq,0,@ldp_mainwh,@lastbinno,
							@blcost,@hinvdate,
							@m_ref,@ltdate,'05',@new_lprice/@lpkqty,@bfcost,0,'','','',@lbarcode,@lcmbkey,@ldiscpc,@lpack,@lpkqty,@lxq/@lpkqty,@lstptr,0);
							if @@error<>0
							begin
								rollback transaction
								set @errstatus=-11
								break
							end
							set @subttlcost=@subttlcost+(@blcost*@lxq)
							set @lttl_fcost=@lttl_fcost+(@bfcost*@lxq) -- Added on 2022-03-27 AA
						end  -- end of returned sales
					end	 -- end of @litemtype not in ('5','6')
---------------------------------------------------------------------------------------------------------------------
                    set @llcost=@subttlcost/(@lqty*@lpkqty)
					set @lfcost=@lttl_fcost/(@lqty*@lpkqty)

					set @xttl_fcost=@xttl_fcost+(@lqty*@lfcost*@lpkqty)
					set @xttl_cost=@xttl_cost+(@lqty*@llcost*@lpkqty)

					set @lslptr=@lslptr+1
					insert into sales_dt (slcenter, company, invtype, ref, invdate, itemno, unicode, qty, fqty, price, discpc,
					 cost, ds_acfm, sl_acfm, gclass, custno, fcy, barcode, imfcval, pack, pkqty, shadd, shdpk, shdqty, frtqty, rtnqty, whno, 
                     cmbkey, folio, rplct_post, sold_item_status,Taxtype,ps_item_vat,item_price_net,item_vat,invdscamt)
					values(@lslcenter,@m_cmp,@m_invtype,@m_ref,@hinvdate,@litemno,@lunicode,
					@lqty,0,@lprice,@ldiscpc,@llcost,@lds_acfm,@lsl_acfm,@lgclass,'','',@lbarcode,@psoffer_amt,@lpack,@lpkqty,
					'',0,0,0,0,@ldp_mainwh,@lcmbkey,@lslptr,0,0,@ltaxtype,iif(@zzatca_rounding=1,0,@psitemvat),@zitem_price_net,@zitem_vat,@zinvdscamt);
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-5
						break
					end
---------------------------------------------------------------------------------------------------------------------					   			   	
					fetch next from pogen2 into  @lcmbkey,@lqty ,@lprice ,@ldiscpc,@psoffer_amt, @lbarcode,
					@llcost,@litemno,@lunicode,@lclasskey,@lpack,@lpkqty,@ltaxtype,@litemtype,@psitemvat,@lfcost,
					@zitem_price_net,@zitem_vat,@zinvdscamt;			   	    
				end -- end of inner loop
				close pogen2
				deallocate pogen2
				if @errstatus<0 break
				if @lslptr=0 break
				set @fc_to_lc_ttl=0
				set @pd_lc=0
				set @opstval=''
				set @diff_amt=0
				set @new_rate=0
				set @match_image=0
				if @hinvpaid<>0
				begin
					if @linvorrtrn='1' and @lfcamt>0
					begin
						select @fc_to_lc_ttl=sum(posfcamt.lcamt) 
						from pos_hd inner join posfcamt inner join glcurr on posfcamt.fcy=glcurr.curcode
						on pos_hd.company=posfcamt.company and pos_hd.contr=posfcamt.contr and pos_hd.ref=posfcamt.ref
						where pos_hd.company=@m_cmp and tdatetime  between @fm_datetime and @to_datetime
						And geninv=0 and invorrtrn='1' and pos_hd.slcenter=@lslcenter and
						PriceVatType=@lpricevattype and No_round_nm=@lno_round_nm 
						and pos_hd.fcamt>0 and isnull(pos_hd.vat_percent,0)=@lnvp_vat_percent
						and isnull(zatca_rounding,0)=@zzatca_rounding; -- Added on 2023-11-10 AA

						if @fc_to_lc_ttl is null 	set @fc_to_lc_ttl=0	  
					end
					set @pd_lc=@hinvpaid-@fc_to_lc_ttl-@lcshprpaidrtn
					if @pd_lc<>0
					begin
							If @m_invtype='06' set @opstval='مبالغ نقدية مستلمة من المبيعات'
							Else set @opstval=@hcustnm
							If @pd_lc<0
							begin
								set @inv_lmtt=@inv_lmtt+Abs(@pd_lc)
								set @opstval='مبالغ نقدية مصروفة مقابل مرتجع استبدال'
							End 
			--
			-- Process GLJRDTL entries
			--
						set @ch_cnt +=1
						set @m_value=@pd_lc						
						set @m_fcval=0
						insert into gljrdtl 
						(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
						values (@m_cmp,@m_invtype,@m_ref,@hcaser,@hinvdate,@opstval,
						abs(@pd_lc),iif(@m_sign*@pd_lc<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0);	
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-12
							break
						end
						If @m_value<0
						begin
							set @l_crtot=@l_crtot+Abs(@m_value)
							set @f_crtot=@f_crtot+Abs(@m_fcval)
						end
						Else
						begin
							set @l_dbtot=@l_dbtot+Abs(@m_value)
							set @f_dbtot=@f_dbtot+Abs(@m_fcval)
						End	
					end
					if @fc_to_lc_ttl>0
					begin
						DECLARE lposfcamt CURSOR LOCAL FAST_FORWARD FOR
						select lcamt=sum(posfcamt.lcamt) ,fcamt=sum(posfcamt.fcamt),posfcamt.fcy,glcurr.curname
						from pos_hd inner join posfcamt inner join glcurr on posfcamt.fcy=glcurr.curcode
						on pos_hd.company=posfcamt.company and pos_hd.contr=posfcamt.contr and pos_hd.ref=posfcamt.ref
						where pos_hd.company=@m_cmp and tdatetime  between @fm_datetime and @to_datetime
						And geninv=0 and invorrtrn='1' and pos_hd.slcenter=@lslcenter and 
						PriceVatType=@lpricevattype and No_round_nm=@lno_round_nm
						and pos_hd.fcamt>0 and isnull(vat_percent,0)=@lnvp_vat_percent
						and isnull(zatca_rounding,0)=@zzatca_rounding -- Added on 2023-11-10 AA
						group by fcy,curname;
						open lposfcamt;
						fetch next from lposfcamt into @plcamt,@pfcamt,@fcfcy,@lcurname;
			 			WHILE dbo.FetchStatusOfCursorNamed('lposfcamt') = 0 
						begin
							set @m_value=@plcamt
							set @m_fcval=@pfcamt
							set @lglacct=''
							set @opstval='مبالغ نقدية مستلمة من المبيعات'+' '+@lcurname
							select @lglacct=glkey from glchart where glkey=@hcaser and glcurrency=@fcfcy;
							if isnull(@lglacct,'')='' 
							begin
					   			insert into glchart (glname,glkey,glcomp,glacttyp,glgroup,glactive,
								accontrol,glp_lcode,glsgrp,gleval,acprotect,cashbnk,section,actlvl,glcurrency)
								select rtrim(glname)+' '+@lcurname as glname,glkey,glcomp,glacttyp,glgroup,glactive,
								accontrol,glp_lcode,glsgrp,gleval,acprotect,cashbnk,section,actlvl,@fcfcy as glcurrency
								from glchart where glkey=@hcaser and glcurrency=space(3);
			    				if @@error<>0
								begin
									rollback transaction
									set @errstatus=-9
									break
								end
							end
							set @ch_cnt +=1
					
							insert into gljrdtl 
							(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                            ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
							values (@m_cmp,@m_invtype,@m_ref,@hcaser,@hinvdate,@opstval,
							abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),abs(@m_fcval),@fcfcy,@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0);	
							if @@error<>0
							begin
								rollback transaction
								set @errstatus=-13
								break
							end
							If @m_value<0
							begin
								set @l_crtot=@l_crtot+Abs(@m_value)
								set @f_crtot=@f_crtot+Abs(@m_fcval)
							end
							Else
							begin
								set @l_dbtot=@l_dbtot+Abs(@m_value)
								set @f_dbtot=@f_dbtot+Abs(@m_fcval)
							End	
							fetch next from lposfcamt into @plcamt,@pfcamt,@fcfcy,@lcurname
						end  -- end of loop lposfcamt
						close lposfcamt
						deallocate lposfcamt
						if @errstatus<0 
						break
					end -- end of @fc_to_lc_ttl
--------------------------------------------------------------------------------------------------------
					if @lcshprpaidrtn<>0
					begin
                        set @opstval='مرتجعات لمبيعات بطاقات نقاطي'
						--set @inv_lmtt=@inv_lmtt+Abs(@lcshprpaidrtn)

			--
			-- Process GLJRDTL entries
			--
						set @ch_cnt +=1
						set @m_value=@lcshprpaidrtn
						set @m_fcval=0
						insert into gljrdtl 
						(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
						values (@m_cmp,@m_invtype,@m_ref,@lprpaidcrdac,@hinvdate,@opstval,
						abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0);	
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-12
							break
						end
						If @m_value<0
						begin
							set @l_crtot=@l_crtot+Abs(@m_value)
							set @f_crtot=@f_crtot+Abs(@m_fcval)
						end
						Else
						begin
							set @l_dbtot=@l_dbtot+Abs(@m_value)
							set @f_dbtot=@f_dbtot+Abs(@m_fcval)
						End	
					end
---------------------------------------------------------------------------------------------------------
				end  -- end of invpaid 

		--*----- update cccommision CHARGES if any
		-- *----  cc commision paid by customer

				if @hextamt<>0
				begin
					set @m_value=-@hextamt
					set @m_fcval=0
					set @opstval='عمولات بطائق الائتمان يتحملها العميل'
					set @ch_cnt +=1
					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
					values (@m_cmp,@m_invtype,@m_ref,@hextser,@hinvdate,@opstval,
					abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0);	
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-15
						break
					end
--					
----------- For Cost center process
--
					if @lcaokcstctr=1 and isnull(@lcstctr,'')<>''
					begin
						insert into gljrcost (company,jdtype,jdref,cstcode,jdkey,jdcurr,Xpercent,amt,jddbcr
						,jdfc_imgval,jdfolno,rplct_post)
						values (@m_cmp,@m_invtype,@m_ref,@lcstctr,@hextser,'',0,abs(@m_value),
						iif(@m_sign*@m_value<0,'C','D'),0,@ch_cnt,0);
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-21
							break
						end
					end
					set @inv_lmtt=@inv_lmtt+Abs(@m_value)
					If @m_value<0
					begin
						set @l_crtot=@l_crtot+Abs(@m_value)	
						set @f_crtot=@f_crtot+Abs(@m_fcval)					
					end
					Else
					begin
						set @l_dbtot=@l_dbtot+Abs(@m_value)	
						set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
					End	
				end
		--  *----  cc commision paid by the company
				--else
				if @hcccommsn<>0
				begin
					set @m_value=-@hcccommsn
					set @m_fcval=0
					set @opstval='مصاريف عمولات بطائق الائتمان نتحملها بدل العميل'
					set @ch_cnt +=1
					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
					values (@m_cmp,@m_invtype,@m_ref,@ldp_crdcardac,@hinvdate,@opstval,
					abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0);	
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-16
						break
					end
					set @inv_lmtt=@inv_lmtt+Abs(@m_value)
					If @m_value<0
					begin
						set @l_crtot=@l_crtot+Abs(@m_value)	
						set @f_crtot=@f_crtot+Abs(@m_fcval)					
					end
					Else
					begin
						set @l_dbtot=@l_dbtot+Abs(@m_value)	
						set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
					End	
		--
					set @m_value=abs(@hcccommsn)
					set @ch_cnt +=1
					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
					values (@m_cmp,@m_invtype,@m_ref,@ldp_cardcomm,@hinvdate,@opstval,
					abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0);	
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-17
						break
					end
--					
----------- For Cost center process
--
					if @lcaokcstctr=1 and isnull(@lcstctr,'')<>''
					begin
						insert into gljrcost (company,jdtype,jdref,cstcode,jdkey,jdcurr,Xpercent,amt,jddbcr
						,jdfc_imgval,jdfolno,rplct_post)
						values (@m_cmp,@m_invtype,@m_ref,@lcstctr,@ldp_cardcomm,'',0,abs(@m_value),
						iif(@m_sign*@m_value<0,'C','D'),0,@ch_cnt,0);
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-21
							break
						end
					end
					If @m_value<0
					begin
						set @l_crtot=@l_crtot+Abs(@m_value)	
						set @f_crtot=@f_crtot+Abs(@m_fcval)					
					end
					Else
					begin
						set @l_dbtot=@l_dbtot+Abs(@m_value)	
						set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
					End	
				end -- end of @hcccommsn
------------------------------------------------------------------------------------
		-- *----  Processing the Value Added Tax paid by client 

				if @hvat_amt_rcvd<>0
				begin
					set @m_value=-@hvat_amt_rcvd 
					set @m_fcval=0
					set @opstval='ضريبة القيمة المضافة'
					set @ch_cnt +=1
					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post,taxcatId )
					values (@m_cmp,@m_invtype,@m_ref,@lvat_rcvd_act,@hinvdate,@opstval,
					abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0,@ltaxcatId);	
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-15
						break
					end
--					
----------- For Cost center process
-------------------- Stopped on 2022-05-25 AA -- Damn Bug
					--if @lcaokcstctr=1 and isnull(@lcstctr,'')<>''
					--begin
					--	insert into gljrcost (company,jdtype,jdref,cstcode,jdkey,jdcurr,Xpercent,amt,jddbcr
					--	,jdfc_imgval,jdfolno,rplct_post)
					--	values (@m_cmp,@m_invtype,@m_ref,@lcstctr,@lvat_rcvd_act,'',0,abs(@m_value),
					--	iif(@m_sign*@m_value<0,'C','D'),0,@ch_cnt,0);
					--	if @@error<>0
					--	begin
					--		rollback transaction
					--		set @errstatus=-21
					--		break
					--	end
					--end
					if not(@lpricevattype>1 and @hvat_amt_rcvd>0) or @zzatca_rounding=1 --- Added on 2023-11-10 AA
						set @inv_lmtt=@inv_lmtt+Abs(@m_value)
					If @m_value<0
					begin
						set @l_crtot=@l_crtot+Abs(@m_value)	
						set @f_crtot=@f_crtot+Abs(@m_fcval)					
					end
					Else
					begin
						set @l_dbtot=@l_dbtot+Abs(@m_value)	
						set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
					End	
					
				end
				------  End of VAT process
------------------------------------------------------------------------------------
		-- *--- Update card payment (VISA ,MASTERCARD,...ETS)

				if @hccpayment<>0
				begin
					set @m_value=@hccpayment
					set @m_fcval=0
					set @opstval='مدفوعات بطائق الائتمان'
					set @ch_cnt +=1
					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
					values (@m_cmp,@m_invtype,@m_ref,@ldp_crdcardac,@hinvdate,@opstval,
					abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0);	
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-18
						break
					end

					If @m_value<0
					begin
						set @l_crtot=@l_crtot+Abs(@m_value)	
						set @f_crtot=@f_crtot+Abs(@m_fcval)					
					end
					Else
					begin
						set @l_dbtot=@l_dbtot+Abs(@m_value)	
						set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
					End	
				end  -- end of @hccpayment
		-- *--- Update Saned card payment (Charity Foundations)
--------------- Added on 2023-10-14 AA -------------------------------------------------------------------------------------
				if @lttl_installment>0 and @linvorrtrn in ('1','2','3') and @lsmsuser<>777 -- Added on 2023-10-16 AA @lttl_installment
				begin
				        set @ltrx_installment_ttl=0; -- Added on 2023-10-17 AA

					    DECLARE linstallment CURSOR LOCAL FAST_FORWARD FOR
						select insshort,insacct,inscmsnacct,a.installment_amt,trx_inscommprcnt,trx_commp_notrtnd,trx_inscommamt,
						trx_confirmed_code,trx_instlmnt_vourcher,trx_buyer_mobile,trx_instaxable from pos_hd a inner join posinstlmnt_trx b						 
						inner join installment_cmp c
						on b.company=c.inscompany and b.trx_inscode=c.inscode
						on a.company=b.company and a.contr=b.contr and a.ref=b.ref
						where a.installment_amt>0  and 
						a.company=@m_cmp  And a.ref<>0  And geninv=0 and 
			            tdatetime  between @fm_datetime and @to_datetime and invorrtrn=@linvorrtrn
			            and a.slcenter=@lslcenter and 
						PriceVatType=@lpricevattype and No_round_nm=@lno_round_nm and discamt=@ldiscamt
						and isnull(vat_percent,0)=@lnvp_vat_percent
						and isnull(zatca_rounding,0)=@zzatca_rounding -- Added on 2023-11-10 AA
						order by inscode,tdatetime;
						open linstallment;
						
						fetch next from linstallment into @linsshort,@linsacct,@linscmsnacct,@linstallment_amt,@linscommprcnt,@lcommp_notrtnd,
						@linscommamt,@ltrx_confirmed_code,@ltrx_instlmnt_vourcher,@ltrx_buyer_mobile,@ltrx_instaxable; -- Added on 2023-10-17 AA  @ltrx_instaxable
			 			 
						WHILE dbo.FetchStatusOfCursorNamed('linstallment') = 0 
						begin
------------------------------- Take care of the installment  amount 
                            set @ltrx_installment_ttl=@ltrx_installment_ttl+@linstallment_amt -- Added on 2023-10-17 AA

							set @linstlmnt_amt_val=@linstallment_amt --iif(@linvorrtrn='1',@linstallment_amt,-@linstallment_amt)
							set @m_value=@linstlmnt_amt_val
							set @m_fcval=0
							set @opstval='تقسيط'+' '+@linsshort+' '+'حركة رقم'+' '+@ltrx_instlmnt_vourcher+' '+'جوال'+' '+@ltrx_buyer_mobile;
								
							set @ch_cnt +=1
							insert into gljrdtl 
							(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
									,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
							values (@m_cmp,@m_invtype,@m_ref,@linsacct,@hinvdate,@opstval,
							abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0);	
							if @@error<>0
							begin
								rollback transaction
								set @errstatus=-38
								break
							end

							If @m_value<0
							begin
								set @l_crtot=@l_crtot+Abs(@m_value)	
								set @f_crtot=@f_crtot+Abs(@m_fcval)					
							end
							Else
							begin
								set @l_dbtot=@l_dbtot+Abs(@m_value)	
								set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
							End	
------------------------------- Calculate the installment commisson amount for the expenses account  ---------------------------------------------------------------------------------- 
					  		if @linvorrtrn='1' set @linstlmnt_commsn=(@linstlmnt_amt_val*(@linscommprcnt+@lcommp_notrtnd))/100+@linscommamt
							else set @linstlmnt_commsn=@linstlmnt_amt_val*@linscommprcnt/100
							set @m_value=@linstlmnt_commsn
							set @m_fcval=0
							set @opstval='عمولة تقسيط'+' '+@linsshort+' '+'حركة رقم'+' '+@ltrx_instlmnt_vourcher+' '+'جوال'+' '+@ltrx_buyer_mobile;
								
							set @ch_cnt +=1
							insert into gljrdtl 
							(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
									,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
							values (@m_cmp,@m_invtype,@m_ref,@linscmsnacct,@hinvdate,@opstval,
							abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0);	
							if @@error<>0
							begin
								rollback transaction
								set @errstatus=-38
								break
							end

							If @m_value<0
							begin
								set @l_crtot=@l_crtot+Abs(@m_value)	
								set @f_crtot=@f_crtot+Abs(@m_fcval)					
							end
							Else
							begin
								set @l_dbtot=@l_dbtot+Abs(@m_value)	
								set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
							End	
------------------------------- Calculate the installment commisson amount for the installment company  ---------------------------------------------
							set @m_value=-@linstlmnt_commsn
							set @m_fcval=0
							set @opstval='عمولة تقسيط'+' '+@linsshort+' '+'حركة رقم'+' '+@ltrx_instlmnt_vourcher+' '+'جوال'+' '+@ltrx_buyer_mobile;
								
							set @ch_cnt +=1
							insert into gljrdtl 
							(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
									,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
							values (@m_cmp,@m_invtype,@m_ref,@linsacct,@hinvdate,@opstval,
							abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0);	
							if @@error<>0
							begin
								rollback transaction
								set @errstatus=-38
								break
							end

							If @m_value<0
							begin
								set @l_crtot=@l_crtot+Abs(@m_value)	
								set @f_crtot=@f_crtot+Abs(@m_fcval)					
							end
							Else
							begin
								set @l_dbtot=@l_dbtot+Abs(@m_value)	
								set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
							End	

------------------------------- Calculate the installment commisson VAT amount for the collected VAT Account ------------------------------------------
                            if @ltrx_instaxable=1
							begin
								set @linstlmnt_vatcmsn=@linstlmnt_commsn*@lvat_percent/100
								set @m_value=@linstlmnt_vatcmsn
								set @m_fcval=0
								set @opstval='ضريبة عمولة'+' '+@linsshort+' '+'حركة رقم'+' '+@ltrx_instlmnt_vourcher+' '+'جوال'+' '+@ltrx_buyer_mobile;
								
								set @ch_cnt +=1
								insert into gljrdtl 
								(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
										,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post,taxcatid )
								values (@m_cmp,@m_invtype,@m_ref,@lvat_paid_act,@hinvdate,@opstval,
								abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0,iif(@linvorrtrn='1',5,6));	
								if @@error<>0
								begin
									rollback transaction
									set @errstatus=-38
									break
								end

								If @m_value<0
								begin
									set @l_crtot=@l_crtot+Abs(@m_value)	
									set @f_crtot=@f_crtot+Abs(@m_fcval)					
								end
								Else
								begin
									set @l_dbtot=@l_dbtot+Abs(@m_value)	
									set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
								End	
	------------------------------- Calculate the installment commisson VAT amount for the Installment company ------------------------------------------
								set @m_value=-@linstlmnt_vatcmsn
								set @m_fcval=0
								set @opstval='ضريبة عمولة'+' '+@linsshort+' '+'حركة رقم'+' '+@ltrx_instlmnt_vourcher+' '+'جوال'+' '+@ltrx_buyer_mobile;
								
								set @ch_cnt +=1
								insert into gljrdtl 
								(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
										,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
								values (@m_cmp,@m_invtype,@m_ref,@linsacct,@hinvdate,@opstval,
								abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0);	
								if @@error<>0
								begin
									rollback transaction
									set @errstatus=-38
									break
								end

								If @m_value<0
								begin
									set @l_crtot=@l_crtot+Abs(@m_value)	
									set @f_crtot=@f_crtot+Abs(@m_fcval)					
								end
								Else
								begin
									set @l_dbtot=@l_dbtot+Abs(@m_value)	
									set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
								End	
							end
-----------------------------------------------------------------------------------------------------------------------------------------------------------																
							fetch next from linstallment into @linsshort,@linsacct,@linscmsnacct,@linstallment_amt,@linscommprcnt,@lcommp_notrtnd,
							@linscommamt,@ltrx_confirmed_code,@ltrx_instlmnt_vourcher,@ltrx_buyer_mobile,@ltrx_instaxable; -- Added on 2023-10-17 AA  @ltrx_instaxable
						end
					 	close linstallment
						deallocate linstallment
						if @errstatus<0 
						break
----------------------- Added on 2023-10-17 AA ---------------------
						--if @ltrx_installment_ttl<>@lttl_installment  -- Stopped on 2024-04-27 AA
						if dbo.value_balanced(@ltrx_installment_ttl,@lttl_installment)=0 -- Added on 2024-04-27 AA
						begin
						    set @errstatus=-1020
							break
						end
--------------------------------------------------------------------
				end  --- End of installment process
----------------------------------------------------------------------------------------------------------------------------
				if @hsanedcrdamt<>0
				begin
------------------- Added on 2023-10-07 AA ----------------------------------------------------------------------
				    set @lttl_chsanedamt=0
					set @lchsanedamt=0
					set @lchrcode=''
					set @lchname=''
					set @lchacct=''
				    if  @linvorrtrn='1'
					begin
					     DECLARE lcharity_saned CURSOR LOCAL FAST_FORWARD FOR
						 select chrcode,chname,chacct,sum(a.saned_amt) from pos_hd a inner join possanedchrty c						 
						 inner join pos_chrt b
						 on c.company=b.company and c.chrty_code=b.chrcode
						 on a.company=c.company and a.contr=c.contr and a.ref=c.ref
						 where a.saned_amt>0 and len(isnull(c.chrty_code,''))>0 and 
						 a.company=@m_cmp  And a.ref<>0  And geninv=0 and 
			             tdatetime  between @fm_datetime and @to_datetime and invorrtrn=@linvorrtrn
			             and a.slcenter=@lslcenter and 
						 PriceVatType=@lpricevattype and No_round_nm=@lno_round_nm and discamt=@ldiscamt
						 and isnull(vat_percent,0)=@lnvp_vat_percent
						 and isnull(zatca_rounding,0)=@zzatca_rounding -- Added on 2023-11-10 AA
						 group by chrcode,chname,chacct;
						 open lcharity_saned;
						 fetch next from lcharity_saned into @lchrcode,@lchname,@lchacct,@lchsanedamt;
			 			 WHILE dbo.FetchStatusOfCursorNamed('lcharity_saned') = 0 
						 begin
						        set @lchacct=isnull(@lchacct,'') 
							    set @lchsanedamt=isnull(@lchsanedamt,0)
								set @m_value=@lchsanedamt
								set @m_fcval=0
								set @opstval='عليكم مقابل مبيعات'+' '+@lchname
								set @ch_cnt +=1
								insert into gljrdtl 
								(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
										,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
								values (@m_cmp,@m_invtype,@m_ref,@lchacct,@hinvdate,@opstval,
								abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0);	
								if @@error<>0
								begin
									rollback transaction
									set @errstatus=-38
									break
								end

								If @m_value<0
								begin
									set @l_crtot=@l_crtot+Abs(@m_value)	
									set @f_crtot=@f_crtot+Abs(@m_fcval)					
								end
								Else
								begin
									set @l_dbtot=@l_dbtot+Abs(@m_value)	
									set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
								End	
								set @lttl_chsanedamt=@lttl_chsanedamt+@lchsanedamt
								fetch next from lcharity_saned into @lchrcode,@lchname,@lchacct,@lchsanedamt;
						 end
					 	 close lcharity_saned
						 deallocate lcharity_saned
						 if @errstatus<0 
						 break
					end  --- End of @lsmsuser=141 and @linvorrtrn='1'
					if dbo.value_balanced(@hsanedcrdamt,@lttl_chsanedamt)=0
					begin
-----------------------------------------------------------------------------------------------------------------------------
						set @m_value=@hsanedcrdamt-@lttl_chsanedamt
						set @m_fcval=0
						set @opstval='مدفوعات بطائق ساند - جمعيات خيرية'
						set @ch_cnt +=1
						insert into gljrdtl 
						(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
							 ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
						values (@m_cmp,@m_invtype,@m_ref,@lsanedcrd_act,@hinvdate,@opstval,
						abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0);	
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-38
							break
						end

						If @m_value<0
						begin
							set @l_crtot=@l_crtot+Abs(@m_value)	
							set @f_crtot=@f_crtot+Abs(@m_fcval)					
						end
						Else
						begin
							set @l_dbtot=@l_dbtot+Abs(@m_value)	
							set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
						End	
					end
				end  -- end of @hsanedcrdamt
				if @hrplsamt<>0
				begin
					set @m_value=@hrplsamt
					set @m_fcval=0
					set @opstval='مدفوعات مرتجعات الاستبدال'
					set @ch_cnt +=1
					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
					values (@m_cmp,@m_invtype,@m_ref,@ldp_rplsac,@hinvdate,@opstval,
					abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0);	
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-19
						break
					end

					If @m_value<0
					begin
						set @l_crtot=@l_crtot+Abs(@m_value)	
						set @f_crtot=@f_crtot+Abs(@m_fcval)					
					end
					Else
					begin
						set @l_dbtot=@l_dbtot+Abs(@m_value)	
						set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
					End	
				end -- end of @hrplsamt
				if @hprpaidamt<>0
				begin
					set @m_value=@hprpaidamt
					set @m_fcval=0
					set @opstval='مدفوعات بطائق مسبوقة الدفع'
					set @ch_cnt +=1
					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
					values (@m_cmp,@m_invtype,@m_ref,@lprpaidcrdac,@hinvdate,@opstval,
					abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0);	
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-20
						break
					end

					If @m_value<0
					begin
						set @l_crtot=@l_crtot+Abs(@m_value)	
						set @f_crtot=@f_crtot+Abs(@m_fcval)					
					end
					Else
					begin
						set @l_dbtot=@l_dbtot+Abs(@m_value)	
						set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
					End	
				end  -- end of @hprpaidamt
------------------------------  Handle Stcpay & Qitaf Payment  --------------------------
------------------------------ Added on 2019-04-04 ----
				if @lstcpay_amt<>0  --- StcPay 
				begin
					set @m_value=@lstcpay_amt
					set @m_fcval=0
					set @opstval='مدفوعات الاتصالات السعزدية Stcpay'
					set @ch_cnt +=1
					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
					values (@m_cmp,@m_invtype,@m_ref,@lstcpay_act,@hinvdate,@opstval,
					abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0);	
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-55
						break
					end

					If @m_value<0
					begin
						set @l_crtot=@l_crtot+Abs(@m_value)	
						set @f_crtot=@f_crtot+Abs(@m_fcval)					
					end
					Else
					begin
						set @l_dbtot=@l_dbtot+Abs(@m_value)	
						set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
					End	
				end  -- end of @lstcpay_amt

				if @lqitaf_amt<>0  --- Qitaf payment 
				begin
					set @m_value=@lqitaf_amt
					set @m_fcval=0
					set @opstval='مدفوعات قطاف'
					set @ch_cnt +=1
					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
					values (@m_cmp,@m_invtype,@m_ref,@lqitaf_act,@hinvdate,@opstval,
					abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0);	
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-57
						break
					end

					If @m_value<0
					begin
						set @l_crtot=@l_crtot+Abs(@m_value)	
						set @f_crtot=@f_crtot+Abs(@m_fcval)					
					end
					Else
					begin
						set @l_dbtot=@l_dbtot+Abs(@m_value)	
						set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
					End	
				end  -- end of @lQitaf_amt
-----------------------------------------------------------------------------------------
				if @arr_ptr>0
				begin
				    set @ttl_class_dsc=0
				    insert into @dsc_class_val 
                    SELECT substring(c.classkey,1,2) as classkey,sum((invdsvl/valafds)*(qty*(price-iif(No_round_nm=0,
					cast(price*dscprsnt/100 as int),(price*dscprsnt/100)))-offer_amt)) as dscclassamt
					from  (pos_hd inner Join pos_dt  
					on  pos_hd.company = pos_dt.company and pos_hd.Contr = pos_dt.Contr and pos_hd.ref = pos_dt.ref)
					left outer join (stunits b inner join stitems c on b.itemno=c.itemno) 
					on pos_dt.cmbkey=b.cmbkey
					where pos_hd.company=@m_cmp and pos_hd.slcenter=@lslcenter and invorrtrn=@linvorrtrn
					and PriceVatType=@lpricevattype and No_round_nm=@lno_round_nm
					And pos_hd.geninv=0  and invdsvl>0 And  not (RTRIM(pos_dt.cmbkey)='' Or RTRIM(pos_dt.barcode)='') and
					tdatetime  between @fm_datetime and @to_datetime and isnull(pos_hd.vat_percent,0)=@lnvp_vat_percent
					and isnull(zatca_rounding,0)=@zzatca_rounding -- Added on 2023-11-10 AA
					group by substring(c.classkey,1,2);

					set @dsc_ptr=@@ROWCOUNT

					while @arr_ptr>0
					begin
					    set @cl_slser=''
						set @dscact=''
						set @cstcode=''
						set @m_vl=0
						select @cl_slser=act,@m_vl=lcamt,@clsname=clsname,@cstcode=cstcode,@dscact=dscact,@xclkey=clkey
						from @class_arr
						where p_ptr=@arr_ptr;
						if isnull(@cl_slser,'')<>'' and isnull(@m_vl,0)<>0
						begin
------------------------ Added on 2020-11-23 AA--------------------------------------------
						    if @lNoDsc4SlPuJv=1 and @dsc_ptr>0
							begin
							   set @dscclassamt=0
							   select @dscclassamt=dscclassamt from @dsc_class_val where classkey=@xclkey;
							   if isnull(@dscclassamt,0)>0
							   begin
							       set @m_vl=@m_vl+@dscclassamt
								   set @ttl_class_dsc=@ttl_class_dsc+@dscclassamt
							   end
							end
--------------------------------------------------------------------------------------------
							set @m_value=@m_vl
							set @m_fcval=0
							set @opstval='مبيعات قسم'+' '+rtrim(@clsname)
							set @ch_cnt +=1
							insert into gljrdtl 
							(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                            ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
							values (@m_cmp,@m_invtype,@m_ref,@cl_slser,@hinvdate,@opstval,
							abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0);	
							if @@error<>0
							begin
								rollback transaction
								set @errstatus=-21
								break
							end
-------------------------- Added on 2018-11-30 to fix fucking bug 
							set @ttl_class_sales=@ttl_class_sales+abs(@m_value)
------------------------------------------------------------------------------
							if @lcaokcstctr=1 and isnull(@cstcode,'')<>''
							begin
								insert into gljrcost (company,jdtype,jdref,cstcode,jdkey,jdcurr,Xpercent,amt,jddbcr
								,jdfc_imgval,jdfolno,rplct_post)
								values (@m_cmp,@m_invtype,@m_ref,@cstcode,@cl_slser,'',0,abs(@m_value),
								iif(@m_sign*@m_value<0,'C','D'),0,@ch_cnt,0);
								if @@error<>0
								begin
									rollback transaction
									set @errstatus=-21
									break
								end
							end
							If @m_value<0
							begin
								set @l_crtot=@l_crtot+Abs(@m_value)	
								set @f_crtot=@f_crtot+Abs(@m_fcval)					
							end
							Else
							begin
								set @l_dbtot=@l_dbtot+Abs(@m_value)	
								set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
							End	
--
-- Process the discount value on class level 
--
							if @dsc_ptr>0 and @lNoDsc4SlPuJv=0  -- Added on 2020-11-23 AA
							if @dscact is not null and @dscact<>''
							begin
							   set @dscclassamt=0
							   
							   select @dscclassamt=dscclassamt from @dsc_class_val where classkey=@xclkey;
							   if isnull(@dscclassamt,0)>0 
							   begin
							        set @ttl_class_dsc=@ttl_class_dsc+@dscclassamt
									set @m_value=@dscclassamt
									set @m_fcval=0
									set @opstval='خصومات مبيعات قسم'+' '+rtrim(@clsname)
									set @ch_cnt +=1
									insert into gljrdtl 
									(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
									,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
									values (@m_cmp,@m_invtype,@m_ref,@dscact,@hinvdate,@opstval,
									abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0);	
									if @@error<>0
									begin
										rollback transaction
										set @errstatus=-44
										break
									end
--					
----------- For Cost center process
--
									if @lcaokcstctr=1 and isnull(@cstcode,'')<>''
									begin
										insert into gljrcost (company,jdtype,jdref,cstcode,jdkey,jdcurr,Xpercent,amt,jddbcr
										,jdfc_imgval,jdfolno,rplct_post)
										values (@m_cmp,@m_invtype,@m_ref,@cstcode,@dscact,'',0,abs(@m_value),
										iif(@m_sign*@m_value<0,'C','D'),0,@ch_cnt,0);
										if @@error<>0
										begin
											rollback transaction
											set @errstatus=-45
											break
										end
									end
									If @m_value<0
									begin
										set @l_crtot=@l_crtot+Abs(@m_value)	
										set @f_crtot=@f_crtot+Abs(@m_fcval)					
									end
									Else
									begin
										set @l_dbtot=@l_dbtot+Abs(@m_value)	
										set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
									End	
							   end
							end  -- end of discount class process
						end
						set @arr_ptr-=1
					end  -- end of @arr_ptr loop

					if @errstatus<0 break; -- Added on 2019-04-15 

				end  -- end of @arr_ptr
				If @m_lccntr<>0 Or @m_fccntr<>0
				begin
					set @m_value=@m_lccntr
					if @lpricevattype>1 and @hvat_amt_rcvd>0  and @lnvp_vat_percent>0 and   @zzatca_rounding=0  -- Added on 2023-11-10 AA
					begin
						 -------------------------- Added on 2018-11-30 to fix fucking bug 
						 -------------------- Stopped on  2019-01-15 
						 --if abs(@m_lccntr)+@ttl_class_sales<>@hvalafds-@lvat_amt_rcvd and @ttl_class_sales=0
						 --begin
							--set @m_value=-@hvalafds-@lvat_amt_rcvd
						 --end
-------------------------- Added on 2019-01-15 To fix the weired case when pricevattype=2 and sales on class level
						 if @ttl_class_sales=0
						 begin
						     ---- Modified on 2019-02-22 
							 if abs(@m_lccntr)<>@hvalafds-@lvat_amt_rcvd
							 begin
								set @m_value=-(@hvalafds-@lvat_amt_rcvd) ---- Modified on 2019-02-22
							 end
						 end
						 else
						 begin
						     set @ltmpvalue=abs(@m_lccntr)+@ttl_class_sales+@lvat_amt_rcvd
							 if @ltmpvalue<>@hvalafds
							 begin
							   if @ltmpvalue<@hvalafds set  @m_value=@m_lccntr+(@ltmpvalue-@hvalafds) 
							   else set  @m_value=@m_lccntr-(@ltmpvalue-@hvalafds)
							 end
						 end
--------------------------  end of addation 
						 set @inv_stk=@hvalafds
					end
-------------------- Added on 2020-11-23 AA ----------------------------------------------------
					if @lNoDsc4SlPuJv=1 and dbo.value_balanced(@hinvdsvl,@ttl_class_dsc)=0
					begin
					    set  @m_value=@m_value-iif(@m_value<0,-(@hinvdsvl-@ttl_class_dsc),(@hinvdsvl-@ttl_class_dsc))
					end
--------------------------------------------------------------------------------------------------					
					set @m_fcval=@m_fccntr
					set @opstval=@hcustnm
					set @ch_cnt +=1
					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
					values (@m_cmp,@m_invtype,@m_ref,@ldp_slser,@hinvdate,@opstval,
					abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0);	
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-22
						break
					end
--					
----------- For Cost center process
--
					if @lcaokcstctr=1 and isnull(@lcstctr,'')<>''
					begin
						insert into gljrcost (company,jdtype,jdref,cstcode,jdkey,jdcurr,Xpercent,amt,jddbcr
						,jdfc_imgval,jdfolno,rplct_post)
						values (@m_cmp,@m_invtype,@m_ref,@lcstctr,@ldp_slser,'',0,abs(@m_value),
						iif(@m_sign*@m_value<0,'C','D'),0,@ch_cnt,0);
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-21
							break
						end
					end
					If @m_value<0
					begin
						set @l_crtot=@l_crtot+Abs(@m_value)	
						set @f_crtot=@f_crtot+Abs(@m_fcval)					
					end
					Else
					begin
						set @l_dbtot=@l_dbtot+Abs(@m_value)	
						set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
					End	
				end  -- end of @m_lccntr

		-- to update discount from total inv-.force dept disc
				if dbo.value_balanced(@hinvdsvl,@ttl_class_dsc)=0 and @lNoDsc4SlPuJv=0 -- Added on 2020-11-23 AA
				begin
					set @m_value=@hinvdsvl-@ttl_class_dsc
					set @m_fcval=0
					set @opstval='خصومات المبيعات النقدية'
					set @ch_cnt +=1
					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
					values (@m_cmp,@m_invtype,@m_ref,@ldp_expser,@hinvdate,@opstval,
					abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0);	
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-14
						break
					end
--					
----------- For Cost center process
--
					if @lcaokcstctr=1 and isnull(@lcstctr,'')<>''
					begin
						insert into gljrcost (company,jdtype,jdref,cstcode,jdkey,jdcurr,Xpercent,amt,jddbcr
						,jdfc_imgval,jdfolno,rplct_post)
						values (@m_cmp,@m_invtype,@m_ref,@lcstctr,@ldp_expser,'',0,abs(@m_value),
						iif(@m_sign*@m_value<0,'C','D'),0,@ch_cnt,0);
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-21
							break
						end
					end
					If @m_value<0
					begin
						set @l_crtot=@l_crtot+Abs(@m_value)	
						set @f_crtot=@f_crtot+Abs(@m_fcval)					
					end
					Else
					begin
						set @l_dbtot=@l_dbtot+Abs(@m_value)	
						set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
					End	
				end  -- end of @hinvdsvl
--
-- Process the Halal discount after the final total 
---
                if @lhlldscamt>0
				begin
					set @m_value=@lhlldscamt
					set @m_fcval=0
					set @opstval='خصومات الهلل من صافي الفاتورة'
					set @ch_cnt +=1
					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
					values (@m_cmp,@m_invtype,@m_ref,@ldp_expser,@hinvdate,@opstval,
					abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0);	
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-14
						break
					end
					If @m_value<0
					begin
						set @l_crtot=@l_crtot+Abs(@m_value)	
						set @f_crtot=@f_crtot+Abs(@m_fcval)					
					end
					Else
					begin
						set @l_dbtot=@l_dbtot+Abs(@m_value)	
						set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
					End	
				end

		--
		--  Finalize update accumalted variables in tables GLJRHDR , SALES_HD  , STHDR
		--
		-----------------Update gljrhdr

				if @hinvttl<>0
				begin
				    if @lNoDsc4SlPuJv=1 and @hinvdsvl>0 set @inv_lmtt=@inv_lmtt-@hinvdsvl  -- Added on 2020-11-23 AA

					update gljrhdr set jhfcflag=iif(@fc_to_lc_ttl>0,1,2),jhentries=@ch_cnt,jhlccrttl = @l_crtot,
					jhfccrttl= @f_crtot,jhlcdbttl = @l_dbtot,jhfcdbttl = @f_dbtot,
					jhamt = Iif(@inv_lmtt>@l_dbtot,@inv_lmtt,@l_dbtot) where jhcomp=@m_cmp and jhtype=@m_invtype and
					jhref=@m_ref
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-23
						break
					end
				end
		--------- Update sthdr
				If @lstptr>0
				begin
				 ------  Added on 2019-08-07 to fix the @inv_stk when lpricevattype>1
				    if @lpricevattype>1 and @hvat_amt_rcvd>0 and @lnvp_vat_percent>0 and  @zzatca_rounding=0 set @inv_stk=@hvalafds
					update sthdr set entries=@lstptr,amnttl = @inv_stk,costttl = @xttl_cost where branch=@m_cmp 
					and trtype=@m_invtype and ref=@m_ref
				end
				else  delete from sthdr where branch=@m_cmp and trtype=@m_invtype and ref=@m_ref
				if @@error<>0
				begin
					rollback transaction
					set @errstatus=-24
					break
				end
---------------------------------------------------------------------------------------------------    
                set @gl_mref=0
                if @lcntstkon=1
				begin
		--
		-- Insert One Record in GLJRHR
		--
		            
					
					
					set @ljhfcflag=2
					set @hcustnm='تكلفة المبيعات لفاتورة رقم '+@m_invtype+'/'+str(@m_ref)
					set @hinvdate=replace(@grdate,'-','')
					----- Added on 2019-11-30  
					----- Added on 2020-08-22 to prevent table locking 
					begin transaction -- Added on 2020-08-22 
					if len(@lsc_code)>0 and @loksctions=1 and @lSctnHasSerial=1 
					begin 
					    set @gl_mref=dbo.get_last_ref_section('17',@m_cmp,@lsc_code)
						update glsction set jv_17=@gl_mref+1 where sc_company=@m_cmp and sc_code=@lsc_code
					end
					else 
					begin 
					   set @gl_mref=dbo.get_last_ref('17',@m_cmp)
					   update stbranch set jv_17=@gl_mref+1 where brnno=@m_cmp
					end
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-9
						break
					end
				    commit transaction -- Added on 2020-08-22 

					insert into gljrhdr (jhcomp,jhtype,jhref,jhcurr,jhamt,jhdate,jhrate,jhtext,jhsrc,jhfcflag,jhreleased,jhposted,
					jhsysdate,modified,[Suspend],usrid,lastupdt,rcvdtrn,isbrtrx,brxref,brxfrm,jhcustno,jhentries,jhlccrttl,
					jhfccrttl,jhlcdbttl,jhfcdbttl) 
					values (@m_cmp,'17',@gl_mref,'',@xttl_cost,@hinvdate,0,@hcustnm,'05',
					@ljhfcflag,0,0,@ltdate,1,0,@p_username,@ltdate,@replication,0,'','','',2,@xttl_cost,0,@xttl_cost,0)
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-26
						break
					end  
--
--  insert on gljrdtl				          			  
--  Entry One
                    set @ldbcr=iif(@m_invtype='06','D','C')
					set @m_value=@xttl_cost
					set @m_fcval=0
					set @opstval=@hcustnm
					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
							 ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
					values (@m_cmp,'17',@gl_mref,@lsrcst,@hinvdate,@opstval,
					abs(@m_value),@ldbcr,0,'',1,1,@ltdate,'05',0,0,'','','',0,0,0)	
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-21
						break
					end
-- Entry Two
--					
----------- For Cost center process
--
					if @lcaokcstctr=1 and isnull(@lcstctr,'')<>''
					begin
						insert into gljrcost (company,jdtype,jdref,cstcode,jdkey,jdcurr,Xpercent,amt,jddbcr
						,jdfc_imgval,jdfolno,rplct_post)
						values (@m_cmp,'17',@gl_mref,@lcstctr,@lsrcst,'',0,abs(@m_value),
						@ldbcr,0,1,0)
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-21
							break
						end
					end

					set @ldbcr=iif(@m_invtype='06','C','D')

					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
							 ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
					values (@m_cmp,'17',@gl_mref,@ldp_diffser,@hinvdate,@opstval,
					abs(@m_value),@ldbcr,0,'',2,2,@ltdate,'05',0,0,'','','',0,0,0)	
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-21
						break
					end									    
				end
-----------------------------------------------------------------------------------------------------------------------
		--    Update sales_hd
				update sales_hd set entries=@lslptr,valafds = @lttl_inv,invttl=@lttl_inv+@hextamt+iif(@lpricevattype=1 or @zzatca_rounding=1,@hvat_amt_rcvd,0) ,invcst=@xttl_cost,
				stkjvno=@gl_mref
				where company=@m_cmp and invtype=@m_invtype and ref=@m_ref
				if @@error<>0
				begin
					rollback transaction
					set @errstatus=-25
					break
				end

			end  --- end of invorrtrn<>'4' -----------------------------------------
			else
			begin
		--
		-- Insert One Record in GLJRHR awadd
		--
				set @ljhfcflag=2
				set @hcustnm='مدفوعات نقدية للعملاء'
				set @hinvdate=replace(@grdate,'-','')
				set @m_invtype='01'
				----- Added on 2019-11-30  
				----- Added on 2020-08-22 to prevent table locking 
				----- Added on 2021-11-15 AA 
				if @ldeleted_geninv>0 set @m_ref=@ldeleted_geninv
				else
				begin
					begin transaction -- Added on 2020-08-22 
					if len(@lsc_code)>0 and @loksctions=1 and @lSctnHasSerial=1 
					begin 
						 set @m_ref=dbo.get_last_ref_section('01',@m_cmp,@lsc_code)
						 update glsction set jv_01=@m_ref+1 where sc_company=@m_cmp and sc_code=@lsc_code
					end
					else
					begin
						set @m_ref=dbo.get_last_ref('01',@m_cmp)
						update stbranch set jv_01=@m_ref+1 where brnno=@m_cmp
					end
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-9
						break
					end
					commit transaction -- Added on 2020-08-22 
				end

				set @hinvttl=@lvalafds-@linvdsvl+iif(@lpricevattype=1 or @zzatca_rounding=1,@lvat_amt_rcvd,0)-@lhlldscamt-@lttl_installment -- Added on 2023-10-16 AA @lttl_installment

				insert into gljrhdr (jhcomp,jhtype,jhref,jhcurr,jhamt,jhdate,jhrate,jhtext,jhsrc,jhfcflag,jhreleased,jhposted,
				jhsysdate,modified,[Suspend],usrid,lastupdt,rcvdtrn,isbrtrx,brxref,brxfrm,jhcustno,jhentries,jhlccrttl,
				jhfccrttl,jhlcdbttl,jhfcdbttl) 
				values (@m_cmp,@m_invtype,@m_ref,'',@hinvttl,@hinvdate,0,@hcustnm,'01',
				@ljhfcflag,0,0,@ltdate,1,0,@p_username,@ltdate,@replication,0,'05','','',iif(@lcshprpaidrtn=0,2,3),@hinvttl,0,@hinvttl,0)
				if @@error<>0
				begin
					rollback transaction
					set @errstatus=-26
					break
				end  
--
--  insert on gljrdtl				          			  
--  Entry One
				set @m_value=@hinvttl-@lcshprpaidrtn
				set @m_fcval=0
				set @opstval='صرف نقدي لمبيعات مرتجعه'
				insert into gljrdtl 
				(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
				values (@m_cmp,@m_invtype,@m_ref,@ldp_cashser,@hinvdate,@opstval,
				abs(@m_value),'C',0,'',1,1,@ltdate,'01',0,0,'','','',0,0,0)	
				if @@error<>0
				begin
					rollback transaction
					set @errstatus=-21
					break
				end

-- Entry Two
--------  Added on 2019-08-22  
               if @lcshprpaidrtn>0
			   begin
					set @m_value=@lcshprpaidrtn
					set @m_fcval=0
					set @opstval='مرتجع نقدي لبطاقات نقاطي'
					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
							 ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
					values (@m_cmp,@m_invtype,@m_ref,@lprpaidcrdac,@hinvdate,@opstval,
					abs(@m_value),'C',0,'',2,2,@ltdate,'01',0,0,'','','',0,0,0)	
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-21
						break
					end
			   end
-- Entry three
				set @opstval='مبالغ مرتجعه للعملاء بدل استبدال'
				set @m_value=@hinvttl
				insert into gljrdtl 
				(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
				values (@m_cmp,@m_invtype,@m_ref,@ldp_rplsac,@hinvdate,@opstval,
				abs(@m_value),'D',0,'',iif(@lcshprpaidrtn=0,2,3),iif(@lcshprpaidrtn=0,2,3),@ltdate,'01',0,0,'','','',0,0,0)	
				if @@error<>0
				begin
					rollback transaction
					set @errstatus=-21
					break
				end
			end
			delete from @class_arr
			delete from @dsc_class_val
	 
--------------------------------   Process charity donations  ------------------------------------------------------
			if  @linvorrtrn='1' and 
			exists(SELECT table_name  FROM INFORMATION_SCHEMA.tables  with (NOLOCK) WHERE TABLE_NAME ='poschrtinv')
			begin
				select @donation_amt=sum(poschrtinv.hllamt) 
				from pos_hd inner join poschrtinv 					
				on pos_hd.company=poschrtinv.company and pos_hd.contr=poschrtinv.contr and pos_hd.ref=poschrtinv.ref
				where pos_hd.company=@m_cmp and tdatetime  between @fm_datetime and @to_datetime
				And geninv=0 and invorrtrn='1' and pos_hd.slcenter=@lslcenter and 
				PriceVatType=@lpricevattype and No_round_nm=@lno_round_nm
				and poschrtinv.hllamt>0 and isnull(pos_hd.vat_percent,0)=@lnvp_vat_percent
				and isnull(zatca_rounding,0)=@zzatca_rounding; -- Added on 2023-11-10 AA

				set @donation_amt=isnull(@donation_amt,0)	  										
				if @donation_amt>0
				begin
						set @opstval='تبرعات نقدية مستلمة لصالح الجمعيات الخيرية'
		--
		-- Insert One Record in GLJRHR
		--
		                set @gl_mref=0
						set @ch_cnt  =0
						set @ljhfcflag=2
						set @hcustnm='تبرعات نقدية مستلمة لصالح الجمعيات الخيرية'
						set @hinvdate=replace(@grdate,'-','')
						set @m_invtype='01'

						----- Added on 2019-11-30 
						----- Added on 2020-08-22 to prevent table locking  
						begin transaction -- Added on 2020-08-22 
						if len(@lsc_code)>0 and @loksctions=1 and @lSctnHasSerial=1 
						begin 
							set @gl_mref=dbo.get_last_ref_section('01',@m_cmp,@lsc_code)
							update glsction set jv_01=@gl_mref+1 where sc_company=@m_cmp and sc_code=@lsc_code
						end
						else 
						begin 
						   set @gl_mref=dbo.get_last_ref('01',@m_cmp)
						   update stbranch set jv_01=@gl_mref+1 where brnno=@m_cmp
						end

						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-9
							break
						end
						commit transaction -- Added on 2020-08-22 

						insert into gljrhdr (jhcomp,jhtype,jhref,jhcurr,jhamt,jhdate,jhrate,jhtext,jhsrc,jhfcflag,jhreleased,jhposted,
						jhsysdate,modified,[Suspend],usrid,lastupdt,rcvdtrn,isbrtrx,brxref,brxfrm,jhcustno,jhentries,jhlccrttl,
						jhfccrttl,jhlcdbttl,jhfcdbttl) 
						values (@m_cmp,@m_invtype,@gl_mref,'',@donation_amt,@hinvdate,0,@hcustnm,'05',
						@ljhfcflag,0,0,@ltdate,1,0,@p_username,@ltdate,@replication,0,'','SL','',2,@donation_amt,0,@donation_amt,0)
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-26
							break
						end  
 
			--
			-- Process GLJRDTL entries
			--
						set @ch_cnt +=1
						set @m_value=@donation_amt
						set @m_fcval=0
						insert into gljrdtl 
						(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
							,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
						values (@m_cmp,'01',@gl_mref,@hcaser,@hinvdate,@opstval,
						abs(@donation_amt),'D',0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0)	
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-12
							break
						end

						DECLARE lposchrtinv CURSOR LOCAL FAST_FORWARD FOR
						select lhllamt=sum(poschrtinv.hllamt) ,pos_chrt.chrcode,chacct,pos_chrt.chname
						from pos_hd inner join poschrtinv inner join pos_chrt 
						on poschrtinv.company=pos_chrt.company and poschrtinv.chrcode=pos_chrt.chrcode
						on pos_hd.company=poschrtinv.company and pos_hd.contr=poschrtinv.contr and pos_hd.ref=poschrtinv.ref
						where pos_hd.company=@m_cmp and tdatetime  between @fm_datetime and @to_datetime
						And geninv=0 and invorrtrn='1' and pos_hd.slcenter=@lslcenter and
						PriceVatType=@lpricevattype and No_round_nm=@lno_round_nm
						and poschrtinv.hllamt>0 and isnull(pos_hd.vat_percent,0)=@lnvp_vat_percent
						and isnull(zatca_rounding,0)=@zzatca_rounding -- Added on 2023-11-10 AA
						group by pos_chrt.chrcode,chacct,pos_chrt.chname;

						open lposchrtinv;
						fetch next from lposchrtinv into @lhll_amt,@lchrcode,@lchacct,@lchname
			 			WHILE dbo.FetchStatusOfCursorNamed('lposchrtinv') = 0 
						begin
							set @m_value=@lhll_amt
							set @m_fcval=0
							set @opstval='تبرع لصالح'+' '+@lchname

							set @ch_cnt +=1
					
							insert into gljrdtl 
							(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
							,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
							values (@m_cmp,'01',@gl_mref,@lchacct,@hinvdate,@opstval,
							abs(@m_value),'C',0,' ',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0)	
							if @@error<>0
							begin
								rollback transaction
								set @errstatus=-13
								break
							end

							fetch next from lposchrtinv into @lhll_amt,@lchrcode,@lchacct,@lchname
						end  -- end of loop lposchrtinv
						close lposchrtinv
						deallocate lposchrtinv
						if @errstatus<0 
						break

		--    Update sales_hd
						update sales_hd set rtnref=@gl_mref
						where company=@m_cmp and invtype='06' and ref=@m_ref
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-25
							break
						end
		--    Update gljrhdr
						update gljrhdr set jhentries=@ch_cnt,brxref=ltrim(str(@m_ref,6)) where jhcomp=@m_cmp and jhtype='01' and
						jhref=@gl_mref
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-23
							break
						end					
				end -- end of @donation_amt
			end  -------- end of @syscode=6 or @lno_round_nm=1
--------------------------------------------------------------------------------------------------------------------		
--
----  Update POS_HD 
--
----- ----- Modified on 2021-11-15 AA to update the new column deleted_geninv           
			Update pos_hd Set geninv =@m_ref,deleted_geninv=0
		    where company=@m_cmp and slcenter=@lslcenter and
			PriceVatType=@lpricevattype and No_round_nm=@lno_round_nm and discamt=@ldiscamt --- added on 2019-04-15
			and invorrtrn=@linvorrtrn	And pos_hd.geninv=0  and tdatetime  between @fm_datetime and @to_datetime
			and isnull(whlslinv,0)=@lwhlslinv and isnull(pos_hd.vat_percent,0)=@lnvp_vat_percent  --- added on 2020-06-04
			and isnull(zatca_rounding,0)=@zzatca_rounding -- Added on 2023-11-10 AA
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-27
				break
			end	
			 
			IF @errstatus=0 
			begin
			   COMMIT TRANSACTION
			   set @no_of_gen_inv +=1
			end
			--else
			--if @@TRANCOUNT>0
			--begin
			--   rollback transaction
			--   break
			--end

			fetch next from pogen1 into @lslcenter,@linvorrtrn,@lentries,@linvttl,@linvcst,@linvdsvl,@lvalafds,
			@lfcamt,@lprpaid,@lcash,@lccpayment,@lcharges,@lcccommision,@lcsanedcrdamt,@lvat_amt_rcvd,
			@ltaxfree_sales,@lhlldscamt,@lpricevattype,@lno_round_nm,@ldiscamt,@lstcpay_amt,@lqitaf_amt,@lcshprpaidrtn,@lwhlslinv,
			@lnvp_vat_percent,@ldeleted_cntr,@lttl_installment,@zzatca_rounding;


			set @arr_ptr=0
		end -- end of outer loop
------- Added on 2024-04-27 AA ------------------------------
		if @@TRANCOUNT>0
		begin
		  IF @errstatus=0 COMMIT TRANSACTION
		  else rollback transaction	
		end
----------------------------------------------------------		
		close pogen1
		deallocate pogen1
        return @errstatus			 
end


GO
/****** Object:  StoredProcedure [dbo].[Generate_Invoice_Frm_POS2]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


 CREATE PROCEDURE [dbo].[Generate_Invoice_Frm_POS2]
	@m_cmp char(2),
	@p_date char(20),
	@p_slcenter char(2),
	@p_trxtype char(1),
	@p_supermarket bit,
	@p_username char(10),
	@p_unq_bc_in_shwrm bit,
	@errstatus int =0 output,
	@no_of_gen_inv int =0 output
	
	AS
	BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
---------------------------------------------------------------------------------------------
	declare 
	@dbc nvarchar(14),
	@lcalcomp char(2),
	@yrcode char(4),
	@syscode int =2,
	@lcauseslctr bit=0,
	@lcaokcstctr bit=0,
	@lrepl_type numeric(1,0)=0,
	@lpos_strt_h numeric(1,0)=5,
	@pos_fm_hour char(8),
	@pos_to_hour char(8),
	@dsc_amt_selected bit =0,
	@lno_round_nm BIT =0,
	@lcntstkon bit =0 ,
	@ldbcr char(1)='',
	@lpricevattype numeric(1,0)=1,
	@lvat_percent numeric(10,3)=0,
	@lhlldscamt float =0,
	@lPVT_level numeric(1,0) =0
------  Added on 2018-07-04	
    declare @o_syscode numeric(2,0)=0,
	        @o_lno_round_nm bit =0,
			@o_lpricevattype numeric(1,0)=1,
			@loksctions bit =0

			set @o_syscode=0
			set @o_lno_round_nm=0
			set @o_lpricevattype=1

	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)

	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @syscode=isnull(sysno,2),@lcauseslctr=causeslctr,@lcaokcstctr=isnull(caokcstctr,0),@lrepl_type=repl_type,
	@lpos_strt_h=isnull(pos_strt_h,5),@dsc_amt_selected=isnull(is_dsc_amt,0),@lno_round_nm=isnull(no_round_nm,0),
	@lcntstkon=cntstkon,@lpricevattype=isnull(pricevattype,1),@lvat_percent=vat_percent,
    @lPVT_level=isnull(SysNo_PVT_level,0),@loksctions=isnull(oksctions,0)
    from sysdb.dbo.glcalend where calcomp=@lcalcomp and yrcode=@yrcode

    set @lpricevattype=isnull(@lpricevattype,1)
------------------------------ added 2018-07-04  -------------------------------------------------------------------
    -- take values from stbranch
	set @o_syscode=@syscode
	set @o_lno_round_nm=@lno_round_nm
	set @o_lpricevattype=@lpricevattype
    if @lPVT_level=2
	begin
	    set @syscode=0
		set @lno_round_nm=0
		set @lpricevattype=1
	    select @syscode=sysno,@dsc_amt_selected=isnull(is_dsc_amt,0),@lno_round_nm=no_round_nm,
		@lpricevattype=pricevattype from stbranch where brnno=@m_cmp	

		if @syscode=0 or @syscode is null set @syscode=@o_syscode
		if @lno_round_nm is null set @lno_round_nm=@o_lno_round_nm	
		if @lpricevattype=0 or @lpricevattype is null set @lpricevattype=@o_lpricevattype
	end

--------------------------------------------------------------------------------------------------------------------------- 
	IF @lpos_strt_h=4 --start from 4 clock
	begin
	   set @pos_fm_hour='04:00:00'  
	   set @pos_to_hour='03:59:00'  
	end   
	ELSE
	begin
	   set @pos_fm_hour='05:00:00'  
	   set @pos_to_hour='04:59:00'  
	end   

-----------------------         Declaration for Donations  --------------------------------------
    declare @donation_amt numeric(12,3)=0,
			@gl_mref numeric(6,0)=0,
			@lchrcode char(1),
			@lchname varchar(50),
			@lhll_amt numeric(12,3),
			@lchacct char(19)
-----------------------------------------------------------------------------------------------
	declare  @m_type char(2),
			@m_ref  numeric(6,0),
			@fm_datetime smalldatetime,
			@to_datetime smalldatetime,
			@m_fmtrxtype char(1),
			@m_totrxtype char(1),
			@m_fmslcenter char(2),
			@m_toslcenter char(2),
			@m_invtype char(2),
			@ltxt varchar(40),
			@server_is_publisher bit =0,
			@hjdate char(10)='',
			@grdate char(10)='',
			@l_vt float=0
	--
	--  prepair the parameters needed for the sql statement
	--
	if len(rtrim(@p_date))>10
	begin
	     set @hjdate=substring(@p_date,11,10)
	end
	set @grdate=substring(@p_date,1,10)
	--
	set @m_fmtrxtype=@p_trxtype
	set @m_totrxtype=@p_trxtype
	if @p_trxtype='5'
	begin
		set @m_fmtrxtype='1'
		set @m_totrxtype='4'
	end
	--- sales center variables
	set @m_fmslcenter=@p_slcenter
	set @m_toslcenter=@p_slcenter
	if @p_slcenter=''
	begin
		set @m_fmslcenter='01'
		set @m_toslcenter='99'
	end

	--  Build up the datetime needed
	--
	set @fm_datetime=cast(@grdate+' '+@pos_fm_hour as smalldatetime)
	set @to_datetime=cast(cast(dateadd(dd,1,cast(@grdate as date)) as char(10))+' '+@pos_to_hour as smalldatetime)
	--
	if DATALENGTH(rtrim(@hjdate))=10
	   set @grdate=@hjdate
	
	declare @lslcenter char(2),
		@linvorrtrn char(1),
		@lentries int ,        
		@linvttl float,
		@linvcst float,
		@linvdsvl float,
		@lvalafds float,
		@lfcamt float,
		@lprpaid numeric(13,3),
		@lcash numeric(13,3),
		@lccpayment numeric(13,3),
		@lcsanedcrdamt numeric(13,3),
		@lcharges numeric(13,3),
		@lcccommision float,
		@ljhfcflag numeric(1,0),
		@lt_qty numeric(13,3),
		@lxq numeric(13,3),
		@ldummy char(24),
		@arr_ptr int =0,
		@subttlcost float=0,
		@lvat_amt_rcvd float =0,
		@ltaxfree_sales float =0,
		@ltaxcatId int =0
		


	-- declare the array holding text for the transaction type
	declare @trxarr table( chx char(1) not null , v varchar(40) not null )
	insert into @trxarr values ('1','مبيعات نقدية')
	insert into @trxarr values ('2','مرتجع استبدال')
	insert into @trxarr values ('3','مرتجع مبيعات نقدية')
	insert into @trxarr values ('4','سند صرف نقدي مقابل مرتجع مبيعات')

	-- Read field from Salecntr 
	declare @ldp_cashser char(19),
		@ldp_okdiff bit ,
		@ldp_mainwh char(2),
		@ldp_expser char(19),
		@ldp_crdcardac char(19),
		@ldp_cardcomm char(19),
		@ldp_rplsac char(19),
		@ldp_diffser char(19),
		@lDP_CSLSER char(19),
		@lDP_RCSLSER char(19),
		@lprpaidcrdac char(19),
		@ltdate char(8),
		@lglacct char(19),
		@lexacct char(19),
		@ldp_slser char(19),
		@lsanedcrd_act char(19),
		@lcstctr char(4)='',
		@lsrcst char(19)='',
		@lvat_rcvd_act char(19)='',
		@ltaxtype char(1)=''
		
	-- variables for sales_hd
	declare @hslcenter char(2),
		@hbranch char(2),
		@hcompany char(2),
		@hinvtype char(2),
		@href numeric(6,0),
		@hinvdate char(8) ,        
		@hcustno char(6), 
		@hcustnm varchar(50),
		@hcaser char(19),
		@hfcy char(3)='',
		@hfcyrate float=0,
		@hinvttl float,
		@hinvcst float,
		@hinvdspc float,
		@hinvdsvl float,
		@hvalafds float,
		@hinvpaid numeric(13,3),
		@hextamt numeric(13,3),
		@hextser char(19),
		@hcccommsn float,
		@hbelowbal bit,
		@hccpayment numeric(13,3),
		@hsanedcrdamt numeric(12,3),
		@hrplsamt numeric(13,3),
		@hprpaidamt numeric(13,3),
		@husrid char(8),
		@hfxrate float =0,
		@hINSTFLAG bit,
		@hposinv numeric(1,0)=1,
		@hvat_amt_rcvd float=0,
		@htaxfree_sales float=0
		

	---
	---   sales_dt declarations
	---
	declare @litemno char(16),
		@lunicode char(6) ,
		@lqty  numeric(13,3),
		@lfqty  numeric(13,3),
		@lprice numeric(13,3),
		@ldiscpc float,
		@lds_acfm numeric(1,0),
		@lsl_acfm numeric(1,0),
		@lgclass char(8),
		@lbarcode char(20),
		@limfcval float,
		@lpack char(1),
		@lpkqty numeric(8,3),
		@lwhno char(2) ,
		@lcmbkey char(24),
		@litemtype char(1),
		@llcost float,
		@blcost float,
		@lfcost float,
		@lstfcy char(3),
		@lclasskey char(12),
		@cl_slser char(19),
		@lslptr int=0,
		@lstptr int=0,
		@lttl_inv float=0
		
	--
	--   Stbins declaration 
	--
	declare @bwhno char(2),
		@bbinno char(6),
		@brmnqty numeric(13,3),
		@lnobinno bit=1,
		@lastbinno char(6)
	--
	-- Declare variables of ADD_DTLS procedure VFP
	--
	declare @xttl_cost float=0,
		@inv_lmtt  float=0,
		@inv_lftt  float=0,
		@m_vl      float=0,
		@m_fc      float=0,
		@inv_stk   float=0,
		@m_lccntr  float=0,
		@m_fccntr  float=0,
		@pd_lc     float =0,
		@opstval varchar(50),
		@diff_amt float=0,
		@new_rate float=0,
		@match_image bit ,
		@fc_to_lc_ttl float=0,
		@ch_cnt int =0,
		@l_crtot float=0,
		@f_crtot float=0,
		@l_dbtot float=0,
		@f_dbtot float=0,
		@m_sign int =0,
		@m_value float=0,
		@m_fcval float=0,
		@plcamt float ,
		@pfcamt float ,
		@fcfcy char (3),
		@lcurname char(20),
		@replication bit =0,
		@xclkey char(12)='',
		@clsname char(20)='',
		@cstcode char(4)='',
		@dscact char(19)='',
		@dscclassamt float=0,
		@dsc_ptr int =0,
		@ttl_class_dsc float=0,
		@lsc_code char(4)=''
		

    if exists(select 1 from sys.servers where is_distributor=1)
    set @replication=1
 	else
	begin	  
	  set @replication=isnull(@lrepl_type,0)
    end
   
	   
	 
	-- DECLARE ARRAY HOLDING THE ITEM CLASS AND ACCOUNT
	declare @class_arr table( p_ptr int,clkey char(12) not null , act char(19) not null,lcamt float ,
	clsname char(20),cstcode char(4),dscact char(19))

    declare @dsc_class_val table(classkey char(12) not null,dscclassamt float default 0)
	declare @pscmbkey char(24),@psqty numeric(12,3),@psprice float,@psdscprsnt float,
  		@psoffer_amt numeric(8, 2), @psbarcode char(20) 
		  
	set @ltdate=replace(cast (GETDATE() as DATE),'-','')
	set @lpricevattype=0
	set @lno_round_nm=0

	DECLARE pogen1 CURSOR LOCAL FAST_FORWARD FOR
	Select slcenter, invorrtrn, sum(entries) As entries,
		sum(invttl) As invttl, Sum(invcst-isnull(dfvchramt,0.00)) As invcst, Sum(invdsvl) As invdsvl,
		sum(valafds) As valafds,fcamt=sum(fcamt),
		sum(prepaidamt) As prpaid,Sum(cashamt) As cash,Sum(ccpaid) As ccpayment,
		charges=sum(iif(ccconus='0', chargeamt, cast(0 as numeric(15,5)))),Sum(chargeamt) As cccommision,
		Sum(isnull(saned_amt,0.00)) As sanedcrdamt,sum(isnull(vat_amt_rcvd,0)) as vat_amt_rcvd,
		sum(isnull(taxfree_sales,0)) as taxfree_sales,sum(isnull(hlldscnt,0)) as hlldscntamt ,
		PriceVatType,No_round_nm
		from pos_hd where company=@m_cmp  And ref<>0  And geninv=0 and 
		tdatetime  between @fm_datetime and @to_datetime and invorrtrn between  @m_fmtrxtype and @m_totrxtype
		and slcenter between @m_fmslcenter and @m_toslcenter
		group By slcenter, invorrtrn,PriceVatType,No_round_nm
		order By slcenter, invorrtrn,PriceVatType,No_round_nm

		open pogen1;
		set @errstatus=0;
		fetch next from pogen1 into @lslcenter,@linvorrtrn,@lentries,@linvttl,@linvcst,@linvdsvl,@lvalafds,
		@lfcamt,@lprpaid,@lcash,@lccpayment,@lcharges,@lcccommision,@lcsanedcrdamt,@lvat_amt_rcvd,
		@ltaxfree_sales,@lhlldscamt,@lpricevattype,@lno_round_nm;
		
		WHILE dbo.FetchStatusOfCursorNamed('pogen1') = 0
		BEGIN

	  		set @ch_cnt  =0
			set @l_crtot =0
			set @f_crtot =0
			set @l_dbtot =0
			set @f_dbtot =0
			set @m_value=0
			set @m_fcval=0
			set @xttl_cost=0
			set @lsc_code=''

			begin transaction
				
			select @ldp_cashser=dp_cashser,@ldp_okdiff=dp_okdiff,@ldp_mainwh=dp_mainwh,@ldp_expser=dp_expser,
			@ldp_crdcardac=dp_crdcardac,@ldp_cardcomm=dp_cardcomm,@ldp_rplsac=dp_rplsac,@ldp_diffser=dp_diffser,@lsrcst=srcst,
			@lDP_CSLSER=DP_CSLSER,@lDP_RCSLSER=DP_RCSLSER,@lprpaidcrdac=prpaidcrdac,@lsanedcrd_act=sanedcrd_act,
			@lcstctr=isnull(cstcode,''),@lvat_rcvd_act=vat_rcvd_act,@lsc_code=isnull(sc_code,'') 
			 from salecntr with (NOLOCK)
			where dp_brno=@m_cmp and dp_dept=@lslcenter

------------------------------ added 2018-07-04  -------------------------------------------------------------------
    -- take values from glsction
			if @lPVT_level=3 and len(@lsc_code)>0 and @loksctions=1
			begin
				set @syscode=0
				set @dsc_amt_selected=0
				set @lno_round_nm=0
				set @lpricevattype=1

				select @syscode=sysno,@dsc_amt_selected=isnull(is_dsc_amt,0),@lno_round_nm=no_round_nm,
				@lpricevattype=pricevattype from glsction where sc_company=@m_cmp and sc_code=@lsc_code

				if @syscode=0 or @syscode is null set @syscode=@o_syscode
				if @lno_round_nm is null set @lno_round_nm=@o_lno_round_nm	
				if @lpricevattype=0 or @lpricevattype is null set @lpricevattype=@o_lpricevattype							
			end			
------------------------------------------------------------------------------------------------------------------

			if @linvorrtrn<>'4'
			begin
			    if @linvorrtrn in ('1','3') set @hcaser=@ldp_cashser
				else set @hcaser=@ldp_rplsac
				if @linvorrtrn='1' set @ldp_slser=@lDP_CSLSER
				else set @ldp_slser=@lDP_RCSLSER
--				set @hextser=iif(@linvorrtrn='2',@ldp_rplsac,@ldp_cashser)
				set @hextser=iif(@lcharges<>0,@ldp_cardcomm,'')
				set @m_invtype=iif(@linvorrtrn='1','06','26')
				set @ltaxcatId=iif(@m_invtype='06',1,2)
				set @m_sign=iif(@linvorrtrn='1',1,-1)
				set @m_ref=dbo.get_last_ref(@m_invtype,@m_cmp)
				set @hINSTFLAG=iif(@lfcamt>0,1,0)
				set @hinvpaid=iif(@m_invtype='06',@lcash-(@lcash+@lccpayment+@lcsanedcrdamt+@linvcst+@lprpaid+@linvdsvl+@lhlldscamt-(@lvalafds+@lcharges+iif(@lpricevattype=1,@lvat_amt_rcvd,0))),
					@lvalafds-@linvdsvl+iif(@lpricevattype=1,@lvat_amt_rcvd,0)-@lhlldscamt)
				set @hinvdate=replace(@grdate,'-','')
				set @hinvttl=@linvttl+@linvdsvl -- return back the invoice discount to the invttl
				set @hinvdsvl=@linvdsvl
				set @hvalafds=@lvalafds
				set @hextamt=@lcharges
				set @hcccommsn=@lcccommision
				set @hccpayment=@lccpayment
				set @hsanedcrdamt=@lcsanedcrdamt
				set @hrplsamt=@linvcst
				set @hprpaidamt=@lprpaid
				set @hvat_amt_rcvd=@lvat_amt_rcvd
				set @htaxfree_sales=@ltaxfree_sales 

				if @m_invtype='06' update stbranch set jv_06=@m_ref+1 where brnno=@m_cmp
				else update stbranch set jv_26=@m_ref+1 where brnno=@m_cmp
			    if @@error<>0
				begin
					rollback transaction
					set @errstatus=-9
					break
				end
				select @hcustnm=v from @trxarr where chx=@linvorrtrn
				set @hposinv=cast(@linvorrtrn as numeric(1,0))
		--- insert data in sales_hd

				insert into sales_hd 
				(slcenter,branch ,company ,invtype ,ref ,invdate,custno ,custnm ,glser,dsctype ,pstmode
				,fcy,fcyrate,duedate ,invttl,invcst,invdspc ,invdsvl ,valafds ,invpaid ,caser ,entries
				,released,posted ,fixrate ,extamt,extser ,pricetp,ischeque ,chkno ,chkdate ,lastupdt,jvgenrt
				,cccommsn ,belowbal,fcy2,ccpayment ,rplsamt,pdother ,slcode,prpaidamt,instldays ,instflag
				,slcmnd ,inv_printed ,bendit ,modified ,rqstorder ,rqststld ,carrier ,rcvdtrn ,usrid ,address
				,suspend ,rtnref,ispurchase ,stkjvno ,posinv ,sanedcrd_amt,vat_amt_rcvd,taxfree_sales,
				clnt_taxcode,clnt_kind,hlldscnt,sysno,No_round_nm,PriceVatType)
				values (@lslcenter,'Q',@m_cmp,@m_invtype,@m_ref,@hinvdate,'',
				@hcustnm,'','',0,'',0,'',@hinvttl,0,0,@linvdsvl,@lvalafds,
				@hinvpaid,
				@hcaser,@lentries,0,0,0,@lcharges,@hextser,'1',0,'','',@ltdate,0,@lcccommision,0,
				'',@lccpayment,@linvcst,0,'',@lprpaid,0,@hINSTFLAG,0,0,0,1,0,0,'',@replication,@p_username,
				'',0,0,0,0,@hposinv,@lcsanedcrdamt,@hvat_amt_rcvd,@htaxfree_sales,'','',@lhlldscamt,
				@syscode,@lno_round_nm,@lpricevattype)
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-1
						break
					end
		--
		--- insert one record in STHDR
		--   
				insert into sthdr (branch,trtype,ref,trdate,amnttl,[text],fcy,fcyrate,costttl,src,posted,released,
				entries,whno,modified,usrid,sysdate,lastupdt,rcvdtrn,isbrtrx,towhno,custno,brsupp,tobrno,brxref,glref,asmtype) 
				values (@m_cmp,@m_invtype,@m_ref,@hinvdate,0,@hcustnm,@hfcy,0,0,
				'05',0,0,0,@ldp_mainwh,1,@p_username,@ltdate,@ltdate,@replication,0,' ','','','',0,0,0)
				if @@error<>0
				begin
					rollback transaction
					set @errstatus=-2
					break
				end
		--
		-- Insert One Record in GLJRHR
		--
				set @ljhfcflag=iif(@Hfcy='',2,1)
				insert into gljrhdr (jhcomp,jhtype,jhref,jhcurr,jhamt,jhdate,jhrate,jhtext,jhsrc,jhfcflag,jhreleased,jhposted,
				jhsysdate,modified,[Suspend],usrid,lastupdt,rcvdtrn,isbrtrx,brxref,brxfrm,jhcustno) 
				values (@m_cmp,@m_invtype,@m_ref,@hfcy,0,@hinvdate,0,@hcustnm,'05',
				@ljhfcflag,0,0,@ltdate,1,0,@p_username,@ltdate,@replication,0,'','','')
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-3
						break
					end            
				if @p_unq_bc_in_shwrm=1
				begin
					DECLARE pogen2 CURSOR LOCAL FAST_FORWARD FOR
					Select pos_dt.cmbkey,  Sum(pos_dt.qty) As qty, pos_dt.price, pos_dt.dscprsnt,sum(isnull(offer_amt,0)) as offer_amt,
					b.barcode,lcost,b.itemno,b.unicode,substring(c.classkey,1,2) as classkey,pack0 as pack,1 as pkqty,pos_dt.taxtype
					from  (pos_hd inner Join pos_dt  
					on  pos_hd.company = pos_dt.company and pos_hd.Contr = pos_dt.Contr and pos_hd.ref = pos_dt.ref)
					left outer join (stunits b inner join stitems c on b.itemno=c.itemno) 
					on pos_dt.cmbkey=b.cmbkey
					where pos_hd.company=@m_cmp and pos_hd.slcenter=@lslcenter and invorrtrn=@linvorrtrn
					and pos_hd.pricevattype=@lpricevattype and pos_hd.No_round_nm=@lno_round_nm
					And pos_hd.geninv=0 And  not (RTRIM(pos_dt.cmbkey)='' Or RTRIM(pos_dt.barcode)='') and
					tdatetime  between @fm_datetime and @to_datetime
					group By pos_dt.cmbkey,pos_dt.price,pos_dt.dscprsnt,b.barcode,lcost,b.itemno,b.unicode,classkey,
					pack0,pos_dt.taxtype
					order By pos_dt.cmbkey,pos_dt.price,pos_dt.dscprsnt
				end
				else
				begin
					if @p_supermarket=1
					begin
		 				DECLARE pogen2 CURSOR LOCAL FAST_FORWARD FOR
						Select pos_dt.cmbkey,  Sum(pos_dt.qty) As qty, pos_dt.price, pos_dt.dscprsnt,
						sum(isnull(offer_amt,0)) as offer_amt,pos_dt.barcode,lcost,b.itemno,b.unicode,substring(f.classkey,1,2) as classkey,
						c.pack,c.pkqty,pos_dt.taxtype
						from  (pos_hd inner Join pos_dt  
						on  pos_hd.company = pos_dt.company and pos_hd.Contr = pos_dt.Contr and pos_hd.ref = pos_dt.ref)
						left outer join (stitems f inner join stunits b on f.itemno=b.itemno
						inner join stitembc c on b.itemno=c.itemno and b.unicode=c.unicode) 
						on pos_dt.barcode=c.pbarcode
						where pos_hd.company=@m_cmp and pos_hd.slcenter=@lslcenter and invorrtrn=@linvorrtrn
						and pos_hd.pricevattype=@lpricevattype and pos_hd.No_round_nm=@lno_round_nm
						And pos_hd.geninv=0 And  not (RTRIM(pos_dt.cmbkey)='' Or RTRIM(pos_dt.barcode)='') and
						tdatetime  between @fm_datetime and @to_datetime
						group By pos_dt.cmbkey,pos_dt.barcode,pos_dt.price,pos_dt.dscprsnt,lcost,b.itemno,b.unicode,classkey,
						c.pack,c.pkqty,pos_dt.taxtype
						order By pos_dt.cmbkey,pos_dt.barcode,pos_dt.price,pos_dt.dscprsnt
					end
					else
					begin
		 				DECLARE pogen2 CURSOR LOCAL FAST_FORWARD FOR
						Select pos_dt.cmbkey,  Sum(pos_dt.qty) As qty, pos_dt.price, pos_dt.dscprsnt,
						sum(isnull(offer_amt,0)) as offer_amt,pos_dt.barcode,lcost,b.itemno,b.unicode,substring(c.classkey,1,2) as classkey
						,pack0 as pack,1 as pkqty,pos_dt.taxtype
						from  (pos_hd inner Join pos_dt  
						on  pos_hd.company = pos_dt.company and pos_hd.Contr = pos_dt.Contr and pos_hd.ref = pos_dt.ref)
						left outer join (stunits b inner join stitems c on b.itemno=c.itemno) 
						on pos_dt.cmbkey=b.cmbkey
						where pos_hd.company=@m_cmp and pos_hd.slcenter=@lslcenter and invorrtrn=@linvorrtrn
						and pos_hd.pricevattype=@lpricevattype and pos_hd.No_round_nm=@lno_round_nm
						And pos_hd.geninv=0 And  not (RTRIM(pos_dt.cmbkey)='' Or RTRIM(pos_dt.barcode)='') and
						tdatetime  between @fm_datetime and @to_datetime
						group By pos_dt.cmbkey,pos_dt.barcode,pos_dt.price,pos_dt.dscprsnt,lcost,b.itemno,b.unicode,
						classkey,pack0,pos_dt.taxtype
						order By pos_dt.cmbkey,pos_dt.barcode,pos_dt.price,pos_dt.dscprsnt
					end
				end
				open pogen2;
				set @lslptr=0
				set @lstptr=0
				set @lttl_inv=0
				set @arr_ptr=0
				set @ttl_class_dsc=0
				set @dsc_ptr=0
				set @xttl_cost=0
				set @inv_stk=0
				set @inv_lftt=0
				set @inv_lmtt=0
				set @m_lccntr=0
				set @m_fccntr=0
				set @ltaxtype='1'

				fetch next from pogen2 into  @lcmbkey,@lqty ,@lprice ,@ldiscpc,@psoffer_amt, @lbarcode,
				@llcost,@litemno,@lunicode,@lclasskey,@lpack,@lpkqty,@ltaxtype
				WHILE dbo.FetchStatusOfCursorNamed('pogen2') = 0
				BEGIn
		--
		-- insert one line each time in SALES_DT
		--    
--		            set @llcost=isnull(@llcost,0)
                    set @ltaxtype=isnull(@ltaxtype,'1')
                    set @llcost=isnull(@llcost,0)
					set @litemno=iif(isnull(@litemno,'')='','',@litemno)
					set @lunicode=iif(isnull(@lunicode,'')='','',@lunicode)
					set @lpack=iif(isnull(@lpack,'')='','',@lpack)
					set @lpkqty=iif(isnull(@lpkqty,0)=0,1,@lpkqty)
					set @lclasskey=iif(isnull(@lclasskey,'')='','',@lclasskey)
					set @lclasskey=rtrim(@lclasskey)+replicate(space(1),12-datalength(rtrim(@lclasskey)))	
					set @cl_slser=''		 
					select @cl_slser=iif(@m_invtype='06',SERCSH,SERRCH),@clsname=name,@cstcode=cstcode,@dscact=serdsc
					 from slclass with (NOLOCK) where company=@m_cmp and cmbkey=@lclasskey
					if rtrim(isnull(@cl_slser,''))='' 
					begin
						set @lsl_acfm=3
						set @lds_acfm=3
						set @lgclass=''
					end
					else
					begin
						set @lsl_acfm=2
						set @lds_acfm=2
						set @lgclass=rtrim(@lclasskey)
					end
					--set @lslptr=@lslptr+1
					--insert into sales_dt values(@lslcenter,@m_cmp,@m_invtype,@m_ref,@hinvdate,@litemno,@lunicode,
					--@lqty,0,@lprice,@ldiscpc,@llcost,@lds_acfm,@lsl_acfm,@lgclass,'','',@lbarcode,@psoffer_amt,@lpack,@lpkqty,
					--'',0,0,0,0,@ldp_mainwh,@lcmbkey,@lslptr,0)
					--if @@error<>0
					--begin
					--	rollback transaction
					--	set @errstatus=-5
					--	break
					--end
		--
		-- set up the accumelated values for sum vars
		--
			
					if  @lno_round_nm=1  --@syscode=6 or
						set @m_vl=-(@lqty*(@lprice-(@lprice*@ldiscpc/100))-@psoffer_amt)
					Else
					    set @m_vl=-(@lqty*(@lprice-cast(@lprice*@ldiscpc/100 as int))-@psoffer_amt)
------ Stopped on 2018-07-04
					 --   if @dsc_amt_selected=0
						--set @m_vl=-(@lqty*(@lprice-cast(@lprice*@ldiscpc/100 as int))-@psoffer_amt)
						--else
						--set @m_vl=-(@lqty*(@lprice-(@lprice*@ldiscpc/100))-@psoffer_amt)

-----
--------------------------------  Added on 2017-12-04 -------------------------------
----  Seprate  the sales from the vat
                   if @lpricevattype>1 and @hvat_amt_rcvd>0 and @ltaxtype='1' and @lvat_percent>0
				   begin
				      set @l_vt =0
					  if @linvdsvl>0 and @lvalafds>0
					  set @l_vt=@m_vl*@linvdsvl/@lvalafds
					 set @l_vt=(@m_vl-@l_vt)*@lvat_percent/(100+@lvat_percent)
					 set @m_vl=@m_vl-@l_vt
				   end
-------------------------------------------------------------------------------------
						
					set @m_fc=0.00
					set @inv_lftt=@inv_lftt+abs(@m_vl)
					set @inv_lmtt=@inv_lmtt+Abs(@m_vl)   
					set @inv_stk=@inv_stk+Abs(@m_vl) 
					if @lsl_acfm=2
					begin 
					    set @xclkey=''
						select @xclkey=clkey from  @class_arr where clkey=@lclasskey
						if rtrim(isnull(@xclkey,''))=''
						begin
							set @arr_ptr+=1
							insert into @class_arr values (@arr_ptr,@lclasskey,@cl_slser,@m_vl,@clsname,@cstcode,@dscact)
						end
							else update @class_arr set lcamt=lcamt+@m_vl where clkey=@lclasskey
						
					end
					if @lsl_acfm=3
					begin
						set @m_lccntr=@m_lccntr+@m_vl
						set @m_fccntr=@m_fccntr+@m_fc
					end
		--
		--  Update the rsvqty of STUNITS 
		--
		            set @subttlcost=0
					if @m_invtype in ('06','04')
					begin
						update stunits set rsvqty=rsvqty+(@lqty*@lpkqty) where itemno=@litemno and unicode=@lunicode	
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-6
							break
						end
					end							
					if  @lno_round_nm=1  -- @syscode=6 or
					   set @lttl_inv=@lttl_inv+(@lqty*(@lprice-(@lprice*@ldiscpc/100)))-@psoffer_amt
					else 
					   set @lttl_inv=@lttl_inv+(@lqty*(@lprice-cast((@lprice*@ldiscpc/100) as int)))-@psoffer_amt
------ Stopped on 2018-07-04
					--begin
					--  if @dsc_amt_selected=0
					--    set @lttl_inv=@lttl_inv+(@lqty*(@lprice-cast((@lprice*@ldiscpc/100) as int)))-@psoffer_amt
					--  else
					--    set @lttl_inv=@lttl_inv+(@lqty*(@lprice-((@lprice*@ldiscpc/100))))-@psoffer_amt
					--end
		
		--
		-- Process the STDTL table 
		--
               
					set @lt_qty=@lqty*@lpkqty
					if @m_invtype in ('06','04')
		   			begin
						set @lnobinno=1
						set @lastbinno=space(6)
						DECLARE lstbins CURSOR LOCAL FAST_FORWARD FOR
						select whno,binno,qty-rsvqty as qty,lcost from stbins where branch=@m_cmp and
						itemno=@litemno and unicode=@lunicode and whno=@ldp_mainwh --and qty-rsvqty>0
						open lstbins;
						fetch next from lstbins into @bwhno,@bbinno,@brmnqty,@blcost
						WHILE dbo.FetchStatusOfCursorNamed('lstbins') = 0 and @lt_qty>0
						begin
							set @lnobinno=0
							set @lastbinno=@bbinno
							if @brmnqty>0
							begin
								if @lt_qty>@brmnqty set @lxq=@brmnqty
								else set @lxq=@lt_qty
								set @lstptr=@lstptr+1
								insert into stdtl (itemno, unicode, branch, trtype, qty, fqty, whno, binno, lcost, trdate, ref,
								 sysdate, src, lprice, fcost, fprice, expdate, towhno, tobinno, barcode, cmbkey, discpc, pack,
								 shdpk, shdqty, folio, rplct_post)
								values(@litemno,@lunicode,@m_cmp,@m_invtype,@lxq,0,@bwhno,@bbinno,@blcost,@hinvdate,
								@m_ref,@ltdate,'05',@lprice/@lpkqty,0,0,'','','',@lbarcode,@lcmbkey,@ldiscpc,@lpack,@lpkqty,@lxq/@lpkqty,@lstptr,0)
								if @@error<>0
								begin
									rollback transaction
									set @errstatus=-7
									break
								end
								set @subttlcost=@subttlcost+(@blcost*@lxq)
								set @lt_qty=@lt_qty-@lxq
				--
				-- Update the RSVQTY of stbins
				--
								update stbins set rsvqty=rsvqty+@lxq where branch=@m_cmp and
										itemno=@litemno and unicode=@lunicode and whno=@bwhno and binno=@bbinno
								if @@error<>0
								begin
									rollback transaction
									set @errstatus=-8
									break
								end
							end
							if @lt_qty<=0 break					
							fetch next from lstbins into @bwhno,@bbinno,@brmnqty,@blcost
						end				  
						close lstbins
						deallocate lstbins
						if @errstatus<0 
						break
						if @lt_qty>0
						begin
							if @lnobinno=1
							begin
							    set @ldummy=''
								select @ldummy=cmbkey from stunits with (NOLOCK) where itemno=@litemno and unicode=@lunicode
								if RTRIM(isnull(@ldummy,''))<>''
								begin
									insert into stbins (itemno,unicode,lcost,whno,branch,binno,fcost,openlcost,openfcost,openbal,qty,rsvqty,expdate) values
									(@litemno,@lunicode,@llcost,@ldp_mainwh,@m_cmp,@lastbinno,0,0,0,0,0,0,' ')
			    					if @@error<>0
									begin
										rollback transaction
										set @errstatus=-9
										break
									end
								end						                           
							end
							set @lstptr=@lstptr+1
							set @lxq=@lt_qty
							if @lnobinno=0 and @blcost>0 set @llcost=@blcost
				 			insert into stdtl (itemno, unicode, branch, trtype, qty, fqty, whno, binno, lcost, trdate, ref,
								 sysdate, src, lprice, fcost, fprice, expdate, towhno, tobinno, barcode, cmbkey, discpc, pack,
								 shdpk, shdqty, folio, rplct_post)
							values(@litemno,@lunicode,@m_cmp,@m_invtype,@lxq,0,@ldp_mainwh,@lastbinno,
							@llcost,@hinvdate,
							@m_ref,@ltdate,'05',@lprice/@lpkqty,0,0,'','','',@lbarcode,@lcmbkey,@ldiscpc,@lpack,@lpkqty,@lxq/@lpkqty,@lstptr,0)
			    			if @@error<>0
							begin
								rollback transaction
								set @errstatus=-9
								break
							end
							set @subttlcost=@subttlcost+(@llcost*@lxq)
							update stbins set rsvqty=rsvqty+@lxq where branch=@m_cmp and
								itemno=@litemno and unicode=@lunicode and whno=@ldp_mainwh and binno=@lastbinno
			    			if @@error<>0
							begin
								rollback transaction
								set @errstatus=-10
								break
							end
						end
					end  -- end of type 06 & 04
					else
					begin
						select @lastbinno=binno,@blcost=lcost from stbins where branch=@m_cmp and
						itemno=@litemno and unicode=@lunicode and whno=@ldp_mainwh
						if isnull(@lastbinno,'')='' set @lastbinno=space(6)
						if isnull(@blcost,0)=0 set @blcost=@llcost
						set @lxq=@lt_qty
						set @lstptr=@lstptr+1
						insert into stdtl (itemno, unicode, branch, trtype, qty, fqty, whno, binno, lcost, trdate, ref,
								 sysdate, src, lprice, fcost, fprice, expdate, towhno, tobinno, barcode, cmbkey, discpc, pack,
								 shdpk, shdqty, folio, rplct_post)
						values(@litemno,@lunicode,@m_cmp,@m_invtype,@lxq,0,@ldp_mainwh,@lastbinno,
						@blcost,@hinvdate,
						@m_ref,@ltdate,'05',@lprice/@lpkqty,0,0,'','','',@lbarcode,@lcmbkey,@ldiscpc,@lpack,@lpkqty,@lxq/@lpkqty,@lstptr,0)
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-11
							break
						end
						set @subttlcost=@subttlcost+(@blcost*@lxq)
					end  -- end of returned sales	
---------------------------------------------------------------------------------------------------------------------
                    set @llcost=@subttlcost/(@lqty*@lpkqty)
					set @xttl_cost=@xttl_cost+(@lqty*@llcost*@lpkqty)
					set @lslptr=@lslptr+1
					insert into sales_dt (slcenter, company, invtype, ref, invdate, itemno, unicode, qty, fqty, price, discpc,
					 cost, ds_acfm, sl_acfm, gclass, custno, fcy, barcode, imfcval, pack, pkqty, shadd, shdpk, shdqty, frtqty, rtnqty, whno, 
                     cmbkey, folio, rplct_post, sold_item_status,Taxtype)
					values(@lslcenter,@m_cmp,@m_invtype,@m_ref,@hinvdate,@litemno,@lunicode,
					@lqty,0,@lprice,@ldiscpc,@llcost,@lds_acfm,@lsl_acfm,@lgclass,'','',@lbarcode,@psoffer_amt,@lpack,@lpkqty,
					'',0,0,0,0,@ldp_mainwh,@lcmbkey,@lslptr,0,0,@ltaxtype)
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-5
						break
					end
---------------------------------------------------------------------------------------------------------------------					   			   	
					fetch next from pogen2 into  @lcmbkey,@lqty ,@lprice ,@ldiscpc,@psoffer_amt, @lbarcode,
					@llcost,@litemno,@lunicode,@lclasskey,@lpack,@lpkqty,@ltaxtype			   	    
				end -- end of inner loop
				close pogen2
				deallocate pogen2
				if @errstatus<0 break
				if @lslptr=0 break
				set @fc_to_lc_ttl=0
				set @pd_lc=0
				set @opstval=''
				set @diff_amt=0
				set @new_rate=0
				set @match_image=0
				if @hinvpaid<>0
				begin
					if @linvorrtrn='1' and @lfcamt>0
					begin
						select @fc_to_lc_ttl=sum(posfcamt.lcamt) 
						from pos_hd inner join posfcamt inner join glcurr on posfcamt.fcy=glcurr.curcode
						on pos_hd.company=posfcamt.company and pos_hd.contr=posfcamt.contr and pos_hd.ref=posfcamt.ref
						where pos_hd.company=@m_cmp and tdatetime  between @fm_datetime and @to_datetime
						And geninv=0 and invorrtrn='1' and pos_hd.slcenter=@lslcenter and
						PriceVatType=@lpricevattype and No_round_nm=@lno_round_nm
						and pos_hd.fcamt>0

						if @fc_to_lc_ttl is null 	set @fc_to_lc_ttl=0	  
					end
					set @pd_lc=@hinvpaid-@fc_to_lc_ttl
					if @pd_lc<>0
					begin
							If @m_invtype='06' set @opstval='مبالغ نقدية مستلمة من المبيعات'
							Else set @opstval=@hcustnm
							If @pd_lc<0
							begin
								set @inv_lmtt=@inv_lmtt+Abs(@pd_lc)
								set @opstval='مبالغ نقدية مصروفة مقابل مرتجع استبدال'
							End 
			--
			-- Process GLJRDTL entries
			--
						set @ch_cnt +=1
						set @m_value=@pd_lc
						set @m_fcval=0
						insert into gljrdtl 
						(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
						values (@m_cmp,@m_invtype,@m_ref,@hcaser,@hinvdate,@opstval,
						abs(@pd_lc),iif(@m_sign*@pd_lc<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0)	
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-12
							break
						end
						If @m_value<0
						begin
							set @l_crtot=@l_crtot+Abs(@m_value)
							set @f_crtot=@f_crtot+Abs(@m_fcval)
						end
						Else
						begin
							set @l_dbtot=@l_dbtot+Abs(@m_value)
							set @f_dbtot=@f_dbtot+Abs(@m_fcval)
						End	
					end
					if @fc_to_lc_ttl>0
					begin
						DECLARE lposfcamt CURSOR LOCAL FAST_FORWARD FOR
						select lcamt=sum(posfcamt.lcamt) ,fcamt=sum(posfcamt.fcamt),posfcamt.fcy,glcurr.curname
						from pos_hd inner join posfcamt inner join glcurr on posfcamt.fcy=glcurr.curcode
						on pos_hd.company=posfcamt.company and pos_hd.contr=posfcamt.contr and pos_hd.ref=posfcamt.ref
						where pos_hd.company=@m_cmp and tdatetime  between @fm_datetime and @to_datetime
						And geninv=0 and invorrtrn='1' and pos_hd.slcenter=@lslcenter and 
						PriceVatType=@lpricevattype and No_round_nm=@lno_round_nm
						and pos_hd.fcamt>0
						group by fcy,curname
						open lposfcamt;
						fetch next from lposfcamt into @plcamt,@pfcamt,@fcfcy,@lcurname
			 			WHILE dbo.FetchStatusOfCursorNamed('lposfcamt') = 0 
						begin
							set @m_value=@plcamt
							set @m_fcval=@pfcamt
							set @lglacct=''
							set @opstval='مبالغ نقدية مستلمة من المبيعات'+' '+@lcurname
							select @lglacct=glkey from glchart where glkey=@hcaser and glcurrency=@fcfcy
							if isnull(@lglacct,'')='' 
							begin
					   			insert into glchart (glname,glkey,glcomp,glacttyp,glgroup,glactive,
								accontrol,glp_lcode,glsgrp,gleval,acprotect,cashbnk,section,actlvl,glcurrency)
								select rtrim(glname)+' '+@lcurname as glname,glkey,glcomp,glacttyp,glgroup,glactive,
								accontrol,glp_lcode,glsgrp,gleval,acprotect,cashbnk,section,actlvl,@fcfcy as glcurrency
								from glchart where glkey=@hcaser and glcurrency=space(3)
			    				if @@error<>0
								begin
									rollback transaction
									set @errstatus=-9
									break
								end
							end
							set @ch_cnt +=1
					
							insert into gljrdtl 
							(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                            ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
							values (@m_cmp,@m_invtype,@m_ref,@hcaser,@hinvdate,@opstval,
							abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),abs(@m_fcval),@fcfcy,@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0)	
							if @@error<>0
							begin
								rollback transaction
								set @errstatus=-13
								break
							end
							If @m_value<0
							begin
								set @l_crtot=@l_crtot+Abs(@m_value)
								set @f_crtot=@f_crtot+Abs(@m_fcval)
							end
							Else
							begin
								set @l_dbtot=@l_dbtot+Abs(@m_value)
								set @f_dbtot=@f_dbtot+Abs(@m_fcval)
							End	
							fetch next from lposfcamt into @plcamt,@pfcamt,@fcfcy,@lcurname
						end  -- end of loop lposfcamt
						close lposfcamt
						deallocate lposfcamt
						if @errstatus<0 
						break
					end -- end of @fc_to_lc_ttl
				end  -- end of invpaid 

		--*----- update cccommision CHARGES if any
		-- *----  cc commision paid by customer

				if @hextamt<>0
				begin
					set @m_value=-@hextamt
					set @m_fcval=0
					set @opstval='عمولات بطائق الائتمان'
					set @ch_cnt +=1
					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
					values (@m_cmp,@m_invtype,@m_ref,@hextser,@hinvdate,@opstval,
					abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0)	
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-15
						break
					end
--					
----------- For Cost center process
--
					if @lcaokcstctr=1 and isnull(@lcstctr,'')<>''
					begin
						insert into gljrcost (company,jdtype,jdref,cstcode,jdkey,jdcurr,Xpercent,amt,jddbcr
						,jdfc_imgval,jdfolno,rplct_post)
						values (@m_cmp,@m_invtype,@m_ref,@lcstctr,@hextser,'',0,abs(@m_value),
						iif(@m_sign*@m_value<0,'C','D'),0,@ch_cnt,0)
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-21
							break
						end
					end
					set @inv_lmtt=@inv_lmtt+Abs(@m_value)
					If @m_value<0
					begin
						set @l_crtot=@l_crtot+Abs(@m_value)	
						set @f_crtot=@f_crtot+Abs(@m_fcval)					
					end
					Else
					begin
						set @l_dbtot=@l_dbtot+Abs(@m_value)	
						set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
					End	
				end
		--  *----  cc commision paid by the company
				else
				if @hcccommsn<>0
				begin
					set @m_value=-@hcccommsn
					set @m_fcval=0
					set @opstval='مصاريف عمولات بطائق الائتمان'
					set @ch_cnt +=1
					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
					values (@m_cmp,@m_invtype,@m_ref,@ldp_crdcardac,@hinvdate,@opstval,
					abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0)	
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-16
						break
					end
					set @inv_lmtt=@inv_lmtt+Abs(@m_value)
					If @m_value<0
					begin
						set @l_crtot=@l_crtot+Abs(@m_value)	
						set @f_crtot=@f_crtot+Abs(@m_fcval)					
					end
					Else
					begin
						set @l_dbtot=@l_dbtot+Abs(@m_value)	
						set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
					End	
		--
					set @m_value=abs(@hcccommsn)
					set @ch_cnt +=1
					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
					values (@m_cmp,@m_invtype,@m_ref,@ldp_cardcomm,@hinvdate,@opstval,
					abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0)	
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-17
						break
					end
--					
----------- For Cost center process
--
					if @lcaokcstctr=1 and isnull(@lcstctr,'')<>''
					begin
						insert into gljrcost (company,jdtype,jdref,cstcode,jdkey,jdcurr,Xpercent,amt,jddbcr
						,jdfc_imgval,jdfolno,rplct_post)
						values (@m_cmp,@m_invtype,@m_ref,@lcstctr,@ldp_cardcomm,'',0,abs(@m_value),
						iif(@m_sign*@m_value<0,'C','D'),0,@ch_cnt,0)
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-21
							break
						end
					end
					If @m_value<0
					begin
						set @l_crtot=@l_crtot+Abs(@m_value)	
						set @f_crtot=@f_crtot+Abs(@m_fcval)					
					end
					Else
					begin
						set @l_dbtot=@l_dbtot+Abs(@m_value)	
						set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
					End	
				end -- end of @hcccommsn
------------------------------------------------------------------------------------
		-- *----  Processing the Value Added Tax paid by client 

				if @hvat_amt_rcvd<>0
				begin
					set @m_value=-@hvat_amt_rcvd 
					set @m_fcval=0
					set @opstval='ضريبة القيمة المضافة'
					set @ch_cnt +=1
					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post,taxcatId )
					values (@m_cmp,@m_invtype,@m_ref,@lvat_rcvd_act,@hinvdate,@opstval,
					abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0,@ltaxcatId)	
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-15
						break
					end
--					
----------- For Cost center process
--
					if @lcaokcstctr=1 and isnull(@lcstctr,'')<>''
					begin
						insert into gljrcost (company,jdtype,jdref,cstcode,jdkey,jdcurr,Xpercent,amt,jddbcr
						,jdfc_imgval,jdfolno,rplct_post)
						values (@m_cmp,@m_invtype,@m_ref,@lcstctr,@lvat_rcvd_act,'',0,abs(@m_value),
						iif(@m_sign*@m_value<0,'C','D'),0,@ch_cnt,0)
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-21
							break
						end
					end
					if not(@lpricevattype>1 and @hvat_amt_rcvd>0  and @lvat_percent>0 ) --and @m_invtype='26'
						set @inv_lmtt=@inv_lmtt+Abs(@m_value)
					If @m_value<0
					begin
						set @l_crtot=@l_crtot+Abs(@m_value)	
						set @f_crtot=@f_crtot+Abs(@m_fcval)					
					end
					Else
					begin
						set @l_dbtot=@l_dbtot+Abs(@m_value)	
						set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
					End	
					
				end
				------  End of VAT process
------------------------------------------------------------------------------------
		-- *--- Update card payment (VISA ,MASTERCARD,...ETS)

				if @hccpayment<>0
				begin
					set @m_value=@hccpayment
					set @m_fcval=0
					set @opstval='مدفوعات بطائق الائتمان'
					set @ch_cnt +=1
					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
					values (@m_cmp,@m_invtype,@m_ref,@ldp_crdcardac,@hinvdate,@opstval,
					abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0)	
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-18
						break
					end

					If @m_value<0
					begin
						set @l_crtot=@l_crtot+Abs(@m_value)	
						set @f_crtot=@f_crtot+Abs(@m_fcval)					
					end
					Else
					begin
						set @l_dbtot=@l_dbtot+Abs(@m_value)	
						set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
					End	
				end  -- end of @hccpayment
		-- *--- Update Saned card payment (Charity Foundations)

				if @hsanedcrdamt<>0
				begin
					set @m_value=@hsanedcrdamt
					set @m_fcval=0
					set @opstval='مدفوعات بطائق ساند - جمعيات خيرية'
					set @ch_cnt +=1
					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
					values (@m_cmp,@m_invtype,@m_ref,@lsanedcrd_act,@hinvdate,@opstval,
					abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0)	
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-38
						break
					end

					If @m_value<0
					begin
						set @l_crtot=@l_crtot+Abs(@m_value)	
						set @f_crtot=@f_crtot+Abs(@m_fcval)					
					end
					Else
					begin
						set @l_dbtot=@l_dbtot+Abs(@m_value)	
						set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
					End	
				end  -- end of @hsanedcrdamt
				if @hrplsamt<>0
				begin
					set @m_value=@hrplsamt
					set @m_fcval=0
					set @opstval='مدفوعات مرتجعات الاستبدال'
					set @ch_cnt +=1
					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
					values (@m_cmp,@m_invtype,@m_ref,@ldp_rplsac,@hinvdate,@opstval,
					abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0)	
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-19
						break
					end

					If @m_value<0
					begin
						set @l_crtot=@l_crtot+Abs(@m_value)	
						set @f_crtot=@f_crtot+Abs(@m_fcval)					
					end
					Else
					begin
						set @l_dbtot=@l_dbtot+Abs(@m_value)	
						set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
					End	
				end -- end of @hrplsamt
				if @hprpaidamt<>0
				begin
					set @m_value=@hprpaidamt
					set @m_fcval=0
					set @opstval='مدفوعات بطائق مسبوقة الدفع'
					set @ch_cnt +=1
					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
					values (@m_cmp,@m_invtype,@m_ref,@lprpaidcrdac,@hinvdate,@opstval,
					abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0)	
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-20
						break
					end

					If @m_value<0
					begin
						set @l_crtot=@l_crtot+Abs(@m_value)	
						set @f_crtot=@f_crtot+Abs(@m_fcval)					
					end
					Else
					begin
						set @l_dbtot=@l_dbtot+Abs(@m_value)	
						set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
					End	
				end  -- end of @hprpaidamt
				if @arr_ptr>0
				begin
				    set @ttl_class_dsc=0
				    insert into @dsc_class_val 
                    SELECT substring(c.classkey,1,2) as classkey,sum((invdsvl/valafds)*(qty*(price-iif(No_round_nm=0,
					cast(price*dscprsnt/100 as int),(price*dscprsnt/100)))-offer_amt)) as dscclassamt
					from  (pos_hd inner Join pos_dt  
					on  pos_hd.company = pos_dt.company and pos_hd.Contr = pos_dt.Contr and pos_hd.ref = pos_dt.ref)
					left outer join (stunits b inner join stitems c on b.itemno=c.itemno) 
					on pos_dt.cmbkey=b.cmbkey
					where pos_hd.company=@m_cmp and pos_hd.slcenter=@lslcenter and invorrtrn=@linvorrtrn
					and PriceVatType=@lpricevattype and No_round_nm=@lno_round_nm
					And pos_hd.geninv=0  and invdsvl>0 And  not (RTRIM(pos_dt.cmbkey)='' Or RTRIM(pos_dt.barcode)='') and
					tdatetime  between @fm_datetime and @to_datetime
					group by substring(c.classkey,1,2);

					set @dsc_ptr=@@ROWCOUNT

					while @arr_ptr>0
					begin
					    set @cl_slser=''
						set @dscact=''
						set @cstcode=''
						set @m_vl=0
						select @cl_slser=act,@m_vl=lcamt,@clsname=clsname,@cstcode=cstcode,@dscact=dscact,@xclkey=clkey
						from @class_arr
						where p_ptr=@arr_ptr
						if isnull(@cl_slser,'')<>'' and isnull(@m_vl,0)<>0
						begin
							set @m_value=@m_vl
							set @m_fcval=0
							set @opstval='مبيعات قسم'+' '+rtrim(@clsname)
							set @ch_cnt +=1
							insert into gljrdtl 
							(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                            ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
							values (@m_cmp,@m_invtype,@m_ref,@cl_slser,@hinvdate,@opstval,
							abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0)	
							if @@error<>0
							begin
								rollback transaction
								set @errstatus=-21
								break
							end
							if @lcaokcstctr=1 and isnull(@cstcode,'')<>''
							begin
								insert into gljrcost (company,jdtype,jdref,cstcode,jdkey,jdcurr,Xpercent,amt,jddbcr
								,jdfc_imgval,jdfolno,rplct_post)
								values (@m_cmp,@m_invtype,@m_ref,@cstcode,@cl_slser,'',0,abs(@m_value),
								iif(@m_sign*@m_value<0,'C','D'),0,@ch_cnt,0)
								if @@error<>0
								begin
									rollback transaction
									set @errstatus=-21
									break
								end
							end
							If @m_value<0
							begin
								set @l_crtot=@l_crtot+Abs(@m_value)	
								set @f_crtot=@f_crtot+Abs(@m_fcval)					
							end
							Else
							begin
								set @l_dbtot=@l_dbtot+Abs(@m_value)	
								set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
							End	
--
-- Process the discount value on class level 
--
							if @dsc_ptr>0 
							if @dscact is not null and @dscact<>''
							begin
							   set @dscclassamt=0
							   
							   select @dscclassamt=dscclassamt from @dsc_class_val where classkey=@xclkey
							   if isnull(@dscclassamt,0)>0 
							   begin
							        set @ttl_class_dsc=@ttl_class_dsc+@dscclassamt
									set @m_value=@dscclassamt
									set @m_fcval=0
									set @opstval='خصومات مبيعات قسم'+' '+rtrim(@clsname)
									set @ch_cnt +=1
									insert into gljrdtl 
									(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
									,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
									values (@m_cmp,@m_invtype,@m_ref,@dscact,@hinvdate,@opstval,
									abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0)	
									if @@error<>0
									begin
										rollback transaction
										set @errstatus=-44
										break
									end
--					
----------- For Cost center process
--
									if @lcaokcstctr=1 and isnull(@cstcode,'')<>''
									begin
										insert into gljrcost (company,jdtype,jdref,cstcode,jdkey,jdcurr,Xpercent,amt,jddbcr
										,jdfc_imgval,jdfolno,rplct_post)
										values (@m_cmp,@m_invtype,@m_ref,@cstcode,@dscact,'',0,abs(@m_value),
										iif(@m_sign*@m_value<0,'C','D'),0,@ch_cnt,0)
										if @@error<>0
										begin
											rollback transaction
											set @errstatus=-45
											break
										end
									end
									If @m_value<0
									begin
										set @l_crtot=@l_crtot+Abs(@m_value)	
										set @f_crtot=@f_crtot+Abs(@m_fcval)					
									end
									Else
									begin
										set @l_dbtot=@l_dbtot+Abs(@m_value)	
										set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
									End	
							   end
							end  -- end of discount class process
						end
						set @arr_ptr-=1
					end  -- end of @arr_ptr loop
				end  -- end of @arr_ptr
				If @m_lccntr<>0 Or @m_fccntr<>0
				begin
					set @m_value=@m_lccntr
					if @lpricevattype>1 and @hvat_amt_rcvd>0  and @lvat_percent>0 
					begin
						 --if @m_invtype='26'
						 --begin
							set @m_value=-@hvalafds+@lvat_amt_rcvd
						 --end
						 set @inv_stk=@hvalafds
					end
					set @m_fcval=@m_fccntr
					set @opstval=@hcustnm
					set @ch_cnt +=1
					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
					values (@m_cmp,@m_invtype,@m_ref,@ldp_slser,@hinvdate,@opstval,
					abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0)	
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-22
						break
					end
--					
----------- For Cost center process
--
					if @lcaokcstctr=1 and isnull(@lcstctr,'')<>''
					begin
						insert into gljrcost (company,jdtype,jdref,cstcode,jdkey,jdcurr,Xpercent,amt,jddbcr
						,jdfc_imgval,jdfolno,rplct_post)
						values (@m_cmp,@m_invtype,@m_ref,@lcstctr,@ldp_slser,'',0,abs(@m_value),
						iif(@m_sign*@m_value<0,'C','D'),0,@ch_cnt,0)
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-21
							break
						end
					end
					If @m_value<0
					begin
						set @l_crtot=@l_crtot+Abs(@m_value)	
						set @f_crtot=@f_crtot+Abs(@m_fcval)					
					end
					Else
					begin
						set @l_dbtot=@l_dbtot+Abs(@m_value)	
						set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
					End	
				end  -- end of @m_lccntr

		-- to update discount from total inv-.force dept disc
				if dbo.value_balanced(@hinvdsvl,@ttl_class_dsc)=0 
				begin
					set @m_value=@hinvdsvl-@ttl_class_dsc
					set @m_fcval=0
					set @opstval='خصومات المبيعات النقدية'
					set @ch_cnt +=1
					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
					values (@m_cmp,@m_invtype,@m_ref,@ldp_expser,@hinvdate,@opstval,
					abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0)	
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-14
						break
					end
--					
----------- For Cost center process
--
					if @lcaokcstctr=1 and isnull(@lcstctr,'')<>''
					begin
						insert into gljrcost (company,jdtype,jdref,cstcode,jdkey,jdcurr,Xpercent,amt,jddbcr
						,jdfc_imgval,jdfolno,rplct_post)
						values (@m_cmp,@m_invtype,@m_ref,@lcstctr,@ldp_expser,'',0,abs(@m_value),
						iif(@m_sign*@m_value<0,'C','D'),0,@ch_cnt,0)
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-21
							break
						end
					end
					If @m_value<0
					begin
						set @l_crtot=@l_crtot+Abs(@m_value)	
						set @f_crtot=@f_crtot+Abs(@m_fcval)					
					end
					Else
					begin
						set @l_dbtot=@l_dbtot+Abs(@m_value)	
						set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
					End	
				end  -- end of @hinvdsvl
--
-- Process the Halal discount after the final total 
---
                if @lhlldscamt>0
				begin
					set @m_value=@lhlldscamt
					set @m_fcval=0
					set @opstval='خصومات الهلل من صافي الفاتورة'
					set @ch_cnt +=1
					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
					values (@m_cmp,@m_invtype,@m_ref,@ldp_expser,@hinvdate,@opstval,
					abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0)	
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-14
						break
					end
					If @m_value<0
					begin
						set @l_crtot=@l_crtot+Abs(@m_value)	
						set @f_crtot=@f_crtot+Abs(@m_fcval)					
					end
					Else
					begin
						set @l_dbtot=@l_dbtot+Abs(@m_value)	
						set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
					End	
				end

		--
		--  Finalize update accumalted variables in tables GLJRHDR , SALES_HD  , STHDR
		--
		-----------------Update gljrhdr

				if @hinvttl<>0
				begin
					update gljrhdr set jhfcflag=iif(@fc_to_lc_ttl>0,1,2),jhentries=@ch_cnt,jhlccrttl = @l_crtot,
					jhfccrttl= @f_crtot,jhlcdbttl = @l_dbtot,jhfcdbttl = @f_dbtot,
					jhamt = Iif(@inv_lmtt>@l_dbtot,@inv_lmtt,@l_dbtot) where jhcomp=@m_cmp and jhtype=@m_invtype and
					jhref=@m_ref
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-23
						break
					end
				end
		--------- Update sthdr
				If @lstptr>0
				begin
					update sthdr set entries=@lstptr,amnttl = @inv_stk,costttl = @xttl_cost where branch=@m_cmp 
					and trtype=@m_invtype and ref=@m_ref
				end
				else  delete from sthdr where branch=@m_cmp and trtype=@m_invtype and ref=@m_ref
				if @@error<>0
				begin
					rollback transaction
					set @errstatus=-24
					break
				end
---------------------------------------------------------------------------------------------------
-------  Process the JV الجرد المستمر 
-----     
                set @gl_mref=0
                if @lcntstkon=1
				begin
		--
		-- Insert One Record in GLJRHR
		--
		            
					
					
					set @ljhfcflag=2
					set @hcustnm='تكلفة المبيعات لفاتورة رقم '+@m_invtype+'/'+str(@m_ref)
					set @hinvdate=replace(@grdate,'-','')
					
					set @gl_mref=dbo.get_last_ref('17',@m_cmp)
					update stbranch set jv_17=@gl_mref+1 where brnno=@m_cmp
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-9
						break
					end
				
					insert into gljrhdr (jhcomp,jhtype,jhref,jhcurr,jhamt,jhdate,jhrate,jhtext,jhsrc,jhfcflag,jhreleased,jhposted,
					jhsysdate,modified,[Suspend],usrid,lastupdt,rcvdtrn,isbrtrx,brxref,brxfrm,jhcustno,jhentries,jhlccrttl,
					jhfccrttl,jhlcdbttl,jhfcdbttl) 
					values (@m_cmp,'17',@gl_mref,'',@xttl_cost,@hinvdate,0,@hcustnm,'05',
					@ljhfcflag,0,0,@ltdate,1,0,@p_username,@ltdate,@replication,0,'','','',2,@xttl_cost,0,@xttl_cost,0)
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-26
						break
					end  
--
--  insert on gljrdtl				          			  
--  Entry One
                    set @ldbcr=iif(@m_invtype='06','D','C')
					set @m_value=@xttl_cost
					set @m_fcval=0
					set @opstval=@hcustnm
					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
							 ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
					values (@m_cmp,'17',@gl_mref,@lsrcst,@hinvdate,@opstval,
					abs(@m_value),@ldbcr,0,'',1,1,@ltdate,'05',0,0,'','','',0,0,0)	
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-21
						break
					end
-- Entry Two
--					
----------- For Cost center process
--
					if @lcaokcstctr=1 and isnull(@lcstctr,'')<>''
					begin
						insert into gljrcost (company,jdtype,jdref,cstcode,jdkey,jdcurr,Xpercent,amt,jddbcr
						,jdfc_imgval,jdfolno,rplct_post)
						values (@m_cmp,'17',@gl_mref,@lcstctr,@lsrcst,'',0,abs(@m_value),
						@ldbcr,0,1,0)
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-21
							break
						end
					end

					set @ldbcr=iif(@m_invtype='06','C','D')

					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
							 ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
					values (@m_cmp,'17',@gl_mref,@ldp_diffser,@hinvdate,@opstval,
					abs(@m_value),@ldbcr,0,'',2,2,@ltdate,'05',0,0,'','','',0,0,0)	
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-21
						break
					end									    
				end
-----------------------------------------------------------------------------------------------------------------------
		--    Update sales_hd
				update sales_hd set entries=@lslptr,valafds = @lttl_inv,invttl=@lttl_inv+@hextamt+iif(@lpricevattype=1,@hvat_amt_rcvd,0) ,invcst=@xttl_cost,
				stkjvno=@gl_mref
				where company=@m_cmp and invtype=@m_invtype and ref=@m_ref
				if @@error<>0
				begin
					rollback transaction
					set @errstatus=-25
					break
				end

			end  --- end of invorrtrn<>'4' -----------------------------------------
			else
			begin
		--
		-- Insert One Record in GLJRHR
		--
				set @ljhfcflag=2
				set @hcustnm='مدفوعات نقدية للعملاء'
				set @hinvdate=replace(@grdate,'-','')
				set @m_invtype='01'
				set @m_ref=dbo.get_last_ref('01',@m_cmp)
				update stbranch set jv_01=@m_ref+1 where brnno=@m_cmp
			    if @@error<>0
				begin
					rollback transaction
					set @errstatus=-9
					break
				end
				set @hinvttl=@lvalafds-@linvdsvl+iif(@lpricevattype=1,@lvat_amt_rcvd,0)-@lhlldscamt
				insert into gljrhdr (jhcomp,jhtype,jhref,jhcurr,jhamt,jhdate,jhrate,jhtext,jhsrc,jhfcflag,jhreleased,jhposted,
				jhsysdate,modified,[Suspend],usrid,lastupdt,rcvdtrn,isbrtrx,brxref,brxfrm,jhcustno,jhentries,jhlccrttl,
				jhfccrttl,jhlcdbttl,jhfcdbttl) 
				values (@m_cmp,@m_invtype,@m_ref,'',@hinvttl,@hinvdate,0,@hcustnm,'01',
				@ljhfcflag,0,0,@ltdate,1,0,@p_username,@ltdate,@replication,0,'05','','',2,@hinvttl,0,@hinvttl,0)
				if @@error<>0
				begin
					rollback transaction
					set @errstatus=-26
					break
				end  
--
--  insert on gljrdtl				          			  
--  Entry One
				set @m_value=@hinvttl
				set @m_fcval=0
				set @opstval='صرف نقدي لمبيعات مرتجعه'
				insert into gljrdtl 
				(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
				values (@m_cmp,@m_invtype,@m_ref,@ldp_cashser,@hinvdate,@opstval,
				abs(@m_value),'C',0,'',1,1,@ltdate,'01',0,0,'','','',0,0,0)	
				if @@error<>0
				begin
					rollback transaction
					set @errstatus=-21
					break
				end
-- Entry Two


				set @opstval='مبالغ مرتجعه للعملاء بدل استبدال'

				insert into gljrdtl 
				(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
				values (@m_cmp,@m_invtype,@m_ref,@ldp_rplsac,@hinvdate,@opstval,
				abs(@m_value),'D',0,'',2,2,@ltdate,'01',0,0,'','','',0,0,0)	
				if @@error<>0
				begin
					rollback transaction
					set @errstatus=-21
					break
				end
			end
			delete from @class_arr
			delete from @dsc_class_val
	 
--------------------------------   Process charity donations  ------------------------------------------------------
			if  @linvorrtrn='1' and 
			exists(SELECT table_name  FROM INFORMATION_SCHEMA.tables  with (NOLOCK) WHERE TABLE_NAME ='poschrtinv')
			begin
				select @donation_amt=sum(poschrtinv.hllamt) 
				from pos_hd inner join poschrtinv 					
				on pos_hd.company=poschrtinv.company and pos_hd.contr=poschrtinv.contr and pos_hd.ref=poschrtinv.ref
				where pos_hd.company=@m_cmp and tdatetime  between @fm_datetime and @to_datetime
				And geninv=0 and invorrtrn='1' and pos_hd.slcenter=@lslcenter and 
				PriceVatType=@lpricevattype and No_round_nm=@lno_round_nm
				and poschrtinv.hllamt>0

				set @donation_amt=isnull(@donation_amt,0)	  										
				if @donation_amt>0
				begin
						set @opstval='تبرعات نقدية مستلمة لصالح الجمعيات الخيرية'
		--
		-- Insert One Record in GLJRHR
		--
		                set @gl_mref=0
						set @ch_cnt  =0
						set @ljhfcflag=2
						set @hcustnm='تبرعات نقدية مستلمة لصالح الجمعيات الخيرية'
						set @hinvdate=replace(@grdate,'-','')
						set @m_invtype='01'
						set @gl_mref=dbo.get_last_ref('01',@m_cmp)
						update stbranch set jv_01=@gl_mref+1 where brnno=@m_cmp
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-9
							break
						end
						
						insert into gljrhdr (jhcomp,jhtype,jhref,jhcurr,jhamt,jhdate,jhrate,jhtext,jhsrc,jhfcflag,jhreleased,jhposted,
						jhsysdate,modified,[Suspend],usrid,lastupdt,rcvdtrn,isbrtrx,brxref,brxfrm,jhcustno,jhentries,jhlccrttl,
						jhfccrttl,jhlcdbttl,jhfcdbttl) 
						values (@m_cmp,@m_invtype,@gl_mref,'',@donation_amt,@hinvdate,0,@hcustnm,'05',
						@ljhfcflag,0,0,@ltdate,1,0,@p_username,@ltdate,@replication,0,'','SL','',2,@donation_amt,0,@donation_amt,0)
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-26
							break
						end  
 
			--
			-- Process GLJRDTL entries
			--
						set @ch_cnt +=1
						set @m_value=@donation_amt
						set @m_fcval=0
						insert into gljrdtl 
						(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
							,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
						values (@m_cmp,'01',@gl_mref,@hcaser,@hinvdate,@opstval,
						abs(@donation_amt),'D',0,'',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0)	
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-12
							break
						end

						DECLARE lposchrtinv CURSOR LOCAL FAST_FORWARD FOR
						select lhllamt=sum(poschrtinv.hllamt) ,pos_chrt.chrcode,chacct,pos_chrt.chname
						from pos_hd inner join poschrtinv inner join pos_chrt 
						on poschrtinv.company=pos_chrt.company and poschrtinv.chrcode=pos_chrt.chrcode
						on pos_hd.company=poschrtinv.company and pos_hd.contr=poschrtinv.contr and pos_hd.ref=poschrtinv.ref
						where pos_hd.company=@m_cmp and tdatetime  between @fm_datetime and @to_datetime
						And geninv=0 and invorrtrn='1' and pos_hd.slcenter=@lslcenter and
						PriceVatType=@lpricevattype and No_round_nm=@lno_round_nm
						and poschrtinv.hllamt>0
						group by pos_chrt.chrcode,chacct,pos_chrt.chname

						open lposchrtinv;
						fetch next from lposchrtinv into @lhll_amt,@lchrcode,@lchacct,@lchname
			 			WHILE dbo.FetchStatusOfCursorNamed('lposchrtinv') = 0 
						begin
							set @m_value=@lhll_amt
							set @m_fcval=0
							set @opstval='تبرع لصالح'+' '+@lchname

							set @ch_cnt +=1
					
							insert into gljrdtl 
							(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
							,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
							values (@m_cmp,'01',@gl_mref,@lchacct,@hinvdate,@opstval,
							abs(@m_value),'C',0,' ',@ch_cnt,@ch_cnt,@ltdate,'05',0,0,'','','',0,0,0)	
							if @@error<>0
							begin
								rollback transaction
								set @errstatus=-13
								break
							end

							fetch next from lposchrtinv into @lhll_amt,@lchrcode,@lchacct,@lchname
						end  -- end of loop lposchrtinv
						close lposchrtinv
						deallocate lposchrtinv
						if @errstatus<0 
						break

		--    Update sales_hd
						update sales_hd set rtnref=@gl_mref
						where company=@m_cmp and invtype='06' and ref=@m_ref
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-25
							break
						end
		--    Update gljrhdr
						update gljrhdr set jhentries=@ch_cnt,brxref=ltrim(str(@m_ref,6)) where jhcomp=@m_cmp and jhtype='01' and
						jhref=@gl_mref
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-23
							break
						end					
				end -- end of @donation_amt
			end  -------- end of @syscode=6 or @lno_round_nm=1
--------------------------------------------------------------------------------------------------------------------		
--
----  Update POS_HD 
--
            
			Update pos_hd Set geninv =@m_ref where company=@m_cmp and slcenter=@lslcenter and
			PriceVatType=@lpricevattype and No_round_nm=@lno_round_nm
			and invorrtrn=@linvorrtrn	And pos_hd.geninv=0  and tdatetime  between @fm_datetime and @to_datetime
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-27
				break
			end	
			 
			IF @errstatus=0 
			begin
			   COMMIT TRANSACTION
			   set @no_of_gen_inv +=1
			end

			fetch next from pogen1 into @lslcenter,@linvorrtrn,@lentries,@linvttl,@linvcst,@linvdsvl,@lvalafds,
			@lfcamt,@lprpaid,@lcash,@lccpayment,@lcharges,@lcccommision,@lcsanedcrdamt,@lvat_amt_rcvd,
			@ltaxfree_sales,@lhlldscamt,@lpricevattype,@lno_round_nm;

			set @arr_ptr=0
		end -- end of outer loop
		close pogen1
		deallocate pogen1
        return @errstatus			 
end
	--















GO
/****** Object:  StoredProcedure [dbo].[get_actexpenses_and_purchase]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2025-01-09@@$$##  Important : must have this line as first line which contains the last update date for the this file 
create PROCEDURE [dbo].[get_actexpenses_and_purchase]
 @lfmdate varchar(8),
 @ltodate varchar(8),
 @expense_amt float output,
 @purchase_amt float output
AS
BEGIN

------ Added on 2025-01-07 AA for dashboard 
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
	declare @ac_level int=0
	set @ac_level=@expense_amt

	set @expense_amt=0
	set @purchase_amt=0
--- To get the accounts expenses
	select @expense_amt= sum(case when jddbcr='D' then jdlcamt else -jdlcamt end)
	from glchart inner join gljrdtl inner join gljrhdr 
	on jdcomp=jhcomp and jdtype=jhtype and jdref = jhref 
	on glchart.glkey=gljrdtl.jdkey and glchart.glcurrency = gljrdtl.jdcurr
	where actlvl=@ac_level and glgroup='6' and jhdate between @lfmdate and @ltodate;
	set @expense_amt=isnull(@expense_amt,0)
---- To get the purchase amount
	select @purchase_amt=sum(iif(invtype in ('10','11'),invcst,-invcst)) from puhdr where invdate between @lfmdate and @ltodate;
	set @purchase_amt=isnull(@purchase_amt,0)
end
GO
/****** Object:  StoredProcedure [dbo].[get_ar_ap_bal]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2025-01-08@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[get_ar_ap_bal]
 @lfmdate varchar(8),
 @ltodate varchar(8),
 @is_ar bit
AS
BEGIN

------ Added on 2025-01-05 AA for dashboard 
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
	if @is_ar=1
	begin
		;with aropenbal as
		(select cf_fcy as fcy,curname,lc_openbal=sum(cu_opnbal),fc_openbal=sum(cf_opnfcy)  from customer a left outer join  glcurr b
		on a.cf_fcy=b.curcode 
		where cu_onlycsh=0
		group by cf_fcy,curname)

		, artrxbal as
		(select dt_fcy as fcy,
		lc_trxbal= sum(case when dt_dbcr='D' then isnull(dt_lcamt,0)-isnull(dt_paidamt,0)-isnull(dt_discamt,0)
		else -(isnull(dt_lcamt,0)-isnull(dt_paidamt,0)-isnull(dt_discamt,0)) end),
		fc_trxbal= sum(case when dt_dbcr='D' then (isnull(dt_fcamt,0)-isnull(dt_fpydamt,0)-isnull(dt_fdscamt,0)) 
		else -(isnull(dt_fcamt,0)-isnull(dt_fpydamt,0)-isnull(dt_fdscamt,0)) end)
		from customer a inner join ardtl inner join arhdr 
		on dt_company=hd_company and dt_type=hd_type and dt_ref = hd_ref 
		on a.cu_company=ardtl.dt_company and a.cu_code = ardtl.dt_cucode and a.cf_fcy=ardtl.dt_fcy
		where cu_onlycsh=0 and dt_date between @lfmdate and @ltodate
		group by dt_fcy)

		select a.fcy,isnull(a.curname,'') as fcyname,sum(isnull(lc_trxbal,0)+lc_openbal) as lc_bal,sum(isnull(fc_trxbal,0)+fc_openbal) as fc_bal 
		from aropenbal a left outer join artrxbal b
		on a.fcy=b.fcy 
		group by a.fcy,isnull(a.curname,'');		
	end
	else
	begin
		;with apopenbal as
		(select cf_fcy as fcy,curname,lc_openbal=sum(cu_opnbal),fc_openbal=sum(cf_opnfcy)  from supplier a left outer join  glcurr b
		on a.cf_fcy=b.curcode 
		group by cf_fcy,curname)

		, aptrxbal as
		(select dt_fcy as fcy,
		lc_trxbal= sum(case when dt_dbcr='D' then isnull(dt_lcamt,0)-isnull(dt_paidamt,0)-isnull(dt_discamt,0)
		else -(isnull(dt_lcamt,0)-isnull(dt_paidamt,0)-isnull(dt_discamt,0)) end),
		fc_trxbal= sum(case when dt_dbcr='D' then (isnull(dt_fcamt,0)-isnull(dt_fpydamt,0)-isnull(dt_fdscamt,0)) 
		else -(isnull(dt_fcamt,0)-isnull(dt_fpydamt,0)-isnull(dt_fdscamt,0)) end)
		from supplier a inner join apdtl inner join aphdr 
		on dt_company=hd_company and dt_type=hd_type and dt_ref = hd_ref 
		on a.cu_company=apdtl.dt_company and a.cu_code = apdtl.dt_cucode and a.cf_fcy=apdtl.dt_fcy
		where len(dt_cucode)>0 and dt_date between @lfmdate and @ltodate
		group by dt_fcy)

		select a.fcy,isnull(a.curname,'') as fcyname,sum(isnull(lc_trxbal,0)+lc_openbal) as lc_bal,sum(isnull(fc_trxbal,0)+fc_openbal) as fc_bal 
		from apopenbal a left outer join aptrxbal b
		on a.fcy=b.fcy 
		group by a.fcy,isnull(a.curname,'');	  
	end
end
GO
/****** Object:  StoredProcedure [dbo].[get_branch_bal]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2022-05-16@@$$##  Important : must have this line as first line which contains the last update date for the this file 
------  Added on 2022-03-21 AA --------
CREATE PROCEDURE [dbo].[get_branch_bal]

 @l_company char(2),
 @l_fcy char(3),
 @l_all bit,
 @l_curbal   float =0 output 
 
	
AS
BEGIN
	declare @open_bal float =0,
        @trx_bal float =0

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	if @l_all=1
	begin
	    select @open_bal=sum(cu_opnbal) from customer with (NOLOCK) where cu_company=@l_company ;

		select @trx_bal=sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt-dt_paidamt,-(dt_lcamt-dt_discamt-dt_paidamt))) 
		from arhdr with (NOLOCK) inner join 
			ardtl on hd_company=dt_company and hd_type=dt_type and hd_ref=dt_ref 
			inner join customer c on dt_company=cu_company and dt_cucode=cu_code and dt_fcy=cf_fcy
			where dt_company=@l_company ;
	end
	else
	begin
		if RTRIM(@l_fcy)=''
			select @open_bal=sum(cu_opnbal) from customer with (NOLOCK) where cu_company=@l_company  and cf_fcy=@l_fcy;
		else
			select @open_bal=sum(cf_opnfcy) from customer with (NOLOCK) where cu_company=@l_company  and cf_fcy=@l_fcy;


		if RTRIM(@l_fcy)=''
		begin
			select @trx_bal=sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt-dt_paidamt,-(dt_lcamt-dt_discamt-dt_paidamt))) 
			from arhdr with (NOLOCK) inner join 
				ardtl on hd_company=dt_company and hd_type=dt_type and hd_ref=dt_ref 
				inner join customer c on dt_company=cu_company and dt_cucode=cu_code and dt_fcy=cf_fcy
				where dt_company=@l_company and dt_fcy=@l_fcy;
		end
		else
		begin
			select @trx_bal=sum(iif(dt_dbcr='D',dt_fcamt-dt_fdscamt-dt_fpydamt,-(dt_fcamt-dt_fdscamt-dt_fpydamt))) 
			from arhdr with (NOLOCK) inner join 
				ardtl on hd_company=dt_company and hd_type=dt_type and hd_ref=dt_ref 
				inner join customer c on dt_company=cu_company and dt_cucode=cu_code and dt_fcy=cf_fcy
				where dt_company=@l_company and dt_fcy=@l_fcy;
		end
    end  
	set @l_curbal=isnull(@open_bal,0)+isnull(@trx_bal,0)
END




GO
/****** Object:  StoredProcedure [dbo].[get_branch_item_avrege_cost]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[get_branch_item_avrege_cost]
 @lbranch char(2),
 @litemno char(16),
 @lunicode char(6),
 @llcost  float = 0 output, 
 @lfcost float = 0 output
 	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
	declare  @vlcost  float = 0 ,
	@vfcost float = 0 ,
	@vbal numeric(14,3) = 0 
    --
	-- Initialize parameters variables
	--
	set @llcost=0.00
	set @lfcost=0.00	
		
	select @vbal=sum(isnull(qty,0)),@vlcost=sum(lcost*qty),@vfcost=sum(isnull(fcost,0)*qty)
	from stbins with (NOLOCK) 
	where branch=@lbranch and itemno=@litemno and unicode=@lunicode
	if @@rowcount>0
	begin
		if @vbal<>0 
		begin
 			set @llcost=abs(@vlcost/@vbal)
			set @lfcost=abs(@vfcost/@vbal)
		end 
	end	
end













GO
/****** Object:  StoredProcedure [dbo].[get_cardtype_4_bal]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-01-07@@$$##  Important : must have this line as first line which contains the last update date for the this file 
create  PROCEDURE [dbo].[get_cardtype_4_bal]
 @lcomp char(2), -- when @lcomp='' , this means the card is on company level
 @lcard char(20),
 @cardbal float=0 output ,
 @errstatus int =0 output
AS
BEGIN
    --
	-- Added on 2023-12-20 to rebuild the balance cardtype 4 on branch level or company level  
	SET NOCOUNT ON
    declare @netrcv float=0,
         @lmnthbal float=0,
		 @lmnth_target float=0,
		 @netsales float=0

     set @errstatus=0
	 if len(@lcomp)>0
	 begin
		 select @lmnth_target=mnth_target,@lmnthbal=isnull(mnthbal,0) from pos_dsc (nolock) where dsccompany=@lcomp and dsccard=@lcard and cardtype=4;

		 Select @netrcv=Sum(b.lcamt) From pos_chhd a (nolock) inner Join pos_chdt b (nolock)
				 On  a.company=b.company and a.ref=b.ref
				 Where  b.company=@lcomp and b.cstcode=@lcard and a.posted=1; 

		  Select @netsales=Sum(Iif(invorrtrn='1',b.prepaidamt,-b.prepaidamt)) 
				From pos_hd a (nolock) inner join posppcard b (nolock) on a.company=b.company and a.contr=b.contr and a.ref=b.ref
				where  a.company=@lcomp and b.disccard=@lcard and invorrtrn  in ('1','3') and b.paytype=4 ;
	  
		  set @cardbal=	@lmnthbal + isnull(@netrcv,0) - isnull(@netsales,0)	

		  if dbo.value_balanced(@lmnth_target,@cardbal)=0
		  begin
				begin transaction
				update pos_dsc set mnth_target=@cardbal where dsccompany=@lcomp and dsccard=@lcard and cardtype=4;
				if @@error<>0 
				begin		  
					rollback transaction
					set @errstatus=-2
					return 
				end
				commit transaction
				set @errstatus=-1
		  end
	  end
	  else
	  begin
		 select @lmnth_target=mnth_target,@lmnthbal=isnull(mnthbal,0) from pos_dsc (nolock) where  dsccard=@lcard and cardtype=4;

		 Select @netrcv=Sum(b.lcamt) From pos_chhd a (nolock) inner Join pos_chdt b (nolock)
				 On  a.company=b.company and a.ref=b.ref
				 Where  b.cstcode=@lcard and a.posted=1; 

		  Select @netsales=Sum(Iif(invorrtrn='1',b.prepaidamt,-b.prepaidamt)) 
				From pos_hd a (nolock) inner join posppcard b (nolock) on a.company=b.company and a.contr=b.contr and a.ref=b.ref
				where  b.disccard=@lcard and invorrtrn  in ('1','3') and b.paytype=4 ;
	  
		  set @cardbal=	@lmnthbal + isnull(@netrcv,0) - isnull(@netsales,0)	

		  if dbo.value_balanced(@lmnth_target,@cardbal)=0
		  begin
				begin transaction
				update pos_dsc set mnth_target=@cardbal where dsccard=@lcard and cardtype=4;
				if @@error<>0 
				begin		  
					rollback transaction
					set @errstatus=-2
					return 
				end
				commit transaction
				set @errstatus=-1
		  end
	  end
end


GO
/****** Object:  StoredProcedure [dbo].[GET_cash_deserve]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-10-01@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCedure [dbo].[GET_cash_deserve]
@lcompany char(2) output,
@rplcntr numeric(4,0) output,
@rplref numeric(8,0) output,
@lttl_rtncshamt float output,  -- use to pass the invttl of rpls invoice if the org invoice exist in last year
@slinvlist varchar(200) output, -- The list Consist of: company contr ref rtnamount  ttlcash/contr ref rtnamount  ttlcash/..... 
@status int output,   -- I will use it as Input & output : when it has 1 then it means that the process will be done
                     -- in the previous Year and i should skip reading 
                     -- Rpls invoice for the first time  in the loop only. 
----------------  New added by awad on 2017-01-10  --------------------------------------
@lttl_charity float=0 output,
----------------  New added by awad on 2019-08-20  --------------------------------------
-- This will fix the the bug of the cash returned if they are using paytype=5 for card
@ppcardlist varchar(200) output -- The list Consist of: contr ref disccard prepaidamt paycard prepaid_rtn /contr ref disccard
---------------------------- End of Addtion  -------------------------------------------

AS
BEGIN
SET NOCOUNT ON
--- 2024-10-01 AA Defined new varibale @lrtn_saned_amt for Manafith process
--- 2023-10-14 AA dDefined new varibales for installment process
--- 2022-06-08 AA Added @lcompany+' '+ to @slinvlist
--- 2022-06-08 AA changed the value of @linv_max_elapsed variable to be iif(@linvdate is null,datediff(d,invdate,getdate()),datediff(d,invdate,@linvdate))
--- 2022-06-08 AA Assign @linvdate=invdate for the rpl returned invoice
--- 2022-06-08 AA changed the type of @linvdate to date & initialized it to null in beginning of while loop
--- 2022-05-07 AA Added semi colon for each select 
--- 2021-04-21 AA if the returned invoice does not exist @lcompany<>@lorgcompany then search again using @lorgcompany  
--- Modified 2021-03-19 added to the GET_cash_deserve_pass2 output for company,contr, ref
--- Modified 2020-10-20 I modified if @lttl_charity>0 to if len(@ppcardlist2)>0
--- Added 2020-10-18 if @lcktype=9 set @lcompany=@lfmbranch
-- Added on 2020-05-13 when frc_rtncash in on  return status as true 0
-- Added on 2020-03-08 to handle the invoice in the Head Office or last year
--- Modified on 2019-08-20 
declare @lcntr numeric(4,0),
        @lref numeric(8,0),
		@linvttl float=0,
        @lrtncshamt float=0,
		@alwamtrtn float=0,
		@linvcst float,
		@sndamt float=0,
		@prpdamt float=0,
		@lcashamt float=0,
		@lccpaid float=0,
		@current_cash float=0,
		@orginvcst float=0,
		@tmpinvcst float=0,
		@linvorrtrn char(1)='',
		@lvchramt float=0,
		@linvdate date, --char(8) Changed on 2022-06-08 AA
		@linv_max_elapsed int=0,
		@lMax_days_allowed int=0,
		@l_ptr  int=0,
		@rplcntr2 int=0,
		@rplref2 int=0,
		@l_rows int=0,
		@skip_read_rpls bit=0,
		@l_rowsrpl int=0,
		@lstcpay_amt float=0, --- Added on 2019-04-08
		@lqitaf_amt float=0 ,  --- Added on 2019-04-08
		@lfrc_rtncash bit =0   --- Added on 2020-05-13
---- Those used for second pass
declare @lttl_rtncshamt2 float=0,
        @status2 int =0  , 
		@slinvlist2 varchar(200),
		@tmpinvcst2 float=0 ,
		@errfound int=0,
		@lttl_charity2 float=0,
		@lhlldscamt numeric(10,3)=0,
		@lcharity_rpls float=0
------ Added on 2019-08-20--------------------------
        declare @ppcard varchar(20),
                @ppamt float,
				@pppaycard varchar(20),
				@ppamt_rtn float,
				@pppaytype int,
		        @ppcardlist2 varchar(200) ,
				@pp_lptr int=0

------ Added on 2020-03-08--------------------------
		declare @lcktype int,
		        @lfmbranch char(2)
------ Added on 2021-04-21--------------------------
		declare @lorgcompany char(2)
		 set @lorgcompany=@lcompany
----------------------------------------------------
				set @ppcardlist=''
------ End of addition on 2019-08-20
------ Added on 2024-10-01 AA for Manafith
       declare @lrtn_saned_amt float
------------------------------------------
------ Added on 2023-10-14 AA for installment
       declare @linstallment_amt float,
	           @lrtn_instlmnt_amt float
------  Inialize vars
		
		set @linvttl=@lttl_rtncshamt
        set @lttl_rtncshamt=0
		set @skip_read_rpls=@status
		set @status=0
		set @slinvlist=''
		set @ppcardlist2='' --- Added on 2019-08-20
		set @rplcntr2=@rplcntr
		set @rplref2=@rplref
		set @lcktype=0
		set @lfmbranch=''
		set @linstallment_amt=0  --Added on 2023-10-14 AA for installment
		set @lrtn_instlmnt_amt=0 --Added on 2023-10-14 AA for installment
		set @lrtn_saned_amt=0  -- Added on 2024-10-01 AA for Manafith

		while @rplref2<>0 and @l_ptr<10
		begin
		    set @l_ptr =@l_ptr+1
			set @l_rowsrpl=0
			set @linvdate=null --Added on 2022-06-08 AA
			-- Added on 2020-03-08
			set @lcktype=0
			set @lfmbranch=''
			set @lfrc_rtncash=0
			set @lcharity_rpls=0     -- Added on 2024-10-01 AA
			set @lrtn_saned_amt=0    -- Added on 2024-10-01 AA for Manafith
			set @lrtn_instlmnt_amt=0 -- Added on 2024-10-01 AA
--- Read the Replaced Invoice
            if @skip_read_rpls=1 and @l_ptr=1
			begin
			   set @lcntr=@rplcntr2
			   set @lref=@rplref2
			   set @linvorrtrn='2'
			   set @lvchramt=0
			   set @l_rowsrpl=1
			end
			else
			begin
---  To get the Ref & contr of the sales invoice connected with the returned sales invoice
---  and keep them in @lcntr @lref
			    set @linvttl=0
				set @lvchramt=0

				select @lcntr=salctrno,@lref=salinvno,@linvttl=invttl-isnull(hlldscnt,0),@linvorrtrn=invorrtrn,
				@lvchramt=isnull(dfvchramt,0.00),@lcharity_rpls=isnull(prepaidamt,0),
				@lcktype=cktype,@lfmbranch=fmbranch ,-- Added on 2020-03-08 
				@lfrc_rtncash=isnull(frc_rtncash,0), -- Added on 2020-05-13
				@linvdate=invdate, --Added on 2022-06-08 AA
				@lrtn_instlmnt_amt=isnull(installment_amt,0) -- Added on 2023-10-14 AA for installment
				,@lrtn_saned_amt=isnull(saned_amt,0) -- Added on 2024-10-01 AA for Manafith
				from pos_hd where company=@lcompany and contr=@rplcntr2 and ref=@rplref2;
				set @l_rowsrpl=@@ROWCOUNT
--------------- Added on 2021-04-21 ---------------------------------------
				if @l_rowsrpl=0 and @lcompany<>@lorgcompany --and @l_ptr>1
				begin
				    set @lcompany=@lorgcompany
					select @lcntr=salctrno,@lref=salinvno,@linvttl=invttl-isnull(hlldscnt,0),@linvorrtrn=invorrtrn,
					@lvchramt=isnull(dfvchramt,0.00),@lcharity_rpls=isnull(prepaidamt,0),
					@lcktype=cktype,@lfmbranch=fmbranch ,-- Added on 2020-03-08 
					@lfrc_rtncash=isnull(frc_rtncash,0), -- Added on 2020-05-13
					@linvdate=invdate, --Added on 2022-06-08 AA
					@lrtn_instlmnt_amt=isnull(installment_amt,0) -- Added on 2023-10-14 AA for installment
					,@lrtn_saned_amt=isnull(saned_amt,0) -- Added on 2024-10-01 AA for Manafith
					from pos_hd where company=@lcompany and contr=@rplcntr2 and ref=@rplref2;
					set @l_rowsrpl=@@ROWCOUNT
				end
----------------------------------------------------------------------------
			end
			if @l_rowsrpl>0
			begin
			    if @linvorrtrn in ('1','4')
				begin
				    set @lcntr=@rplcntr2
				    set @lref=@rplref2
					if @l_ptr=1 set @orginvcst=@lvchramt
				end
				else
				begin
				  if @l_ptr=1 set @orginvcst=@linvttl
				  set @lttl_charity=@lttl_charity-@lcharity_rpls
				     -isnull(@lrtn_instlmnt_amt,0)-isnull(@lrtn_saned_amt,0); -- Added on 2024-10-01 AA
				end

------ Here Read the sales invoice against the replaced invoice
                set @prpdamt=0
				set @sndamt=0
				set @lcashamt=0
				set @linvcst=0
				set @lccpaid=0
				set @linvttl=0
				set @lrtncshamt=0
				set @linv_max_elapsed=0
				--- Added on 2019-04-08 
				set @lstcpay_amt=0
				set @lqitaf_amt=0
				if @lcktype=9 set @lcompany=@lfmbranch -- Added on 2020-10-18
				select @prpdamt=isnull(prepaidamt,0.00),@sndamt=isnull(saned_amt,0.00),@lcashamt=isnull(cashamt,0.00),
				@linvcst=isnull(invcst,0.00),@lccpaid=isnull(ccpaid,0.00),@linvttl=isnull(invttl,0.00)-isnull(hlldscnt,0),
				@lrtncshamt=isnull(rtncshamt,0.00),
				@lstcpay_amt=isnull(a.stcpay_amt,0.00),@lqitaf_amt=isnull(qitaf_amt,0.00), --- Added on 2019-04-08
				@linv_max_elapsed=iif(@linvdate is null,datediff(d,invdate,getdate()),datediff(d,invdate,@linvdate)), --Added on 2022-06-08 AA
				@linstallment_amt=isnull(a.installment_amt,0) -- Added on 2023-10-14 AA for installment
				from pos_hd a
				where a.company=@lcompany and a.contr=@lcntr and a.ref=@lref;

				------ Added on 2020-03-08--------------------------
				if @@ROWCOUNT=0 
				begin
					set @rplcntr=@lcntr
					set @rplref=@lref
					if @lcktype=9
					begin
							set @status=-2  --- Sales invoice is available in HO
							set @lcompany=@lfmbranch
					end
					else 
						if @lfrc_rtncash=1 set @status=0 -- Added on 2020-05-13
						else set @status=-1  --- Sales invoice is available in the previous year
					break
				end
----------------  New added by awad on 2017-01-10  --------------------------------------
                set @linvcst=isnull(@linvcst,0)
				set @prpdamt=isnull(@prpdamt,0)
				set @sndamt=isnull(@sndamt,0)
				set @lcashamt=isnull(@lcashamt,0)
				set @lccpaid=isnull(@lccpaid,0)
				set @lrtncshamt=isnull(@lrtncshamt,0)
				set @linvttl=isnull(@linvttl,0.00)
				--- Added on 2019-04-08
				set @lstcpay_amt=isnull(@lstcpay_amt,0.00)
				set @lqitaf_amt=isnull(@lqitaf_amt,0.00)

				set @linstallment_amt=isnull(@linstallment_amt,0.00) -- Added on 2023-10-14 AA for installment

				if @linvorrtrn='4' set @linvcst=@lvchramt

				
			 	set @lttl_charity=@lttl_charity+@prpdamt+@sndamt+@linstallment_amt -- Added on 2023-10-14 AA for installment
				set @current_cash=@lcashamt+@lccpaid-@lrtncshamt+@lstcpay_amt+@lqitaf_amt
				
---------------------------- End of Addtion  -------------------------------------------
---------------- Added on 2019-08-20  ---------------------------------
                if @prpdamt>0
				begin
				    set @ppcard=''
					set @ppamt=0
					set @pppaycard=''
					set @ppamt_rtn=0
					set @pppaytype=0

					DECLARE ppcard_crsr CURSOR LOCAL FAST_FORWARD FOR 
					select disccard,prepaidamt,paycard,prepaidamt_rtn,paytype from posppcard  
					where company=@lcompany and contr=@lcntr and ref=@lref and paytype=5;
					open  ppcard_crsr;
					fetch next from ppcard_crsr into @ppcard,@ppamt,@pppaycard,@ppamt_rtn,@pppaytype;
					WHILE @@FETCH_STATUS =0
					begin
					    if isnull(@ppamt,0)>0
						begin
						    set @pp_lptr=@pp_lptr+1
							if @pp_lptr=1
								set @ppcardlist=ltrim(str(@lcntr))+' '+ltrim(str(@lref))+' '+rtrim(ltrim(@ppcard))
								+' '+ltrim(str(@ppamt,12,3))+' '+rtrim(ltrim(iif(len(isnull(@pppaycard,''))=0,'xx',@pppaycard)))+' '+ltrim(str(isnull(@ppamt_rtn,0),15,7))
							else
								set @ppcardlist=@ppcardlist+'/'+ltrim(str(@lcntr))+' '+ltrim(str(@lref))+' '+rtrim(ltrim(@ppcard))
								+' '+ltrim(str(@ppamt,12,3))+' '+rtrim(ltrim(iif(len(isnull(@pppaycard,''))=0,'xx',@pppaycard)))+' '+ltrim(str(isnull(@ppamt_rtn,0),15,7))
							end
					    fetch next from ppcard_crsr into @ppcard,@ppamt,@pppaycard,@ppamt_rtn,@pppaytype
					end
					CLOSE ppcard_crsr
					DEALLOCATE ppcard_crsr
				end
				
---------------- End of addition on 2019-08-20--------------------------------------				
				if @l_ptr=1
				begin
					if @orginvcst<=@current_cash
					begin
						set @alwamtrtn=@orginvcst
						set @lttl_rtncshamt=@alwamtrtn
						set @slinvlist=@lcompany+' '+ltrim(str(@lcntr))+' '+ltrim(str(@lref))+' '+ltrim(str(@alwamtrtn,12,2))-- Added on 2022-06-08 @lcompany+' '+
						+' '+ltrim(str(@current_cash,12,2))+' '+ltrim(str(@linv_max_elapsed))
						break
					end
					set @lttl_rtncshamt =@lttl_rtncshamt + @current_cash
						set @alwamtrtn=@lttl_rtncshamt
						if @alwamtrtn>0
						   set @slinvlist=@lcompany+' '+ltrim(str(@lcntr))+' '+ltrim(str(@lref))+' '+ltrim(str(@alwamtrtn,12,2))-- Added on 2022-06-08 @lcompany+' '+
						   +' '+ltrim(str(@current_cash,12,2))+' '+ltrim(str(@linv_max_elapsed));
					
					if @linvcst=0   break

					if @orginvcst>=@linvcst set @tmpinvcst=@linvcst
					else set  @tmpinvcst=@orginvcst						
				end
				else    ----------- End Of @@l_ptr=1
				begin
					if @tmpinvcst<=@current_cash
					begin
						set @alwamtrtn=@tmpinvcst
						set @lttl_rtncshamt =@lttl_rtncshamt + @alwamtrtn
						set @slinvlist=@slinvlist+'/'+@lcompany+' '+ltrim(str(@lcntr))+' '+ltrim(str(@lref))+' '+ltrim(str(@alwamtrtn,12,2))-- Added on 2022-06-08 @lcompany+' '+
						+' '+ltrim(str(@current_cash,12,2))+' '+ltrim(str(@linv_max_elapsed));
						break
					end
					set @lttl_rtncshamt =@lttl_rtncshamt + @current_cash
						set @alwamtrtn=@current_cash
						if @alwamtrtn>0
						    set @slinvlist=@slinvlist+'/'+@lcompany+' '+ltrim(str(@lcntr))+' '+ltrim(str(@lref))+' '+ltrim(str(@alwamtrtn,12,2))-- Added on 2022-06-08 @lcompany+' '+
							+' '+ltrim(str(@current_cash,12,2))+' '+ltrim(str(@linv_max_elapsed));
					if @linvcst=0  break

					if @tmpinvcst>=@linvcst set @tmpinvcst=@linvcst	
															     
				end       ----------- End Of @@l_ptr>1

				if @lttl_rtncshamt>=@orginvcst break;

				set @rplcntr2=0
				set @rplref2 =0
				set @l_rows=0

				if @linvcst>0 
				begin
					select @rplcntr2=b.rcontr,@rplref2=b.rref from posrtninv b
					where company=@lcompany and contr=@lcntr and ref=@lref;
					set @l_rows=@@ROWCOUNT
				end
				if @l_rows=0  break;
				else if @l_rows>1  
				begin
				   
					DECLARE crs0 CURSOR LOCAL FAST_FORWARD FOR 
					select rcontr,rref from posrtninv 
					where company=@lcompany and contr=@lcntr and ref=@lref;
					open crs0;

						
						fetch next from crs0 into @rplcntr2,@rplref2;
						WHILE @@FETCH_STATUS =0
						begin
                            set @status2=0
							set @slinvlist2=''
							set @ppcardlist2=''
							set @errfound=0
							set @lttl_rtncshamt2=@orginvcst-@lttl_rtncshamt
							set @lttl_charity2=0
	                        exec dbo.GET_cash_deserve_pass2 @lcompany output,@rplcntr2 output,@rplref2 output,@lttl_rtncshamt2 output,
							                                @slinvlist2 output,@status2 output,@lttl_charity2 output,
															@ppcardlist2 output
                            if @status2=0
							begin
							    set @lttl_charity=@lttl_charity+@lttl_charity2
							    if @lttl_rtncshamt2>0
								begin
							       set @lttl_rtncshamt=@lttl_rtncshamt+@lttl_rtncshamt2

								   if len(@slinvlist)=0 set @slinvlist=@slinvlist2
								   else set @slinvlist=@slinvlist+'/'+@slinvlist2										   							   
								end
------------------------------ Added on 2019-08-20 
								if  len(@ppcardlist2)>0  ---- Modified on 2020-10-20 
								   if len(@ppcardlist)=0 set @ppcardlist=@ppcardlist2
								   else set @ppcardlist=@ppcardlist+'/'+@ppcardlist2
------------------------------ End of Addition on 2019-08-20
								if @lttl_rtncshamt>=@orginvcst break
							    fetch next from crs0 into @rplcntr2,@rplref2
							end
							else 
							begin
							    set @errfound=-1
								-- Added on 2020-03-08
								set @rplcntr=@rplcntr2
								set @rplref=@rplref2
								if @status2=-3
								begin
									if @skip_read_rpls=0 set @status=-3  
									else set @status=-4 
								end
							    else set @status=@status2 -- Added on 2020-03-08
							    break
							end
						end   ----------- End Of @@FETCH_STATUS Inner LLOOOOP
					--end       ----------- End Of Inner @@ROWCOUNT>0
					CLOSE crs0
					DEALLOCATE crs0
					break
					--if @lttl_rtncshamt>=@orginvcst or @errfound<0 break
				end	          ----------- End Of @l_rows>1 			
			end               ----------- End Of @@ROWCOUNT>0
			else
			begin
				set @rplcntr=@rplcntr2
				set @rplref=@rplref2
				if  @lfrc_rtncash=1 set @status=0  -- Added on 2020-05-13
				else
				if @skip_read_rpls=0 set @status=-3  
				else set @status=-4 
				Break;
			end
		end                   ----------- End Of Main While Loop
END



GO
/****** Object:  StoredProcedure [dbo].[GET_cash_deserve_pass2]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-10-01@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCedure [dbo].[GET_cash_deserve_pass2]
@lcompany char(2) output,
@rplcntr numeric(4,0) output,
@rplref numeric(8,0) output,
@lttl_rtncshamt float output,
@slinvlist varchar(200) output, -- The list Consist of: contr ref amount/contr ref amount/..... 
@status int=0 output,
----------------  New added by awad on 2017-01-10  --------------------------------------
@lttl_charity float=0 output,
----------------  New added by awad on 2019-08-20  --------------------------------------
-- This will fix the the bug of the cash returned if they are using paytype=5 for card
@ppcardlist varchar(200) output -- The list Consist of: contr ref disccard prepaidamt paycard prepaid_rtn /contr ref disccard
---------------------------- End of Addtion  -------------------------------------------
AS
BEGIN
SET NOCOUNT ON
--- 2024-10-01 AA Defined new varibale @lrtn_saned_amt for Manafith process
--- 2023-10-14 AA dDefined new varibales for installment process
--- 2022-06-08 AA Added @lcompany+' '+ to @slinvlist
--- 2022-06-08 AA changed the value of @linv_max_elapsed variable to be iif(@linvdate is null,datediff(d,invdate,getdate()),datediff(d,invdate,@linvdate))
--- 2022-06-08 AA Assign @linvdate=invdate for the rpl returned invoice
--- 2022-06-08 AA Added new varibale @linvdate to date & initialized it to null in beginning of while loop
--- 2022-05-07 AA Added semi colon for each select 
--- Modified 2021-03-19 added to the GET_cash_deserve_pass2 output for company,contr, ref
--- Added 2020-10-18 if @lcktype=9 set @lcompany=@lfmbranch
---- Added on 2020-05-13 when frc_rtncash in on  return status as true 0
---- Modified on 2019-08-20 to add two variables stcpay & qitaf
declare @lcntr numeric(4,0),
        @lref numeric(8,0),
		@linvttl float=0,
        @lrtncshamt float=0,
		@alwamtrtn float=0,
		@linvcst float,
		@sndamt float=0,
		@prpdamt float=0,
		@lcashamt float=0,
		@lccpaid float=0,
		@current_cash float=0,
		@orginvcst float=0,
		@tmpinvcst float=0,
		@linvorrtrn char(1)='',
		@lvchramt float=0,
		@linv_max_elapsed int =0,
		@l_ptr  int=0,
		@rplcntr2 int=0,
		@rplref2 int=0,
		@l_rows int=0,
		@rmninvcst float=0,
		@lcharity_rpls float=0,
		@lstcpay_amt float=0, --- Added on 2019-04-08
		@lqitaf_amt float=0,   --- Added on 2019-04-08
		@lfrc_rtncash bit =0,   --- Added on 2020-05-13
		@linvdate date --- Added on 2022-06-08
------ Added on 2019-08-20--------------------------
        declare @ppcard varchar(20),
                @ppamt float,
				@pppaycard varchar(20),
				@ppamt_rtn float,
				@pppaytype int,
				@pp_lptr int=0
				set @ppcardlist=''
------ End of addition on 2019-08-20
------ Added on 2024-10-01 AA for Manafith
       declare @lrtn_saned_amt float
------------------------------------------
------ Added on 2023-10-14 AA for installment
       declare @linstallment_amt float,
	           @lrtn_instlmnt_amt float
------ Added on 2020-03-08--------------------------
		declare @lcktype int,
		        @lfmbranch char(2)
----------------------------------------------------
------  Inialize vars
 
        set @rmninvcst=@lttl_rtncshamt
		set @lttl_rtncshamt=0
		set @status=0
		set @slinvlist=''
		set @rplcntr2=@rplcntr
		set @rplref2=@rplref
		set @lttl_charity=0
		set @linstallment_amt=0  --Added on 2023-10-14 AA for installment
		set @lrtn_instlmnt_amt=0 --Added on 2023-10-14 AA for installment
		set @lrtn_saned_amt=0  -- Added on 2024-10-01 AA for Manafith

		while @rplref2<>0 and @l_ptr<10
		begin
		    set @l_ptr =@l_ptr+1
--- Read the Replaced Invoice
            set @linvttl=0
			set @lvchramt=0
			-- Added on 2020-03-08
			set @lcktype=0
			set @lfmbranch=''
			set @linvdate=null --Added on 2022-06-08 AA
			set @lcharity_rpls=0     -- Added on 2024-10-01 AA
			set @lrtn_saned_amt=0    -- Added on 2024-10-01 AA for Manafith
			set @lrtn_instlmnt_amt=0 -- Added on 2024-10-01 AA

		    select @lcntr=salctrno,@lref=salinvno,@linvttl=invttl-isnull(hlldscnt,0),@linvorrtrn=invorrtrn,
			@lvchramt=isnull(dfvchramt,0.00),@lcharity_rpls=isnull(prepaidamt,0),
			@lcktype=cktype,@lfmbranch=fmbranch ,-- Added on 2020-03-08 
			@lfrc_rtncash=isnull(frc_rtncash,0), -- Added on 2020-05-12
			@linvdate=invdate, --Added on 2022-06-08 AA
			@lrtn_instlmnt_amt=isnull(installment_amt,0) -- Added on 2023-10-14 AA for installment
			,@lrtn_saned_amt=isnull(saned_amt,0) -- Added on 2024-10-01 AA for Manafith
			 from pos_hd where company=@lcompany and contr=@rplcntr2 and ref=@rplref2;
			if @@ROWCOUNT>0
			begin
			    if @linvorrtrn in ('1','4')
				begin
				    set @lcntr=@rplcntr2
				    set @lref=@rplref2	
				end
				else set @lttl_charity=@lttl_charity-@lcharity_rpls-isnull(@lrtn_instlmnt_amt,0)-isnull(@lrtn_saned_amt,0) -- Added on 2024-10-01 AA
				if @l_ptr=1 set @orginvcst=@rmninvcst
                set @prpdamt=0
				set @sndamt=0
				set @lcashamt=0
				set @linvcst=0
				set @lccpaid=0
				set @linvttl=0
				set @lrtncshamt=0
				set @linv_max_elapsed=0
				--- Added on 2019-04-08 
				set @lstcpay_amt=0
				set @lqitaf_amt=0

				if @lcktype=9 set @lcompany=@lfmbranch -- Added on 2020-10-18 

				select @prpdamt=prepaidamt,@sndamt=saned_amt,@lcashamt=cashamt,
				@linvcst=invcst,@lccpaid=ccpaid,@linvttl=invttl-isnull(hlldscnt,0),@lrtncshamt=isnull(rtncshamt,0.00),
				@linv_max_elapsed=iif(@linvdate is null,datediff(d,invdate,getdate()),datediff(d,invdate,@linvdate)), --Added on 2022-06-08 AA
				@lstcpay_amt=isnull(a.stcpay_amt,0.00),@lqitaf_amt=isnull(qitaf_amt,0.00), --- Added on 2019-04-08
				@linstallment_amt=isnull(a.installment_amt,0) -- Added on 2023-10-14 AA for installment
				from pos_hd a
				where a.company=@lcompany and a.contr=@lcntr and a.ref=@lref;
				------ Added on 2020-03-08--------------------------
				if @@ROWCOUNT=0 
				begin
					set @rplcntr=@lcntr
					set @rplref=@lref
					if @lcktype=9
					begin
					     set @status=-2  --- Sales invoice is available in HO
						 set @lcompany=@lfmbranch
					end
					else 
					  if @lfrc_rtncash=1 set @status=0 -- Added on 2020-05-13
					  else set @status=-1  --- Sales invoice is available in the previous year
					break
				end
----------------  New added by awad on 2017-01-10  --------------------------------------
                set @linvcst=isnull(@linvcst,0)
				set @prpdamt=isnull(@prpdamt,0)
				set @sndamt=isnull(@sndamt,0)
				set @lcashamt=isnull(@lcashamt,0)
				set @lccpaid=isnull(@lccpaid,0)
				set @lrtncshamt=isnull(@lrtncshamt,0)
				set @linvttl=isnull(@linvttl,0.00)
				--- Added on 2019-04-08
				set @lstcpay_amt=isnull(@lstcpay_amt,0.00)
				set @lqitaf_amt=isnull(@lqitaf_amt,0.00)
				set @linstallment_amt=isnull(@linstallment_amt,0.00) -- Added on 2023-10-14 AA for installment

				if @linvorrtrn='4' set @linvcst=@lvchramt

				
			 	set @lttl_charity=@lttl_charity+@prpdamt+@sndamt+@linstallment_amt -- Added on 2023-10-14 AA for installment
				set @current_cash=@lcashamt+@lccpaid-@lrtncshamt+@lstcpay_amt+@lqitaf_amt	
---------------------------- End of Addtion  -------------------------------------------
---------------- Added on 2019-08-20  ---------------------------------
                if @prpdamt>0
				begin
				    set @ppcard=''
					set @ppamt=0
					set @pppaycard=''
					set @ppamt_rtn=0
					set @pppaytype=0

					DECLARE ppcard_crsr CURSOR LOCAL FAST_FORWARD FOR 
					select disccard,prepaidamt,paycard,prepaidamt_rtn,paytype from posppcard  
					where company=@lcompany and contr=@lcntr and ref=@lref and paytype=5;
					open  ppcard_crsr;
					fetch next from ppcard_crsr into @ppcard,@ppamt,@pppaycard,@ppamt_rtn,@pppaytype;
					WHILE @@FETCH_STATUS =0
					begin
					    if isnull(@ppamt,0)>0
						begin
						    set @pp_lptr=@pp_lptr+1
							if @pp_lptr=1
								set @ppcardlist=ltrim(str(@lcntr))+' '+ltrim(str(@lref))+' '+rtrim(ltrim(@ppcard))
								+' '+ltrim(str(@ppamt,12,3))+' '+rtrim(ltrim(iif(len(isnull(@pppaycard,''))=0,'xx',@pppaycard)))+' '+ltrim(str(isnull(@ppamt_rtn,0),15,7))
							else
								set @ppcardlist=@ppcardlist+'/'+ltrim(str(@lcntr))+' '+ltrim(str(@lref))+' '+rtrim(ltrim(@ppcard))
								+' '+ltrim(str(@ppamt,12,3))+' '+rtrim(ltrim(iif(len(isnull(@pppaycard,''))=0,'xx',@pppaycard)))+' '+ltrim(str(isnull(@ppamt_rtn,0),15,7))
							end
					    fetch next from ppcard_crsr into @ppcard,@ppamt,@pppaycard,@ppamt_rtn,@pppaytype
					end
					CLOSE ppcard_crsr
					DEALLOCATE ppcard_crsr
				end
				
---------------- End of addition on 2019-08-20--------------------------------------				
				if @l_ptr=1
				begin
					if @orginvcst<=@current_cash
					begin
						set @alwamtrtn=@orginvcst
						set @lttl_rtncshamt=@alwamtrtn
						set @slinvlist=@lcompany+' '+ltrim(str(@lcntr))+' '+ltrim(str(@lref))+' '+ltrim(str(@alwamtrtn,12,2)) -- Added on 2022-06-08 @lcompany+' '+
						+' '+ltrim(str(@current_cash,12,2))+' '+ltrim(str(@linv_max_elapsed));
						break
					end
					set @lttl_rtncshamt =@lttl_rtncshamt + @current_cash
						set @alwamtrtn=@lttl_rtncshamt
						if @alwamtrtn>0
						   set @slinvlist=@lcompany+' '+ltrim(str(@lcntr))+' '+ltrim(str(@lref))+' '+ltrim(str(@alwamtrtn,12,2)) -- Added on 2022-06-08 @lcompany+' '+
						   +' '+ltrim(str(@current_cash,12,2))+' '+ltrim(str(@linv_max_elapsed));
					
					if @linvcst=0  break

					if @orginvcst>=@linvcst set @tmpinvcst=@linvcst
					else set  @tmpinvcst=@orginvcst						
				end
				else    ----------- End Of @@l_ptr=1
				begin
					if @tmpinvcst<=@current_cash
					begin
						set @alwamtrtn=@tmpinvcst
						set @lttl_rtncshamt =@lttl_rtncshamt + @alwamtrtn
						set @slinvlist=@slinvlist+'/'+@lcompany+' '+ltrim(str(@lcntr))+' '+ltrim(str(@lref))+' '+ltrim(str(@alwamtrtn,12,2)) -- Added on 2022-06-08 @lcompany+' '+
						+' '+ltrim(str(@current_cash,12,2))+' '+ltrim(str(@linv_max_elapsed));
						break
					end
					set @lttl_rtncshamt =@lttl_rtncshamt + @current_cash
					set @alwamtrtn=@current_cash
					if @alwamtrtn>0
						set @slinvlist=@slinvlist+'/'+@lcompany+' '+ltrim(str(@lcntr))+' '+ltrim(str(@lref))+' '+ltrim(str(@alwamtrtn,12,2)) -- Added on 2022-06-08 @lcompany+' '+
						+' '+ltrim(str(@current_cash,12,2))+' '+ltrim(str(@linv_max_elapsed));

					if @linvcst=0 break

					if @tmpinvcst>=@linvcst set @tmpinvcst=@linvcst	
															     
				end       ----------- End Of @@l_ptr>1

				if @lttl_rtncshamt>=@orginvcst break;

				set @rplcntr2=0
				set @rplref2 =0
				set @l_rows=0
				if @linvcst>0
				begin
					select @rplcntr2=b.rcontr,@rplref2=b.rref from posrtninv b
					where company=@lcompany and contr=@lcntr and ref=@lref;
					set @l_rows=@@ROWCOUNT
				end
				if @l_rows=0  break;
				--else if @l_rows>1  
				--begin
				--	break -- for the time being 
				--end				
			end               ----------- End Of @@ROWCOUNT>0
			else
			begin
				set @rplcntr=@rplcntr2
				set @rplref=@rplref2
				if  @lfrc_rtncash=1 set @status=0 -- Added on 2020-05-13
				else set @status=-3   
				Break;
			end
		end                   ----------- End Of While Loop
END


GO
/****** Object:  StoredProcedure [dbo].[get_cashinhand_bankcash]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2025-01-09@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[get_cashinhand_bankcash]
 @lfmdate varchar(8),
 @ltodate varchar(8),
 @ac_level int
AS
BEGIN

------ Added on 2025-01-05 AA for dashboard 
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON

	;with glopenbal as
	(select glcurrency as fcy,glackind,curname,lc_openbal=sum(glopnbal),fc_openbal=sum(fcopnbal)  from glchart left outer join  glcurr 
	on glchart.glcurrency=glcurr.curcode 
	where actlvl=@ac_level and glackind in ('1','2')
	group by glcurrency,glackind,curname)

	, gltrxbal as
	(select jdcurr as fcy,glackind,
	lc_trxbal= sum(case when jddbcr='D' then jdlcamt else -jdlcamt end),
	fc_trxbal= sum(case when jddbcr='D' then jdfcamt else -jdfcamt end)
	from (glchart inner join gljrdtl inner join gljrhdr 
	on jdcomp=jhcomp and jdtype=jhtype and jdref = jhref 
	on glchart.glkey=gljrdtl.jdkey and glchart.glcurrency = gljrdtl.jdcurr) --and jddate between "+fmdate +" and "+todate;
	where actlvl=@ac_level and glackind in ('1','2') and jhdate between @lfmdate and @ltodate
	group by jdcurr,glackind)

	select a.fcy,isnull(a.curname,'') as fcyname,a.glackind,sum(isnull(lc_trxbal,0)+lc_openbal) as lc_bal,sum(isnull(fc_trxbal,0)+fc_openbal) as fc_bal 
	from glopenbal a left outer join gltrxbal b
	on a.fcy=b.fcy and a.glackind=b.glackind 
	group by a.fcy,a.glackind,isnull(a.curname,'');
end
GO
/****** Object:  StoredProcedure [dbo].[get_category_sales]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2025-01-08@@$$##  Important : must have this line as first line which contains the last update date for the this file 
create PROCEDURE [dbo].[get_category_sales]
 @lfmdate varchar(8),
 @ltodate varchar(8),
 @ssprice  nvarchar(1000),
 @group_factor nvarchar(50),
 @NoOfRecords int output
AS
BEGIN

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
    declare @sqlmsg nvarchar(max)

	set @NoOfRecords=0
	set @sqlmsg =''
---===================================================================================================================================================
set @sqlmsg ='select substring(classkey,1,2) as mclass,
     slprice=sum(case when sales_dt.invtype in (''04'',''06'') then '+@ssprice+' else cast(0.00 AS DECIMAL(20,5)) end),
     rtprice=sum(case when sales_dt.invtype in (''24'',''26'') then '+@ssprice+' else cast(0.00 AS DECIMAL(20,5)) end),
     dsc= sum(iif(valafds>0,(invdsvl/valafds),0)*'+@ssprice+'*(case when sales_hd.invtype in (''04'',''06'') then 1 else -1 end)),
     sl_salesvat=sum((iif(isnull(sales_dt.taxtype,''1'')<=''1'' and ((len(sales_hd.custno)>0 and isnull(sales_hd.clnt_kind,''1'')<=''1'') or 
     (len(sales_hd.custno)=0 and isnull(sales_hd.clnt_kind,''0'') not in (''C'',''I''))) and isnull(sales_hd.vat_amt_rcvd,0)>0 
	 and isnull(sales_hd.pricevattype,1)>1 and
     isnull(zatca_rounding,0)=0,'+@ssprice+'-iif(invdsvl>0 and valafds>0,(invdsvl/valafds)
    *'+@ssprice+',0.00),0.00)*iif(sales_hd.invtype in (''04'',''06''),1,-1))*sales_hd.vat_percent/(100+sales_hd.vat_percent)),
     sl_hlldscnt=sum(iif(isnull(hlldscnt,0)=0 or valafds=0,0.00,'+@ssprice+'*(hlldscnt/valafds)*iif(sales_hd.invtype in (''04'',''06''),1,-1)))
     FROM  STITEMS inner join stunits inner Join sales_dt inner Join sales_hd inner join Salecntr 
	 on sales_hd.company=Salecntr.dp_brno and sales_hd.slcenter=Salecntr.dp_dept 
     on sales_dt.company=sales_hd.company and sales_dt.invtype=sales_hd.invtype and sales_dt.ref=sales_hd.ref 
     on stunits.itemno=sales_dt.itemno and stunits.Unicode=sales_dt.Unicode
     on stitems.itemno=stunits.itemno
     where  sales_hd.invdate between '+@lfmdate+' and '+@ltodate
     if len(@group_factor)>0 set @sqlmsg=@sqlmsg+' and '+@group_factor
     set @sqlmsg=@sqlmsg+' Group By substring(classkey,1,2)'


	exec sp_executesql @sqlmsg;        
	if @@error<>0 set @NoOfRecords=-1 
	ELSE set @NoOfRecords=@@ROWCOUNT

END
GO
/****** Object:  StoredProcedure [dbo].[Get_class_dsc_amt]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO






 CREATE PROCEDURE [dbo].[Get_class_dsc_amt]
	@m_cmp char(2),
	@p_trxtype char(1),
	@p_ref numeric(6),
	@p_supermarket bit,
	@p_classkey char(2),
	@p_dscclassamt float=0 output
	
	AS
	BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
		SET NOCOUNT ON

		SELECT @p_dscclassamt=sum((invdsvl/valafds)*(qty*(price-iif(@p_supermarket=0,cast(price*dscprsnt/100 as int),
			(price*dscprsnt/100)))-offer_amt)) 
			from  (pos_hd inner Join pos_dt  
			on  pos_hd.company = pos_dt.company and pos_hd.Contr = pos_dt.Contr and pos_hd.ref = pos_dt.ref)
			left outer join (stunits b inner join stitems c on b.itemno=c.itemno) 
			on pos_dt.cmbkey=b.cmbkey
			where pos_hd.company=@m_cmp and geninv=@p_ref and invorrtrn=@p_trxtype and substring(c.classkey,1,2)=@p_classkey
			and invdsvl>0 
			set @p_dscclassamt=isnull(@p_dscclassamt,0)
    end












GO
/****** Object:  StoredProcedure [dbo].[get_client_bal]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-08-31@@$$##  Important : must have this line as first line which contains the last update date for the this file 
------ 2024-08-28 AA Added new code to calculate the balance up to specific date
------  Modified on 2022-03-21   dt_paidamt & dt_fpydamt are missing & added
CREATE PROCEDURE [dbo].[get_client_bal]

 @l_company char(2),
 @l_cucode char(6),
 @l_fcy char(3),
 @l_posted bit ,
 @l_curbal   float =0 output,
 @up_2_date char(8) -- Added on 2024-08-28 AA
 
	
AS
BEGIN
declare @open_bal float =0,
        @trx_bal float =0,
		@ldate char(8) -- Added on 2024-08-28 AA

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	
	set @ldate=isnull(@up_2_date,'') -- Added on 2024-08-28 AA

	SET NOCOUNT ON;
	if RTRIM(@l_fcy)=''
	    select @open_bal=cu_opnbal from customer with (NOLOCK) where cu_company=@l_company and cu_code=@l_cucode and cf_fcy=@l_fcy;
    else
	    select @open_bal=cf_opnfcy from customer with (NOLOCK) where cu_company=@l_company and cu_code=@l_cucode and cf_fcy=@l_fcy;

	if @l_posted=0
	begin
	   if RTRIM(@l_fcy)=''
	   begin
---------- Added on  2024-08-28 AA ---------------------------------------------------------------------------------------
	       if len(@ldate)>0
		   select @trx_bal=sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt-dt_paidamt,-(dt_lcamt-dt_discamt-dt_paidamt))) from arhdr with (NOLOCK) inner join 
				ardtl on hd_company=dt_company and hd_type=dt_type and hd_ref=dt_ref 
				where dt_company=@l_company and dt_cucode=@l_cucode
				and dt_fcy=@l_fcy and arhdr.hd_date<=@ldate;
		   else
-----------------------------------------------------------------------------------------------------------------------
		   select @trx_bal=sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt-dt_paidamt,-(dt_lcamt-dt_discamt-dt_paidamt))) from arhdr with (NOLOCK) inner join 
				ardtl on hd_company=dt_company and hd_type=dt_type and hd_ref=dt_ref 
				where dt_company=@l_company and dt_cucode=@l_cucode
				and dt_fcy=@l_fcy;

	   end
	   else
	   begin
---------- Added on  2024-08-28 AA ---------------------------------------------------------------------------------------
	       if len(@ldate)>0
		   select @trx_bal=sum(iif(dt_dbcr='D',dt_fcamt-dt_fdscamt-dt_fpydamt,-(dt_fcamt-dt_fdscamt-dt_fpydamt))) from arhdr with (NOLOCK) inner join 
				ardtl on hd_company=dt_company and hd_type=dt_type and hd_ref=dt_ref 
				where dt_company=@l_company and dt_cucode=@l_cucode
				and dt_fcy=@l_fcy and arhdr.hd_date<=@ldate;
		   else
--------------------------------------------------------------------------------------------------------------------------
		   select @trx_bal=sum(iif(dt_dbcr='D',dt_fcamt-dt_fdscamt-dt_fpydamt,-(dt_fcamt-dt_fdscamt-dt_fpydamt))) from arhdr with (NOLOCK) inner join 
				ardtl on hd_company=dt_company and hd_type=dt_type and hd_ref=dt_ref 
				where dt_company=@l_company and dt_cucode=@l_cucode
				and dt_fcy=@l_fcy;
	   end
    end
	else
	begin
	    if RTRIM(@l_fcy)=''
		begin
		    select @trx_bal=sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt-dt_paidamt,-(dt_lcamt-dt_discamt-dt_paidamt))) from arhdr with (NOLOCK) inner join 
				ardtl with (NOLOCK) on hd_company=dt_company and hd_type=dt_type and hd_ref=dt_ref 
				where dt_company=@l_company and dt_cucode=@l_cucode
				and dt_fcy=@l_fcy and hd_posted=1;
	    end
		else
		begin
		    select @trx_bal=sum(iif(dt_dbcr='D',dt_fcamt-dt_fdscamt-dt_fpydamt,-(dt_fcamt-dt_fdscamt-dt_fpydamt))) from arhdr with (NOLOCK) inner join 
				ardtl on hd_company=dt_company and hd_type=dt_type and hd_ref=dt_ref 
				where dt_company=@l_company and dt_cucode=@l_cucode
				and dt_fcy=@l_fcy and hd_posted=1;
		end
	end
	set @l_curbal=isnull(@open_bal,0)+isnull(@trx_bal,0)
END



GO
/****** Object:  StoredProcedure [dbo].[get_client_item_produced_qty_cur_prev_year]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--
-- Get client ch_tgtqty and ch_fnlqtyrcv for a specific cmbkey and specific request no from current year and last year productions.
--
create PROCEDURE [dbo].[get_client_item_produced_qty_cur_prev_year]
    @cmpcode char(2),
	@cucode char (6),
	@rqstno Numeric(6,0),
    @cmbkey char(24),
	@up_to_date char(8),
	@c_l_tgtqty Numeric(12,3)=0 output,
	@c_l_fnlqtyrcv numeric(12,3)=0 output,
	@p_l_tgtqty Numeric(12,3)=0 output,
	@p_l_fnlqtyrcv numeric(12,3)=0 output
AS
BEGIN    
	declare @dbc varchar(40)

	set @dbc=DB_NAME()	
	if ltrim(rtrim(isnull(@up_to_date,'')))=''
	   select @c_l_tgtqty=sum(ch_tgtqty),
	          @c_l_fnlqtyrcv=sum(ch_fnlqtyrcv) 
		   from jchdr
		   where ch_company=@cmpcode and cmbkey=@cmbkey and ch_cucode=@cucode and ch_cstrqstno=@rqstno
	else
	    select @c_l_tgtqty=sum(ch_tgtqty),
	           @c_l_fnlqtyrcv=sum(ch_fnlqtyrcv) 
		   from jchdr
		   where ch_company=@cmpcode and cmbkey=@cmbkey and ch_cucode=@cucode and ch_cstrqstno=@rqstno and ch_jcdate<=@up_to_date

     
	     set @c_l_tgtqty=isnull(@c_l_tgtqty,0)
		 set @c_l_fnlqtyrcv=isnull(@c_l_fnlqtyrcv,0)
       

	  declare @yrcode char(2)
	  set @yrcode=substring(@dbc,7,2)
	  set @dbc=substring(@dbc,1,6)+str(cast(@yrcode as int)-1,2)
	  if exists(SELECT name FROM sys.databases where name=@dbc)
	  begin
         declare @sql nvarchar(4000),
		 @paralist nvarchar(400)=''
         SET @SQL='select @p_l_tgtqty=sum(ch_tgtqty),@p_l_fnlqtyrcv=sum(ch_fnlqtyrcv)'
		 SET @SQL=@SQL+' from '+@dbc+'.dbo.jchdr '
		 SET @SQL=@SQL+' where ch_company='''+@cmpcode+''' and cmbkey='''+@cmbkey+''' and custno='''+@cucode+''' and ch_cstrqstno='''+@rqstno+''''
		 
		 set @paralist='@p_l_tgtqty Numeric(12,3) output,@p_l_fnlqtyrcv Numeric(12,3) output'		 
		 EXECUTE sp_executesql @sql,@paralist,@p_l_tgtqty=@p_l_tgtqty output,@p_l_fnlqtyrcv=@p_l_fnlqtyrcv output

	  end
      
	  set @p_l_tgtqty=isnull(@p_l_tgtqty,0)
	  set @p_l_fnlqtyrcv=isnull(@p_l_fnlqtyrcv,0)

end







GO
/****** Object:  StoredProcedure [dbo].[get_client_item_sale_rtrn_qty_cur_prev_year]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--
-- Get client sales_qty and rtrnd_qty for a specific items from current year and last year.
--
CREATE PROCEDURE [dbo].[get_client_item_sale_rtrn_qty_cur_prev_year]
    @itemno char(16),
	@unicode char(6),
	@cucode char (6),
	@fcy char(3),
	@up_to_date char(8),
	@c_l_saleqty Numeric(13,3)=0 output,
	@c_l_rtrnqty numeric(13,3)=0 output,
	@p_l_saleqty Numeric(13,3)=0 output,
	@p_l_rtrnqty numeric(13,3)=0 output
AS
BEGIN    
	declare @dbc varchar(40)
	--DECLARE @cur_yr_saleqty Numeric(13,3)=0,
	--        @cur_yr_rtrnqty numeric(13,3)=0
	set @dbc=DB_NAME()
	--K.A.N ADD H.POSTED='1'  TAKE POSTED ONLY	
	if ltrim(rtrim(isnull(@up_to_date,'')))=''
	   select @c_l_saleqty=sum(case when d.invtype in ('04','06') then qty*pkqty else 0 end),
	          @c_l_rtrnqty=sum(case when d.invtype in ('24','26') then qty*pkqty else 0 end) 
		   from sales_dt d inner join sales_hd h on h.company=d.company and h.invtype=d.invtype and h.ref=d.ref
		   where itemno=@itemno and unicode=@unicode and h.custno=@cucode and h.fcy=@fcy and h.posted='1'
	else
	   select @c_l_saleqty=sum(case when d.invtype in ('04','06') then qty*pkqty else 0 end),
	       @c_l_rtrnqty=sum(case when d.invtype in ('24','26') then qty*pkqty else 0 end) 
		   from sales_dt d inner join sales_hd h on h.company=d.company and h.invtype=d.invtype and h.ref=d.ref
		   where itemno=@itemno and unicode=@unicode and h.custno=@cucode and h.fcy=@fcy and h.fcy=@fcy and h.posted='1' and h.invdate<=@up_to_date

     
	     set @c_l_saleqty=isnull(@c_l_saleqty,0)
		 set @c_l_rtrnqty=isnull(@c_l_rtrnqty,0)
       

	  declare @yrcode char(2)
	  set @yrcode=substring(@dbc,7,2)
	  set @dbc=substring(@dbc,1,6)+str(cast(@yrcode as int)-1,2)
	  if exists(SELECT name FROM sys.databases where name=@dbc)
	  begin
         declare @sql nvarchar(4000),
		 @paralist nvarchar(400)=''
		 --K.A.N ADD H.POSTED=''1''  TAKE POSTED ONLY
         SET @SQL='select @p_l_saleqty=sum(case when d.invtype in (''04'',''06'') then qty*pkqty else 0 end),@p_l_rtrnqty=sum(case when d.invtype in (''24'',''26'') then qty*pkqty else 0 end)'
		 SET @SQL=@SQL+' from '+@dbc+'.dbo.sales_dt d inner join '+@dbc+'.dbo.sales_hd h on h.company=d.company and h.invtype=d.invtype and h.ref=d.ref '
		 SET @SQL=@SQL+' where itemno='''+@itemno+''' and unicode='''+@unicode+''' and h.custno='''+@cucode+''' and h.fcy='''+@fcy+''' and h.posted=''1'''		 		 
		 
		 set @paralist='@p_l_saleqty Numeric(13,3) output,@p_l_rtrnqty Numeric(13,3) output'		 
		 EXECUTE sp_executesql @sql,@paralist,@p_l_saleqty=@p_l_saleqty output,@p_l_rtrnqty=@p_l_rtrnqty output
		 
		   --set @c_l_saleqty=isnull(@c_l_saleqty,0)+isnull(@cur_yr_saleqty,0)
		   --set @c_l_rtrnqty=isnull(@c_l_rtrnqty,0)+isnull(@cur_yr_rtrnqty,0)

	  end
      
	  set @p_l_saleqty=isnull(@p_l_saleqty,0)
	  set @p_l_rtrnqty=isnull(@p_l_rtrnqty,0)

end










GO
/****** Object:  StoredProcedure [dbo].[get_client_last_invoice]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2023-05-08@@$$##  Important : must have this line as first line which contains the last update date for the this file 

---- 2023-05-08 AA Stopped the code of searching in pervious year 
---- Modified on 2022-05-02 AA the value of the parameter @c_l_invnet is modified to be cu_openbal-cu_lcaloc instead of the client current balance
--
CREATE PROCEDURE [dbo].[get_client_last_invoice]
    @WhereClause nvarchar(500),
	@WhereExtra nvarchar(200),
	@c_l_invnet float output,
	@inv_duedate char(8) output,
	@lcurdate varchar(10) output,
	@lref int=0 output
AS
BEGIN
    declare @dbc varchar(40),
    @sql nvarchar(400)='',
	@paralist nvarchar(400)='',
	@ldate varchar(10),
	@custbal float
	set @lref=0
	set @custbal=@c_l_invnet
	set @c_l_invnet=0

	set @dbc=DB_NAME()	
	set @ldate=replace(cast(cast(getdate() as date) as varchar(10)),'-','')

	set @sql='select top 1 @c_l_invnet=dt_lcamt-dt_paidamt-dt_discamt-dt_lcaloc,@inv_duedate=dt_duedate,@lref=dt_ref from ardtl where '+@WhereClause
	if isnull(@WhereExtra,'')<>''
	   set @sql=@sql+@WhereExtra

	set @sql=@sql+' and dt_type=''04'' and dt_lcamt-dt_paidamt-dt_discamt-dt_lcaloc>0 and dt_duedate<'''+@ldate+''' order by dt_date desc'

	set @paralist='@c_l_invnet float output,@inv_duedate char(8) output,@lref int output'


	EXECUTE sp_executesql @sql ,@paralist,@c_l_invnet=@c_l_invnet output,@inv_duedate=@inv_duedate output,@lref=@lref output;


	if isnull(@lref,0)=0  and @custbal>0 --len(isnull(@inv_duedate,''))=0 and 
	begin
	  declare @yrcode char(2)
	  set @yrcode=substring(@dbc,7,2)
	  set @dbc=substring(@dbc,1,6)+str(cast(@yrcode as int)-1,2)
	  if exists(SELECT name FROM sys.databases where name=@dbc)
	  begin
	     set @lref=0
		 set @c_l_invnet=0
		 set @inv_duedate=''

		 set @sql='select top 1 @c_l_invnet=dt_lcamt-dt_paidamt-dt_discamt-dt_lcaloc,@inv_duedate=dt_duedate,@lref=dt_ref from '+@dbc+'.dbo.ardtl where '+@WhereClause
		 set @sql=@sql+' and dt_type=''04'' and dt_lcamt-dt_paidamt-dt_discamt-dt_lcaloc>0 and dt_duedate<'''+@ldate+''' order by dt_date desc'
		 EXECUTE sp_executesql @sql ,@paralist,@c_l_invnet=@c_l_invnet output,@inv_duedate=@inv_duedate output,@lref=@lref output;
	  end
	end
	set @c_l_invnet=isnull(@c_l_invnet,0)
	set @inv_duedate=isnull(@inv_duedate,'')
	set @lcurdate=@ldate
	set @lref=isnull(@lref,0)
end



GO
/****** Object:  StoredProcedure [dbo].[get_client_last_price]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--
-- Get client last price for specific items from current year. If it does not exist then get it from the previous year
--
CREATE PROCEDURE [dbo].[get_client_last_price]
    @WhereClause nvarchar(500),
	@WhereExtra nvarchar(200),
	@c_l_price Numeric(13,3)=0 output
AS
BEGIN
    declare @dbc varchar(40),
    @sql nvarchar(400)='',
	@paralist nvarchar(400)=''
	set @dbc=DB_NAME()	

	set @sql='select top 1 @c_l_price=price from sales_dt where '+@WhereClause
	if isnull(@WhereExtra,'')<>''
	   set @sql=@sql+@WhereExtra

	set @sql=@sql+' and invtype in (''04'',''06'') order by invdate desc'

	set @paralist='@c_l_price Numeric(13,3) output'

--print @sql
	EXECUTE sp_executesql @sql ,@paralist,@c_l_price=@c_l_price output

	if isnull(@c_l_price,0)=0
	begin
	  declare @yrcode char(2)
	  set @yrcode=substring(@dbc,7,2)
	  set @dbc=substring(@dbc,1,6)+str(cast(@yrcode as int)-1,2)
	  if exists(SELECT name FROM sys.databases where name=@dbc)
	  begin
		 set @sql='select top 1 @c_l_price=price from '+@dbc+'.dbo.sales_dt where '+@WhereClause+' and invtype in (''04'',''06'') order by invdate desc'
		 EXECUTE sp_executesql @sql ,@paralist,@c_l_price=@c_l_price output
	  end
	end
	set @c_l_price=isnull(@c_l_price,0)
end











GO
/****** Object:  StoredProcedure [dbo].[get_client_last_price_pack_pkqty]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--
-- Get client last price for specific items from current year. If it does not exist then get it from the previous year
--
CREATE PROCEDURE [dbo].[get_client_last_price_pack_pkqty]
    @WhereClause nvarchar(500),
	@WhereExtra nvarchar(200),
	@c_l_price Numeric(13,3)=0 output,
	@c_l_pack char(1)='' output,
	@c_l_pkqty numeric(8,3)=1 output
AS
BEGIN
    declare @dbc varchar(40),
    @sql nvarchar(400)='',
	@paralist nvarchar(400)=''
	set @dbc=DB_NAME()	

	set @sql='select top 1 @c_l_price=price,@c_l_pack=pack,@c_l_pkqty=pkqty from sales_dt where '+@WhereClause
	if isnull(@WhereExtra,'')<>''
	   set @sql=@sql+@WhereExtra

	set @sql=@sql+' and invtype in (''04'',''06'') order by invdate desc'

	set @paralist='@c_l_price Numeric(13,3) output,@c_l_pack char(1) output,@c_l_pkqty numeric(8,3) output'

--print @sql
	EXECUTE sp_executesql @sql ,@paralist,@c_l_price=@c_l_price output,@c_l_pack=@c_l_pack output,@c_l_pkqty=@c_l_pkqty output

	if isnull(@c_l_price,0)=0
	begin
	  declare @yrcode char(2)
	  set @yrcode=substring(@dbc,7,2)
	  set @dbc=substring(@dbc,1,6)+str(cast(@yrcode as int)-1,2)
	  if exists(SELECT name FROM sys.databases where name=@dbc)
	  begin
		 set @sql='select top 1 @c_l_price=price,@c_l_pack=pack,@c_l_pkqty=pkqty from '+@dbc+'.dbo.sales_dt where '+@WhereClause+' and invtype in (''04'',''06'') order by invdate desc'
		 EXECUTE sp_executesql @sql ,@paralist,@c_l_price=@c_l_price output,@c_l_pack=@c_l_pack output,@c_l_pkqty=@c_l_pkqty output
	  end
	end
	set @c_l_price=isnull(@c_l_price,0)
	set @c_l_pack=isnull(@c_l_pack,'')
	set @c_l_pkqty=isnull(@c_l_pkqty,0)
end









GO
/****** Object:  StoredProcedure [dbo].[get_client_qty_buy_item]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-02-26@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[get_client_qty_buy_item]
 
 @l_company char(2),
 @l_barcode varchar(20), 
 @l_disccard char(20),
 @l_slcenter char(2),  
 @l_start_date date,
 @l_end_date date,
 @l_qtybalbuy   numeric(12,3) =0 output 
 
	
AS
BEGIN
	declare @qty numeric(12,3) =0
 

---- Added on 2024-02-25 AA 

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	select @qty=sum(qty) from pos_hd a (NOLOCK) inner join pos_dt b(NOLOCK) on a.company=b.company and a.contr=b.contr and a.ref=b.ref
	where a.company=@l_company and disccard=@l_disccard and barcode=@l_barcode 
			and invdate between @l_start_date and @l_end_date;

    set @l_qtybalbuy=isnull(@qty,0)
	
END

GO
/****** Object:  StoredProcedure [dbo].[get_correct_hijjri_date]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2023-11-25@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[get_correct_hijjri_date]
-------- 
 @pdate varchar(8) output,
 @lgrdate date output,
 @pstrictDate bit

AS
BEGIN
---- Added on 2023-11-20 AA when @pstrictDate=0 means if @p_date is 14450430 which is wrong date in hijiri , correct the date & return it as 14450501 
----                        when @pstrictDate=1 means if @p_date is 14450430 which is wrong date in hijiri , Do not correct the date & return empty string
---- Added on 2023-11-19 AA Added new paramter named @pstrictDate
---- Added on 2023-11-19 AA Removed codes not needed anymore 
---- Added on 2023-11-19 AA Added new code to solve the hijri problem
---- Added on 2023-11-16 AA re-writtin from scrash & enhenced , improved & solved many many date hijiri problems 
	SET NOCOUNT ON;
	declare @lcdate varchar(8),
			@l_loop_cntr int = 0,
			@is_it_hij bit=0,
			@DateConvertFactor int=0,
			@ptr int=0,
			@dd int,@org_dd int=0,
			@ldone bit=0,
			@mm int=0,
			@yy int=0,
			@errstatus int=0,
			@hj_today_date char(8),
			@lgrdate2 date
			set @lcdate=@pdate
			set @lgrdate=null
			--while @l_loop_cntr>0
			--begin
			--	set @l_loop_cntr=@l_loop_cntr-1

	SET @is_it_hij=iif(substring(@pdate,1,2)='14',1,0) 
	set @DateConvertFactor=iif(substring(@pdate,1,2)='14',131,112)
--- Added on 2023-11-19 AA  ----------------------
	declare @today date,@baddate date,@lmdate date,
	  @hjdate char(8), @days_diff int
	set @today=convert(date,getdate(),112)
	set @hjdate=FORMAT(@today,'yyyyMMdd','ar')	
	set @baddate=convert(date,@hjdate,131) ---
	set @days_diff=datediff(d,@baddate,@today)
--	set @lgrdate=dateadd(d,@days_diff,convert(date,@pdate,131))
---------------------------------------------------
	if not ((cast(substring(@lcdate,7,2) as int) between 1 and 29) and (cast(substring(@lcdate,5,2) as int) between 1 and 12) and len(@pdate)=8)
	begin
		begin try
			set @lgrdate=dateadd(d,@days_diff,convert(date,@lcdate,@DateConvertFactor))  -- Added on 2023-11-20 AA convert(date,@lcdate,@DateConvertFactor)
			set @errstatus=0
		end try
		begin catch
		   if @pstrictDate=0
		   begin
			   set @errstatus=-1
			   if @is_it_hij=1
			   begin
					set @dd=cast(substring(@lcdate,7,2) as int)
					set @mm=cast(substring(@lcdate,5,2) as int)
					set @yy=cast(substring(@lcdate,1,4) as int)
					set @org_dd=@dd
					if @dd>=30
					begin
						if @dd=30
						begin
						  set @ptr=1
						end
						else set @errstatus=-2
					end	
					else if @mm>12 set @errstatus=-2
			   end
			   else set @errstatus=-4
		   end
		   else set @errstatus=-3
		end catch
		if @errstatus=-1 and @ptr=1
		begin
			if @mm<12  set @lcdate=str(@yy,4)+iif(@mm+1<10,'0'+str(@mm+1,1),str(@mm+1,2))+'01'
			else set @lcdate=str(@yy+1,4)+'01'+'01'
			begin try
				set @lgrdate= dateadd(d,@days_diff,convert(date,@lcdate,@DateConvertFactor))  -- Added on 2023-11-20 AA convert(date,@lcdate,@DateConvertFactor)	
				set @pdate=@lcdate
			end try
			begin catch
			   set @errstatus=-3
			end	catch
		end
		if @errstatus=-2 or @errstatus=-3 or @errstatus=-4
		begin			
				set @pdate=''
				set @lgrdate= null
		end
	end
	else
	begin
		begin try
			set @lgrdate= dateadd(d,@days_diff,convert(date,@lcdate,@DateConvertFactor))  -- Added on 2023-11-20 AA
			set @errstatus=0
		end try
		begin catch
		   set @errstatus=-2
		   set @pdate=''
		   set @lgrdate= null
		end catch
	end
end



GO
/****** Object:  StoredProcedure [dbo].[get_crnt_card_bal]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-01-07@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[get_crnt_card_bal]
 @lcomp char(2),
 @lcard char(20),
 @cardbal float=0 output ,
 @errstatus int =0 output
AS
BEGIN
  -- Added on 2023-12-20 AA updated from sqlsrvr12
  -- Added on 2023-11-30 For Sawaed AlRiyadh
	-- Added on 2020-03-20 
	SET NOCOUNT ON
    declare @netrcv float=0,
         @lmnthbal float=0,
		 @lmnth_target float=0,
		 @netsales float=0

     set @errstatus=0

	 select @lmnth_target=mnth_target,@lmnthbal=isnull(mnthbal,0) from pos_dsc (nolock) where dsccompany=@lcomp and dsccard=@lcard

	 Select @netrcv=Sum(b.lcamt) From pos_chhd a inner Join pos_chdt b 
			 On  a.company=b.company and a.ref=b.ref
			 Where  b.company=@lcomp and b.cstcode=@lcard and a.posted=1

      Select @netsales=Sum(Iif(invorrtrn='1',prepaidamt,-prepaidamt)) 
			From pos_hd 
			where  company=@lcomp and disccard=@lcard and invorrtrn<>'4' and paytype=4
	  set @cardbal=	@lmnthbal + isnull(@netrcv,0) - isnull(@netsales,0)	

	  if dbo.value_balanced(@lmnth_target,@cardbal)=0
	  begin
			begin transaction
			update pos_dsc set mnth_target=@cardbal where dsccompany=@lcomp and dsccard=@lcard
			if @@error<>0 
			begin		  
				rollback transaction
				set @errstatus=-1
				return 
			end
			commit transaction
	  end
end


GO
/****** Object:  StoredProcedure [dbo].[get_date_diff_y_m_d]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2022-07-20@@$$##  Important : must have this line as first line which contains the last update date for the this file 
---- Modified  on 2022-07-20 KAN. it was very old in some customer databases like step by step and causes error
CREATE PROCEDURE [dbo].[get_date_diff_y_m_d]
-------- 

 @pfdate varchar(8) ,
 @ptdate varchar(8) ,
 @errstatus int  output,
 @years  int output,
 @months int output,
 @days int output
  	
AS
BEGIN		
		SET NOCOUNT ON;

        declare @date3 smalldatetime		

		declare @lfdate date,
		        @ltdate date,
		        @lgrdate date

		set @errstatus  =0
		
		set @years=0
		set @months=0
		set @days=0

		if len(isnull(@pfdate,''))=0 and len(isnull(@ptdate,''))=0 
		begin
		    set @errstatus  =-2
			return
		end 

		if len(isnull(@pfdate,''))=0
		begin
		   set @pfdate=convert(varchar(8),getdate(),112)
		   set @lfdate=cast(getdate() as date)
		end
		else
		begin
			exec dbo.validate_date @pfdate output,@errstatus output,@lfdate output
			if @errstatus<0 return
		end
		set @errstatus  =0
		if len(isnull(@ptdate,''))=0
		begin
		    set @ptdate=convert(varchar(8),getdate(),112)
			set @ltdate=cast(getdate() as date)
		end
		else
		begin
			exec dbo.validate_date @ptdate output,@errstatus output,@ltdate output
			if @errstatus<0 return	
		end
		
		set @errstatus  =0	
        begin try		
           if @lfdate>@ltdate
           begin
              set @date3=@lfdate
              set @lfdate=@ltdate
              set @lfdate=@date3
           end
		   
		   set @months=datediff (MONTH,@lfdate,@ltdate)	       
		   if dateadd(month,@months,@lfdate) >@ltdate
           begin
             set @months=@months-1
           end
	   	   set @days=DATEDIFF(day,dateadd(month,@months,@lfdate),@ltdate)
           set @years=@months/12
           set @months=@months % 12
        end try				
	    begin catch
		   set @errstatus  =-1
		   set @years = 0
		   set @months = 0
		   set @days = 0
	    end catch		
END













GO
/****** Object:  StoredProcedure [dbo].[get_glsction_bal]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2022-05-16@@$$##  Important : must have this line as first line which contains the last update date for the this file 
------  Added on 2022-03-21 AA --------
CREATE PROCEDURE [dbo].[get_glsction_bal]

 @l_company char(2),
 @l_sc_code char(6),
 @l_fcy char(3),
 @l_all bit,
 @l_curbal   float =0 output 
 
	
AS
BEGIN
	declare @open_bal float =0,
        @trx_bal float =0

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	if @l_all=1
	begin
	    select @open_bal=sum(cu_opnbal) from customer with (NOLOCK) where cu_company=@l_company and section=@l_sc_code ;

		select @trx_bal=sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt-dt_paidamt,-(dt_lcamt-dt_discamt-dt_paidamt))) 
		from arhdr with (NOLOCK) inner join 
			ardtl on hd_company=dt_company and hd_type=dt_type and hd_ref=dt_ref 
			inner join customer c on dt_company=cu_company and dt_cucode=cu_code and dt_fcy=cf_fcy
			where dt_company=@l_company and c.section=@l_sc_code;
	end
	else
		begin
		if RTRIM(@l_fcy)=''
			select @open_bal=sum(cu_opnbal) from customer with (NOLOCK) where cu_company=@l_company and section=@l_sc_code and cf_fcy=@l_fcy;
		else
			select @open_bal=sum(cf_opnfcy) from customer with (NOLOCK) where cu_company=@l_company and section=@l_sc_code and cf_fcy=@l_fcy;


		if RTRIM(@l_fcy)=''
		begin
			select @trx_bal=sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt-dt_paidamt,-(dt_lcamt-dt_discamt-dt_paidamt))) 
			from arhdr with (NOLOCK) inner join 
				ardtl on hd_company=dt_company and hd_type=dt_type and hd_ref=dt_ref 
				inner join customer c on dt_company=cu_company and dt_cucode=cu_code and dt_fcy=cf_fcy
				where dt_company=@l_company and c.section=@l_sc_code
				and dt_fcy=@l_fcy;
		end
		else
		begin
			select @trx_bal=sum(iif(dt_dbcr='D',dt_fcamt-dt_fdscamt-dt_fpydamt,-(dt_fcamt-dt_fdscamt-dt_fpydamt))) 
			from arhdr with (NOLOCK) inner join 
				ardtl on hd_company=dt_company and hd_type=dt_type and hd_ref=dt_ref 
				inner join customer c on dt_company=cu_company and dt_cucode=cu_code and dt_fcy=cf_fcy
				where dt_company=@l_company and c.section=@l_sc_code
				and dt_fcy=@l_fcy;
		end
     end
	 set @l_curbal=isnull(@open_bal,0)+isnull(@trx_bal,0)
END





GO
/****** Object:  StoredProcedure [dbo].[get_item_avrege_cost]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2023-06-13@@$$##  Important : must have this line as first line which contains the last update date for the this file
CREATE PROCEDURE [dbo].[get_item_avrege_cost]
 @litemno char(16),
 @lunicode char(6),
 @llcost  float = 0 output, 
 @lfcost float = 0 output,
 @lbal float = 0 output,
 @lrsbqty float = 0 output,
 @errstatus int = 0 output
	
AS
BEGIN
----  Added on 2023-06-13 AA fixed the bug , do not sum lcost when qty<0 in stbins
----  Modified on 2020-12-03 AA converting @lbal & @lrsbqty from numeric to float

		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
		SET NOCOUNT ON
		declare  @vlcost  float = 0 ,
		@vfcost float = 0 ,
		@vbal float = 0 ,  ----  Modified on 2020-12-03 AA
		@vrsbqty float = 0 ----  Modified on 2020-12-03 AA
		select @vbal=sum(isnull(qty,0)),@vrsbqty=sum(isnull(rsvqty,0)),@vlcost=sum(lcost*qty),@vfcost=sum(isnull(fcost,0)*qty)
		 from stbins with (NOLOCK) 
		where itemno=@litemno and unicode=@lunicode
		and qty>0; -- Added on 2023-06-13 AA
		if @@rowcount>0
		begin
			set @lbal=@vbal
			set @lrsbqty=@vrsbqty
			if @lbal<>0 
			begin
 				set @llcost=abs(@vlcost/@lbal)
				set @lfcost=abs(@vfcost/@lbal)
			end 
		end
		else set @errstatus=-1
end



GO
/****** Object:  StoredProcedure [dbo].[get_item_balance]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[get_item_balance] 
@pbranch char(2),
@pitemno char(16),
@punicode char(6),
@ptodate char(8),
@pposted_only bit,
@pbal numeric(13,5) output , -- lvl=1 ,lvl=2 lvl=3
@plstrcvdate char(8) output
AS
BEGIN
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
	SET NOCOUNT ON
	declare @lposted bit,
	        @lunposted bit,
			@ltrxbal numeric(13,5)=0,
			@lopenbal numeric(13,5)=0 ,
			@lpos int =0

    if @pposted_only=1
	begin
		 set @lposted=1
		 set @lunposted=1
	end
	else
	begin
		 set @lposted=0
		 set @lunposted=1
	end
	set @lpos=iif(@pbal<=1,0,iif(@pbal=2,3,6))
	set @pbal =0
	set @plstrcvdate=''
	if len(@pbranch)=0
	begin
	    if @lpos=0
		begin
		select @ltrxbal=sum(case when (dd.trtype in ('02','04','06','09','30','31')) or (tobinno<>'+' and dd.trtype='20')
			then -(dd.qty+dd.fqty) else dd.qty+dd.fqty end),@plstrcvdate=max(iif(hh.trtype in ('10','11'),hh.trdate,''))
			from sthdr hh inner join stdtl dd
			on hh.branch=dd.branch and hh.trtype=dd.trtype and hh.ref=dd.ref
			where itemno=@pitemno  and hh.trtype not in ('14') and hh.posted in (@lposted,@lunposted)
			and hh.trdate<=@ptodate

			select @lopenbal=sum(openbal) from stbins where itemno=@pitemno  
		end
		else
		begin
		select @ltrxbal=sum(case when (dd.trtype in ('02','04','06','09','30','31')) or (tobinno<>'+' and dd.trtype='20')
			then -(dd.qty+dd.fqty) else dd.qty+dd.fqty end),@plstrcvdate=max(iif(hh.trtype in ('10','11'),hh.trdate,''))
			from sthdr hh inner join stdtl dd
			on hh.branch=dd.branch and hh.trtype=dd.trtype and hh.ref=dd.ref
			where itemno=@pitemno and substring(unicode,1,@lpos)=@punicode and hh.trtype not in ('14') and hh.posted in (@lposted,@lunposted)
			and hh.trdate<=@ptodate

			select @lopenbal=sum(openbal) from stbins where itemno=@pitemno and substring(unicode,1,@lpos)=@punicode 
		end
	 end
     else
	 begin
	    if @lpos=0
		begin
			 select @ltrxbal=sum(case when (dd.trtype in ('02','04','06','09','30','31')) or (tobinno<>'+' and dd.trtype='20')
				then -(dd.qty+dd.fqty) else dd.qty+dd.fqty end),@plstrcvdate=max(iif(hh.trtype in ('10','11'),hh.trdate,''))
				from sthdr hh inner join stdtl dd
				on hh.branch=dd.branch and hh.trtype=dd.trtype and hh.ref=dd.ref
				where hh.branch=@pbranch and itemno=@pitemno  and hh.trtype not in ('14') and hh.posted in (@lposted,@lunposted)
				and hh.trdate<=@ptodate	 
		
			  select @lopenbal=sum(openbal) from stbins where branch=@pbranch and itemno=@pitemno	
		end
		else
		begin
			 select @ltrxbal=sum(case when (dd.trtype in ('02','04','06','09','30','31')) or (tobinno<>'+' and dd.trtype='20')
				then -(dd.qty+dd.fqty) else dd.qty+dd.fqty end),@plstrcvdate=max(iif(hh.trtype in ('10','11'),hh.trdate,''))
				from sthdr hh inner join stdtl dd
				on hh.branch=dd.branch and hh.trtype=dd.trtype and hh.ref=dd.ref
				where hh.branch=@pbranch and itemno=@pitemno and substring(unicode,1,@lpos)=@punicode and hh.trtype not in ('14') and hh.posted in (@lposted,@lunposted)
				and hh.trdate<=@ptodate	 
		
			  select @lopenbal=sum(openbal) from stbins where branch=@pbranch and itemno=@pitemno and substring(unicode,1,@lpos)=@punicode			
		end			
	  end
	  set @pbal=isnull(@lopenbal,0)+isnull(@ltrxbal,0)
	  set @plstrcvdate=isnull(@plstrcvdate,'')
end














GO
/****** Object:  StoredProcedure [dbo].[get_item_rsvqty_4_sls_withno_bal]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2022-11-09@@$$##  Important : must have this line as first line which contains the last update date for the this file 
create PROCEDURE [dbo].[get_item_rsvqty_4_sls_withno_bal] 
@pitemno char(16),
@punicode char(6),
@pwhno char(2),
@pbinno char(6),
@pbal float output -- be used as input when pbal=0 use sales_dt  pbal=1 use stdtl
AS
BEGIN
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
	SET NOCOUNT ON
	declare @rsvqty_4_sales_withno_bal float,
	        @use_stdtl bit
	set @use_stdtl=iif(@pbal=1,1,0)
	set @pbal=0.00
	set @rsvqty_4_sales_withno_bal=0.00
	if @use_stdtl=0
		select @rsvqty_4_sales_withno_bal=sum((qty+fqty)*pkqty) from sales_dt a inner join sales_hd b 
		on a.company=b.company and a.invtype=b.invtype and a.ref=b.ref
		where b.invtype in ('04','06') and b.belowbal=1 and a.itemno=@pitemno and a.unicode=@punicode and a.whno=@pwhno;
	else
		select @rsvqty_4_sales_withno_bal=sum(qty) from stdtl a inner join sales_hd b 
		on a.branch=b.company and a.trtype=b.invtype and a.ref=b.ref
		where b.invtype in ('04','06') and b.belowbal=1 and a.itemno=@pitemno and a.unicode=@punicode and a.whno=@pwhno and a.binno=@pbinno;
	set @pbal=isnull(@rsvqty_4_sales_withno_bal,0.00);
end


GO
/****** Object:  StoredProcedure [dbo].[get_last_binno]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2023-06-19@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[get_last_binno] 
@pbranch char(2),
@pitemno char(16),
@punicode char(6),
@pwhno char(2),
@pbinno char(6) output 

AS
BEGIN
---- 2023-06-19 AA added new condition "and len(binno)>0"
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
	SET NOCOUNT ON
	declare @lbinno char(6)

	
	set @pbinno =''
	set @lbinno =''

	select top 1 @lbinno=binno from stdtl where branch=@pbranch and itemno=@pitemno and unicode=@punicode and whno=@pwhno
	and (trtype in ('10','11','01') or (trtype='20' and len(towhno)=0)) and len(binno)>0  -- Added on 2023-06-19 AA
	order by trdate desc,iif(trtype in ('10','11'),'01','02') 
	if @@ROWCOUNT=0 or @lbinno is null
	begin
	   set @lbinno =''
	   select @lbinno=max(binno) from stbins where branch=@pbranch and itemno=@pitemno and unicode=@punicode and whno=@pwhno
	end
	set @pbinno = isnull(@lbinno,'')	  
end


GO
/****** Object:  StoredProcedure [dbo].[get_missing_slinvoice]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2023-07-15@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[get_missing_slinvoice]
@branch char(2),
@inv_type char(2),
@frmdate char(8),
@todate  char(8),
@sccode  char(6),
@invref  int output  -- has an input value for SctnHasSerial

as
begin
--- 2023-07-15 AA Fixed the bug when section is used , set @minimum=isnull(@minimum,1) replace by set @minimum=isnull(@minimum,0)
	DECLARE @minimum INT,
	@SctnHasSerial bit =0
	set @SctnHasSerial=iif(@invref>0,1,0)
	set @invref=0
	if @SctnHasSerial=0
	begin
		SELECT @minimum = MIN(ref) FROM sales_hd where company=@branch and invtype=@inv_type and invdate between @frmdate and @todate;
		set @minimum=isnull(@minimum,0) 
		if @minimum=0 return

		;WITH Missing (missnum, maxid)
		AS
		(
		 SELECT @minimum AS missnum, (select max(ref) from sales_hd where company=@branch and  invtype=@inv_type and  invdate between @frmdate and @todate)
		 UNION ALL
		 SELECT missnum + 1, maxid FROM Missing
		 WHERE missnum < maxid
		)
		SELECT top 1 @invref=missnum
		FROM Missing
		LEFT OUTER JOIN sales_hd tt on tt.ref = Missing.missnum and tt.company=@branch and tt.invtype=@inv_type
		WHERE  tt.ref is NULL
		OPTION (MAXRECURSION 0);
	end
	else
	begin
		SELECT @minimum = MIN(ref) FROM sales_hd a inner join salecntr b on a.company=b.dp_brno and a.slcenter=b.dp_dept
		where company=@branch and b.sc_code=@sccode and invtype=@inv_type and invdate between @frmdate and @todate;
		set @minimum=isnull(@minimum,0) -- Fixed the bug , replaced 1 instead 1

		;WITH Missing (missnum, maxid)
		AS
		(
		 SELECT @minimum AS missnum, (select max(ref) from sales_hd a inner join salecntr b on a.company=b.dp_brno and a.slcenter=b.dp_dept
		 where company=@branch and b.sc_code=@sccode and invtype=@inv_type and  invdate between @frmdate and @todate)
		 UNION ALL
		 SELECT missnum + 1, maxid FROM Missing
		 WHERE missnum < maxid
		)
		SELECT top 1 @invref=missnum
		FROM Missing
		LEFT OUTER JOIN (salecntr z inner join sales_hd tt on z.dp_brno=tt.company and z.dp_dept=tt.slcenter and z.sc_code=@sccode) 
		on tt.ref = Missing.missnum and tt.company=@branch and tt.invtype=@inv_type
		WHERE tt.ref is NULL
		OPTION (MAXRECURSION 0);

	end
end


GO
/****** Object:  StoredProcedure [dbo].[get_next_key]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[get_next_key]
 @filename char(20),
 @p_compx   char(2),
 @Max_id   int output
	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
	SET @max_id=(case rtrim(@filename)
	  when 'CUSTOMER' then (select MAX(CAST(cu_code AS INT)) from customer with (NOLOCK)  where cu_company=@p_compx)
	  when 'SUPPLIER' then (select MAX(CAST(cu_code AS INT)) from supplier with (NOLOCK)  where cu_company=@p_compx)
	  else 0
    end) 	
	set @Max_id=@Max_id+1
END

















GO
/****** Object:  StoredProcedure [dbo].[Get_option_Srlno]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Get_option_Srlno]
@option_id int output,
@errstatus int =0 output
AS BEGIN
	declare 
	@dbc nvarchar(14),
	@lcalcomp char(2),
	@yrcode char(4)

	set @option_id=0
	set @errstatus=0

	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)

	DECLARE @NewRef INT,@maxref int
	DECLARE @isEx INT
	SET @NewRef =0
	SET @isEx=1
	set @maxref=0

	SELECT @NewRef  = isnull(item_options_cntr,0)   
	from sysdb.dbo.glcalend where calcomp=@lcalcomp and yrcode=@yrcode
	select @maxref=max(opt_dtl_id) from rstoption_dt 
	if @NewRef<@maxref set @NewRef=@maxref


	WHILE   @isEx=1
	BEGIN
		IF(SELECT  COUNT(*) FROM rstoption_dt  WHERE opt_dtl_id=@NewRef)>0
		BEGIN 
	        SET @NewRef=@NewRef+1
	    END 
		ELSE 
		BEGIN
			SET @NewRef=@NewRef
			SET @isEx=0
		END
	END 
	if @isEx=0
	begin
	    set @option_id=@NewRef
	    begin transaction
	    update sysdb.dbo.glcalend set item_options_cntr=@NewRef+1 where calcomp=@lcalcomp and yrcode=@yrcode
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-1
		end
		else commit transaction
	end
END













GO
/****** Object:  StoredProcedure [dbo].[get_remain_qty_offer]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-02-26@@$$##  Important : must have this line as first line which contains the last update date for the this file
CREATE PROCEDURE [dbo].[get_remain_qty_offer]

 @l_barcode char(20),
 @l_qtybalbuy numeric(12,3)  output ,
 @l_company char(2),
 @l_slcenter char(2)
 	
AS
BEGIN
------ Added on 2024-02-25 AA & enhenced to fit the new offer modification

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;	

	declare @qty numeric(12,3) =0,
    @loffer_no int =0

    set @loffer_no=@l_qtybalbuy
	set @l_qtybalbuy=0.00
	   
	select @qty=isnull(b.max2buy,0)-isnull(b.qty_offer_sold,0) from stoffers_main a with (NOLOCK) inner join stoffers b with (NOLOCK)
	on a.company=b.company and a.slcenter=b.slcenter and a.offer_no=b.offer_no
	where b.company=@l_company and (b.slcenter=@l_slcenter or len(b.slcenter)=0) and b.offer_no=@loffer_no and  b.barcode=@l_barcode;

	set @l_qtybalbuy=isnull(@qty,0)
END

GO
/****** Object:  StoredProcedure [dbo].[get_row_count]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[get_row_count]
 @filename nvarchar(200),
 @p_cond   nvarchar(200),
 @Max_id   int output
	
AS
BEGIN
    declare @sqlmsg nvarchar(400)
	select @Max_id as awad into #TGID where 1 = 2
	set @sqlmsg='select count(*) from '
	if @filename is not null and  @filename<>''
	 begin
	  set @sqlmsg=@sqlmsg+rtrim(@filename)
	
	  if @p_cond is not null and  @p_cond<>''
	  set @sqlmsg=@sqlmsg+' where '+rtrim(@p_cond)
	 

	   SET NOCOUNT ON
	   insert into #TGID
	    exec sp_executesql @sqlmsg
	end
    select @max_id=awad from #TGID
	drop table #TGID
END

















GO
/****** Object:  StoredProcedure [dbo].[get_salesman_bal]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2022-05-16@@$$##  Important : must have this line as first line which contains the last update date for the this file 
------  Added on 2022-03-21 AA --------
CREATE PROCEDURE [dbo].[get_salesman_bal]

 @l_company char(2),
 @l_slcode char(2),
 @l_fcy char(3),
 @l_all bit,
 @l_curbal   float =0 output 
 
	
AS
BEGIN
	declare @open_bal float =0,
        @trx_bal float =0

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	if @l_all=1
	begin
	    select @open_bal=sum(cu_opnbal) from customer with (NOLOCK) where cu_company=@l_company and slcode=@l_slcode;
		select @trx_bal=sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt-dt_paidamt,-(dt_lcamt-dt_discamt-dt_paidamt))) 
		from arhdr with (NOLOCK) inner join 
			ardtl on hd_company=dt_company and hd_type=dt_type and hd_ref=dt_ref 
			inner join customer c on dt_company=cu_company and dt_cucode=cu_code and dt_fcy=cf_fcy
			where dt_company=@l_company and c.slcode=@l_slcode;
	end
	else
	begin
		if RTRIM(@l_fcy)=''
			select @open_bal=sum(cu_opnbal) from customer with (NOLOCK) where cu_company=@l_company and slcode=@l_slcode and cf_fcy=@l_fcy;
		else
			select @open_bal=sum(cf_opnfcy) from customer with (NOLOCK) where cu_company=@l_company and slcode=@l_slcode and cf_fcy=@l_fcy;


		if RTRIM(@l_fcy)=''
		begin
			select @trx_bal=sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt-dt_paidamt,-(dt_lcamt-dt_discamt-dt_paidamt))) 
			from arhdr with (NOLOCK) inner join 
				ardtl on hd_company=dt_company and hd_type=dt_type and hd_ref=dt_ref 
				inner join customer c on dt_company=cu_company and dt_cucode=cu_code and dt_fcy=cf_fcy
				where dt_company=@l_company and c.slcode=@l_slcode
				and dt_fcy=@l_fcy;
		end
		else
		begin
			select @trx_bal=sum(iif(dt_dbcr='D',dt_fcamt-dt_fdscamt-dt_fpydamt,-(dt_fcamt-dt_fdscamt-dt_fpydamt))) 
			from arhdr with (NOLOCK) inner join 
				ardtl on hd_company=dt_company and hd_type=dt_type and hd_ref=dt_ref 
				inner join customer c on dt_company=cu_company and dt_cucode=cu_code and dt_fcy=cf_fcy
				where dt_company=@l_company and c.slcode=@l_slcode
				and dt_fcy=@l_fcy;
		end
    end
	set @l_curbal=isnull(@open_bal,0)+isnull(@trx_bal,0)
END




GO
/****** Object:  StoredProcedure [dbo].[get_settled_offers]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[get_settled_offers]
	@lcomp char(2),
	@lcontr int,
	@lref int,
	@errstatus int = 0 output
	
AS
BEGIN

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON

;
	with cte_offer_stld (barcode,offer_amt,qty,rtrnd)
	as
	(select barcode,isnull(offer_amt,0) as offer_amt,qty,rtrnd from pos_dt
	where company=@lcomp and contr=@lcontr and ref=@lref and 
	qty>1 and rtrnd>0 and offer_amt>0 and qty-rtrnd>0)
	select a.barcode,a.offer_amt,a.qty,a.rtrnd,sum(isnull(d.offer_amt,0)) as offer_stld from pos_hd c
	inner join pos_dt d on c.company=d.company and c.contr=d.contr and c.ref=d.ref
	inner join cte_offer_stld a on d.barcode=a.barcode
	where c.company=@lcomp and c.salctrno=@lcontr and c.salinvno=@lref and invorrtrn in ('2','3')
	group by a.barcode,a.offer_amt,a.qty,a.rtrnd
	set @errstatus=@@rowcount	
end









GO
/****** Object:  StoredProcedure [dbo].[get_sql_info]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
 ---- 2024-08-27@@$$##  Important : must have this line as first line which contains the last update date for the this file 
 CREATE PROCEDURE [dbo].[get_sql_info] 
    @reg_hkey varchar(100) ,
    @keyPath varchar(100) ,
    @value_name varchar(100) ,
	@Registry_Value varchar(1000)='' output,
	@p_servername  varchar(100) output
	AS
	BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
		SET NOCOUNT ON
		declare @loc_value varchar(1000)
		set @loc_value=''
        EXECUTE xp_regread @reg_hkey,  @keyPath, @value_name, @loc_value OUTPUT
      
		  set @Registry_Value=iif(@p_servername='@',@loc_value,'')
		  set @p_servername=@@SERVERNAME
    end
GO
/****** Object:  StoredProcedure [dbo].[get_stock_val]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2025-01-08@@$$##  Important : must have this line as first line which contains the last update date for the this file 
create PROCEDURE [dbo].[get_stock_val]
 @lfmdate varchar(8),
 @ltodate varchar(8),
 @by_wh bit
AS
BEGIN

------ Added on 2025-01-07 AA for dashboard 
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
	if @by_wh=1
	begin
        select a.whno,ttlcost=sum(qty*lcost),b.name as m_name from stbins a inner join stwhous b 
		on a.branch=b.branch and a.whno=b.whno
		group by a.whno,b.name;
	end
	else
	begin
        select b.mgroup,ttlcost=sum(qty*lcost),c.name as m_name from stbins a inner join stitems b 
		on a.itemno=b.itemno 
		left outer join stclass c on b.mgroup=c.mgroup
		group by b.mgroup,c.name;	  
	end
end
GO
/****** Object:  StoredProcedure [dbo].[get_vender_last_price]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--
-- Get vender last price for specific items from current year. If it does not exist then get it from the previous year
--
CREATE PROCEDURE [dbo].[get_vender_last_price]
    @WhereClause nvarchar(500),
	@WhereExtra nvarchar(200) ,
	@c_l_price Numeric(13,3)=0 output,
	@lpkqty Numeric(13,3)=0 output

AS
BEGIN
    declare @dbc varchar(40),
    @sql nvarchar(400)='',
	@paralist nvarchar(400)=''
	
	set @dbc=DB_NAME()	

	set @sql='select top 1 @c_l_price=price,@lpkqty=pkqty from pudtl where '+@WhereClause
	if isnull(@WhereExtra,'')<>''
	   set @sql=@sql+@WhereExtra

	set @sql=@sql+' and invtype in (''10'',''11'') order by invdate desc'

	set @paralist='@c_l_price Numeric(13,3) output,@lpkqty Numeric(13,3) output'

--print @sql
	EXECUTE sp_executesql @sql ,@paralist,@c_l_price=@c_l_price output,@lpkqty=@lpkqty output

	if isnull(@c_l_price,0)=0
	begin
	  declare @yrcode char(2)
	  set @yrcode=substring(@dbc,7,2)
	  set @dbc=substring(@dbc,1,6)+str(cast(@yrcode as int)-1,2)
	  if exists(SELECT name FROM sys.databases where name=@dbc)
	  begin
		 set @sql='select top 1 @c_l_price=price,@lpkqty=pkqty from '+@dbc+'.dbo.pudtl where '+@WhereClause+' and invtype in (''10'',''11'') order by invdate desc'
		 EXECUTE sp_executesql @sql ,@paralist,@c_l_price=@c_l_price output,@lpkqty=@lpkqty output
	  end
	end
	set @c_l_price=isnull(@c_l_price,0)
	set @lpkqty=isnull(@lpkqty,1)
	set  @lpkqty=iif( @lpkqty=0,1, @lpkqty)
end











GO
/****** Object:  StoredProcedure [dbo].[gl_uncomplete]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-08-19@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[gl_uncomplete]
 @m_cmp char(2),
 @m_type char(2),
 @m_ref  int, 
 @pstmode bit,
 @lsrc char(2),
 @caokmustfc bit,
 @errcode char(4) output
 	
AS
BEGIN

----- 2024-08-19 AA Added excluded the installment for user yemen
----- 2024-05-25 AA Added new code for src=45 from kassem & removed the old one
----- 2023-12-11 AA Added two more variables vat_percent & lextamt_vat 
----- 2023-12-11 AA Added code to fit zatca rounding requirement 
----- 2023-12-11 AA Added the new variable for zatca rounding 
----- 2023-10-19 AA Added new codes to handle the difference occured by installment commission & commission vat
----- 2023-07-22 AA Fixed the bug when external client & pricevattype=2 & extamt>0
----- 2023-07-04 AA From Kass to solve problem with PP
----- 2023-05-14 KAN Added Fixed Asset Codes
----- 2023-02-28 AA replaced if @trnsprt_onus=0 and @m_type in ('06','26') set  @llcamt=@llcamt+@ltrprt_vatamt with 
-----               if @trnsprt_onus=0  set  @llcamt=@llcamt+@ltrprt_vatamt
----- 2023-02-22 AA Added new code when the varibale @trnsprt_onus=0 and cash invoice
----- 2023-02-22 AA Added new varibale @trnsprt_onus
----- 2023-02-20 AA Added new varibale @broker_vatamt and add it to the variable @llcamt
----- 2023-01-15 AA Added new variable @lvatregtype to fix the bug when vatregtype=3 in the invoice purchase
----- 2023-01-09 AA Added new code to fix the bug when sales invoices for smsuser=288 and has transport expense
----- 2023-01-07 AA Added new code to fix the bug when purchase invoices for smsuser=288 and has transport expense
----- 2022-10-13 AA Added new codes and new select statement from slfcypay table to get the currency payment difference
----- 2022-10-13 AA Added new varible named @lfcdiff to store the currency difference of invoice payment (yemen)
----- 2022-10-13 AA Added @lcountrycode to the select statement of glcalend table for yemen
----- 2022-10-13 AA added new variable name @lcountrycode to store the country column from glcalend for yemen
----- 2022-08-21 KAN Modification for Rent System Trans To Be Posted With Payment In Different Currency 
----- 2022-07-24 AA I have added the broker_ttlcmsn in slinvexp table
----- 2022-06-08 AA I have added @lsmsuser variable & read the value from stbranch
----- 2022-06-08 AA I have define some variables to be used for the expense values
----- 2022-06-08 AA I have added new code to read from slinvexp table to get invoice expense
----- 2022-05-09 AA i have made the @m_ref parameter to be int instead of numeric(6,0)
----- Added on 2022-03-16 AA use dbo.value_balanced(@fc_db,@fc_cr)=0 instead of @fc_dbc<>@fc_cr
----- Added on 2022-01-20 when @llisit_opst=1 then do not check for @fc_db<>@fc_cr
----- Modified on 2021-12-03 AA changed numeric(20,7) to float
----- Added on 2021-06-20 AA the rent system src=45 by Kassem
----- Added on 2021-06-17 AA set @llcamt=@llinvcst+@llimfcval+@lvat_amt+iif(@lNoDsc4SlPuJv=0,@llinvdsvl,0)
------Added on 2021-06-07 AA if @llisit_opst=1 and dbo.value_balanced(@ljhamt,@llcamt)=0 set @llcamt=@ljhamt 
----  Added on 2020-11-25 AA to handle the free qty
----  Modified on 2020-11-25 to check if the Purchase invoice discount will not be shown in the JV by adding iif(@lNoDsc4SlPuJv=0,@llinvdsvl,0)
----  Modified on 2020-11-23 to check if the sales invoice discount will not be shown in the JV by adding -iif(@lNoDsc4SlPuJv=1,@llinvdsvl,0) 
----  Modified on 2020-08-13 AA if the purchase invoice has all items as service items & there is expenses. Fixed
	SET NOCOUNT ON
	declare @ljhamt float=0,
	@lptr int =0,
	@no_entries int=0,
	@jhlccrttl float,
	@jhlcdbttl float,
	@posted bit,
	@src char(2),
	@lbrxfrm char(2)='',
	@lisbrtrx bit=0,
	@lpricevattype numeric(1,0)=1,
	@lpriceincludevat bit =0,
    @lvat_percent numeric(10,3)=0 ,  
	@lNoDsc4SlPuJv bit =0;

	declare @p_supermarket bit,
	@dbc nvarchar(14),
	@lcalcomp char(2),
	@yrcode char(4),
	@lcountrycode int=0, -- Added on 2022-10-13 AA For yemen
	@lfcdiff float =0,   -- Added on 2022-10-13 AA For yemen
	@lvatregtype numeric(1,0)=1   -- Added on 2023-01-15 AA

--- Added on 2023-12-11 AA Variables for zatca rounding-----	
	declare
	@lzatca_rounding bit=0, 
	@l_extamt_vat numeric(12,3)=0 
---------------------------------------------------------
	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)

	select @lpricevattype=pricevattype,@lvat_percent=vat_percent,@lNoDsc4SlPuJv=isnull(NoDsc4SlPuJv,0),@lcountrycode=country, -- Added on 2022-10-13 For yemen
	@lvatregtype=vatregtype -- Added on 2023-01-15 AA
	from sysdb.dbo.glcalend 
	where calcomp=@lcalcomp and yrcode=@yrcode;

	set @lpricevattype=isnull(@lpricevattype,1)
	set @lpricevattype=iif(@lpricevattype=0,1,@lpricevattype)

	set @errcode='';

    select @posted=jhposted,@src=jhsrc,@ljhamt=jhamt,@jhlccrttl=jhlccrttl,@jhlcdbttl=jhlcdbttl,
	      @no_entries=jhentries,@lbrxfrm=brxfrm,@lisbrtrx=isbrtrx from gljrhdr with (NOLOCK)
	where jhcomp=@m_cmp and jhtype=@m_type and jhref=@m_ref;
    set @lptr=@@rowcount

	declare @llopst_fcy char(3),
		@llinvttl float,
		@llextamt float,
		@llfcy char(3),
		@llfcyrate float,
		@llfixrate float,
		@llcccommsn float,
		@llcamt float=0,
		@llinvcst float=0,
		@llttl float=0,
		@llxttl float=0,
		@llinvdsvl float=0,
		@llimfcval float=0,
		@llbranch char(2),
		@llisit_opst bit,
		@llrplsamt float=0,
		@llccpayment float=0,
		@llprpaidamt float=0,
		@llinvpaid  float=0,
		@llvat_amt_rcvd float=0,
		@lvat_amt float=0,
		@llcttlexp float=0,
		@llcinvexp float=0,
		@llprodrate float=0,
	    @lclient_is_opticals int =0,
	    @m_exlc float=0,
		@l_date char(8)='';

--------- Added on 2022-06-08 AA  ---------------------------
    declare @lsmsuser int=0 
    select @lsmsuser=smsuser from stbranch where brnno=@m_cmp; 
	set @lsmsuser=isnull(@lsmsuser,0)
-------------------------------------------------------------
		set @llisit_opst=0
	select @lclient_is_opticals=count(*) from stbranch where smsuser=200;

	if @lsrc<>'01' and not ((@lsrc='05' or @lsrc='03') and @m_type='17') and not (@lsrc='03' and @lisbrtrx=1)
	and not (@lsrc='05' and @m_type='01') 
	begin
		  if @lptr=0
		  begin
			set @errcode='122'
			return
		  end
		  set @lptr=0
		  if @pstmode=1 
		  begin
			  if  @posted=0
			  begin
				set @errcode='136'
				return
			  end
		  end
		  else 
		  if  @posted=1
		  begin 
				set @errcode='212'
				return
		  end

          If @lsrc='02'
		  begin
				select @llfcy=isnull(hd_fcy,''),@llopst_fcy=isnull(opst_fcy,''),@llisit_opst=isit_opst,@llxttl=opst_val,
				@llttl=hd_ltotal from arhdr with (NOLOCK) where hd_COMPANY=@m_cmp AND hd_TYPE=@m_type AND hd_REF=@m_ref;
				if @@rowcount=0
				begin
					set @errcode='122'
					return
				end
				If @llisit_opst=1 And @llfcy<>'' And @llopst_fcy=''
					set @llcamt=iif(@llttl>@llxttl,@llttl,@llxttl)
				Else
					set @llcamt=@llttl

				if @llisit_opst=1 and dbo.value_balanced(@ljhamt,@llcamt)=0	
				    set @llcamt=@ljhamt;
		  end
          If @lsrc='05' 
		  begin
				declare @lposinv int=0,	
				        @lsandedamt float =0,
						@fqtyvat float=0,
						@extamt_vat float =0, --Added on 2023-07-22 AA einvphs2
						@linstallment_amt float=0 -- Added on 2023-10-19 AA installment

				set @lpricevattype=0   	 
				select @llinvttl=valafds,@llextamt=extamt,@llvat_amt_rcvd=vat_amt_rcvd,@llfcy=isnull(fcy,''),@llfcyrate=isnull(fcyrate,0),
				@llcccommsn=cccommsn,@llfixrate=isnull(fixrate,0),@llrplsamt=rplsamt,@llinvdsvl=invdsvl,
				@llccpayment = ccpayment ,@llprpaidamt = prpaidamt , @llinvpaid = invpaid,@lpricevattype=pricevattype,
				@lposinv=posinv,@lsandedamt=sanedcrd_amt,@l_date=invdate,
				@fqtyvat=iif(pricevattype>1 and isnull(fqtyval,0)>0,isnull(fqtyval,0)*vat_percent/(100+vat_percent),0),
				@lvat_percent=vat_percent, -- Added on 2023-01-09 AA
				@extamt_vat=iif(pricevattype>1 and clnt_kind in ('2','3') and extamt>0,extamt*vat_percent/(100+vat_percent),0), -- Added on 2023-07-22 AA
				@linstallment_amt=iif(@lcountrycode<>1,isnull(installment_amt,0),0) -- Added on 2023-10-19 AA installment
				from sales_hd with (NOLOCK) where COMPANY=@m_cmp AND INVTYPE=@m_type AND REF=@m_ref;
				if @@rowcount=0
				begin
					set @errcode='122'
					return
				end
----------------------------------------------------------------------------------------------------------
--------------- 
------------------ Added on 2022-06-08 AA ---------------------------------------------------------------
				declare
					@ltrprt_amt float=0,
					@ltrprt_vatamt float=0,
					@slsmencmsn_amt float=0,
					@lttl_ar float=0,
					@lbroker_ttlcmsn float=0, -- Added on 2022-07-24 AA
					@lis_vat bit=0, -- Added on 2023-01-09 AA
					@broker_vatamt float=0,  --  Added on 2023-02-20 AA
					@trnsprt_onus bit=0  --  Added on 2023-02-22 AA

				if @lsmsuser<>288  
				begin
					select @ltrprt_amt=isnull(transportamt,0),@ltrprt_vatamt=isnull(transport_vat,0),@slsmencmsn_amt=isnull(slsmanamt,0),
					@lbroker_ttlcmsn=isnull(broker_ttlcmsn,0), -- Added on 2022-07-24 AA
					@broker_vatamt=isnull(broker_vat_amt,0),	--  Added on 2023-02-20 AA	
					@trnsprt_onus=isnull(transportOnUs,0) 	--  Added on 2023-02-22 AA	
					from slinvexp with (NOLOCK) 
					where COMPANY=@m_cmp AND INVTYPE=@m_type AND REF=@m_ref; 
					set @ltrprt_amt=isnull(@ltrprt_amt,0)
					set @ltrprt_vatamt=isnull(@ltrprt_vatamt,0)
					set @slsmencmsn_amt=isnull(@slsmencmsn_amt,0)
					set @lbroker_ttlcmsn=isnull(@lbroker_ttlcmsn,0) -- Added on 2022-07-24 AA
					set @broker_vatamt=isnull(@broker_vatamt,0) --  Added on 2023-02-20 AA	
					set @trnsprt_onus=isnull(@trnsprt_onus,0) --  Added on 2023-02-22 AA
				end
	-------------------------------------------------------------------------------------------------------------------
	----------- Added on 2023-01-09 AA For Jood ----------------------------------------------------------------
				else
				begin
					select @ltrprt_amt=isnull(trans_expnse,0),@slsmencmsn_amt=isnull(slsmanamt,0),
					@lbroker_ttlcmsn=isnull(driver_expnseamt,0),
					@lis_vat=isnull(is_vat,0) 
					from slinvexp with (NOLOCK) 
					where COMPANY=@m_cmp AND INVTYPE=@m_type AND REF=@m_ref;
					set @ltrprt_amt=isnull(@ltrprt_amt,0)
					if @lis_vat=1
					set @ltrprt_vatamt=@ltrprt_amt*@lvat_percent/100
					if @ltrprt_amt=0
					set @lbroker_ttlcmsn=isnull(@lbroker_ttlcmsn,0)
					set @slsmencmsn_amt=isnull(@slsmencmsn_amt,0)
				end
----------------------------------------------------------------------------------------------------
				if @lclient_is_opticals>0 and @llcccommsn<>0
					   set @m_exlc=@llcccommsn*iif(@l_date<'20200701',5.00,15.00)/100 
--------------- Added on 2023-12-11 AA ----------------------------------------------------------------------------------------------------------
                set @l_extamt_vat=0
				set @lzatca_rounding=0

				if COL_LENGTH('dbo.sales_hd','zatca_rounding') is not null
				begin 
					select @lzatca_rounding=isnull(zatca_rounding,0) from sales_hd with (NOLOCK) 
					where COMPANY=@m_cmp AND INVTYPE=@m_type AND REF=@m_ref;
					if @llextamt>0 and @lzatca_rounding=1 and @lpricevattype>1 and @lvat_percent>0 
					set @l_extamt_vat=round(@llextamt*@lvat_percent/(100+@lvat_percent),2)
				end
---------------------------------------------------------------------------------------------------------------------------------------------------
				If isnull(@llfcy,'')=''
				begin
------------------- Added on 2023-12-11 AA -------------------------------------------------------------------------------------------------------------------
				    if 	@lzatca_rounding=1 	
						set  @llcamt=(@llinvttl+@llextamt+@llcccommsn+iif(@lpricevattype=1 or @lzatca_rounding=1,@llvat_amt_rcvd,0))-iif(@lNoDsc4SlPuJv=1,@llinvdsvl,0)-@l_extamt_vat			    
					else
					begin
----------------------------------------------------------------------------------------------------------------------------------------------------------
						set  @llcamt=(@llinvttl+@llextamt+@llcccommsn+@fqtyvat+iif(@lpricevattype=1 or @lzatca_rounding=1,@llvat_amt_rcvd,0))-iif(@lNoDsc4SlPuJv=1,@llinvdsvl,0) 
						set @llcamt=@llcamt-@extamt_vat  -- Added on 2023-07-22 AA Einvphs2
					end
	----------------- Added on 2022-06-08 AA ----------------------------------------
					set @llcamt=@llcamt+@ltrprt_amt+@ltrprt_vatamt+@slsmencmsn_amt+@lbroker_ttlcmsn -- Added on 2022-07-24 AA
					            +@broker_vatamt --  Added on 2023-02-20 AA
					if @trnsprt_onus=0  set  @llcamt=@llcamt+@ltrprt_vatamt --  Added on 2023-02-28 AA
					--if @trnsprt_onus=0 and @m_type in ('06','26') set  @llcamt=@llcamt+@ltrprt_vatamt  --  Stopped on 2023-02-28 AA

					if @llcamt<@ljhamt and @lposinv>0
					begin --- 2018-09-23
						if @llinvpaid < 0 set @llcamt=@llcamt + abs(@llinvpaid)
						if @llrplsamt < 0 set @llcamt=@llcamt + abs(@llrplsamt) 
					end
------------------- Added on 2023-10-19 AA handle installment difference -----------------------
                    if @llcamt<@ljhamt and @linstallment_amt>0 and @m_type in ('06','26') 
					begin
						declare @linstlmnt_cmsn float =0,
								@linstlmnt_cmsn_vat float=0
					    if @lposinv>0
						begin
							select @linstlmnt_cmsn=sum(iif(@m_type='06',(a.installment_amt*(trx_inscommprcnt+trx_commp_notrtnd)/100)+trx_inscommamt,
							a.installment_amt*trx_inscommprcnt/100)),
							@linstlmnt_cmsn_vat=sum(iif(@m_type='06',(a.installment_amt*(trx_inscommprcnt+trx_commp_notrtnd)/100)+trx_inscommamt,
							a.installment_amt*trx_inscommprcnt/100)*iif(a.trx_instaxable=1,b.vat_percent/100,0.00))
							from posinstlmnt_trx a inner join pos_hd b on a.company=b.company and a.contr=b.contr and a.ref=b.ref
							where b.company=@m_cmp and b.invorrtrn=@lposinv and geninv=@m_ref and a.installment_amt>0
							set @llcamt=@llcamt+@linstlmnt_cmsn+@linstlmnt_cmsn_vat
						end
						else
						begin
							select @linstlmnt_cmsn=iif(@m_type='06',(a.installment_amt*(trx_inscommprcnt+trx_commp_notrtnd)/100)+trx_inscommamt,
							a.installment_amt*trx_inscommprcnt/100),
							@linstlmnt_cmsn_vat=iif(@m_type='06',(a.installment_amt*(trx_inscommprcnt+trx_commp_notrtnd)/100)+trx_inscommamt,
							a.installment_amt*trx_inscommprcnt/100)*iif(a.trx_instaxable=1,b.vat_percent/100,0.00)
							from installment_trx a inner join sales_hd b on a.company=b.company and a.invtype=b.invtype and a.ref=b.ref
							where a.company=@m_cmp and a.invtype=@m_type and a.ref=@m_ref and a.installment_amt>0
							set @llcamt=@llcamt+@linstlmnt_cmsn+@linstlmnt_cmsn_vat
						end
					end
------------------------------------------------------------------------------------------------
					if @llcamt<@ljhamt and @m_exlc>0
						set @llcamt=@llcamt+@m_exlc;
	------------- Added on 2022-10-13 AA For yemen---------------------------------------------------------------------------------------
					if @lcountrycode=1 and @llcamt<@ljhamt
					begin
						select @lfcdiff=fcamt*(fcyrate-fixrate) from slfcypay where COMPANY=@m_cmp AND INVTYPE=@m_type AND REF=@m_ref
						and fcyrate>0 and fixrate>0
						set @lfcdiff=abs(isnull(@lfcdiff,0))
						set @llcamt=@llcamt+@lfcdiff
					end	
	------------------------------------------------------------------------------------------------------------------------------------																
				end
				Else
					set  @llcamt=(@llinvttl+@llextamt+@llcccommsn+@fqtyvat+iif(@lpricevattype=1,@llvat_amt_rcvd,0)-iif(@lNoDsc4SlPuJv=1,@llinvdsvl,0))
					*iif(@llfcyrate>@llfixrate,@llfcyrate,@llfixrate);

		  end
          If @lsrc='06' or (@lsrc='10' and @m_type='27')
		  begin
				select @llfcy=isnull(hd_fcy,''),@llopst_fcy=isnull(opst_fcy,''),@llisit_opst=isit_opst,@llxttl=opst_val,
				@llttl=hd_ltotal from aphdr with (NOLOCK) where hd_COMPANY=@m_cmp AND hd_TYPE=@m_type AND hd_REF=@m_ref;
				if @@rowcount=0
				begin
					set @errcode='122'
					return
				end
				If @llisit_opst=1 And @llfcy<>'' And @llopst_fcy=''
					set @llcamt=iif(@llttl>@llxttl,@llttl,@llxttl)
				Else
					set @llcamt=@llttl;
				if @llisit_opst=1 and dbo.value_balanced(@ljhamt,@llcamt)=0	
				    set @llcamt=@ljhamt;         
		  end
          If @lsrc='07' 
		  begin
				select @llinvcst=invcst,@llinvttl=invttl,@llinvdsvl=invdsvl,@llfcy=isnull(fcy,''),
				@llfcyrate=isnull(fcyrate,0),@llfixrate=isnull(fixrate,0),@llimfcval=imfcval,@llbranch=branch,
				@lvat_amt=vat_amt_paid,@llcttlexp=lcttlexp,@llcinvexp=lcinvexp,@llprodrate=prodrate,
				@lpriceincludevat=isnull(priceincludevat,0)
				from puhdr with (NOLOCK) where COMPANY=@m_cmp AND INVTYPE=@m_type AND REF=@m_ref;
				if @@rowcount=0
				begin
					set @errcode='122'
					return
				end

				If isnull(@llfcy,'')=''
				begin
------  Stopped on 2023-01-15 AA Bug when Vatregtype=3  ----------------------------------------------------
------	set  @llcamt=iif(@llbranch='Q',@llinvcst+@llimfcval+@lvat_amt+iif(@lNoDsc4SlPuJv=0,@llinvdsvl,0), 
------	  @llinvttl+@lvat_amt-iif(@lNoDsc4SlPuJv=1,@llinvdsvl,0))+(@llcttlexp-@llcinvexp);	
----------------------------------------------------------------------------------------------------------
------set @llcamt=@llinvcst+@llimfcval+@lvat_amt+iif(@lNoDsc4SlPuJv=0,@llinvdsvl,0) stopped on 202-01-07 AA
-------- Added on 2023-01-15 AA To fix the bug when Vatregtype=3 ----------------------------------------
--------- Added on 2023-01-07 AA -------------------------------------------------------------------------------------	
                    set  @llcamt=iif(@llbranch='Q',@llinvcst+@llimfcval+iif(@lVatregtype=3,0,@lvat_amt)
					+iif(@lNoDsc4SlPuJv=0,@llinvdsvl,0),	
					@llinvttl+@lvat_amt-iif(@lNoDsc4SlPuJv=1,@llinvdsvl,0))+(@llcttlexp-@llcinvexp);	
----------------------------------------------------------------------------------------------------------------------								     						 
					if dbo.value_balanced(@ljhamt,@llcamt)=0 
					  if @lsmsuser=288 set @llcamt=@ljhamt -- Jood 
					    else set @llcamt=@llinvcst+@llimfcval+iif(@lVatregtype=3,0,@lvat_amt)+iif(@lNoDsc4SlPuJv=0,@llinvdsvl,0) -- Added on 2023-01-15 AA Bug when Vatregtype=3
--						else set @llcamt=@llinvcst+@llimfcval+@lvat_amt+iif(@lNoDsc4SlPuJv=0,@llinvdsvl,0) Stopped on 2023-01-15 AA Bug when Vatregtype=3                       
------------------------------------------------------------------------------------------------						 						 						 						 
				end	 	 
				Else
				begin
				    if @llfixrate=0
					begin
					  select @llfixrate=isnull(curfix,0) from glcurr where curcode=@llfcy;
					  if @llfixrate=0 set @llfixrate=@llfcyrate;
					end
					IF @llbranch='Q' set @llcamt=(@llimfcval+iif(@lNoDsc4SlPuJv=0,@llinvdsvl,0))*@llfcyrate
					else set @llcamt=((@llinvttl-iif(@lNoDsc4SlPuJv=1,@llinvdsvl,0))*@llfcyrate)+(@llcttlexp-@llcinvexp);
					set @llcamt=@llcamt+(@lvat_amt*@llprodrate);
					
					if @llbranch='Q' set @llcamt=@llcamt+@llinvcst
					if @llfixrate>@llfcyrate set @llcamt=@llcamt+(@llfixrate-@llfcyrate)*@llinvttl
					
				end
		  end
          If @lsrc='22'  
		  begin
--				select @llcamt=phamt from pphdr with (NOLOCK) where phcomp=@m_cmp AND phtype=@m_type AND phref=@m_ref;
				select @llcamt=phamt+isnull(phcmp_socamt,cast(0 as float)) from pphdr with (NOLOCK) where phcomp=@m_cmp AND phtype=@m_type AND phref=@m_ref; -- Added on 2023-07-04 From KAss
				if @@rowcount=0
				begin
					set @errcode='122'
					return
				end       
		  end
------- Added on 2023-05-14 AA From Kassem -------------------------------------------------------
		   -- 2023-05-11 KAN Added Fixed Asset Codes Wich Abo Mohammed Always Overwrites It. LOL
 		   If @lsrc='33'  --Fixed Assets
		   begin
			   select @llcamt=case 
			                       when fh_fatype='3' then fh_ltotal+fh_ftoteqc+fh_dtlocal+fh_dtfceqc
			                       when fh_fatype='4' then fh_ltotal
			                       when fh_fatype='2' then @ljhamt
								   when fh_fatype='1' then fh_ltotal+fh_ftoteqc- hlldscnt + iif(isnull(priceincludevat,0)=0,vat_amt,0)
								   else fh_ltotal+fh_ftoteqc  end														  
			   from fahdr with (NOLOCK) where fh_company=@m_cmp AND fh_type=@m_type AND fh_ref=@m_ref;
			   if @@rowcount=0
			   begin
				    set @errcode='122'
				    return
			   end       
		   end		         
		   --end : -- 2023-05-11 KAN Added Fixed Asset Codes Wich Abo Mohammed Always Overwrites It. LOL
----------------------------------------------------------------------------------------------------		   		  
          If @lsrc='45'
		  begin
				----- 2022-08-21 KAN Modification for Rent System Trans To Be Posted With Payment In Different Currency 
				--select @llcamt=ttlamount from retrans_hd with (NOLOCK) where company=@m_cmp AND trtype=@m_type AND ref=@m_ref;
--------------- Stopped on 2024-05-25 AA by Kass -----------------------------------------------------------------------------------------------
				--select @llcamt=ttlamount+ISNULL(diffamount,0) from retrans_hd with (NOLOCK) where company=@m_cmp AND trtype=@m_type AND ref=@m_ref;
--------------- Added on 2024-05-25 AA from Kass -----------------------------------------------------------------------------------------------
				select @llcamt=case when isnull(lcnet,0)>isnull(lccnet,0) then isnull(lcnet,0) else isnull(lccnet,0) end + isnull(diffamount,0) 
				from retrans_hd with (NOLOCK) where company=@m_cmp and trtype=@m_type and ref=@m_ref; 
------------------------------------------------------------------------------------------------------------------------------------------------
				if @@rowcount=0
				begin
					set @errcode='122'
					return
				end       
		  end
		  If @lsrc='26'  
		  begin
				select @llcamt=lh_ltotal from lchdr with (NOLOCK) where lh_company=@m_cmp AND lh_type=@m_type AND lh_ref=@m_ref;
				if @@rowcount=0
				begin
					set @errcode='122'
					return
				end       
		  end	
          ---------------------------------------------------------------------------------------------------------------
		  if @lsrc in ('23','31') 
		  begin
		        --K.A.N OCT 21,2021  FOR TAX NEW TRANSACTIO
				if @lbrxfrm='V2'   --new transactio
				begin
				   select @llcamt=hd_ltotal from sdhdr with (NOLOCK) where hd_COMPANY=@m_cmp and hd_TYPE=@m_type and hd_TYPE=@m_type and hd_REF=@m_ref;
				   if @@rowcount=0
				   begin
				      set @errcode='122'
					  return
				   end
				   if @ljhamt>@llcamt set @llcamt=@ljhamt
				end
				else
				begin  ----K.A.N OCT 21,2021  FOR TAX NEW TRANSACTIO
				   if @lbrxfrm='S1'
				      select @llcamt=hd_ltotal from sdhdr where hd_COMPANY=@m_cmp AND hd_TYPE=@m_type AND 
				         hd_REF=@m_ref;
				      else select @llcamt=sdamount from sdaad_hd with (NOLOCK) where COMPANY=@m_cmp AND sdTYPE=@m_type and 
				         REF=@m_ref;
				
				      if @@rowcount=0
				      begin
					     set @errcode='122'
					     return
				      end
		        end   --K.A.N OCT 21,2021  FOR TAX NEW TRANSACTIO
		  end
		  --if @lsrc in ('23','31') 
		  --begin
		  --      if @lbrxfrm='S1'
				--select @llcamt=hd_ltotal from sdhdr where hd_COMPANY=@m_cmp AND hd_TYPE=@m_type AND 
				--   hd_REF=@m_ref;
				--else select @llcamt=sdamount from sdaad_hd with (NOLOCK) where COMPANY=@m_cmp AND sdTYPE=@m_type 
				--   AND REF=@m_ref;
				--if @@rowcount=0
				--begin
				--	set @errcode='122'
				--	return
				--end
		  --end
		  if @lsrc='03'
		  begin
		    set @llcamt=@ljhamt
		  end
		  if dbo.value_balanced(@ljhamt,@llcamt)=0		  
		  begin
				set @errcode='215'
				return
		  end
	end

    if  @src<>@lsrc
	begin
		set @errcode='124'
		return
	end	
	if dbo.value_balanced(@ljhamt,@jhlccrttl)=0 or dbo.value_balanced(@ljhamt,@jhlcdbttl)=0
	begin
		set @errcode='137'
		return
	end 
	declare @lc_db float,@lc_cr float,@fc_db float,@fc_cr float

	select @lptr=sum(1),@lc_db=sum(iif(jddbcr='D',jdlcamt,0)),@lc_cr=sum(iif(jddbcr='C',jdlcamt,0)),
	@fc_db=sum(iif(jddbcr='D' and isnull(jdcurr,'')<>'',jdfcamt,0)),@fc_cr=sum(iif(jddbcr='C' and isnull(jdcurr,'')<>'',jdfcamt,0))
	from gljrdtl with (NOLOCK) where jdcomp=@m_cmp AND jdTYPE=@m_type AND jdREF=@m_ref;
	if @@rowcount=0
	begin
		set @errcode='122'
		return
	end

	if @lptr<>@no_entries
	begin
		set @errcode='140'
		return
	end	
	if dbo.value_balanced(@lc_db,@lc_cr)=0 
	begin
		set @errcode='138'
		return
	end 
	
	if dbo.value_balanced(@lc_db,@ljhamt)=0 
	begin
		set @errcode='137'
		return
	end
	
--- Added on 2022-03-16 AA  
    if @caokmustfc=1 and dbo.value_balanced(@fc_db,@fc_cr)=0 and @llisit_opst=0
	set @errcode='139'
end



GO
/****** Object:  StoredProcedure [dbo].[glacct_balance]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[glacct_balance]
 @l_acct char(19),
 @l_fcy char(3),
 @acc_type int,  /* 0=local 1=forgin 2=both */
 @l_curbal   float = 0 output 
	
AS
BEGIN
declare @open_bal float =0
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @open_bal=(case @acc_type
	   when 0 then (select glopnbal from glchart where glkey=@l_acct and glcurrency=@l_fcy)
	   when 1 then (select fcopnbal from glchart where glkey=@l_acct and glcurrency=@l_fcy)
	   when 2 then (select sum(glopnbal) from glchart where glkey=@l_acct)
	   else 0
	   end)
    
    SET NOCOUNT ON
    set @l_curbal=(case @acc_type
       when 0 then (select SUM(case when jddbcr='D' then jdlcamt else -jdlcamt end) from gljrdtl
       where jdkey=@l_acct and jdcurr=@l_fcy)
       when 1 then (select SUM(case when jddbcr='D' then jdfcamt else -jdfcamt end) from gljrdtl
       where jdkey=@l_acct and jdcurr=@l_fcy)
       when 2 then (select SUM(case when jddbcr='D' then jdlcamt else -jdlcamt end) from gljrdtl
       where jdkey=@l_acct) 
       else 0
       end)      
    -- Insert statements for procedure here
 
	set @l_curbal=@l_curbal+@open_bal
END

















GO
/****** Object:  StoredProcedure [dbo].[import_charity_card_trx_by_linkserver]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[import_charity_card_trx_by_linkserver]
	@fmdate varchar(8),
	@todate varchar(8),
	@lsc_code char(6),
	@linkserver nvarchar(50),
	@errstatus int = 0 output
 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
-- 

   Declare @lcall_frm_job bit=0,
           @ldate varchar(10),
		   @lfdate varchar(8)='',
		   @ltdate varchar(8)='',
		   @dbcname nvarchar(10),
		   @dbc nvarchar(50),
		   @sqlmsg nvarchar(max)
		

    set @dbcname=db_name()
	

	


-- First check if link server exist

   if not exists(select name from sys.servers where name=@linkserver)
   begin
      set @errstatus=-99
	  return @errstatus
   end
   --IF not EXISTS (SELECT name FROM master.dbo.sysdatabases WHERE name = @dbcname)
   set @dbc=@linkserver+'.'+@dbcname+'.dbo.'

-- Process the data 
  if isnull(@fmdate,'')=''  and isnull(@todate,'')=''
   begin
         set @lcall_frm_job=1
	      set @ldate = convert(varchar(10),dateadd(dd,-1,getdate()),112)
	      set @lfdate=@ldate
		  set @ltdate=convert(varchar(10),getdate(),112) --@ldate
   end
   else
   begin
        set @lcall_frm_job=0
		set @lfdate=@fmdate
		set @ltdate=@todate
   end

 

------------------------------------------  Process pos_chhd Table  -----------------------------------------------------------------
 

		
		set @sqlmsg='merge pos_chhd as t 
		using (select * from '+@dbc+'pos_chhd with (NOLOCK) where posted=1 and sc_code='+@lsc_code
		+' and chdate between '+@lfdate+' and '+@ltdate+') as s
		on t.company=s.company and t.sc_code=s.sc_code and t.ref=s.ref
		when not matched then
		insert (company, ref, chdate, desctxt, lcamt, posted, entries, trdate, dbacc, cracc, chrcode, usrid, sc_code) 
		values (s.company, s.ref, s.chdate, s.desctxt, s.lcamt, s.posted, s.entries, s.trdate, s.dbacc, s.cracc, s.chrcode, s.usrid, s.sc_code);'
		
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-1	
			return	@errstatus		 				
		end

------------------------------------------  Process pos_chdt Table  -----------------------------------------------------------------
		
		set @sqlmsg='merge pos_chdt as t 
		using (select b.* from '+@dbc+'pos_chhd a with (NOLOCK) inner join '+@dbc+'pos_chdt b with (NOLOCK)
		on a.company=b.company and a.sc_code=b.sc_code and a.ref=b.ref
				where posted=1 and a.sc_code='+@lsc_code
			+'	and a.chdate between '+@lfdate+' and '+@ltdate+') as s
		on t.company=s.company and t.sc_code=s.sc_code and t.ref=s.ref and t.folio=s.folio
		when not matched then
		insert (company, ref, cstcode, lcamt, folio, sc_code)
		values (s.company, s.ref, s.cstcode, s.lcamt, s.folio, s.sc_code);'

		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-2	
			return @errstatus			 				
		end

------------------------------------------  Process pos_dsc Table  -----------------------------------------------------------------

		set @sqlmsg='merge pos_dsc as t 
		using (select c.* from '+@dbc+'pos_chhd a with (NOLOCK) inner join '+@dbc+'pos_chdt b with (NOLOCK)
		on a.company=b.company and a.sc_code=b.sc_code and a.ref=b.ref
		inner join '+@dbc+'pos_dsc c on b.company=c.dsccompany and b.cstcode=c.dsccard
				where posted=1 and a.sc_code='+@lsc_code
			+'	and a.chdate between '+@lfdate+' and '+@ltdate+') as s
		on t.dsccompany=s.dsccompany  and t.dsccard=s.dsccard 
		when not matched then
		insert (dsccompany, dsccard, dscname, dscaddress, dsctel, dscprtg, dscstatus, dscnote, modified, mnth_target, mnthbal, trgt_prcnt, prepaidamt, cardtype,
		        cardused, expdate, chrcode, cstpassw, crtdate, crtyear, cust_ttlsales,sales_grantd, ttl_grantd, vchr_value, vchr_used, mothercard, lastpaycard,
				nqati_openbal, nodsc4promo, employees_only, no_payment)
		values (s.dsccompany, s.dsccard, s.dscname, s.dscaddress, s.dsctel, s.dscprtg, s.dscstatus, s.dscnote, s.modified, s.mnth_target, s.mnthbal, s.trgt_prcnt, s.prepaidamt, s.cardtype,
		        s.cardused, s.expdate, s.chrcode, s.cstpassw, s.crtdate, s.crtyear, s.cust_ttlsales,sales_grantd, s.ttl_grantd, s.vchr_value, s.vchr_used, s.mothercard, s.lastpaycard,
				s.nqati_openbal, s.nodsc4promo, s.employees_only, s.no_payment);'

		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-2	
			return @errstatus			 				
		end
		commit transaction		

-------------------------------------------  Rebuild the card balances ---------------------------------------
          set @errstatus=0
          exec dbo.bld_charity_card_bal_swdruh @lsc_code, @errstatus output
	return	@errstatus
end











GO
/****** Object:  StoredProcedure [dbo].[import_from_swdruh_branch_by_linkserver]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[import_from_swdruh_branch_by_linkserver]
	@fmdate varchar(8),
	@todate varchar(8),
	@lsc_code char(6),
	@linkserver nvarchar(50),
	@pos_trx bit,
	@pp_trx bit,
	@pp_card bit,
	@whcnd varchar(200),
	@errstatus int = 0 output
 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
-- 

   Declare @lcall_frm_job bit=0,
           @ldate varchar(10),
		   @lfdate varchar(8)='',
		   @ltdate varchar(8)='',
		   @dbcname nvarchar(10),
		   @dbc nvarchar(50),
		   @sqlmsg nvarchar(max)
		

    set @dbcname=db_name()
	

	


-- First check if link server exist

   if not exists(select name from sys.servers where name=@linkserver)
   begin
      set @errstatus=-99
	  return @errstatus
   end
   --IF not EXISTS (SELECT name FROM master.dbo.sysdatabases WHERE name = @dbcname)
   set @dbc=@linkserver+'.'+@dbcname+'.dbo.'

-- Process the data 
  if isnull(@fmdate,'')=''  and isnull(@todate,'')=''
   begin
         set @lcall_frm_job=1
	      set @ldate = convert(varchar(10),dateadd(dd,-1,getdate()),112)
	      set @lfdate=@ldate
		  set @ltdate=convert(varchar(10),getdate(),112) --@ldate
   end
   else
   begin
        set @lcall_frm_job=0
		set @lfdate=@fmdate
		set @ltdate=@todate
   end

 

------------------------------------------  Process pos_chhd Table  -----------------------------------------------------------------
 
   if @pp_trx=1
   begin	
		set @sqlmsg='merge pos_chhd as t 
		using (select * from '+@dbc+'pos_chhd with (NOLOCK) where posted=1 and sc_code='+@lsc_code
		+' and chdate between '+@lfdate+' and '+@ltdate+') as s
		on t.company=s.company and t.sc_code=s.sc_code and t.ref=s.ref
		when not matched then
		insert (company, ref, chdate, desctxt, lcamt, posted, entries, trdate, dbacc, cracc, chrcode, usrid, sc_code) 
		values (s.company, s.ref, s.chdate, s.desctxt, s.lcamt, 0, s.entries, s.trdate, s.dbacc, s.cracc, s.chrcode, s.usrid, s.sc_code);'
		
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-1	
			return	@errstatus		 				
		end

------------------------------------------  Process pos_chdt Table  -----------------------------------------------------------------
		
		set @sqlmsg='merge pos_chdt as t 
		using (select b.* from '+@dbc+'pos_chhd a with (NOLOCK) inner join '+@dbc+'pos_chdt b with (NOLOCK)
		on a.company=b.company and a.sc_code=b.sc_code and a.ref=b.ref
				where posted=1 and a.sc_code='+@lsc_code
			+'	and a.chdate between '+@lfdate+' and '+@ltdate+') as s
		on t.company=s.company and t.sc_code=s.sc_code and t.ref=s.ref and t.folio=s.folio
		when not matched then
		insert (company, ref, cstcode, lcamt, folio, sc_code)
		values (s.company, s.ref, s.cstcode, s.lcamt, s.folio, s.sc_code);'

		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-2	
			return @errstatus			 				
		end

		declare @l_ps varchar(2)='PS'

		set @sqlmsg='merge gljrhdr as t 
		using (select * from '+@dbc+'gljrhdr with (NOLOCK) where jhposted=1 '
		+' and jhdate between '+@lfdate+' and '+@ltdate+' and brxfrm='+@l_ps+') as s
		 on t.jhcomp=s.jhcomp and t.jhtype=s.jhtype and t.jhref=s.jhref 
		 when not matched then 
		 insert (jhcomp, jhtype, jhref, jhdate, jhtext, jhamt, jhentries, jhsrc, jhsysdate, jhcurr, jhfcflag, jhrate
		, jhreleased, jhposted, lastupdt, jhlccrttl, jhlcdbttl, jhfccrttl, jhfcdbttl, jhimgrate
		, modified, serial_no, rcvdtrn, suspend, usrid, isbrtrx, brxref, brxfrm, jhcustno, hide_jv)
		 values (s.jhcomp,s.jhtype,s.jhref,s.jhdate,s.jhtext,s.jhamt,s.jhentries,s.jhsrc,s.jhsysdate,s.jhcurr,s.jhfcflag,s.jhrate
		,s.jhreleased,0,s.lastupdt,s.jhlccrttl,s.jhlcdbttl,s.jhfccrttl,s.jhfcdbttl,s.jhimgrate
		,s.modified,s.serial_no,1,s.suspend,s.usrid,s.isbrtrx,s.brxref,s.brxfrm,s.jhcustno,s.hide_jv);'
		
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-26
			return @errstatus
		end
		
		set @sqlmsg='merge gljrdtl as t 
		using (select b.* from '+@dbc+'gljrhdr a with (NOLOCK) inner join '+@dbc+'gljrdtl b with (NOLOCK)
		on a.jhcomp=b.jdcomp and a.jhtype=b.jdtype and a.jhref=b.jdref
		where jhposted=1 '
		+' and jhdate between '+@lfdate+' and '+@ltdate+' and brxfrm='+@l_ps+') as s
			on t.jdcomp=s.jdcomp and t.jdtype=s.jdtype and t.jdref=s.jdref and t.jdfolio=s.jdfolio
			when not matched then 
			insert (jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,
			jdfcamt ,jdcurr,jdfolio ,jdfolno ,jdsysdate ,jdsrc ,jdfc_imgval ,jdcstval ,
			cstkey ,brnno ,bracc ,brxref,match,rplct_post,taxcatId)
	 		values (s.jdcomp ,s.jdtype ,s.jdref ,s.jdkey ,s.jddate ,s.jdtext ,s.jdlcamt ,s.jddbcr ,
			s.jdfcamt ,s.jdcurr,s.jdfolio ,s.jdfolno ,s.jdsysdate ,s.jdsrc ,s.jdfc_imgval ,s.jdcstval ,
			s.cstkey ,s.brnno ,s.bracc ,s.brxref,s.match,0,s.taxcatId);'
		
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-27
			return @errstatus
		end
		commit transaction
	end
------------------------------------------  Process pos_dsc Table  -----------------------------------------------------------------
   if @pp_card=1 or @pp_trx=1
   begin
		set @sqlmsg='merge pos_dsc as t 
		using (select c.* from '+@dbc+'pos_chhd a with (NOLOCK) inner join '+@dbc+'pos_chdt b with (NOLOCK)
		on a.company=b.company and a.sc_code=b.sc_code and a.ref=b.ref
		inner join '+@dbc+'pos_dsc c on b.company=c.dsccompany and b.cstcode=c.dsccard
				where posted=1 and a.sc_code='+@lsc_code
			+'	and a.chdate between '+@lfdate+' and '+@ltdate+') as s
		on t.dsccompany=s.dsccompany  and t.dsccard=s.dsccard 
		when not matched then
		insert (dsccompany, dsccard, dscname, dscaddress, dsctel, dscprtg, dscstatus, dscnote, modified, mnth_target, mnthbal, trgt_prcnt, prepaidamt, cardtype,
		        cardused, expdate, chrcode, cstpassw, crtdate, crtyear, cust_ttlsales,sales_grantd, ttl_grantd, vchr_value, vchr_used, mothercard, lastpaycard,
				nqati_openbal, nodsc4promo, employees_only, no_payment)
		values (s.dsccompany, s.dsccard, s.dscname, s.dscaddress, s.dsctel, s.dscprtg, s.dscstatus, s.dscnote, s.modified, s.mnth_target, s.mnthbal, s.trgt_prcnt, s.prepaidamt, s.cardtype,
		        s.cardused, s.expdate, s.chrcode, s.cstpassw, s.crtdate, s.crtyear, s.cust_ttlsales,sales_grantd, s.ttl_grantd, s.vchr_value, s.vchr_used, s.mothercard, s.lastpaycard,
				s.nqati_openbal, s.nodsc4promo, s.employees_only, s.no_payment);'
       
	    begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-2	
			return @errstatus			 				
		end
		commit transaction	
	end	
--------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
    if @pos_trx=1
	begin
		set @sqlmsg='merge pos_hd as t '
		+ ' using '
		+ ' (select * from '+@dbc+'pos_hd b where '+@whcnd+') as s'
		+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
		+ ' when not matched then '
		+ ' insert (company, contr, ref, invdate, entries, slperson, paytype, chargepctg, chargeamt, invdspc, disccard, 
			cardtype, invttl, invcst, invdsvl, valafds, invpaid, pricetp, slcenter, invorrtrn, cashamt, modified, 
			salinvno, salctrno, tdatetime, cktype, geninv, rref, rcontr, ccpaid, ccconus, prepaidamt, fmbranch,
			mobile, fcamt, custtype, paycard, saned_amt,rtncshamt,dfvchramt,frc_rtncash,vat_amt_rcvd,taxfree_sales,
			hlldscnt,discamt,No_round_nm,PriceVatType,CashDsc4RtnPrepaid,outside_order,stcpay_amt,Qitaf_amt,vat_percent)'
		+ ' values (s.company,s.contr,s.ref,s.invdate,s.entries,s.slperson ,s.paytype,s.chargepctg,s.chargeamt'
		+ ' ,s.invdspc ,s.disccard ,s.cardtype ,s.invttl,s.invcst,s.invdsvl,s.valafds ,s.invpaid,s.pricetp,s.slcenter'
		+ ' ,s.invorrtrn ,s.cashamt,s.modified ,s.salinvno ,s.salctrno ,s.tdatetime ,s.cktype ,s.geninv ,s.rref'
		+ ' ,s.rcontr ,s.ccpaid ,s.ccconus,s.prepaidamt ,s.fmbranch,s.mobile ,s.fcamt ,s.custtype ,s.paycard,s.saned_amt,
			 s.rtncshamt,s.dfvchramt,s.frc_rtncash,s.vat_amt_rcvd,s.taxfree_sales,s.hlldscnt,
			 s.discamt,s.No_round_nm,s.PriceVatType,s.CashDsc4RtnPrepaid,s.outside_order,s.stcpay_amt,s.Qitaf_amt,s.vat_percent);'	
	
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-3
			return @errstatus
		end

		set @sqlmsg='merge pos_dt as t '
		+ ' using '
		+ ' (select a.* from '+@dbc+'pos_dt a inner join '+@dbc+'pos_hd b'
		+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
		+ ' where '+@whcnd+') as s'
		+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
		+ ' when not matched then '
		+ ' insert (company, contr, ref, cmbkey, qty, price, barcode, dscprsnt, srlno, rtrnd, dsc_amt, offer_amt
			, nqati_prcnt,taxtype) 
			values (s.company ,s.contr ,s.ref,s.cmbkey ,s.qty,s.price ,s.barcode ,s.dscprsnt ,s.srlno,s.rtrnd,
					s.dsc_amt,s.offer_amt,s.nqati_prcnt,s.taxtype);'
	

		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-4
			return 
		end

		set @sqlmsg='merge POSRTNINV as t '
		+ ' using '
		+ ' (select a.* from '+@dbc+'POSRTNINV a inner join '+@dbc+'pos_hd b'
		+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
		+ ' where '+@whcnd+') as s'
		+ ' on t.company=s.company and t.rcontr=s.rcontr and t.rref=s.rref '
		+ ' when not matched then '
		+ ' insert values (s.company,s.rcontr,s.rref,s.Contr,s.ref,s.rtnamt);'

		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-6
			return 
		end

		set @sqlmsg='merge POSPPCARD as t '
		+ ' using '
		+ ' (select a.* from '+@dbc+'POSPPCARD a inner join '+@dbc+'pos_hd b'
		+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
		+ ' where '+@whcnd+') as s'
		+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.disccard=s.disccard and t.paycard=s.paycard'
		+ ' when not matched then '
		+ ' insert (company, contr, ref, disccard, paytype, prepaidamt, paycard, nodsc4promo, prepaidamt_rtn)
			values (s.company,s.contr,s.ref,s.disccard,s.paytype,s.prepaidamt,s.paycard,s.nodsc4promo,s.prepaidamt_rtn);'

		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-9
			return @errstatus
		end

		set @sqlmsg='merge POSCCCARD as t '
		+ ' using '
		+ ' (select a.* from '+@dbc+'POSCCCARD a inner join '+@dbc+'pos_hd b'
		+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
		+ ' where '+@whcnd+') as s'
		+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.cccardno=s.cccardno and t.ccsrlno=s.ccsrlno'
		+ ' when not matched then '
		+ ' insert (company, contr, ref, cccardno, ccsrlno, cardtype, ccpaid, ccconus, chargepctg, chargeamt, cctype,
			approvl_no, TransDate, TransTime, TransNo, terminal_id)'
		+ ' values (s.company,s.contr,s.ref,s.cccardno,s.ccsrlno,s.cardtype,s.ccpaid,
			s.ccconus,s.chargepctg,s.chargeamt,s.cctype,s.approvl_no,s.TransDate,s.TransTime,s.TransNo,s.terminal_id);'

		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-9
			return 
		end

		commit transaction
	end
-------------------------------------------  Rebuild the card balances ---------------------------------------
          set @errstatus=0
          exec dbo.bld_charity_card_bal_swdruh @lsc_code, @errstatus output
	return	@errstatus
end











GO
/****** Object:  StoredProcedure [dbo].[import_from_swdruh_mainoffice_by_linkserver]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[import_from_swdruh_mainoffice_by_linkserver]
	@fmdate varchar(8),
	@todate varchar(8),
	@lsc_code char(6),
	@ok_items bit,
	@ok_slcenter bit,
	@ok_whno bit,
	@ok_glchart bit,
	@ok_users bit,
	@errstatus int = 0 output
 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
-- 

   Declare @lcall_frm_job bit=0,
           @ldate varchar(10),
		   @lfdate varchar(8)='',
		   @ltdate varchar(8)='',
		   @dbcname nvarchar(10),
		   @dbc nvarchar(50),
		   @sqlmsg nvarchar(max),
		   @linkserver nvarchar(50)
		
		set @linkserver='mainserver'
    set @dbcname=db_name()
	

	


-- First check if link server exist

   if not exists(select name from sys.servers where name=@linkserver)
   begin
      set @errstatus=-99
	  return @errstatus
   end
   --IF not EXISTS (SELECT name FROM master.dbo.sysdatabases WHERE name = @dbcname)
   set @dbc=@linkserver+'.'+@dbcname+'.dbo.'

-- Process the data 
  if isnull(@fmdate,'')=''  and isnull(@todate,'')=''
   begin
         set @lcall_frm_job=1
	      set @ldate = convert(varchar(10),dateadd(dd,-1,getdate()),112)
	      set @lfdate=@ldate
		  set @ltdate=convert(varchar(10),getdate(),112) --@ldate
   end
   else
   begin
        set @lcall_frm_job=0
		set @lfdate=@fmdate
		set @ltdate=@todate
   end
  if @ok_items=1
  begin
 		set @sqlmsg='merge stitems as t 
		using ( select distinct c.* from '+@dbc+'stunits a with (NOLOCK) 
		inner join '+@dbc+'stitems c with (NOLOCK)
		on a.itemno=c.itemno
		where len(isnull(a.lastupdt,''''))>0
		 and a.lastupdt between '+@lfdate+' and '+@ltdate+') as s
		on t.itemno=s.itemno
		when  matched then
		update set t.name=s.name,t.mgroup=s.mgroup,t.sgroup=s.sgroup,t.category=s.category,t.classkey=s.classkey,
		t.sgroup3=s.sgroup3,t.sgroup4=s.sgroup4,t.country=s.country,t.splycode=s.splycode,t.msplycode=s.msplycode,
		t.vprice=s.vprice
		when not matched then
		insert (name,itemno,mgroup,sgroup,category,fcy,classkey,exdatealw,noofsbitem,modified,
		sgroup3,sgroup4,company,lname,country,season,splycode,splylcact,itemtype,prntasmitm,prmdesc,
		scndesc,cmpprcnt,dsctype,brand_id,msplycode,modelno,nosales,vprice,fix_barcode,taxtype)
		values (s.name,s.itemno,s.mgroup,s.sgroup,s.category,s.fcy,s.classkey,s.exdatealw,s.noofsbitem,s.modified,
		s.sgroup3,s.sgroup4,s.company,s.lname,s.country,s.season,s.splycode,s.splylcact,s.itemtype,s.prntasmitm,s.prmdesc,
		s.scndesc,s.cmpprcnt,s.dsctype,s.brand_id,s.msplycode,s.modelno,s.nosales,s.vprice,s.fix_barcode,s.taxtype);'

		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-1	
			return	@errstatus		 				
		end
		
	-------  Process Stunits 


		set @sqlmsg='merge stunits as t 
		using ( select distinct a.* from '+@dbc+'stunits a with (NOLOCK) 
		inner join '+@dbc+'stitems c with (NOLOCK)
		on a.itemno=c.itemno 
		where len(isnull(a.lastupdt,''''))>0
		 and a.lastupdt between '+@lfdate+' and '+@ltdate+') as s
		on t.itemno=s.itemno and t.unicode=s.unicode 
        when  matched then
		update set t.lprice1=s.lprice1,t.lprice2=s.lprice2,t.lprice3=s.lprice3,t.lrcvdate=s.lrcvdate,t.lastissue=s.lastissue,
		t.maxdisc1=s.maxdisc1,t.lastupdt=s.lastupdt,t.mnmprice=s.mnmprice
		when not matched then
		insert (name,itemno,unicode,moved,openlcost,lcost,lprice1,fprice1,maxdisc1,lprice2,fprice2,maxdisc2,
		 lprice3,fprice3,maxdisc3,openfcost,fcost,lrcvdate,lastissue,openbal,curbal,rsvqty,
		 minstk,maxstk,orderlevel,leadday,Xdecimal,barcode,pack1,pkqty1,pack2,pkqty2,pack3,
		 pkqty3,company,modified,pack0,packtp,scnname,crtdate,inactive,prmcode,scncode,
		 cmbkey,mnmprice,lastupdt,modelno,splyitemno,splyinv,invprice,invqty,invpk,pp2,pp3)
		values (s.name,s.itemno,s.unicode,s.moved,s.openlcost,s.lcost,s.lprice1,s.fprice1,s.maxdisc1,s.lprice2,s.fprice2,s.maxdisc2,
		 s.lprice3,s.fprice3,s.maxdisc3,s.openfcost,s.fcost,s.lrcvdate,s.lastissue,s.openbal,s.curbal,s.rsvqty,
		 s.minstk,s.maxstk,s.orderlevel,s.leadday,s.Xdecimal,s.barcode,s.pack1,s.pkqty1,s.pack2,s.pkqty2,s.pack3,
		 s.pkqty3,s.company,s.modified,s.pack0,s.packtp,s.scnname,s.crtdate,s.inactive,s.prmcode,s.scncode,
		 s.cmbkey,s.mnmprice,s.lastupdt,s.modelno,s.splyitemno,s.splyinv,s.invprice,s.invqty,s.invpk,s.pp2,s.pp3);'
        
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-2	
			return	@errstatus		 				
		end
	
		commit transaction 
	end  		
------------------------------------------  Process pos_chhd Table  -----------------------------------------------------------------
 

   if @ok_glchart=1
   begin		
		set @sqlmsg='merge glchart as t 
		using (select * from '+@dbc+'glchart with (NOLOCK) where  section='+@lsc_code
		+') as s
		on t.glcomp=s.glcomp and t.glkey=s.glkey and t.glcurrency=s.glcurrency
		when not matched then
		insert (glname, glkey, glcomp, glcurbal, glopnbal, glopndate, glamnd, glacttyp, glgroup, glactive, glpurge, accontrol, glp_lcode,
		          glcurrency, glbal01, glbal02, glbal03, glbal04, glbal05, glbal06, glbal07, glbal08, glbal09, glbal10, glbal11, glbal12, 
                  glbal13, fccurbal, fcopnbal, fcbal01, fcbal02, fcbal03, fcbal04, fcbal05, fcbal06, fcbal07, fcbal08, fcbal09, fcbal10,
				   fcbal11, fcbal12, fcbal13, glsgrp, imopnbal, imcurbal, lastupdt, gleval, acprotect, pkey, chkey, cashbnk, modified, gllname,
				    section, isbracc, actlvl, glackind) 
		values (s.glname, s.glkey, s.glcomp, s.glcurbal, s.glopnbal, s.glopndate, s.glamnd, s.glacttyp, s.glgroup, s.glactive, s.glpurge, s.accontrol, s.glp_lcode,
		          s.glcurrency, s.glbal01, s.glbal02, s.glbal03, s.glbal04, s.glbal05, s.glbal06, s.glbal07, s.glbal08, s.glbal09, s.glbal10, s.glbal11, s.glbal12,
                  s.glbal13, s.fccurbal, s.fcopnbal, s.fcbal01, s.fcbal02, s.fcbal03, s.fcbal04, s.fcbal05, s.fcbal06, s.fcbal07, s.fcbal08, s.fcbal09, s.fcbal10,
				   s.fcbal11, s.fcbal12, s.fcbal13, s.glsgrp, s.imopnbal, s.imcurbal, s.lastupdt, s.gleval, s.acprotect, s.pkey, s.chkey, s.cashbnk, s.modified, s.gllname,
				    s.section, s.isbracc, s.actlvl, s.glackind);'
		
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-3	
			return	@errstatus		 				
		end
		commit transaction
	end
------------------------------------------  Process pos_chdt Table  -----------------------------------------------------------------
	if @ok_slcenter=1
	begin	
		set @sqlmsg='merge salecntr as t 
		using (select * from '+@dbc+'salecntr a with (NOLOCK) 
				where a.sc_code='+@lsc_code+') as s
		on t.dp_brno=s.dp_brno and t.dp_dept=s.dp_dept 
		when not matched then
		insert (dp_name, dp_brno, dp_dept, dp_cashser, dp_cslser, dp_oslser, dp_rcslser, dp_roslser, dp_custser, dp_expser,
	   	        dp_okdiff, dp_diffser, dp_mainwh, dp_rtrnwh, lastupdt, dp_comp, dp_fccrdt, nochg_print, modified, srcst, cstcode, 
                dp_crdcardac, dp_rplsac, dp_cardcomm, dp_lname, slwhsrc, prpaidcrdac, FRC_CRSL_FC, inv_form_no, sc_code,
				sanedcrd_act, no_of_invCopies, Vat_rcvd_act, custody_ac, stcpay_act, suspended, Qitaf_act)
		values (s.dp_name, s.dp_brno, s.dp_dept, s.dp_cashser, s.dp_cslser, s.dp_oslser, s.dp_rcslser, s.dp_roslser, s.dp_custser, s.dp_expser,
	   	        s.dp_okdiff, s.dp_diffser, s.dp_mainwh, s.dp_rtrnwh, s.lastupdt, s.dp_comp, s.dp_fccrdt, s.nochg_print, s.modified, s.srcst, s.cstcode, 
                s.dp_crdcardac, s.dp_rplsac, s.dp_cardcomm, s.dp_lname, s.slwhsrc, s.prpaidcrdac, s.FRC_CRSL_FC, s.inv_form_no, s.sc_code,
				s.sanedcrd_act, s.no_of_invCopies, s.Vat_rcvd_act, s.custody_ac, s.stcpay_act, s.suspended, s.Qitaf_act);'

        begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-4	
			return @errstatus			 				
		end
		commit transaction
	end
------------------------------------------  Process stwhous Table  -----------------------------------------------------------------
    if @ok_whno=1
	begin
		set @sqlmsg='merge stwhous as t 
		using (select * from '+@dbc+'stwhous a with (NOLOCK) 
				where a.sc_code='+@lsc_code+') as s
		on t.branch=s.branch and t.whno=s.whno 
		when not matched then
		insert (name, whno, branch, manager, phone, address, lastupdt, srwhs, modified, lname, fax, prnt_fsh, ac_end_prd, cstcode,
		 no_autosales, sc_code, suspended)
		values (s.name, s.whno, s.branch, s.manager, s.phone, s.address, s.lastupdt, s.srwhs, s.modified, s.lname, s.fax, s.prnt_fsh, s.ac_end_prd, s.cstcode,
		 s.no_autosales, s.sc_code, s.suspended);'

        begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-5	
			return @errstatus			 				
		end
		commit transaction
	end	
------------------------------------------  Process sysuse Table  -----------------------------------------------------------------
    if @ok_users=1
	begin
		set @sqlmsg='merge sysuse as t 
		using (select * from '+@dbc+'sysuse a with (NOLOCK)) as s
		on t.branch=s.branch and t.whno=s.whno 
		when not matched then
		insert (username, formkey, formsel, formname, password, fullname, showcost, acssdisc, chgprice, acssfqty, undrcost
		        , undrmin, belowbal, grp, company, uchgpas, shwacprtct, useprice1, useprice2, useprice3, maxdsc, maxfqty, currate 
                , usrbrn, msuser, uspright, uswhalw, uscntralw, usdptalw, uslatin, usslcsh, usslcrd, usslrcsh, usslrcrd, uspucsh
				, uspucrd, uspurcsh, uspurcrd, usjv, usrcv, usiss, uschqrcv, uschqiss, ustrnsin, ustrnsout, usbnkin, uscredit
				, usdebit, ussuspend, actallow, openallow, cstallow, editothers, suspend, usalwchgprs, dsplyothers, chgperiod
				, chgtdate, alwprntrpt, printinv, printtrx, printbarcode, onlinepost, showitmcst, usmagnetic, sendsms
				, usslprofit, posuser, inv_form_no, ushide_jv 
                , uschdlcshinv, uschdlcshrcv, uschdlchqrcv, usshowprofit, goblwmnmp, usfpalw, usfpimage, mobileuser
				, confirmPurchase, noovrdrft, onlyactrmt, confirmbr, passwordPDA, confirmtrnsfr, nopriceblwcost
				, mobilNo, OTP, web_rights, mgmtcnfrm, NorgstrNoSl, ussctnalw, Noslsblwcst, AlwChangeVAT, emp_code
				, blkassmbld)
		values (s.username, s.formkey, s.formsel, s.formname, s.password, s.fullname, s.showcost, s.acssdisc, s.chgprice, s.acssfqty, s.undrcost
		        , s.undrmin, s.belowbal, s.grp, s.company, s.uchgpas, s.shwacprtct, s.useprice1, s.useprice2, s.useprice3, s.maxdsc, s.maxfqty, s.currate 
                , s.usrbrn, s.msuser, s.uspright, s.uswhalw, s.uscntralw, s.usdptalw, s.uslatin, s.usslcsh, s.usslcrd, s.usslrcsh, s.usslrcrd, s.uspucsh
				, s.uspucrd, s.uspurcsh, s.uspurcrd, s.usjv, s.usrcv, s.usiss, s.uschqrcv, s.uschqiss, s.ustrnsin, s.ustrnsout, s.usbnkin, s.uscredit
				, s.usdebit, s.ussuspend, s.actallow, s.openallow, s.cstallow, s.editothers, s.suspend, s.usalwchgprs, s.dsplyothers, s.chgperiod
				, s.chgtdate, s.alwprntrpt, s.printinv, s.printtrx, s.printbarcode, s.onlinepost, s.showitmcst, s.usmagnetic, s.sendsms
				, s.usslprofit, s.posuser, s.inv_form_no, s.ushide_jv 
                , s.uschdlcshinv, s.uschdlcshrcv, s.uschdlchqrcv, s.usshowprofit, s.goblwmnmp, s.usfpalw, s.usfpimage, s.mobileuser
				, s.confirmPurchase, s.noovrdrft, s.onlyactrmt, s.confirmbr, s.passwordPDA, s.confirmtrnsfr, s.nopriceblwcost
				, s.mobilNo, s.OTP, s.web_rights, s.mgmtcnfrm, s.NorgstrNoSl, s.ussctnalw, s.Noslsblwcst, s.AlwChangeVAT, s.emp_code
				, s.blkassmbld);'

        begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-6	
			return @errstatus			 				
		end
		commit transaction	
	end  
	return	@errstatus
end











GO
/****** Object:  StoredProcedure [dbo].[Import_POS_invoices_from_branch]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-10-15@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[Import_POS_invoices_from_branch]
 @whr_condn nvarchar(200),
 @brlinksrvr nvarchar(30),
 @wth_slp_cntr bit,
 @no_of_invoices int output, -- used as input too to force import missing entries =1 ---= 0 stopped on 2023-10-22 AA
 @errstatus int  output -- = 0 stopped on 2022-04-04 AA
 --@STR_MSG VARCHAR(1000) OUT
	
AS
BEGIN
---- Added on 2024-10-14 AA new code to import the posmnfthcard table
---- Added on 2024-10-14 AA two new columns installment_amt_rtn & api_auto_connect to posinstlmnt_trx table 
---- Added on 2024-08-20 AA Added alwcsh_rtrn_L2yr to pos_slp table
---- Added on 2024-08-20 AA Added alw_taxed_invoice to pos_ctr table
---- Added on 2024-08-20 AA added clnt_taxcode to pos_ei table
---- Added on 2024-08-05 AA Resized @brlinksrvr parameter to nvarchar(30)
---- 2024-01-15 AA Added new code to improve importing possanedchrty table
---- 2024-01-15 AA Added new code to improve importing posinstlmnt_trx table
---- 2024-01-15 AA Added new code to improve importing posfcamt table
---- 2024-01-15 AA Added new code to improve importing poschrtinv table
---- 2024-01-15 AA Added new code to improve importing poscccard table
---- 2024-01-15 AA Added new code to improve importing posppcard table
---- 2024-01-15 AA Added new code to improve importing POSRTNINV table
---- 2024-01-15 AA Added new code to improve importing Posinvoffer table
---- 2024-01-15 AA Added new code to improve importing pos_dt table
---- Added on 2023-12-26 AA Added code to prevent improt pos_ei table for yemen
---- Added on 2023-12-26 AA New variable @lcountrycode to be used for yemen
---- Added on 2023-12-13 AA When ubl is missing import all missing columns in pos_ei
---- Added on 2023-11-14 AA removed  extra slpfpimage2 column from pos_slp table
---- Added on 2023-11-13 AA Added  missing comma in table pos_slp
---- Added on 2023-11-13 AA Added 1 missing column1 to pos_ei table
---- Added on 2023-11-13 AA Added 1 missing column to posinvoffer table
---- Added on 2023-11-13 AA Added 3 missing columns to pos_dt table 
---- Added on 2023-11-13 AA Added 3 missing columns to pos_hd table 
---- Added on 2023-11-13 AA Added 5 missing columns to pos_slp table 
---- Added on 2023-11-13 AA Added two columns to pos_ctr table 
---- Added on 2023-11-12 AA make relation with local pos_hd to insure to copy anything not exist in pos_hd
---- Added on 2023-10-22 AA using the parameter @no_of_invoices as input for the value of @limport_any_missing_data 
---- Added on 2023-10-22 AA Added new public variable named @limport_any_missing_data 
---- Added on 2023-10-22 AA  The @no_of_invoices is used as inpurt 
---- Added on 2023-10-22 AA to force import any missing data from any invoice tables
---- Added on 2023-10-22 AA to force import possanedchrty eventhough not import any invoice from pos_hd 
---- Added on 2023-10-22 AA Correct the saned_am column to saned_amt 
---- Added on 2023-10-21 AA Added installment_amt and bk_amount columns to pos_hd
---- Added on 2023-10-21 AA import the new table possanedchrty 
---- Added on 2023-10-09 AA import the new table posinstlmnt_trx
---- Added on 2023-10-09 AA Fixed a bug khalid not included @brlinksrvr+@dbc for pos_hd
---- Added on 2022-11-24 AA Added 4 columns missing from pos_slp
---- Added on 2022-04-04 AA when @errstatus = 1 means import invhstry table otherwise donot
---- Added on 2022-04-04 AA when @no_of_invoices=0 do not return and skip all transaction tables and go to pos_mny
---- Added on 2022-04-02 AA changed smalldatetime to datetime 
---- Added on 2020-11-28 invhstry is imported too.
---- Added on 2020-06-08 vat_percent column added to the pos_hd
---- Modified on 2019-04-06 added posinvoffer , stcpay & qitaf 
---- Added the new column prepaidamt_rtn in posppcard 2019-10-11
---- Added insert command for pos_slp table 2019-10-11
---- Added t.paycard=s.paycard for posppcard table link 2019-10-11
---- Ignored the @it_is_pos variable and fixed pos_mny  2019-10-11
	declare @sqlmsg nvarchar(max)='',
	@dbc nvarchar(14),
	@lcalcomp char(2),
	@yrcode char(4),
	@syscode int =2,
	@lcauseslctr bit=0,
	@it_is_pos bit=0,
	@lPVT_level numeric(1,0) =0
	declare @o_syscode numeric(2,0)=0,
	@loksctions bit =0,
	@lbranch char(2)='',
	@lslcenter char(2)='',
	@lsc_code  char(4)='',
	@l_pos int =0,
--- Added on 2022-04-04 AA --------------------
	@l_import_invhstry_tbl bit =0 
	set @l_import_invhstry_tbl=@errstatus
	set @errstatus=0
---------------------------------------------------
--- Added on 2023-10-22 AA ----------------------------------
    declare @limport_any_missing_data bit 
	set @limport_any_missing_data=cast(@no_of_invoices as bit)
	set @no_of_invoices=0
---------------------------------------------------------------
	set @l_pos=charindex('@',@brlinksrvr)
	if @l_pos>0
	begin
	   set @lsc_code=substring(@brlinksrvr,1,@l_pos-1)
	   set @brlinksrvr=substring(@brlinksrvr,@l_pos+1,14)
	   set @lbranch=substring(@lsc_code,1,2)
	   if len(@lsc_code)>2 set  @lslcenter=substring(@lsc_code,3,2)
	   set @lsc_code=''
	end
---------------------------------------------------------------------------------------------
	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
	declare @countrycode int =0 -- Added on 2023-12-26 AA
	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @syscode=isnull(sysno,2),@lcauseslctr=causeslctr,@lPVT_level=isnull(SysNo_PVT_level,0),@loksctions=isnull(oksctions,0),
	@countrycode=country -- Added on 2023-12-26 AA
	  from sysdb.dbo.glcalend 
	where calcomp=@lcalcomp and yrcode=@yrcode;
------------------------------------------------------------------------------------------------------------------------------
    set @o_syscode=@syscode
    if @lPVT_level=2 and len(@lbranch)>0
	begin
	    set @syscode=0
	    select @syscode=sysno
		 from stbranch where brnno=@lbranch;
		if @syscode=0 or @syscode is null set @syscode=@o_syscode
	end
	else
	if @lPVT_level=3 and @loksctions=1 and len(@lslcenter)>0 and len(@lbranch)>0 
	begin
	     select @lsc_code=sc_code from salecntr where dp_brno=@lbranch and dp_dept=@lslcenter;
		 if @lsc_code is not null and len(@lsc_code)>0
		 begin
		      set @syscode=0
		      select @syscode=sysno from glsction where sc_code=@lsc_code;
			  if @syscode=0 or @syscode is null set @syscode=@o_syscode
		 end
	end
-------------------------------------------------------------------------------------------------------------
    set @errstatus=0
    if @syscode<>3  set @dbc='.'+db_name()+'.dbo.'
	else 
	begin
------------------------------ Get Yrcode & Calcomp from Branch Boteequ  ----------------------------------------------
		declare @dynsql nvarchar(300),
				@params nvarchar(100)

		set @yrcode=''
		set @lcalcomp=''
		set @dynsql='select top 1 @yrcd=yrcode,@lclcmp=calcomp  from '+@brlinksrvr+'.posysdb.dbo.glcalend'
		+ ' order by yrcode desc';
		set @params='@yrcd char(4) output,@lclcmp char(2) output';
		exec sp_executesql @dynsql,@params,@yrcd=@yrcode output,@lclcmp=@lcalcomp output;
		if @@error<>0 or @@rowcount=0
		begin
		  	set @errstatus=-1
			return 
		end
		if @yrcode<>'' and @lcalcomp<>'' set @dbc='.pos'+@lcalcomp+'y'+substring(@yrcode,3,2)+'.dbo.'
		else
		begin
		  	set @errstatus=-2
			return 		  
		end
		set @it_is_pos=1
------------------------------------------------------------------------------------------------------------------------
	end
    
--BEGIN TRY
--------------------------------------------------------- import POS_SLP & POS_CTR -------------------------------------
    if @wth_slp_cntr=1
	begin
			set @sqlmsg='merge pos_ctr as t '
			+ ' using '+@brlinksrvr+@dbc+'pos_ctr as s'
			+ ' on t.ctrcompany=s.ctrcompany and t.ctrcode=s.ctrcode'
			+ ' when matched then '
			+ ' update set t.ctrloc = s.ctrloc ,t.ctrstatus = s.ctrstatus ,t.ctrnote = s.ctrnote ,t.ctrcash = s.ctrcash'
			+ ',t.ctrrpls = s.ctrrpls,t.ctrcard = s.ctrcard ,t.ctrsanet = s.ctrsanet,t.ctrsanetpctg = s.ctrsanetpctg'
			+ ',t.ctrvisa = s.ctrvisa ,t.ctrvisapctg = s.ctrvisapctg ,t.ctrmaster = s.ctrmaster'
			+ ',t.ctrmasterpctg = s.ctrmasterpctg,t.ctrothers = s.ctrothers ,t.ctrotherspctg = s.ctrotherspctg'
			+ ',t.slcenter = s.slcenter ,t.invser = s.invser,t.drwrcomport = s.drwrcomport,t.spath = s.spath'
			+ ',t.ctrserial = s.ctrserial,t.modified = s.modified,t.started = s.started ,t.ended = s.ended'
			+ ',t.drawer = s.drawer,t.cdisplay = s.cdisplay ,t.slmsg = s.slmsg,t.rtnmsg = s.rtnmsg'
			+ ',t.footmsg1 = s.footmsg1,t.footmsg2 = s.footmsg2,t.footmsg3 = s.footmsg3,t.saveinserver = s.saveinserver'
			+ ',t.saveinvall = s.saveinvall,t.scr_open = s.scr_open,t.slnoprint = s.slnoprint,t.rtnoprint = s.rtnoprint'
			+ ',t.ccconus = s.ccconus,t.upditem_hrs = s.upditem_hrs,t.updinv_hrs = s.updinv_hrs,t.prntbyclass = s.prntbyclass'
			+ ',t.sltype = s.sltype,t.rttype = s.rttype,t.rptype = s.rptype,t.icrptype = s.icrptype'
			+ ',t.ctrprpaid = s.ctrprpaid,t.rtfmothrs = s.rtfmothrs,t.magcard = s.magcard,t.usbdsply = s.usbdsply'
			+ ',t.dsplycomport = s.dsplycomport,t.rpt_grp_items = s.rpt_grp_items,
			   t.ctrsaned=s.ctrsaned,t.ctrsndecrpos=s.ctrsndecrpos,t.ctreftpos=s.ctreftpos ,t.eftport=s.eftport,
			   t.ntk_printer1=s.ntk_printer1,t.ntk_printer2=s.ntk_printer2,t.grp_printers=s.grp_printers,
			   t.grp_prnt_local=s.grp_prnt_local,t.ctrcredit=s.ctrcredit,t.ctrinstlmnt_pay=s.ctrinstlmnt_pay,
			   t.alw_taxed_invoice=s.alw_taxed_invoice' -- Added on 2024-08-20 AA
			+ ' when not matched then '
			+ ' insert (ctrcompany,ctrcode,ctrloc,ctrstatus ,ctrnote ,ctrcash ,ctrrpls ,ctrcard,ctrsanet'
			+ ',ctrsanetpctg,ctrvisa,ctrvisapctg ,ctrmaster,ctrmasterpctg,ctrothers,ctrotherspctg'
			+ ',slcenter,invser ,drwrcomport,spath ,ctrserial,modified,started,ended,drawer'
			+ ',cdisplay,slmsg,rtnmsg,footmsg1,footmsg2,footmsg3,saveinserver,saveinvall,scr_open'
			+ ',slnoprint,rtnoprint,ccconus ,upditem_hrs,updinv_hrs,prntbyclass ,sltype ,rttype'
			+ ',rptype ,icrptype,ctrprpaid ,rtfmothrs,magcard ,usbdsply,dsplycomport,rpt_grp_items,
				ctrsaned,ctrsndecrpos,eftport,ctreftpos,ntk_printer1,ntk_printer2,grp_printers,grp_prnt_local,
				cshRtn_f_o_b,ctrotherpay,ctrinstlmnt_pay,ctrcredit,alw_taxed_invoice)' -- Added on 2024-08-20 AA
			+ ' values (s.ctrcompany,s.ctrcode,s.ctrloc,s.ctrstatus ,s.ctrnote ,s.ctrcash ,s.ctrrpls ,s.ctrcard,s.ctrsanet'
			+ ',s.ctrsanetpctg,s.ctrvisa,s.ctrvisapctg ,s.ctrmaster,s.ctrmasterpctg,s.ctrothers,s.ctrotherspctg'
			+ ',s.slcenter,s.invser ,s.drwrcomport,s.spath ,s.ctrserial,s.modified,s.started,s.ended,s.drawer'
			+ ',s.cdisplay,s.slmsg,s.rtnmsg,s.footmsg1,s.footmsg2,s.footmsg3,s.saveinserver,s.saveinvall,s.scr_open'
			+ ',s.slnoprint,s.rtnoprint,s.ccconus ,s.upditem_hrs,s.updinv_hrs,s.prntbyclass ,s.sltype ,s.rttype'
			+ ',s.rptype ,s.icrptype,s.ctrprpaid ,s.rtfmothrs,s.magcard ,s.usbdsply,s.dsplycomport,s.rpt_grp_items,
				s.ctrsaned,s.ctrsndecrpos,s.eftport,s.ctreftpos,s.ntk_printer1,s.ntk_printer2,s.grp_printers,
				s.grp_prnt_local,s.cshRtn_f_o_b,s.ctrotherpay,s.ctrinstlmnt_pay,s.ctrcredit,s.alw_taxed_invoice);' -- Added on 2024-08-20 AA
			begin transaction
			exec sp_executesql @sqlmsg
			if @@error<>0 
			begin
				rollback transaction
				set @errstatus=-10
				return 
			end
			else commit transaction
	-- t.slppassword=s.slppassword,  is rempved 08-06-2014
			set @sqlmsg='merge pos_slp as t '
			+ ' using '+@brlinksrvr+@dbc+'pos_slp as s'
			+ ' on t.slpcompany=s.slpcompany and t.slpcode=s.slpcode'
			+ ' when matched then '
			+ ' update set t.slpname=s.slpname,t.slpaddress=s.slpaddress,t.slptel=s.slptel,'
			+ ' t.slpchgqty=s.slpchgqty,t.slpchgprice=s.slpchgprice'
			+ ',t.slpdelline=s.slpdelline,t.slpothersinv=s.slpothersinv,t.slpreturn=s.slpreturn,t.slpstatus=s.slpstatus,'
			+ ' t.slpalowdisc=s.slpalowdisc,t.slpmaxdisc=s.slpmaxdisc,t.slppricetp=s.slppricetp'
			+ ',t.slpalowcancel=s.slpalowcancel,t.slpalowopdr=s.slpalowopdr,t.modified=s.modified,t.slpalowexit=s.slpalowexit,'
			+ ' t.slprtwoinv=s.slprtwoinv,t.slpblowbal=s.slpblowbal,t.scr_open=s.scr_open'
			+ ',t.alwitmdsc=s.alwitmdsc,t.maxitmdsc=s.maxitmdsc ,t.alwuserpls=s.alwuserpls ,t.alwuseicrpls=s.alwuseicrpls,'
			+ 't.slpmagnetic=s.slpmagnetic,t.alwusebrrtn=s.alwusebrrtn,t.alwreprint=s.alwreprint'
			+ ',t.frcrplinv=s.frcrplinv,t.catch_thief=s.catch_thief,t.sold_once=s.sold_once,t.only_scan_bc=s.only_scan_bc,'
			+ 't.stop_item_column=s.stop_item_column,t.slpfpalw=s.slpfpalw,t.slpfpimage=s.slpfpimage'
			+ ',t.slcenter=s.slcenter,t.salesquota=s.salesquota,t.commissionP=s.commissionP,t.bonus=s.bonus,
				t.supervisor=s.supervisor,t.ReadInvByBarcd=s.ReadInvByBarcd,
				t.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,
				t.alwcshcardpay=s.alwcshcardpay,t.slp_hlldscamtMAX=s.slp_hlldscamtMAX,t.alwprnttmpinv=s.alwprnttmpinv,
				t.ignore_mnmprice=s.ignore_mnmprice,t.NoExceed_hll=s.NoExceed_hll,t.slpfpimage2=s.slpfpimage2,
				t.showallsuspndinv=s.showallsuspndinv,t.nodelchgmny=s.nodelchgmny,t.delitmbybrcd=s.delitmbybrcd,
				t.noinvprint_atsave=s.noinvprint_atsave, t.No_item_srch_in_inv=s.No_item_srch_in_inv,
				t.No_dsc_if_no_mobile= s.No_dsc_if_no_mobile,t.slpfpimage3= s.slpfpimage3,
				t.alwcsh_rtrn_L2yr=s.alwcsh_rtrn_L2yr' -- Added on 2024-08-20 AA
			+ ' when not matched then '
			+ ' insert (slpcompany, slpcode, slpname, slpaddress, slptel, slppassword, slpchgqty, slpchgprice, slpdelline,
				slpothersinv, slpreturn, slpstatus, slpalowdisc, slpmaxdisc, slppricetp, slpalowcancel, slpalowopdr, 
				modified, slpalowexit, slprtwoinv, slpblowbal, scr_open, alwitmdsc, maxitmdsc, alwuserpls, alwuseicrpls,
				slpmagnetic, alwusebrrtn, alwreprint, frcrplinv, catch_thief, sold_once, only_scan_bc, 
				stop_item_column, slpfpalw, slpfpimage, slcenter, salesquota, commissionP, bonus, supervisor, ReadInvByBarcd,
				alwrtncash, alwmtchrtn, alwinvtrnsfr, alwcshcardpay, slp_hlldscamtMAX, alwprnttmpinv, 
				ignore_mnmprice, NoExceed_hll,slpfpimage2,showallsuspndinv,nodelchgmny,delitmbybrcd,
				noinvprint_atsave, No_item_srch_in_inv, No_dsc_if_no_mobile, slpfpimage3,alwcsh_rtrn_L2yr)'
			+ ' values (s.slpcompany,s.slpcode,s.slpname,s.slpaddress,s.slptel,s.slppassword,s.slpchgqty,s.slpchgprice'
			+ ',s.slpdelline,s.slpothersinv,s.slpreturn,s.slpstatus,s.slpalowdisc,s.slpmaxdisc,s.slppricetp'
			+ ',s.slpalowcancel,s.slpalowopdr,s.modified,s.slpalowexit,s.slprtwoinv,s.slpblowbal,s.scr_open'
			+ ',s.alwitmdsc,s.maxitmdsc ,s.alwuserpls ,s.alwuseicrpls,s.slpmagnetic,s.alwusebrrtn,s.alwreprint'
			+ ',s.frcrplinv,s.catch_thief,s.sold_once,s.only_scan_bc,s.stop_item_column,s.slpfpalw,s.slpfpimage'
			+ ',s.slcenter,s.salesquota,s.commissionP,s.bonus,s.supervisor,s.ReadInvByBarcd,s.alwrtncash,
			   s.alwmtchrtn,s.alwinvtrnsfr,s.alwcshcardpay,s.slp_hlldscamtMAX,s.alwprnttmpinv,s.ignore_mnmprice,
			   s.NoExceed_hll,s.slpfpimage2,s.showallsuspndinv,s.nodelchgmny,s.delitmbybrcd,
			   s.noinvprint_atsave, s.No_item_srch_in_inv, s.No_dsc_if_no_mobile, s.slpfpimage3,s.alwcsh_rtrn_L2yr);' -- Added on 2024-08-20 AA
			begin transaction
			exec sp_executesql @sqlmsg
			if @@error<>0 
			begin
				rollback transaction
				set @errstatus=-11
				return 
			end
			else commit transaction
	end
------------------------------------------------------------------------------------------------------------------------
	set @sqlmsg='merge pos_hd as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_hd b where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, invdate, entries, slperson, paytype, chargepctg, chargeamt, invdspc, disccard, 
		cardtype, invttl, invcst, invdsvl, valafds, invpaid, pricetp, slcenter, invorrtrn, cashamt, modified, 
		salinvno, salctrno, tdatetime, cktype, geninv, rref, rcontr, ccpaid, ccconus, prepaidamt, fmbranch,
		mobile, fcamt, custtype, paycard, saned_amt,rtncshamt,dfvchramt,frc_rtncash,vat_amt_rcvd,taxfree_sales,
		hlldscnt,discamt,No_round_nm,PriceVatType,CashDsc4RtnPrepaid,outside_order,stcpay_amt,Qitaf_amt,vat_percent,bk_amount,installment_amt,
		slcode,inv_copies_no,zatca_rounding)'
	+ ' values (s.company,s.contr,s.ref,s.invdate,s.entries,s.slperson ,s.paytype,s.chargepctg,s.chargeamt'
    + ' ,s.invdspc ,s.disccard ,s.cardtype ,s.invttl,s.invcst,s.invdsvl,s.valafds ,s.invpaid,s.pricetp,s.slcenter'
    + ' ,s.invorrtrn ,s.cashamt,s.modified ,s.salinvno ,s.salctrno ,s.tdatetime ,s.cktype ,s.geninv ,s.rref'
    + ' ,s.rcontr ,s.ccpaid ,s.ccconus,s.prepaidamt ,s.fmbranch,s.mobile ,s.fcamt ,s.custtype ,s.paycard,s.saned_amt,
	     s.rtncshamt,s.dfvchramt,s.frc_rtncash,s.vat_amt_rcvd,s.taxfree_sales,s.hlldscnt,
		 s.discamt,s.No_round_nm,s.PriceVatType,s.CashDsc4RtnPrepaid,s.outside_order,s.stcpay_amt,s.Qitaf_amt,s.vat_percent,s.bk_amount,s.installment_amt,
		 s.slcode,s.inv_copies_no,s.zatca_rounding);'	
	
	begin transaction
	exec sp_executesql @sqlmsg
	set @no_of_invoices=@@ROWCOUNT
	if @@error<>0 --or @no_of_invoices=0 --- Stopped on 2022-04-04 AA
	begin
		rollback transaction
		set @errstatus=-3
		if @no_of_invoices=0 set @errstatus=0
		return 
	end


--- Added on 2022-04-04 AA -----
	if @no_of_invoices>0 or @limport_any_missing_data=1  -- Added on 2023-10-22 AA
	begin
---------------------------------
--  Make sure that the field NQATI_PRCNT is available in pos_dt
			declare @is_nqati_there varchar(30)=''
			set @is_nqati_there=iif(EXISTS(SELECT name FROM sys.columns
			WHERE Name = N'nqati_prcnt' AND OBJECT_ID = OBJECT_ID(N'pos_dt')),',s.nqati_prcnt);',');');
	
			set @sqlmsg='merge pos_dt as t '
			+ ' using '
			+ ' (select a.* from '+@brlinksrvr+@dbc+'pos_dt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
			+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
			+ ' inner join pos_hd c on b.company=c.company and b.contr=c.contr and b.ref=c.ref'  -- Added on 2024-01-15 AA to fix problems in taba
			+ ' where '+@whr_condn+') as s'
			+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
			+ ' when not matched then '
			+ ' insert (company, contr, ref, cmbkey, qty, price, barcode, dscprsnt, srlno, rtrnd, dsc_amt, offer_amt
				, nqati_prcnt,taxtype,item_price_net,item_vat,invdscamt) 
				values (s.company ,s.contr ,s.ref,s.cmbkey ,s.qty,s.price ,s.barcode ,s.dscprsnt ,s.srlno,s.rtrnd,
						s.dsc_amt,s.offer_amt,s.nqati_prcnt,s.taxtype,s.item_price_net,s.item_vat,s.invdscamt);'
	


			exec sp_executesql @sqlmsg
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-4
				return 
			end
		--------
	


		-------- Posinvoffer 
			set @sqlmsg='merge Posinvoffer as t '
			+ ' using '
			+ ' (select a.* from '+@brlinksrvr+@dbc+'Posinvoffer a inner join '+@brlinksrvr+@dbc+'pos_hd b'
			+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
			+ ' inner join pos_hd c on b.company=c.company and b.contr=c.contr and b.ref=c.ref'  -- Added on 2024-01-15 AA to fix problems in taba
			+ ' where '+@whr_condn+') as s'
			+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
			+ ' when not matched then '
			+ ' insert (company, contr, ref, srlno, msbrcd_srlno, offer_type, itemgroup, minqty, givenamt, givenqty,Max2buy)
				values (s.company ,s.contr ,s.ref,s.srlno, s.msbrcd_srlno, s.offer_type, s.itemgroup, s.minqty,
				 s.givenamt, s.givenqty,s.Max2buy);'

	


			exec sp_executesql @sqlmsg
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-6
				return 
			end

			set @sqlmsg='merge POSRTNINV as t '
			+ ' using '
			+ ' (select a.* from '+@brlinksrvr+@dbc+'POSRTNINV a inner join '+@brlinksrvr+@dbc+'pos_hd b'
			+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
			+ ' inner join pos_hd c on b.company=c.company and b.contr=c.contr and b.ref=c.ref'  -- Added on 2024-01-15 AA to fix problems in taba
			+ ' where '+@whr_condn+' ) as s'
			+ ' on t.company=s.company and t.rcontr=s.rcontr and t.rref=s.rref '
			+ ' when not matched then '
			+ ' insert values (s.company,s.rcontr,s.rref,s.Contr,s.ref,s.rtnamt);'

			exec sp_executesql @sqlmsg
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-7
				return 
			end

			set @sqlmsg='merge POSPPCARD as t '
			+ ' using '
			+ ' (select a.* from '+@brlinksrvr+@dbc+'POSPPCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
			+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
			+ ' inner join pos_hd c on b.company=c.company and b.contr=c.contr and b.ref=c.ref'  -- Added on 2024-01-15 AA to fix problems in taba
			+ ' where '+@whr_condn+' ) as s'
			+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.disccard=s.disccard and t.paycard=s.paycard'
			+ ' when not matched then '
			+ ' insert (company, contr, ref, disccard, paytype, prepaidamt, paycard, nodsc4promo, prepaidamt_rtn)
				values (s.company,s.contr,s.ref,s.disccard,s.paytype,s.prepaidamt,s.paycard,s.nodsc4promo,s.prepaidamt_rtn);'

			exec sp_executesql @sqlmsg
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-9
				return 
			end

			set @sqlmsg='merge POSCCCARD as t '
			+ ' using '
			+ ' (select a.* from '+@brlinksrvr+@dbc+'POSCCCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
			+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
			+ ' inner join pos_hd c on b.company=c.company and b.contr=c.contr and b.ref=c.ref'  -- Added on 2024-01-15 AA to fix problems in taba
			+ ' where '+@whr_condn+' ) as s'
			+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.cccardno=s.cccardno and t.ccsrlno=s.ccsrlno'
			+ ' when not matched then '
			+ ' insert (company, contr, ref, cccardno, ccsrlno, cardtype, ccpaid, ccconus, chargepctg, chargeamt, cctype,
				approvl_no, TransDate, TransTime, TransNo, terminal_id)'
			+ ' values (s.company,s.contr,s.ref,s.cccardno,s.ccsrlno,s.cardtype,s.ccpaid,
				s.ccconus,s.chargepctg,s.chargeamt,s.cctype,s.approvl_no,s.TransDate,s.TransTime,s.TransNo,s.terminal_id);'

			exec sp_executesql @sqlmsg
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-8
				return 
			end

			set @sqlmsg='merge poschrtinv as t '
			+ ' using '
			+ ' (select a.* from '+@brlinksrvr+@dbc+'poschrtinv a inner join '+@brlinksrvr+@dbc+'pos_hd b'
			+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
			+ ' inner join pos_hd c on b.company=c.company and b.contr=c.contr and b.ref=c.ref'  -- Added on 2024-01-15 AA to fix problems in taba
			+ ' where '+@whr_condn+' ) as s'
			+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
			+ ' when not matched then '
			+ ' insert values (s.company,s.contr,s.ref,s.hllamt,s.chrcode);'

			exec sp_executesql @sqlmsg
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-5
				return 
			end

			set @sqlmsg='merge posfcamt as t '
			+ ' using '
			+ ' (select a.* from '+@brlinksrvr+@dbc+'posfcamt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
			+ ' inner join pos_hd c on b.company=c.company and b.contr=c.contr and b.ref=c.ref'  -- Added on 2024-01-15 AA to fix problems in taba
			+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
			+ ' where '+@whr_condn+') as s'
			+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
			+ ' when not matched then '
			+ ' insert values (s.company,s.contr,s.ref,s.fcy,s.fcamt,s.fcyrate,s.lcamt,s.srlno);'

			exec sp_executesql @sqlmsg
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-9
				return 
			end
			if @countrycode=0 --- Added on 2023-12-26 AA
			begin
------------------add 02-09-2023 -- by khalid
				set @sqlmsg='merge pos_ei as t '
					+ ' using '
					+ ' (select a.* from '+@brlinksrvr+@dbc+'pos_ei a inner join '+@brlinksrvr+@dbc+'pos_hd b'  -- Fixed bug must include @brlinksrvr+@dbc
					+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
					+ ' inner join pos_hd c on b.company=c.company and b.contr=c.contr and b.ref=c.ref'  -- Add to fix problems in taba
					+ ' where '+@whr_condn+') as s'
					+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
					+ ' when matched and t.ubl is null then '  --- Added on 2023-12-12 AA to import ubl
					+ ' update set t.previousInvoiceHash=s.previousInvoiceHash,t.QRvalue=s.QRvalue,t.CurrentInvoiceHash=s.CurrentInvoiceHash,t.ubl=s.ubl,t.InvoiceCounterValue=s.InvoiceCounterValue,'
					+ ' t.einv_is_sent=s.einv_is_sent,t.reason_not_sent=s.reason_not_sent,t.uuid=s.uuid,t.folio=s.folio,t.deviceSN=s.deviceSN, '
					+ ' t.clnt_taxcode=s.clnt_taxcode ' -- Added on 2024-08-20 AA 
					+ ' when not matched then '
					+ ' insert values (s.company,s.contr,s.ref,s.InvoiceTypeCode,s.tax_invoice_type,s.uuid,s.previousInvoiceHash,s.QRvalue'
					+ ',s.Order_ref_id,s.ContractDocRef,s.PaymentType,s.InvoiceTransactionCode,s.DebitCreditReason,s.CurrentInvoiceHash'
					+ ',s.InvoiceCounterValue,s.LatestDeliveryDate,s.einv_is_sent,s.ubl,s.invoice_charges'
					+ ',s.ExemptionReason,s.EXEMPTIONCODE,s.reason_not_sent,s.zatca_datetime,s.folio,s.deviceSN,s.zatca_conn,s.clnt_taxcode);' -- Added on 2024-08-20 AA
					exec sp_executesql @sqlmsg
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-5
						return 
					end
			end
		------------------added on 2023-10-09 AA For posinstlmnt_trx ---------------------------------------------------------------------------------
			set @sqlmsg='merge posinstlmnt_trx as t '
				+ ' using '
				+ ' (select a.* from '+@brlinksrvr+@dbc+'posinstlmnt_trx a inner join '+@brlinksrvr+@dbc+'pos_hd b'  -- Fixed bug must include @brlinksrvr+@dbc
				+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
				+ ' inner join pos_hd c on b.company=c.company and b.contr=c.contr and b.ref=c.ref'  -- Added on 2024-01-15 AA to fix problems in taba
				+ ' where '+@whr_condn+') as s'
				+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
				+ ' when not matched then '
				+ ' insert values (s.company,s.contr,s.ref,s.trx_inscode,s.trx_cmsn_pd_by_buyer,s.trx_instaxable,s.trx_inscommprcnt,s.trx_inscommamt,
					s.installment_amt,s.trx_buyer_mobile,s.trx_confirmed_code,s.trx_instlmnt_vourcher,s.trx_buyer_name,s.trx_commp_notrtnd,
					s.installment_amt_rtn,s.api_auto_connect);'
				exec sp_executesql @sqlmsg
				if @@error<>0
				begin
					rollback transaction
					set @errstatus=-5
					return 
				end
		--------------------------------------------------------------------------------------------------------------------------------------------------
		------------------added on 2023-10-21 AA For possanedchrty table  ---------------------------------------------------------------------------------
			set @sqlmsg='merge possanedchrty as t '
				+ ' using '
				+ ' (select a.* from '+@brlinksrvr+@dbc+'possanedchrty a inner join '+@brlinksrvr+@dbc+'pos_hd b'  
				+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
				+ ' inner join pos_hd c on b.company=c.company and b.contr=c.contr and b.ref=c.ref'  -- Added on 2024-01-15 AA to fix problems in taba
				+ ' where '+@whr_condn+') as s'
				+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
				+ ' when not matched then '
				+ ' insert values (s.company,s.contr,s.ref, s.chrty_code, s.mobileno, s.approval_code, s.saned_amt);'

				exec sp_executesql @sqlmsg
				if @@error<>0
				begin
					rollback transaction
					set @errstatus=-5
					return 
				end
--------------------------------------------------------------------------------------------------------------------------------------------------
------------------added on 2024-10-14 AA For posmnfthcard ---------------------------------------------------------------------------------
			set @sqlmsg='merge posmnfthcard as t '
				+ ' using '
				+ ' (select a.* from '+@brlinksrvr+@dbc+'posmnfthcard a inner join '+@brlinksrvr+@dbc+'pos_hd b'  -- Fixed bug must include @brlinksrvr+@dbc
				+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
				+ ' inner join pos_hd c on b.company=c.company and b.contr=c.contr and b.ref=c.ref'  -- Added on 2024-01-15 AA to fix problems in taba
				+ ' where '+@whr_condn+') as s'
				+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
				+ ' when not matched then '
				+ ' insert values (s.company, s.contr, s.ref, s.clncard, s.itemcode, s.paidamt, s.mnorgname, s.mnorgtaxcode, s.invoiceType, 
				    s.balancetype, s.mnqty, s.manafithtrxid, s.paidamt_rtn, s.mn_vat_amt, s.requestid);'
				exec sp_executesql @sqlmsg
				if @@error<>0
				begin
					rollback transaction
					set @errstatus=-5
					return 
				end
		--------------------------------------------------------------------------------------------------------------------------------------------------

				commit transaction
--- Added on 2022-04-04 AA
	end 
	else rollback transaction
	------------------added & Stopped on 2023-10-22 AA For possanedchrty table  ---------------------------------------------------------------------------------
	--if @no_of_invoices=0
	--begin
	--	set @sqlmsg='merge possanedchrty as t '
	--		+ ' using '
	--		+ ' (select a.* from '+@brlinksrvr+@dbc+'possanedchrty a inner join '+@brlinksrvr+@dbc+'pos_hd b'  
	--		+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	--		+ ' where '+@whr_condn+') as s'
	--		+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	--		+ ' when not matched then '
	--		+ ' insert values (s.company,s.contr,s.ref, s.chrty_code, s.mobileno, s.approval_code, s.saned_amt);'

	--	begin transaction
	--	exec sp_executesql @sqlmsg
	--	if @@error<>0
	--	begin
	--		rollback transaction
	--		set @errstatus=-5
	--		return 
	--	end
	--	commit transaction
 --    end
----------------------------------------------------------------------------------------------------------------------------------
	declare @new_cndn nvarchar(250),
	        @lpos int =0
	set @lpos=charindex('tdatetime',@whr_condn)
	set @new_cndn=substring(@whr_condn,@lpos,200)
	set @new_cndn=replace(replace(@new_cndn,'tdatetime','mnydate'),'datetime','date')
	set @sqlmsg='merge pos_mny as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_mny  where '+@new_cndn+') as s'	
	+ ' on t.company=s.company and t.contr=s.contr and t.mnydate=s.mnydate and t.slpcode=s.slpcode'
    + ' when not matched then '
	+ ' insert (company,contr,mnydate,slpcode,oner,fiver,tenr,twntyr,fiftyr,hundredr,
                twohandr,fivehandr,modified,rtnval,network,prepaidamt,scrtnval,scnetwork,scprepaidamt,
				sccash,saned_amt,scsaned_amt,fiveh,tenh,twntyfiveh,fiftyh,stcpay_amt,qitaf_amt)                
	    values (s.company,s.contr,s.mnydate,s.slpcode,s.oner,s.fiver,s.tenr,s.twntyr,s.fiftyr,s.hundredr,
                s.twohandr,s.fivehandr,s.modified,s.rtnval,s.network,s.prepaidamt,s.scrtnval ,s.scnetwork,
				s.scprepaidamt,s.sccash,s.saned_amt,s.scsaned_amt,s.fiveh,s.tenh,s.twntyfiveh,
	            s.fiftyh,s.stcpay_amt,s.qitaf_amt);'

	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-10
	end
	else commit transaction

---------------------------------------  Import invhstry from branch --------------------------------

    set @new_cndn=replace(replace(@whr_condn,'b.','a.'),'a.slcenter','b.slcenter')
	set @sqlmsg='merge invhstry as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'invhstry a inner join '+@brlinksrvr+@dbc+'pos_ctr b'
	+ ' on a.company=b.ctrcompany and a.contr=b.ctrcode '
	+ ' where '+@new_cndn+') as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno and t.ref_id=s.ref_id '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, cmbkey, qty, price, barcode, dscprsnt, srlno, invdate, tdatetime, slperson, invorrtrn, 
	            deletedx, ref_id, qtydel, retreived, offer_amt)
		values (s.company, s.contr, s.ref, s.cmbkey, s.qty, s.price, s.barcode, s.dscprsnt, s.srlno, s.invdate, s.tdatetime, s.slperson, s.invorrtrn, 
	            s.deletedx, s.ref_id, s.qtydel, s.retreived, s.offer_amt);'
--- Added on 2022-04-04 AA -----
	if @l_import_invhstry_tbl=1
	begin
---------------------------------
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-11
		end
		else commit transaction
	end
end 


GO
/****** Object:  StoredProcedure [dbo].[Import_POS_invoices_from_POS]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-10-15@@$$##  Important : must have this line as first line which contains the last update date for the this file
CREATE PROCEDURE [dbo].[Import_POS_invoices_from_POS]
 @whr_condn nvarchar(200),
 @brlinksrvr nvarchar(20), -- nvarchar(15)
 @no_of_invoices int output,
 @errstatus int = 0 output
	
AS
BEGIN

---- Added on 2024-10-14 AA two new columns installment_amt_rtn & api_auto_connect to posinstlmnt_trx table 
---- Added on 2024-08-20 AA added clnt_taxcode to pos_ei table
---- Added on 2024-08-05 AA Resized @brlinksrvr parameter to nvarchar(20)
---- Added on 2023-12-13 AA When ubl is missing import all missing columns in pos_ei
---- Added on 2023-12-03 AA exclude yemen from importing pos_ei table
---- Added on 2023-12-03 AA 1 more column were missing from pos_ei
---- Added on 2023-12-03 AA 3 more columns were missing from pos_dt
---- Added on 2023-12-03 AA 3 more columns were missing from pos_hd
---- Added on 2023-10-22 AA using the parameter @no_of_invoices as input for the value of @limport_any_missing_data 
---- Added on 2023-10-22 AA Added new public variable named @limport_any_missing_data 
---- Added on 2023-10-22 AA  The @no_of_invoices is used as inpurt 
---- Added on 2023-10-22 AA to force import any missing data from any invoice tables
---- Added on 2023-10-22 AA Correct the saned_am column to saned_amt in possanedchrty table
---- Added on 2023-10-21 AA Added installment_amt to pos_hd
---- Added on 2023-10-21 AA import the new table possanedchrty 
---- Added on 2023-10-09 AA import the new table posinstlmnt_trx
---- Added on 2023-10-09 AA Fixed a bug khalid not included @brlinksrvr+@dbc for pos_hd
---- 2023-05-08 AA Added new public variable @lcountry
---- 2023-05-08 AA Added the @lcountry to select statement of glcalend 
---- 2023-05-08 AA Add new code in pos_mny table for yemen
---- Added on 2020-11-28 invhstry is imported too.
---- Added on 2020-06-08 vat_percent column added to the pos_hd
---- Modified on 2019-04-06 added posinvoffer , stcpay & qitaf 
	declare @sqlmsg nvarchar(max)='',
	@dbc nvarchar(14),
	@lcalcomp char(2),
	@yrcode char(4),
	@syscode int =2,
	@lcauseslctr bit=0,
	@it_is_pos bit=0,
	@lcountry numeric(1,0)=0 -- Added on 2023-05-08 AA
--- Added on 2023-10-22 AA ----------------------------------
    declare @limport_any_missing_data bit 
	set @limport_any_missing_data=cast(@no_of_invoices as bit)
	set @no_of_invoices=0
---------------------------------------------------------------
---------------------------------------------------------------------------------------------
	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)

	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @syscode=sysno,@lcauseslctr=causeslctr,@lcountry=country  from sysdb.dbo.glcalend  ---- Added on 2023-05-08 AA country
	where calcomp=@lcalcomp and yrcode=@yrcode;
------------------------------------------------------------------------------------------------------------------------------

    set @errstatus=0
 
------------------------------ Get Yrcode & Calcomp from Branch Boteequ  ----------------------------------------------
		declare @dynsql nvarchar(300),
				@params nvarchar(100)

		set @yrcode=''
		set @lcalcomp=''
		set @dynsql='select top 1 @yrcd=yrcode,@lclcmp=calcomp  from '+@brlinksrvr+'.posysdb.dbo.glcalend'
		+ ' order by yrcode desc';
		set @params='@yrcd char(4) output,@lclcmp char(2) output';
		exec sp_executesql @dynsql,@params,@yrcd=@yrcode output,@lclcmp=@lcalcomp output
		if @@error<>0 or @@rowcount=0
		begin
		  	set @errstatus=-1
			return 
		end
		if @yrcode<>'' and @lcalcomp<>'' set @dbc='.pos'+@lcalcomp+'y'+substring(@yrcode,3,2)+'.dbo.'
		else
		begin
		  	set @errstatus=-2
			return 		  
		end
		set @it_is_pos=1
------------------------------------------------------------------------------------------------------------------------
	set @sqlmsg='merge pos_hd as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_hd b where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert ( company,contr,ref,invdate,entries,slperson,paytype,chargepctg,chargeamt,invdspc,disccard,cardtype,invttl,invcst
          ,invdsvl,valafds,invpaid,pricetp,slcenter,invorrtrn,cashamt,modified,salinvno,salctrno,tdatetime,cktype
          ,geninv,rref,rcontr,ccpaid,ccconus,prepaidamt,fmbranch,mobile,fcamt,custtype,paycard,frc_rtncash,saned_amt
          ,rtncshamt,dfvchramt,vat_amt_rcvd,taxfree_sales,hlldscnt,discamt,No_round_nm,PriceVatType,CashDsc4RtnPrepaid,stcpay_amt
          ,outside_order,qitaf_amt,vat_percent,bk_amount,installment_amt,
		  slcode,inv_copies_no,zatca_rounding)' -- Added on 2023-12-03 AA
	+ ' values (s.company,s.contr,s.ref,s.invdate,s.entries,s.slperson,s.paytype,s.chargepctg,s.chargeamt,s.invdspc,s.disccard,s.cardtype,s.invttl,s.invcst
          ,s.invdsvl,s.valafds,s.invpaid,s.pricetp,s.slcenter,s.invorrtrn,s.cashamt,s.modified,s.salinvno,s.salctrno,s.tdatetime,s.cktype
          ,s.geninv,s.rref,s.rcontr,s.ccpaid,s.ccconus,s.prepaidamt,s.fmbranch,s.mobile,s.fcamt,s.custtype,s.paycard,s.frc_rtncash,s.saned_amt
          ,s.rtncshamt,s.dfvchramt,s.vat_amt_rcvd,s.taxfree_sales,s.hlldscnt,s.discamt,s.No_round_nm,s.PriceVatType,s.CashDsc4RtnPrepaid,s.stcpay_amt
          ,s.outside_order,s.qitaf_amt,s.vat_percent,s.bk_amount,s.installment_amt,
		  s.slcode,s.inv_copies_no,s.zatca_rounding);'	 -- Added on 2023-12-03 AA	
	
		
	
	begin transaction
	exec sp_executesql @sqlmsg
	set @no_of_invoices=@@ROWCOUNT
	if @@error<>0  
	begin
		rollback transaction
		set @errstatus=-3
		if @no_of_invoices=0 set @errstatus=0
		return 
	end

	if @no_of_invoices>0 or @limport_any_missing_data=1 -- Added on 2023-10-22 AA
	begin
		set @sqlmsg='merge pos_dt as t '
		+ ' using '
		+ ' (select a.* from '+@brlinksrvr+@dbc+'pos_dt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
		+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
		+ ' where '+@whr_condn+') as s'
		+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
		+ ' when not matched then '
			+ ' insert (company, contr, ref, cmbkey, qty, price, barcode, dscprsnt, srlno, rtrnd, dsc_amt, offer_amt
				, nqati_prcnt,taxtype,item_price_net,item_vat,invdscamt) 
				values (s.company ,s.contr ,s.ref,s.cmbkey ,s.qty,s.price ,s.barcode ,s.dscprsnt ,s.srlno,s.rtrnd,
						s.dsc_amt,s.offer_amt,s.nqati_prcnt,s.taxtype,s.item_price_net,s.item_vat,s.invdscamt);'

		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-4
			return 
		end

	
	-------- Posinvoffer 
		set @sqlmsg='merge Posinvoffer as t '
		+ ' using '
		+ ' (select a.* from '+@brlinksrvr+@dbc+'Posinvoffer a inner join '+@brlinksrvr+@dbc+'pos_hd b'
		+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
		+ ' where '+@whr_condn+') as s'
		+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
		+ ' when not matched then '
		+ ' insert (company, contr, ref, srlno, msbrcd_srlno, offer_type, itemgroup, minqty, givenamt, givenqty,Max2buy)
			values (s.company ,s.contr ,s.ref,s.srlno, s.msbrcd_srlno, s.offer_type, s.itemgroup, s.minqty,
			 s.givenamt, s.givenqty,s.Max2buy);'

	
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-6
			return 
		end

		set @sqlmsg='merge POSRTNINV as t '
		+ ' using '
		+ ' (select a.* from '+@brlinksrvr+@dbc+'POSRTNINV a inner join '+@brlinksrvr+@dbc+'pos_hd b'
		+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
		+ ' where '+@whr_condn+') as s'
		+ ' on t.company=s.company and t.rcontr=s.rcontr and t.rref=s.rref '
		+ ' when not matched then '
		+ ' insert values (s.company,s.rcontr,s.rref,s.Contr,s.ref,s.rtnamt);'

		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-7
			return 
		end

		set @sqlmsg='merge POSPPCARD as t '
		+ ' using '
		+ ' (select a.* from '+@brlinksrvr+@dbc+'POSPPCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
		+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
		+ ' where '+@whr_condn+') as s'
		+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.disccard=s.disccard'
		+ ' when not matched then '
		+ ' insert values (s.company,s.contr,s.ref,s.disccard,s.paytype,s.prepaidamt,s.paycard,s.nodsc4promo,s.prepaidamt_rtn);'

		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-8
			return 
		end
	-------------------------------------------------------------------------------
		set @sqlmsg='merge POSCCCARD as t '
		+ ' using '
		+ ' (select a.* from '+@brlinksrvr+@dbc+'POSCCCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
		+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
		+ ' where '+@whr_condn+' ) as s'
		+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.cccardno=s.cccardno and t.ccsrlno=s.ccsrlno'
		+ ' when not matched then '
		+ ' insert values (s.company,s.contr,s.ref,s.cccardno,s.ccsrlno,s.cardtype,s.ccpaid,
			s.ccconus,s.chargepctg,s.chargeamt,s.cctype,s.approvl_no,s.TransDate,s.TransTime,s.TransNo,s.terminal_id);'

		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-9
			return 
		end

		set @sqlmsg='merge poschrtinv as t '
		+ ' using '
		+ ' (select a.* from '+@brlinksrvr+@dbc+'poschrtinv a inner join '+@brlinksrvr+@dbc+'pos_hd b'
		+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
		+ ' where '+@whr_condn+' ) as s'
		+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
		+ ' when not matched then '
		+ ' insert values (s.company,s.contr,s.ref,s.hllamt,s.chrcode);'

		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-10
			return 
		end
	-----------------------------------------------------------------------------


		set @sqlmsg='merge posfcamt as t '
		+ ' using '
		+ ' (select a.* from '+@brlinksrvr+@dbc+'posfcamt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
		+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
		+ ' where '+@whr_condn+') as s'
		+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
		+ ' when not matched then '
		+ ' insert values (s.company,s.contr,s.ref,s.fcy,s.fcamt,s.fcyrate,s.lcamt,s.srlno);'

		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-11
			return 
		end
------------------add 02-09-2023 -- by khalid
        if @lcountry<>1 -- Added on 2023-12-03 AA
		begin
			set @sqlmsg='merge pos_ei as t '
				+ ' using '
				+ ' (select a.* from '+@brlinksrvr+@dbc+'pos_ei a inner join '+@brlinksrvr+@dbc+'pos_hd b'
				+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
				+ ' where '+@whr_condn+') as s'
				+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
				+ ' when matched and t.ubl is null then '  --- Added on 2023-12-12 AA to import ubl
				+ ' update set t.previousInvoiceHash=s.previousInvoiceHash,t.QRvalue=s.QRvalue,t.CurrentInvoiceHash=s.CurrentInvoiceHash,t.ubl=s.ubl,t.InvoiceCounterValue=s.InvoiceCounterValue,'
				+ ' t.einv_is_sent=s.einv_is_sent,t.reason_not_sent=s.reason_not_sent,t.uuid=s.uuid,t.folio=s.folio,t.deviceSN=s.deviceSN '				
				+ ' when not matched then '
					+ ' insert values (s.company,s.contr,s.ref,s.InvoiceTypeCode,s.tax_invoice_type,s.uuid,s.previousInvoiceHash,s.QRvalue'
					+ ',s.Order_ref_id,s.ContractDocRef,s.PaymentType,s.InvoiceTransactionCode,s.DebitCreditReason,s.CurrentInvoiceHash'
					+ ',s.InvoiceCounterValue,s.LatestDeliveryDate,s.einv_is_sent,s.ubl,s.invoice_charges'
					+ ',s.ExemptionReason,s.EXEMPTIONCODE,s.reason_not_sent,s.zatca_datetime,s.folio,s.deviceSN,s.zatca_conn,s.clnt_taxcode);' -- Added on 2024-08-20 AA

				exec sp_executesql @sqlmsg
				if @@error<>0
				begin
					rollback transaction
					set @errstatus=-5
					return 
				end
			end
	-------------	------------------
	------------------added on 2023-10-09 AA For posinstlmnt_trx ---------------------------------------------------------------------------------
		set @sqlmsg='merge posinstlmnt_trx as t '
			+ ' using '
			+ ' (select a.* from '+@brlinksrvr+@dbc+'posinstlmnt_trx a inner join '+@brlinksrvr+@dbc+'pos_hd b'  
			+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
			+ ' where '+@whr_condn+') as s'
			+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
			+ ' when not matched then '
			+ ' insert values (s.company,s.contr,s.ref,s.trx_inscode,s.trx_cmsn_pd_by_buyer,s.trx_instaxable,s.trx_inscommprcnt,s.trx_inscommamt,
				s.installment_amt,s.trx_buyer_mobile,s.trx_confirmed_code,s.trx_instlmnt_vourcher,s.trx_buyer_name,s.trx_commp_notrtnd,
				s.installment_amt_rtn,s.api_auto_connect);' -- Added on 2024-10-14 AA
			exec sp_executesql @sqlmsg
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-5
				return 
			end
	-------------------------------------------------------------------------------------------------------------------------------------------------
	------------------added on 2023-10-21 AA For possanedchrty table  ---------------------------------------------------------------------------------
		set @sqlmsg='merge possanedchrty as t '
			+ ' using '
			+ ' (select a.* from '+@brlinksrvr+@dbc+'possanedchrty a inner join '+@brlinksrvr+@dbc+'pos_hd b'  
			+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
			+ ' where '+@whr_condn+') as s'
			+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
			+ ' when not matched then '
			+ ' insert values (s.company,s.contr,s.ref, s.chrty_code, s.mobileno, s.approval_code, s.saned_amt);'

			exec sp_executesql @sqlmsg
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-5
				return 
			end
	--------------------------------------------------------------------------------------------------------------------------------------------------
		commit transaction
	end
	else rollback transaction

	declare @new_cndn nvarchar(250),
	        @lpos int =0

	set @new_cndn=replace(replace(@whr_condn,'tdatetime','mnydate'),'smalldatetime','date')
	if @lcountry<>1
	begin
		set @sqlmsg='merge pos_mny as t '
		+ ' using '
		+ ' (select * from '+@brlinksrvr+@dbc+'pos_mny where '+@new_cndn+') as s'	
		+ ' on t.company=s.company and t.contr=s.contr and t.mnydate=s.mnydate and t.slpcode=s.slpcode'
		+ ' when not matched then '
		+ ' insert (company,contr,mnydate,slpcode,oner,fiver,tenr,twntyr,fiftyr,hundredr,
					twohandr,fivehandr,modified,rtnval,network,prepaidamt,scrtnval,scnetwork,scprepaidamt,
					sccash,saned_amt,scsaned_amt,fiveh,tenh,twntyfiveh,fiftyh,stcpay_amt,qitaf_amt)                
			values (s.company,s.contr,s.mnydate,s.slpcode,s.oner,s.fiver,s.tenr,s.twntyr,s.fiftyr,s.hundredr,
					s.twohandr,s.fivehandr,s.modified,s.rtnval,s.network,s.prepaidamt,s.scrtnval ,s.scnetwork,
					s.scprepaidamt,s.sccash,s.saned_amt,s.scsaned_amt,s.fiveh,s.tenh,s.twntyfiveh,
					s.fiftyh,s.stcpay_amt,s.qitaf_amt);'	
    end
---  Added on 2023-05-08 AA For yemen ---------------------------------------------------------------
	else
	begin
		set @sqlmsg='merge pos_mny as t '
		+ ' using '
		+ ' (select * from '+@brlinksrvr+@dbc+'pos_mny where '+@new_cndn+') as s'	
		+ ' on t.company=s.company and t.contr=s.contr and t.mnydate=s.mnydate and t.slpcode=s.slpcode'
		+ ' when not matched then '
		+ ' insert (company,contr,mnydate,slpcode,oner,fiver,tenr,twntyr,fiftyr,hundredr,
					twohandr,fivehandr,modified,rtnval,network,prepaidamt,scrtnval,scnetwork,scprepaidamt,
					sccash,saned_amt,scsaned_amt,fiveh,tenh,twntyfiveh,fiftyh,stcpay_amt,qitaf_amt,twofifty,thousand)                
			values (s.company,s.contr,s.mnydate,s.slpcode,s.oner,s.fiver,s.tenr,s.twntyr,s.fiftyr,s.hundredr,
					s.twohandr,s.fivehandr,s.modified,s.rtnval,s.network,s.prepaidamt,s.scrtnval ,s.scnetwork,
					s.scprepaidamt,s.sccash,s.saned_amt,s.scsaned_amt,s.fiveh,s.tenh,s.twntyfiveh,
					s.fiftyh,s.stcpay_amt,s.qitaf_amt,s.twofifty,s.thousand);'
	end
	begin transaction
	--exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-88
		return -- Added on 2023-05-08 AA
	end
	else commit transaction
---------------------------------------  Import invhstry from branch --------------------------------
	set @sqlmsg='merge invhstry as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'invhstry a '
	+ ' where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno and t.ref_id=s.ref_id '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, cmbkey, qty, price, barcode, dscprsnt, srlno, invdate, tdatetime, slperson, invorrtrn, 
	            deletedx, ref_id, qtydel, retreived, offer_amt)
		values (s.company, s.contr, s.ref, s.cmbkey, s.qty, s.price, s.barcode, s.dscprsnt, s.srlno, s.invdate, s.tdatetime, s.slperson, s.invorrtrn, 
	            s.deletedx, s.ref_id, s.qtydel, s.retreived, s.offer_amt);'

	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-10
	end
	else commit transaction	
end 



GO
/****** Object:  StoredProcedure [dbo].[Import_RSTPOS_invoices_from_branch]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- Added on 2020-11-28 invhstry is imported too.
---- Added on 2020-06-08 vat_percent column added to the order_hdr
---- Modified on 2019-04-06 added posinvoffer , stcpay & qitaf 
---- Added the new column prepaidamt_rtn in posppcard 2019-10-11
---- Added insert command for pos_slp table 2019-10-11
---- Added t.paycard=s.paycard for posppcard table link 2019-10-11
---- Ignored the @it_is_pos variable and fixed pos_mny  2019-10-11

CREATE PROCEDURE [dbo].[Import_RSTPOS_invoices_from_branch]
 @whr_condn nvarchar(200),
 @brlinksrvr nvarchar(20),
 @wth_slp_cntr bit,
 @no_of_invoices int=0 output,
 @errstatus int = 0 output
 --@STR_MSG VARCHAR(1000) OUT
	
AS
BEGIN
	declare @sqlmsg nvarchar(max)='',
	@dbc nvarchar(14),
	@lcalcomp char(2),
	@yrcode char(4),
	@syscode int =2,
	@lcauseslctr bit=0,
	@it_is_pos bit=0,
	@lPVT_level numeric(1,0) =0
	declare @o_syscode numeric(2,0)=0,
	@loksctions bit =0,
	@lbranch char(2)='',
	@lslcenter char(2)='',
	@lsc_code  char(4)='',
	@l_pos int =0
---------------------------------------------------
-- First check if link server exist

   if not exists(select name from sys.servers where name=@brlinksrvr)
   begin
      set @errstatus=-99
	  return @errstatus
   end
---------------------------------------------------------------------------------------------
	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)

	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @syscode=isnull(sysno,2),@lcauseslctr=causeslctr,@lPVT_level=isnull(SysNo_PVT_level,0),@loksctions=isnull(oksctions,0)
	  from sysdb.dbo.glcalend 
	where calcomp=@lcalcomp and yrcode=@yrcode
------------------------------------------------------------------------------------------------------------------------------
    set @o_syscode=@syscode
 --   if @lPVT_level=2 and len(@lbranch)>0
	--begin
	--    set @syscode=0
	--    select @syscode=sysno
	--	 from stbranch where brnno=@lbranch	
	--	if @syscode=0 or @syscode is null set @syscode=@o_syscode
	--end
	--else
	--if @lPVT_level=3 and @loksctions=1 and len(@lslcenter)>0 and len(@lbranch)>0 
	--begin
	--     select @lsc_code=sc_code from salecntr where dp_brno=@lbranch and dp_dept=@lslcenter
	--	 if @lsc_code is not null and len(@lsc_code)>0
	--	 begin
	--	      set @syscode=0
	--	      select @syscode=sysno from glsction where sc_code=@lsc_code
	--		  if @syscode=0 or @syscode is null set @syscode=@o_syscode
	--	 end
	--end
-------------------------------------------------------------------------------------------------------------
    set @errstatus=0
    set @dbc='.'+db_name()+'.dbo.'

    
--BEGIN TRY
--------------------------------------------------------- import rstcashier & rstcashier_payment_method -------------------------------------
    if @wth_slp_cntr=1
	begin
	    set @sqlmsg='merge rstcashier as t '
		+ ' using '+@brlinksrvr+@dbc+'rstcashier as s'
		+ ' on t.company=s.company and t.rt_code=s.rt_code and  t.cashier_id=s.cashier_id'
		+ ' when matched then '
		+ ' update set t.cashier_name = s.cashier_name ,t.dsc = s.dsc ,t.inactive = s.inactive ,t.is_sale = s.is_sale'
        + ',t.is_return = s.is_return,t.ecrpos = s.ecrpos ,t.ecrport = s.ecrport,t.usedrawer = s.usedrawer'
        + ',t.drwrcomport = s.drwrcomport ,t.order_prntbyclass = s.order_prntbyclass ,t.customer_display = s.customer_display'
        + ',t.usbdsplyport = s.usbdsplyport,t.dsplycomport = s.dsplycomport ,t.number_of_screen = s.number_of_screen'
        + ',t.wellcome_message = s.wellcome_message ,t.invsales_message = s.invsales_message,t.message_return = s.message_return,t.show_image = s.show_image'
        + ',t.show_description = s.show_description,t.created_date = s.created_date,t.print_inv_by_category = s.print_inv_by_category ,t.print_inv_local = s.print_inv_local'
        + ',t.pickup_printer_id = s.pickup_printer_id,t.kitchen_printer_id = s.kitchen_printer_id ,t.cashier_local_printer_id = s.cashier_local_printer_id,t.invser = s.invser'
        + ',t.ctrserial = s.ctrserial,t.started_session = s.started_session,t.ended_session = s.ended_session,t.slcenter = s.slcenter'
        + ',t.slnoprint = s.slnoprint,t.rtnoprint = s.rtnoprint,t.slnoprint = s.slnoprint,t.rtnoprint = s.rtnoprint'
        + ',t.days2stop = s.days2stop,t.reprint = s.reprint,t.saveinserver = s.saveinserver'
		+ ' when not matched then '
		+ ' insert (company, rt_code, cashier_id, cashier_name, dsc, inactive, is_sale, is_return, ecrpos, ecrport, usedrawer, 
		            drwrcomport, order_prntbyclass, customer_display, usbdsplyport, dsplycomport, number_of_screen, wellcome_message, 
                    invsales_message, message_return, show_image, show_description, created_date, print_inv_by_category, 
				    print_inv_local, pickup_printer_id, kitchen_printer_id, cashier_local_printer_id, invser, ctrserial, 
					started_session, ended_session, slcenter, slnoprint, rtnoprint, days2stop, reprint, saveinserver)'
		+ ' values (s.company,s.rt_code,s.cashier_id,s.cashier_name,s.dsc,s.inactive,s.is_sale,s.is_return,s.ecrpos,s.ecrport,s.usedrawer, 
		            s.drwrcomport,s.order_prntbyclass,s.customer_display,s.usbdsplyport,s.dsplycomport,s.number_of_screen,s.wellcome_message, 
                    s.invsales_message,s.message_return,s.show_image,s.show_description,s.created_date,s.print_inv_by_category, 
				    s.print_inv_local,s.pickup_printer_id,s.kitchen_printer_id,s.cashier_local_printer_id,s.invser,s.ctrserial, 
					s.started_session,s.ended_session,s.slcenter,s.slnoprint,s.rtnoprint,s.days2stop,s.reprint,s.saveinserver);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-10
			return 
		end
		
--------------------------------- rstcashier_payment_method Table ------------------------- 

	    set @sqlmsg='merge rstcashier_payment_method as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'rstcashier_payment_method a inner join '+@brlinksrvr+@dbc+'rstcashier b'
	+ ' on a.company=b.company and a.rt_code=b.rt_code and a.cashier_id=b.cashier_id ) as s
	    on t.company=s.company and t.rt_code=s.rt_code and t.cashier_id=s.cashier_id and t.payment_id=s.payment_id
	    when not matched then 
	    insert (company, rt_code, cashier_id, payment_id, lastupdt)
		values (s.company,s.rt_code,s.cashier_id, s.payment_id, s.lastupdt);'

		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-10
			return 
		end
		else commit transaction
	end
------------------------------------------------------------------------------------------------------------------------
	set @sqlmsg='merge rstorder_hdr as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'rstorder_hdr b where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.cashier_id=s.cashier_id and t.invno=s.invno '
	+ ' when not matched then '
	+ ' insert (company, rt_code, cashier_id, invno, order_num, customer_id, user_id, create_date, update_date, order_type_id, 
	    order_status_id, amount, sub_total, discount, discount_percentage, tax_amount, tax_rate, cancel_reason_id, 
        parent_id, order_sales_return, shipping_method_id, notes, table_id, table_reservation_id)'
	+ ' values (s.company,s.rt_code,s.cashier_id,s.invno,s.order_num,s.customer_id, user_id,s.create_date,s.update_date,s.order_type_id, 
	    s.order_status_id,s.amount,s.sub_total,s.discount,s.discount_percentage,s.tax_amount,s.tax_rate,s.cancel_reason_id, 
        s.parent_id,s.order_sales_return,s.shipping_method_id,s.notes,s.table_id,s.table_reservation_id);'	
	
	begin transaction
	exec sp_executesql @sqlmsg
	set @no_of_invoices=@@ROWCOUNT
	if @@error<>0 or @no_of_invoices=0
	begin
		rollback transaction
		set @errstatus=-3
		if @no_of_invoices=0 set @errstatus=0
		return 
	end

--  Make sure that the field NQATI_PRCNT is available in order_dtl
	
    --declare @is_nqati_there varchar(30)=''
    --set @is_nqati_there=iif(EXISTS(SELECT name FROM sys.columns
    --WHERE Name = N'nqati_prcnt' AND OBJECT_ID = OBJECT_ID(N'order_dtl')),',s.nqati_prcnt);',');')
	
	set @sqlmsg='merge rstorder_dtl as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'rstorder_dtl a inner join '+@brlinksrvr+@dbc+'rstorder_hdr b'
	+ ' on a.company=b.company and a.cashier_id=b.cashier_id and a.invno=b.invno'
	+ ' where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.cashier_id=s.cashier_id and t.invno=s.invno and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert (company, cashier_id, invno, cmbkey, barcode, quantity, rate, amount, discount, discount_percentage, is_void, reason_id, 
	           return_quantity, update_date, offer_amt, taxtype, nqati_prcnt, srlno, notes) 
	    values (s.company,s.cashier_id,s.invno,s.cmbkey,s.barcode,s.quantity,s.rate,s.amount,s.discount,s.discount_percentage,s.is_void,s.reason_id, 
	           s.return_quantity,s.update_date,s.offer_amt,s.taxtype,s.nqati_prcnt,s.srlno,s.notes);'
	


	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-4
		return 
	end
--------------------------------- order_product_option Table ------------------------- 
	set @sqlmsg='merge rstorder_product_option as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'rstorder_product_option a inner join '+@brlinksrvr+@dbc+'rstorder_hdr b'
	+ ' on a.company=b.company and a.cashier_id=b.cashier_id and a.invno=b.invno'
	+ ' where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.cashier_id=s.cashier_id and t.invno=s.invno and t.option_dtl_id=s.option_dtl_id and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert (company, cashier_id, invno, cmbkey, option_id, option_dtl_id, amount, quantity, srlno) 
	    values (s.company,s.cashier_id,s.invno, s.cmbkey, s.option_id, s.option_dtl_id, s.amount, s.quantity, s.srlno);'
	


	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end
--------------------------------- payment Table ------------------------- 
	set @sqlmsg='merge rstorder_payment as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'rstorder_payment a inner join '+@brlinksrvr+@dbc+'rstorder_hdr b'
	+ ' on a.company=b.company and a.cashier_id=b.cashier_id and a.invno=b.invno'
	+ ' where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.cashier_id=s.cashier_id and t.invno=s.invno and t.payment_method_id=s.payment_method_id and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert (company, cashier_id, invno, payment_method_id, amount, payment_reference, dsc, srlno) 
	    values (s.company,s.cashier_id,s.invno, s.payment_method_id, s.amount, s.payment_reference, s.dsc, s.srlno);'
	


	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-6
		return 
	end


-------- Posinvoffer 
	set @sqlmsg='merge Posinvoffer as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'Posinvoffer a inner join '+@brlinksrvr+@dbc+'rstorder_hdr b'
	+ ' on a.company=b.company and a.cashier_id=b.cashier_id and a.invno=b.invno'
	+ ' where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.cashier_id=s.cashier_id and t.invno=s.invno and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert (company, cashier_id, invno, srlno, msbrcd_srlno, offer_type, itemgroup, minqty, givenamt, givenqty)
	    values (s.company ,s.cashier_id ,s.invno,s.srlno, s.msbrcd_srlno, s.offer_type, s.itemgroup, s.minqty,
		 s.givenamt, s.givenqty);'

	


	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-7
		return 
	end

--------------------------------- POSPPCARD Table ------------------------- 

	set @sqlmsg='merge POSPPCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSPPCARD a inner join '+@brlinksrvr+@dbc+'rstorder_hdr b'
	+ ' on a.company=b.company and a.cashier_id=b.cashier_id and a.invno=b.invno'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.cashier_id=s.cashier_id and t.invno=s.invno and t.disccard=s.disccard and t.paycard=s.paycard'
	+ ' when not matched then '
	+ ' insert (company, cashier_id, invno, disccard, paytype, prepaidamt, paycard, nodsc4promo, prepaidamt_rtn)
	    values (s.company,s.cashier_id,s.invno,s.disccard,s.paytype,s.prepaidamt,s.paycard,s.nodsc4promo,s.prepaidamt_rtn);'

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end
--------------------------------- POSCCCARD Table -------------------------
	set @sqlmsg='merge POSCCCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSCCCARD a inner join '+@brlinksrvr+@dbc+'rstorder_hdr b'
	+ ' on a.company=b.company and a.cashier_id=b.cashier_id and a.invno=b.invno'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.cashier_id=s.cashier_id and t.invno=s.invno and t.cccardno=s.cccardno and t.ccsrlno=s.ccsrlno'
	+ ' when not matched then '
	+ ' insert (company, cashier_id, invno, cccardno, ccsrlno, cardtype, ccpaid, ccconus, chargepctg, chargeamt, cctype,
	    approvl_no, TransDate, TransTime, TransNo, terminal_id)'
	+ ' values (s.company,s.cashier_id,s.invno,s.cccardno,s.ccsrlno,s.cardtype,s.ccpaid,
	    s.ccconus,s.chargepctg,s.chargeamt,s.cctype,s.approvl_no,s.TransDate,s.TransTime,s.TransNo,s.terminal_id);'

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

--------------------------------- posfcamt Table -------------------------
	set @sqlmsg='merge posfcamt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'posfcamt a inner join '+@brlinksrvr+@dbc+'rstorder_hdr b'
	+ ' on a.company=b.company and a.cashier_id=b.cashier_id and a.invno=b.invno'
	+ ' where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.cashier_id=s.cashier_id and t.invno=s.invno and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert values (s.company,s.cashier_id,s.invno,s.fcy,s.fcamt,s.fcyrate,s.lcamt,s.srlno);'

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-6
		return 
	end
	else commit transaction
	

end 














GO
/****** Object:  StoredProcedure [dbo].[Import_RSTPOS_invoices_from_POS]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- Added on 2020-11-28 invhstry is imported too.
---- Added on 2020-06-08 vat_percent column added to the pos_hd
---- Modified on 2019-04-06 added posinvoffer , stcpay & qitaf 
CREATE PROCEDURE [dbo].[Import_RSTPOS_invoices_from_POS]
 @whr_condn nvarchar(200),
 @brlinksrvr nvarchar(15),
 @no_of_invoices int=0 output,
 @errstatus int = 0 output
	
AS
BEGIN
	declare @sqlmsg nvarchar(max)='',
	@dbc nvarchar(14),
	@lcalcomp char(2),
	@yrcode char(4),
	@syscode int =2,
	@lcauseslctr bit=0,
	@it_is_pos bit=0

-- First check if link server exist

   if not exists(select name from sys.servers where name=@brlinksrvr)
   begin
      set @errstatus=-99
	  return @errstatus
   end
---------------------------------------------------------------------------------------------
	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)

	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @syscode=sysno,@lcauseslctr=causeslctr  from sysdb.dbo.glcalend 
	where calcomp=@lcalcomp and yrcode=@yrcode
------------------------------------------------------------------------------------------------------------------------------

    set @errstatus=0
 
------------------------------ Get Yrcode & Calcomp from Branch Boteequ  ----------------------------------------------
		declare @dynsql nvarchar(300),
				@params nvarchar(100)

		set @yrcode=''
		set @lcalcomp=''
		set @dynsql='select top 1 @yrcd=yrcode,@lclcmp=calcomp  from '+@brlinksrvr+'.posysdb.dbo.glcalend'
		+ ' order by yrcode desc';
		set @params='@yrcd char(4) output,@lclcmp char(2) output';
		exec sp_executesql @dynsql,@params,@yrcd=@yrcode output,@lclcmp=@lcalcomp output
		if @@error<>0 or @@rowcount=0
		begin
		  	set @errstatus=-1
			return 
		end
		if @yrcode<>'' and @lcalcomp<>'' set @dbc='.pos'+@lcalcomp+'y'+substring(@yrcode,3,2)+'.dbo.'
		else
		begin
		  	set @errstatus=-2
			return 		  
		end
		set @it_is_pos=1
------------------------------------------------------------------------------------------------------------------------
	
    


------------------------------------------------------------------------------------------------------------------------
	set @sqlmsg='merge rstorder_hdr as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'order_hdr b where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.cashier_id=s.cashier_id and t.invno=s.invno '
	+ ' when not matched then '
	+ ' insert (company, rt_code, cashier_id, invno, order_num, customer_id, user_id, create_date, update_date, order_type_id, 
	    order_status_id, amount, sub_total, discount, discount_percentage, tax_amount, tax_rate, cancel_reason_id, 
        parent_id, order_sales_return, shipping_method_id, notes, table_id, table_reservation_id)'
	+ ' values (s.company,s.rt_code,s.cashier_id,s.invno,s.order_num,s.customer_id, user_id,s.create_date,s.update_date,s.order_type_id, 
	    s.order_status_id,s.amount,s.sub_total,s.discount,s.discount_percentage,s.tax_amount,s.tax_rate,s.cancel_reason_id, 
        s.parent_id,s.order_sales_return,s.shipping_method_id,s.notes,s.table_id,s.table_reservation_id);'	
	
	begin transaction
	exec sp_executesql @sqlmsg
	set @no_of_invoices=@@ROWCOUNT
	if @@error<>0 or @no_of_invoices=0
	begin
		rollback transaction
		set @errstatus=-3
		if @no_of_invoices=0 set @errstatus=0
		return 
	end

	
	set @sqlmsg='merge rstorder_dtl as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'order_dtl a inner join '+@brlinksrvr+@dbc+'order_hdr b'
	+ ' on a.company=b.company and a.cashier_id=b.cashier_id and a.invno=b.invno'
	+ ' where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.cashier_id=s.cashier_id and t.invno=s.invno and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert (company, cashier_id, invno, cmbkey, barcode, quantity, rate, amount, discount, discount_percentage, is_void, reason_id, 
	           return_quantity, update_date, offer_amt, taxtype, nqati_prcnt, srlno, notes) 
	    values (s.company,s.cashier_id,s.invno,s.cmbkey,s.barcode,s.quantity,s.rate,s.amount,s.discount,s.discount_percentage,s.is_void,s.reason_id, 
	           s.return_quantity,s.update_date,s.offer_amt,s.taxtype,s.nqati_prcnt,s.srlno,s.notes);'
	


	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-4
		return 
	end
--------------------------------- order_product_option Table ------------------------- 
	set @sqlmsg='merge rstorder_product_option as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'order_product_option a inner join '+@brlinksrvr+@dbc+'order_hdr b'
	+ ' on a.company=b.company and a.cashier_id=b.cashier_id and a.invno=b.invno'
	+ ' where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.cashier_id=s.cashier_id and t.invno=s.invno and t.option_dtl_id=s.option_dtl_id and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert (company, cashier_id, invno, cmbkey, option_id, option_dtl_id, amount, quantity, srlno) 
	    values (s.company,s.cashier_id,s.invno, s.cmbkey, s.option_id, s.option_dtl_id, s.amount, s.quantity, s.srlno);'
	


	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end
--------------------------------- payment Table ------------------------- 
	set @sqlmsg='merge rstorder_payment as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'payment a inner join '+@brlinksrvr+@dbc+'order_hdr b'
	+ ' on a.company=b.company and a.cashier_id=b.cashier_id and a.invno=b.invno'
	+ ' where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.cashier_id=s.cashier_id and t.invno=s.invno and t.payment_method_id=s.payment_method_id and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert (company, cashier_id, invno, payment_method_id, amount, payment_reference, dsc, srlno) 
	    values (s.company,s.cashier_id,s.invno, s.payment_method_id, s.amount, s.payment_reference, s.dsc, s.srlno);'
	


	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-6
		return 
	end


-------- Posinvoffer 
	set @sqlmsg='merge Posinvoffer as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'Posinvoffer a inner join '+@brlinksrvr+@dbc+'order_hdr b'
	+ ' on a.company=b.company and a.cashier_id=b.cashier_id and a.invno=b.invno'
	+ ' where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.cashier_id=s.cashier_id and t.invno=s.invno and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert (company, cashier_id, invno, srlno, msbrcd_srlno, offer_type, itemgroup, minqty, givenamt, givenqty)
	    values (s.company ,s.cashier_id ,s.invno,s.srlno, s.msbrcd_srlno, s.offer_type, s.itemgroup, s.minqty,
		 s.givenamt, s.givenqty);'

	


	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-7
		return 
	end

--------------------------------- POSPPCARD Table ------------------------- 

	set @sqlmsg='merge POSPPCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSPPCARD a inner join '+@brlinksrvr+@dbc+'order_hdr b'
	+ ' on a.company=b.company and a.cashier_id=b.cashier_id and a.invno=b.invno'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.cashier_id=s.cashier_id and t.invno=s.invno and t.disccard=s.disccard and t.paycard=s.paycard'
	+ ' when not matched then '
	+ ' insert (company, cashier_id, invno, disccard, paytype, prepaidamt, paycard, nodsc4promo, prepaidamt_rtn)
	    values (s.company,s.cashier_id,s.invno,s.disccard,s.paytype,s.prepaidamt,s.paycard,s.nodsc4promo,s.prepaidamt_rtn);'

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end
--------------------------------- POSCCCARD Table -------------------------
	set @sqlmsg='merge POSCCCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSCCCARD a inner join '+@brlinksrvr+@dbc+'order_hdr b'
	+ ' on a.company=b.company and a.cashier_id=b.cashier_id and a.invno=b.invno'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.cashier_id=s.cashier_id and t.invno=s.invno and t.cccardno=s.cccardno and t.ccsrlno=s.ccsrlno'
	+ ' when not matched then '
	+ ' insert (company, cashier_id, invno, cccardno, ccsrlno, cardtype, ccpaid, ccconus, chargepctg, chargeamt, cctype,
	    approvl_no, TransDate, TransTime, TransNo, terminal_id)'
	+ ' values (s.company,s.cashier_id,s.invno,s.cccardno,s.ccsrlno,s.cardtype,s.ccpaid,
	    s.ccconus,s.chargepctg,s.chargeamt,s.cctype,s.approvl_no,s.TransDate,s.TransTime,s.TransNo,s.terminal_id);'

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

--------------------------------- posfcamt Table -------------------------
	set @sqlmsg='merge posfcamt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'posfcamt a inner join '+@brlinksrvr+@dbc+'order_hdr b'
	+ ' on a.company=b.company and a.cashier_id=b.cashier_id and a.invno=b.invno'
	+ ' where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.cashier_id=s.cashier_id and t.invno=s.invno and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert values (s.company,s.cashier_id,s.invno,s.fcy,s.fcamt,s.fcyrate,s.lcamt,s.srlno);'

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-6
		return 
	end
	else commit transaction

end 














GO
/****** Object:  StoredProcedure [dbo].[ImportPuordPDAxml]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[ImportPuordPDAxml]
@STR_MSG NVARCHAR(1000) OUT,
@RET_ID INT OUT,
@PDAXFR xml,
@BRANCH Nchar(2),
@USRID Nchar(10)

AS BEGIN 
   set lock_timeout 2000
BEGIN TRY
	DECLARE @shdpk NUMERIC(10,3),
	        @shdpk1 NUMERIC(10,3),
	        @shdpk2 NUMERIC(10,3)
	DECLARE @pack0 NVARCHAR(1)
	DECLARE @pack1 NVARCHAR(1)
	DECLARE @pack2 NVARCHAR(1)
	DECLARE @pack NVARCHAR(1)
	DECLARE @pack_0 char(1)
	DECLARE @lprice float
	DECLARE @cmbkey NVARCHAR(24)
	DECLARE @itemno CHAR(16)
	DECLARE @unicode CHAR(6)
	DECLARE @lcost float
	declare @Trdate varchar(20)
	DECLARE @handle INT	
	DECLARE @barcode NVARCHAR(20)
	DECLARE @fm_binno nCHAR(6)
	DECLARE @to_binno nCHAR(6)
	DECLARE @qty float
	DECLARE @comp char(2),
	@binno_found bit =0,
	@lcustcode char(6)=''


	declare @ss as varchar(10),
	@srlno as int =0,
	@shdqty as float=0,
	@frtqty as float =0,
	@ttlqty as float =0,
	@avail_qty float =0,
	@ttlcost as float =0

	declare @dbc varchar(20),
	@lusing_hij_date bit =0,
	@ldate varchar(10),
	@lfdate varchar(8)='',
	@errstatus int =0,
	@stunits_lcost float=0,
	@lexpdate varchar(8)=''

	
	set @lcustcode=@STR_MSG

	set @STR_MSG=''
	set @RET_ID=0
	set @dbc=db_name()
	SET @lusing_hij_date=iif(cast(substring(@dbc,7,2) as int)>30,1,0)
	set @comp=substring(@dbc,4,2)
	if @lusing_hij_date=1
	begin
		set @ldate =convert(varchar(10),getdate(),131)
		set @lfdate=substring(@ldate,7,4)+substring(@ldate,4,2)+iif(substring(@ldate,1,1)=' ','0'+substring(@ldate,2,1),substring(@ldate,1,2))
	end
	else
	begin
		set @ldate = convert(varchar(10),getdate(),112)
		set @lfdate=@ldate		
	end
	declare @lcaalwngtvs bit =0,
	        @yrcode varchar(4),
	        @syscode int =2

	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
	
	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @syscode=sysno,@lcaalwngtvs=isnull(caalwngtvs ,0)
	       from sysdb.dbo.glcalend with (nolock)
	       where calcomp=@comp and yrcode=@yrcode

--------------------------------------------------------------------------------------------------------------------------- 
	IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[#TEMPTRX_PDA]') AND type in (N'U'))
	DROP TABLE [dbo].[#TEMPTRX_PDA]

	EXEC sp_xml_preparedocument @handle OUTPUT, @PdaXfr

	select  barcode,shdqty,frmbinno 
	into #TEMPTRX_PDA FROM OPENXML (@handle, 'NewDataSet/Table1', 2) WITH
	(barcode nvarCHAR(20),
	shdqty float,
	frmbinno nCHAR(6))

	

	declare @ref int=0

	EXEC sp_xml_removedocument @handle
	
--insert into TMP(FLD)values('1')

	Declare Curs Cursor For Select * From #TEMPTRX_PDA 
	open Curs 
	Fetch Next From Curs Into @barcode,@shdqty,@fm_binno
    DECLARE @j INT=1
	set @ref =0
	--set @Trdate=CONVERT(VARCHAR(10), getdate(), 112)
	select @ref =dbo.get_last_ref('34', @branch)
---------------------------------------

---------------------------------------------------------------------
    begin transaction
	insert into ord_hdr (branch, company, ref, invdate, custno, custnm, glser, fcy, fcyrate, invttl, invcst,
	 invdspc, invdsvl, valafds, invpaid, caser, entries,
 fixrate, lastupdt, isl_c, modified, splyinv, closed, processed,   rcvdtrn, usrid)
 values('Q',@branch,@ref,@lfdate,@lcustcode,'طلب شراء عن طريق جهاز PDA','','',0,0,0,0,0,0,0,'',0,0,@lfdate,0,
        1,'',0,0,0,@usrid)


		if @@error<>0
		begin
			rollback transaction
			SET @RET_ID = -2
			SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   
			set @errstatus =-2
		end
		----------------------------------

	-------------------------------------
    if @errstatus=0
	begin
		WHILE @@FETCH_STATUS = 0  
		begin
			set @itemno =''
			set @unicode =''
			set @lcost =0
			set @cmbkey =''
			set @lprice =0
			set @pack0=''
			set @pack1=''
			set @pack2=''
			set @stunits_lcost=0
			set @pack='' 
			set @pack=rtrim(@fm_binno)
			set @shdpk =0
			set @shdpk1 =0
			set @shdpk2 =0
			if @syscode<>6
			begin
				select @itemno =itemno,@unicode =UNICODE,@cmbkey =cmbkey ,@lprice =lprice1,@pack1=pack1,
				@pack2=pack2,
				@pack0=pack0 ,@shdpk1 =pkqty1,@shdpk2 =pkqty2,@stunits_lcost=lcost   from stunits with (nolock) 
				where barcode =@barcode 
				if @pack=@pack0 or rtrim(@pack)='' set @shdpk=1
				else if @pack=@pack1 set @shdpk=@shdpk1
				else if @pack=@pack2 set @shdpk=@shdpk2
				
			end
			else
			begin
				select @itemno =a.itemno,@unicode =a.UNICODE,@cmbkey =a.cmbkey ,@lprice =b.lprice1 ,
				@pack0=b.pack ,@shdpk =b.pkqty,@stunits_lcost=lcost   from stunits a with (nolock) inner join stitembc b with (nolock)
				on a.itemno=b.itemno and a.unicode=b.unicode
				where pbarcode =@barcode 
				set @pack=@pack0
            end

			if isnull(@shdpk,0)<=0 set @shdpk=1

		    set @lcost=(@stunits_lcost*@shdpk)



				
	
	
			INSERT INTO ord_dtl (company, ref, invdate, itemno, unicode, qty, price, discpc, cost, custno, fcy, barcode, pack, 
           pkqty, qtyrcv, qtyrsv, lstrcvdate, cmbkey, fqty, folio, splyinv, dlvrydate, caser)values(
		   @branch,@ref,@lfdate,@itemno,@unicode,@shdqty,@lcost,0,0,@lcustcode,'',@barcode,@pack,
		   @shdpk,0,0,'',@cmbkey,0,@j,'','','')
			--@itemno,@unicode,'20',@qty ,@whno ,@lcost ,@lfdate,@ref ,@lfdate,'03', @lprice,@towhno ,@barcode ,
			--@fm_binno,@to_binno,@branch ,@cmbkey,0,0,0,@pack0,1,@qty ,@j,@lexpdate)
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -4
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   
				set @errstatus =-4
				break
			end

			set @ttlcost=@ttlcost+(@lcost*@shdqty)

			set @j=@j+1

			Fetch Next From Curs Into @barcode,@shdqty,@fm_binno
		END
		if @errstatus =0
		begin

			update ord_hdr   set   entries =(@j-1),valafds = @ttlcost,invttl=@ttlcost  WHERE   company=@branch   and ref=@ref 
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -7
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   
				set @errstatus =-7
			end
			else
			begin
				update stbranch   set   jv_34 =@ref+1  WHERE   company =@comp AND  BRNNO=@branch 
				if @@error<>0
				begin
					rollback transaction
					SET @RET_ID = -8
					SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   
					set @errstatus =-8				
				end
				else 
				begin
					set @errstatus = @@ROWCOUNT
					commit transaction
					SET @RET_ID = 1	
				end
			end
		end
	end
	CLOSE Curs 
	DEALLOCATE Curs
	IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'#TEMPTRX_PDA'))
	DROP TABLE [#TEMPTRX_PDA]
    return @errstatus
END TRY
	BEGIN CATCH
	    if @@TRANCOUNT >0 ROLLBACK TRANSACTION
		SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () 

		SET @RET_ID = -99
		IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'#TEMPTRX_PDA'))
		DROP TABLE [#TEMPTRX_PDA]
		--insert into TMP(FLD)values(@STR_MSG)
		RETURN -99
END CATCH
	
END

















GO
/****** Object:  StoredProcedure [dbo].[ImportSlinvAPIxml]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[ImportSlinvAPIxml]

@STR_MSG NVARCHAR(1000) out,
@ltrtype char(2),
@lcustcode varchar(6),
@hinvdsvl float,
@hinvdspc float,
@lbelowbal bit,
@hvat_amt_rcvd float,
@htaxfree_sales float,
@RET_ID INT out,
@API_Inv nvarchar(max),
@SLCNTR char(2),
@SLPRSN char(2),
@BRANCH char(2),
@USRID varchar(10)

AS BEGIN 
   set lock_timeout 2000
BEGIN TRY
	DECLARE @shdpk NUMERIC(10,3)
	DECLARE @pack0 NVARCHAR(1)
	DECLARE @pack_0 char(1)
	DECLARE @lprice decimal(11,3)=0
	DECLARE @cmbkey NVARCHAR(24)
	DECLARE @itemno CHAR(16)
	DECLARE @unicode CHAR(6)
	DECLARE @lcost float
	declare @Trdate varchar(20)
	DECLARE @handle INT	
	DECLARE @barcode NVARCHAR(20)
--	DECLARE @lcustcode nCHAR(6)
	DECLARE @lbinno CHAR(6)
	DECLARE @qty float
--	declare @ltrtype nchar(2)
	DECLARE @comp char(2),
	@binno_found bit =0
	


	declare @ss as varchar(10),
	@srlno as int =0,
	@lshdqty as float=0,
	@lfrtqty as float =0,
	@ttlqty as float =0,
	@avail_qty float =0,
	@ttlcost as float =0,
	@ttlinv as float =0

	declare @dbc varchar(20),
	@lusing_hij_date bit =0,
	@ldate varchar(10),
	@lfdate varchar(8)='',
	@errstatus int =0,
	@stunits_lcost float=0,
	@lwhno as char(2)=''



	set @STR_MSG=''
	set @RET_ID=0
	set @dbc=db_name()
	SET @lusing_hij_date=iif(cast(substring(@dbc,7,2) as int)>30,1,0)
	set @comp=substring(@dbc,4,2)
	if @lusing_hij_date=1
	begin
		set @ldate =convert(varchar(10),getdate(),131)
		set @lfdate=substring(@ldate,7,4)+substring(@ldate,4,2)+iif(substring(@ldate,1,1)=' ','0'+substring(@ldate,2,1),substring(@ldate,1,2))
	end
	else
	begin
		set @ldate = convert(varchar(10),getdate(),112)
		set @lfdate=@ldate		
	end
	declare @lcaalwngtvs bit =0,
	        @yrcode varchar(4),
	        @syscode int =2

	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>40,'14','20')+rtrim(@yrcode)
------------------------------------------------------
	declare @lslcenter char(2),
		@linvorrtrn char(1),
		@lentries int ,        
		@linvttl float,
		@linvcst float,
		@linvdsvl float,
		@lvalafds float,
		@lfcamt float,
		@lprpaid numeric(13,3),
		@lcash numeric(13,3),
		@lccpayment numeric(13,3),
		@lcsanedcrdamt numeric(13,3),
		@lcharges numeric(13,3),
		@lcccommision float,
		@ljhfcflag numeric(1,0)=2,
		@lt_qty numeric(13,3),
		@lxq numeric(13,3),
		@ldummy char(24),
		@arr_ptr int =0,
		@subttlcost float=0,
		@lpack1 char(1)=''
-------------------------------------------------------
	---
	---   sales_dt declarations
	---
	declare @litemno char(16),
		@lunicode char(6) ,
		@lqty  numeric(13,3),
		@lfqty  numeric(13,3),
		@ldiscpc float,
		@lds_acfm numeric(1,0),
		@lsl_acfm numeric(1,0),
		@lgclass char(8),
		@lbarcode char(20),
		@limfcval float,
		@lpack char(1),
		@lpkqty numeric(8,3),
		@lcmbkey char(24),
		@litemtype char(1),
		@llcost float,
		@blcost float,
		@lfcost float,
		@lstfcy char(3),
		@lclasskey char(12),
		@cl_slser char(19),
		@lslptr int=0,
		@lstptr int=0,
		@lttl_inv float=0,
		@lshadd char(1),
		@lshdpk numeric(9,3),
		@lfolio int,
		@ltaxtype char(1),
		@lfcy char(3),
		@ldsc_amt float




	--
	--   Stbins declaration 
	--
	declare @bwhno char(2),
		@bbinno char(6),
		@brmnqty numeric(13,3),
		@lnobinno bit=1,
		@lastbinno char(6)
    
	-- variables for sales_hd
	declare @hslcenter char(2),
		@hbranch char(2),
		@hcompany char(2),
		@hinvtype char(2),
		@href numeric(6,0),
		@hinvdate char(8) ,        
		@hcustno char(6), 
		@hfcy char(3)='',
		@hfcyrate float=0,
		@hinvttl float,
		@hinvcst float,
		@hvalafds float,
		@hinvpaid numeric(13,3),
		@hextamt numeric(13,3),
		@hextser char(19),
		@hcccommsn float,
		@hbelowbal bit=0,
		@hccpayment numeric(13,3),
		@hsanedcrdamt numeric(12,3),
		@hrplsamt numeric(13,3),
		@hprpaidamt numeric(13,3),
		@husrid char(8),
		@hfxrate float =0,
		@hINSTFLAG bit,
		@hposinv numeric(1,0)=1	

	Declare @xbelowbal bit =0
------------------------------  Get Data From Sysuse ---------------------------------------------------------------
		select @xbelowbal=belowbal 
			 from sysuse with (NOLOCK)
			where username=@USRID 
		if @lbelowbal=1 and isnull(@xbelowbal,0)=0 
		begin
		   set @RET_ID=-7
		   return
		end
------------------------------  Get Data From salecntr ---------------------------------------------------------------
	declare @ldp_cashser char(19),
		@ldp_okdiff bit ,
		@ldp_mainwh char(2),
		@ldp_expser char(19),
		@ldp_oslser char(19),
		@ldp_cardcomm char(19),
		@ldp_rplsac char(19),
		@ldp_diffser char(19),
		@lDP_CSLSER char(19),
		@lDP_RCSLSER char(19),
		@lprpaidcrdac char(19),
		@ltdate char(8),
		@lglacct char(19),
		@lexacct char(19),
		@ldp_slser char(19),
		@lsanedcrd_act char(19),
		@lcstctr char(4)=''

	declare @xttl_cost float=0,
		@inv_lmtt  float=0,
		@inv_lftt  float=0,
		@m_vl      float=0,
		@m_fc      float=0,
		@inv_stk   float=0,
		@m_lccntr  float=0,
		@m_fccntr  float=0,
		@pd_lc     float =0,
		@opstval varchar(50),
		@diff_amt float=0,
		@new_rate float=0,
		@match_image bit ,
		@fc_to_lc_ttl float=0,
		@ch_cnt int =0,
		@l_crtot float=0,
		@f_crtot float=0,
		@l_dbtot float=0,
		@f_dbtot float=0,
		@m_sign int =1,
		@m_value float=0,
		@m_fcval float=0,
		@plcamt float ,
		@pfcamt float ,
		@fcfcy char (3),
		@lcurname char(20),
		@replication bit =0,
		@xclkey char(12)='',
		@clsname char(20)='',
		@cstcode char(4)='',
		@dscact char(19)='',
		@dscclassamt float=0,
		@dsc_ptr int =0,
		@ttl_class_dsc float=0

	declare @hcustnm varchar(50)='',
	    @hcaser varchar(19)='',
		@haddress varchar(50)='',
		@lvat_rcvd_act varchar(19)=''
		

		select @ldp_cashser=dp_cashser,@ldp_okdiff=dp_okdiff,@ldp_mainwh=dp_mainwh,@ldp_expser=dp_expser,
		@ldp_oslser=dp_oslser,@ldp_cardcomm=dp_cardcomm,@ldp_rplsac=dp_rplsac,@ldp_diffser=dp_diffser,
		@lDP_CSLSER=DP_CSLSER,@lDP_RCSLSER=DP_RCSLSER,@lprpaidcrdac=prpaidcrdac,@lsanedcrd_act=sanedcrd_act,@lcstctr=isnull(cstcode,''),
		@lvat_rcvd_act=vat_rcvd_act
			from salecntr with (NOLOCK)
		where dp_brno=@BRANCH and dp_dept=@SLCNTR
------------------------------------------------------------------------------------------------------------------------	
------------------------  Get Customer Info  
----
        declare @cstaddrs varchar(60)='',
		@cstclass char(2)='',
		@cstcu_ctlser varchar(19)='',
		@dbtglacct char(19)='',
		@cstmaxlimit numeric(11,3)=0,
		@ldudate char(10)='',
		@ldudays int =0,
		@lcu_name varchar(50)=''

		Declare @hpricevattype numeric(1,0),@hNo_round_nm bit,@hvat_percent numeric(5,2),
		@hclnt_taxcode varchar(20),@hclnt_kind char(1)
		
		set @lwhno=@ldp_mainwh
		if len(rtrim(@lcustcode))>0
		begin
			select @lcu_name=cu_name,@cstaddrs=cu_addrs,@cstclass=cu_class,@cstcu_ctlser=cu_ctlser,@cstmaxlimit=isnull(cu_crlmt,0),
			@ldudays=isnull(cu_pymnt,0),@hclnt_taxcode=isnull(clnt_taxcode,''),@hclnt_kind=isnull(cu_kind,'') from customer where cu_company=@branch and cu_code=@lcustcode
			if len(isnull(@cstcu_ctlser,''))>0  set @dbtglacct=@cstcu_ctlser
			else
			begin
			   select @dbtglacct=cl_crlser from classfil where cl_company=@BRANCH and cl_code=@cstclass
			end
		end

		set @hcaser=''
		set @ldp_slser=''
		if @ltrtype ='06'
		begin
			set @hcaser=@ldp_cashser
			set @dbtglacct=@hcaser
			set @ldp_slser=@lDP_CSLSER
			set @hcustnm='مبيعات نقدية تمت عن طريق الجوال'				
		end
		else
		begin
			set @ldp_slser=@ldp_oslser
			set @hcustnm='مبيعات آجلة تمت عن طريق الجوال'
-------------------------- To calculate Due date
			if @ldudays>0
			begin
				if @lusing_hij_date=1
				begin
					set @ldate =convert(varchar(10),dateadd(dd,@ldudays,getdate()),131)
					set @ldudate=substring(@ldate,7,4)+substring(@ldate,4,2)+iif(substring(@ldate,1,1)=' ','0'+substring(@ldate,2,1),substring(@ldate,1,2))
				end
				else
				begin
					set @ldate = convert(varchar(10),dateadd(dd,@ldudays,getdate()),112)
					set @ldudate=@ldate		
				end
			end
			else set @ldudate=@lfdate
		end


------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
    declare @lcaokcstctr bit =0
	select @syscode=sysno,@lcaalwngtvs=isnull(caalwngtv ,0),@lcaokcstctr=isnull(caokcstctr,0),@hpricevattype=isnull(pricevattype,0),
	       @hNo_round_nm=isnull(No_round_nm,0),@hvat_percent=vat_percent
	       from sysdb.dbo.glcalend with (nolock)
	       where calcomp=@comp and yrcode=@yrcode

--------------------------------------------------------------------------------------------------------------------------- 


	declare @ref int=0,
	        @l_vt float=0
	

	--EXEC sp_xml_removedocument @handle
	


    DECLARE @j INT=1
	set @ref =0
	--set @Trdate=CONVERT(VARCHAR(10), getdate(), 112)
	select @ref =dbo.get_last_ref(@ltrtype, @branch)
       begin transaction

		if @ltrtype='06' update stbranch set jv_06=@ref+1 where brnno=@BRANCH
		else update stbranch set jv_04=@ref+1 where brnno=@BRANCH
		if @@error<>0
		begin
			rollback transaction
			SET @RET_ID = -1
			SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
			set @errstatus =-1
			goto jumplbl
		end
		commit transaction
---------------------------- Calculate the customer max limit 
  declare @tmp_ttl_inv float =0,
          @cst_curbal float =0,
		  @lposted bit =0


  --if @cstmaxlimit>0 and @ltrtype='04'
  --begin
  --      if @syscode<>6
  --    		Select @tmp_ttl_inv=sum((frtqty+(shdqty*pkqty1))*price)
		--	From #TEMPSLINV_PDA a inner join stunits b on a.barcode=b.barcode
		--else
		--	Select @tmp_ttl_inv=sum(shdqty*price)
		--	From #TEMPSLINV_PDA 

		--exec dbo.get_client_bal @BRANCH,@lcustcode,@lfcy,@lposted,@cst_curbal output
		--if @cst_curbal+@tmp_ttl_inv>@cstmaxlimit
		--begin
		--	SET @RET_ID = -55
		--	SET @STR_MSG ='العميل'+' '+@lcu_name+' '+'تجاوز الحد الاعلى للمديونية'
		--	set @errstatus =-1			
		--	goto jumplbl
		--end
  --end
  
---------------------------------------------------------------------
 -- DECLARE ARRAY HOLDING THE ITEM CLASS AND ACCOUNT
	    declare @class_arr table( p_ptr int,clkey char(12) not null , act char(19) not null,lcamt float ,
		clsname char(20),cstcode char(4),dscact char(19))

        --declare @dsc_class_val table(classkey char(12) not null,dscclassamt float default 0)   


		begin transaction
------------------------------------------------------------------------------
 

		insert into sales_hd 
		(slcenter,branch ,company ,invtype ,ref ,invdate,custno ,custnm ,glser,dsctype ,pstmode
		,fcy,fcyrate,duedate ,invttl,invcst,invdspc ,invdsvl ,valafds ,invpaid ,caser ,entries
		,released,posted ,fixrate ,extamt,extser ,pricetp,ischeque ,chkno ,chkdate ,lastupdt,jvgenrt
		,cccommsn ,belowbal,fcy2,ccpayment ,rplsamt,pdother ,slcode,prpaidamt,instldays ,instflag
		,slcmnd ,inv_printed ,bendit ,modified ,rqstorder ,rqststld ,carrier ,rcvdtrn ,usrid ,address
		,suspend ,rtnref,ispurchase ,stkjvno ,posinv ,sanedcrd_amt,
		vat_amt_rcvd,taxfree_sales,	clnt_taxcode,clnt_kind,hlldscnt,sysno,No_round_nm,
		PriceVatType,vat_percent)
		values (@SLCNTR,'Q',@BRANCH,@ltrtype,@ref,@lfdate,@lcustcode ,@hcustnm,'','',0,
		'',0,@ldudate,0,0,@hinvdspc,@hinvdsvl,0,0,@hcaser,0,
		0,0,0,0,'','1',0,'','',@lfdate,0,
		0,0,'',0,0,0,@SLPRSN ,0,0,0,
		0,0,0,1,0,0,'',0,@USRID ,@haddress,
		0,0,0,0,4,0,
		@hvat_amt_rcvd,@htaxfree_sales,@hclnt_taxcode,@hclnt_kind,0,@syscode,@hNo_round_nm,@hpricevattype,@hvat_percent)
		if @@error<>0
		begin
			rollback transaction
			SET @RET_ID = -2
			SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))    
			set @errstatus =-2
			goto jumplbl
		end
-----------------------------------------------------------------------------
	--
	--- insert one record in STHDR
	-- 

	 insert into sthdr (branch, trtype, ref, trdate, text, amnttl, costttl, sysdate, src, released,
	 posted, fcy, fcyrate, whno, entries, lastupdt, towhno, modified, rcvdtrn, custno, usrid, brsupp,
	 tobrno, brxref, glref, isbrtrx, asmtype, repost )
	 values(@branch ,@ltrtype,@ref ,@lfdate,@hcustnm,0,0,@lfdate,'05',0,
	       0,'',0,'',0,@lfdate,'',0,0,@lcustcode ,@usrid,'',
		   '',0,0,0,0,0)

		if @@error<>0
		begin
			rollback transaction
			SET @RET_ID = -3
			SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))    
			set @errstatus =-3
			goto jumplbl
		end
		--
		-- Insert One Record in GLJRHR
		--
		set @ljhfcflag=2
		insert into gljrhdr (jhcomp,jhtype,jhref,jhcurr,jhamt,jhdate,jhrate,jhtext,jhsrc,jhfcflag,jhreleased,jhposted,
		jhsysdate,modified,[Suspend],usrid,lastupdt,rcvdtrn,isbrtrx,brxref,brxfrm,jhcustno) 
		values (@branch,@ltrtype,@ref,'',0,@lfdate,0,@hcustnm,'05',
		@ljhfcflag,0,0,@lfdate,1,0,@USRID ,@lfdate,0,0,'','','')
		if @@error<>0
		begin
			rollback transaction
			SET @RET_ID = -4
			SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
			set @errstatus =-4
			goto jumplbl
		end  
	-------------------------------------get_client_bal

    if @errstatus=0
	begin
	 --   if @syscode <> 6
		--begin
		--	DECLARE Cursdtl CURSOR LOCAL FAST_FORWARD FOR
		--	Select a.barcode,shdqty,frtqty,price,pack0,pkqty1,lcost,substring(c.classkey,1,2) as classkey,
		--	cmbkey,b.itemno,b.unicode,pack1
		--	From #TEMPSLINV_PDA a inner join stunits b on a.barcode=b.barcode 
		--	inner join stitems c on b.itemno=c.itemno
		--end
		--else
		--begin
		--	DECLARE Cursdtl CURSOR LOCAL FAST_FORWARD FOR
		--	Select a.barcode,shdqty,frtqty,price,pack0,d.pkqty as pkqty1,lcost,substring(c.classkey,1,2) as classkey,
		--	b.cmbkey,b.itemno,b.unicode,d.pack as pack1
		--	From #TEMPSLINV_PDA a inner join stitembc d on a.barcode=d.pbarcode 
		--	inner join stunits b on d.itemno=b.itemno and d.unicode=b.unicode
		--	inner join stitems c on b.itemno=c.itemno
		--end
		EXEC sp_xml_preparedocument @handle OUTPUT, @API_Inv

		Declare Cursdtl Cursor For
		SELECT    *  
		FROM      OPENXML (@handle, '/Root/sales_dt',2)  with
		(cmbkey varchar(24),barcode varchar(20),
		qty float,price float,
		 pack char(1),pkqty numeric(9, 3),shdpk numeric(9, 3),shdqty float,frtqty float,
		 Taxtype char(1))
		open Cursdtl 
		Fetch Next From Cursdtl Into @lcmbkey,@lbarcode,@lqty,@lprice,@lpack,@lpkqty,@lshdpk,@lshdqty,@lfrtqty,@ltaxtype
        
	    EXEC sp_xml_removedocument @handle

	  	set @ch_cnt  =0
		set @l_crtot =0
		set @f_crtot =0
		set @l_dbtot =0
		set @f_dbtot =0
		set @m_value=0
		set @m_fcval=0
		set @xttl_cost=0
		set @lslptr=0
		set @lstptr=0
		set @lttl_inv=0
				
		set @ttl_class_dsc=0
		set @dsc_ptr=0
		set @xttl_cost=0
		set @inv_stk=0
		set @inv_lftt=0
		set @inv_lmtt=0
		set @m_lccntr=0
		set @m_fccntr=0
		set @arr_ptr=0
		WHILE dbo.FetchStatusOfCursorNamed('Cursdtl') = 0 
		begin
		    set @lnobinno=1
			set @lastbinno=space(6)
		    set @lpkqty=isnull(@lpkqty,1)
			set @lpkqty=iif(@lpkqty=0,1,@lpkqty)
			set @lpack=iif(isnull(@lpack,'')='','',@lpack)
			if  @syscode in (4,5)
			begin
			    set @lshdqty=isnull(@lshdqty,0)
				set @lfrtqty=isnull(@lfrtqty,0)
				set @lshdpk=isnull(@lshdpk,1)
				set @lshdpk=iif(@lshdpk=0,1,@lshdpk)
			    set @qty=@lfrtqty+(@lshdqty*@lshdpk)
			end
		    else set @qty=@lqty*@lpkqty
            set @ltaxtype=isnull(@ltaxtype,'1')
			if @ltaxtype='0' or rtrim(@ltaxtype)='' set @ltaxtype='1'

			select @lclasskey=substring(a.classkey,1,2),@litemno=b.itemno,@lunicode=b.unicode,@litemtype=itemtype,@pack0=pack0,@lpack1=pack1
			from stitems a inner join stunits b
			on a.itemno=b.itemno where b.cmbkey=@lcmbkey

			set @avail_qty=0
			set @lcost=0
			set @lclasskey=iif(isnull(@lclasskey,'')='','',@lclasskey)
			set @lclasskey=rtrim(@lclasskey)+replicate(space(1),12-datalength(rtrim(@lclasskey)))	
			set @cl_slser=''		 
			select @cl_slser=iif(@ltrtype='06',SERCSH,SERCRD),@clsname=name,@cstcode=cstcode,@dscact=serdsc
				from slclass with (NOLOCK) where company=@BRANCH and cmbkey=@lclasskey
			if rtrim(isnull(@cl_slser,''))='' 
			begin
				set @lsl_acfm=3
				set @lds_acfm=3
				set @lgclass=''
			end
			else
			begin
				set @lsl_acfm=2
				set @lds_acfm=2
				set @lgclass=rtrim(@lclasskey)
			end
			set @l_vt=0
			set @m_vl=-iif(@syscode not in (4,5),(@lqty*@lprice),@qty*@lprice)
            if @hpricevattype>1 and @hvat_amt_rcvd>0 and @ltaxtype='1' --and @lnvp_vat_percent>0
			begin
			    set @l_vt=@m_vl*@hvat_percent/(@hvat_percent+100)
				set @m_vl=@m_vl+@l_vt
			end
			set @m_fc=0.00
			set @inv_lftt=@inv_lftt+abs(@m_vl)
			set @inv_lmtt=@inv_lmtt+Abs(@m_vl)   
			set @inv_stk=@inv_stk+Abs(@m_vl) 
			if @lsl_acfm=2
			begin 
				set @xclkey=''
				select @xclkey=clkey from  @class_arr where clkey=@lclasskey
				if rtrim(isnull(@xclkey,''))=''
				begin
					set @arr_ptr+=1
					insert into @class_arr values (@arr_ptr,@lclasskey,@cl_slser,@m_vl,@clsname,@cstcode,@dscact)
				end
				else update @class_arr set lcamt=lcamt+@m_vl where clkey=@lclasskey
			end
			if @lsl_acfm=3
			begin
				set @m_lccntr=@m_lccntr+@m_vl
				set @m_fccntr=@m_fccntr+@m_fc
			end

			set @lttl_inv=@lttl_inv+abs(@m_vl)
			set @avail_qty=0

			if @lbelowbal = 0 and @lcaalwngtvs=0
			begin
				select @avail_qty=sum(qty-abs(rsvqty)) from stbins where branch=@BRANCH and itemno=@litemno and unicode=@lunicode
				and whno=@lwhno 
				set @avail_qty=isnull(@avail_qty,0)
				if @qty>@avail_qty
				begin
					rollback transaction
					SET @RET_ID = -5
					SET @STR_MSG = 'الكمية تجاوزت الرصيد المتاح للصنف '+' '+@lcmbkey
					set @errstatus =-5
					break
				end
			end
			set @subttlcost=0
			if @litemtype not in ('5','6')
			begin
				set @lt_qty=@qty
				DECLARE lstbins CURSOR LOCAL FAST_FORWARD FOR
				select binno,qty-rsvqty as qty,lcost from stbins where branch=@branch and
				itemno=@litemno and unicode=@lunicode and whno=@lwhno
				open lstbins;
				fetch next from lstbins into @bbinno,@brmnqty,@blcost
				WHILE dbo.FetchStatusOfCursorNamed('lstbins') = 0 and @lt_qty>0
				begin
				    
					set @lnobinno=0
					set @lastbinno=@bbinno
					if @brmnqty>0
					begin
						if @lt_qty>@brmnqty set @lxq=@brmnqty
						else set @lxq=@lt_qty
						set @lstptr=@lstptr+1
						insert into stdtl (itemno, unicode, branch, trtype, qty, fqty, whno, binno, lcost, trdate, ref,
							sysdate, src, lprice, fcost, fprice, expdate, towhno, tobinno, barcode, cmbkey, discpc, pack,
							shdpk, shdqty, folio, rplct_post)
						values(@litemno,@lunicode,@BRANCH,@ltrtype,@lxq,0,@lwhno,@bbinno,@blcost,@lfdate,
						@ref,@lfdate,'05',@lprice,0,0,'','','',@lbarcode,@lcmbkey,0,@pack0,1,@lxq,@lstptr,0)
						if @@error<>0
						begin
							rollback transaction
							SET @RET_ID = -6
							SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))    
							set @errstatus =-6
							break
						end
						set @subttlcost=@subttlcost+(@blcost*@lxq)
						set @lt_qty=@lt_qty-@lxq
		--
		-- Update the RSVQTY of stbins
		--
						update stbins set rsvqty=rsvqty+@lxq where branch=@BRANCH and
								itemno=@litemno and unicode=@lunicode and whno=@lwhno and binno=@bbinno
						if @@error<>0
						begin
							rollback transaction
							SET @RET_ID = -7
							SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
							set @errstatus =-7
							break
						end
					end
					if @lt_qty<=0 break					
					fetch next from lstbins into @bbinno,@brmnqty,@blcost
				end				  
				close lstbins
				deallocate lstbins
				if @errstatus<0 break

				if @lt_qty>0  
				if (@lbelowbal=1 or (@syscode in (2,3,6) and @lcaalwngtvs=1))
				begin
					--set @hbelowbal = 1
					if @lnobinno=1
					begin
						set @ldummy=''
						select @ldummy=cmbkey from stunits with (NOLOCK) where itemno=@litemno and unicode=@lunicode
						if RTRIM(isnull(@ldummy,''))<>''
						begin
							insert into stbins (itemno,unicode,lcost,whno,branch,binno,fcost,openlcost,openfcost,openbal,qty,rsvqty,expdate) values
							(@litemno,@lunicode,@llcost,@ldp_mainwh,@BRANCH,@lastbinno,0,0,0,0,0,0,' ')
			    			if @@error<>0
							begin
								rollback transaction
								SET @RET_ID = -8
								SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
								set @errstatus =-8
								break
							end
						end						                           
					end
					set @lstptr=@lstptr+1
					set @lxq=@lt_qty
					if @lnobinno=0 and @blcost>0 set @llcost=@blcost
					insert into stdtl (itemno, unicode, branch, trtype, qty, fqty, whno, binno, lcost, trdate, ref,
							sysdate, src, lprice, fcost, fprice, expdate, towhno, tobinno, barcode, cmbkey, discpc, pack,
							shdpk, shdqty, folio, rplct_post)
					values(@litemno,@lunicode,@BRANCH,@ltrtype,@lxq,0,@lwhno,@lastbinno,
					@llcost,@lfdate,
					@ref,@lfdate,'05',@lprice,0,0,'','','',@lbarcode,@lcmbkey,0,@pack0,1,@lxq,@lstptr,0)
					if @@error<>0
					begin
						rollback transaction
						SET @RET_ID = -9
						SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))    
						set @errstatus =-9
						break
					end
					set @subttlcost=@subttlcost+(@llcost*@lxq)
					update stbins set rsvqty=rsvqty+@lxq where branch=@BRANCH and
						itemno=@litemno and unicode=@lunicode and whno=@lwhno and binno=@lastbinno
					if @@error<>0
					begin
						rollback transaction
						SET @RET_ID = -10
						SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
						set @errstatus =-10
						break
					end
				end   -- end of @lt_qty>0
				else
				begin
				   rollback transaction
				   SET @RET_ID = -99
				   set @errstatus =-99
				   SET @STR_MSG = 'الكمية تجاوزت الرصيد المتاح للصنف '+' '+@lcmbkey
				   break
				end

				update stunits set rsvqty=rsvqty+@qty where itemno=@litemno and unicode=@lunicode	
				if @@error<>0
				begin
					rollback transaction
					SET @RET_ID = -11
					SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
					set @errstatus =-11
					break
				end
			end
---------------------------------------------------------------------------------------------------------------------
            set @ldiscpc=0
			set @llcost=@subttlcost/(@qty)
			set @xttl_cost=@xttl_cost+(@qty*@llcost)
			set @lslptr=@lslptr+1
			if @syscode in (4,5,8,9)
				insert into sales_dt (slcenter, company, invtype, ref, invdate, itemno, unicode, qty, fqty, price, discpc,
					cost, ds_acfm, sl_acfm, gclass, custno, fcy, barcode, imfcval, pack, pkqty, shadd, shdpk, shdqty, frtqty, rtnqty, whno, 
					cmbkey, folio, rplct_post, sold_item_status,taxtype)
				values(@SLCNTR,@BRANCH,@ltrtype,@ref,@lfdate,@litemno,@lunicode,
				@qty,0,@lprice,@ldiscpc,@llcost,@lds_acfm,@lsl_acfm,@lgclass,'','',@lbarcode,0,@pack0,1,
				@lpack1,@lshdpk,@lshdqty,@lfrtqty,0,@lwhno,@lcmbkey,@lslptr,0,0,@ltaxtype)
			else
			    --if @syscode=6
				    insert into sales_dt (slcenter, company, invtype, ref, invdate, itemno, unicode, qty, fqty, price, discpc,
						cost, ds_acfm, sl_acfm, gclass, custno, fcy, barcode, imfcval, pack, pkqty, shadd, shdpk, shdqty, frtqty, rtnqty, whno, 
						cmbkey, folio, rplct_post, sold_item_status,taxtype)
					values(@SLCNTR,@BRANCH,@ltrtype,@ref,@lfdate,@litemno,@lunicode,
					@lqty,0,@lprice,@ldiscpc,@llcost,@lds_acfm,@lsl_acfm,@lgclass,'','',@lbarcode,0,@lpack,@lpkqty,
					'',0,0,0,0,@lwhno,@lcmbkey,@lslptr,0,0,@ltaxtype)
				--else
				--insert into sales_dt (slcenter, company, invtype, ref, invdate, itemno, unicode, qty, fqty, price, discpc,
				--	cost, ds_acfm, sl_acfm, gclass, custno, fcy, barcode, imfcval, pack, pkqty, shadd, shdpk, shdqty, frtqty, rtnqty, whno, 
				--	cmbkey, folio, rplct_post, sold_item_status,taxtype)
				--values(@SLCNTR,@BRANCH,@ltrtype,@ref,@lfdate,@litemno,@lunicode,
				--@qty,0,@lprice,@ldiscpc,@llcost,@lds_acfm,@lsl_acfm,@lgclass,'','',@lbarcode,0,@lpack,1,
				--'',0,0,0,0,@lwhno,@lcmbkey,@lslptr,0,0,@ltaxtype)
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -12
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
				set @errstatus =-12
				break
			end
---------------------------------------------------------------------------------------------------------------------			
		    Fetch Next From Cursdtl Into @lcmbkey,@lbarcode,@lqty,@lprice,@lpack,@lpkqty,@lshdpk,@lshdqty,@lfrtqty,@ltaxtype
									
		END
		CLOSE Cursdtl 
		DEALLOCATE Cursdtl

		if @errstatus =0 and @lslptr>0
		begin
				
			set @pd_lc=@lttl_inv
			set @opstval=''
			set @diff_amt=0
			set @new_rate=0
			set @match_image=0
			set @hinvpaid=0
			set @hvalafds = @lttl_inv
			if @ltrtype='06' set @hinvpaid=@lttl_inv
				
				    
					
            set @opstval=@hcustnm

			--
			-- Process GLJRDTL entries
			--
			set @ch_cnt +=1
			set @m_value=@pd_lc-@hinvdsvl+iif(@hpricevattype<=1,@hvat_amt_rcvd,0)
			set @pd_lc=@m_value
			set @m_fcval=0
			insert into gljrdtl 
			(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post,taxcatId )
			values (@BRANCH,@ltrtype,@ref,@dbtglacct,@lfdate,@opstval,
			abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@lfdate,'05',0,0,'','','',0,0,0,0)	
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -13
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
				set @errstatus =-13
				goto jumplbl
			end
			If @m_value<0
			begin
				set @l_crtot=@l_crtot+Abs(@m_value)
				set @f_crtot=@f_crtot+Abs(@m_fcval)
			end
			Else
			begin
				set @l_dbtot=@l_dbtot+Abs(@m_value)
				set @f_dbtot=@f_dbtot+Abs(@m_fcval)
			End	
------------------------------------  Process GLdtl on the class level  ----------------------------------
            if @arr_ptr>0
			begin
				while @arr_ptr>0
				begin
					set @cl_slser=''
					set @dscact=''
					set @cstcode=''
					set @m_vl=0
					select @cl_slser=act,@m_vl=lcamt,@clsname=clsname,@cstcode=cstcode,@dscact=dscact,@xclkey=clkey
					from @class_arr
					where p_ptr=@arr_ptr
					if isnull(@cl_slser,'')<>'' and isnull(@m_vl,0)<>0
					begin
						set @m_value=@m_vl
						set @m_fcval=0
						set @opstval='مبيعات قسم'+' '+rtrim(@clsname)
						set @ch_cnt +=1
						insert into gljrdtl 
						(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                        ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post,taxcatId )
						values (@BRANCH,@ltrtype,@ref,@cl_slser,@lfdate,@opstval,
						abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@lfdate,'05',0,0,'','','',0,0,0,0)	
						if @@error<>0
						begin
							rollback transaction
							SET @RET_ID = -14
							SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
							set @errstatus =-14
							goto jumplbl
						end
						if @lcaokcstctr=1 and isnull(@cstcode,'')<>''
						begin
							insert into gljrcost (company,jdtype,jdref,cstcode,jdkey,jdcurr,Xpercent,amt,jddbcr
							,jdfc_imgval,jdfolno,rplct_post)
							values (@BRANCH,@ltrtype,@ref,@cstcode,@cl_slser,'',0,abs(@m_value),
							iif(@m_sign*@m_value<0,'C','D'),0,@ch_cnt,0)
							if @@error<>0
							begin
								rollback transaction
								SET @RET_ID = -15
								SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
								set @errstatus =-15
								goto jumplbl
							end
						end
						If @m_value<0
						begin
							set @l_crtot=@l_crtot+Abs(@m_value)	
							set @f_crtot=@f_crtot+Abs(@m_fcval)					
						end
						Else
						begin
							set @l_dbtot=@l_dbtot+Abs(@m_value)	
							set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
						End	
					end
					set @arr_ptr-=1
				end  -- end of @arr_ptr loop
            end  ----  end of @arr_ptr
----------------------------------------------------------------------------------------------------------------					
				
			If @m_lccntr<>0 Or @m_fccntr<>0
			begin
				set @m_value=@m_lccntr
				set @m_fcval=@m_fccntr
				set @opstval=@hcustnm
				set @ch_cnt +=1
				insert into gljrdtl 
				(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                        ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post,taxcatId )
				values (@BRANCH,@ltrtype,@ref,@ldp_slser,@lfdate,@opstval,
				abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@lfdate,'05',0,0,'','','',0,0,0,0)	
				if @@error<>0
				begin
					rollback transaction
					SET @RET_ID = -16
					SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
					set @errstatus =-16
					goto jumplbl
				end
--					
----------- For Cost center process
--
				if @lcaokcstctr=1 and isnull(@lcstctr,'')<>''
				begin
					insert into gljrcost (company,jdtype,jdref,cstcode,jdkey,jdcurr,Xpercent,amt,jddbcr
					,jdfc_imgval,jdfolno,rplct_post)
					values (@BRANCH,@ltrtype,@ref,@lcstctr,@ldp_slser,'',0,abs(@m_value),
					iif(@m_sign*@m_value<0,'C','D'),0,@ch_cnt,0)
					if @@error<>0
					begin
						rollback transaction
						SET @RET_ID = -17
						SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
						set @errstatus =-17
						goto jumplbl
					end
				end
				If @m_value<0
				begin
					set @l_crtot=@l_crtot+Abs(@m_value)	
					set @f_crtot=@f_crtot+Abs(@m_fcval)					
				end
				Else
				begin
					set @l_dbtot=@l_dbtot+Abs(@m_value)	
					set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
				End	
			end  -- end of @m_lccntr
			if @hinvdsvl>0 --dbo.value_balanced(@hinvdsvl,@ttl_class_dsc)=0 and @lNoDsc4SlPuJv=0 -- Added on 2020-11-23 AA
			begin
				set @m_value=@hinvdsvl-@ttl_class_dsc
				set @m_fcval=0
				set @opstval='خصومات المبيعات'
				set @ch_cnt +=1
				insert into gljrdtl 
				(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                        ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post,taxcatId )
				values (@BRANCH,@ltrtype,@ref,@ldp_expser,@lfdate,@opstval,
				abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@lfdate,'05',0,0,'','','',0,0,0,0)	
				if @@error<>0
				begin
					rollback transaction
					SET @RET_ID = -16
					SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
					set @errstatus =-16
					goto jumplbl
				end
--					
----------- For Cost center process
--
				if @lcaokcstctr=1 and isnull(@lcstctr,'')<>''
				begin
					insert into gljrcost (company,jdtype,jdref,cstcode,jdkey,jdcurr,Xpercent,amt,jddbcr
					,jdfc_imgval,jdfolno,rplct_post)
					values (@BRANCH,@ltrtype,@ref,@lcstctr,@ldp_expser,'',0,abs(@m_value),
					iif(@m_sign*@m_value<0,'C','D'),0,@ch_cnt,0)
					if @@error<>0
					begin
						rollback transaction
						SET @RET_ID = -16
						SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
						set @errstatus =-16
						goto jumplbl
					end
				end
				If @m_value<0
				begin
					set @l_crtot=@l_crtot+Abs(@m_value)	
					set @f_crtot=@f_crtot+Abs(@m_fcval)					
				end
				Else
				begin
					set @l_dbtot=@l_dbtot+Abs(@m_value)	
					set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
				End	
			end  -- end of @hinvdsvl
		-- *----  Processing the Value Added Tax paid by client 

				if @hvat_amt_rcvd<>0
				begin
					set @m_value=-@hvat_amt_rcvd 
					set @m_fcval=0
					set @opstval='ضريبة القيمة المضافة'
					set @ch_cnt +=1
					insert into gljrdtl 
					(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                         ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post,taxcatId )
					values (@BRANCH,@ltrtype,@ref,@lvat_rcvd_act,@lfdate,@opstval,
					abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@lfdate,'05',0,0,'','','',0,0,0,1)	
					if @@error<>0
					begin
						rollback transaction
						SET @RET_ID = -16
						SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
						set @errstatus =-16
						goto jumplbl
					end
--					
----------- For Cost center process
--
					if @lcaokcstctr=1 and isnull(@lcstctr,'')<>''
					begin
						insert into gljrcost (company,jdtype,jdref,cstcode,jdkey,jdcurr,Xpercent,amt,jddbcr
						,jdfc_imgval,jdfolno,rplct_post)
						values (@BRANCH,@ltrtype,@ref,@lcstctr,@lvat_rcvd_act,'',0,abs(@m_value),
						iif(@m_sign*@m_value<0,'C','D'),0,@ch_cnt,0)
						if @@error<>0
						begin
							rollback transaction
							SET @RET_ID = -16
							SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
							set @errstatus =-16
							goto jumplbl
						end
					end
					if not(@hpricevattype>1 and @hvat_amt_rcvd>0   ) --and @m_invtype='26'
						set @inv_lmtt=@inv_lmtt+Abs(@m_value)
					If @m_value<0
					begin
						set @l_crtot=@l_crtot+Abs(@m_value)	
						set @f_crtot=@f_crtot+Abs(@m_fcval)					
					end
					Else
					begin
						set @l_dbtot=@l_dbtot+Abs(@m_value)	
						set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
					End	
					
				end
				------  End of VAT process
--------------------------------------------------------------------------
		-----------------Update gljrhdr


			update gljrhdr set jhfcflag=2,jhentries=@ch_cnt,jhlccrttl = @l_crtot,
			jhfccrttl= @f_crtot,jhlcdbttl = @l_dbtot,jhfcdbttl = @f_dbtot,
			jhamt = Iif(@inv_lmtt>@l_dbtot,@inv_lmtt,@l_dbtot) where jhcomp=@BRANCH  and jhtype=@ltrtype and
			jhref=@ref
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -18
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
				set @errstatus =-18
				goto jumplbl
			end
				
	--------- Update sthdr
			If @lstptr>0
			begin
				update sthdr set entries=@lstptr,amnttl = @inv_stk,costttl = @xttl_cost where branch=@BRANCH 
				and trtype=@ltrtype and ref=@ref
			end
			else  delete from sthdr where branch=@BRANCH and trtype=@ltrtype and ref=@ref
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -19
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
				set @errstatus =-19
				goto jumplbl
			end
	--    Update sales_hd
			update sales_hd set entries=@lslptr,valafds=@lttl_inv,invcst=@xttl_cost,belowbal=@lbelowbal,
			invttl=@lttl_inv+iif(@hpricevattype>1,0,@hvat_amt_rcvd)
			where company=@BRANCH and invtype=@ltrtype and ref=@ref
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -20
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
				set @errstatus =-20
				goto jumplbl
			end
			if @ltrtype='04'
			begin
			     insert into arhdr
			     (hd_company, hd_type, hd_ref, hd_date, hd_fcy, hd_ftotal, hd_fcyrate, hd_ltotal, hd_cucode, 
				 hd_desc1, hd_ser, hd_rlsd, hd_posted, hd_trxsrc, hd_sysdate, hd_lcnet, hd_fcnet, hd_lccnet,
				 hd_fccnet, isit_opst, opst_val, opst_fcy, lastupdt, modified, rcvdtrn, usrid, clcode, clcmnd,
				 dscamt, payinv) 
				 values (@BRANCH,@ltrtype,@ref,@lfdate,'',0,0,@pd_lc,@lcustcode,
				 @hcustnm,'',0,0,'05',@lfdate,@pd_lc,0,0,
				 0,0,0,'',@lfdate,1,0,@USRID,'',0,0,0)
				if @@error<>0
				begin
					rollback transaction
					SET @RET_ID = -21
					SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
					set @errstatus =-21
					goto jumplbl
				end

				insert into ardtl 
				(dt_company, dt_type, dt_ref, dt_date, dt_lcamt, dt_paidamt, dt_discamt, dt_cucode, dt_fcy,
				 dt_trxsrc, dt_fcamt, dt_fpydamt, dt_fdscamt, dt_lcaloc, dt_fcaloc, dt_aloctd, dt_pdinv, dt_duedate,
                 dt_desc, dt_chkno, dt_chkdate, dt_chkbnk, dt_dbcr, dt_ackey, dt_folio, dt_rcvno, dt_lstdate,
				 tdscdays, tdscpcs, match, rplct_post)
				 values(@BRANCH,@ltrtype,@ref,@lfdate,@pd_lc,0,0,@lcustcode,'',
				 '05',0,0,0,0,0,'0',0,@lfdate,
				 @hcustnm,'','','','D','',1,0,'',
				 0,0,0,0)
				 if @@error<>0
				begin
					rollback transaction
					SET @RET_ID = -22
					SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
					set @errstatus =-22
					goto jumplbl
				end
			end
		end
	end
	jumplbl:
	if @errstatus=0 commit transaction
	select @RET_ID,@ref,@STR_MSG
    return --@errstatus
END TRY
	BEGIN CATCH
	    if @@TRANCOUNT>0 ROLLBACK TRANSACTION
		SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
		select @STR_MSG
		SET @RET_ID = -99
		RETURN ---99
END CATCH
end	




















GO
/****** Object:  StoredProcedure [dbo].[ImportSlinvPDAxml]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[ImportSlinvPDAxml]
@STR_MSG NVARCHAR(1000) OUT,
@RET_ID INT OUT,
@PDAXFR xml,
@SLCNTR Nchar(2),
@SLPRSN Nchar(2),
@BRANCH Nchar(2),
@USRID Nchar(10)

AS BEGIN 
   set lock_timeout 2000
BEGIN TRY
	DECLARE @shdpk NUMERIC(10,3)
	DECLARE @pack0 NVARCHAR(1)
	DECLARE @pack_0 char(1)
	DECLARE @lprice decimal(11,3)=0
	DECLARE @cmbkey NVARCHAR(24)
	DECLARE @itemno CHAR(16)
	DECLARE @unicode CHAR(6)
	DECLARE @lcost float
	declare @Trdate varchar(20)
	DECLARE @handle INT	
	DECLARE @barcode NVARCHAR(20)
	DECLARE @lcustcode nCHAR(6)
	DECLARE @lbinno CHAR(6)
	DECLARE @qty float
	declare @ltrtype nchar(2)
	DECLARE @comp char(2),
	@binno_found bit =0
	


	declare @ss as varchar(10),
	@srlno as int =0,
	@lshdqty as float=0,
	@lfrtqty as float =0,
	@ttlqty as float =0,
	@avail_qty float =0,
	@ttlcost as float =0,
	@ttlinv as float =0

	declare @dbc varchar(20),
	@lusing_hij_date bit =0,
	@ldate varchar(10),
	@lfdate varchar(8)='',
	@errstatus int =0,
	@stunits_lcost float=0,
	@lwhno as char(2)=''

	SET @ltrtype =substring(@STR_MSG,1,2)
	set @lcustcode=substring(@STR_MSG,4,6)

	set @STR_MSG=''
	set @RET_ID=0
	set @dbc=db_name()
	SET @lusing_hij_date=iif(cast(substring(@dbc,7,2) as int)>30,1,0)
	set @comp=substring(@dbc,4,2)
	if @lusing_hij_date=1
	begin
		set @ldate =convert(varchar(10),getdate(),131)
		set @lfdate=substring(@ldate,7,4)+substring(@ldate,4,2)+iif(substring(@ldate,1,1)=' ','0'+substring(@ldate,2,1),substring(@ldate,1,2))
	end
	else
	begin
		set @ldate = convert(varchar(10),getdate(),112)
		set @lfdate=@ldate		
	end
	declare @lcaalwngtvs bit =0,
	        @yrcode varchar(4),
	        @syscode int =2

	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
------------------------------------------------------
	declare @lslcenter char(2),
		@linvorrtrn char(1),
		@lentries int ,        
		@linvttl float,
		@linvcst float,
		@linvdsvl float,
		@lvalafds float,
		@lfcamt float,
		@lprpaid numeric(13,3),
		@lcash numeric(13,3),
		@lccpayment numeric(13,3),
		@lcsanedcrdamt numeric(13,3),
		@lcharges numeric(13,3),
		@lcccommision float,
		@ljhfcflag numeric(1,0)=2,
		@lt_qty numeric(13,3),
		@lxq numeric(13,3),
		@ldummy char(24),
		@arr_ptr int =0,
		@subttlcost float=0,
		@lpack1 char(1)=''
-------------------------------------------------------
	---
	---   sales_dt declarations
	---
	declare @litemno char(16),
		@lunicode char(6) ,
		@lqty  numeric(13,3),
		@lfqty  numeric(13,3),
		@ldiscpc float,
		@lds_acfm numeric(1,0),
		@lsl_acfm numeric(1,0),
		@lgclass char(8),
		@lbarcode char(20),
		@limfcval float,
		@lpack char(1),
		@lpkqty numeric(8,3),
		@lcmbkey char(24),
		@litemtype char(1),
		@llcost float,
		@blcost float,
		@lfcost float,
		@lstfcy char(3),
		@lclasskey char(12),
		@cl_slser char(19),
		@lslptr int=0,
		@lstptr int=0,
		@lttl_inv float=0
		
	--
	--   Stbins declaration 
	--
	declare @bwhno char(2),
		@bbinno char(6),
		@brmnqty numeric(13,3),
		@lnobinno bit=1,
		@lastbinno char(6)
    
	-- variables for sales_hd
	declare @hslcenter char(2),
		@hbranch char(2),
		@hcompany char(2),
		@hinvtype char(2),
		@href numeric(6,0),
		@hinvdate char(8) ,        
		@hcustno char(6), 
		@hfcy char(3)='',
		@hfcyrate float=0,
		@hinvttl float,
		@hinvcst float,
		@hinvdspc float,
		@hinvdsvl float,
		@hvalafds float,
		@hinvpaid numeric(13,3),
		@hextamt numeric(13,3),
		@hextser char(19),
		@hcccommsn float,
		@hbelowbal bit=0,
		@hccpayment numeric(13,3),
		@hsanedcrdamt numeric(12,3),
		@hrplsamt numeric(13,3),
		@hprpaidamt numeric(13,3),
		@husrid char(8),
		@hfxrate float =0,
		@hINSTFLAG bit,
		@hposinv numeric(1,0)=1	

	Declare @lbelowbal bit =0
------------------------------  Get Data From Sysuse ---------------------------------------------------------------
		select @lbelowbal=belowbal 
			 from sysuse with (NOLOCK)
			where username=@USRID 
------------------------------  Get Data From salecntr ---------------------------------------------------------------
	declare @ldp_cashser char(19),
		@ldp_okdiff bit ,
		@ldp_mainwh char(2),
		@ldp_expser char(19),
		@ldp_oslser char(19),
		@ldp_cardcomm char(19),
		@ldp_rplsac char(19),
		@ldp_diffser char(19),
		@lDP_CSLSER char(19),
		@lDP_RCSLSER char(19),
		@lprpaidcrdac char(19),
		@ltdate char(8),
		@lglacct char(19),
		@lexacct char(19),
		@ldp_slser char(19),
		@lsanedcrd_act char(19),
		@lcstctr char(4)=''

	declare @xttl_cost float=0,
		@inv_lmtt  float=0,
		@inv_lftt  float=0,
		@m_vl      float=0,
		@m_fc      float=0,
		@inv_stk   float=0,
		@m_lccntr  float=0,
		@m_fccntr  float=0,
		@pd_lc     float =0,
		@opstval varchar(50),
		@diff_amt float=0,
		@new_rate float=0,
		@match_image bit ,
		@fc_to_lc_ttl float=0,
		@ch_cnt int =0,
		@l_crtot float=0,
		@f_crtot float=0,
		@l_dbtot float=0,
		@f_dbtot float=0,
		@m_sign int =1,
		@m_value float=0,
		@m_fcval float=0,
		@plcamt float ,
		@pfcamt float ,
		@fcfcy char (3),
		@lcurname char(20),
		@replication bit =0,
		@xclkey char(12)='',
		@clsname char(20)='',
		@cstcode char(4)='',
		@dscact char(19)='',
		@dscclassamt float=0,
		@dsc_ptr int =0,
		@ttl_class_dsc float=0

	declare @hcustnm varchar(50)='',
	    @hcaser varchar(19)='',
		@haddress varchar(50)=''
		

		select @ldp_cashser=dp_cashser,@ldp_okdiff=dp_okdiff,@ldp_mainwh=dp_mainwh,@ldp_expser=dp_expser,
		@ldp_oslser=dp_oslser,@ldp_cardcomm=dp_cardcomm,@ldp_rplsac=dp_rplsac,@ldp_diffser=dp_diffser,
		@lDP_CSLSER=DP_CSLSER,@lDP_RCSLSER=DP_RCSLSER,@lprpaidcrdac=prpaidcrdac,@lsanedcrd_act=sanedcrd_act,@lcstctr=isnull(cstcode,'')
			from salecntr with (NOLOCK)
		where dp_brno=@BRANCH and dp_dept=@SLCNTR
------------------------------------------------------------------------------------------------------------------------	
------------------------  Get Customer Info  
----
        declare @cstaddrs varchar(60)='',
		@cstclass char(2)='',
		@cstcu_ctlser varchar(19)='',
		@dbtglacct char(19)='',
		@cstmaxlimit numeric(11,3)=0,
		@ldudate char(10)='',
		@ldudays int =0,
		@lcu_name varchar(50)=''

		set @lwhno=@ldp_mainwh
		if len(rtrim(@lcustcode))>0
		begin
			select @lcu_name=cu_name,@cstaddrs=cu_addrs,@cstclass=cu_class,@cstcu_ctlser=cu_ctlser,@cstmaxlimit=isnull(cu_crlmt,0),
			@ldudays=isnull(cu_pymnt,0) from customer where cu_company=@branch and cu_code=@lcustcode
			if len(isnull(@cstcu_ctlser,''))>0  set @dbtglacct=@cstcu_ctlser
			else
			begin
			   select @dbtglacct=cl_crlser from classfil where cl_company=@BRANCH and cl_code=@cstclass
			end
		end
--dateadd(dd,-1,getdate())
		set @hcaser=''
		set @ldp_slser=''
		if @ltrtype ='06'
		begin
			set @hcaser=@ldp_cashser
			set @dbtglacct=@hcaser
			set @ldp_slser=@lDP_CSLSER
			set @hcustnm='مبيعات نقدية تمت عن طريق جهاز PDA'				
		end
		else
		begin
			set @ldp_slser=@ldp_oslser
			set @hcustnm='مبيعات آجلة تمت عن طريق جهاز PDA'
-------------------------- To calculate Due date
			if @ldudays>0
			begin
				if @lusing_hij_date=1
				begin
					set @ldate =convert(varchar(10),dateadd(dd,@ldudays,getdate()),131)
					set @ldudate=substring(@ldate,7,4)+substring(@ldate,4,2)+iif(substring(@ldate,1,1)=' ','0'+substring(@ldate,2,1),substring(@ldate,1,2))
				end
				else
				begin
					set @ldate = convert(varchar(10),dateadd(dd,@ldudays,getdate()),112)
					set @ldudate=@ldate		
				end
			end
			else set @ldudate=@lfdate
		end

------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
    declare @lcaokcstctr bit =0
	select @syscode=sysno,@lcaalwngtvs=isnull(caalwngtv ,0),@lcaokcstctr=isnull(caokcstctr,0)
	       from sysdb.dbo.glcalend with (nolock)
	       where calcomp=@comp and yrcode=@yrcode

--------------------------------------------------------------------------------------------------------------------------- 
	IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[#TEMPSLINV_PDA]') AND type in (N'U'))
	DROP TABLE [dbo].[#TEMPSLINV_PDA]

	EXEC sp_xml_preparedocument @handle OUTPUT, @PdaXfr

	select  barcode,shdqty,frtqty,price
	into #TEMPSLINV_PDA FROM OPENXML (@handle, 'NewDataSet/Table1', 2) WITH
	(barcode nvarCHAR(20),
	shdqty float,
	frtqty float,
	price decimal(11,3))

	declare @ref int=0

	EXEC sp_xml_removedocument @handle
	


    DECLARE @j INT=1
	set @ref =0
	--set @Trdate=CONVERT(VARCHAR(10), getdate(), 112)
	select @ref =dbo.get_last_ref(@ltrtype, @branch)

---------------------------- Calculate the customer max limit 
  declare @tmp_ttl_inv float =0,
          @cst_curbal float =0,
		  @lposted bit =0,
		  @lfcy char(3)=space(3)

  if @cstmaxlimit>0 and @ltrtype='04'
  begin
        if @syscode<>6
      		Select @tmp_ttl_inv=sum((frtqty+(shdqty*pkqty1))*price)
			From #TEMPSLINV_PDA a inner join stunits b on a.barcode=b.barcode
		else
			Select @tmp_ttl_inv=sum(shdqty*price)
			From #TEMPSLINV_PDA 

		exec dbo.get_client_bal @BRANCH,@lcustcode,@lfcy,@lposted,@cst_curbal output
		if @cst_curbal+@tmp_ttl_inv>@cstmaxlimit
		begin
			SET @RET_ID = -55
			SET @STR_MSG ='العميل'+' '+@lcu_name+' '+'تجاوز الحد الاعلى للمديونية'
			set @errstatus =-1			
			goto jumplbl
		end
  end
  
---------------------------------------------------------------------
 -- DECLARE ARRAY HOLDING THE ITEM CLASS AND ACCOUNT
	    declare @class_arr table( p_ptr int,clkey char(12) not null , act char(19) not null,lcamt float ,
		clsname char(20),cstcode char(4),dscact char(19))

        --declare @dsc_class_val table(classkey char(12) not null,dscclassamt float default 0)   


		
------------------------------------------------------------------------------
        begin transaction

		if @ltrtype='06' update stbranch set jv_06=@ref+1 where brnno=@BRANCH
		else update stbranch set jv_04=@ref+1 where brnno=@BRANCH
		if @@error<>0
		begin
			rollback transaction
			SET @RET_ID = -1
			SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
			set @errstatus =-1
			goto jumplbl
		end

		insert into sales_hd 
		(slcenter,branch ,company ,invtype ,ref ,invdate,custno ,custnm ,glser,dsctype ,pstmode
		,fcy,fcyrate,duedate ,invttl,invcst,invdspc ,invdsvl ,valafds ,invpaid ,caser ,entries
		,released,posted ,fixrate ,extamt,extser ,pricetp,ischeque ,chkno ,chkdate ,lastupdt,jvgenrt
		,cccommsn ,belowbal,fcy2,ccpayment ,rplsamt,pdother ,slcode,prpaidamt,instldays ,instflag
		,slcmnd ,inv_printed ,bendit ,modified ,rqstorder ,rqststld ,carrier ,rcvdtrn ,usrid ,address
		,suspend ,rtnref,ispurchase ,stkjvno ,posinv ,sanedcrd_amt)
		values (@SLCNTR,'Q',@BRANCH,@ltrtype,@ref,@lfdate,@lcustcode ,@hcustnm,'','',0,
		'',0,@ldudate,0,0,0,0,0,0,@hcaser,0,
		0,0,0,0,'','1',0,'','',@lfdate,0,
		0,0,'',0,0,0,@SLPRSN ,0,0,0,
		0,0,0,1,0,0,'',0,@USRID ,@haddress,
		0,0,0,0,4,0)
		if @@error<>0
		begin
			rollback transaction
			SET @RET_ID = -2
			SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))    
			set @errstatus =-2
			goto jumplbl
		end
-----------------------------------------------------------------------------
	--
	--- insert one record in STHDR
	-- 

	 insert into sthdr (branch, trtype, ref, trdate, text, amnttl, costttl, sysdate, src, released,
	 posted, fcy, fcyrate, whno, entries, lastupdt, towhno, modified, rcvdtrn, custno, usrid, brsupp,
	 tobrno, brxref, glref, isbrtrx, asmtype, repost )
	 values(@branch ,@ltrtype,@ref ,@lfdate,@hcustnm,0,0,@lfdate,'05',0,
	       0,'',0,'',0,@lfdate,'',0,0,@lcustcode ,@usrid,'',
		   '',0,0,0,0,0)

		if @@error<>0
		begin
			rollback transaction
			SET @RET_ID = -3
			SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))    
			set @errstatus =-3
			goto jumplbl
		end
		--
		-- Insert One Record in GLJRHR
		--
		set @ljhfcflag=2
		insert into gljrhdr (jhcomp,jhtype,jhref,jhcurr,jhamt,jhdate,jhrate,jhtext,jhsrc,jhfcflag,jhreleased,jhposted,
		jhsysdate,modified,[Suspend],usrid,lastupdt,rcvdtrn,isbrtrx,brxref,brxfrm,jhcustno) 
		values (@branch,@ltrtype,@ref,'',0,@lfdate,0,@hcustnm,'05',
		@ljhfcflag,0,0,@lfdate,1,0,@USRID ,@lfdate,0,0,'','','')
		if @@error<>0
		begin
			rollback transaction
			SET @RET_ID = -4
			SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
			set @errstatus =-4
			goto jumplbl
		end  
	-------------------------------------get_client_bal

    if @errstatus=0
	begin
	    if @syscode <> 6
		begin
			DECLARE Cursdtl CURSOR LOCAL FAST_FORWARD FOR
			Select a.barcode,shdqty,frtqty,price,pack0,pkqty1,lcost,substring(c.classkey,1,2) as classkey,
			cmbkey,b.itemno,b.unicode,pack1
			From #TEMPSLINV_PDA a inner join stunits b on a.barcode=b.barcode 
			inner join stitems c on b.itemno=c.itemno
		end
		else
		begin
			DECLARE Cursdtl CURSOR LOCAL FAST_FORWARD FOR
			Select a.barcode,shdqty,frtqty,price,pack0,d.pkqty as pkqty1,lcost,substring(c.classkey,1,2) as classkey,
			b.cmbkey,b.itemno,b.unicode,d.pack as pack1
			From #TEMPSLINV_PDA a inner join stitembc d on a.barcode=d.pbarcode 
			inner join stunits b on d.itemno=b.itemno and d.unicode=b.unicode
			inner join stitems c on b.itemno=c.itemno
		end
		open Cursdtl 
		Fetch Next From Cursdtl Into @lbarcode,@lshdqty,@lfrtqty,@lprice,@lpack,@lpkqty,@llcost,@lclasskey,
									@lcmbkey,@litemno,@lunicode,@lpack1
	
	  	set @ch_cnt  =0
		set @l_crtot =0
		set @f_crtot =0
		set @l_dbtot =0
		set @f_dbtot =0
		set @m_value=0
		set @m_fcval=0
		set @xttl_cost=0
		set @lslptr=0
		set @lstptr=0
		set @lttl_inv=0
				
		set @ttl_class_dsc=0
		set @dsc_ptr=0
		set @xttl_cost=0
		set @inv_stk=0
		set @inv_lftt=0
		set @inv_lmtt=0
		set @m_lccntr=0
		set @m_fccntr=0
		set @arr_ptr=0
		WHILE dbo.FetchStatusOfCursorNamed('Cursdtl') = 0 
		begin
		    set @lnobinno=1
			set @lastbinno=space(6)
		    set @lpkqty=isnull(@lpkqty,1)
			set @lpkqty=iif(@lpkqty=0,1,@lpkqty)
			set @qty=@lfrtqty+(@lshdqty*@lpkqty)
			set @avail_qty=0
			set @lcost=0
			set @lclasskey=iif(isnull(@lclasskey,'')='','',@lclasskey)
			set @lclasskey=rtrim(@lclasskey)+replicate(space(1),12-datalength(rtrim(@lclasskey)))	
			set @cl_slser=''		 
			select @cl_slser=iif(@ltrtype='06',SERCSH,SERCRD),@clsname=name,@cstcode=cstcode,@dscact=serdsc
				from slclass with (NOLOCK) where company=@BRANCH and cmbkey=@lclasskey
			if rtrim(isnull(@cl_slser,''))='' 
			begin
				set @lsl_acfm=3
				set @lds_acfm=3
				set @lgclass=''
			end
			else
			begin
				set @lsl_acfm=2
				set @lds_acfm=2
				set @lgclass=rtrim(@lclasskey)
			end
			set @m_vl=-iif(@syscode<>6,(@qty*@lprice),@lshdqty*@lprice)
			set @m_fc=0.00
			set @inv_lftt=@inv_lftt+abs(@m_vl)
			set @inv_lmtt=@inv_lmtt+Abs(@m_vl)   
			set @inv_stk=@inv_stk+Abs(@m_vl) 
			if @lsl_acfm=2
			begin 
				set @xclkey=''
				select @xclkey=clkey from  @class_arr where clkey=@lclasskey
				if rtrim(isnull(@xclkey,''))=''
				begin
					set @arr_ptr+=1
					insert into @class_arr values (@arr_ptr,@lclasskey,@cl_slser,@m_vl,@clsname,@cstcode,@dscact)
				end
				else update @class_arr set lcamt=lcamt+@m_vl where clkey=@lclasskey
			end
			if @lsl_acfm=3
			begin
				set @m_lccntr=@m_lccntr+@m_vl
				set @m_fccntr=@m_fccntr+@m_fc
			end

			set @lttl_inv=@lttl_inv+abs(@m_vl)
			set @avail_qty=0

			if @lbelowbal = 0 and @lcaalwngtvs=0
			begin
				select @avail_qty=sum(qty-rsvqty) from stbins where branch=@BRANCH and itemno=@litemno and unicode=@lunicode
				and whno=@lwhno 
				set @avail_qty=isnull(@avail_qty,0)
				if @qty>@avail_qty
				begin
					rollback transaction
					SET @RET_ID = -5
					SET @STR_MSG = 'الكمية تجاوزت الرصيد المتاح للصنف '+' '+@lcmbkey
					set @errstatus =-5
					break
				end
			end
			set @subttlcost=0
			set @lt_qty=@qty
            DECLARE lstbins CURSOR LOCAL FAST_FORWARD FOR
			select binno,qty-rsvqty as qty,lcost from stbins where branch=@branch and
			itemno=@litemno and unicode=@lunicode and whno=@lwhno
			open lstbins;
			fetch next from lstbins into @bbinno,@brmnqty,@blcost
			WHILE dbo.FetchStatusOfCursorNamed('lstbins') = 0 and @lt_qty>0
			begin
				set @lnobinno=0
				set @lastbinno=@bbinno
				if @brmnqty>0
				begin
					if @lt_qty>@brmnqty set @lxq=@brmnqty
					else set @lxq=@lt_qty
					set @lstptr=@lstptr+1
					insert into stdtl (itemno, unicode, branch, trtype, qty, fqty, whno, binno, lcost, trdate, ref,
						sysdate, src, lprice, fcost, fprice, expdate, towhno, tobinno, barcode, cmbkey, discpc, pack,
						shdpk, shdqty, folio, rplct_post)
					values(@litemno,@lunicode,@BRANCH,@ltrtype,@lxq,0,@lwhno,@bbinno,@blcost,@lfdate,
					@ref,@lfdate,'05',@lprice,0,0,'','','',@lbarcode,@lcmbkey,0,@lpack,1,@lxq,@lstptr,0)
					if @@error<>0
					begin
						rollback transaction
						SET @RET_ID = -6
						SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))    
						set @errstatus =-6
						break
					end
					set @subttlcost=@subttlcost+(@blcost*@lxq)
					set @lt_qty=@lt_qty-@lxq
	--
	-- Update the RSVQTY of stbins
	--
					update stbins set rsvqty=rsvqty+@lxq where branch=@BRANCH and
							itemno=@litemno and unicode=@lunicode and whno=@lwhno and binno=@bbinno
					if @@error<>0
					begin
						rollback transaction
						SET @RET_ID = -7
						SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
						set @errstatus =-7
						break
					end
				end
				if @lt_qty<=0 break					
				fetch next from lstbins into @bbinno,@brmnqty,@blcost
			end				  
			close lstbins
			deallocate lstbins
			if @errstatus<0 break

			if @lt_qty>0
			begin
			    set @hbelowbal = 1
				if @lnobinno=1
				begin
					set @ldummy=''
					select @ldummy=cmbkey from stunits with (NOLOCK) where itemno=@litemno and unicode=@lunicode
					if RTRIM(isnull(@ldummy,''))<>''
					begin
						insert into stbins (itemno,unicode,lcost,whno,branch,binno,fcost,openlcost,openfcost,openbal,qty,rsvqty,expdate) values
						(@litemno,@lunicode,@llcost,@ldp_mainwh,@BRANCH,@lastbinno,0,0,0,0,0,0,' ')
			    		if @@error<>0
						begin
							rollback transaction
							SET @RET_ID = -8
							SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
							set @errstatus =-8
							break
						end
					end						                           
				end
				set @lstptr=@lstptr+1
				set @lxq=@lt_qty
				if @lnobinno=0 and @blcost>0 set @llcost=@blcost
				insert into stdtl (itemno, unicode, branch, trtype, qty, fqty, whno, binno, lcost, trdate, ref,
						sysdate, src, lprice, fcost, fprice, expdate, towhno, tobinno, barcode, cmbkey, discpc, pack,
						shdpk, shdqty, folio, rplct_post)
				values(@litemno,@lunicode,@BRANCH,@ltrtype,@lxq,0,@lwhno,@lastbinno,
				@llcost,@lfdate,
				@ref,@lfdate,'05',@lprice,0,0,'','','',@lbarcode,@lcmbkey,0,@lpack,1,@lxq,@lstptr,0)
			    if @@error<>0
				begin
					rollback transaction
					SET @RET_ID = -9
					SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))    
					set @errstatus =-9
					break
				end
				set @subttlcost=@subttlcost+(@llcost*@lxq)
				update stbins set rsvqty=rsvqty+@lxq where branch=@BRANCH and
					itemno=@litemno and unicode=@lunicode and whno=@lwhno and binno=@lastbinno
			    if @@error<>0
				begin
					rollback transaction
					SET @RET_ID = -10
					SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
					set @errstatus =-10
					break
				end
			end   -- end of @lt_qty>0

			update stunits set rsvqty=rsvqty+@qty where itemno=@litemno and unicode=@lunicode	
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -11
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
				set @errstatus =-11
				break
			end
---------------------------------------------------------------------------------------------------------------------
            set @ldiscpc=0
			set @llcost=@subttlcost/(@qty)
			set @xttl_cost=@xttl_cost+(@qty*@llcost)
			set @lslptr=@lslptr+1
			if @syscode in (4,5,8,9)
				insert into sales_dt (slcenter, company, invtype, ref, invdate, itemno, unicode, qty, fqty, price, discpc,
					cost, ds_acfm, sl_acfm, gclass, custno, fcy, barcode, imfcval, pack, pkqty, shadd, shdpk, shdqty, frtqty, rtnqty, whno, 
					cmbkey, folio, rplct_post, sold_item_status)
				values(@SLCNTR,@BRANCH,@ltrtype,@ref,@lfdate,@litemno,@lunicode,
				@qty,0,@lprice,@ldiscpc,@llcost,@lds_acfm,@lsl_acfm,@lgclass,'','',@lbarcode,0,@lpack,1,
				@lpack1,@lpkqty,@lshdqty,@lfrtqty,0,@lwhno,@lcmbkey,@lslptr,0,0)
			else
			    if @syscode=6
				    insert into sales_dt (slcenter, company, invtype, ref, invdate, itemno, unicode, qty, fqty, price, discpc,
						cost, ds_acfm, sl_acfm, gclass, custno, fcy, barcode, imfcval, pack, pkqty, shadd, shdpk, shdqty, frtqty, rtnqty, whno, 
						cmbkey, folio, rplct_post, sold_item_status)
					values(@SLCNTR,@BRANCH,@ltrtype,@ref,@lfdate,@litemno,@lunicode,
					@lshdqty,0,@lprice,@ldiscpc,@llcost,@lds_acfm,@lsl_acfm,@lgclass,'','',@lbarcode,0,@lpack1,@lpkqty,
					'',0,0,0,0,@lwhno,@lcmbkey,@lslptr,0,0)
				else
				insert into sales_dt (slcenter, company, invtype, ref, invdate, itemno, unicode, qty, fqty, price, discpc,
					cost, ds_acfm, sl_acfm, gclass, custno, fcy, barcode, imfcval, pack, pkqty, shadd, shdpk, shdqty, frtqty, rtnqty, whno, 
					cmbkey, folio, rplct_post, sold_item_status)
				values(@SLCNTR,@BRANCH,@ltrtype,@ref,@lfdate,@litemno,@lunicode,
				@qty,0,@lprice,@ldiscpc,@llcost,@lds_acfm,@lsl_acfm,@lgclass,'','',@lbarcode,0,@lpack,1,
				'',0,0,0,0,@lwhno,@lcmbkey,@lslptr,0,0)
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -12
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
				set @errstatus =-12
				break
			end
---------------------------------------------------------------------------------------------------------------------			
		    Fetch Next From Cursdtl Into @lbarcode,@lshdqty,@lfrtqty,@lprice,@lpack,@lpkqty,@llcost,@lclasskey,
									@lcmbkey,@litemno,@lunicode,@lpack1
		END
		CLOSE Cursdtl 
		DEALLOCATE Cursdtl

		if @errstatus =0 and @lslptr>0
		begin
				
			set @pd_lc=@lttl_inv
			set @opstval=''
			set @diff_amt=0
			set @new_rate=0
			set @match_image=0
			set @hinvpaid=0
			set @hvalafds = @lttl_inv
			if @ltrtype='06' set @hinvpaid=@lttl_inv
				
				    
					
            set @opstval=@hcustnm

			--
			-- Process GLJRDTL entries
			--
			set @ch_cnt +=1
			set @m_value=@pd_lc
			set @m_fcval=0
			insert into gljrdtl 
			(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
			values (@BRANCH,@ltrtype,@ref,@dbtglacct,@lfdate,@opstval,
			abs(@pd_lc),iif(@m_sign*@pd_lc<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@lfdate,'05',0,0,'','','',0,0,0)	
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -13
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
				set @errstatus =-13
				goto jumplbl
			end
			If @m_value<0
			begin
				set @l_crtot=@l_crtot+Abs(@m_value)
				set @f_crtot=@f_crtot+Abs(@m_fcval)
			end
			Else
			begin
				set @l_dbtot=@l_dbtot+Abs(@m_value)
				set @f_dbtot=@f_dbtot+Abs(@m_fcval)
			End	
------------------------------------  Process GLdtl on the class level  ----------------------------------
            if @arr_ptr>0
			begin
				while @arr_ptr>0
				begin
					set @cl_slser=''
					set @dscact=''
					set @cstcode=''
					set @m_vl=0
					select @cl_slser=act,@m_vl=lcamt,@clsname=clsname,@cstcode=cstcode,@dscact=dscact,@xclkey=clkey
					from @class_arr
					where p_ptr=@arr_ptr
					if isnull(@cl_slser,'')<>'' and isnull(@m_vl,0)<>0
					begin
						set @m_value=@m_vl
						set @m_fcval=0
						set @opstval='مبيعات قسم'+' '+rtrim(@clsname)
						set @ch_cnt +=1
						insert into gljrdtl 
						(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                        ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
						values (@BRANCH,@ltrtype,@ref,@cl_slser,@lfdate,@opstval,
						abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@lfdate,'05',0,0,'','','',0,0,0)	
						if @@error<>0
						begin
							rollback transaction
							SET @RET_ID = -14
							SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
							set @errstatus =-14
							goto jumplbl
						end
						if @lcaokcstctr=1 and isnull(@cstcode,'')<>''
						begin
							insert into gljrcost (company,jdtype,jdref,cstcode,jdkey,jdcurr,Xpercent,amt,jddbcr
							,jdfc_imgval,jdfolno,rplct_post)
							values (@BRANCH,@ltrtype,@ref,@cstcode,@cl_slser,'',0,abs(@m_value),
							iif(@m_sign*@m_value<0,'C','D'),0,@ch_cnt,0)
							if @@error<>0
							begin
								rollback transaction
								SET @RET_ID = -15
								SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
								set @errstatus =-15
								goto jumplbl
							end
						end
						If @m_value<0
						begin
							set @l_crtot=@l_crtot+Abs(@m_value)	
							set @f_crtot=@f_crtot+Abs(@m_fcval)					
						end
						Else
						begin
							set @l_dbtot=@l_dbtot+Abs(@m_value)	
							set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
						End	
					end
					set @arr_ptr-=1
				end  -- end of @arr_ptr loop
            end  ----  end of @arr_ptr
----------------------------------------------------------------------------------------------------------------					
				
			If @m_lccntr<>0 Or @m_fccntr<>0
			begin
				set @m_value=@m_lccntr
				set @m_fcval=@m_fccntr
				set @opstval='مبيعات نقدية'
				set @ch_cnt +=1
				insert into gljrdtl 
				(jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,jdfcamt,jdcurr,jdfolio
                        ,jdfolno ,jdsysdate,jdsrc,jdfc_imgval,jdcstval,cstkey ,brnno ,bracc,brxref,match,rplct_post )
				values (@BRANCH,@ltrtype,@ref,@ldp_slser,@lfdate,@opstval,
				abs(@m_value),iif(@m_sign*@m_value<0,'C','D'),0,'',@ch_cnt,@ch_cnt,@lfdate,'05',0,0,'','','',0,0,0)	
				if @@error<>0
				begin
					rollback transaction
					SET @RET_ID = -16
					SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
					set @errstatus =-16
					goto jumplbl
				end
--					
----------- For Cost center process
--
				if @lcaokcstctr=1 and isnull(@lcstctr,'')<>''
				begin
					insert into gljrcost (company,jdtype,jdref,cstcode,jdkey,jdcurr,Xpercent,amt,jddbcr
					,jdfc_imgval,jdfolno,rplct_post)
					values (@BRANCH,@ltrtype,@ref,@lcstctr,@ldp_slser,'',0,abs(@m_value),
					iif(@m_sign*@m_value<0,'C','D'),0,@ch_cnt,0)
					if @@error<>0
					begin
						rollback transaction
						SET @RET_ID = -17
						SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
						set @errstatus =-17
						goto jumplbl
					end
				end
				If @m_value<0
				begin
					set @l_crtot=@l_crtot+Abs(@m_value)	
					set @f_crtot=@f_crtot+Abs(@m_fcval)					
				end
				Else
				begin
					set @l_dbtot=@l_dbtot+Abs(@m_value)	
					set @f_dbtot=@f_dbtot+Abs(@m_fcval)					
				End	
			end  -- end of @m_lccntr
--------------------------------------------------------------------------
		-----------------Update gljrhdr


			update gljrhdr set jhfcflag=2,jhentries=@ch_cnt,jhlccrttl = @l_crtot,
			jhfccrttl= @f_crtot,jhlcdbttl = @l_dbtot,jhfcdbttl = @f_dbtot,
			jhamt = Iif(@inv_lmtt>@l_dbtot,@inv_lmtt,@l_dbtot) where jhcomp=@BRANCH  and jhtype=@ltrtype and
			jhref=@ref
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -18
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
				set @errstatus =-18
				goto jumplbl
			end
				
	--------- Update sthdr
			If @lstptr>0
			begin
				update sthdr set entries=@lstptr,amnttl = @inv_stk,costttl = @xttl_cost where branch=@BRANCH 
				and trtype=@ltrtype and ref=@ref
			end
			else  delete from sthdr where branch=@BRANCH and trtype=@ltrtype and ref=@ref
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -19
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
				set @errstatus =-19
				goto jumplbl
			end
	--    Update sales_hd
			update sales_hd set entries=@lslptr,valafds = @lttl_inv,invttl=@lttl_inv,invcst=@xttl_cost,belowbal=@hbelowbal
			where company=@BRANCH and invtype=@ltrtype and ref=@ref
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -20
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
				set @errstatus =-20
				goto jumplbl
			end
			if @ltrtype='04'
			begin
			     insert into arhdr
			     (hd_company, hd_type, hd_ref, hd_date, hd_fcy, hd_ftotal, hd_fcyrate, hd_ltotal, hd_cucode, 
				 hd_desc1, hd_ser, hd_rlsd, hd_posted, hd_trxsrc, hd_sysdate, hd_lcnet, hd_fcnet, hd_lccnet,
				 hd_fccnet, isit_opst, opst_val, opst_fcy, lastupdt, modified, rcvdtrn, usrid, clcode, clcmnd,
				 dscamt, payinv) 
				 values (@BRANCH,@ltrtype,@ref,@lfdate,'',0,0,@lttl_inv,@lcustcode,
				 @hcustnm,'',0,0,'05',@lfdate,@lttl_inv,0,0,
				 0,0,0,'',@lfdate,1,0,@USRID,'',0,0,0)
				if @@error<>0
				begin
					rollback transaction
					SET @RET_ID = -21
					SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))   
					set @errstatus =-21
					goto jumplbl
				end

				insert into ardtl 
				(dt_company, dt_type, dt_ref, dt_date, dt_lcamt, dt_paidamt, dt_discamt, dt_cucode, dt_fcy,
				 dt_trxsrc, dt_fcamt, dt_fpydamt, dt_fdscamt, dt_lcaloc, dt_fcaloc, dt_aloctd, dt_pdinv, dt_duedate,
                 dt_desc, dt_chkno, dt_chkdate, dt_chkbnk, dt_dbcr, dt_ackey, dt_folio, dt_rcvno, dt_lstdate,
				 tdscdays, tdscpcs, match, rplct_post)
				 values(@BRANCH,@ltrtype,@ref,@lfdate,@lttl_inv,0,0,@lcustcode,'',
				 '05',0,0,0,0,0,'0',0,@lfdate,
				 @hcustnm,'','','','D','',1,0,'',
				 0,0,0,0)
				 if @@error<>0
				begin
					rollback transaction
					SET @RET_ID = -22
					SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
					set @errstatus =-22
					goto jumplbl
				end
			end
		end
	end
	jumplbl:
	if @errstatus=0 commit transaction
	IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'#TEMPSLINV_PDA'))
	DROP TABLE [#TEMPSLINV_PDA]
    return @errstatus
END TRY
	BEGIN CATCH
	    if @@TRANCOUNT>0 ROLLBACK TRANSACTION
		SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  

		SET @RET_ID = -99
		IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'#TEMPSLINV_PDA'))
		DROP TABLE [#TEMPSLINV_PDA]
		--insert into TMP(FLD)values(@STR_MSG)
		RETURN -99
END CATCH
	
END

















GO
/****** Object:  StoredProcedure [dbo].[ImportTransferAPIxml]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[ImportTransferAPIxml]
@branch char(2),
@trtype char(2),
@trdate varchar(10),
@text varchar(60),
@userid varchar(10),
@STR_MSG NVARCHAR(1000) OUT,
@RET_ID INT OUT,
@API_Trans nvarchar(max)
AS BEGIN 
    BEGIN TRANSACTION
	BEGIN TRY
		DECLARE @qty float 
		DECLARE @whno CHAR(2),@binno char(6)
		DECLARE @towhno CHAR(2),@tobinno char(6)
		DECLARE @barcode VARCHAR(20)
		declare @cmbkey char(24),@pack char(1)
		DECLARE @shdpk numeric(15,5),@shdqty float



		DECLARE @ttlqty float=0
		DECLARE @ttllcost float=0
		DECLARE @lprice float =0
		declare @fcost float =0
		DECLARE @itemno VARCHAR(16)
		DECLARE @unicode VARCHAR(6)
		DECLARE @lcost float
		DECLARE @handle INT	, @entries int=0
		declare @ss as varchar(10)
		declare @ref int,
		        @rmnqty float
-------------------------------------------------------------------
declare 
	@dbc nvarchar(14),
	@lcalcomp char(2),
	@yrcode char(4),
	@sysno int,
	@caalwngtvs bit

	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
	select @sysno=sysno,@caalwngtvs=caalwngtvs  from sysdb.dbo.glcalend 
	       where calcomp=@lcalcomp and yrcode=@yrcode
-------------------------------------------------------------------
		EXEC sp_xml_preparedocument @handle OUTPUT, @API_Trans

		Declare Curs Cursor For
		SELECT    *  
		FROM      OPENXML (@handle, '/Root/stdtl',2)  with
		(qty float,
		 whno char(2),binno char(6),
		towhno char(2),tobinno char(6),barcode char(20),cmbkey char(24),pack char(1),shdpk numeric(15,5),shdqty float)
		open Curs 
		Fetch Next From Curs Into @qty,@whno,@binno,@towhno,@tobinno,@barcode,@cmbkey,@pack,@shdpk,@shdqty

		set @entries=0

		SET @RET_ID =0

		SET @STR_MSG =''
		EXEC sp_xml_removedocument @handle
		DECLARE @j INT=1
		set @ref =0
	--			set @Trdate=CONVERT(VARCHAR(10), getdate(), 112)
		set @ref =dbo.get_last_ref('20', @branch)
		begin transaction
		update stbranch   set   jv_20 =@ref+1  WHERE   BRNNO=@branch 
		if @@error<>0
		begin
			rollback transaction
			SET @RET_ID = -4
		end
		else commit transaction 
		set @ss ='1'
		if @RET_ID=0
		begin
			set @ttllcost=0
			set @ttlqty=0
			set @trdate=replace(@trdate,'-','')
			SET @STR_MSG =cast(@ref as nvarchar(20))
			insert into sthdr (branch ,trtype,ref ,trdate ,text ,posted,whno ,towhno,usrid,asmtype, 
			amnttl,costttl,sysdate,src,released,fcy,fcyrate,entries,lastupdt,
			modified,rcvdtrn,custno,brsupp,tobrno,brxref,glref,isbrtrx )
			values(@branch ,'20',@ref ,@Trdate,@text,0,@whno,@towhno,@userid,0,0,0 , @Trdate,'03',1,'',0,0,@Trdate,
			0,0,'','','',0,0,0)
			
			WHILE @@FETCH_STATUS = 0  
			begin
				set @itemno =''
				set @unicode =''
				set @lcost =0
				set @lprice =0
				
				set @ttlqty=@ttlqty+@qty
				set @entries=@entries+1
				select @itemno =a.itemno,@unicode =a.UNICODE  ,@rmnqty=qty-b.rsvqty,
				@fcost =b.fcost,@lcost=b.lcost   from stunits a inner join stbins b on a.itemno=b.itemno and a.unicode=b.unicode
				where cmbkey=@cmbkey and branch=@branch and whno=@whno and binno=@binno

				If (@sysno not in (2,3,6) Or (@sysno in (2,3,6) And @caalwngtvs=0)) and @qty>isnull(@rmnqty,0)
				begin
				    rollback transaction
				    SET @RET_ID = -9
					break
				end
				set @ttllcost=@ttllcost+(@qty*@lcost)
		
				INSERT INTO STDTL (itemno,unicode,trtype,qty,whno,lcost,trdate,ref,sysdate ,src ,
				lprice,towhno ,barcode,binno,tobinno,branch ,cmbkey,fqty,fcost,fprice ,pack,shdpk ,shdqty ,folio)values(
				@itemno,@unicode,'20',@qty ,@whno ,@lcost ,@Trdate,@ref ,@Trdate,'03', @lprice,@towhno ,@barcode ,
				@binno,@tobinno,@branch ,@cmbkey,0,@fcost,0,@pack,@shdpk,@shdqty ,@j)
				SET @j=@j +1

				INSERT INTO STDTL (itemno,unicode,trtype,qty,whno,lcost,trdate,ref,sysdate ,src ,
				lprice,towhno ,barcode,binno,tobinno,branch ,cmbkey,fqty,fcost,fprice ,pack,shdpk ,shdqty ,folio)values(
				@itemno,@unicode,'20',@qty ,@towhno ,@lcost ,@Trdate,@ref ,@Trdate,'03', @lprice,'' ,@barcode ,
				@tobinno,'+',@branch ,@cmbkey,0,@fcost,0,@pack,@shdpk,@shdqty ,@j)

		

				update stbins set rsvqty =rsvqty+@qty  where branch =@branch  and whno =@whno and binno=@binno
				and itemno =@itemno  and unicode =@unicode 
				if @@error<>0
				begin
					rollback transaction
					SET @RET_ID = -5
					break
				end
				set @j=@j+1

				Fetch Next From Curs Into @qty,@whno,@binno,@towhno,@tobinno,@barcode,@cmbkey,@pack,@shdpk,@shdqty
			END
			update sthdr   set   entries =@entries,amnttl=@ttlqty,costttl=@ttllcost  WHERE   branch=@branch  and trtype=20 and ref=@ref 
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -6
			end
		end
		CLOSE Curs 
		DEALLOCATE Curs
		if @RET_ID=0
		begin
			
			COMMIT TRANSACTION
			SET @RET_ID = 1
		--	RETURN 	@@ROWCOUNT
		end
		else set @entries=0

	END TRY
	BEGIN CATCH
 	    ROLLBACK TRANSACTION
		SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  + CONVERT (VARCHAR, @ss) 

		SET @RET_ID = -21
		set @entries=0
	END CATCH
	
	
    if @@TRANCOUNT>0 
	  if @RET_ID<0 ROLLBACK TRANSACTION else COMMIT TRANSACTION 
	-- return --@entries 
END



















GO
/****** Object:  StoredProcedure [dbo].[ImportTransferPDAxml]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[ImportTransferPDAxml]

@STR_MSG NVARCHAR(1000) OUT,
@RET_ID INT OUT,
@PdaTrans xml
AS BEGIN 
BEGIN TRANSACTION
BEGIN TRY
	DECLARE @shdpk float
	DECLARE @pack0 NVARCHAR(30)
	DECLARE @pack_0 int
	DECLARE @lprice float
	DECLARE @cmbkey NVARCHAR(50)
	DECLARE @itemno NVARCHAR(30)
	DECLARE @unicode NVARCHAR(30)
	DECLARE @lcost float
	declare @Trdate varchar(20)
	DECLARE @handle INT	
	DECLARE @barcode NVARCHAR(30)
	DECLARE @whno CHAR(10)
	DECLARE @towhno CHAR(10)
	DECLARE @qty NUMERIC(18,2)
	DECLARE @comp char(10)
	DECLARE @branch char(10)
	declare @ss as varchar(10)
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[#TEMP_PDA]') AND type in (N'U'))
DROP TABLE [dbo].[#TEMP_PDA]

EXEC sp_xml_preparedocument @handle OUTPUT, @PdaTrans

select  barcode,whno,towhno,qty ,branch,comp
into #TEMP_PDA FROM OPENXML (@handle, 'NewDataSet/Table1', 2) WITH
(barcode NVARCHAR(30),
whno CHAR(10),
towhno CHAR(10) ,
qty NUMERIC(18,2),
branch char(10),
comp char(10))
set @ss ='1'

declare @ref int
EXEC sp_xml_removedocument @handle

--insert into TMP(FLD)values('1')

Declare Curs Cursor For
Select * From #TEMP_PDA --WHERE #TEMP_PDA.barcode<>''  AND NOT #TEMP_PDA.barcode IS NULL
				open Curs 
				Fetch Next From Curs Into @barcode,@whno,@towhno,@qty,@branch,@comp
                DECLARE @j INT=1
				set @ref =0
				set @Trdate=CONVERT(VARCHAR(10), getdate(), 112)
				select @ref =dbo.get_last_ref('20', @branch)
				SET @STR_MSG =cast(@ref as nvarchar(20))
				insert into sthdr (branch ,trtype,ref ,trdate ,text ,posted,whno ,towhno,usrid,asmtype, 
				amnttl,costttl,sysdate,src,released,fcy,fcyrate,entries,lastupdt,
				modified,rcvdtrn,custno,brsupp,tobrno,brxref,glref,isbrtrx )
				values(@branch ,'20',@ref ,@Trdate,'',0,@whno,@towhno,'',0,0,0 , @Trdate,'03',1,0,0,0,@Trdate,
				0,0,0,0,0,0,0,0)
				set @ss ='2'
				WHILE @@FETCH_STATUS = 0  
				begin
					set @itemno =''
					set @unicode =''
					set @lcost =0
					set @cmbkey =''
					set @lprice =0
					set @pack0=''

					set @pack_0=0 

					set @shdpk =0
					select @itemno =itemno,@unicode =UNICODE,@cmbkey =cmbkey ,@lprice =lprice1 ,
					@pack0=pack0 ,@shdpk =1,@lcost=lcost   from stunits where barcode =@barcode 

set @ss ='3'
					INSERT INTO STDTL (itemno,unicode,trtype,qty,whno,lcost,trdate,ref,sysdate ,src ,
					lprice,towhno ,barcode,binno,tobinno,branch ,cmbkey,fqty,fcost,fprice ,pack,shdpk ,shdqty ,folio)values(
					@itemno,@unicode,'20',@qty ,@whno ,@lcost ,@Trdate,@ref ,@Trdate,'03', @lprice,@towhno ,@barcode ,
					'','',@branch ,@cmbkey,0,0,0,@pack0,@shdpk,@qty ,@j)
					SET @j=@j +1

					INSERT INTO STDTL (itemno,unicode,trtype,qty,whno,lcost,trdate,ref,sysdate ,src ,
					lprice,towhno ,barcode,binno,tobinno,branch ,cmbkey,fqty,fcost,fprice ,pack,shdpk ,shdqty ,folio)values(
					@itemno,@unicode,'20',@qty ,@towhno  ,@lcost ,@Trdate,@ref ,@Trdate,'03', @lprice,'',@barcode ,
					'','+',@branch ,@cmbkey,0,0,0,@pack0,@shdpk,@qty ,@j )

set @ss ='4'

					update stbins set rsvqty =rsvqty+@qty  where branch =@branch  and whno =@whno 
					and itemno =@itemno  and unicode =@unicode 
					set @j=@j+1

					Fetch Next From Curs Into @barcode,@whno,@towhno,@qty,@branch,@comp
				END

				update stbranch   set   jv_20 =@ref+1  WHERE   company =@comp AND  BRNNO=@branch 
				update sthdr   set   entries =@j-1  WHERE   branch=@branch  and trtype=20 and ref=@ref 

	CLOSE Curs 
	DEALLOCATE Curs
	set @ss ='5'
	COMMIT TRANSACTION
	--	SET @STR_MSG ='DATA UPDATED SUCCESSFULLY'
		SET @RET_ID = 1
		RETURN 	@@ROWCOUNT
	END TRY
	BEGIN CATCH
	ROLLBACK TRANSACTION
		SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  + CONVERT (VARCHAR, @ss) 

		SET @RET_ID = -1
		--insert into TMP(FLD)values(@STR_MSG)
		RETURN -1
	END CATCH
	if @@ROWCOUNT>0 COMMIT TRANSACTION
END

















GO
/****** Object:  StoredProcedure [dbo].[ImportTransferPDAxml_1]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROC [dbo].[ImportTransferPDAxml_1]

@STR_MSG NVARCHAR(1000) OUT,

@RET_ID INT OUT,

@PdaTrans xml

AS BEGIN 

BEGIN TRANSACTION

BEGIN TRY



	DECLARE @shdpk float

	DECLARE @pack0 NVARCHAR(30)

	DECLARE @lprice float

	DECLARE @cmbkey NVARCHAR(50)

	DECLARE @itemno NVARCHAR(30)

	DECLARE @unicode NVARCHAR(30)

	DECLARE @lcost float

	declare @Trdate varchar(20)

	DECLARE @handle INT	

	DECLARE @barcode NVARCHAR(30)

	DECLARE @whno CHAR(10)

	DECLARE @towhno CHAR(10)

	DECLARE @qty NUMERIC(18,2)

	DECLARE @comp char(10)

	DECLARE @branch char(10)

	declare @ss as varchar(10)

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[#TEMP_PDA]') AND type in (N'U'))

DROP TABLE [dbo].[#TEMP_PDA]

EXEC sp_xml_preparedocument @handle OUTPUT, @PdaTrans

select  barcode,whno,towhno,qty ,comp,branch

into #TEMP_PDA FROM OPENXML (@handle, 'NewDataSet/Table1', 2) WITH

(barcode NVARCHAR(30),

whno CHAR(10),

towhno CHAR(10) ,

qty NUMERIC(18,2),

comp char(10),

branch char(10))
set @ss ='1'
declare @ref int

EXEC sp_xml_removedocument @handle

--insert into TMP(FLD)values('1')

Declare Curs Cursor For

Select * From #TEMP_PDA --WHERE #TEMP_PDA.barcode<>''  AND NOT #TEMP_PDA.barcode IS NULL

				open Curs 

				Fetch Next From Curs Into @barcode,@whno,@towhno,@qty,@branch,@comp

                DECLARE @j INT=1

				

				set @ref =0

				set @Trdate=CONVERT(VARCHAR(10), getdate(), 112)



				SELECT @ref= jv_20 +1  FROM stbranch  WHERE COMPANY=@comp and BRNNO=@branch 

				SET @STR_MSG =@ref 

				

				insert into sthdr (branch ,trtype,ref ,trdate ,text ,posted,whno ,towhno,usrid,asmtype, 

				amnttl,costttl,sysdate,src,released,fcy,fcyrate,entries,lastupdt,

				modified,rcvdtrn,custno,brsupp,tobrno,brxref,glref,isbrtrx )

				values(@branch ,'20',@ref ,@Trdate,'',0,@whno,@towhno,'',0,0,0 , @Trdate,'03',1,0,0,0,@Trdate,

				0,0,0,0,0,0,0,0)

				set @ss ='2'

				WHILE @@FETCH_STATUS = 0  

				begin

					

					set @itemno =''

					set @unicode =''

					set @lcost =0

					set @cmbkey =''

					set @lprice =0

					set @pack0=''

					set @shdpk =0

					select @itemno =itemno,@unicode =UNICODE,@cmbkey =cmbkey ,@lprice =lprice1 ,

					@pack0=pack0 ,@shdpk =1   from stunits where barcode =@barcode 


set @ss ='3'
				



					INSERT INTO STDTL (itemno,unicode,trtype,qty,whno,lcost,trdate,ref,sysdate ,src ,

					lprice,towhno ,barcode,binno,tobinno,branch ,cmbkey,fqty,fcost,fprice ,pack,shdpk ,shdqty ,folio)values(

					@itemno,@unicode,'20',@qty ,@whno ,@lcost ,@Trdate,@ref ,@Trdate,'03', @lprice,@towhno ,@barcode ,

					'','',@branch ,@cmbkey,0,0,0,@pack0,@pack0,@qty ,@j)



					SET @j=@j +1



					INSERT INTO STDTL (itemno,unicode,trtype,qty,whno,lcost,trdate,ref,sysdate ,src ,

					lprice,towhno ,barcode,binno,tobinno,branch ,cmbkey,fqty,fcost,fprice ,pack,shdpk ,shdqty ,folio)values(

					@itemno,@unicode,'20',@qty ,@towhno  ,@lcost ,@Trdate,@ref ,@Trdate,'03', @lprice,'',@barcode ,

					'+','',@branch ,@cmbkey,0,0,0,@pack0,@pack0,@qty ,@j )


set @ss ='4'
		

					

					

					update stbins set rsvqty =rsvqty+@qty  where branch =@branch  and whno =@whno 

					and itemno =@itemno  and unicode =@unicode 

					--insert into TMP(FLD)values('4')

					update stbranch   set   jv_20 =@ref  WHERE   company =@comp AND  BRNNO=@branch 

					SELECT *FROM stbranch 

				--	insert into TMP(FLD)values('5')

					update sthdr   set   entries =@j  WHERE   branch=@branch  and trtype=20 and ref=@ref 

				--insert into TMP(FLD)values('6')

					set @j=@j+1

					

					Fetch Next From Curs Into @barcode,@whno,@towhno,@qty,@branch,@comp

				END

	CLOSE Curs 

	DEALLOCATE Curs
	set @ss ='5'
	COMMIT TRANSACTION

		SET @STR_MSG ='DATA UPDATED SUCCESSFULLY'

		SET @RET_ID = 1

		

		RETURN 	@@ROWCOUNT

	END TRY

	BEGIN CATCH

	ROLLBACK TRANSACTION

		SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  + CONVERT (VARCHAR, @ss) 

		SET @RET_ID = -1

		insert into TMP(FLD)values(@STR_MSG)

		RETURN -1

	END CATCH

END





















GO
/****** Object:  StoredProcedure [dbo].[ImportTTKPDA2EXCEL]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[ImportTTKPDA2EXCEL]

@STR_MSG VARCHAR(1000) OUT,
@RET_ID INT OUT,
@PdaTtk xml
AS BEGIN
	BEGIN TRY
		DECLARE @handle INT	,	
				@errstatus int = 0
		declare @sqlmsg varchar(8000)='',
		        @filename varchar(50)='',
				@rtncode varchar(30)=''

				set @filename=@STR_MSG
            ---------
			---------  BCP required all declare variables to be VARCHAR . It is Must  ----------
			---------
		     set @sqlmsg='bcp "select srl_no,barcode,name,cmbkey,qty, whno from ##TEMPEXCEL_PDA " queryout '
			 set @sqlmsg=@sqlmsg+' c:\temp\'+@filename+' -c  -w   -U SA -P infocic -S'+ @@servername
		

	    set @RET_ID = 0
		set @STR_MSG =''

		IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'##TEMPEXCEL_PDA') AND type in (N'U'))
		DROP TABLE [##TEMPEXCEL_PDA]

		EXEC sp_xml_preparedocument @handle OUTPUT, @PdaTtk

		set @rtncode='before create ##TEMPEXCEL_PDA'

		select  srl_no,barcode,name,cmbkey,qty,whno
		into ##TEMPEXCEL_PDA FROM OPENXML (@handle, '/NewDataSet/Table1', 2) WITH
		(srl_no int,
		 barcode nvarchar(20),
		 name nvarchar(50) 'name',
		 cmbkey nvarchar(24),
		 qty nvarchar(20),
		 whno nCHAR(2))
		set @rtncode='After create ##TEMPEXCEL_PDA'		
		EXEC sp_xml_removedocument @handle

		set @rtncode='before calling bcp'

		exec master..xp_cmdshell @sqlmsg
		if @@error<>0
		begin		
			SET @RET_ID = -1
			SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   +' rtncode='+@rtncode
			set @errstatus = -1
		end
		else
		begin
		    set @errstatus = @@ROWCOUNT
			SET @RET_ID = 1				
		end
		IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'##TEMPEXCEL_PDA'))
		DROP TABLE [##TEMPEXCEL_PDA]
		return @errstatus
	END TRY
	BEGIN CATCH
			SET @STR_MSG ='ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +' rtncode='+@rtncode
			SET @RET_ID = -2
			set @errstatus = -2
			IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'##TEMPEXCEL_PDA'))
			DROP TABLE [##TEMPEXCEL_PDA]
			return @errstatus
	END CATCH

END

















GO
/****** Object:  StoredProcedure [dbo].[ImportTTKPDAxml]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROC [dbo].[ImportTTKPDAxml]

@STR_MSG NVARCHAR(1000) OUT,
@RET_ID INT OUT,
@PdaTtk xml,
@USRID nchar(10)
AS BEGIN

    set lock_timeout 2000

	BEGIN TRY
		DECLARE @handle INT	,	
				@errstatus int = 0
		declare @sqlmsg nvarchar(max),
		@device_id as nvarchar(200)=@STR_MSG,
		@col_q as nvarchar(10)=''
		set @col_q ='q'+rtrim(ltrim(cast(@RET_ID as nvarchar(5))))

	    set @RET_ID = 0
		set @STR_MSG =''
		IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'#TEMP_PDA') AND type in (N'U'))
		DROP TABLE [#TEMP_PDA]

		EXEC sp_xml_preparedocument @handle OUTPUT, @PdaTtk

		select  whno,itemno,[unicode],qty
		into #TEMP_PDA FROM OPENXML (@handle, '/NewDataSet/Table1', 2) WITH
		(whno nCHAR(2),
		ITEMNO nchar(16) 'itemno',
		[UNICODE] nchar(6) 'unicode',
		qty FLOAT)
				
		EXEC sp_xml_removedocument @handle
		

		SET @sqlmsg='MERGE TTKNFILE as t
		   using (select whno,SPACE(6) AS binno,replicate(space(1),16-len(rtrim(itemno)))+rtrim(itemno) as itemno,unicode,qty as '+@col_q+' from #TEMP_PDA ) as s
			on t.whno=s.whno and t.binno=s.binno and t.itemno=s.itemno and t.unicode=s.unicode
			when matched then
			update set t.'+@col_q+'=s.'+@col_q 
		  + ' when not matched then '
		  + ' insert (whno,binno,itemno,unicode,'+@col_q+')'
		  +	' values (s.whno,s.binno,s.itemno,s.unicode,s.'+@col_q+');'

		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			SET @RET_ID = -1
			SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   
			set @errstatus = -1
			
		end
		else
		begin		    
		    set @errstatus = @@ROWCOUNT
			commit transaction
			SET @RET_ID = 1	
			begin transaction
			update sysdb.dbo.Pda_devices set lastuserttk=@USRID ,lastTTKupdate=getdate()
			if @@error<>0 	rollback transaction
			   else commit transaction		
		end
		IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'#TEMP_PDA'))
		DROP TABLE [#TEMP_PDA]
		return @errstatus
	END TRY
	BEGIN CATCH
	       if @@trancount>0  ROLLBACK TRANSACTION
		   if @RET_ID <>1
		   begin
				SET @STR_MSG ='ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  
				SET @RET_ID = -2
				set @errstatus = -2
			end
			IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'#TEMP_PDA'))
			DROP TABLE [#TEMP_PDA]
			return @errstatus
	END CATCH

END

















GO
/****** Object:  StoredProcedure [dbo].[ImportXfrPDAxml]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[ImportXfrPDAxml]
@STR_MSG NVARCHAR(1000) OUT,
@RET_ID INT OUT,
@PDAXFR xml,
@WHNO Nchar(2),
@TOWHNO Nchar(2),
@BRANCH Nchar(2),
@USRID Nchar(10)

AS BEGIN 
   set lock_timeout 2000
BEGIN TRY
	DECLARE @shdpk NUMERIC(10,3)
	DECLARE @pack0 NVARCHAR(1)
	DECLARE @pack_0 char(1)
	DECLARE @lprice float
	DECLARE @cmbkey NVARCHAR(24)
	DECLARE @itemno CHAR(16)
	DECLARE @unicode CHAR(6)
	DECLARE @lcost float
	declare @Trdate varchar(20)
	DECLARE @handle INT	
	DECLARE @barcode NVARCHAR(20)
	DECLARE @fm_binno nCHAR(6)
	DECLARE @to_binno nCHAR(6)
	DECLARE @qty float
	DECLARE @comp char(2),
	@binno_found bit =0


	declare @ss as varchar(10),
	@srlno as int =0,
	@shdqty as float=0,
	@frtqty as float =0,
	@ttlqty as float =0,
	@avail_qty float =0,
	@ttlcost as float =0

	declare @dbc varchar(20),
	@lusing_hij_date bit =0,
	@ldate varchar(10),
	@lfdate varchar(8)='',
	@errstatus int =0,
	@stunits_lcost float=0,
	@lexpdate varchar(8)=''

	set @STR_MSG=''
	set @RET_ID=0
	set @dbc=db_name()
	SET @lusing_hij_date=iif(cast(substring(@dbc,7,2) as int)>30,1,0)
	set @comp=substring(@dbc,4,2)
	if @lusing_hij_date=1
	begin
		set @ldate =convert(varchar(10),getdate(),131)
		set @lfdate=substring(@ldate,7,4)+substring(@ldate,4,2)+iif(substring(@ldate,1,1)=' ','0'+substring(@ldate,2,1),substring(@ldate,1,2))
	end
	else
	begin
		set @ldate = convert(varchar(10),getdate(),112)
		set @lfdate=@ldate		
	end
	declare @lcaalwngtvs bit =0,
	        @yrcode varchar(4),
	        @syscode int =2

	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
	
	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @syscode=sysno,@lcaalwngtvs=isnull(caalwngtvs ,0)
	       from sysdb.dbo.glcalend with (nolock)
	       where calcomp=@comp and yrcode=@yrcode

--------------------------------------------------------------------------------------------------------------------------- 
	IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[#TEMPTRX_PDA]') AND type in (N'U'))
	DROP TABLE [dbo].[#TEMPTRX_PDA]

	EXEC sp_xml_preparedocument @handle OUTPUT, @PdaXfr

	select  barcode,frmbinno,Tobinno,shdqty,frtqty 
	into #TEMPTRX_PDA FROM OPENXML (@handle, 'NewDataSet/Table1', 2) WITH
	(barcode nvarCHAR(20),
	frmbinno nCHAR(6),
	Tobinno nCHAR(6),
	shdqty float,
	frtqty float)

	

	declare @ref int=0

	EXEC sp_xml_removedocument @handle
	
--insert into TMP(FLD)values('1')

	Declare Curs Cursor For Select * From #TEMPTRX_PDA 
	open Curs 
	Fetch Next From Curs Into @barcode,@fm_binno,@to_binno,@shdqty,@frtqty
    DECLARE @j INT=1
	set @ref =0
	--set @Trdate=CONVERT(VARCHAR(10), getdate(), 112)
	select @ref =dbo.get_last_ref('20', @branch)
---------------------------------------

---------------------------------------------------------------------
    begin transaction
	insert into sthdr (branch, trtype, ref, trdate, text, amnttl, costttl, sysdate, src, released,
	 posted, fcy, fcyrate, whno, entries, lastupdt, towhno, modified, rcvdtrn, custno, usrid, brsupp,
	 tobrno, brxref, glref, isbrtrx, asmtype, repost )
	 values(@branch ,'20',@ref ,@lfdate,'تحويل مخزني PDA',0,0,@lfdate,'03',0,
	       0,'',0,@whno,0,@lfdate,@towhno,0,0,'',@usrid,'',
		   '',0,0,0,0,0)

		if @@error<>0
		begin
			rollback transaction
			SET @RET_ID = -2
			SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   
			set @errstatus =-2
		end
		----------------------------------

	-------------------------------------
    if @errstatus=0
	begin
		WHILE @@FETCH_STATUS = 0  
		begin
			set @itemno =''
			set @unicode =''
			set @lcost =0
			set @cmbkey =''
			set @lprice =0
			set @pack0=''
			set @stunits_lcost=0
			set @pack_0=0 

			set @shdpk =0
			if @syscode<>6
			begin
				select @itemno =itemno,@unicode =UNICODE,@cmbkey =cmbkey ,@lprice =lprice1 ,
				@pack0=pack0 ,@shdpk =pkqty1,@stunits_lcost=lcost   from stunits with (nolock) 
				where barcode =@barcode 
				
			end
			else
			begin
				select @itemno =a.itemno,@unicode =a.UNICODE,@cmbkey =a.cmbkey ,@lprice =b.lprice1 ,
				@pack0=a.pack0 ,@shdpk =b.pkqty,@stunits_lcost=lcost   from stunits a with (nolock) inner join stitembc b with (nolock)
				on a.itemno=b.itemno and a.unicode=b.unicode
				where pbarcode =@barcode 
				----set @qty=@frtqty*isnull(@shdpk,1)
				if isnull(@shdpk,1)>1 set @lprice=@lprice/@shdpk
            end
			set @qty=@frtqty+(@shdqty*isnull(@shdpk,1))
			set @lexpdate=''
			set @avail_qty=0
			    set @lcost=0
				set @fm_binno=isnull(@fm_binno,space(6))
				set @to_binno=isnull(@to_binno,space(6))

				select 	@lcost=lcost,@avail_qty=qty-rsvqty,@lexpdate=expdate   from stbins with (nolock) where branch =@branch and itemno= @itemno
				and unicode=@unicode and whno=@whno and binno=@fm_binno
				set @avail_qty=isnull(@avail_qty,0)
				
				if @lcost is null
				begin
				    set @binno_found=0
				    set @lcost=@stunits_lcost
				end
				else 
				begin
				    set @binno_found=1
					if @lcost=0 set @lcost=@stunits_lcost
				end

				if @lcaalwngtvs=0
				if @qty>@avail_qty
				begin
					rollback transaction
					SET @RET_ID = -3
					SET @STR_MSG = 'الكمية تجاوزت الرصيد المتاح للصنف '+' '+@cmbkey
					set @errstatus =-3
					break
				end
			--end
	
			INSERT INTO STDTL (itemno,unicode,trtype,qty,whno,lcost,trdate,ref,sysdate ,src ,
			lprice,towhno ,barcode,binno,tobinno,branch ,cmbkey,fqty,fcost,fprice ,pack,shdpk ,shdqty ,folio,expdate)values(
			@itemno,@unicode,'20',@qty ,@whno ,@lcost ,@lfdate,@ref ,@lfdate,'03', @lprice,@towhno ,@barcode ,
			@fm_binno,@to_binno,@branch ,@cmbkey,0,0,0,@pack0,1,@qty ,@j,@lexpdate)
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -4
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   
				set @errstatus =-4
				break
			end
	
			SET @j=@j +1
			set @ttlqty=@ttlqty +@qty
			set @ttlcost=@ttlcost+(@qty*@lcost)
			--set @tobinno=
			INSERT INTO STDTL (itemno,unicode,trtype,qty,whno,lcost,trdate,ref,sysdate ,src ,
			lprice,towhno ,barcode,binno,tobinno,branch ,cmbkey,fqty,fcost,fprice ,pack,shdpk ,shdqty ,folio,expdate)values(
			@itemno,@unicode,'20',@qty ,@towhno  ,@lcost ,@lfdate,@ref ,@lfdate,'03', @lprice,'',@barcode ,
			@to_binno,'+',@branch ,@cmbkey,0,0,0,@pack0,1,@qty ,@j ,@lexpdate)


			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -5
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   
				set @errstatus =-5
				break
			end

			if @binno_found = 1
			    update stbins set rsvqty =rsvqty+@qty  where branch =@branch and itemno =@itemno  and unicode =@unicode  and whno =@whno and binno=@fm_binno
            else insert into stbins (branch, itemno, unicode, whno, binno, qty, rsvqty, openbal, lcost,
			 fcost, openlcost, openfcost, expdate) values (@branch,@itemno,@unicode,@whno,@fm_binno,0,@qty,0,@lcost,
			 0,0,0,' ')
	
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -6
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   
				set @errstatus =-6
				break
			end		 
			set @j=@j+1

			Fetch Next From Curs Into @barcode,@fm_binno,@to_binno,@shdqty,@frtqty
		END
		if @errstatus =0
		begin

			update sthdr   set   entries =(@j-1)/2,amnttl = @ttlqty,costttl=@ttlcost  WHERE   branch=@branch  and trtype=20 and ref=@ref 
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -7
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   
				set @errstatus =-7
			end
			else
			begin
				update stbranch   set   jv_20 =@ref+1  WHERE   company =@comp AND  BRNNO=@branch 
				if @@error<>0
				begin
					rollback transaction
					SET @RET_ID = -8
					SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   
					set @errstatus =-8				
				end
				else 
				begin
					set @errstatus = @@ROWCOUNT
					commit transaction
					SET @RET_ID = 1	
				end
			end
		end
	end
	CLOSE Curs 
	DEALLOCATE Curs
	IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'#TEMPTRX_PDA'))
	DROP TABLE [#TEMPTRX_PDA]
    return @errstatus
END TRY
	BEGIN CATCH
	    if @@TRANCOUNT >0 ROLLBACK TRANSACTION
		SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () 

		SET @RET_ID = -99
		IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'#TEMPTRX_PDA'))
		DROP TABLE [#TEMPTRX_PDA]
		--insert into TMP(FLD)values(@STR_MSG)
		RETURN -99
END CATCH
	
END

















GO
/****** Object:  StoredProcedure [dbo].[is_client_got_dsc]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[is_client_got_dsc]

 @l_company char(2),
 @l_custno char(6),
 @l_barcode char(20),
 @l_errstatus   int =0 output ---  0 = No discount 1 = there is discount -1= error
 
	
AS
BEGIN
	declare @ldscstatus int =0
        

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	select top 1 @ldscstatus=count(*) from sales_dd where company=@l_company and invtype='21' and custno=@l_custno
	and barcode=@l_barcode 
	set @l_errstatus=@ldscstatus
END

















GO
/****** Object:  StoredProcedure [dbo].[is_column_exist]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[is_column_exist]

 @column_name varchar(20),
 @table_name  varchar(20),
 @errstatus int = 0 output
	
AS
BEGIN
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
		SET NOCOUNT ON
--        declare 1
 ----------------------------------------------------- positems  -------------------------------------------------
	if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = @table_name and COLUMN_NAME=@column_name)
		set @errstatus=1
	else  set @errstatus=0
		return @errstatus
end













GO
/****** Object:  StoredProcedure [dbo].[jc_uncomplete]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create PROCEDURE [dbo].[jc_uncomplete]
 @m_cmp char(2),
 @m_type char(2),
 @m_ref  numeric(6,0), 
 @pstmode bit,
 @lsrc char(2),
 @errcode char(4) output
 
	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.posted,trdate,src,AMNTTL,costttl,entries
	SET NOCOUNT ON
	declare @lAMNTTL numeric(20,7)=0,
	@lptr int =0,
	@no_entries int=0,
	@lcostttl numeric(20,7),
	@posted bit,
	@src char(2)
	set @errcode='';

    select @posted=posted,@src=src,@lAMNTTL=AMNTTL,@lcostttl=costttl,@no_entries=entries from sthdr with (NOLOCK) 
	where branch=@m_cmp and trtype=@m_type and ref=@m_ref
    set @lptr=@@rowcount

	declare @llref numeric(6,0),
		@llinvttl numeric(20,7),
		@llextamt numeric(20,7),
		@llfcy char(3),
		@llfcyrate numeric(20,7),
		@llcamt numeric(20,7)=0,
		@litem_lines int=0,
		@llttl numeric(20,7)=0,
		@llxttl numeric(20,7)=0

	if @lsrc<>'03' and @lsrc<>'55'  --  55 job costing
	begin
		  if @lptr=0
		  begin
			set @errcode='122'
			return
		  end
		  set @lptr=0
		  if @pstmode=1 
		  begin
			  if  @posted=0
			  begin
				set @errcode='136'
				return
			  end
		  end
		  else 
		  if  @posted=1
		  begin 
				set @errcode='212'
				return
		  end


          If @lsrc='05' And @src=@lsrc
		  begin
				--invTTL,extamt,fcy,fcyrate
				select @llinvttl=invTTL,@llextamt=extamt,@llfcy=isnull(fcy,''),@llfcyrate=isnull(fcyrate,0)
				from sales_hd with (NOLOCK) where COMPANY=@m_cmp AND INVTYPE=@m_type AND REF=@m_ref
				if @@rowcount=0
				begin
					set @errcode='122'
					return
				end
				If isnull(@llfcy,'')=''
					set  @llcamt=(@llinvttl-@llextamt)
				Else
					set  @llcamt=(@llinvttl-@llextamt)*@llfcyrate;

				select @litem_lines=sum(iif(itemtype in ('5','6'),1,0)),@llxttl=sum(iif(itemtype in ('5','6'),0,
				(qty*price)*iif(@llfcy<>'' and @llfcyrate>0,@llfcyrate,1)))
				from sales_dt with (NOLOCK) inner join stitems on sales_dt.itemno=stitems.itemno
				where sales_dt.COMPANY=@m_cmp AND INVTYPE=@m_type AND REF=@m_ref    
				if @@rowcount=0
				begin
					set @errcode='140'
					return
				end
				If Abs(@lAMNTTL-@llcamt)>.001  And @litem_lines=0 
				begin
					set @errcode='213'
					return
				end
                select @lptr=sum(1),@llttl=sum(lprice*qty) from stdtl with (NOLOCK) where 
				branch=@m_cmp and trtype=@m_type and ref=@m_ref
		  end
          If @lsrc='07' And @src=@lsrc
		  begin
				select @llcamt=invcst
				from puhdr with (NOLOCK) where COMPANY=@m_cmp AND INVTYPE=@m_type AND REF=@m_ref
				if @@rowcount=0
				begin
					set @errcode='122'
					return
				end
				If @lcostttl<>@llcamt
				begin
					set @errcode='213'
					return
				end
                select @lptr=sum(1),@llttl=sum(lcost*(qty+fqty)) from stdtl with (NOLOCK) where 
				branch=@m_cmp and trtype=@m_type and ref=@m_ref
		  end
	end
    if  @src<>@lsrc
	begin
		set @errcode='124'
		return
	end	
	set @no_entries=@no_entries+iif(@m_type='20',@no_entries,0)
	if @lsrc='03' or @lsrc='55'  --  55 job costing
	begin
		select @lptr=sum(1) from stdtl with (NOLOCK) where branch=@m_cmp and trtype=@m_type and ref=@m_ref
	end
	set @lptr=isnull(@lptr,0)
	if @lptr<>@no_entries
	begin
		set @errcode='140'
		return
	end	
	if @lsrc<>'03' and @lsrc<>'55'  --  55 job costing
	begin
	   if @lsrc='05'
	   begin
	     If Abs(@llxttl-@llttl)>=1
		 begin
			set @errcode='213'
			return
		 end
	   end
	   else
	   begin
	     If Abs(@llttl-@llcamt)>=1
		 begin
			set @errcode='213'
			return
		 end
	   end
	end	
end







GO
/****** Object:  StoredProcedure [dbo].[Move_Data_by_linkserver]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2023-10-11@@$$##  Important : must have this line as first line which contains the last update date for the this file 
 
CREATE PROCEDURE [dbo].[Move_Data_by_linkserver]
	@fmdate varchar(8),
	@todate varchar(8),
	@linkserver nvarchar(50),
	@ok_sl bit,
	@ok_pu bit,
	@ok_st bit,
	@ok_gl bit,
	@ok_ap bit,
	@ok_ar bit,
	@ok_chq bit,
	@ok_resendtrx BIT,
	@ok_sd bit,
	@errstatus int = 0 output
 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from

----- Added on 2023-10-11 AA Fixed many bugs in importing sales_ei done by khalid

	SET NOCOUNT ON
-- 
   declare @posfdate date,
		   @postdate date

   Declare @lcall_frm_job bit=0,
           @ldate varchar(10),
		   @lfdate varchar(8)='',
		   @ltdate varchar(8)='',
		   @lusing_hij_date bit=0,
		   @dbcname nvarchar(10),
		   @dbc nvarchar(50),
		   @sqlmsg nvarchar(max)
		

    set @dbcname=db_name()
	SET @lusing_hij_date=iif(cast(substring(@dbcname,7,2) as int)>30,1,0)

	


-- First check if link server exist

   if not exists(select name from sys.servers where name=@linkserver)
   begin
      set @errstatus=-99
	  return @errstatus
   end
   --IF not EXISTS (SELECT name FROM master.dbo.sysdatabases WHERE name = @dbcname)
   set @dbc=@linkserver+'.'+@dbcname+'.dbo.'

-- Process the data 
  if isnull(@fmdate,'')=''  and isnull(@todate,'')=''
   begin
       set @lcall_frm_job=1
	   if @lusing_hij_date=1
	   begin
		   set @ldate =convert(varchar(10),dateadd(dd,-1,getdate()),131)
		   set @lfdate=substring(@ldate,7,4)+substring(@ldate,4,2)+iif(substring(@ldate,1,1)=' ','0'+substring(@ldate,2,1),substring(@ldate,1,2))
		   set @ldate = convert(varchar(10),getdate(),131)
		   set @ltdate=substring(@ldate,7,4)+substring(@ldate,4,2)+iif(substring(@ldate,1,1)=' ','0'+substring(@ldate,2,1),substring(@ldate,1,2))
	   end
	   else
	   begin
	      set @ldate = convert(varchar(10),dateadd(dd,-1,getdate()),112)
	      set @lfdate=@ldate
		  set @posfdate=cast(@ldate as date)
		  set @ltdate=convert(varchar(10),getdate(),112) --@ldate
		  set @postdate=cast(@ltdate as date)
	   end
   end
   else
   begin
        set @lcall_frm_job=0
		set @lfdate=@fmdate
		set @ltdate=@todate
   end

 


Declare @Item_cnd nvarchar(100)='',
        @st_cnd  nvarchar(100)='',
		@gl_cnd  nvarchar(100)='',
		@ar_cnd  nvarchar(100)='',
		@ap_cnd  nvarchar(100)=''

----  Process Puhdr & Pudtl Table 
    if @ok_pu=1
	begin

		
		set @sqlmsg='merge puhdr as t 
		using (select * from '+@dbc+'puhdr with (NOLOCK) where posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
		+' and invdate between '+@lfdate+' and '+@ltdate+') as s
		on t.company=s.company and t.invtype=s.invtype and t.ref=s.ref
		when not matched then
		insert (slcenter,branch,company,invtype,ref,invdate,custno,custnm,glser,dsctype,pstmode,fcy
		         ,fcyrate,duedate,invttl,invcst,invdspc,invdsvl,valafds,invpaid,caser,entries
				 ,released,posted,fixrate,spply_exp,pricetp,isglact,chkno,chkdate,lastupdt
				 ,jvgenrt,imfcval,lcser,frieght,insurexp,customfee,portexp,samplexp,lcinvexp
				 ,fcinvexp,lcothrexp,fineexp,lcttlexp,fcttlexp,tktexp,freexp,transexp
                 ,prodrate,isl_c,binno,aprxcst,aprxpc,aprxser,expser,modified,splyinv,isorder
				 ,settled,rcvdtrn,fcothrexp,usrid,jvdsc,paylcl,tdscpcs,tdscdays,orderno,slcode
				 ,lccode,edm,shpdate,gntd_fm_lc,lc_ship_no,xfr_amt,xfr_acc,vat_amt_paid
				 ,taxfree_purchase,VatNot4Vender,vndr_taxcode,expns4vat,tax_Pd_mthd,vndr_kind
				 ,manulvat,hlldscnt,dscamt_type,PriceIncludeVat,vat_percent,fqtyval,datetime_stamp,chng_item_price) 
		values (S.slcenter,S.branch,S.company,S.invtype,S.ref,S.invdate,S.custno,S.custnm,S.glser,S.dsctype
           ,S.pstmode,S.fcy,S.fcyrate,S.duedate,S.invttl,S.invcst,S.invdspc,S.invdsvl,S.valafds,S.invpaid
		   ,S.caser,S.entries,S.released,0,S.fixrate,S.spply_exp,S.pricetp,S.isglact,S.chkno
		   ,S.chkdate,S.lastupdt,S.jvgenrt,S.imfcval,S.lcser,S.frieght,S.insurexp,S.customfee
		   ,S.portexp,S.samplexp,S.lcinvexp,S.fcinvexp,S.lcothrexp,S.fineexp,S.lcttlexp,S.fcttlexp
		   ,S.tktexp,S.freexp,S.transexp,S.prodrate,S.isl_c,S.binno,S.aprxcst,S.aprxpc,S.aprxser
		   ,S.expser,S.modified,S.splyinv,S.isorder,S.settled,S.rcvdtrn,S.fcothrexp,S.usrid,S.jvdsc,S.paylcl
           ,S.tdscpcs,S.tdscdays,S.orderno,S.slcode,S.lccode,S.edm,S.shpdate,S.gntd_fm_lc
           ,S.lc_ship_no,S.xfr_amt,S.xfr_acc,S.vat_amt_paid,S.taxfree_purchase,S.VatNot4Vender
           ,S.vndr_taxcode,S.expns4vat,S.tax_Pd_mthd,S.vndr_kind,S.manulvat,S.hlldscnt
           ,S.dscamt_type,S.PriceIncludeVat,S.vat_percent,S.fqtyval,s.datetime_stamp,s.chng_item_price);'
		
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-1	
			return	@errstatus		 				
		end
		
		set @sqlmsg='merge pudtl as t 
		using (select b.* from '+@dbc+'puhdr a with (NOLOCK) inner join '+@dbc+'pudtl b with (NOLOCK)
		on a.company=b.company and a.invtype=b.invtype and a.ref=b.ref
				where posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
			+'	and a.invdate between '+@lfdate+' and '+@ltdate+') as s
		on t.company=s.company and t.invtype=s.invtype and t.ref=s.ref and t.folio=s.folio
		when not matched then
		insert (slcenter,company,invtype,ref,invdate,itemno,unicode,qty,fqty,price,discpc
           ,cost,ds_acfm,sl_acfm,gclass,custno,fcy,barcode,imfcval,pack,pkqty
           ,expdate,binno,shdqty,shdpk,shadd,frtqty,cmbkey,folio,rplct_post
           ,edm_value,whno,splyinv,garntee_amt,Taxtype)
		values (S.slcenter,S.company,S.invtype,S.ref,S.invdate,S.itemno,S.unicode,S.qty,S.fqty,S.price,S.discpc
           ,S.cost,S.ds_acfm,S.sl_acfm,S.gclass,S.custno,S.fcy,S.barcode,S.imfcval,S.pack,S.pkqty
           ,S.expdate,S.binno,S.shdqty,S.shdpk,S.shadd,S.frtqty,S.cmbkey,S.folio,0
           ,S.edm_value,S.whno,S.splyinv,S.garntee_amt,S.Taxtype);'

		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-2	
			return @errstatus			 				
		end
		
		---------  Slvchrimage   Table  
		set @sqlmsg='merge Slvchrimage as t 
		using (select  b.* from '+@dbc+'puhdr a with (NOLOCK) inner join '+@dbc+'Slvchrimage b with (NOLOCK) 
		on a.company=b.company and a.invtype=b.invtype and a.ref=b.ref
				where posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
			+'	and a.invdate between '+@lfdate+' and '+@ltdate+') as s
		on t.company=s.company and t.invtype=s.invtype and t.ref=s.ref 
		when not matched then
		insert (company,invtype,ref,vchrpicture,voucherNo,No_of_cartons,pricePerUnit,carrierNo
          ,DriverName,mobileNo,delivaryDate,rcvdDate,rcvd_person,Pstatus,notes
          ,src,vdate,usrid,confirmed,rtnref)
		values (S.company,S.invtype,S.ref,S.vchrpicture,S.voucherNo,S.No_of_cartons,S.pricePerUnit,S.carrierNo
          ,S.DriverName,S.mobileNo,S.delivaryDate,S.rcvdDate,S.rcvd_person,S.Pstatus,S.notes
          ,S.src,S.vdate,S.usrid,S.confirmed,S.rtnref);'

		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-3	
			return	@errstatus		 				
		end
		
		---------  Sltrans   Table 
		set @sqlmsg='merge sltrans as t 
		using (select distinct c.* from '+@dbc+'puhdr a with (NOLOCK) inner join '+@dbc+'Slvchrimage b with (NOLOCK) 
		inner join sltrans c with (NOLOCK)
		on b.carrierNo=c.code
		on a.company=b.company and a.invtype=b.invtype and a.ref=b.ref
		where posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
		+'	and a.invdate between '+@lfdate+' and '+@ltdate+') as s
		on t.code=s.code
		when not matched then
		insert ( code,cname,pname,address,tel,fax,mobile,modified,lcname,lpname,lastupdt
       ,laddress,pricePerUnit,tprtexpact,is_vat) 
		values (S.code,S.cname,S.pname,S.address,S.tel,S.fax,S.mobile,S.modified,S.lcname,S.lpname,S.lastupdt
       ,S.laddress,S.pricePerUnit,S.tprtexpact,S.is_vat);'

		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-4	
			return	@errstatus		 				
		end
		
		---------  Stcrtpuinv   Table  
		set @sqlmsg='merge Stcrtpuinv as t 
		using (select distinct b.* from '+@dbc+'puhdr a with (NOLOCK) inner join '+@dbc+'Stcrtpuinv b with (NOLOCK)
		on a.company=b.branch and iif(a.custno<>'''',cast(a.custno as char(19)),a.caser)=b.splycode and a.fcy=b.fcy and a.splyinv=b.splyinv
				where posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
			+'	and a.invdate between '+@lfdate+' and '+@ltdate+' and a.invtype in (''10'',''11'')) as s
		on t.branch=s.branch and t.splycode=s.splycode and t.fcy=s.fcy and t.splyinv=s.splyinv and t.itemno=s.itemno and t.unicode=s.unicode
		when not matched then
		insert ( branch,splycode,fcy,splyinv,itemno,unicode,dbxyr,idate
         ,lastupdt,rplct_post,slcode)
		values (S.branch,S.splycode,S.fcy,S.splyinv,S.itemno,S.unicode,S.dbxyr,S.idate
         ,S.lastupdt,S.rplct_post,S.slcode);'

		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-5	
			return	@errstatus		 				
		end
		commit transaction
		
	-------  Process puprsnitems 

			set @sqlmsg='merge puprsnitems as t
			using ( select distinct c.* from '+@dbc+'sthdr a with (NOLOCK) inner join '+@dbc+'stdtl b with (NOLOCK)
			inner join '+@dbc+'puprsnitems c with (NOLOCK)
			on b.itemno=c.itemno
			on a.branch=b.branch and a.trtype=b.trtype and a.ref=b.ref
			where posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
			+' and a.trdate between '+@lfdate+' and '+@ltdate+' and a.src=''07'' ) as s
			on t.itemno=s.itemno 
			when not matched then
			insert (itemno,slcode,notified)
			values (s.itemno,s.slcode,s.notified);'

			begin transaction
			exec sp_executesql @sqlmsg
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-6	
				return @errstatus			 				
			end
			commit transaction
			
	-------  Process stcosttype 
	   

			
			--set @sqlmsg='merge stcosttype as t
			--using ( select distinct c.* from '+@dbc+'sthdr a with (NOLOCK) inner join '+@dbc+'stdtl b with (NOLOCK)
			--inner join '+@dbc+'stcosttype c with (NOLOCK)
			--on b.branch=c.branch and b.itemno=c.itemno and b.unicode=c.unicode
			--on a.branch=b.branch and a.trtype=b.trtype and a.ref=b.ref
   --         where posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
			--+' and a.trdate between '+@lfdate+' and '+@ltdate+' and a.trtype in (''10'',''11'') ) as s
			--on t.branch=s.branch and t.itemno=s.itemno and t.unicode=s.unicode
			--when matched and s.lstrcvdate>t.lstrcvdate then
			--update set t.highlcost=s.highlcost,t.lowlcost=s.lowlcost,t.lstrcvdate=s.lstrcvdate,t.lastlcost=s.lastlcost,
			--t.lastfcost=s.lastfcost
			--when not matched then
			--insert (branch,itemno ,unicode  ,lastlcost,highlcost,lowlcost ,lstrcvdate,lastfcost) values
			--(s.branch,s.itemno ,s.unicode  ,s.lastlcost,s.highlcost,s.lowlcost ,s.lstrcvdate,s.lastfcost);'
			
			--begin transaction
			--exec sp_executesql @sqlmsg
			--if @@error<>0
			--begin
			--	rollback transaction
			--	set @errstatus=-19	
			--	return	@errstatus
			--end
			--commit transaction
		

		set @Item_cnd='a.src=''07'''
		set @st_cnd='a.src=''07'''
		set @gl_cnd='jhsrc=''07'''
		set @ap_cnd='hd_trxsrc=''07'''
	end
---  Sales Processing 
    if @ok_sl=1
	begin

------ Sales_hd Table
		
		set @sqlmsg='merge sales_hd as t 
		using (select * from '+@dbc+'sales_hd with (NOLOCK) where posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
		+' and invdate between '+@lfdate+' and '+@ltdate+') as s
		on t.company=s.company and t.invtype=s.invtype and t.ref=s.ref
		when not matched then
		 insert (slcenter,branch,company,invtype,ref,invdate,custno,custnm,glser,dsctype
           ,pstmode,fcy,fcyrate,duedate,invttl,invcst,invdspc,invdsvl,valafds
           ,invpaid,caser,entries,released,posted,fixrate,extamt,extser,pricetp
           ,ischeque,chkno,chkdate,lastupdt,jvgenrt,cccommsn,belowbal,fcy2,ccpayment
           ,rplsamt,pdother,slcode,prpaidamt,instldays,instflag,slcmnd,inv_printed
           ,bendit,modified,rqstorder,rqststld,carrier,rcvdtrn,usrid,address,suspend
           ,rtnref,ispurchase,stkjvno,posinv,sanedcrd_amt,invlocked,remarks,remarks2
           ,rtncash_dfrpl,vat_amt_rcvd,taxfree_sales,clnt_taxcode,clnt_kind,hlldscnt
           ,no_round_nm,pricevattype,sysno,smssent,stcpay_amt,fc2lcamt,qitaf_amt
           ,whlslinv,vat_percent,fsh_printed,fqtyval,datetime_stamp,Fusrprintinv,discountedBill
		   ,almnm_contract_section,instlmnt_code,installment_amt,mobileNo,client_name,cashpaid)
		 values (S.slcenter,S.branch,S.company,S.invtype,S.ref,S.invdate,S.custno,S.custnm,S.glser,S.dsctype
           ,S.pstmode,S.fcy,S.fcyrate,S.duedate,S.invttl,S.invcst,S.invdspc,S.invdsvl,S.valafds
           ,S.invpaid,S.caser,S.entries,S.released,0,S.fixrate,S.extamt,S.extser,S.pricetp
           ,S.ischeque,S.chkno,S.chkdate,S.lastupdt,S.jvgenrt,S.cccommsn,S.belowbal,S.fcy2,S.ccpayment
           ,S.rplsamt,S.pdother,S.slcode,S.prpaidamt,S.instldays,S.instflag,S.slcmnd,S.inv_printed
           ,S.bendit,S.modified,S.rqstorder,S.rqststld,S.carrier,S.rcvdtrn,S.usrid,S.address,S.suspend
           ,S.rtnref,S.ispurchase,S.stkjvno,S.posinv,S.sanedcrd_amt,S.invlocked,S.remarks,S.remarks2
           ,S.rtncash_dfrpl,S.vat_amt_rcvd,S.taxfree_sales,S.clnt_taxcode,S.clnt_kind,S.hlldscnt
           ,S.no_round_nm,S.pricevattype,S.sysno,S.smssent,S.stcpay_amt,S.fc2lcamt,S.qitaf_amt
           ,S.whlslinv,S.vat_percent,S.fsh_printed,S.fqtyval,s.datetime_stamp,s.Fusrprintinv,s.discountedBill
		   ,s.almnm_contract_section,s.instlmnt_code,s.installment_amt,s.mobileNo,s.client_name,s.cashpaid);'	

		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-7
			return @errstatus
		end
	
	-----------



---------- Modified on 2023-10-11 AA  Sales_ei -----------------------------------------------------------------------------------------
		set @sqlmsg='merge sales_ei as t 
		using 
		(select a.* from '+@dbc+'sales_ei a with (NOLOCK) inner join '+@dbc+'gljrhdr b with (NOLOCK) 
		on a.company=b.jhcomp and a.invtype=b.jhtype and a.ref=b.jhref
		where b.jhposted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')+' and b.jhdate between '+@lfdate+' and '+@ltdate+') as s 
		on t.company=s.company and t.invtype=s.invtype and t.ref=s.ref 
		when not matched then 
	    insert (company,invtype,ref,InvoiceTypeCode,tax_invoice_type,uuid,previousInvoiceHash,QRvalue,
			Order_ref_id,ContractDocRef,PaymentType,InvoiceTransactionCode,DebitCreditReason,
			CurrentInvoiceHash,InvoiceCounterValue,LatestDeliveryDate,einv_is_sent,usr_slct_simple_einv,
			invoice_charges,ubl,ExemptionReason,Exemptioncode,reason_not_sent,zatca_datetime,
			folio,DeviceSN,is_production)
		 values (s.company,s.invtype,s.ref,s.InvoiceTypeCode,s.tax_invoice_type,s.uuid,s.previousInvoiceHash,s.QRvalue,
			s.Order_ref_id,s.ContractDocRef,s.PaymentType,s.InvoiceTransactionCode,s.DebitCreditReason,
			s.CurrentInvoiceHash,s.InvoiceCounterValue,s.LatestDeliveryDate,s.einv_is_sent,s.usr_slct_simple_einv,
			s.invoice_charges,s.ubl,s.ExemptionReason,s.Exemptioncode,s.reason_not_sent,s.zatca_datetime,
			s.folio,s.DeviceSN,s.is_production);'
	
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-5
			return 
		end

------------------------------------------------------------------------------------------------------------------------------	
------ Sales_dt Table

		set @sqlmsg='merge Sales_dt as t 
		using (select b.* from '+@dbc+'Sales_hd a with (NOLOCK) inner join '+@dbc+'Sales_dt b with (NOLOCK)
		on a.company=b.company and a.invtype=b.invtype and a.ref=b.ref
				where posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
			+'	and a.invdate between '+@lfdate+' and '+@ltdate+') as s 
		on t.company=s.company and t.invtype=s.invtype and t.ref=s.ref and t.folio=s.folio
		when not matched then
		 insert ( slcenter,company,invtype,ref,invdate,itemno,unicode,qty,fqty,price,discpc
           ,cost,ds_acfm,sl_acfm,gclass,custno,fcy,barcode,imfcval,pack,pkqty
           ,shadd,shdpk,shdqty,frtqty,rtnqty,whno,cmbkey,folio,rplct_post,sold_item_status
           ,taxtype,ps_item_vat,dsc_amt,binno)
		 values (S.slcenter,S.company,S.invtype,S.ref,S.invdate,S.itemno,S.unicode,S.qty,S.fqty,S.price,S.discpc
           ,S.cost,S.ds_acfm,S.sl_acfm,S.gclass,S.custno,S.fcy,S.barcode,S.imfcval,S.pack,S.pkqty
           ,S.shadd,S.shdpk,S.shdqty,S.frtqty,S.rtnqty,S.whno,S.cmbkey,S.folio,S.rplct_post,S.sold_item_status
           ,S.taxtype,S.ps_item_vat,S.dsc_amt,s.binno);'

		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-9
			return @errstatus
		end
        commit transaction
		
		set @Item_cnd=iif(@Item_cnd<>'',@Item_cnd+' or ','')+'a.src=''05'''
		set @st_cnd=iif(@st_cnd<>'',@st_cnd+' or ','')+'a.src=''05'''
		set @gl_cnd=iif(@gl_cnd<>'',@gl_cnd+' or ','')+'jhsrc=''05'''
		set @ar_cnd=iif(@ar_cnd<>'',@ar_cnd+' or ','')+'hd_trxsrc=''05'''
	end
----------------------sales_ei -------- 


----  Process sdaad_hd & sdaad_dt ,sdhdr & sddtl Table  
 	if @ok_sd=1 
	begin
------ sdaad_hd Table
		set @sqlmsg='merge sdaad_hd as t 
		using (select * from '+@dbc+'sdaad_hd with (NOLOCK) where posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
		+' and sddate between '+@lfdate+' and '+@ltdate+') as s
		on t.company=s.company and t.sdtype=s.sdtype and t.ref=s.ref
		when not matched then
		insert (company,sdtype,ref,sdtext,sdtcode,caser,sddate,sdamount,released,posted
          ,lastupdt,usrid,sdttlamt,rcvdtrn,sdentries,Vat_Percent,sdttlvatamt
          ,vat_included,sdNoVat)
		values (S.company,S.sdtype,S.ref,S.sdtext,S.sdtcode,S.caser,S.sddate,S.sdamount,S.released,0
          ,S.lastupdt,S.usrid,S.sdttlamt,S.rcvdtrn,S.sdentries,S.Vat_Percent,S.sdttlvatamt
          ,S.vat_included,S.sdNoVat);'

		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-27
			return @errstatus
		end
------ sdaad_dt Table
		set @sqlmsg='merge sdaad_dt as t 
		using (select b.* from '+@dbc+'sdaad_hd a with (NOLOCK) inner join sdaad_dt b with (NOLOCK) 
		on a.company=b.company and a.sdtype=b.sdtype and a.ref=b.ref
		where posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
	   + ' and a.sddate between '+@lfdate+' and '+@ltdate+') as s
	   on t.company=s.company and t.sdtype=s.sdtype and t.ref=s.ref and t.folio=s.folio
	   when not matched then
	   insert (company,sdtype,ref,sdsubscrbno,sdamount,sdlastpaid,sdlastamt,sdtext
         ,sdtcode,folio,vat_amt_paid)
	   values (S.company,S.sdtype,S.ref,S.sdsubscrbno,S.sdamount,S.sdlastpaid,S.sdlastamt,S.sdtext
         ,S.sdtcode,S.folio,S.vat_amt_paid);'
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-112	
			return	@errstatus		 				
		end
		

------ sdhdr Table
	    set @sqlmsg='merge sdhdr as t 
		using (select * from '+@dbc+'sdhdr with (NOLOCK) where hd_posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
		+' and hd_date between '+@lfdate+' and '+@ltdate+' ) as s
		on t.hd_company=s.hd_company and t.hd_type=s.hd_type and t.hd_ref=s.hd_ref
		when not matched then
		insert ( hd_company,hd_type,hd_ref,hd_date,hd_fcy,hd_ftotal,hd_fcyrate,hd_ltotal,hd_cucode
             ,hd_desc1,hd_ser,hd_rlsd,hd_posted,hd_trxsrc,hd_sysdate,hd_lcnet,hd_fcnet
             ,hd_lccnet,hd_fccnet,isit_opst,opst_val,opst_fcy,lastupdt,modified
             ,rcvdtrn,usrid,clcode,clcmnd,dscamt,payinv,rowguid,Vat_Percent,serial_no,brxfrm,caser,ctype,datetime_stamp,clnt_kind)
		values (S.hd_company,S.hd_type,S.hd_ref,S.hd_date,S.hd_fcy,S.hd_ftotal,S.hd_fcyrate,S.hd_ltotal,S.hd_cucode
             ,S.hd_desc1,S.hd_ser,S.hd_rlsd,0,S.hd_trxsrc,S.hd_sysdate,S.hd_lcnet,S.hd_fcnet
             ,S.hd_lccnet,S.hd_fccnet,S.isit_opst,S.opst_val,S.opst_fcy,S.lastupdt,S.modified
             ,S.rcvdtrn,S.usrid,S.clcode,S.clcmnd,S.dscamt,S.payinv,S.rowguid,S.Vat_Percent,S.serial_no,s.brxfrm,s.caser,s.ctype,s.datetime_stamp,s.clnt_kind);'
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-112	
			return	@errstatus		 				
		end
------ sddtl Table
	    set @sqlmsg='merge sddtl as t 
		using (select b.* from '+@dbc+'sdhdr a with (NOLOCK) inner join '+@dbc+'sddtl b
		on  a.hd_company=b.dt_company and a.hd_type=b.dt_type and a.hd_ref=b.dt_ref
		where hd_posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
		+' and hd_date between '+@lfdate+' and '+@ltdate+' ) as s
		on t.dt_company=s.dt_company and t.dt_type=s.dt_type and t.dt_ref=s.dt_ref and t.dt_folio=s.dt_folio
		when not matched then
		insert ( dt_company,dt_type,dt_ref,dt_date,dt_lcamt,dt_paidamt,dt_discamt,dt_cucode
             ,dt_fcy,dt_trxsrc,dt_fcamt,dt_fpydamt,dt_fdscamt,dt_lcaloc,dt_fcaloc
             ,dt_aloctd,dt_pdinv,dt_duedate,dt_desc,dt_chkno,dt_chkdate,dt_chkbnk
             ,dt_dbcr,dt_ackey,dt_folio,dt_rcvno,dt_lstdate,tdscdays,tdscpcs
             ,match,rplct_post,rowguid,dt_sucode,cstcode,taxcatId,jdcstval
             ,cstkey,vndr_taxcode,vndr_name,no_chng_col,amtincldvat)
		values (S.dt_company,S.dt_type,S.dt_ref,S.dt_date,S.dt_lcamt,S.dt_paidamt,S.dt_discamt,S.dt_cucode
             ,S.dt_fcy,S.dt_trxsrc,S.dt_fcamt,S.dt_fpydamt,S.dt_fdscamt,S.dt_lcaloc,S.dt_fcaloc
             ,S.dt_aloctd,S.dt_pdinv,S.dt_duedate,S.dt_desc,S.dt_chkno,S.dt_chkdate,S.dt_chkbnk
             ,S.dt_dbcr,S.dt_ackey,S.dt_folio,S.dt_rcvno,S.dt_lstdate,S.tdscdays,S.tdscpcs
             ,S.match,S.rplct_post,S.rowguid,S.dt_sucode,S.cstcode,S.taxcatId,S.jdcstval
             ,S.cstkey,S.vndr_taxcode,S.vndr_name,s.no_chng_col,s.amtincldvat);'
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-112	
			return	@errstatus		 				
		end
		commit transaction

		set @gl_cnd=iif(@gl_cnd<>'',@gl_cnd+' or ','')+'jhsrc=''23'''
		set @ar_cnd=iif(@ar_cnd<>'',@ar_cnd+' or ','')+'hd_trxsrc=''23'''
		set @ap_cnd=iif(@ap_cnd<>'',@ap_cnd+' or ','')+'hd_trxsrc=''23'''
--
------------------------ For Tax system 
--
		set @gl_cnd=iif(@gl_cnd<>'',@gl_cnd+' or ','')+'jhsrc=''31'''
		set @ar_cnd=iif(@ar_cnd<>'',@ar_cnd+' or ','')+'hd_trxsrc=''31'''
		set @ap_cnd=iif(@ap_cnd<>'',@ap_cnd+' or ','')+'hd_trxsrc=''31'''
	end
----  Process Sthdr & Stdtl Table   
	if @ok_st=1 or @ok_sl=1 or @ok_pu=1
	begin
	    if  @ok_st=1
		begin
			set @Item_cnd=iif(@Item_cnd<>'',@Item_cnd+' or ','')+'a.src=''03'''
			set @st_cnd=iif(@st_cnd<>'',@st_cnd+' or ','')+'a.src=''03'''
		end
		set @sqlmsg='merge sthdr as t 
		using (select * from '+@dbc+'sthdr a with (NOLOCK) where posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
		+' and trdate between '+@lfdate+' and '+@ltdate
		+' and ('+@st_cnd+')) as s
		on t.branch=s.branch and t.trtype=s.trtype and t.ref=s.ref
		when not matched then
		insert ( branch,trtype,ref,trdate,text,amnttl,costttl,sysdate,src,released,posted
         ,fcy,fcyrate,whno,entries,lastupdt,towhno,modified,rcvdtrn,custno,usrid
         ,brsupp,tobrno,brxref,glref,isbrtrx,asmtype,repost,items_rcvd,trx_printed)
		values (S.branch,S.trtype,S.ref,S.trdate,S.text,S.amnttl,S.costttl,S.sysdate,S.src,S.released,0
         ,S.fcy,S.fcyrate,S.whno,S.entries,S.lastupdt,S.towhno,S.modified,S.rcvdtrn,S.custno,S.usrid
         ,S.brsupp,S.tobrno,S.brxref,S.glref,S.isbrtrx,S.asmtype,S.repost,S.items_rcvd,S.trx_printed);'

		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-11	
			return @errstatus			 				
		end
		
		set @sqlmsg='merge stdtl as t 
		using (select b.* from '+@dbc+'sthdr a with (NOLOCK) inner join '+@dbc+'stdtl b with (NOLOCK)
		on a.branch=b.branch and a.trtype=b.trtype and a.ref=b.ref
			   where posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
			 +'  and a.trdate between '+@lfdate+' and '+@ltdate+' and ('+@st_cnd+')) as s
		on t.branch=s.branch and t.trtype=s.trtype and t.ref=s.ref and t.folio=s.folio
		when not matched then
		insert ( itemno,unicode,branch,trtype,qty,fqty,whno,binno,lcost,trdate,ref,sysdate
         ,src,lprice,fcost,fprice,expdate,towhno,tobinno,barcode,cmbkey,discpc
         ,pack,shdpk,shdqty,folio,rplct_post)
		values (S.itemno,S.unicode,S.branch,S.trtype,S.qty,S.fqty,S.whno,S.binno,S.lcost,S.trdate,S.ref,S.sysdate
         ,S.src,S.lprice,S.fcost,S.fprice,S.expdate,S.towhno,S.tobinno,S.barcode,S.cmbkey,S.discpc
         ,S.pack,S.shdpk,S.shdqty,S.folio,0);'

		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-12	
			return	@errstatus		 				
		end
		commit transaction
		
	end
----- Cheque Processing 
    if @ok_chq=1
	begin
	    set @sqlmsg='merge bktransx as t 
		using (select * from '+@dbc+'bktransx  with (NOLOCK) where posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
		+'  and trdate between '+@lfdate+' and '+@ltdate+') as s
		on t.company=s.company and t.trtype=s.trtype and t.ref=s.ref
        when not matched then
		insert (company,trtype,ref,cucode,glact,bkact,ctype,amt,trdate,chkdate,chkno
          ,bank,rcvname,bending,xdesc,canceled,actcode,dtentry,fcy,posted
          ,released,printed,trxsrc,actno,cstname,chqwthd,chkdesc,fcyrate
          ,isit_opst,opst_fcy,opst_val,rcvdtrn,hide_jv,rcvno,bcode,bal,stk
          ,dscac,dscamt,dscptg,dscdesc,ptodate,mgmtcnfrm,mgmtnote) 
		values (S.company,S.trtype,S.ref,S.cucode,S.glact,S.bkact,S.ctype,S.amt,S.trdate,S.chkdate,S.chkno
          ,S.bank,S.rcvname,S.bending,S.xdesc,S.canceled,S.actcode,S.dtentry,S.fcy,S.posted
          ,S.released,S.printed,S.trxsrc,S.actno,S.cstname,S.chqwthd,S.chkdesc,S.fcyrate
          ,S.isit_opst,S.opst_fcy,S.opst_val,S.rcvdtrn,S.hide_jv,S.rcvno,S.bcode,S.bal,S.stk
          ,S.dscac,S.dscamt,S.dscptg,S.dscdesc,S.ptodate,S.mgmtcnfrm,S.mgmtnote);' 

		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-13
			return @errstatus
		end
		commit transaction
		
		set @gl_cnd=iif(@gl_cnd<>'',@gl_cnd+' or ','')+'jhsrc=''10'''
		set @ar_cnd=iif(@ar_cnd<>'',@ar_cnd+' or ','')+'hd_trxsrc=''10'''
		set @ap_cnd=iif(@ap_cnd<>'',@ap_cnd+' or ','')+'hd_trxsrc=''10'''
	end
----- AR Processing 
    if @ok_ar=1 or @ar_cnd<>''
	begin
	    if @ok_ar=1
		begin
			set @gl_cnd=iif(@gl_cnd<>'',@gl_cnd+' or ','')+'jhsrc=''02'''
			set @ar_cnd=iif(@ar_cnd<>'',@ar_cnd+' or ','')+'hd_trxsrc=''02'''
		end
	    set @sqlmsg='merge arhdr as t 
		using (select * from '+@dbc+'arhdr with (NOLOCK) where hd_posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
		+' and hd_date between '+@lfdate+' and '+@ltdate+' and ('+@ar_cnd+')) as s
		on t.hd_company=s.hd_company and t.hd_type=s.hd_type and t.hd_ref=s.hd_ref
		when not matched then
		insert ( hd_company,hd_type,hd_ref,hd_date,hd_fcy,hd_ftotal,hd_fcyrate,hd_ltotal,hd_cucode
             ,hd_desc1,hd_ser,hd_rlsd,hd_posted,hd_trxsrc,hd_sysdate,hd_lcnet,hd_fcnet
             ,hd_lccnet,hd_fccnet,isit_opst,opst_val,opst_fcy,lastupdt,modified,rcvdtrn
             ,usrid,clcode,clcmnd,dscamt,payinv,discountedBill) 
		values (S.hd_company,S.hd_type,S.hd_ref,S.hd_date,S.hd_fcy,S.hd_ftotal,S.hd_fcyrate,S.hd_ltotal,S.hd_cucode
             ,S.hd_desc1,S.hd_ser,S.hd_rlsd,0,S.hd_trxsrc,S.hd_sysdate,S.hd_lcnet,S.hd_fcnet
             ,S.hd_lccnet,S.hd_fccnet,S.isit_opst,S.opst_val,S.opst_fcy,S.lastupdt,S.modified,S.rcvdtrn
             ,S.usrid,S.clcode,S.clcmnd,S.dscamt,S.payinv,s.discountedBill);'

		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-14
			return @errstatus
		end
		
	    set @sqlmsg='merge ardtl as t 
		using (select b.* from '+@dbc+'arhdr a with (NOLOCK) inner join '+@dbc+'ardtl b
		on  a.hd_company=b.dt_company and a.hd_type=b.dt_type and a.hd_ref=b.dt_ref
		where hd_posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
		+' and hd_date between '+@lfdate+' and '+@ltdate+' and ('+@ar_cnd+')) as s
		on t.dt_company=s.dt_company and t.dt_type=s.dt_type and t.dt_ref=s.dt_ref and t.dt_folio=s.dt_folio
		when not matched then
		insert (dt_company,dt_type,dt_ref,dt_date,dt_lcamt,dt_paidamt,dt_discamt,dt_cucode
            ,dt_fcy,dt_trxsrc,dt_fcamt,dt_fpydamt,dt_fdscamt,dt_lcaloc,dt_fcaloc
            ,dt_aloctd,dt_pdinv,dt_duedate,dt_desc,dt_chkno,dt_chkdate,dt_chkbnk
            ,dt_dbcr,dt_ackey,dt_folio,dt_rcvno,dt_lstdate,tdscdays,tdscpcs
            ,match,rplct_post) 
		values(S.dt_company,S.dt_type,S.dt_ref,S.dt_date,S.dt_lcamt,S.dt_paidamt,S.dt_discamt,S.dt_cucode
            ,S.dt_fcy,S.dt_trxsrc,S.dt_fcamt,S.dt_fpydamt,S.dt_fdscamt,S.dt_lcaloc,S.dt_fcaloc
            ,S.dt_aloctd,S.dt_pdinv,S.dt_duedate,S.dt_desc,S.dt_chkno,S.dt_chkdate,S.dt_chkbnk
            ,S.dt_dbcr,S.dt_ackey,S.dt_folio,S.dt_rcvno,S.dt_lstdate,S.tdscdays,S.tdscpcs
            ,S.match,0);'

		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-16
			return @errstatus
		end
		
	    set @sqlmsg='merge customer as t 
		using (select distinct c.* from '+@dbc+'arhdr a with (NOLOCK) inner join '+@dbc+'ardtl b with (NOLOCK)
		inner join '+@dbc+'customer c with (NOLOCK)
		on b.dt_company=c.cu_company and b.dt_cucode=c.cu_code and b.dt_fcy=c.cf_fcy
		on  a.hd_company=b.dt_company and a.hd_type=b.dt_type and a.hd_ref=b.dt_ref
		where dt_cucode<>'''' and hd_posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
		+' and hd_date between '+@lfdate+' and '+@ltdate+' and ('+@ar_cnd+')) as s
		on t.cu_company=s.cu_company and t.cu_code=s.cu_code and t.cf_fcy=s.cf_fcy
		when not matched then
		insert ( cu_name,cu_company,cu_code,cu_class,cu_addrs,cu_tel,cu_fax,cu_tlx,cu_email
          ,cu_cntactp,cu_title,cu_crlmt,cu_pymnt,cu_status,cu_opnbal,cu_curbal
          ,cf_fcy,cf_opnfcy,cf_curfcy,cu_xrf,cu_alwcr,cu_ctlser,lastupdt
          ,cu_lcaloc,cu_fcaloc,cu_instlmnt,cu_instldays,cu_install,modified
          ,cmncode,cu_lname,cu_city,cu_type,cu_laddrs,cu_carrier,cu_mobile
		  ,section,cu_sendsms,cu_onlycsh,clnt_taxcode,taxFree,cu_kind,exduplimit
          ,individual_clnt,cu_invdsc,slcode,lst_inv_excd_duedate,usrid,usridchg,Added_date,ok_free,ok_no_pay,ok_no_down_payment)
		values(S.cu_name,S.cu_company,S.cu_code,S.cu_class,S.cu_addrs,S.cu_tel,S.cu_fax,S.cu_tlx,S.cu_email
          ,S.cu_cntactp,S.cu_title,S.cu_crlmt,S.cu_pymnt,S.cu_status,S.cu_opnbal,S.cu_curbal
          ,S.cf_fcy,S.cf_opnfcy,S.cf_curfcy,S.cu_xrf,S.cu_alwcr,S.cu_ctlser,S.lastupdt
          ,S.cu_lcaloc,S.cu_fcaloc,S.cu_instlmnt,S.cu_instldays,S.cu_install,S.modified
          ,S.cmncode,S.cu_lname,S.cu_city,S.cu_type,S.cu_laddrs,S.cu_carrier,S.cu_mobile
		  ,S.section,S.cu_sendsms,S.cu_onlycsh,S.clnt_taxcode,S.taxFree,S.cu_kind,S.exduplimit
          ,S.individual_clnt,s.cu_invdsc,s.slcode,s.lst_inv_excd_duedate,s.usrid,s.usridchg,s.Added_date,s.ok_free,s.ok_no_pay,s.ok_no_down_payment);'

		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-18
			return @errstatus
		end
		
		commit transaction
	end
	

	------
set @sqlmsg='merge customer_ei as t 
		using (select distinct c.* from '+@dbc+'arhdr a with (NOLOCK) inner join '+@dbc+'ardtl b with (NOLOCK)
		inner join '+@dbc+'customer_ei c with (NOLOCK)
		on b.dt_company=c.cu_company and b.dt_cucode=c.cu_code and b.dt_fcy=c.cf_fcy
		on  a.hd_company=b.dt_company and a.hd_type=b.dt_type and a.hd_ref=b.dt_ref
		where dt_cucode<>'''' and hd_posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
		+' and hd_date between '+@lfdate+' and '+@ltdate+' and ('+@ar_cnd+')) as s
		on t.cu_company=s.cu_company and t.cu_code=s.cu_code and t.cf_fcy=s.cf_fcy
		when not matched then
		insert ( cu_company,cu_code,cf_fcy,district,district_l,city_text,city_text_l,country_code,postal_code,Other_id_SchemeID
            ,bldg_no,bldg_no_l,street_name,street_name_l,area_name,area_name_l,extra_address_no,extra_address_no_l
            ,street_name2,street_name2_l,Group_VAT_ID,other_scheme_type)
		values(s.cu_company,s.cu_code,s.cf_fcy,s.district,s.district_l,s.city_text,s.city_text_l,s.country_code,s.postal_code,s.Other_id_SchemeID
            ,s.bldg_no,s.bldg_no_l,s.street_name,s.street_name_l,s.area_name,s.area_name_l,s.extra_address_no,s.extra_address_no_l
            ,s.street_name2,s.street_name2_l,s.Group_VAT_ID,s.other_scheme_type);'

		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-18
			return @errstatus
		end
------

----- AP Processing 

    if @ok_ap=1 or @ap_cnd<>''
	begin
	    if @ok_ap=1
		begin
			set @gl_cnd=iif(@gl_cnd<>'',@gl_cnd+' or ','')+'jhsrc=''06'''
			set @ap_cnd=iif(@ap_cnd<>'',@ap_cnd+' or ','')+'hd_trxsrc=''06'''
		end
	    set @sqlmsg='merge aphdr as t 
		using (select * from '+@dbc+'aphdr with (NOLOCK) where hd_posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
		+' and hd_date between '+@lfdate+' and '+@ltdate+' and ('+@ap_cnd+')) as s
		on t.hd_company=s.hd_company and t.hd_type=s.hd_type and t.hd_ref=s.hd_ref
		when not matched then
		insert (hd_company,hd_type,hd_ref,hd_date,hd_fcy,hd_ftotal,hd_fcyrate,hd_ltotal,hd_cucode
             ,hd_desc1,hd_ser,hd_rlsd,hd_posted,hd_trxsrc,hd_sysdate,hd_lcnet,hd_fcnet
             ,hd_lccnet,hd_fccnet,isit_opst,opst_val,opst_fcy,lastupdt,modified,rcvdtrn
             ,usrid,clcode,clcmnd,dscamt,payinv,bankref)
		values (S.hd_company,S.hd_type,S.hd_ref,S.hd_date,S.hd_fcy,S.hd_ftotal,S.hd_fcyrate,S.hd_ltotal,S.hd_cucode
             ,S.hd_desc1,S.hd_ser,S.hd_rlsd,0,S.hd_trxsrc,S.hd_sysdate,S.hd_lcnet,S.hd_fcnet
             ,S.hd_lccnet,S.hd_fccnet,S.isit_opst,S.opst_val,S.opst_fcy,S.lastupdt,S.modified,S.rcvdtrn
             ,S.usrid,S.clcode,S.clcmnd,S.dscamt,S.payinv,S.bankref);'

		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-20
			return @errstatus
		end
		
	    set @sqlmsg='merge apdtl as t 
		using (select b.* from '+@dbc+'aphdr a with (NOLOCK) inner join '+@dbc+'apdtl b with (NOLOCK)
		on  a.hd_company=b.dt_company and a.hd_type=b.dt_type and a.hd_ref=b.dt_ref
		where hd_posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
		+' and hd_date between '+@lfdate+' and '+@ltdate+' and ('+@ap_cnd+')) as s
		on t.dt_company=s.dt_company and t.dt_type=s.dt_type and t.dt_ref=s.dt_ref and t.dt_folio=s.dt_folio
		when not matched then
		insert (dt_company,dt_type,dt_ref,dt_date,dt_lcamt,dt_paidamt,dt_discamt,dt_cucode,dt_fcy
             ,dt_trxsrc,dt_fcamt,dt_fpydamt,dt_fdscamt,dt_lcaloc,dt_fcaloc,dt_aloctd
             ,dt_pdinv,dt_duedate,dt_desc,dt_chkno,dt_chkdate,dt_chkbnk,dt_dbcr
             ,dt_ackey,dt_folio,dt_rcvno,dt_lstdate,tdscdays,tdscpcs,match
             ,rplct_post)
		values(S.dt_company,S.dt_type,S.dt_ref,S.dt_date,S.dt_lcamt,S.dt_paidamt,S.dt_discamt,S.dt_cucode,S.dt_fcy
             ,S.dt_trxsrc,S.dt_fcamt,S.dt_fpydamt,S.dt_fdscamt,S.dt_lcaloc,S.dt_fcaloc,S.dt_aloctd
             ,S.dt_pdinv,S.dt_duedate,S.dt_desc,S.dt_chkno,S.dt_chkdate,S.dt_chkbnk,S.dt_dbcr
             ,S.dt_ackey,S.dt_folio,S.dt_rcvno,S.dt_lstdate,S.tdscdays,S.tdscpcs,S.match
             ,0);'

		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-22
			return @errstatus
		end
		
	    set @sqlmsg='merge supplier as t 
		using (select distinct c.* from '+@dbc+'aphdr a with (NOLOCK) inner join '+@dbc+'apdtl b with (NOLOCK)
		inner join '+@dbc+'supplier c with (NOLOCK)
		on b.dt_company=c.cu_company and b.dt_cucode=c.cu_code and b.dt_fcy=c.cf_fcy
		on  a.hd_company=b.dt_company and a.hd_type=b.dt_type and a.hd_ref=b.dt_ref
		where dt_cucode<>'''' and hd_posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
		+' and hd_date between '+@lfdate+' and '+@ltdate+' and ('+@ap_cnd+')) as s
		on t.cu_company=s.cu_company and t.cu_code=s.cu_code and t.cf_fcy=s.cf_fcy
		when not matched then
		insert ( cu_name,cu_company,cu_code,cu_class,cu_addrs,cu_tel,cu_fax,cu_tlx,cu_email,cu_cntactp
          ,cu_title,cu_crlmt,cu_pymnt,cu_status,cu_opnbal,cu_curbal,cf_fcy,cf_opnfcy
          ,cf_curfcy,cu_xrf,cu_alwcr,cu_ctlser,lastupdt,cu_lcaloc,cu_fcaloc,modified
          ,cmncode,cu_lname,cu_city,cu_country,cu_laddrs,cu_mobile,cu_sendsms,rowguid
          ,whno,vndr_taxcode,taxFree,cu_kind,section,PriceIncludeVat,cu_type)
		values(S.cu_name,S.cu_company,S.cu_code,S.cu_class,S.cu_addrs,S.cu_tel,S.cu_fax,S.cu_tlx,S.cu_email,S.cu_cntactp
          ,S.cu_title,S.cu_crlmt,S.cu_pymnt,S.cu_status,S.cu_opnbal,S.cu_curbal,S.cf_fcy,S.cf_opnfcy
          ,S.cf_curfcy,S.cu_xrf,S.cu_alwcr,S.cu_ctlser,S.lastupdt,S.cu_lcaloc,S.cu_fcaloc,S.modified
          ,S.cmncode,S.cu_lname,S.cu_city,S.cu_country,S.cu_laddrs,S.cu_mobile,S.cu_sendsms,S.rowguid
          ,S.whno,S.vndr_taxcode,S.taxFree,S.cu_kind,S.section,S.PriceIncludeVat,S.cu_type);'
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-23
			return @errstatus
		end

		commit transaction
------ Sales_dh Table
		
		set @sqlmsg='merge Sales_dh as t 
		using (select * from '+@dbc+'Sales_dh with (NOLOCK) where posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
		+' and invdate between '+@lfdate+' and '+@ltdate+') as s
		on t.company=s.company and t.invtype=s.invtype and t.ref=s.ref
		when not matched then
		insert (slcenter,branch,company,invtype,ref,invdate,custno,custnm,glser,dsctype
           ,pstmode,fcy,fcyrate,duedate,invttl,invcst,invdspc,invdsvl,valafds
           ,invpaid,caser,entries,released,posted,fixrate,extamt,extser,pricetp
           ,ischeque,chkno,chkdate,lastupdt,jvgenrt,cccommsn,belowbal,fcy2,ccpayment
           ,rplsamt,pdother,slcode,prpaidamt,instldays,instflag,slcmnd,inv_printed
           ,bendit,modified,rqstorder,rqststld,carrier,rcvdtrn,usrid,address,suspend
           ,rtnref,ispurchase,stkjvno,posinv,jvdate,vat_amt_rcvd,taxfree_sales
		   ,PriceVatType,vat_percent,datetime_stamp,clnt_taxcode,clnt_kind)
		values (S.slcenter,S.branch,S.company,S.invtype,S.ref,S.invdate,S.custno,S.custnm,S.glser,S.dsctype
           ,S.pstmode,S.fcy,S.fcyrate,S.duedate,S.invttl,S.invcst,S.invdspc,S.invdsvl,S.valafds
           ,S.invpaid,S.caser,S.entries,S.released,0,S.fixrate,S.extamt,S.extser,S.pricetp
           ,S.ischeque,S.chkno,S.chkdate,S.lastupdt,S.jvgenrt,S.cccommsn,S.belowbal,S.fcy2,S.ccpayment
           ,S.rplsamt,S.pdother,S.slcode,S.prpaidamt,S.instldays,S.instflag,S.slcmnd,S.inv_printed
           ,S.bendit,S.modified,S.rqstorder,S.rqststld,S.carrier,S.rcvdtrn,S.usrid,S.address,S.suspend
           ,S.rtnref,S.ispurchase,S.stkjvno,S.posinv,S.jvdate,S.vat_amt_rcvd,S.taxfree_sales
		   ,S.PriceVatType,S.vat_percent,s.datetime_stamp,s.clnt_taxcode,s.clnt_kind);'	

		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-24
			return @errstatus
		end
		
------ Sales_dd Table

		set @sqlmsg='merge Sales_dd as t 
		using (select b.* from '+@dbc+'Sales_dh a with (NOLOCK) inner join '+@dbc+'Sales_dd b with (NOLOCK)
		on a.company=b.company and a.invtype=b.invtype and a.ref=b.ref
				where posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
			+'	and a.invdate between '+@lfdate+' and '+@ltdate+') as s
		on t.company=s.company and t.invtype=s.invtype and t.ref=s.ref and t.folio=s.folio
		when not matched then
		insert (slcenter,company,invtype,ref,invdate,itemno,unicode,qty,fqty,price,discpc
           ,cost,ds_acfm,sl_acfm,gclass,custno,fcy,barcode,imfcval,pack,pkqty
           ,shadd,shdpk,shdqty,frtqty,rtnqty,whno,cmbkey,dscqty,dscprice,rplct_post
           ,folio,whqty,nprice2,nprice3)
		values (S.slcenter,S.company,S.invtype,S.ref,S.invdate,S.itemno,S.unicode,S.qty,S.fqty,S.price,S.discpc
           ,S.cost,S.ds_acfm,S.sl_acfm,S.gclass,S.custno,S.fcy,S.barcode,S.imfcval,S.pack,S.pkqty
           ,S.shadd,S.shdpk,S.shdqty,S.frtqty,S.rtnqty,S.whno,S.cmbkey,S.dscqty,S.dscprice,0
           ,S.folio,S.whqty,S.nprice2,S.nprice3);'

		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-25
			return @errstatus
		end
        commit transaction
		
	end
----- GL Processing 
    if @ok_gl=1 or @gl_cnd<>''
	begin
		set @gl_cnd=iif(@gl_cnd<>'',@gl_cnd+' or ','')+'jhsrc=''01'''	

		set @sqlmsg='merge gljrhdr as t 
		using (select * from '+@dbc+'gljrhdr with (NOLOCK) where jhposted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
		+' and jhdate between '+@lfdate+' and '+@ltdate+' and ('+@gl_cnd+')) as s
		 on t.jhcomp=s.jhcomp and t.jhtype=s.jhtype and t.jhref=s.jhref 
		 when not matched then  
		 insert (jhcomp, jhtype, jhref, jhdate, jhtext, jhamt, jhentries, jhsrc, jhsysdate, jhcurr, jhfcflag, jhrate
		, jhreleased, jhposted, lastupdt, jhlccrttl, jhlcdbttl, jhfccrttl, jhfcdbttl, jhimgrate
		, modified, serial_no, rcvdtrn, suspend, usrid, isbrtrx, brxref, brxfrm, jhcustno, hide_jv,bankref,Vat_Percent,jhtext1)
		 values (s.jhcomp,s.jhtype,s.jhref,s.jhdate,s.jhtext,s.jhamt,s.jhentries,s.jhsrc,s.jhsysdate,s.jhcurr,s.jhfcflag,s.jhrate
		,s.jhreleased,0,s.lastupdt,s.jhlccrttl,s.jhlcdbttl,s.jhfccrttl,s.jhfcdbttl,s.jhimgrate
		,s.modified,s.serial_no,1,s.suspend,s.usrid,s.isbrtrx,s.brxref,s.brxfrm,s.jhcustno,s.hide_jv,s.bankref,s.Vat_Percent,s.jhtext1);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-7
			return @errstatus
		end
		
		set @sqlmsg='merge gljrdtl as t 
		using (select b.* from '+@dbc+'gljrhdr a with (NOLOCK) inner join '+@dbc+'gljrdtl b with (NOLOCK)
		on a.jhcomp=b.jdcomp and a.jhtype=b.jdtype and a.jhref=b.jdref
		where jhposted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
		+' and jhdate between '+@lfdate+' and '+@ltdate+' and ('+@gl_cnd+')) as s
			on t.jdcomp=s.jdcomp and t.jdtype=s.jdtype and t.jdref=s.jdref and t.jdfolio=s.jdfolio
			when not matched then 
			insert (jdcomp ,jdtype ,jdref ,jdkey ,jddate ,jdtext ,jdlcamt ,jddbcr ,
			jdfcamt ,jdcurr,jdfolio ,jdfolno ,jdsysdate ,jdsrc ,jdfc_imgval ,jdcstval ,
			cstkey ,brnno ,bracc ,brxref,match,rplct_post,taxcatId,jhcustno)
	 		values (s.jdcomp ,s.jdtype ,s.jdref ,s.jdkey ,s.jddate ,s.jdtext ,s.jdlcamt ,s.jddbcr ,
			s.jdfcamt ,s.jdcurr,s.jdfolio ,s.jdfolno ,s.jdsysdate ,s.jdsrc ,s.jdfc_imgval ,s.jdcstval ,
			s.cstkey ,s.brnno ,s.bracc ,s.brxref,s.match,0,s.taxcatId,s.jhcustno);'	

		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-8
			return @errstatus
		end

		set @sqlmsg='merge gljrcost as t 
		using
		(select c.* from gljrhdr b  with (NOLOCK) inner join '+@dbc+'gljrcost c  with (NOLOCK)
		on b.jhcomp=c.company and b.jhtype=c.jdtype and b.jhref=c.jdref
		where rcvdtrn=1 and jhdate between '+@lfdate+' and '+@ltdate+' and ('+@gl_cnd+')) as s
		on t.company=s.company and t.jdtype=s.jdtype and t.jdref=s.jdref and t.cstcode=s.cstcode and t.jdfolno=s.jdfolno
		when not matched then
		insert (company, jdtype, jdref, cstcode, jdkey, jdcurr, Xpercent, amt, jddbcr, jdfc_imgval, jdfolno, rplct_post) 
		values (s.company,s.jdtype,s.jdref,s.cstcode,s.jdkey,s.jdcurr,s.xpercent,s.amt,s.jddbcr,s.jdfc_imgval,s.jdfolno,0);'
			begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-29
			return @errstatus
		end
		commit transaction
		end
	
	
-----------------------------------		
	    set @sqlmsg='merge glchart as t 
		using (select distinct c.* from '+@dbc+'gljrhdr a with (NOLOCK) inner join '+@dbc+'gljrdtl b with (NOLOCK)
		inner join '+@dbc+'glchart c with (NOLOCK)
		on b.jdkey=c.glkey and b.jdcurr=c.glcurrency
		on a.jhcomp=b.jdcomp and a.jhtype=b.jdtype and a.jhref=b.jdref
		where  jhposted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
		+' and jhdate between '+@lfdate+' and '+@ltdate+' and ('+@gl_cnd+')) as s
		on t.glkey=s.glkey and t.glcurrency=s.glcurrency 
		when not matched then
		insert ( glname,glkey,glcomp,glcurbal,glopnbal,glopndate,glamnd,glacttyp,glgroup,glactive
         ,glpurge,accontrol,glp_lcode,glcurrency,glbal01,glbal02,glbal03,glbal04,glbal05
         ,glbal06,glbal07,glbal08,glbal09,glbal10,glbal11,glbal12,glbal13,fccurbal,fcopnbal
         ,fcbal01,fcbal02,fcbal03,fcbal04,fcbal05,fcbal06,fcbal07,fcbal08,fcbal09,fcbal10
         ,fcbal11,fcbal12,fcbal13,glsgrp,imopnbal,imcurbal,lastupdt,gleval,acprotect,pkey
         ,chkey,cashbnk,modified,gllname,section,isbracc,actlvl,glackind,rowguid)
		values (S.glname,S.glkey,S.glcomp,S.glcurbal,S.glopnbal,S.glopndate,S.glamnd,S.glacttyp,S.glgroup,S.glactive
         ,S.glpurge,S.accontrol,S.glp_lcode,S.glcurrency,S.glbal01,S.glbal02,S.glbal03,S.glbal04,S.glbal05
         ,S.glbal06,S.glbal07,S.glbal08,S.glbal09,S.glbal10,S.glbal11,S.glbal12,S.glbal13,S.fccurbal,S.fcopnbal
         ,S.fcbal01,S.fcbal02,S.fcbal03,S.fcbal04,S.fcbal05,S.fcbal06,S.fcbal07,S.fcbal08,S.fcbal09,S.fcbal10
         ,S.fcbal11,S.fcbal12,S.fcbal13,S.glsgrp,S.imopnbal,S.imcurbal,S.lastupdt,S.gleval,S.acprotect,S.pkey
         ,S.chkey,S.cashbnk,S.modified,S.gllname,S.section,S.isbracc,S.actlvl,S.glackind,S.rowguid);'

		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-28
			return @errstatus
		end
		commit transaction
		

-----  Process Stitems  
   if @Item_cnd<>''
	begin
		
		set @sqlmsg='merge stitems as t 
		using ( select distinct c.* from '+@dbc+'sthdr a with (NOLOCK) inner join '+@dbc+'stdtl b with (NOLOCK) 
		inner join '+@dbc+'stitems c with (NOLOCK)
		on b.itemno=c.itemno
		on a.branch=b.branch and a.trtype=b.trtype and a.ref=b.ref
		where posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
		+' and a.trdate between '+@lfdate+' and '+@ltdate+' and ('+@st_cnd+')) as s
		on t.itemno=s.itemno
		when  matched then
		update set t.name=s.name,t.mgroup=s.mgroup,t.sgroup=s.sgroup,t.category=s.category,t.classkey=s.classkey,
		t.sgroup3=s.sgroup3,t.sgroup4=s.sgroup4,t.country=s.country,t.splycode=s.splycode,t.msplycode=s.msplycode,
		t.vprice=s.vprice
		when not matched then
		insert (name,itemno,mgroup,sgroup,category,fcy,classkey,exdatealw,noofsbitem,modified,
		sgroup3,sgroup4,company,lname,country,season,splycode,splylcact,itemtype,prntasmitm,prmdesc,
		scndesc,cmpprcnt,dsctype,brand_id,msplycode,modelno,nosales,vprice,fix_barcode,taxtype)
		values (s.name,s.itemno,s.mgroup,s.sgroup,s.category,s.fcy,s.classkey,s.exdatealw,s.noofsbitem,s.modified,
		s.sgroup3,s.sgroup4,s.company,s.lname,s.country,s.season,s.splycode,s.splylcact,s.itemtype,s.prntasmitm,s.prmdesc,
		s.scndesc,s.cmpprcnt,s.dsctype,s.brand_id,s.msplycode,s.modelno,s.nosales,s.vprice,s.fix_barcode,s.taxtype);'

		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-30	
			return	@errstatus		 				
		end
		
	-------  Process Stunits 
		set @sqlmsg='merge stunits as t 
		using ( select distinct c.* from '+@dbc+'sthdr a with (NOLOCK) inner join '+@dbc+'stdtl b with (NOLOCK) 
		inner join '+@dbc+'Stunits c with (NOLOCK)
		on b.itemno=c.itemno and b.unicode=c.unicode
		on a.branch=b.branch and a.trtype=b.trtype and a.ref=b.ref
		where posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
		+' and a.trdate between '+@lfdate+' and '+@ltdate+' and ('+@st_cnd+')) as s
		on t.itemno=s.itemno and t.unicode=s.unicode 
        when  matched then
		update set t.lprice1=s.lprice1,t.lprice2=s.lprice2,t.lprice3=s.lprice3,t.lrcvdate=s.lrcvdate,t.lastissue=s.lastissue,
		t.maxdisc1=s.maxdisc1,t.lastupdt=s.lastupdt,t.mnmprice=s.mnmprice
		when not matched then
		insert (name,itemno,unicode,moved,openlcost,lcost,lprice1,fprice1,maxdisc1,lprice2,fprice2,maxdisc2,
		 lprice3,fprice3,maxdisc3,openfcost,fcost,lrcvdate,lastissue,openbal,curbal,rsvqty,
		 minstk,maxstk,orderlevel,leadday,Xdecimal,barcode,pack1,pkqty1,pack2,pkqty2,pack3,
		 pkqty3,company,modified,pack0,packtp,scnname,crtdate,inactive,prmcode,scncode,
		 cmbkey,mnmprice,lastupdt,modelno,splyitemno,splyinv,invprice,invqty,invpk,pp2,pp3)
		values (s.name,s.itemno,s.unicode,s.moved,s.openlcost,s.lcost,s.lprice1,s.fprice1,s.maxdisc1,s.lprice2,s.fprice2,s.maxdisc2,
		 s.lprice3,s.fprice3,s.maxdisc3,s.openfcost,s.fcost,s.lrcvdate,s.lastissue,s.openbal,s.curbal,s.rsvqty,
		 s.minstk,s.maxstk,s.orderlevel,s.leadday,s.Xdecimal,s.barcode,s.pack1,s.pkqty1,s.pack2,s.pkqty2,s.pack3,
		 s.pkqty3,s.company,s.modified,s.pack0,s.packtp,s.scnname,s.crtdate,s.inactive,s.prmcode,s.scncode,
		 s.cmbkey,s.mnmprice,s.lastupdt,s.modelno,s.splyitemno,s.splyinv,s.invprice,s.invqty,s.invpk,s.pp2,s.pp3);'
        
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-31	
			return	@errstatus		 				
		end

	-------  Process stitmphoto 
set @sqlmsg='merge stitmphoto as t 
		using ( select c.* from '+@dbc+'sthdr a with (NOLOCK) inner join '+@dbc+'stdtl b with (NOLOCK)
		inner join '+@dbc+'stitmphoto c with (NOLOCK) inner join stunits d with (NOLOCK)
		on c.itemno=d.itemno and c.unicode=d.unicode
		on b.itemno=c.itemno and b.unicode=c.unicode
		on a.branch=b.branch and a.trtype=b.trtype and a.ref=b.ref
		where posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
		+' and a.trdate between '+@lfdate+' and '+@ltdate+' and ('+@st_cnd+')) as s
		on t.itemno=s.itemno and t.unicode=s.unicode 
		when not matched then
		insert (itemno, unicode,remarks ,ipicture,ord_qty,mnimumdt,cust_pctg,is_double_width,is_price_per_length,is_accessory_stk_item,dsc_amt1,dsc_amt2,dsc_amt3,
		usrid,usrid_lstchg,onlinesales,exemption_reason_code)
		values (s.itemno, s.unicode,s.remarks ,s.ipicture,s.ord_qty,s.mnimumdt,s.cust_pctg,s.is_double_width,s.is_price_per_length,s.is_accessory_stk_item,s.dsc_amt1,
		s.dsc_amt2,s.dsc_amt3,s.usrid,s.usrid_lstchg,s.onlinesales,s.exemption_reason_code);'

		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-32	
			return	@errstatus		 				
		end
--------------------------------
set @sqlmsg='merge stitempictures as t 
		using ( select c.* from '+@dbc+'sthdr a with (NOLOCK) inner join '+@dbc+'stdtl b with (NOLOCK)
		inner join '+@dbc+'stitempictures c with (NOLOCK) inner join stunits d with (NOLOCK)
		on c.cmbkey=d.cmbkey 
		on b.cmbkey=c.cmbkey 
		on a.branch=b.branch and a.trtype=b.trtype and a.ref=b.ref
		where posted=1 '+iif(@ok_resendtrx=0,' and rcvdtrn=0 ','')
		+' and a.trdate between '+@lfdate+' and '+@ltdate+' and ('+@st_cnd+')) as s
		on t.cmbkey=s.cmbkey 
		when not matched then
		insert (cmbkey,picture_order,picture_name,default_picture,item_image)
		values (s.cmbkey,s.picture_order,s.picture_name,s.default_picture,s.item_image);'
        exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-32	
			return	@errstatus		 				
		end
		commit transaction   		
	end
	return	@errstatus
end


GO
/****** Object:  StoredProcedure [dbo].[move_data_with_no_balances]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[move_data_with_no_balances]
 @dbc nvarchar(50),
 @multibarcode bit,
 @errstatus int = 0 output
	
AS
BEGIN
	declare @sqlmsg nvarchar(max)='',
	@tbl nvarchar(50)=''
    set @errstatus=0

	---- 
	---------------------  Move ITEMS from Last year for STITEMS 
	----
	
	set @tbl=@dbc+'STITEMS as s '
	set @sqlmsg='merge STITEMS as t '
	set  @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+'on  t.itemno=s.itemno'
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+'insert values (s.name,s.itemno,s.mgroup,s.sgroup,s.category,s.fcy,s.classkey,s.exdatealw,s.noofsbitem,1, '	
	set @sqlmsg= @sqlmsg+' s.sgroup3,s.sgroup4,s.company,s.lname,s.country,s.season,s.splycode,s.splylcact,s.itemtype,s.prntasmitm,s.prmdesc,'	
	set @sqlmsg= @sqlmsg+'s.scndesc,s.cmpprcnt,s.dsctype,s.brand_id,s.msplycode,s.modelno,s.nosales,s.vprice,s.fix_barcode,s,taxtype);'	

	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end
	else commit transaction

	

	---- 
	---------------------  Move open balance from Last year for STUNITS 
	----
	set @tbl=@dbc+'stunits as s '
	set @sqlmsg='merge stunits as t '
	set  @sqlmsg= @sqlmsg+' using '+@tbl
	set  @sqlmsg= @sqlmsg+' on  t.itemno=s.itemno and t.unicode=s.unicode '
	set  @sqlmsg= @sqlmsg+' when not matched then '
	set  @sqlmsg= @sqlmsg+' insert values (s.name,s.itemno,s.unicode,0,s.lcost,s.lcost,s.lprice1,s.fprice1,s.maxdisc1,s.lprice2,s.fprice2,s.maxdisc2,'
	set  @sqlmsg= @sqlmsg+'s.lprice3,s.fprice3,s.maxdisc3,s.fcost,s.fcost,s.lrcvdate,s.lastissue,0,0,0,s.minstk,s.maxstk,'
	set  @sqlmsg= @sqlmsg+'s.orderlevel,s.leadday,s.Xdecimal,s.barcode,s.pack1,s.pkqty1,s.pack2,s.pkqty2,s.pack3,s.pkqty3,s.company,'
	set  @sqlmsg= @sqlmsg+'1,s.pack0,s.packtp,s.scnname,s.crtdate,s.inactive,s.prmcode,s.scncode,s.cmbkey,s.mnmprice,'
	set  @sqlmsg= @sqlmsg+'s.lastupdt,s.modelno,s.splyitemno,s.splyinv,s.invprice,s.invqty,s.invpk,s.pp2,s.pp3);'

		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-6
			return 
		end
		else commit transaction


	---- 
	---------------------  Move Photos from Last year for stitmphoto 
	----
	set @tbl=@dbc+'stitmphoto as s '
	set @sqlmsg='merge stitmphoto as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.itemno=s.itemno and t.unicode=s.unicode '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.itemno,s.unicode,s.remarks,s.ipicture,s.ord_qty,s.mnimumdt,s.cust_pctg);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-8
			return 
		end
		else commit transaction

---- 
	---------------------  Move records from Last year for stasmbld 
	----
	set @tbl=@dbc+'stasmbld as s '
	set @sqlmsg='merge stasmbld as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.itemno=s.itemno and t.unicode=s.unicode  and t.asmitemno=s.asmitemno and t.asmunicode=s.asmunicode  '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.itemno,s.unicode,s.asmitemno,s.asmunicode,s.cmbkey,s.qtyneeded);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-9
			return 
		end
		else commit transaction

	---- 
	---------------------  Move records from Last year for STOFFERS 
	----
	set @tbl=@dbc+'STOFFERS as s '
	set @sqlmsg='merge STOFFERS as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.barcode=s.barcode '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.itemno,s.unicode,s.barcode,s.DiscountP,s.disctype,s.MinQty,s.GivenAmt,s.StartDate,s.EndDate,s.InActive,s.lastupdt,s.max2buy,s.lprice1,s.itemgroup);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-10
			return 
		end
		else commit transaction

	---- 
	---------------------  Move records from Last year for STITEMBC 
	----
	if @multibarcode=1
	  begin
			set @tbl=@dbc+'STITEMBC as s '
			set @sqlmsg='merge STITEMBC as t '
			set @sqlmsg= @sqlmsg+' using '+@tbl
			set @sqlmsg= @sqlmsg+' on t.pbarcode=s.pbarcode '
			set @sqlmsg= @sqlmsg+' when not matched then '
			set @sqlmsg= @sqlmsg+' insert values (s.pbarcode,s.itemno,s.unicode,s.cmbkey,s.pack,s.pkqty,s.lprice1,s.weight,s.mnmprice,s.itext,s.litext,s.pkorder,s.lastrcvd,s.lprice2);'
				begin transaction
				exec sp_executesql @sqlmsg
				if @@error<>0
				begin
					rollback transaction
					set @errstatus=-11
					return 
				end
				else commit transaction
	   end

	---- 
	---------------------  Move records from Last year for stbrprice
	----

		set @tbl=@dbc+'stbrprice as s '
		set @sqlmsg='merge stbrprice as t '
		set @sqlmsg= @sqlmsg+' using '+@tbl
		set @sqlmsg= @sqlmsg+' on t.company=s.company and t.slcenter=s.slcenter and t.itemno=s.itemno and t.unicode=s.unicode '
		set @sqlmsg= @sqlmsg+' when not matched then '
		set @sqlmsg= @sqlmsg+' insert values (s.company,s.slcenter,s.itemno,s.unicode,s.lprice1,s.lprice2,s.lprice3,'
		+ 's.maxdisc1,s.maxdisc2,s.maxdisc3,s.mnmprice,s.pprice1,s.pprice2,s.pprice3,s.modelno,s.promotion,s.prm_start,s.prm_end,'
		+ 's.slsprsnt,s.fprice1,s.fprice2,s.fprice3,s.modified,s.lastupdt);'
			begin transaction
			exec sp_executesql @sqlmsg
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-12
				return 
			end
			else commit transaction
	  
	---- 
	---------------------  Move records from Last year for STCOMMISSION 
	----
	set @tbl=@dbc+'STCOMMISSION as s '
	set @sqlmsg='merge STCOMMISSION as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.itemno=s.itemno and t.unicode=s.unicode '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.itemno,s.unicode,s.commtype,s.commission,s.cmntarget,s.InActive,s.cmsn_onQty);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-13
			return 
		end
		else commit transaction
	---- 
	---------------------  Move records from Last year for stitemrp 
	----
	set @tbl=@dbc+'stitemrp as s '
	set @sqlmsg='merge stitemrp as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.itemno=s.itemno and t.unicode=s.unicode  and t.rplitemno=s.rplitemno and t.rplunicode=s.rplunicode  '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.itemno,s.unicode,s.rplitemno,s.rplunicode,s.cmbkey,s.rplorder,s.lastupdt);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-14
			return 
		end
		else commit transaction
	---- 
	---------------------  Move records from Last year for stqtybc 
	----
	set @tbl=@dbc+'stqtybc as s '
	set @sqlmsg='merge stqtybc as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.barcode=s.barcode '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.barcode,s.cmbkey,s.lastupdt);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-15
			return 
		end
		else commit transaction
	---- 
	---------------------  Move records from Last year for stcrtpuinv 
	----
	set @tbl=@dbc+'stcrtpuinv as s '
	set @sqlmsg='merge stcrtpuinv as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.branch=s.branch and t.splycode=s.splycode and t.fcy=s.fcy and t.splyinv=s.splyinv and t.itemno=s.itemno '
	+ ' and t.unicode=s.unicode'
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert (branch, splycode, fcy, splyinv, itemno, unicode, dbxyr, idate, lastupdt, rplct_post,slcode)
	values (s.branch,s.splycode,s.fcy,s.splyinv,s.itemno,s.unicode,s.dbxyr,s.idate,s.lastupdt,s.rplct_post,s.slcode);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-16
			return 
		end
		else commit transaction
	---- 
	---------------------  Move records from Last year for stwhous
	----
	set @tbl=@dbc+'stwhous as s '
	set @sqlmsg='merge stwhous as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.whno=s.whno '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert (name, whno, branch, manager, phone, address, lastupdt, srwhs, modified, lname, fax,
	 prnt_fsh, ac_end_prd, cstcode, no_autosales)
	 values (s.name,s.whno,s.branch,s.manager,s.phone,s.address,s.lastupdt,s.srwhs,s.modified,
	        s.lname,s.fax,s.prnt_fsh,s.ac_end_prd,s.cstcode, s.no_autosales);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-17
			return 
		end
		else commit transaction
	---- 
	---------------------  Move records from Last year for stclass
	----
	set @tbl=@dbc+'stclass as s '
	set @sqlmsg='merge stclass as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.cmbkey=s.cmbkey '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.name,s.cmbkey,s.mgroup,s.sgroup,s.category,s.sercsh,s.sercrd,s.serrch,s.serrcr,
	        s.serdsc,s.serpcsh,s.serpcrd,s.serprch,s.serprcr,s.serpdsc,s.sgroup3,s.sgroup4,s.modified,s.pkey,s.chkey,
			s.lname,s.lastupdt);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-18
			return 
		end
		else commit transaction
    ---- 
	---------------------  Move records from Last year for stprice
	----
	set @tbl=@dbc+'stprice as s '
	set @sqlmsg='merge stprice as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.code=s.code '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.name,s.code,s.disc,s.lprice,s.fprice,s.minsal,s.maxsal,s.modified,s.lname,
			s.lastupdt);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-19
			return 
		end
		else commit transaction
	---- 
	---------------------  Move records from Last year for stbranch
	----
	set @tbl=@dbc+'stbranch as s '
	set @sqlmsg='merge stbranch as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.brnno=s.brnno '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert (name, brnno, govrn, city, area, cmbkey, company, cashser, modified,
			bcserial, jv_01, jv_02, jv_03, jv_04, jv_05, jv_06, jv_07, jv_08, jv_09, jv_10, jv_11, jv_12,
			jv_13, jv_14, jv_18, jv_19, jv_20, jv_21, jv_22, 
			jv_23, jv_24, jv_26, jv_27, jv_28, jv_30, jv_31, jv_32, jv_33, jv_34, calgl, calar, calap,
			calst, srdiff, lname, lastupdt, jv_45, stkxtoser, stkxfmser, baddress, lbaddress, phone, fax,
			jv_17, jv_16, jv_46, dscalwser, 
			dscernser, jv_101, manualser, smsdispname, smsuser, smsfooter, rebate_act,pricetp,rebate_loss)
	values (s.name,s.brnno,s.govrn,s.city,s.area,s.cmbkey,s.company,s.cashser,s.modified,
	        s.bcserial,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
			s.srdiff,s.lname,s.lastupdt,1,s.stkxtoser,s.stkxfmser,s.baddress,s.lbaddress,s.phone,s.fax,1,1,1,
			s.dscalwser,s.dscernser,1,s.manualser,s.smsdispname,s.smsuser,s.smsfooter,s.rebate_act,s.pricetp,s.rebate_loss);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-20
			return 
		end
		else commit transaction
   ---- 
	---------------------  Move records from Last year for starea
	----
	set @tbl=@dbc+'starea as s '
	set @sqlmsg='merge starea as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.cmbkey=s.cmbkey '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.name,s.cmbkey,s.govrn,s.city,s.region,s.modified,s.lname,s.lastupdt,s.pkey,
			s.chkey);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-21
			return 
		end
		else commit transaction
  ---- 
	---------------------  Move records from Last year for stbrand
	----
	set @tbl=@dbc+'stbrand as s '
	set @sqlmsg='merge stbrand as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.brand_id=s.brand_id '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.brand_id,s.name,s.lname);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-22
			return 
		end
		else commit transaction

   ---- 
	---------------------  Move records from Last year for SYSUSE
	----
	set @tbl=@dbc+'sysuse as s '
	set @sqlmsg='merge sysuse as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.username=s.username '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert (username, formkey, formsel, formname, password, fullname, showcost, acssdisc,
		chgprice, acssfqty, undrcost, undrmin, belowbal, grp, company, uchgpas, shwacprtct, useprice1, useprice2, 
		useprice3, maxdsc, maxfqty, currate, usrbrn, msuser, uspright, uswhalw, uscntralw, usdptalw,
		uslatin, usslcsh, usslcrd, usslrcsh, usslrcrd, uspucsh, uspucrd, uspurcsh, uspurcrd, usjv,
		usrcv, usiss, uschqrcv, 
		uschqiss, ustrnsin, ustrnsout, usbnkin, uscredit, usdebit, ussuspend, actallow, openallow, 
		cstallow, editothers, suspend, usalwchgprs, dsplyothers, chgperiod, chgtdate, alwprntrpt, printinv,
		printtrx, printbarcode, onlinepost, showitmcst, usmagnetic, sendsms, usslprofit, posuser,
		inv_form_no, ushide_jv, uschdlcshinv, uschdlcshrcv, uschdlchqrcv, usshowprofit, goblwmnmp,
		usfpalw, usfpimage, mobileuser, confirmPurchase, noovrdrft, onlyactrmt, confirmbr, passwordPDA,
		confirmtrnsfr, nopriceblwcos,mobilNo,OTP,web_rights,mgmtcnfrm,NorgstrNoSl)
	values (s.username,s.formkey,s.formsel,s.formname,s.password,s.fullname,s.showcost,s.acssdisc
		,s.chgprice,s.acssfqty,s.undrcost,s.undrmin,s.belowbal,s.grp,s.company,s.uchgpas,s.shwacprtct
		,s.useprice1,s.useprice2,s.useprice3,s.maxdsc,s.maxfqty,s.currate,s.usrbrn,s.msuser,s.uspright
		,s.uswhalw,s.uscntralw,s.usdptalw,s.uslatin,s.usslcsh,s.usslcrd,s.usslrcsh,s.usslrcrd
		,s.uspucsh,s.uspucrd,s.uspurcsh,s.uspurcrd,s.usjv,s.usrcv,s.usiss,s.uschqrcv,s.uschqiss
		,s.ustrnsin,s.ustrnsout,s.usbnkin,s.uscredit,s.usdebit,s.ussuspend,s.actallow,s.openallow
		,s.cstallow,s.editothers,s.suspend,s.usalwchgprs,s.dsplyothers,s.chgperiod,s.chgtdate
		,s.alwprntrpt,s.printinv,s.printtrx,s.printbarcode,s.onlinepost,s.showitmcst
		,s.usmagnetic,s.sendsms,s.usslprofit,s.posuser,s.inv_form_no,s.ushide_jv,s.uschdlcshinv
		,s.uschdlcshrcv,s.uschdlchqrcv,s.usshowprofit,s.goblwmnmp,s.usfpalw,s.usfpimage,
		s.mobileuser, s.confirmPurchase, s.noovrdrft, s.onlyactrmt, s.confirmbr, s.passwordPDA,
		s.confirmtrnsfr, s.nopriceblwcost,s.mobilNo,s.OTP,s.web_rights,s.mgmtcnfrm,s.NorgstrNoSl);'
	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-22
		return 
	end
	else commit transaction	
end














GO
/****** Object:  StoredProcedure [dbo].[move_items_wzero_bal_fm_last_year_4_br_wh]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[move_items_wzero_bal_fm_last_year_4_br_wh]
 @dbc nvarchar(50),
 @multibarcode bit,
 @errstatus int = 0 output
	
AS
BEGIN
	declare @sqlmsg nvarchar(max)='',
	@tbl nvarchar(50)=''
    set @errstatus=0

	---- 
	---------------------  Move ITEMS from Last year for STITEMS 
	----
	
	set @tbl=@dbc+'STITEMS as s '
	set @sqlmsg='merge STITEMS as t '
	set  @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+'on  t.itemno=s.itemno'
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+'insert values (s.name,s.itemno,s.mgroup,s.sgroup,s.category,s.fcy,s.classkey,s.exdatealw,s.noofsbitem,1, '	
	set @sqlmsg= @sqlmsg+' s.sgroup3,s.sgroup4,s.company,s.lname,s.country,s.season,s.splycode,s.splylcact,s.itemtype,s.prntasmitm,s.prmdesc,'	
	set @sqlmsg= @sqlmsg+'s.scndesc,s.cmpprcnt,s.dsctype,s.brand_id,s.msplycode,s.modelno,s.nosales,s.vprice,s.fix_barcode,s.taxtype,s.taxfree);'	

	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end
	else commit transaction

	

	---- 
	---------------------  Move open balance from Last year for STUNITS 
	----
	set @tbl=@dbc+'stunits as s '
	set @sqlmsg='merge stunits as t '
	set  @sqlmsg= @sqlmsg+' using '+@tbl
	set  @sqlmsg= @sqlmsg+' on  t.itemno=s.itemno and t.unicode=s.unicode '
	set  @sqlmsg= @sqlmsg+' when not matched then '
	set  @sqlmsg= @sqlmsg+' insert values (s.name,s.itemno,s.unicode,0,s.lcost,s.lcost,s.lprice1,s.fprice1,s.maxdisc1,s.lprice2,s.fprice2,s.maxdisc2,'
	set  @sqlmsg= @sqlmsg+'s.lprice3,s.fprice3,s.maxdisc3,s.fcost,s.fcost,s.lrcvdate,s.lastissue,0,0,0,s.minstk,s.maxstk,'
	set  @sqlmsg= @sqlmsg+'s.orderlevel,s.leadday,s.Xdecimal,s.barcode,s.pack1,s.pkqty1,s.pack2,s.pkqty2,s.pack3,s.pkqty3,s.company,'
	set  @sqlmsg= @sqlmsg+'1,s.pack0,s.packtp,s.scnname,s.crtdate,s.inactive,s.prmcode,s.scncode,s.cmbkey,s.mnmprice,'
	set  @sqlmsg= @sqlmsg+'s.lastupdt,s.modelno,s.splyitemno,s.splyinv,s.invprice,s.invqty,s.invpk,s.pp2,s.pp3);'

		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-6
			return 
		end
		else commit transaction


	---- 
	---------------------  Move Photos from Last year for stitmphoto 
	----
	set @tbl=@dbc+'stitmphoto as s '
	set @sqlmsg='merge stitmphoto as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.itemno=s.itemno and t.unicode=s.unicode '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.itemno,s.unicode,s.remarks,s.ipicture,s.ord_qty,s.mnimumdt,s.cust_pctg);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-8
			return 
		end
		else commit transaction

---- 
	---------------------  Move records from Last year for stasmbld 
	----
	set @tbl=@dbc+'stasmbld as s '
	set @sqlmsg='merge stasmbld as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.itemno=s.itemno and t.unicode=s.unicode  and t.asmitemno=s.asmitemno and t.asmunicode=s.asmunicode  '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.itemno,s.unicode,s.asmitemno,s.asmunicode,s.cmbkey,s.qtyneeded);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-9
			return 
		end
		else commit transaction

	---- 
	---------------------  Move records from Last year for STOFFERS 
	----
	set @tbl=@dbc+'STOFFERS as s '
	set @sqlmsg='merge STOFFERS as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.barcode=s.barcode '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.itemno,s.unicode,s.barcode,s.DiscountP,s.disctype,s.MinQty,s.GivenAmt,s.StartDate,s.EndDate,s.InActive,s.lastupdt,s.max2buy,s.lprice1,s.itemgroup);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-10
			return 
		end
		else commit transaction

	---- 
	---------------------  Move records from Last year for STITEMBC 
	----
	if @multibarcode=1
	  begin
			set @tbl=@dbc+'STITEMBC as s '
			set @sqlmsg='merge STITEMBC as t '
			set @sqlmsg= @sqlmsg+' using '+@tbl
			set @sqlmsg= @sqlmsg+' on t.pbarcode=s.pbarcode '
			set @sqlmsg= @sqlmsg+' when not matched then '
			set @sqlmsg= @sqlmsg+' insert values (s.pbarcode,s.itemno,s.unicode,s.cmbkey,s.pack,s.pkqty,s.lprice1,s.weight,s.mnmprice,s.itext,s.litext,s.pkorder,s.lastrcvd,s.lprice2);'
				begin transaction
				exec sp_executesql @sqlmsg
				if @@error<>0
				begin
					rollback transaction
					set @errstatus=-11
					return 
				end
				else commit transaction
	   end

	---- 
	---------------------  Move records from Last year for stbrprice
	----

		set @tbl=@dbc+'stbrprice as s '
		set @sqlmsg='merge stbrprice as t '
		set @sqlmsg= @sqlmsg+' using '+@tbl
		set @sqlmsg= @sqlmsg+' on t.company=s.company and t.slcenter=s.slcenter and t.itemno=s.itemno and t.unicode=s.unicode '
		set @sqlmsg= @sqlmsg+' when not matched then '
		set @sqlmsg= @sqlmsg+' insert values (s.company,s.slcenter,s.itemno,s.unicode,s.lprice1,s.lprice2,s.lprice3,'
		+ 's.maxdisc1,s.maxdisc2,s.maxdisc3,s.mnmprice,s.pprice1,s.pprice2,s.pprice3,s.modelno,s.promotion,s.prm_start,s.prm_end,'
		+ 's.slsprsnt,s.fprice1,s.fprice2,s.fprice3,s.modified,s.lastupdt);'
			begin transaction
			exec sp_executesql @sqlmsg
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-12
				return 
			end
			else commit transaction
	  
	---- 
	---------------------  Move records from Last year for STCOMMISSION 
	----
	set @tbl=@dbc+'STCOMMISSION as s '
	set @sqlmsg='merge STCOMMISSION as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.itemno=s.itemno and t.unicode=s.unicode '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.itemno,s.unicode,s.commtype,s.commission,s.cmntarget,s.InActive,s.cmsn_onQty);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-13
			return 
		end
		else commit transaction
	---- 
	---------------------  Move records from Last year for stitemrp 
	----
	set @tbl=@dbc+'stitemrp as s '
	set @sqlmsg='merge stitemrp as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.itemno=s.itemno and t.unicode=s.unicode  and t.rplitemno=s.rplitemno and t.rplunicode=s.rplunicode  '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.itemno,s.unicode,s.rplitemno,s.rplunicode,s.cmbkey,s.rplorder,s.lastupdt);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-14
			return 
		end
		else commit transaction
end






GO
/****** Object:  StoredProcedure [dbo].[move_stk_bal_fm_last_year_4_br_wh]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[move_stk_bal_fm_last_year_4_br_wh]
 @dbc nvarchar(50),
 @multibarcode bit,
 @cmp char(2),
 @whno char(2),
 @errstatus int = 0 output
	
AS
BEGIN
	declare @sqlmsg nvarchar(max)='',
	@tbl nvarchar(50)='',
	@stbinsjoin nvarchar(100)='',
	@cmdcndn nvarchar(100)=''
	set @cmdcndn=' where b.branch='+@cmp+iif(@whno<>'',' and b.whno='+@whno,'')
    set @stbinsjoin=' inner join '+@dbc+'stbins b on a.itemno=b.itemno and a.unicode=b.unicode '
    set @errstatus=0
--
----------------------  This part used to erase the old openning balanes for STBINS & STUNITS
--
		
	begin transaction
	IF @whno<>''
	begin
		update stunits set curbal=curbal-isnull(lopenbal,0),
		openlcost=iif(openbal-isnull(lopenbal,0)<>0,((openbal*openlcost)-isnull(llcost,0))/(openbal-isnull(lopenbal,0)),openlcost),
		openfcost=iif(openbal-isnull(lopenbal,0)<>0,((openbal*openfcost)-isnull(ffcost,0))/(openbal-isnull(lopenbal,0)),openfcost),
		openbal=openbal-isnull(lopenbal,0)
		from stunits as s
		join 
		(select itemno,unicode ,lopenbal=sum(openbal),llcost=sum(openbal*openlcost),ffcost=sum(openbal*openfcost) 
		from stbins where branch=@cmp and whno=@whno group by itemno,unicode) b
		on s.itemno=b.itemno and s.unicode=b.unicode
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-1
			return --@errstatus
		end
		
		update stbins set qty=qty-openbal,openbal=0,openlcost=0,openfcost=0 where branch=@cmp and whno=@whno
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-2
			return --@errstatus
		end
	end
	else
	begin
		update stunits set curbal=curbal-isnull(lopenbal,0),
		openlcost=iif(openbal-isnull(lopenbal,0)<>0,((openbal*openlcost)-isnull(llcost,0))/(openbal-isnull(lopenbal,0)),openlcost),
		openfcost=iif(openbal-isnull(lopenbal,0)<>0,((openbal*openfcost)-isnull(ffcost,0))/(openbal-isnull(lopenbal,0)),openfcost),
		openbal=openbal-isnull(lopenbal,0)
		from stunits as s
		join 
		(select itemno,unicode ,lopenbal=sum(openbal),llcost=sum(openbal*openlcost),ffcost=sum(openbal*openfcost) 
		from stbins where branch=@cmp  group by itemno,unicode) b
		on s.itemno=b.itemno and s.unicode=b.unicode
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-3
			return --@errstatus
		end
		
		update stbins set qty=qty-openbal,openbal=0,openlcost=0,openfcost=0 where branch=@cmp 
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-4
			return --@errstatus
		end
	end
	commit transaction
	---- 
	---------------------  Move ITEMS from Last year for STITEMS 
	----
	set @errstatus=0

	set @sqlmsg='merge STITEMS as t '
	set  @sqlmsg= @sqlmsg+' using '
	+'(select distinct a.* from '+@dbc+'stitems a inner join '+@dbc+'stbins b on a.itemno=b.itemno where b.branch='+@cmp
	+iif(@whno<>'',' and whno='+@whno,'')+') as s '
	set @sqlmsg= @sqlmsg+'on  t.itemno=s.itemno'
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+'insert values (s.name,s.itemno,s.mgroup,s.sgroup,s.category,s.fcy,s.classkey,s.exdatealw,s.noofsbitem,1, '	
	set @sqlmsg= @sqlmsg+' s.sgroup3,s.sgroup4,s.company,s.lname,s.country,s.season,s.splycode,s.splylcact,s.itemtype,s.prntasmitm,s.prmdesc,'	
	set @sqlmsg= @sqlmsg+'s.scndesc,s.cmpprcnt,s.dsctype,s.brand_id,s.msplycode,s.modelno,s.nosales,s.vprice,s.fix_barcode,s.taxtype,s.taxfree);'	

	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end
	else commit transaction

	

	---- 
	---------------------  Move open items from Last year for STUNITS 
	----
	set @sqlmsg='merge stunits as t '
	set  @sqlmsg= @sqlmsg+' using '
	+'(select distinct a.* from '+@dbc+'stunits a '
	+' inner join '+@dbc+'stbins b on a.itemno=b.itemno and a.unicode=b.unicode where b.branch='+@cmp
	+iif(@whno<>'',' and whno='+@whno,'')+' ) as s '
	set  @sqlmsg= @sqlmsg+' on  t.itemno=s.itemno and t.unicode=s.unicode '
	set  @sqlmsg= @sqlmsg+' when not matched then '
	set  @sqlmsg= @sqlmsg+' insert values (s.name,s.itemno,s.unicode,0,s.lcost,s.lcost,s.lprice1,s.fprice1,s.maxdisc1,s.lprice2,s.fprice2,s.maxdisc2,'
	set  @sqlmsg= @sqlmsg+'s.lprice3,s.fprice3,s.maxdisc3,s.fcost,s.fcost,s.lrcvdate,s.lastissue,0,0,0,s.minstk,s.maxstk,'
	set  @sqlmsg= @sqlmsg+'s.orderlevel,s.leadday,s.Xdecimal,s.barcode,s.pack1,s.pkqty1,s.pack2,s.pkqty2,s.pack3,s.pkqty3,s.company,'
	set  @sqlmsg= @sqlmsg+'1,s.pack0,s.packtp,s.scnname,s.crtdate,s.inactive,s.prmcode,s.scncode,s.cmbkey,s.mnmprice,'
	set  @sqlmsg= @sqlmsg+'s.lastupdt,s.modelno,s.splyitemno,s.splyinv,s.invprice,s.invqty,s.invpk,s.pp2,s.pp3);'

		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-6
			return 
		end
		else commit transaction
/*

	--set @tbl=@dbc+'stunits as s '
	set @sqlmsg='merge stunits as t '
	set  @sqlmsg= @sqlmsg+' using '
	+'(select  a.*,qty*b.lcost as ttlcost,qty*b.fcost as ttfcost,b.qty from '+@dbc+'stunits a '
	+' inner join '+@dbc+'stbins b on a.itemno=b.itemno and a.unicode=b.unicode where b.branch='+@cmp
	+iif(@whno<>'',' and whno='+@whno,'')+' ) as s '
	set  @sqlmsg= @sqlmsg+' on  t.itemno=s.itemno and t.unicode=s.unicode '
	set  @sqlmsg= @sqlmsg+' when matched then '
	set  @sqlmsg= @sqlmsg+' update set t.curbal=t.curbal+s.qty,'
	+ 't.openlcost=iif(t.openbal+s.qty<>0,((t.openlcost*t.openbal)+s.ttlcost)/(t.openbal+s.qty),t.openlcost),'
	+ 't.openfcost=iif(t.openbal+s.qty<>0,((t.openfcost*t.openbal)+s.ttfcost)/(t.openbal+s.qty),t.openfcost),'
	+ 't.openbal=t.openbal+s.qty '
	set  @sqlmsg= @sqlmsg+' when not matched then '
	set  @sqlmsg= @sqlmsg+' insert values (s.name,s.itemno,s.unicode,0,s.lcost,s.lcost,s.lprice1,s.fprice1,s.maxdisc1,s.lprice2,s.fprice2,s.maxdisc2,'
	set  @sqlmsg= @sqlmsg+'s.lprice3,s.fprice3,s.maxdisc3,s.fcost,s.fcost,s.lrcvdate,s.lastissue,s.curbal,s.curbal,0,s.minstk,s.maxstk,'
	set  @sqlmsg= @sqlmsg+'s.orderlevel,s.leadday,s.Xdecimal,s.barcode,s.pack1,s.pkqty1,s.pack2,s.pkqty2,s.pack3,s.pkqty3,s.company,'
	set  @sqlmsg= @sqlmsg+'1,s.pack0,s.packtp,s.scnname,s.crtdate,s.inactive,s.prmcode,s.scncode,s.cmbkey,s.mnmprice,'
	set  @sqlmsg= @sqlmsg+'s.lastupdt,s.modelno,s.splyitemno,s.splyinv,s.invprice,s.invqty,s.invpk,s.pp2);'

		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-6
			return 
		end
		else commit transaction
 */
	---- 
	---------------------  Move open balance from Last year for STBINS 
	----
		

	set @sqlmsg='merge stbins as t '
	set @sqlmsg= @sqlmsg+' using '
	+' (select * from '+@dbc+'stbins b '+@cmdcndn +') as s '
	set @sqlmsg= @sqlmsg+' on t.branch=s.branch and t.itemno=s.itemno and t.unicode=s.unicode and t.whno=s.whno and t.binno=s.binno '
	set @sqlmsg= @sqlmsg+' when matched then '
	set @sqlmsg= @sqlmsg+' update set t.qty=t.qty+s.qty,t.openbal=s.qty,t.openlcost=s.lcost,t.openfcost=s.fcost '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.branch,s.itemno,s.unicode,s.whno,s.binno,s.qty,0,s.qty,s.lcost,s.fcost,s.lcost,s.fcost,s.expdate);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-7
			return 
		end
		else commit transaction
	---- 
	---------------------  Move open balance from Last year for STUNITS 
	----
	begin transaction
	IF @whno<>''
	begin
		update stunits set curbal=curbal+isnull(lopenbal,0),
		openlcost=iif(openbal+isnull(lopenbal,0)<>0,((openbal*openlcost)+isnull(llcost,0))/(openbal+isnull(lopenbal,0)),openlcost),
		openfcost=iif(openbal+isnull(lopenbal,0)<>0,((openbal*openfcost)+isnull(ffcost,0))/(openbal+isnull(lopenbal,0)),openfcost),
		openbal=openbal+isnull(lopenbal,0)
		from stunits as s
		join 
		(select itemno,unicode ,lopenbal=sum(openbal),llcost=sum(openbal*openlcost),ffcost=sum(openbal*openfcost) 
		from stbins where branch=@cmp and whno=@whno group by itemno,unicode) b
		on s.itemno=b.itemno and s.unicode=b.unicode
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-1
			return --@errstatus
		end
	end
	else
	begin
		update stunits set curbal=curbal+isnull(lopenbal,0),
		openlcost=iif(openbal+isnull(lopenbal,0)<>0,((openbal*openlcost)+isnull(llcost,0))/(openbal+isnull(lopenbal,0)),openlcost),
		openfcost=iif(openbal+isnull(lopenbal,0)<>0,((openbal*openfcost)+isnull(ffcost,0))/(openbal+isnull(lopenbal,0)),openfcost),
		openbal=openbal+isnull(lopenbal,0)
		from stunits as s
		join 
		(select itemno,unicode ,lopenbal=sum(openbal),llcost=sum(openbal*openlcost),ffcost=sum(openbal*openfcost) 
		from stbins where branch=@cmp  group by itemno,unicode) b
		on s.itemno=b.itemno and s.unicode=b.unicode
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-3
			return --@errstatus
		end		
	end
	commit transaction


	---- 
	---------------------  Move Photos from Last year for stitmphoto 
	----
	--set @tbl=@dbc+'stitmphoto as s '
	--set @sqlmsg='merge stitmphoto as t '
	--set @sqlmsg= @sqlmsg+' using '
	--+' (select distinct a.* from '+@dbc+'stitmphoto a '+@stbinsjoin+@cmdcndn+') as s '
	--set @sqlmsg= @sqlmsg+' on t.itemno=s.itemno and t.unicode=s.unicode '
	--set @sqlmsg= @sqlmsg+' when not matched then '
	--set @sqlmsg= @sqlmsg+' insert values (s.itemno,s.unicode,s.remarks,s.ipicture,s.ord_qty,s.mnimumdt,s.cust_pctg);'
	--	begin transaction
	--	exec sp_executesql @sqlmsg
	--	if @@error<>0
	--	begin
	--		rollback transaction
	--		set @errstatus=-8
	--		return 
	--	end
	--	else commit transaction
		 
		 end







GO
/****** Object:  StoredProcedure [dbo].[move_stock_balances_fm_last_year]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[move_stock_balances_fm_last_year]
 @dbc nvarchar(50),
 @multibarcode bit,
 @uniqu_bcs bit , -- multi branch prices
 @errstatus int = 0 output
	
AS
BEGIN
	declare @sqlmsg nvarchar(max)
	declare @tbl nvarchar(50)
	set @tbl=@dbc+'stitems as s '
	---- 
	---------------------  Move iTEMS from Last year for STITEMS 
	----
	set @errstatus=0

	set @sqlmsg='merge STITEMS as t '
	set  @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+'on  t.itemno=s.itemno'
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+'insert values (s.name,s.itemno,s.mgroup,s.sgroup,s.category,s.fcy,s.classkey,s.exdatealw,s.noofsbitem,1, '	
	set @sqlmsg= @sqlmsg+' s.sgroup3,s.sgroup4,s.company,s.lname,s.country,s.season,s.splycode,s.splylcact,s.itemtype,s.prntasmitm,s.prmdesc,'	
	set @sqlmsg= @sqlmsg+'s.scndesc,s.cmpprcnt,s.dsctype,s.brand_id,s.msplycode,s.modelno,s.nosales,s.vprice,s.fix_barcode,s.taxtype,s.taxfree);'	


		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-1
			return 
		end
		else commit transaction

	

	---- 
	---------------------  Move open balance from Last year for STUNITS 
	----
	set @tbl=@dbc+'stunits as s '
	set @sqlmsg='merge stunits as t '
	set  @sqlmsg= @sqlmsg+' using '+@tbl
	set  @sqlmsg= @sqlmsg+' on  t.itemno=s.itemno and t.unicode=s.unicode '
	set  @sqlmsg= @sqlmsg+' when matched then '
	set  @sqlmsg= @sqlmsg+' update set t.curbal=t.curbal-t.openbal+s.curbal,t.openbal=s.curbal,t.openlcost=s.lcost,t.openfcost=s.fcost '
	set  @sqlmsg= @sqlmsg+' when not matched then '
	set  @sqlmsg= @sqlmsg+' insert values (s.name,s.itemno,s.unicode,0,s.lcost,s.lcost,s.lprice1,s.fprice1,s.maxdisc1,s.lprice2,s.fprice2,s.maxdisc2,'
	set  @sqlmsg= @sqlmsg+'s.lprice3,s.fprice3,s.maxdisc3,s.fcost,s.fcost,s.lrcvdate,s.lastissue,s.curbal,s.curbal,0,s.minstk,s.maxstk,'
	set  @sqlmsg= @sqlmsg+'s.orderlevel,s.leadday,s.Xdecimal,s.barcode,s.pack1,s.pkqty1,s.pack2,s.pkqty2,s.pack3,s.pkqty3,s.company,'
	set  @sqlmsg= @sqlmsg+'1,s.pack0,s.packtp,s.scnname,s.crtdate,s.inactive,s.prmcode,s.scncode,s.cmbkey,s.mnmprice,'
	set  @sqlmsg= @sqlmsg+'s.lastupdt,s.modelno,s.splyitemno,s.splyinv,s.invprice,s.invqty,s.invpk,s.pp2,s.pp3);'

		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-2
			return 
		end
		else commit transaction

	---- 
	---------------------  Move open balance from Last year for STBINS 
	----
		
	set @tbl=@dbc+'stbins as s '
	set @sqlmsg='merge stbins as t '
	set @sqlmsg= @sqlmsg+' using '+@tbl
	set @sqlmsg= @sqlmsg+' on t.branch=s.branch and t.itemno=s.itemno and t.unicode=s.unicode and t.whno=s.whno and t.binno=s.binno '
	set @sqlmsg= @sqlmsg+' when matched then '
	set @sqlmsg= @sqlmsg+' update set t.qty=t.qty-t.openbal+s.qty,t.openbal=s.qty,t.openlcost=s.lcost,t.openfcost=s.fcost '
	set @sqlmsg= @sqlmsg+' when not matched then '
	set @sqlmsg= @sqlmsg+' insert values (s.branch,s.itemno,s.unicode,s.whno,s.binno,s.qty,0,s.qty,s.lcost,s.fcost,s.lcost,s.fcost,s.expdate);'
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-3
			return 
		end
		else commit transaction
	---- 
	---------------------  Move Photos from Last year for stitmphoto 
	----
	--set @tbl=@dbc+'stitmphoto as s '
	--set @sqlmsg='merge stitmphoto as t '
	--set @sqlmsg= @sqlmsg+' using '+@tbl
	--set @sqlmsg= @sqlmsg+' on t.itemno=s.itemno and t.unicode=s.unicode '
	--set @sqlmsg= @sqlmsg+' when not matched then '
	--set @sqlmsg= @sqlmsg+' insert values (s.itemno,s.unicode,s.remarks,s.ipicture,s.ord_qty,s.mnimumdt,s.cust_pctg);'
	--	begin transaction
	--	exec sp_executesql @sqlmsg
	--	if @@error<>0
	--	begin
	--		rollback transaction
	--		set @errstatus=-4
	--		return 
	--	end
	--	else commit transaction

		end
	





GO
/****** Object:  StoredProcedure [dbo].[new_bld_acct_bal]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2022-05-29@@$$##  Important : must have this line as first line which contains the last update date for the this file
-- Added on 2022-05-29 AA 
create PROCEDURE [dbo].[new_bld_acct_bal]
 @m_cmp char(2),
 @m_startdate char(8),
 @m_enddate char(8),
 @errstatus int output
 	
AS
BEGIN
    set @errstatus=0
	begin transaction
	update glchart set glcurbal=glopnbal,fccurbal=fcopnbal where glcomp=@m_cmp;
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-1
		return 				
	end
	
	update glchart set glcurbal=dbo.Acc_is_zero_value(xcurbal+glopnbal,5),fccurbal=dbo.Acc_is_zero_value(zcurbal+fcopnbal,5)
	from glchart c
	join
	(select jdcomp,jdkey,jdcurr,xcurbal=sum(iif(jddbcr='D',jdlcamt,-jdlcamt)),zcurbal=sum(iif(jddbcr='D',jdfcamt,-jdfcamt))
	from gljrhdr a inner join gljrdtl b on a.jhcomp=b.jdcomp and a.jhtype=b.jdtype and a.jhref=b.jdref 
	where jhcomp=@m_cmp and jhposted=1 and jhdate between @m_startdate and @m_enddate
	group by jdcomp,jdkey,jdcurr) d
	on c.glcomp=d.jdcomp and c.glkey=d.jdkey and c.glcurrency=d.jdcurr;
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-2 				
	end
	else commit transaction

end



GO
/****** Object:  StoredProcedure [dbo].[new_stupdt]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-04-06@@$$##  Important : must have this line as first line which contains the last update date for the this file
CREATE PROCEDURE [dbo].[new_stupdt]
   @errstatus int = 0 output
	
AS
BEGIN
---- 2024-04-05 AA Added changed the order of item trx list
---- 2023-10-26 AA Added new code to get red of the bad cost total from stbins
---- 2023-10-26 AA changed the way i update stunits from stbins
---- 2023-10-26 AA Force to select the proper openlcost for each binno at beginning
---- 2023-10-25 AA Even the @stk_lcost>0 put openbal<=0 , now forcing to search for any purchase for the item
---- 2023-10-25 AA Added new variable @item_received to track if the item already has received qty & has lcost
---- 2023-10-25 AA  Enhenced the search for the lcost if stk_lcost is 0
---- 2023-10-13 AA to fix the bug of using towhno instead of @ltowhno
---- 2023-10-13 AA to fix the bug of removing expdate from binno
---- 2023-08-16 AA convert numeric(6,0) to int for @lref & @lglref
---- 2023-07-15 AA fixed the bug of curbal in stunits 
---- 2023-07-12 AA Fixed the problem of zero lcost in stunits when qty in zero on stbins
---- 2023-06-13 AA fixed the bug of stunits lcost, not to sum any qty<0 in stbins 
---- 2023-01-07 AA Fixed the bug of lrunbal value when it is 0.000000000nnnn set to 0.00
---- 2022-12-21 Fixed the bug when and inventory transaction has JV (glref>0) do not build cost
---- Added on 2022-05-23 AA semi colons are added to the end of eash select statements
---- Added on 2022-05-23 AA Fixed the bug of converting float to numeric(20,12)
---- 2021-08-27 AA allow to take the lcost from sttypecost table if lstrcvdate>=yr_start
---- 2020-08-16 AA Made all the qty to be numeric(20,21) instead of float to get red of the long decimal fractions 
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.posted,trdate,src,AMNTTL,costttl,entries
	SET NOCOUNT ON


	declare @lcurbal float ,  
        @lrunbal float , 
        @inbal float , 
        @lopenbal float , 
		@llprice float,
		@llcost float,
		@lfcost float,
		@lopenlcost float,
		@lopenfcost float,
		@trxlcost float,
		@trxfcost float,
		@trxqty float , 
		@lbranch char(2),
        @litemno char(16),
		@lunicode char(6) ,
		@lwhno char(2) ,
		@lbinno char(6),
		@lttlqty float=0 , 
		@lmnopenlcost float,
		@stk_lcost float,
		@costchg int=0,
		@lastcost float,
		@stk_fcost float,
		@lmnopenfcost float

	declare 
		@dbc nvarchar(14),
		@lcalcomp char(2),
		@yrcode char(4),
		@lbrxautojv bit=0,
		@lyr_start char(8) -- Added on 2021-08-27 
		set @dbc=db_name()
		set @lcalcomp=substring(@dbc,4,2)
		set @yrcode=substring(@dbc,7,2)
		SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)

	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @lbrxautojv=brxautojv,@lyr_start=calstart  from sysdb.dbo.glcalend  -- Modified on 2021-08-27 
	       where calcomp=@lcalcomp and yrcode=@yrcode;
    set @lbrxautojv=isnull(@lbrxautojv,0)
--------------------------------------------------------------------------------------------------------------------------- 
---
---   Prepair for deletion and updating to openbal vaalues
---
      
		begin transaction
		delete from stbins where openbal=0 and openlcost=0 and len(expdate)=0 -- Added on 2023-10-13 AA to fix the bug of removing expdate from binno
		if @@error<>0
			begin
			  rollback transaction
			  set @errstatus=-1		
			  return		 
			end
		
		update stbins set qty=openbal,lcost=openlcost,fcost=openfcost
		if @@error<>0
			begin
			  rollback transaction
			  set @errstatus=-1		
			  return		 
			end
			
		update stunits set curbal=openbal,lcost=openlcost,fcost=openfcost
		if @@error<>0
			begin
			  rollback transaction
			  set @errstatus=-1		
			  return		 
			end
		commit transaction
-----------------------------------------------------------------------------------------------
        begin transaction
		merge stbins as t
		using (select distinct branch,a.itemno,a.unicode,whno,binno from stdtl a inner join stunits b 
		   on a.itemno=b.itemno and a.unicode=b.unicode
		   inner join stitems c
		   on b.itemno=c.itemno
		where c.itemtype not in ('5','6')) as s
		on t.branch=s.branch and t.itemno=s.itemno and t.unicode=s.unicode and t.whno=s.whno and t.binno=s.binno
		when not matched then
			insert values (s.branch,s.itemno,s.unicode,s.whno,s.binno,0,0,0,0,0,0,0,'');
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-1	
				return --@errstatus			 				
			end
			else commit transaction
		  if @errstatus<0 
		  return 
-------------------------------------  Added on 22-03-2017 --------------------------------
--- To handle the pu fcyrate 0.000001 which make the fcost of stdtl very big
        begin transaction
		update stdtl set fcost=0
		from stdtl t
		join
		(
		select a.itemno,a.unicode,a.branch,a.trtype,a.ref,folio,b.fcyrate,lcost,fcost from stdtl a with (nolock)
		 inner join puhdr b with (nolock) on a.branch=b.company and a.trtype=b.invtype
		and a.ref=b.ref
		where a.src='07' and b.fcyrate=0.000001 and len(fcy)=0) s
		on t.branch=s.branch and t.trtype=s.trtype and t.ref=s.ref and t.folio=s.folio
		where t.src='07';
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-1	
			return 			 				
		end
		
		--  the fcost always zero
		update stdtl set fcost=nfcost
		from stdtl t
		join
		(
		select a.branch,a.trtype,a.ref,folio,nfcost=lcost/curfix  from sthdr x 
		inner join  stdtl a on a.branch=x.branch and a.trtype=x.trtype and a.ref=x.ref inner join 
		stitems b on a.itemno=b.itemno inner join glcurr c on b.fcy=c.curcode
		where len(b.fcy)>0 and a.trtype='01' and fcost=0 and curfix>0) s
		on t.branch=s.branch and t.trtype=s.trtype and t.ref=s.ref and t.folio=s.folio;
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-1	
			return 			 				
		end
		update puhdr set fcyrate=0 where fcyrate=0.000001 and len(fcy)=0
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-1	
			return 			 				
		end
		commit transaction			
-----------------------------------------------------------------------------------------------
--  Building stbins items qty balances and cost
--
     declare @ltrtype char(2),
	         @ltrdate char(8),
	         @lref int,
			 @lqty float,
			 @lfolio int,
			 @lisbrtrx bit,
			 @lrcvdtrn bit,
			 @lposted bit,
			 @ltowhno char(2),
			 @ltobinno char(6),
			 @lfcy char(3),
			 @lfcyrate float,
			 @ttp int,
			 @dont_check_cost int=0,
			 @xdate char(8),
			 @lcurfixrate float=0,
			 @only20type bit =0,
			 @lglref int=0, -- Added on 2022-12-21 AA
			 @item_received bit =0 -- Added on 2023-10-25 AA 

     set @errstatus=0;
     DECLARE crs0 CURSOR LOCAL FAST_FORWARD FOR
     select branch,a.itemno,a.unicode,whno,binno,a.openbal,a.openlcost,a.openfcost,b.fcy,c.openlcost as mnopenlcost,
	 c.openfcost as mnopenfcost from stbins a inner join stunits c 
	 on a.itemno=c.itemno and a.unicode=c.unicode
	 inner join stitems b
	 on c.itemno=b.itemno 
	 order by itemno;
	
	 
  	 open crs0;

------------------------------------
		fetch next from crs0 into @lbranch,@litemno,@lunicode,@lwhno,@lbinno,@lopenbal,@lopenlcost,@lopenfcost,@lfcy,
		@lmnopenlcost,@lmnopenfcost;

		
		WHILE dbo.FetchStatusOfCursorNamed('crs0') = 0
        BEGIN
		    set @lrunbal=@lopenbal
			set @dont_check_cost=0
			set @stk_lcost=ABS(@lopenlcost)
			set @stk_fcost=ABS(@lopenfcost)
----------- Added on 2023-10-26 AA -------------------------------------
			if @lrunbal<=0 and @stk_lcost>0 and @lmnopenlcost>0
			if @lmnopenlcost<@stk_lcost 
			begin 
			   set @stk_lcost=@lmnopenlcost
			   set @stk_fcost=@lmnopenfcost
			end
------------------------------------------------------------------------
			set @lastcost=0
			set @only20type=0
	        set @item_received=iif(@lrunbal>0 and @stk_lcost>0,1,0) -- Added on 2023-10-25 AA 
			
			set @lcurfixrate=0
			if len(@lfcy)>0 select @lcurfixrate=curfix from glcurr where curcode=@lfcy;

            DECLARE crs1 CURSOR LOCAL FAST_FORWARD FOR
			select a.trtype,a.ref,a.folio,qty+fqty as qty,lcost,fcost,isbrtrx,posted,a.towhno,a.tobinno,fcyrate,a.trdate,
			rcvdtrn,b.glref -- Added on 2022-12-21 AA
			from sthdr b inner join stdtl a
	    	on b.branch=a.branch and b.trtype=a.trtype and b.ref=a.ref 
	    	where a.branch=@lbranch and a.itemno=@litemno and a.unicode=@lunicode and a.whno=@lwhno and binno=@lbinno
			order by a.trdate,Iif(a.trtype in ('10','11','01'),'01',Iif(a.trtype='14','02',
			iif(a.trtype in ('13','46','12'),'03','04'))),a.ref,folio; -- Modified on 2024-04-05 AA
            --order by a.trdate ,Iif(a.trtype in ('10','11','01','13','46','12','14'),'01','02'),a.ref,folio;
			open crs1;

			fetch next from crs1 into @ltrtype,@lref,@lfolio,@lqty,@llcost,@lfcost,@lisbrtrx,@lposted,@ltowhno
			,@ltobinno,@lfcyrate,@ltrdate,@lrcvdtrn,@lglref; -- Added on 2022-12-21 AA @lglref

			begin transaction

			WHILE dbo.FetchStatusOfCursorNamed('crs1') = 0
            BEGIN
				set @trxlcost=0
				set @trxfcost=0
			    
			    set @ttp=cast(@ltrtype as int)
				if @stk_lcost=0 and @llcost>0 set @lastcost=@llcost
				if @lposted=1
				begin
				   if @ttp in (4,6,9,30,31,2)
				   begin
				       set @lrunbal=@lrunbal-@lqty
				   end
				   if @ttp in (5,24,26,13,12) or (@ttp=46 And @lqty<0)  
				   begin
				       set @lrunbal=@lrunbal+@lqty
                       If @lqty>0 And @stk_lcost=0 
					   begin  
                         set @lastcost=@llcost
                       
                       end
				   end
				   if @ttp in (1,10,11) or (@ttp=46 And @lqty>0) 
				   begin
				      set @item_received=1 --Added on 2023-10-25 AA 
				      if @lrunbal>0
					  begin
						-- added on 2018-04-04
						if @stk_lcost>0
						set @stk_lcost=Abs(((@stk_lcost*@lrunbal)+Abs(@lqty*@llcost))/(@lrunbal+@lqty))
						else set @stk_lcost=@llcost

						  if isnull(@lfcost,0)<>0
						  begin 
						       if @stk_fcost>0
						          set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*@lfcost))/(@lrunbal+@lqty))
							   else set @stk_fcost=@lfcost
						  end
						  else 
						  if isnull(@lfcy,'')<>''
						  begin
							   if  isnull(@lfcyrate,0)>0
							     if @stk_fcost>0
								   set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*(@llcost/@lfcyrate)))/(@lrunbal+@lqty))
								 else set @stk_fcost=(@llcost/@lfcyrate)
							   else 
							   if isnull(@lcurfixrate,0)>0
							        if @stk_fcost>0
									  set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*(@llcost/@lcurfixrate)))/(@lrunbal+@lqty))
									else set @stk_fcost=(@llcost/@lcurfixrate)
						  end
					  end
					  else
					  begin
							set @stk_lcost=@llcost
							if isnull(@lfcost,0)<>0  set @stk_fcost=@lfcost
							else if isnull(@lfcy,'')<>'' 
							begin
								if  isnull(@lfcyrate,0)>0 set @stk_fcost=@llcost/@lfcyrate
								else  if isnull(@lcurfixrate,0)>0 set @stk_fcost=@llcost/@lcurfixrate
							end
					  end
					  set @lrunbal=@lrunbal+@lqty
				   end
                   if @ttp=20
				   begin
				       if rtrim(@ltowhno)=''
					   begin
					       set @item_received=1 --Added on 2023-10-25 AA 
						   if @stk_lcost=0
						   begin
							 set @stk_lcost=@llcost
							 set @stk_fcost=@lfcost
						   end
						   else
						   if @lrunbal>0
						   begin
							  -- added on 2018-04-04
						      if @stk_lcost>0
							  set @stk_lcost=Abs(((@stk_lcost*@lrunbal)+Abs(@lqty*@llcost))/(@lrunbal+@lqty))
							  else set @stk_lcost=@llcost
							   
							   if isnull(@lfcost,0)<>0 
							       if @stk_fcost>0
								   set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*@lfcost))/(@lrunbal+@lqty))
								   else set @stk_fcost=@lfcost
						   end
						   else
						   begin
							 set @stk_lcost=@llcost
							 set @stk_fcost=@lfcost
						   end
					   end
				       set @lrunbal = @lrunbal + Iif(rtrim(@ltowhno)<>'',-@lqty,@lqty)
				   end
				   if @ttp=14
				   begin
					   set @stk_lcost=@llcost
					   set @stk_fcost=@lfcost
					   set @item_received=1 --Added on 2023-10-25 AA 
				   end
			    end  -- end of @lposted
--
---------- beginning of stdtl lcost update
--
				If not (@ttp in (1,10,11,14,30,31,20) or (@ttp=46 And @lqty>0) or @lisbrtrx=1 
				       or @lglref>0) -- Added on 2022-12-21 AA
				begin
				    set @only20type=1
				    if (@stk_lcost=0 or @item_received=0 )and  @dont_check_cost<3  -- Added on 2023-10-25 AA or @item_received=0 
					begin
						if @ttp<>'20'
						begin
							set @dont_check_cost +=1
							set @xdate=@ltrdate
							Select top 1 @trxlcost=lcost,@trxfcost=fcost,@trxqty=qty+fqty From stdtl where
							branch=@lbranch and itemno=@litemno and unicode=@lunicode and whno=@lwhno and
							binno=@lbinno and  
							(trtype in ('01','10','11') or (trtype='46' And qty>0) or (trtype='20' And towhno=''))
							order by trdate,iif(trtype in ('01','10','11'),1,2),stdtl.ref,folio;

							if isnull(@trxlcost,0)=0
							begin
								set @dont_check_cost +=1
								Select top 1 @trxlcost=lcost,@trxfcost=fcost From stdtl where
								branch=@lbranch and itemno=@litemno and unicode=@lunicode and whno=@lwhno
								and  
								(trtype in ('01','10','11') or (trtype='46' And qty>0) or (trtype='20' And towhno=''))
								order by trdate,iif(trtype in ('01','10','11'),1,2),stdtl.ref,folio;
							end
							if isnull(@trxlcost,0)=0 
							begin
								set @dont_check_cost +=1
								Select top 1 @trxlcost=lcost,@trxfcost=fcost From stdtl where
								branch=@lbranch and itemno=@litemno and unicode=@lunicode 
								and  
								(trtype in ('01','10','11') or (trtype='46' And qty>0))
								order by trdate,iif(trtype in ('01','10','11'),1,2),stdtl.ref,folio;
							end
							if isnull(@trxlcost,0)=0 
							begin
								set @dont_check_cost +=1
								Select top 1 @trxlcost=lcost,@trxfcost=fcost From stdtl where
								itemno=@litemno and unicode=@lunicode 
								and  
								(trtype in ('01','10','11') or (trtype='46' And qty>0)) 
								order by trdate,iif(trtype in ('01','10','11'),1,2),stdtl.ref,folio;
							end
							if isnull(@trxlcost,0)=0 
							begin
								set @trxlcost=0
								set @trxfcost=0
								select @trxlcost=lastlcost,@trxfcost=lastfcost from stcosttype 
								where branch=@lbranch  and itemno=@litemno and unicode=@lunicode 
								and lstrcvdate>=@lyr_start; -- Added on 2021-08-27 AA
								if isnull(@trxlcost,0)=0
								begin
									select top 1 @trxlcost=lastlcost,@trxfcost=lastfcost from stcosttype 
									where  itemno=@litemno and unicode=@lunicode and lstrcvdate>=@lyr_start order by lstrcvdate desc,branch; 
								end
							end									 
						end

						if not(@ttp=20) 
						begin
							if isnull(@trxlcost,0)>0
							begin
								set @stk_lcost=@trxlcost
								set @stk_fcost=isnull(@trxfcost,0)
							end
							else
							begin
								if @stk_lcost=0 and @lmnopenlcost>0 set @stk_lcost=ABS(@lmnopenlcost)
								if @stk_fcost=0 and @lmnopenfcost>0 set @stk_fcost=ABS(@lmnopenfcost)
							end
						end

					end  -- end of @stk_lcost=0
					if not(@ttp=20) 
					begin
					    if @stk_lcost>0 
						begin
						    update stdtl set lcost=@stk_lcost,fcost=@stk_fcost where branch=@lbranch and trtype=@ltrtype and
							ref=@lref and folio=@lfolio
			         	    if @@error<>0
						    begin
							    rollback transaction
							    set @errstatus=-1
							    break
						    end
						end 
					end
					if @ttp=20 and @stk_lcost=0 and @llcost>0
					begin
					   set @stk_lcost=@llcost
					end

				end -- end of stdtl lcost update
				fetch next from crs1 into @ltrtype,@lref,@lfolio,@lqty,@llcost,@lfcost,@lisbrtrx,@lposted,@ltowhno
			    ,@ltobinno,@lfcyrate,@ltrdate,@lrcvdtrn,@lglref; -- Added on 2022-12-21 AA @lglref
			end  -- end of crs1 inner loop
            CLOSE crs1
            DEALLOCATE crs1
			if @errstatus=-1
			break;

------------------------------------------------------

-----
------          update stbins qty and lcost
------

            if @lrunbal<>0 and  @stk_lcost=0
			if  @only20type=0
			begin
				set @trxlcost=0
				set @trxfcost=0
				select @trxlcost=lastlcost,@trxfcost=lastfcost from stcosttype 
				where branch=@lbranch  and itemno=@litemno and unicode=@lunicode;
				if isnull(@trxlcost,0)=0
				begin
					select top 1 @trxlcost=lastlcost,@trxfcost=lastfcost from stcosttype 
					where  itemno=@litemno and unicode=@lunicode order by lstrcvdate desc,branch; 
				end
				if isnull(@trxlcost,0)>0
				begin
					set @stk_lcost=@trxlcost
					set @stk_fcost=isnull(@trxfcost,0)
				end
			end

			if @stk_lcost=0
			if @lopenlcost>0 
			begin
			    set @stk_lcost=ABS(@lopenlcost)
				set @stk_fcost=ABS(@lopenfcost)
			end
			else if @lmnopenlcost>0
			begin
			    set @stk_lcost=ABS(@lmnopenlcost)
				set @stk_fcost=ABS(@lmnopenfcost)
			end
			else if @lastcost>0 set @stk_lcost=@lastcost
------------ Added on 2023-01-07 AA get red of bad decimals ----------------------------
            if abs(@lrunbal)<1 and @lrunbal<>0 and cast(@lrunbal as numeric(20,4))=0
			 set @lrunbal=0.00
----------------------------------------------------------------------------------------
            update stbins set qty=@lrunbal,lcost=@stk_lcost,fcost=@stk_fcost where 
			branch=@lbranch and itemno=@litemno and unicode=@lunicode and whno=@lwhno and binno=@lbinno
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-1
				break
			end
			else commit transaction


			fetch next from crs0 into @lbranch,@litemno,@lunicode,@lwhno,@lbinno,@lopenbal,@lopenlcost,@lopenfcost,@lfcy,
			@lmnopenlcost,@lmnopenfcost;
		end  -- end of crs0 ourter loop
		CLOSE crs0;
        DEALLOCATE crs0;
		if @errstatus=-1 
		begin
		   if @@TRANCOUNT>0   rollback transaction
			return @errstatus
	    end
		else if @@TRANCOUNT>0 commit transaction
---
----------------  Update stunits curbal and lcost
---

      begin transaction
----- Stopped on 2023-10-26 AA --------------------------------------------------------------------------------------------------------------------
	 --  update stunits set curbal=xcurbal,lcost=iif(xcurbal>0 and ttllcost>0,ttllcost/xcurbal,iif(minlcost>0,minlcost,iif(maxlcost>0,maxlcost,lcost))),
	 --  fcost=iif(xcurbal>0 and ttlfcost>0,ttlfcost/xcurbal,iif(minfcost>0,minfcost,iif(maxfcost>0,maxfcost,fcost)))
	 --  from stunits as v
	 --  join
	 --  (select itemno,unicode,xcurbal=sum(qty),ttllcost=sum(qty*lcost),ttlfcost=sum(qty*isnull(fcost,0)),
	 --   minlcost=min(lcost),maxlcost=max(lcost),minfcost=min(fcost),maxfcost=max(fcost)
	 --   from stbins
	 --   where qty>0 -- Added on 2023-06-13 AA
	 --   group by itemno,unicode) c
		--on v.itemno=c.itemno and v.unicode=c.unicode;

------ Added on 2023-10-26 AA --------------------------------------------------------------------------------------------------------------------
	   update stunits set curbal=xcurbal,lcost=iif((xcurbal>0 and ttllcost>0) or (xcurbal<0 and ttllcost<0),ttllcost/xcurbal,iif(minlcost>0,minlcost,iif(maxlcost>0,maxlcost,lcost))),
	   fcost=iif((xcurbal>0 and ttlfcost>0) or (xcurbal<0 and ttlfcost<0),ttlfcost/xcurbal,iif(minfcost>0,minfcost,iif(maxfcost>0,maxfcost,fcost)))
	   from stunits as v
	   join
	   (select itemno,unicode,xcurbal=sum(qty),ttllcost=sum(qty*lcost),ttlfcost=sum(qty*isnull(fcost,0)),
	    minlcost=min(lcost),maxlcost=max(lcost),minfcost=min(fcost),maxfcost=max(fcost)
	    from stbins
	    group by itemno,unicode) c
		on v.itemno=c.itemno and v.unicode=c.unicode;
-----------------------------------------------------------------------------------------------------------------------------------------------------
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-1
			return --@errstatus
		end
		commit transaction

		begin transaction
		update stbins set lcost=avgcost/cntr
		from stbins t
		join
		(
		select itemno,unicode,avgcost=sum(lcost),cntr=count(*) from stbins
		group by itemno,unicode having sum(qty)=0 and sum(qty*lcost)<>0) as c
		on t.itemno=c.itemno and t.unicode=c.unicode
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-1
			return --@errstatus
		end
		commit transaction
----- Stopped on 2023-10-26 AA --------------------------------------------------------------------------------------------------------------------
----- Added on 2023-07-15 AA -------------------------------------------------------------------------------------------
  --     begin transaction
	 --  update stunits set curbal=xcurbal
	 --  from stunits as v
	 --  join
	 --  (select itemno,unicode,xcurbal=sum(qty)
	 --   from stbins
	 --   group by itemno,unicode) c
		--on v.itemno=c.itemno and v.unicode=c.unicode;
		--if @@error<>0
		--begin
		--	rollback transaction
		--	set @errstatus=-1
		--	return --@errstatus
		--end
		--commit transaction
--------------------------------------------------------------------------------------------------------------------------
----- Stopped on 2023-10-26 AA --------------------------------------------------------------------------------------------------------------------
------- Added on 2023-07-12 AA to get lcost of stunits from stbins when qty=0
--     begin transaction
--	   update stunits set lcost=iif(xcurbal>0 and ttllcost>0,ttllcost/xcurbal,0),
--	   fcost=iif(xcurbal>0 and ttlfcost>0,ttlfcost/xcurbal,0)
--	   from stunits as v
--	   join
--	   (select a.itemno,a.unicode,xcurbal=count(*),ttllcost=sum(a.lcost),ttlfcost=sum(isnull(a.fcost,0))
--	    from stbins a inner join stunits b on a.itemno=b.itemno and a.unicode=b.unicode
--	    where b.lcost=0 and a.lcost>0 -- Added on 2023-06-13 AA
--	    group by a.itemno,a.unicode) c
--		on v.itemno=c.itemno and v.unicode=c.unicode;
--		if @@error<>0
--		begin
--			rollback transaction
--			set @errstatus=-3
--			return --@errstatus
--		end
--		commit transaction
--		
		IF  EXISTS(SELECT * FROM sys.indexes WHERE object_id = object_id('dbo.stdtl') AND NAME ='xx100xxtemp')
		drop index 	xx100xxtemp on dbo.stdtl;
end


GO
/****** Object:  StoredProcedure [dbo].[new_stupdt_stktkon]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

---- 2020-08-16 AA Made all the qty to be numeric(20,21) instead of float to get red of the long decimal fractions 

CREATE PROCEDURE [dbo].[new_stupdt_stktkon]  --April 14,2021
   @errstatus int = 0 output
	
AS
BEGIN

	SET NOCOUNT ON

IF not EXISTS(SELECT * FROM sys.indexes WHERE object_id = object_id('dbo.stdtl') AND NAME ='xx100xxtemp')
create index xx100xxtemp on stdtl (branch,itemno,unicode,whno,binno)

declare @lcurbal numeric(20,12) ,
        @lrunbal numeric(20,12),
        @inbal numeric(20,12),
        @lopenbal numeric(20,12),
		@llprice float,
		@llcost float,
		@lfcost float,
		@lopenlcost float,
		@lopenfcost float,
		@trxlcost float,
		@trxfcost float,
		@trxqty numeric(20,12),
		@lbranch char(2),
        @litemno char(16),
		@lunicode char(6) ,
		@lwhno char(2) ,
		@lbinno char(6),
		@lttlqty numeric(20,12)=0,
		@lmnopenlcost float,
		@stk_lcost float,
		@costchg int=0,
		@lastcost float,
		@stk_fcost float,
		@lmnopenfcost float

declare 
	@dbc nvarchar(14),
	@lcalcomp char(2),
	@yrcode char(4),
	@lbrxautojv bit=0
	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @lbrxautojv=brxautojv  from sysdb.dbo.glcalend 
	       where calcomp=@lcalcomp and yrcode=@yrcode
    set @lbrxautojv=isnull(@lbrxautojv,0)
--------------------------------------------------------------------------------------------------------------------------- 
     --Cursor Will Contail The Items That Has Transactions in Stdtl And No Entry In Stbins
	 -- Must Create Them And Make balance & Cost Building For Them
	 DECLARE crs0 CURSOR LOCAL FAST_FORWARD FOR

     select distinct a.branch,a.itemno,a.unicode,a.whno,a.binno,CAST(0 as float) as openbal,CAST(0 as float) as openlcost,
                CAST(0 as float) as openfcost,c.fcy,CAST(0 as float) as mnopenlcost,CAST(0 as float) as mnopenfcost 
				from stdtl a inner join stunits b 
       on a.itemno=b.itemno and a.unicode=b.unicode inner join stitems c 
	   on b.itemno=c.itemno and c.itemtype not in ('5','6')
	   left outer join stbins aa on a.branch=aa.branch and a.itemno=aa.itemno and 
	   aa.itemno is null and aa.unicode is null and aa.whno is null and aa.binno is null 
	   --a.itemno=aa.itemno and a.unicode=aa.unicode and a.whno=aa.whno and a.binno=aa.binno
	   order by a.itemno;

-----------------------------------------------------------------------------------------------
        begin transaction
		merge stbins as t
		using (select distinct branch,a.itemno,a.unicode,whno,binno from stdtl a inner join stunits b 
		   on a.itemno=b.itemno and a.unicode=b.unicode
		   inner join stitems c
		   on b.itemno=c.itemno
		where c.itemtype not in ('5','6')) as s
		on t.branch=s.branch and t.itemno=s.itemno and t.unicode=s.unicode and t.whno=s.whno and t.binno=s.binno
		when not matched then
			insert values (s.branch,s.itemno,s.unicode,s.whno,s.binno,0,0,0,0,0,0,0,'');
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-1	
				return --@errstatus			 				
			end
			else commit transaction
		  if @errstatus<0 
		  return 
-----------------------------------------------------------------------------------------------
--  Building stbins items qty balances & cost
--
     declare @ltrtype char(2),
	         @ltrdate char(8),
	         @lref numeric(6,0),
			 @lqty float,
			 @lfolio int,
			 @lisbrtrx bit,
			 @lrcvdtrn bit,
			 @lposted bit,
			 @ltowhno char(2),
			 @ltobinno char(6),
			 @lfcy char(3),
			 @lfcyrate numeric(10,5),
			 @ttp int,
			 @dont_check_cost int=0,
			 @xdate char(8),
			 @lcurfixrate float=0,
			 @only20type bit =0;

     set @errstatus=0;
		 
  	 open crs0;

------------------------------------
		fetch next from crs0 into @lbranch,@litemno,@lunicode,@lwhno,@lbinno,@lopenbal,@lopenlcost,@lopenfcost,@lfcy,
		@lmnopenlcost,@lmnopenfcost;		
		WHILE dbo.FetchStatusOfCursorNamed('crs0') = 0
        BEGIN
		    set @lrunbal=@lopenbal
			set @dont_check_cost=0
			set @stk_lcost=ABS(@lopenlcost)
			set @lastcost=0
			set @only20type=0
	        
			set @stk_fcost=ABS(@lopenfcost)

			set @lcurfixrate=0
			if len(@lfcy)>0 select @lcurfixrate=curfix from glcurr where curcode=@lfcy

            DECLARE crs1 CURSOR LOCAL FAST_FORWARD FOR
			select a.trtype,a.ref,a.folio,qty+fqty as qty,lcost,fcost,isbrtrx,posted,a.towhno,a.tobinno,fcyrate,a.trdate,
			rcvdtrn
			from sthdr b inner join stdtl a
	    	on b.branch=a.branch and b.trtype=a.trtype and b.ref=a.ref 
	    	where a.branch=@lbranch and a.itemno=@litemno and a.unicode=@lunicode and a.whno=@lwhno and binno=@lbinno
            order by a.trdate ,Iif(a.trtype in ('10','11','01','13','46','12','14'),'01','02'),a.ref,folio
			open crs1;

			fetch next from crs1 into @ltrtype,@lref,@lfolio,@lqty,@llcost,@lfcost,@lisbrtrx,@lposted,@ltowhno
			,@ltobinno,@lfcyrate,@ltrdate,@lrcvdtrn;

			begin transaction

			WHILE dbo.FetchStatusOfCursorNamed('crs1') = 0
            BEGIN
				set @trxlcost=0
				set @trxfcost=0
			    
			    set @ttp=cast(@ltrtype as int)
				if @stk_lcost=0 and @llcost>0 set @lastcost=@llcost
				if @lposted=1
				begin
				   if @ttp in (4,6,9,30,31,2)
				   begin
				       set @lrunbal=@lrunbal-@lqty
				   end
				   if @ttp in (5,24,26,13,12) or (@ttp=46 And @lqty<0)  
				   begin
				       set @lrunbal=@lrunbal+@lqty
                       If @lqty>0 And @stk_lcost=0 
					   begin  
                         set @lastcost=@llcost
                         --set @stk_fcost=@lfcost
                       end
				   end
				   if @ttp in (1,10,11) or (@ttp=46 And @lqty>0) 
				   begin
				      if @lrunbal>0
					  begin
						-- added on 2018-04-04
						if @stk_lcost>0
						set @stk_lcost=Abs(((@stk_lcost*@lrunbal)+Abs(@lqty*@llcost))/(@lrunbal+@lqty))
						else set @stk_lcost=@llcost

						  if isnull(@lfcost,0)<>0
						  begin 
						       if @stk_fcost>0
						          set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*@lfcost))/(@lrunbal+@lqty))
							   else set @stk_fcost=@lfcost
						  end
						  else 
						  if isnull(@lfcy,'')<>''
						  begin
							   if  isnull(@lfcyrate,0)>0
							     if @stk_fcost>0
								   set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*(@llcost/@lfcyrate)))/(@lrunbal+@lqty))
								 else set @stk_fcost=(@llcost/@lfcyrate)
							   else 
							   if isnull(@lcurfixrate,0)>0
							        if @stk_fcost>0
									  set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*(@llcost/@lcurfixrate)))/(@lrunbal+@lqty))
									else set @stk_fcost=(@llcost/@lcurfixrate)
						  end
					  end
					  else
					  begin
							set @stk_lcost=@llcost
							if isnull(@lfcost,0)<>0  set @stk_fcost=@lfcost
							else if isnull(@lfcy,'')<>'' 
							begin
								if  isnull(@lfcyrate,0)>0 set @stk_fcost=@llcost/@lfcyrate
								else  if isnull(@lcurfixrate,0)>0 set @stk_fcost=@llcost/@lcurfixrate
							end
					  end
					  set @lrunbal=@lrunbal+@lqty
				   end
                   if @ttp=20
				   begin
				       if rtrim(@ltowhno)=''
					   begin
						   if @stk_lcost=0
						   begin
							 set @stk_lcost=@llcost
							 set @stk_fcost=@lfcost
						   end
						   else
						   if @lrunbal>0
						   begin
							  -- added on 2018-04-04
						      if @stk_lcost>0
							  set @stk_lcost=Abs(((@stk_lcost*@lrunbal)+Abs(@lqty*@llcost))/(@lrunbal+@lqty))
							  else set @stk_lcost=@llcost
							   
							   if isnull(@lfcost,0)<>0 
							       if @stk_fcost>0
								   set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*@lfcost))/(@lrunbal+@lqty))
								   else set @stk_fcost=@lfcost
						   end
						   else
						   begin
							 set @stk_lcost=@llcost
							 set @stk_fcost=@lfcost
						   end
					   end
				       set @lrunbal = @lrunbal + Iif(rtrim(@ltowhno)<>'',-@lqty,@lqty)
				   end
				   if @ttp=14
				   begin
					   set @stk_lcost=@llcost
					   set @stk_fcost=@lfcost
				   end
			    end  -- end of @lposted
--
---------- beginning of stdtl lcost update
--
		--		print 'dd'+' '+str(@stk_lcost)+' type='+@ltrtype+' ref='+str(@lref)+' '+@litemno @lbrxautojv
				If not (@ttp in (1,10,11,14,30,31,20) or (@ttp=46 And @lqty>0) or @lisbrtrx=1)
--				((@lrcvdtrn=1 or @lposted=1 or @lbrxautojv=1) and @lisbrtrx=1 ))
				begin
				    set @only20type=1
				    if @stk_lcost=0 and  @dont_check_cost<3  ----runbal<0 And !okpurchaseinvoice And !T_NOT_POSTED.
					begin
						if @ttp<>'20'
						begin
						     set @dont_check_cost +=1
							 set @xdate=@ltrdate
							 Select top 1 @trxlcost=lcost,@trxfcost=fcost,@trxqty=qty+fqty From stdtl where
							 branch=@lbranch and itemno=@litemno and unicode=@lunicode and whno=@lwhno and
							 binno=@lbinno and --trdate>=@xdate and 
							 (trtype in ('01','10','11') or (trtype='46' And qty>0) or (trtype='20' And @ltowhno=''))
							 order by trdate,iif(trtype in ('01','10','11'),1,2),stdtl.ref,folio

							 if isnull(@trxlcost,0)=0
							 begin
							     set @dont_check_cost +=1
								 Select top 1 @trxlcost=lcost,@trxfcost=fcost From stdtl where
								 branch=@lbranch and itemno=@litemno and unicode=@lunicode and whno=@lwhno
								  and --trdate>=@xdate and 
								 (trtype in ('01','10','11') or (trtype='46' And qty>0) or (trtype='20' And @ltowhno=''))
								 order by trdate,iif(trtype in ('01','10','11'),1,2),stdtl.ref,folio
								 --print '3'+str(isnull(@trxlcost,0))+' type='+@ltrtype+' ref='+str(@lref)
								 if isnull(@trxlcost,0)=0 --is null
								 begin
								     set @dont_check_cost +=1
									 Select top 1 @trxlcost=lcost,@trxfcost=fcost From stdtl where
									 branch=@lbranch and itemno=@litemno and unicode=@lunicode 
									  and  
									 (trtype in ('01','10','11') or (trtype='46' And qty>0) or 
									 (trtype='20' And @ltowhno=''))
									 order by trdate,iif(trtype in ('01','10','11'),1,2),stdtl.ref,folio

									 if isnull(@trxlcost,0)=0 --is null
									 begin
										 set @dont_check_cost +=1
										 Select top 1 @trxlcost=lcost,@trxfcost=fcost From stdtl where
										 itemno=@litemno and unicode=@lunicode 
										  and  
										 (trtype in ('01','10','11') or (trtype='46' And qty>0)) 
										 order by trdate,iif(trtype in ('01','10','11'),1,2),stdtl.ref,folio

										 if isnull(@trxlcost,0)=0 --is null
										 begin
											set @trxlcost=0
											set @trxfcost=0
											select @trxlcost=lastlcost,@trxfcost=lastfcost from stcosttype 
											where branch=@lbranch  and itemno=@litemno and unicode=@lunicode
											if isnull(@trxlcost,0)=0
											begin
												select top 1 @trxlcost=lastlcost,@trxfcost=lastfcost from stcosttype 
												where  itemno=@litemno and unicode=@lunicode order by lstrcvdate desc,branch 
											end
										 end									 
									 end
								--	 print '4'+str(isnull(@trxlcost,0))+' type='+@ltrtype+' ref='+str(@lref)+'  '+@litemno
								 end
							 end
						end

						if not(@ttp=20) -- and rtrim(@ltowhno)='')
						begin
							if isnull(@trxlcost,0)>0
							begin
								set @stk_lcost=@trxlcost
								set @stk_fcost=isnull(@trxfcost,0)
							end
							else
							begin
								if @stk_lcost=0 and @lmnopenlcost>0 set @stk_lcost=ABS(@lmnopenlcost)
								if @stk_fcost=0 and @lmnopenfcost>0 set @stk_fcost=ABS(@lmnopenfcost)
							end
						end
						--print '5'+str(@stk_lcost)+' type='+@ltrtype+' ref='+str(@lref)+'  '+@litemno
					end  -- end of @stk_lcost=0
					--stopped for continous stock taking April 14,2021
					--if not(@ttp=20) --and rtrim(@ltowhno)='')
					--begin
					--    if @stk_lcost>0 
					--	begin
					--	   -- print '6'+str(@stk_lcost)+' type='+@ltrtype+' ref='+str(@lref)+'  '+@litemno
					--	    update stdtl set lcost=@stk_lcost,fcost=@stk_fcost where branch=@lbranch and trtype=@ltrtype and
					--		ref=@lref and folio=@lfolio
			        -- 	    if @@error<>0
					--	    begin
					--		    rollback transaction
					--		    set @errstatus=-1
					--		    break
					--	    end
					--	end 
					--end
					if @ttp=20 and @stk_lcost=0 and @llcost>0
					begin
					   set @stk_lcost=@llcost
					end

				end -- end of stdtl lcost update
				fetch next from crs1 into @ltrtype,@lref,@lfolio,@lqty,@llcost,@lfcost,@lisbrtrx,@lposted,@ltowhno
			    ,@ltobinno,@lfcyrate,@ltrdate,@lrcvdtrn;
			end  -- end of crs1 inner loop
            CLOSE crs1
            DEALLOCATE crs1
			if @errstatus=-1
			break;

------------------------------------------------------

-----
------          update stbins qty & lcost
------

            if @lrunbal<>0 and  @stk_lcost=0
			if  @only20type=0
			begin
				set @trxlcost=0
				set @trxfcost=0
				select @trxlcost=lastlcost,@trxfcost=lastfcost from stcosttype 
				where branch=@lbranch  and itemno=@litemno and unicode=@lunicode
				if isnull(@trxlcost,0)=0
				begin
					select top 1 @trxlcost=lastlcost,@trxfcost=lastfcost from stcosttype 
					where  itemno=@litemno and unicode=@lunicode order by lstrcvdate desc,branch 
				end
				if isnull(@trxlcost,0)>0
				begin
					set @stk_lcost=@trxlcost
					set @stk_fcost=isnull(@trxfcost,0)
				end
			end

			if @stk_lcost=0
			if @lopenlcost>0 
			begin
			    set @stk_lcost=ABS(@lopenlcost)
				set @stk_fcost=ABS(@lopenfcost)
			end
			else if @lmnopenlcost>0
			begin
			    set @stk_lcost=ABS(@lmnopenlcost)
				set @stk_fcost=ABS(@lmnopenfcost)
			end
			else if @lastcost>0 set @stk_lcost=@lastcost

            update stbins set qty=@lrunbal,lcost=@stk_lcost,fcost=@stk_fcost where 
			branch=@lbranch and itemno=@litemno and unicode=@lunicode and whno=@lwhno and binno=@lbinno
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-1
				break
			end
			else commit transaction
			fetch next from crs0 into @lbranch,@litemno,@lunicode,@lwhno,@lbinno,@lopenbal,@lopenlcost,@lopenfcost,@lfcy,
			@lmnopenlcost,@lmnopenfcost;
		end  -- end of crs0 ourter loop
		CLOSE crs0;
        DEALLOCATE crs0;
		if @errstatus=-1 
		begin
		   if @@TRANCOUNT>0   rollback transaction
			return @errstatus
	    end
		else if @@TRANCOUNT>0 commit transaction
---
----------------  Update stunits curbal & lcost
---
      begin transaction
	   update stunits set curbal=xcurbal,lcost=iif(xcurbal>0 and ttllcost>0,ttllcost/xcurbal,iif(minlcost>0,minlcost,iif(maxlcost>0,maxlcost,lcost))),
	   fcost=iif(xcurbal>0 and ttlfcost>0,ttlfcost/xcurbal,iif(minfcost>0,minfcost,iif(maxfcost>0,maxfcost,fcost)))
	   from stunits as v
	   join
	   (select itemno,unicode,xcurbal=sum(qty),ttllcost=sum(qty*lcost),ttlfcost=sum(qty*isnull(fcost,0)),
	    minlcost=min(lcost),maxlcost=max(lcost),minfcost=min(fcost),maxfcost=max(fcost)
	    from stbins
	    group by itemno,unicode) c
		on v.itemno=c.itemno and v.unicode=c.unicode
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-1
			return --@errstatus
		end
		commit transaction
--				
		IF  EXISTS(SELECT * FROM sys.indexes WHERE object_id = object_id('dbo.stdtl') AND NAME ='xx100xxtemp')
		drop index 	xx100xxtemp on dbo.stdtl
end











GO
/****** Object:  StoredProcedure [dbo].[one_trx_bldbal_jmla]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[one_trx_bldbal_jmla]
 @m_cmp char(2),
 @m_type char(2),
 @m_ref  numeric(6,0), 
 @errstatus int = 0 output
	
AS
BEGIN

		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
	SET NOCOUNT ON
	if @m_type='14' return @errstatus
	begin transaction

			---
			--- Update qty & rsvqty in STBINS
			---
	update stbins set qty=openbal+ttlbal ,rsvqty=ttlrsv
	from stbins a
	join 
	(select dd.branch,itemno,unicode,dd.whno,binno,ttlbal=sum(iif(hh.posted=1,case when (dd.trtype in ('02','04','06','09','30','31')) or (tobinno<>'+' and dd.trtype='20')
		then -(dd.qty+dd.fqty) else dd.qty+dd.fqty end,0)),
		ttlrsv=sum(iif(hh.posted=0,case when (dd.trtype in ('02','04','06','09','30','31') 
		or (dd.trtype in('13','46') And qty<0) or (dd.trtype='20' And dd.towhno<>'')) and not (dd.trtype='46' And tobinno='*')
		then abs(dd.qty+dd.fqty) else 0 end,0))
			from sthdr hh inner join stdtl dd
		on hh.branch=dd.branch and hh.trtype=dd.trtype and hh.ref=dd.ref
        where hh.trtype<>'14' and exists(select distinct itemno from stdtl k
		where dd.itemno=k.itemno and dd.unicode=k.unicode and k.branch=@m_cmp and k.trtype=@m_type and k.ref=@m_ref)
		group by dd.branch,itemno,unicode,dd.whno,binno ) b
		on a.branch=b.branch and a.itemno=b.itemno and a.unicode=b.unicode and a.whno=b.whno and a.binno=b.binno
		if @@error<>0
		begin
		    rollback transaction
			set @errstatus=-2
			return @errstatus
		end
			---
			--- Update qty & rsvqty in STUNITS
			---
	update stunits set curbal=openbal+ttlbal ,rsvqty=ttlrsv
	from stunits a
	join 
	(select itemno,unicode,ttlbal=sum(iif(hh.posted=1,case when (dd.trtype in ('02','04','06','09','30','31')) or (tobinno<>'+' and dd.trtype='20')
		then -(dd.qty+dd.fqty) else dd.qty+dd.fqty end,0)),
		ttlrsv=sum(iif(hh.posted=0,case when (dd.trtype in ('02','04','06','09','30','31') 
		or (dd.trtype in('13','46') And qty<0) or (dd.trtype='20' And dd.towhno<>'')) and not (dd.trtype='46' And tobinno='*')
		then abs(dd.qty+dd.fqty) else 0 end,0))
			from sthdr hh inner join stdtl dd
		on hh.branch=dd.branch and hh.trtype=dd.trtype and hh.ref=dd.ref
        where hh.trtype not in ('14','20') and exists(select distinct itemno from stdtl k
		where dd.itemno=k.itemno and dd.unicode=k.unicode and k.branch=@m_cmp and k.trtype=@m_type and k.ref=@m_ref)
		group by itemno,unicode ) b
		on a.itemno=b.itemno and a.unicode=b.unicode 
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-1
			return --@errstatus
		end

		 commit transaction
	 	return @errstatus
end














GO
/****** Object:  StoredProcedure [dbo].[pcsbld_stbins_bal]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[pcsbld_stbins_bal]
 
 @errstatus int = 0 output
	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
		begin transaction
---------------------------------------------------------------
	update  stbins set qty=isnull(lcurbal,0)+openbal
	from stbins as b
	join 
    (select c.branch,c.itemno,c.unicode,c.whno,c.binno,lcurbal=sum(case when (c.trtype in ('02','04','06','09','30','31')) 
	or (c.towhno<>'  ' and c.trtype='20')
		then -(qty+fqty) else qty+fqty end) from stdtl c inner join sthdr 
		on c.branch=sthdr.branch and c.trtype=sthdr.trtype and c.ref=sthdr.ref
		where  posted='1' and sthdr.trtype<>'14'
		group by  c.branch,itemno,unicode,c.whno,binno) a
	on a.branch=b.branch and a.itemno=b.itemno and a.unicode=b.unicode and a.whno=b.whno and a.binno=b.binno
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-1				  
		end
		else commit transaction
		return @errstatus
end














GO
/****** Object:  StoredProcedure [dbo].[pcsstupdt]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[pcsstupdt]
 
 @errstatus int = 0 output
	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
-- 
-- This section is used to addup new entries for stbins
--
declare @curbal numeric(12,3) ,
        @lrunbal numeric(12,3),
        @inbal numeric(12,3),
        @lopenbal numeric(12,3),
		@llprice numeric (12,3),
		@llcost float,
		@lfcost float,
		@lavlcost float,
		@lavfcost float,
		@inttlcost float,
		@inttfcost float,
		@lbranch char(2),
        @litemno char(16),
		@lunicode char(6) ,
		@lwhno char(2) ,
		@lbinno char(6),
		@lttlqty numeric(13,3),
		@lttllcost float,
		@lttlfcost float,
		@lptr int = 0,
		@lstunits cursor,
		@lcursor cursor ;

---
---   Prepair for deletion and updating to openbal vaalues
---
      
		begin transaction
		delete from stbins where openbal=0 and openlcost=0 
		if @@error<>0
			begin
			  rollback transaction
			  set @errstatus=-1		
			  return		 
			end
		
		update stbins set qty=openbal,lcost=openlcost,fcost=openfcost
		if @@error<>0
			begin
			  rollback transaction
			  set @errstatus=-1		
			  return		 
			end
			
		update stunits set curbal=openbal,lcost=openlcost,fcost=openfcost
		if @@error<>0
			begin
			  rollback transaction
			  set @errstatus=-1		
			  return		 
			end
		commit transaction
-----------------------------------------------------------------------------------------------
     begin transaction
		merge stbins as t
		using (select distinct branch,a.itemno,a.unicode,whno,binno from stdtl a inner join stunits b on a.itemno=b.itemno 
			and a.unicode=b.unicode ) as s
		on t.branch=s.branch and t.itemno=s.itemno and t.unicode=s.unicode and t.whno=s.whno and t.binno=s.binno
		when not matched then
			insert values (s.branch,s.itemno,s.unicode,s.whno,s.binno,0,0,0,0,0,0,0,'');
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-1	
				return --@errstatus			 				
			end
			else commit transaction
		  if @errstatus<0 
		  return 
-----------------------------------------------------------------------------------------------
/*		
		set @lcursor = cursor for 
		select distinct a.branch,a.itemno,a.unicode,a.whno,a.binno from sthdr b inner join stdtl a inner join stitems c
		on a.itemno=c.itemno
		on b.branch=a.branch and b.trtype=a.trtype and b.ref=b.ref
		 where not exists(select whno from stbins where stbins.branch=a.branch and stbins.itemno=a.itemno
		  and stbins.unicode=a.unicode and stbins.whno=a.whno 
				and binno=a.binno) and
		 b.posted='1' and c.itemtype not in ('5','6') 
		order by itemno,unicode			

		open @lcursor;
		
		fetch next from @lcursor into @lbranch,@litemno,@lunicode,@lwhno,@lbinno
		
		begin transaction
		WHILE @@FETCH_STATUS = 0
        BEGIN

		    insert into stbins (branch,itemno,unicode,whno,binno,lcost,fcost,openbal,openlcost,openfcost,qty,expdate) values
		    (@lbranch,@litemno,@lunicode,@lwhno,@lbinno,0,0,0,0,0,0,' ')

				if @@error<>0
				begin
				  rollback transaction
				  set @errstatus=-1
				  break
				end
		  
		  fetch next from @lcursor into  @lbranch,@litemno,@lunicode,@lwhno,@lbinno
		 end
		 if @errstatus=0 
		 commit transaction
close @lcursor
deallocate @lcursor
if @errstatus<0 
  return
  */
  
---
-----   Build up the curbal of stunits and lcost of stbins & stunits
-----
-----------------------------------------------------------------------------------------------------------------
    set @errstatus=0;
    begin transaction
    update stunits set curbal=openbal+lcurbal,lcost=iif(openbal+isnull(xinbal,0)<>0,
	(isnull(xinttlcost,0)+(openbal*openlcost))/(openbal+isnull(xinbal,0)),openlcost),
	fcost=iif(openbal+isnull(xinbal,0)<>0,
	(isnull(xinttfcost,0)+(openbal*openfcost))/(openbal+isnull(xinbal,0)),openfcost)
	from stunits as v
	join
	( select itemno,unicode,lcurbal=sum(case when a.trtype in ('02','04','06','09','30','31')
	then -(qty+fqty) else qty+fqty end) ,xinbal=sum(case when ((a.trtype in ('01','10','11')) or (a.trtype='46' and a.qty>0)) and b.isbrtrx='0' 
	then qty+fqty
	else 0 end),xinttlcost=sum(case when ((a.trtype in ('01','10','11')) or (a.trtype='46' and a.qty>0)) and b.isbrtrx='0' 
	then (qty+fqty)*a.lcost
	else 0 end),xinttfcost=sum(case when ((a.trtype in ('01','10','11')) or (a.trtype='46' and a.qty>0)) and b.isbrtrx='0' 
	then (qty+fqty)*a.fcost
	else 0 end)
	from stdtl a inner join sthdr b
	on a.branch=b.branch and a.trtype=b.trtype and a.ref=b.ref
	where  posted='1'  and b.trtype not in ('14','20')
	group by itemno,unicode) c
	on v.itemno=c.itemno and v.unicode=c.unicode
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-1
		return --@errstatus
	end
	else
	begin
	/*
		update stunits set lcost=iif(substring(c.date_type_lcost,9,2)='14',cast(ltrim(substring(c.date_type_lcost,11,18)) as float),
		iif(lcost<>0,lcost,cast(ltrim(substring(c.date_type_lcost,11,18)) as float))),
        fcost=iif(substring(c.date_type_fcost,9,2)='14',cast(ltrim(substring(c.date_type_fcost,11,18)) as float),
		iif(fcost<>0,fcost,cast(ltrim(substring(c.date_type_fcost,11,18)) as float)))
		from stunits as v
		join
		(select itemno,unicode,max(a.trdate+a.trtype+str(lcost,18,10)) as date_type_lcost,
		max(a.trdate+a.trtype+str(fcost,18,10)) as date_type_fcost from stdtl a inner join sthdr b
		on a.branch=b.branch and a.trtype=b.trtype and a.ref=b.ref
		where b.posted='1' and  (a.trtype in ('01','10','11','14') or (a.trtype='46' and a.qty>0))
		group by itemno ,unicode) c
		
		on v.itemno=c.itemno and v.itemno=c.itemno 
		where substring(c.date_type_lcost,9,2)='14'
		if @@error<>0
		begin			
			rollback transaction
			set @errstatus=-1
			return --@errstatus
		end
		else 
		begin
		*/
			update stbins set lcost=llcost,fcost=ffcost
			from stbins v
			join 
			(select itemno,unicode,llcost=lcost,ffcost=fcost from stunits ) c
			on v.itemno=c.itemno and v.unicode=c.unicode
	 		if @@error<>0
			begin			
				rollback transaction
				set @errstatus=-1
				return --@errstatus
			end
			else commit transaction
--		end
	end        
------------------------------------------------------------------------------------------------------------------
/*set @errstatus=0;

set @lstunits = cursor for 
   select distinct a.itemno,a.unicode,openbal,openlcost,openfcost,lprice1 
from stitems c inner join stunits a
on c.itemno=a.itemno
 inner join stdtl b
on a.itemno=b.itemno and a.unicode=b.unicode
where not (c.itemtype in ('5','6') or (c.itemtype='2' and a.unicode=''));
		open @lstunits;
		
		fetch next from @lstunits into @litemno,@lunicode,@lopenbal,@llcost,@lfcost,@llprice
		begin transaction
		WHILE @@FETCH_STATUS = 0
        BEGIN
        select @curbal=sum(case when a.trtype in ('02','04','06','09','30','31')
              then -(qty+fqty) else qty+fqty end) ,@inbal=sum(case when ((a.trtype in ('01','10','11')) or (a.trtype='46' and a.qty>0)) and b.isbrtrx='0' 
			  then qty+fqty
			  else 0 end),@inttlcost=sum(case when ((a.trtype in ('01','10','11')) or (a.trtype='46' and a.qty>0)) and b.isbrtrx='0' 
			  then (qty+fqty)*a.lcost
			  else 0 end),@inttfcost=sum(case when ((a.trtype in ('01','10','11')) or (a.trtype='46' and a.qty>0)) and b.isbrtrx='0' 
			  then (qty+fqty)*a.fcost
			  else 0 end)
			  from stdtl a inner join sthdr b
              on a.branch=b.branch and a.trtype=b.trtype and a.ref=b.ref
                where  posted='1' and a.itemno=@litemno and a.unicode=@lunicode  and b.trtype not in ('14','20');
				select @lrunbal=isnull(@curbal,0)+@lopenbal;
				select @lttlqty=isnull(@inbal,0)+@lopenbal;
				select @lttllcost=isnull(@inttlcost,0)+(@lopenbal*@llcost);
				select @lttlfcost=isnull(@inttfcost,0)+(@lopenbal*@lfcost);
				set @lavlcost=	@llcost	;	
				set @lavfcost=	@lfcost	;
				if
				@lttlqty>0
				begin
				  set @lavlcost=@lttllcost/@lttlqty
				  set @lavfcost=@lttlfcost/@lttlqty
--				  update stunits set curbal=@lrunbal,lcost=@lavlcost,fcost=@lavfcost where itemno=@litemno and unicode=@lunicode 
				end
--				else update stunits set curbal=@lrunbal where itemno=@litemno and unicode=@lunicode
				if 
				@lavlcost=0
				begin
				  select top 1 @lavlcost=lcost,@lavfcost=fcost from stdtl a inner join sthdr b on a.branch=b.branch and a.trtype=b.trtype and a.ref=b.ref
				   where itemno=@litemno and unicode=@lunicode and a.trtype='14' and  posted='1' order by b.trdate desc
				   set @lavlcost=isnull(@lavlcost,0)
				   set @lavfcost=isnull(@lavfcost,0)
				if @lavlcost=0 
				 set @lavlcost=@llprice;
				end
				update stunits set curbal=@lrunbal,lcost=@lavlcost,fcost=@lavfcost where itemno=@litemno and unicode=@lunicode 
	        	 
				if @@error<>0
				begin
				  rollback transaction
				  set @errstatus=-1
				  break
				end
                update stbins set lcost=@lavlcost,fcost=@lavfcost where itemno=@litemno and unicode=@lunicode	
				if @@error<>0
				begin
				  rollback transaction
				  set @errstatus=-1
				  break
				end							
		 fetch next from @lstunits into @litemno,@lunicode,@lopenbal,@llcost,@lfcost,@llprice
        end
	     if @errstatus=0 
		 commit transaction;
close @lstunits
deallocate @lstunits;
if @errstatus<0 
  return
 */ 
---
---    Build up the lcost of stdtl and if type ='14' then update lcost of stunits & stbins
---
---------------------------------------------------------------------------------------------------------------------
/*
begin transaction
update stdtl set lcost=llcost,fcost=ffcost
from stdtl v
join
(select a.branch,a.trtype,a.ref,a.folio,llcost=u.lcost,ffcost=u.fcost from sthdr b inner join stdtl a
	on b.branch=a.branch and b.trtype=a.trtype and b.ref=a.ref 
	inner join stunits u on  a.itemno=u.itemno and a.unicode=u.unicode  
	where  	(a.trtype in ('04','06','24','26','20','05','13','12','09') or (a.trtype='46' and a.qty<0)) and isbrtrx='0'
	) c
	on v.branch=c.branch and v.trtype=c.trtype and v.ref=c.ref and v.folio=c.folio 
	if @@error<>0
	begin			
		rollback transaction
		set @errstatus=-1
		return --@errstatus
	end
	else commit transaction
	*/
--inner join stbins u on a.branch=u.branch and a.itemno=u.itemno and a.unicode=u.unicode and a.whno=u.whno and a.binno=u.binno 
----------------------------------------------------------------------------------------------------------------------	

declare @ltype char(2),
    @lref numeric(6,0),
	@lqty numeric(12,3),
	@lfolio numeric(7,0),
    @litemno1 char(16),
	@costchg float,
	@lunicode1 char(6) ,
	@lisbrtrx bit
DECLARE crs0 CURSOR LOCAL FAST_FORWARD FOR
	select distinct a.itemno,a.unicode,a.lcost,a.fcost 
	from stitems c inner join stunits a
	on c.itemno=a.itemno
	inner join stdtl b
	on a.itemno=b.itemno and a.unicode=b.unicode
	where not (c.itemtype in ('5','6') or (c.itemtype='2' and a.unicode=''));

	open crs0;
	    set @errstatus=0;
		fetch next from crs0 into @litemno,@lunicode,@llcost,@lfcost;
		
		WHILE dbo.FetchStatusOfCursorNamed('crs0') = 0
        BEGIN
  			DECLARE crs1 CURSOR LOCAL FAST_FORWARD FOR
			select a.branch,a.itemno,a.unicode,a.trtype,a.ref,a.folio,qty+fqty as qty,lcost,fcost,isbrtrx from sthdr b inner join stdtl a
			on b.branch=a.branch and b.trtype=a.trtype and b.ref=a.ref 
			where a.itemno=@litemno and a.unicode=@lunicode and ((b.posted='1' and  (a.trtype in ('01','10','11','14') or (a.trtype='46' and a.qty>0))) or
			(a.trtype in ('04','06','24','26','20','05','13','12','09') or (a.trtype='46' and a.qty<0)))
			order by b.trdate;

			open crs1;
			set @lttlqty=0;
				set @costchg=0;
			fetch next from crs1 into @lbranch,@litemno1,@lunicode1,@ltype,@lref,@lfolio,@lqty,@lavlcost,@lavfcost,@lisbrtrx;
			begin transaction
			WHILE dbo.FetchStatusOfCursorNamed('crs1') = 0
              BEGIN
			     if
				  @ltype in ('01','10','11','14') or (@ltype='46' and @lqty>0)
				  begin
				    if @ltype='14'
					begin
				        set @costchg=@lavlcost
			  	 	    update stdtl set qty=@lttlqty where branch=@lbranch and trtype=@ltype and ref=@lref and folio=@lfolio
			       	    if @@error<>0
						begin
							rollback transaction
							set @errstatus=-1
							break
						end
					end
					else
					begin
						set @lttlqty=@lttlqty+@lqty
						if @lisbrtrx='0'
						set @costchg=0;
					end
				  end
				  else
				  begin
				    if @ltype<>'20'
					begin
			  			 if @ltype in ('05','24','26','20','13','12','46') 
						   set @lttlqty=@lttlqty+@lqty;
						 else
						  set @lttlqty=@lttlqty-@lqty;
					 end 
				  end
				  if  (@ltype in ('04','06','24','26','20','05','13','12','09') or (@ltype='46' and @lqty<0)) and @lisbrtrx='0'
				  begin
						update stdtl set lcost=(case when @costchg=0 then @llcost else  @costchg end)
						where branch=@lbranch and trtype=@ltype and ref=@lref and folio=@lfolio;
						if @@error<>0
						begin
							rollback transaction
							set @errstatus=-1
							break
						end
				  end
				   fetch next from crs1 into @lbranch,@litemno1,@lunicode1,@ltype,@lref,@lfolio,@lqty,@lavlcost,@lavfcost,@lisbrtrx;
	          end
              CLOSE crs1
              DEALLOCATE crs1
			  if @errstatus=-1
			    break;

			  if @costchg>0
			  begin
					update stunits set lcost=@costchg where itemno=@litemno and unicode=@lunicode;
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-1
						break
					end
			        update stbins set lcost=@costchg where itemno=@litemno and unicode=@lunicode;
			   		if @@error<>0
				    begin
						rollback transaction
						set @errstatus=-1
						break
				    end
			  end

			  commit transaction;
			  fetch next from crs0 into @litemno,@lunicode,@llcost,@lfcost;
		end
		 
		CLOSE crs0;
        DEALLOCATE crs0;
			 
--end
end













GO
/****** Object:  StoredProcedure [dbo].[pp_uncomplete]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[pp_uncomplete]
 @m_cmp char(2),
 @m_type char(2),
 @m_ref  numeric(6,0), 
 @pstmode bit,
 @lsrc char(2),
 @errcode char(4) output
	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.posted,trdate,src,AMNTTL,costttl,entries
	SET NOCOUNT ON
	declare @ljhamt numeric(20,7)=0,
	@lptr int =0,
	@phentries int=0,
	@lphamt numeric(20,7),
	@lcrttl numeric(20,7),
	@ldbttl numeric(20,7),
	@posted bit,
	@src char(2),
	@pptype numeric(1, 0),
	@cmp_socamt numeric(20,7),
	@ttlnet_salry numeric(20,7)

	set @errcode='';

 	select @posted=phposted,@lcrttl=phlc2ttl,@lphamt=phamt,@ldbttl=phlcttl,@src=phsrc,
	       @cmp_socamt=isnull(phcmp_socamt,CAST(0 as numeric(20,7))),@ttlnet_salry=isnull(phttlnet_salry, CAST(0 as numeric(20,7))),
		   @pptype=phpptype
	  from pphdr with (NOLOCK) where phcomp=@m_cmp AND phtype=@m_type AND phref=@m_ref;
    set @lptr=@@rowcount

    if  @src<>@lsrc
	begin
		set @errcode='124'
		return
	end	
	--K.A.N SEP 25,2021
	--if @lphamt<>@lcrttl or @lphamt<>@ldbttl or @ldbttl<>@lcrttl
	if @lphamt<>@lcrttl or ABS(@ldbttl+@cmp_socamt)-@lphamt>0.009 or ABS(@ldbttl+@cmp_socamt)-@lcrttl>0.009
	begin
		set @errcode='123'
		return
	end	

	declare @lc_db numeric(20,7),@lc_cr numeric(20,7)
    select @lptr=sum(1), @lc_db=sum(iif(pddbcr='D',pdlcamt,0)),@lc_cr=sum(iif(pddbcr='C',pdlcamt,0))
       from ppdtl with (NOLOCK) where 
	   pdcomp=@m_cmp AND pdtype=@m_type AND pdref=@m_ref
	if @@rowcount=0
	begin
		set @errcode='122'
		return
	end

	if (@ldbttl<>@lc_db AND @lc_db<>0)  OR (@lcrttl<>@lc_cr AND @lc_cr<>0)
	begin
		set @errcode='138'
		return
	end	
--	if dbo.value_balanced(@ldbttl,Iif(@lc_db<>0,@lc_db,@lc_cr))=0
--	begin
--		set @errcode='137'
--		return
--	end	
end













GO
/****** Object:  StoredProcedure [dbo].[pu_uncomplete]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-03-07@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[pu_uncomplete]
 @m_cmp char(2),
 @m_type char(2),
 @m_ref  int ,--numeric(6,0) 
 @errcode char(4) output
 
	
AS
BEGIN
----- Modified on 2024-03-06 AA convert @m_ref from numeric(6,0) to int
----- Added on 2023-12-15 AA this SP is included now in the system
----- Added on 2023-12-15 AA Added new codes for zatca rounding
----- Added on 2023-12-15 AA it is very old and modified it 
----- Added on 2023-12-15 AA will be updated auto through the system
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
	declare @lttl numeric(20,7)=0,
	@lptr int =0,
	@no_entries int=0,
	@lttlinv numeric(20,7),
	@lextamt numeric(20,7)
	set @errcode='';

---------------------------------
--------------- Added on 2023-12-11 AA ----------------------------------------------------------------------------------------------------------


	if COL_LENGTH('dbo.puhdr','zatca_rounding') is not null
	begin 
		with cte_a (entries,valafds,lpt,xttl) as
		(
		   select H.ENTRIES,H.valafds ,count(*) as lpt,sum(iif(h.zatca_rounding=1,qty*item_price_net,qty*(price-((price*discpc)/100))))  AS xTTL
		   from puhdr h with (NOLOCK) inner join pudtl b with (NOLOCK)
		   on h.company=b.company and h.invtype=b.invtype and h.ref=b.ref
		   WHERE h.COMPANY=@m_cmp AND h.INVTYPE=@m_type AND h.REF=@m_ref
		   GROUP BY entries,valafds
		)
		select @no_entries=entries,@lttlinv=valafds,@lptr=lpt,@lttl=xttl from cte_a ;
	end
	else
	begin
----------------------------------------------------------------------------------------------------------------------------------------------

		with cte_a (entries,valafds,lpt,xttl) as
		(
			select H.ENTRIES,H.valafds ,D.LPT,D.xTTL FROM puhdr H with (NOLOCK) INNER JOIN 
			(SELECT COMPANY,INVTYPE,REF,sum(qty*(price-((price*discpc)/100)))  AS xTTL,SUM(1) AS LPT 
			FROM pudtl with (NOLOCK) WHERE COMPANY=@m_cmp AND INVTYPE=@m_type AND REF=@m_ref
			GROUP BY COMPANY,INVTYPE,REF) AS D
			ON H.COMPANY=D.COMPANY AND H.INVTYPE=D.INVTYPE AND H.REF=D.REF
		)
		select @no_entries=entries,@lttlinv=valafds,@lptr=lpt,@lttl=xttl from cte_a ;
	end
	If @lptr<>@no_entries Or (@lptr=0 And @no_entries=0)
	set @errcode='140'
	if dbo.value_balanced(@lttl,@lttlinv)=0 
	 set @errcode='281'
end

GO
/****** Object:  StoredProcedure [dbo].[Re_Post_Replcated_Trx_4_GL_AR_AP]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[Re_Post_Replcated_Trx_4_GL_AR_AP]
 @errstatus int = 0 output
	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
---
-----------------------  Re post The Replicated GL transactions -------------------------------------------------
---
	declare @dbc nvarchar(13),
	        @sqlmsg nvarchar(max),
			@lcalcomp char(2),
			@yrcode char(4)

    declare @prd1_strt date,@prd1_end date,
	        @prd2_strt date,@prd2_end date,
			@prd3_strt date,@prd3_end date,
	        @prd4_strt date,@prd4_end date,
			@prd5_strt date,@prd5_end date,
	        @prd6_strt date,@prd6_end date,
			@prd7_strt date,@prd7_end date,
	        @prd8_strt date,@prd8_end date,
			@prd9_strt date,@prd9_end date,
			@prd10_strt date,@prd10_end date,
	        @prd11_strt date,@prd11_end date,
			@prd12_strt date,@prd12_end date,
			@yrend date,@calvlno int =4

	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)

    select @prd1_strt=cast(cal01 as date),@prd2_strt=cast(cal02 as date),@prd3_strt=cast(cal03 as date),
	@prd4_strt=cast(cal04 as date),@prd5_strt=cast(cal05 as date),@prd6_strt=cast(cal06 as date),
    @prd7_strt=cast(cal07 as date),@prd8_strt=cast(cal08 as date),@prd9_strt=cast(cal09 as date)
	,@prd10_strt=cast(cal10 as date),
	@prd11_strt=cast(cal11 as date),@prd12_strt=cast(cal12 as date),@yrend=cast(calend as date),@calvlno=calvlno
    from sysdb.dbo.glcalend where calcomp=@lcalcomp and yrcode=@yrcode

	set @prd1_end=DATEADD(DAY, -1, @prd2_strt) 
	set @prd2_end=DATEADD(DAY, -1, @prd3_strt)
	set @prd3_end=DATEADD(DAY, -1, @prd4_strt) 
	set @prd4_end=DATEADD(DAY, -1, @prd5_strt)
	set @prd5_end=DATEADD(DAY, -1, @prd6_strt) 
	set @prd6_end=DATEADD(DAY, -1, @prd7_strt)
	set @prd7_end=DATEADD(DAY, -1, @prd8_strt) 
	set @prd8_end=DATEADD(DAY, -1, @prd9_strt)
	set @prd9_end=DATEADD(DAY, -1, @prd10_strt)
	set @prd10_end=DATEADD(DAY, -1, @prd11_strt) 
	set @prd11_end=DATEADD(DAY, -1, @prd12_strt)
	set @prd12_end=@yrend

	begin transaction
;
	with cte_accts (glcomp,glkey,glcurrency)
	as 
	(select distinct jdcomp,jdkey,jdcurr from gljrhdr a inner join gljrdtl b
	 on a.jhcomp=b.jdcomp and a.jhtype=b.jdtype and a.jhref=b.jdref
	 where rcvdtrn=1 and modified=1 and jhposted=1
	 )

   update glchart set glcurbal=isnull(lc_bal,0)+glopnbal,fccurbal=isnull(fc_bal,0)+fcopnbal,
	       glbal01=isnull(prd1_bal,0),glbal02=isnull(prd2_bal,0),glbal03=isnull(prd3_bal,0),glbal04=isnull(prd4_bal,0),
		   glbal05=isnull(prd5_bal,0),glbal06=isnull(prd6_bal,0),glbal07=isnull(prd7_bal,0),glbal08=isnull(prd8_bal,0),
		   glbal09=isnull(prd9_bal,0),glbal10=isnull(prd10_bal,0),glbal11=isnull(prd11_bal,0),glbal12=isnull(prd12_bal,0),
	       fcbal01=isnull(fprd1_bal,0),fcbal02=isnull(fprd2_bal,0),fcbal03=isnull(fprd3_bal,0),fcbal04=isnull(fprd4_bal,0),
		   fcbal05=isnull(fprd5_bal,0),fcbal06=isnull(fprd6_bal,0),fcbal07=isnull(fprd7_bal,0),fcbal08=isnull(fprd8_bal,0),
		   fcbal09=isnull(fprd9_bal,0),fcbal10=isnull(fprd10_bal,0),fcbal11=isnull(fprd11_bal,0),fcbal12=isnull(fprd12_bal,0)
	from glchart t
	join 
	(select jdcomp,jdkey,jdcurr,
	prd1_bal=sum(iif(cast(jddate as date) between @prd1_strt and @prd1_end,iif(jddbcr='C',-jdlcamt,jdlcamt),0)),
	prd2_bal=sum(iif(cast(jddate as date) between @prd2_strt and @prd2_end,iif(jddbcr='C',-jdlcamt,jdlcamt),0)),
	prd3_bal=sum(iif(cast(jddate as date) between @prd3_strt and @prd3_end,iif(jddbcr='C',-jdlcamt,jdlcamt),0)),
	prd4_bal=sum(iif(cast(jddate as date) between @prd4_strt and @prd4_end,iif(jddbcr='C',-jdlcamt,jdlcamt),0)),
	prd5_bal=sum(iif(cast(jddate as date) between @prd5_strt and @prd5_end,iif(jddbcr='C',-jdlcamt,jdlcamt),0)),
	prd6_bal=sum(iif(cast(jddate as date) between @prd6_strt and @prd6_end,iif(jddbcr='C',-jdlcamt,jdlcamt),0)),
	prd7_bal=sum(iif(cast(jddate as date) between @prd7_strt and @prd7_end,iif(jddbcr='C',-jdlcamt,jdlcamt),0)),
	prd8_bal=sum(iif(cast(jddate as date) between @prd8_strt and @prd8_end,iif(jddbcr='C',-jdlcamt,jdlcamt),0)),
	prd9_bal=sum(iif(cast(jddate as date) between @prd9_strt and @prd9_end,iif(jddbcr='C',-jdlcamt,jdlcamt),0)),
	prd10_bal=sum(iif(cast(jddate as date) between @prd10_strt and @prd10_end,iif(jddbcr='C',-jdlcamt,jdlcamt),0)),
	prd11_bal=sum(iif(cast(jddate as date) between @prd11_strt and @prd11_end,iif(jddbcr='C',-jdlcamt,jdlcamt),0)),
	prd12_bal=sum(iif(cast(jddate as date) between @prd12_strt and @prd12_end,iif(jddbcr='C',-jdlcamt,jdlcamt),0)),
	lc_bal=sum(iif(jddbcr='C',-jdlcamt,jdlcamt)),
	fprd1_bal=sum(iif(cast(jddate as date) between @prd1_strt and @prd1_end,iif(jddbcr='C',-jdfcamt,jdfcamt),0)),
	fprd2_bal=sum(iif(cast(jddate as date) between @prd2_strt and @prd2_end,iif(jddbcr='C',-jdfcamt,jdfcamt),0)),
	fprd3_bal=sum(iif(cast(jddate as date) between @prd3_strt and @prd3_end,iif(jddbcr='C',-jdfcamt,jdfcamt),0)),
	fprd4_bal=sum(iif(cast(jddate as date) between @prd4_strt and @prd4_end,iif(jddbcr='C',-jdfcamt,jdfcamt),0)),
	fprd5_bal=sum(iif(cast(jddate as date) between @prd5_strt and @prd5_end,iif(jddbcr='C',-jdfcamt,jdfcamt),0)),
	fprd6_bal=sum(iif(cast(jddate as date) between @prd6_strt and @prd6_end,iif(jddbcr='C',-jdfcamt,jdfcamt),0)),
	fprd7_bal=sum(iif(cast(jddate as date) between @prd7_strt and @prd7_end,iif(jddbcr='C',-jdfcamt,jdfcamt),0)),
	fprd8_bal=sum(iif(cast(jddate as date) between @prd8_strt and @prd8_end,iif(jddbcr='C',-jdfcamt,jdfcamt),0)),
	fprd9_bal=sum(iif(cast(jddate as date) between @prd9_strt and @prd9_end,iif(jddbcr='C',-jdfcamt,jdfcamt),0)),
	fprd10_bal=sum(iif(cast(jddate as date) between @prd10_strt and @prd10_end,iif(jddbcr='C',-jdfcamt,jdfcamt),0)),
	fprd11_bal=sum(iif(cast(jddate as date) between @prd11_strt and @prd11_end,iif(jddbcr='C',-jdfcamt,jdfcamt),0)),
	fprd12_bal=sum(iif(cast(jddate as date) between @prd12_strt and @prd12_end,iif(jddbcr='C',-jdfcamt,jdfcamt),0)),
	fc_bal=sum(iif(jddbcr='C',-jdfcamt,jdfcamt)) from gljrhdr a inner join gljrdtl b inner join cte_accts c
	on b.jdcomp=c.glcomp and b.jdkey=c.glkey and b.jdcurr=c.glcurrency
	on a.jhcomp=b.jdcomp and a.jhtype=b.jdtype and a.jhref=b.jdref
	where jhposted=1 
	group by jdcomp,jdkey,jdcurr
	) s
	on t.glcomp=s.jdcomp and t.glkey=s.jdkey and t.glcurrency=s.jdcurr
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-1	
		return			
	end

	update gljrhdr set modified=0 where jhposted=1 and modified=1 and rcvdtrn=1
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-2	
		return			
	end
	commit transaction
------------------------------------------------------------------------------------------------------------------
--
---                 Re Post Replicated transactions For customers 
--
    begin transaction
;
	with cte_custx (cu_company,cu_code,cf_fcy)
	as 
	(select distinct dt_company,dt_cucode,dt_fcy from arhdr a inner join ardtl b
	 on a.hd_company=b.dt_company and a.hd_type=b.dt_type and a.hd_ref=b.dt_ref
	 where rcvdtrn=1 and modified=1 and hd_posted=1 and rtrim(dt_cucode)<>'')
	 
	update customer set cu_curbal=cu_opnbal+isnull(lc_bal,0),cf_curfcy=cf_opnfcy+isnull(fc_bal,0)
	from customer t
	join 
	(
	select dt_company,dt_cucode,dt_fcy,
	lc_bal=sum(iif(dt_dbcr='C',-(dt_lcamt-dt_paidamt-dt_discamt),dt_lcamt-dt_paidamt-dt_discamt)),
	fc_bal=sum(iif(dt_dbcr='C',-(dt_fcamt-dt_fpydamt-dt_fdscamt),dt_fcamt-dt_fpydamt-dt_fdscamt))
	from arhdr a inner join ardtl b inner join cte_custx c
	on b.dt_company=c.cu_company and b.dt_cucode=c.cu_code and b.dt_fcy=c.cf_fcy
	on a.hd_company=b.dt_company and a.hd_type=b.dt_type and a.hd_ref=b.dt_ref
	where hd_posted=1
	group by dt_company,dt_cucode,dt_fcy) s
	on t.cu_company=s.dt_company and t.cu_code=s.dt_cucode and t.cf_fcy=s.dt_fcy
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-3
		return				
	end

	update arhdr set modified=0 where hd_posted=1 and modified=1 and rcvdtrn=1
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-4	
		return			
	end
	commit transaction
--
---                 Re Post Replicated transactions For Suppliers 
--
    begin transaction
;
	with cte_supp (cu_company,cu_code,cf_fcy)
	as 
	(select distinct dt_company,dt_cucode,dt_fcy from aphdr a inner join apdtl b
	 on a.hd_company=b.dt_company and a.hd_type=b.dt_type and a.hd_ref=b.dt_ref
	 where rcvdtrn=1 and modified=1 and hd_posted=1 and rtrim(dt_cucode)<>'')
	 
	update Supplier set cu_curbal=cu_opnbal+isnull(lc_bal,0),cf_curfcy=cf_opnfcy+isnull(fc_bal,0)
	from Supplier t
	join 
	(
	select dt_company,dt_cucode,dt_fcy,
	lc_bal=sum(iif(dt_dbcr='C',-(dt_lcamt-dt_paidamt-dt_discamt),dt_lcamt-dt_paidamt-dt_discamt)),
	fc_bal=sum(iif(dt_dbcr='C',-(dt_fcamt-dt_fpydamt-dt_fdscamt),dt_fcamt-dt_fpydamt-dt_fdscamt))
	from aphdr a inner join apdtl b inner join cte_supp c
	on b.dt_company=c.cu_company and b.dt_cucode=c.cu_code and b.dt_fcy=c.cf_fcy
	on a.hd_company=b.dt_company and a.hd_type=b.dt_type and a.hd_ref=b.dt_ref
	where hd_posted=1
	group by dt_company,dt_cucode,dt_fcy) s
	on t.cu_company=s.dt_company and t.cu_code=s.dt_cucode and t.cf_fcy=s.dt_fcy
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return				
	end

	update aphdr set modified=0 where hd_posted=1 and modified=1 and rcvdtrn=1
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-6	
		return			
	end
	commit transaction
end












GO
/****** Object:  StoredProcedure [dbo].[remove_DBC_column_Constraint]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-10-03@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[remove_DBC_column_Constraint]

 @lcolumn_name nvarchar(30),
 @ltable_name  nvarchar(30),
 @lDATA_TYPE  nvarchar(30),
 @errstatus int = 0  output ,
 @scale_precision_val int	
AS
BEGIN
----- Added on 2024-10-02 AA resize the datatype of @table_name paramter to 30
----- Added on 2024-10-02 AA resize the datatype of @column_name paramter to 30
----- Added on 2023-07-12 AA to convert varchar(MAX) to varchar(nnn)
----- Added on 2022-09-09 AA to change the size of varchar type
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
		SET NOCOUNT ON
--        declare 1
    DECLARE @ConstraintName nvarchar(200),@lcommand nvarchar(200),
	@action_type char(1)='',
	@s_p_len int=0,
	@select_result bit =0

	if @scale_precision_val>0
	begin
	    set @action_type=substring(cast(@scale_precision_val as varchar(10)),1,1)
		set @s_p_len=cast(substring(cast(@scale_precision_val as varchar(10)),2,8) as int)
	end
	else 
---  Added on 2023-07-12 AA Einvphs2 
	if @scale_precision_val<0
	begin
	   set @action_type='4'
	   set @s_p_len=-1
	end
----------------------------------
	set  @errstatus =0;
	
	if @action_type=''  -- convert from numeric to float 
	begin
          if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME =  @ltable_name 
		    and COLUMN_NAME=@lcolumn_name AND DATA_TYPE=@lDATA_TYPE) set @select_result=1 
	end
	else 
	if @action_type='1'  -- Check the numeric scale size 
	begin
          if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME =  @ltable_name 
		    and COLUMN_NAME=@lcolumn_name AND DATA_TYPE=@lDATA_TYPE and NUMERIC_SCALE=@s_p_len) set @select_result=1 	
	end 
	else
	if @action_type='2'  -- Check the numeric PRECISION size 
	begin
          if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME =  @ltable_name 
		    and COLUMN_NAME=@lcolumn_name AND DATA_TYPE=@lDATA_TYPE and NUMERIC_PRECISION=@s_p_len) set @select_result=1 	
	end 
----- Added on 2022-09-09 AA to change the size of varchar type 
	if @action_type='4'  --  
	begin
          if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME =  @ltable_name 
		    and COLUMN_NAME=@lcolumn_name AND DATA_TYPE=@lDATA_TYPE and CHARACTER_MAXIMUM_LENGTH=@s_p_len) set @select_result=1 	
	end 
	if @select_result=1
	begin
		SELECT @ConstraintName = Name FROM SYS.DEFAULT_CONSTRAINTS WHERE PARENT_OBJECT_ID = OBJECT_ID(@ltable_name)
		AND PARENT_COLUMN_ID = (SELECT column_id FROM sys.columns WHERE NAME = @lcolumn_name AND
		[object_id] = OBJECT_ID(@ltable_name))
		IF @ConstraintName IS NOT NULL
		begin
			set @lcommand='ALTER TABLE [dbo].'+@ltable_name+' drop  CONSTRAINT '+@ConstraintName
			exec sp_executesql @lcommand
			if @@error<>0
			begin
				set @errstatus=-1					 		
			end
		end
	end
	else set  @errstatus=-2
	return @errstatus
end


GO
/****** Object:  StoredProcedure [dbo].[Repost_trx_bld_balcost]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[Repost_trx_bld_balcost]
   @errstatus int = 0 output
	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
-- 
-- This section is used to addup new entries for stbins
--
declare @lcurbal numeric(12,3) ,
        @lrunbal numeric(12,3),
        @inbal numeric(12,3),
        @lopenbal numeric(12,3),
		@llprice numeric (12,3),
		@llcost float,
		@lfcost float,
		@lopenlcost float,
		@lopenfcost float,
		@trxlcost float,
		@trxfcost float,
		@trxqty numeric(13,3),
		@lbranch char(2),
        @litemno char(16),
		@lunicode char(6) ,
		@lwhno char(2) ,
		@lbinno char(6),
		@lttlqty numeric(13,3)=0,
		@lmnopenlcost float,
		@stk_lcost float,
		@costchg int=0,
		@lastcost float,
		@stk_fcost float,
		@lmnopenfcost float


	if not exists(select count(*) from sthdr with (NOLOCK) where repost=1)
	return
---
---   Prepair for deletion and updating to openbal vaalues
---
      
		begin transaction
		delete from stbins where openbal=0 and openlcost=0 
		if @@error<>0
			begin
			  rollback transaction
			  set @errstatus=-1		
			  return		 
			end
		
		update stbins set qty=openbal,lcost=openlcost,fcost=openfcost where 
		exists(select distinct itemno from sthdr k with (NOLOCK) inner join stdtl h with (NOLOCK)
		    on k.branch=h.branch and k.trtype=h.trtype and k.ref=h.ref
		where stbins.itemno=h.itemno and stbins.unicode=h.unicode 
		and posted=1 and repost=1)
		if @@error<>0
			begin
			  rollback transaction
			  set @errstatus=-1		
			  return		 
			end
			
		update stunits set curbal=openbal,lcost=openlcost,fcost=openfcost where 
		exists(select distinct itemno from sthdr k  with (NOLOCK) inner join stdtl h with (NOLOCK)
		    on k.branch=h.branch and k.trtype=h.trtype and k.ref=h.ref
		where stunits.itemno=h.itemno and stunits.unicode=h.unicode 
		and posted=1 and repost=1)
		if @@error<>0
			begin
			  rollback transaction
			  set @errstatus=-1		
			  return		 
			end
		commit transaction
-----------------------------------------------------------------------------------------------
     begin transaction
		merge stbins as t
		using (select distinct branch,a.itemno,a.unicode,whno,binno from stdtl a inner join stunits b 
		   on a.itemno=b.itemno and a.unicode=b.unicode
		   inner join stitems c
		   on b.itemno=c.itemno
		where c.itemtype not in ('5','6') and exists(select distinct itemno from sthdr k  with (NOLOCK) inner join stdtl h with (NOLOCK)
		    on k.branch=h.branch and k.trtype=h.trtype and k.ref=h.ref
		where b.itemno=h.itemno and b.unicode=h.unicode and posted=1 and repost=1)) as s
		on t.branch=s.branch and t.itemno=s.itemno and t.unicode=s.unicode and t.whno=s.whno and t.binno=s.binno
		when not matched then
			insert values (s.branch,s.itemno,s.unicode,s.whno,s.binno,0,0,0,0,0,0,0,'');
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-1	
				return --@errstatus			 				
			end
			else commit transaction
		  if @errstatus<0 
		  return 
	
-----------------------------------------------------------------------------------------------
--  Building stbins items qty balances & cost
--
     declare @ltrtype char(2),
	         @ltrdate char(8),
	         @lref numeric(6,0),
			 @lqty numeric (15,4),
			 @lfolio int,
			 @lisbrtrx bit,
			 @lrcvdtrn bit,
			 @lposted bit,
			 @ltowhno char(2),
			 @ltobinno char(6),
			 @lfcy char(3),
			 @lfcyrate numeric(10,5),
			 @ttp int,
			 @dont_check_cost int=0,
			 @xdate char(8);
     set @errstatus=0;
     DECLARE crs0 CURSOR LOCAL FAST_FORWARD FOR
     select branch,a.itemno,a.unicode,whno,binno,a.openbal,a.openlcost,a.openfcost,b.fcy,c.openlcost as mnopenlcost,
	 c.openfcost as mnopenfcost from stbins a inner join stunits c 
	 on a.itemno=c.itemno and a.unicode=c.unicode
	 inner join stitems b
	 on c.itemno=b.itemno 
     where exists(select distinct itemno from sthdr k  with (NOLOCK) inner join stdtl h with (NOLOCK)
		    on k.branch=h.branch and k.trtype=h.trtype and k.ref=h.ref
		where a.itemno=h.itemno and a.unicode=h.unicode 
		and posted=1 and repost=1)
	 order by itemno;
	
	 
  	 open crs0;

------------------------------------
		fetch next from crs0 into @lbranch,@litemno,@lunicode,@lwhno,@lbinno,@lopenbal,@lopenlcost,@lopenfcost,@lfcy,
		@lmnopenlcost,@lmnopenfcost;

		begin transaction
		WHILE dbo.FetchStatusOfCursorNamed('crs0') = 0
        BEGIN
		    set @lrunbal=@lopenbal
			set @dont_check_cost=0
			set @stk_lcost=@lopenlcost
	--		print '******************'+' '+str(@stk_lcost)+' '+@litemno+' '+@lwhno
			set @stk_fcost=@lopenfcost
			if @stk_lcost=0 and @lmnopenlcost>0 set @stk_lcost=@lmnopenlcost 
			if @stk_fcost=0 and @lmnopenfcost>0 set @stk_fcost=@lmnopenfcost 
            DECLARE crs1 CURSOR LOCAL FAST_FORWARD FOR
			select a.trtype,a.ref,a.folio,qty+fqty as qty,lcost,fcost,isbrtrx,posted,a.towhno,a.tobinno,fcyrate,a.trdate,
			rcvdtrn
			from sthdr b inner join stdtl a
	    	on b.branch=a.branch and b.trtype=a.trtype and b.ref=a.ref 
	    	where a.branch=@lbranch and a.itemno=@litemno and a.unicode=@lunicode and a.whno=@lwhno and binno=@lbinno
			order by a.trdate ,Iif(a.trtype in ('10','11','01','13','46','12','14') Or 
			(a.trtype='20' And a.towhno<>''),'01','02'),a.ref,folio 
			open crs1;

			fetch next from crs1 into @ltrtype,@lref,@lfolio,@lqty,@llcost,@lfcost,@lisbrtrx,@lposted,@ltowhno
			,@ltobinno,@lfcyrate,@ltrdate,@lrcvdtrn;

			WHILE dbo.FetchStatusOfCursorNamed('crs1') = 0
            BEGIN
			    set @trxlcost=0
			    set @ttp=cast(@ltrtype as int)
				if @lposted=1
				begin
				   if @ttp in (4,6,9,30,31,2)
				   begin
				       set @lrunbal=@lrunbal-@lqty
				   end
				   if @ttp in (5,24,26,13,12) or (@ttp=46 And @lqty<0)  
				   begin
				       set @lrunbal=@lrunbal+@lqty
                       If @lqty>0 And @stk_lcost=0 
					   begin  
                         set @stk_lcost=@llcost
                         set @stk_fcost=@lfcost
                       end
				   end
				   if @ttp in (1,10,11) or (@ttp=46 And @lqty>0) 
				   begin
				      if @lrunbal>0
					  begin
					      set @stk_lcost=Abs(((@stk_lcost*@lrunbal)+Abs(@lqty*@llcost))/(@lrunbal+@lqty))
						  if isnull(@lfcost,0)<>0 
						       set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*@lfcost))/(@lrunbal+@lqty))
						  else if isnull(@lfcy,'')<>'' and isnull(@lfcyrate,0)<>0
						       set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*(@lfcost/@lfcyrate)))/(@lrunbal+@lqty))
					  end
					  else
					  begin
					     set @stk_lcost=@llcost
						 set @stk_fcost=@lfcost
					  end
					  set @lrunbal=@lrunbal+@lqty
				   end
                   if @ttp=20
				   begin
				       if rtrim(@ltowhno)=''
					   begin
						   if @stk_lcost=0
						   begin
							 set @stk_lcost=@llcost
							 set @stk_fcost=@lfcost
						   end
						   else
						   if @lrunbal>0
						   begin
							   set @stk_lcost=Abs(((@stk_lcost*@lrunbal)+Abs(@lqty*@llcost))/(@lrunbal+@lqty))
							   if isnull(@lfcost,0)<>0 
								   set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*@lfcost))/(@lrunbal+@lqty))
						   end
						   else
						   begin
							 set @stk_lcost=@llcost
							 set @stk_fcost=@lfcost
						   end
					   end
				       set @lrunbal = @lrunbal + Iif(rtrim(@ltowhno)<>'',-@lqty,@lqty)
				   end
				   if @ttp=14
				   begin
					   set @stk_lcost=@llcost
					   set @stk_fcost=@lfcost
				   end
			    end  -- end of @lposted
--
---------- beginning of stdtl lcost update
--
		--		print 'dd'+' '+str(@stk_lcost)+' type='+@ltrtype+' ref='+str(@lref)+' '+@litemno
				If not (@ttp in (1,10,11,14,30,31) or (@ttp=46 And @lqty>0) or (@lrcvdtrn=1 and @lisbrtrx=1)
				or (@lposted=1 and @lisbrtrx=1))
				begin
				    if @stk_lcost=0 and  @dont_check_cost<3  ----runbal<0 And !okpurchaseinvoice And !T_NOT_POSTED.
					begin
						if @ttp<>'20'
						begin
						     set @dont_check_cost +=1
							 set @xdate=@ltrdate
							 Select top 1 @trxlcost=lcost,@trxfcost=fcost,@trxqty=qty+fqty From stdtl where
							 branch=@lbranch and itemno=@litemno and unicode=@lunicode and whno=@lwhno and
							 binno=@lbinno and --trdate>=@xdate and 
							 (trtype in ('01','10','11') or (trtype='46' And qty>0) or (trtype='20' And @ltowhno=''))
							 order by trdate,iif(trtype in ('01','10','11'),1,2)

							 if isnull(@trxlcost,0)=0
							 begin
							     set @dont_check_cost +=1
								 Select top 1 @trxlcost=lcost,@trxfcost=fcost From stdtl where
								 branch=@lbranch and itemno=@litemno and unicode=@lunicode and whno=@lwhno
								  and --trdate>=@xdate and 
								 (trtype in ('01','10','11') or (trtype='46' And qty>0) or (trtype='20' And @ltowhno=''))
								 order by trdate,iif(trtype in ('01','10','11'),1,2)
								 --print '3'+str(isnull(@trxlcost,0))+' type='+@ltrtype+' ref='+str(@lref)
								 if isnull(@trxlcost,0)=0 --is null
								 begin
								     set @dont_check_cost +=1
									 Select top 1 @trxlcost=lcost,@trxfcost=fcost From stdtl where
									 branch=@lbranch and itemno=@litemno and unicode=@lunicode 
									  and  
									 (trtype in ('01','10','11') or (trtype='46' And qty>0) or 
									 (trtype='20' And @ltowhno=''))
									 order by trdate,iif(trtype in ('01','10','11'),1,2)
									 if isnull(@trxlcost,0)=0 --is null
									 begin
										 set @dont_check_cost +=1
										 Select top 1 @trxlcost=lcost,@trxfcost=fcost From stdtl where
										 itemno=@litemno and unicode=@lunicode 
										  and  
										 (trtype in ('01','10','11') or (trtype='46' And qty>0)) 
										 order by trdate,iif(trtype in ('01','10','11'),1,2),stdtl.ref,folio
									 end
								 end
							 end
						end
						else
						if @ttp=20 and rtrim(@ltowhno)<>''
						begin
							 set @xdate=@ltrdate
							 Select top 1 @trxlcost=lcost,@trxfcost=fcost,@trxqty=qty+fqty From stdtl where
							 branch=@lbranch  and itemno=@litemno and unicode=@lunicode and whno=@lwhno and
							 binno=@lbinno and trdate>=@xdate and 
							 (trtype in ('01','10','11') or (trtype='46' And qty>0))
							 order by trdate,iif(trtype in ('01','10','11'),1,2)
						end
						if not(@ttp=20 and rtrim(@ltowhno)='')
						begin
							if isnull(@trxlcost,0)>0
							begin
								set @stk_lcost=@trxlcost
								set @stk_fcost=isnull(@trxfcost,0)
							end
						end
						--print '5'+str(@stk_lcost)+' type='+@ltrtype+' ref='+str(@lref)+'  '+@litemno
					end  -- end of @stk_lcost=0
					if not(@ttp=20 and rtrim(@ltowhno)='')
					begin
					    if @stk_lcost>0 
						begin
						   -- print '6'+str(@stk_lcost)+' type='+@ltrtype+' ref='+str(@lref)+'  '+@litemno
						    update stdtl set lcost=@stk_lcost,fcost=@stk_fcost where branch=@lbranch and trtype=@ltrtype and
							ref=@lref and folio=@lfolio
			         	    if @@error<>0
						    begin
							    rollback transaction
							    set @errstatus=-1
							    break
						    end
						end 
					end
					if @ttp=20 and rtrim(@ltowhno)<>''
					begin
					    if @stk_lcost>0
						    update stdtl set lcost=@stk_lcost,fcost=@stk_fcost where branch=@lbranch and trtype=@ltrtype and
						    ref=@lref and itemno=@litemno and unicode=@lunicode and whno=@ltowhno and binno=@ltobinno
						else
					       update stdtl set lcost=@llcost,fcost=@lfcost where branch=@lbranch and trtype=@ltrtype and
						   ref=@lref and itemno=@litemno and unicode=@lunicode and whno=@ltowhno and binno=@ltobinno
			         	if @@error<>0
						begin
							rollback transaction
							set @errstatus=-1
							break
						end
					end
				end -- end of stdtl lcost update
				fetch next from crs1 into @ltrtype,@lref,@lfolio,@lqty,@llcost,@lfcost,@lisbrtrx,@lposted,@ltowhno
			    ,@ltobinno,@lfcyrate,@ltrdate,@lrcvdtrn;
			end  -- end of crs1 inner loop
            CLOSE crs1
            DEALLOCATE crs1
			if @errstatus=-1
			break;

------------------------------------------------------

-----
------          update stbins qty & lcost
------

            if @lrunbal<>0 and  @stk_lcost=0
			if exists(SELECT table_name  FROM INFORMATION_SCHEMA.tables with (NOLOCK)  WHERE TABLE_NAME = 'stcosttype')
			begin
			    select @trxlcost=lastlcost,@trxfcost=lastfcost from stcosttype 
				where branch=@lbranch  and itemno=@litemno and unicode=@lunicode
				if isnull(@trxlcost,0)>0
				begin
					set @stk_lcost=@trxlcost
					set @stk_fcost=isnull(@trxfcost,0)
				end
			end
/*
			else
			begin --- look for lcost in Branch + itemno +whno
				Select top 1 @trxlcost=lcost,@trxfcost=fcost From stdtl where
				branch=@lbranch  and itemno=@litemno and unicode=@lunicode and whno=@lwhno and
				(trtype in ('01','10','11') or (trtype='46' And qty>0) or (trtype='20' And @ltowhno=''))
				order by trdate desc,iif(trtype in ('01','10','11'),1,2)

				if isnull(@trxlcost,0)>0  --@trxlcost is not null
				begin
					set @stk_lcost=@trxlcost
					set @stk_fcost=isnull(@trxfcost,0)
				end
				else
				begin  -- look for lcost in the branch + itemno
					Select top 1 @trxlcost=lcost,@trxfcost=fcost From stdtl where
					branch=@lbranch  and itemno=@litemno and unicode=@lunicode and 
					(trtype in ('01','10','11') or (trtype='46' And qty>0) or (trtype='20' And @ltowhno=''))
					order by trdate desc,iif(trtype in ('01','10','11'),1,2)
					if isnull(@trxlcost,0)>0
					begin
						set @stk_lcost=@trxlcost
						set @stk_fcost=isnull(@trxfcost,0)
					end
				end
			end
*/
			  if @stk_lcost=0
			  if @lopenlcost>0 
			  begin
			       set @stk_lcost=@lopenlcost
				   set @stk_fcost=@lopenfcost
			  end
			  else if @lmnopenlcost>0
			  begin
			       set @stk_lcost=@lmnopenlcost
				   set @stk_fcost=@lmnopenfcost
			  end

            update stbins set qty=@lrunbal,lcost=@stk_lcost,fcost=@stk_fcost where 
			branch=@lbranch and itemno=@litemno and unicode=@lunicode and whno=@lwhno and binno=@lbinno
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-1
				break
			end
			fetch next from crs0 into @lbranch,@litemno,@lunicode,@lwhno,@lbinno,@lopenbal,@lopenlcost,@lopenfcost,@lfcy,
			@lmnopenlcost,@lmnopenfcost;
		end  -- end of crs0 ourter loop
		CLOSE crs0;
        DEALLOCATE crs0;
		if @errstatus=-1 
		begin
		    rollback transaction
			return
	    end
		else commit transaction
---
----------------  Update stunits curbal & lcost
---

       begin transaction
	   update stunits set curbal=xcurbal,lcost=iif(xcurbal<>0,ttllcost/xcurbal,iif(lcost<>0,lcost,xxlcost)),
	   fcost=iif(xcurbal<>0,ttlfcost/xcurbal,iif(fcost<>0,fcost,xxfcost))
	   from stunits as v
	   join
	   (select itemno,unicode,xcurbal=sum(qty),ttllcost=sum(qty*lcost),ttlfcost=sum(qty*isnull(fcost,0)),
	    xxlcost=avg(iif(qty=0 and lcost>0,lcost,0)),xxfcost=avg(iif(qty=0 and fcost>0,fcost,0))
	    from stbins
		where  exists(select distinct itemno from sthdr k with (NOLOCK) inner join stdtl h with (NOLOCK)
		    on k.branch=h.branch and k.trtype=h.trtype and k.ref=h.ref
		where stbins.itemno=h.itemno and stbins.unicode=h.unicode and posted=1 and repost=1)
	    group by itemno,unicode) c
		on v.itemno=c.itemno and v.unicode=c.unicode
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-1
			return --@errstatus
		end
		commit transaction

		begin transaction
		update sthdr set repost=0 where repost=1 and posted=1
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-31
			return --@errstatus
		end
		commit transaction
--		
-- take care of the lcost of the  transaction between branches in stdtl only in the branch who initiate the transaction
-- which mean skip those transactions that replicate to other branch
--
		--begin transaction
		--update stdtl set lcost=llcost,fcost=lfcost
		--from stdtl v
		--join 
		--  (select a.tobrno as branch,'01' as trtype,a.brxref as ref,folio,llcost=lcost,lfcost=fcost from sthdr a inner join stdtl b 
		--		on a.branch=b.branch and a.trtype=b.trtype and a.ref=b.ref where isbrtrx = 1 and rcvdtrn=0 and posted=0 and b.trtype='09'
		--   ) c
		--   on v.branch=c.branch and v.trtype=c.trtype and v.ref=c.ref and v.folio=c.folio
		--   where v.trtype='01'
		--if @@error<>0
		--begin
		--	rollback transaction
		--	set @errstatus=-7
		--	return --@errstatus
		--end
		--commit transaction		
end













GO
/****** Object:  StoredProcedure [dbo].[rtn_cursor]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[rtn_cursor]
 @STR_MSG NVARCHAR(1000) OUT,
 @errstatus int output,
 @PdaTtk XML
	
AS
BEGIN

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	


	BEGIN TRY
 		DECLARE @handle INT		
				
		--declare @PdaTtk XML

		--SET @PdaTtk=@xmldoc
	    SET @errstatus=0
		set @STR_MSG =''
		IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'#TEMP_PDA') AND type in (N'U'))
		DROP TABLE [#TEMP_PDA]
		
		EXEC sp_xml_preparedocument @handle OUTPUT, @PdaTtk
		
		select  err_no,err_lmsg,err_amsg
		into #TEMP_PDA FROM OPENXML (@handle, '/VFPData/sldtl', 2) WITH
		(err_no CHAR(5),
		err_lmsg varchar(100) ,
		err_amsg varchar(100))	
					
		EXEC sp_xml_removedocument @handle 
		

		select * from  #TEMP_PDA
		 
		IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'#TEMP_PDA'))
		DROP TABLE [#TEMP_PDA]

		--return @errstatus  
	END TRY
	BEGIN CATCH
		SET @STR_MSG ='ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()  
				
		set @errstatus = -2
			
		IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'#TEMP_PDA'))
		DROP TABLE [#TEMP_PDA]
			--return @errstatus
	END CATCH
 end











GO
/****** Object:  StoredProcedure [dbo].[sd_uncomplete]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[sd_uncomplete]
 @m_cmp char(2),
 @trx_type char(2),
 @m_ref  numeric(6,0), 
 @errcode char(4) output,
 @ttype char(2)
 
	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
	declare @lttl numeric(20,7)=0,
	@lptr int =0,
	@m_type char(2)='01',
	@lsdamount numeric(20,7)=0,
	@lttlamt numeric(20,7),
	@lttldtl numeric(20,7),
	@lsdttlvatamt numeric(20,7)=0,  --K.A.N 2021-02-19
	@ldtlvat numeric(20,7)=0        --K.A.N 2021-02-19

	set @errcode='';


	if @trx_type='01'    -- Sadaad Transaction
	begin
		with cte_a (sdamount,sdttlamt,sdttlvatamt,lpt,xttl,xllvat) as
		(
			select H.sdamount,H.sdttlamt,H.sdttlvatamt,D.LPT,D.xTTL,D.xllvat FROM sdaad_hd H with (NOLOCK) INNER JOIN 
			(SELECT COMPANY,sdTYPE,REF,sum(sdamount) AS xTTL,sum(vat_amt_paid) as xllvat,SUM(1) AS LPT 
			FROM sdaad_dt with (NOLOCK) WHERE COMPANY=@m_cmp AND sdTYPE=@m_type AND REF=@m_ref
			GROUP BY COMPANY,sdTYPE,REF) AS D
			ON H.COMPANY=D.COMPANY AND H.sdTYPE=D.sdTYPE AND H.REF=D.REF
		)
		select @lsdamount=sdamount,@lsdttlvatamt=sdttlvatamt,@lttlamt=sdttlamt,@lptr=lpt,@lttldtl=xttl,
		       @ldtlvat=xllvat from cte_a ;

		If @lptr=0 	set @errcode='140'
		if dbo.value_balanced(@lsdamount,@lttlamt+@lsdttlvatamt)=0 or dbo.value_balanced(@lsdamount,@lttldtl+@ldtlvat)=0
		set @errcode='281'
	 end
	 else
	 begin
	    declare 
		@lttldb numeric(20,7),
		@lttlcr numeric(20,7),
		@lhd_lcnet numeric(20,7),
		@lhd_lccnet numeric(20,7);

		if @trx_type='02' set @m_type='01'
		else if isnull(@ttype,'')<>'' set @m_type=@ttype;

		with cte_a (hd_ltotal,hd_lcnet,hd_lccnet,lpt,xttldb,xttlcr) as
		(
			select H.hd_ltotal,H.hd_lcnet,h.hd_lccnet ,D.LPT,D.xTTLdb,xTTLcr FROM sdhdr H with (NOLOCK) INNER JOIN 
			(SELECT dt_COMPANY,dt_TYPE,dt_REF,sum(iif(dt_dbcr='D',dt_lcamt,cast(0 as float)))  AS xTTLdb,
			sum(iif(dt_dbcr='C',dt_lcamt,cast(0 as float)))  AS xTTLcr,SUM(1) AS LPT 
			FROM sddtl with (NOLOCK) WHERE dt_COMPANY=@m_cmp AND dt_TYPE=@m_type AND dt_REF=@m_ref
			GROUP BY dt_COMPANY,dt_TYPE,dt_REF) AS D
			ON H.hd_COMPANY=D.dt_COMPANY AND H.hd_TYPE=D.dt_TYPE AND H.hd_REF=D.dt_REF
		)
		select @lttlamt=hd_ltotal,@lhd_lcnet=hd_lcnet,@lhd_lccnet=hd_lccnet,
		@lptr=lpt,@lttldb=xttldb,@lttlcr=xttlcr from cte_a ;

		If @lptr=0 	set @errcode='140'
		if dbo.value_balanced(@lhd_lcnet,@lttlamt)=0 or dbo.value_balanced(@lhd_lcnet,@lhd_lccnet)=0
		or dbo.value_balanced(@lttldb,@lttlcr)=0 or dbo.value_balanced(@lttldb,@lttlamt)=0 
		set @errcode='281'
	 end
end











GO
/****** Object:  StoredProcedure [dbo].[Send_email_4_reorder_items]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[Send_email_4_reorder_items]
AS
BEGIN
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
	SET NOCOUNT ON
	declare @cmp char(2),
        @lslcode char(2),
		@lslname varchar(40),
		@lnotify_within int,
		@lslemail varchar(60),
		@errstatus int = 0,
		@branch_name varchar(50)='',		
		@RtnCode int=0,
		@ErrorID INT=0,
		@no_of_items int=0,
		@yrcode int,
		@lsalesmen cursor ;
	DECLARE @tableHTML  NVARCHAR(MAX);
	set @yrcode=cast(substring(db_name(),7,2) as int)

	set @lsalesmen = cursor for 		
	select slcompany,slcode,notify_within,slemail,slname from salesmen where purshman=1 and notify_type=2 
	and isnull(notify_within,0)>0 and not (slemail is null or slemail='')
	order by slcompany,slcode
 
	open @lsalesmen;
	fetch next from @lsalesmen into @cmp,@lslcode,@lnotify_within,@lslemail,@lslname

	WHILE @@FETCH_STATUS = 0
	BEGIN
		select @branch_name=name from stbranch where brnno=@cmp
		select @no_of_items=count(*) 
			from  dbc01y36.dbo.puprsnitems a inner join dbc01y36.dbo.stcosttype b inner join dbc01y36.dbo.stunits e 
			inner join dbc01y36.dbo.stitems c 
			inner join dbc01y36.dbo.supplier d
			on d.cu_company=@cmp and d.cu_code=cast(c.splycode as char(6)) 
			on e.itemno=c.itemno 
			on b.branch=@cmp and b.itemno=e.itemno and b.unicode=e.unicode
			on @cmp=b.branch and a.itemno=b.itemno  
			where b.branch=@cmp  and a.notified=0 and curbal<=0  and a.slcode=@lslcode
			and datediff(d,iif(@yrcode>=34,CONVERT(DATE, substring(lstrcvdate,7,2)+'-'+substring(lstrcvdate,5,2)+'-'+
			substring(lstrcvdate,1,4), 131),cast(lstrcvdate as date)),cast(getdate() as date))<=@lnotify_within
		if isnull(@no_of_items,0)>0
		begin
			SET @tableHTML =
			N'<h1>قائمة الاصناف التي انتهى ارصدتها</h1>'
		  +	N'<h2>اسم الفرع : ' + @branch_name + '</h2>'
		  + N'<table border="1">'
		  + N'<tr><th>رقم الصنف</th>'
		  + N'<th>اسم الصنف</th><th>آخر سعر شراء</th><th>آخر تاريخ شراء</th>'
		  + N'<th>اسم المورد</th></tr>'
		  + CAST ( (select
				   td = b.itemno ,''
				 , td = c.name,''
				 , td = cast(lastlcost as numeric(12,2)),''
				 , td = cast(b.lstrcvdate as date) ,''
				 , td = d.cu_name,''
			from  dbc01y36.dbo.puprsnitems a inner join dbc01y36.dbo.stcosttype b inner join dbc01y36.dbo.stunits e 
			inner join dbc01y36.dbo.stitems c 
			inner join dbc01y36.dbo.supplier d
			on d.cu_company=@cmp and d.cu_code=cast(c.splycode as char(6)) 
			on e.itemno=c.itemno 
			on b.branch=@cmp and b.itemno=e.itemno and b.unicode=e.unicode
			on @cmp=b.branch and a.itemno=b.itemno  
			where b.branch=@cmp  and a.notified=0 and curbal<=0  and a.slcode=@lslcode
			and datediff(d,iif(@yrcode>=34,CONVERT(DATE, substring(lstrcvdate,7,2)+'-'+substring(lstrcvdate,5,2)+'-'+
			substring(lstrcvdate,1,4), 131),cast(lstrcvdate as date)),cast(getdate() as date))<=@lnotify_within--notify_within
			order by cu_name
			FOR XML PATH('tr'), TYPE
			  ) AS NVARCHAR(MAX)
				 )
		  + N'</table>';

			EXEC @RtnCode=msdb.dbo.sp_send_dbmail
				@profile_name = 'awadProfile'
			  , @recipients = @lslemail
			  , @subject = 'اعادة طلب اصناف'
			  , @body = @tableHTML
			  , @body_format = 'HTML'
	  

			SET @ErrorID = @@ERROR

			IF @RtnCode = 0 and @ErrorID=0 
			BEGIN
			    begin transaction
				update puprsnitems set notified = 1
				from puprsnitems x
				join
				(select a.itemno,a.slcode 
					from  dbc01y36.dbo.puprsnitems a inner join dbc01y36.dbo.stcosttype b inner join dbc01y36.dbo.stunits e 
				inner join dbc01y36.dbo.stitems c 
				inner join dbc01y36.dbo.supplier d
				on d.cu_company=@cmp and d.cu_code=cast(c.splycode as char(6)) 
				on e.itemno=c.itemno 
				on b.branch=@cmp and b.itemno=e.itemno and b.unicode=e.unicode
				on @cmp=b.branch and a.itemno=b.itemno  
				where b.branch=@cmp  and a.notified=0 and curbal<=0  and a.slcode=@lslcode
				and datediff(d,iif(@yrcode>=34,CONVERT(DATE, substring(lstrcvdate,7,2)+'-'+substring(lstrcvdate,5,2)+'-'+
				substring(lstrcvdate,1,4), 131),cast(lstrcvdate as date)),cast(getdate() as date))<=@lnotify_within) y
				on x.itemno=y.itemno and x.slcode=y.slcode
	 			if @@error<>0
				begin
					rollback transaction
					set @errstatus=-1		
					break		 
				end
				commit transaction

			END
			else
			begin
				set @errstatus=-2
				break 
			end
		end
		fetch next from @lsalesmen into @cmp,@lslcode,@lnotify_within,@lslemail,@lslname
	end
	close @lsalesmen
	deallocate @lsalesmen
	return @errstatus
end












GO
/****** Object:  StoredProcedure [dbo].[show_locked_tbls]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[show_locked_tbls]
  
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
SELECT
Locks.request_session_id AS SessionID,
Obj.Name AS LockedObjectName,
DATEDIFF(second,ActTra.Transaction_begin_time, GETDATE()) AS Duration,
ActTra.Transaction_begin_time,
COUNT(*) AS Locks
FROM    sys.dm_tran_locks Locks
JOIN sys.partitions Parti ON Parti.hobt_id = Locks.resource_associated_entity_id
JOIN sys.objects Obj ON Obj.object_id = Parti.object_id

JOIN sys.dm_exec_sessions ExeSess ON ExeSess.session_id = Locks.request_session_id
JOIN sys.dm_tran_session_transactions TranSess ON ExeSess.session_id = TranSess.session_id
JOIN sys.dm_tran_active_transactions ActTra ON TranSess.transaction_id = ActTra.transaction_id
WHERE   resource_database_id = db_id() AND Obj.Type = 'U'
GROUP BY ActTra.Transaction_begin_time,Locks.request_session_id, Obj.Name
end














GO
/****** Object:  StoredProcedure [dbo].[sl_del_slinv]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-01-07@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[sl_del_slinv]
 @m_cmp char(2),
 @m_type char(2),
 @m_ref  int, 
 @m_posinv numeric(1,0),
 @errstatus int  output
	
AS
BEGIN
----  Added on 2023-11-25 AA Changed the data type of ref from numeric(6,0) to int 
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
		SET NOCOUNT ON
		declare @lstkjvno int=0,
		    @Donate_ref int =0,
			@restaurant_system int=0
			set @restaurant_system=@errstatus
			set @errstatus=0

		select @lstkjvno=stkjvno,@Donate_ref=rtnref from sales_hd where company=@m_cmp and invTYPE=@m_type and ref=@m_ref;
		if isnull(@lstkjvno,0)>0
		begin
			delete from gljrhdr where jhcomp=@m_cmp and jhtype='17' and jhref=@lstkjvno;
			if @@error<>0
			begin
				set @errstatus=-17
				return @errstatus
			end
		end
		if @m_posinv=1 and @m_type='06' and isnull(@Donate_ref,0)>0
		begin
			delete from gljrhdr where jhcomp=@m_cmp and jhtype='01' and jhref=@Donate_ref and jhsrc='05' 
			and brxfrm ='SL' and rtrim(brxref)=cast(@m_ref as varchar(6));
			if @@error<>0
			begin
				set @errstatus=-9
				return @errstatus
			end
		end
		if @m_type in ('04','06')
			begin
			update  stunits set rsvqty=rsvqty-isnull(a.ttlrsvqty,0)					
			from stunits as b
			join 
			(select c.itemno,[unicode],sum(qty*iif(pkqty=0,1,pkqty)) as ttlrsvqty 
				from sales_dt c inner join stitems on c.itemno=stitems.itemno
				where  c.company=@m_cmp and INVTYPE=@m_type and ref=@m_ref and itemtype<>'5' group by c.itemno,c.unicode) a
			on a.itemno=b.itemno and a.unicode=b.unicode;
			if @@error<>0
			begin
				set @errstatus=-1
				return @errstatus
			end
			---
			--- Update rsvqty in STBINS
			---
			update  stbins set rsvqty=rsvqty-isnull(a.ttlrsvqty,0)					
			from stbins as b
			join 
			(select branch,itemno,unicode,whno,binno,sum(qty) as ttlrsvqty from stdtl
				where  branch=@m_cmp and trTYPE=@m_type and ref=@m_ref 
				group by  branch,itemno,unicode,whno,binno) a
			on a.branch=b.branch and a.itemno=b.itemno and a.unicode=b.unicode and a.whno=b.whno and a.binno=b.binno;
			if @@error<>0
			begin
				set @errstatus=-2
				return @errstatus
			end
		end
		delete from gljrhdr where jhcomp=@m_cmp and jhtype=@m_type and jhref=@m_ref;
		if @@error<>0
		begin
			set @errstatus=-3
			return @errstatus
		end
		delete from arhdr where hd_company=@m_cmp and hd_type=@m_type and hd_ref=@m_ref;
		if @@error<>0
		begin
			set @errstatus=-4
			return @errstatus
		end
		delete from sthdr  where branch=@m_cmp and trTYPE=@m_type and ref=@m_ref ;
		if @@error<>0
		begin
			set @errstatus=-5
			return @errstatus
		end

		delete from sales_hd  where company=@m_cmp and invTYPE=@m_type and ref=@m_ref ;
		if @@error<>0
		begin
			set @errstatus=-6
			return @errstatus
		end
		if @m_posinv>0
		begin
		    if @restaurant_system>0
            begin
				if @m_type='06'
				----- Modified on 2021-11-15 AA to update the new column deleted_geninv
					update rstorder_hdr set geninv=0,deleted_geninv=@m_ref where company=@m_cmp and geninv=@m_ref and order_sales_return=1;
				else update rstorder_hdr set geninv=0,deleted_geninv=@m_ref where company=@m_cmp and geninv=@m_ref and order_sales_return=3;
			end
			else
			begin
				if @m_type='06'
				----- Modified on 2021-11-15 AA to update the new column deleted_geninv
					update pos_hd set geninv=0,deleted_geninv=@m_ref where company=@m_cmp and geninv=@m_ref and invorrtrn='1';
				else update pos_hd set geninv=0,deleted_geninv=@m_ref where company=@m_cmp and geninv=@m_ref and invorrtrn in ('2','3');
			end
			if @@error<>0
			begin
				set @errstatus=-7
				return @errstatus
			end
		end
		return @errstatus
end

GO
/****** Object:  StoredProcedure [dbo].[sl_uncomplete]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-08-31@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[sl_uncomplete]
 @m_cmp char(2),
 @m_type char(2),
 @m_ref  int, --numeric(6,0)
 @syscode int,
 @errcode char(4) output
 
	
AS
BEGIN
----- Added on 2024-08-30 AA bug for those who has multibarnches & multi sysno , syscode must be taken from sales_hd
----- Added on 2024-05-13 AA fixed the bug that retuning 281 by adding new codes & variable to fix the bug & removed an old code 
----- Modified on 2024-03-06 AA convert @m_ref from numeric(6,0) to int
----- Added on 2024-02-22 AA get red of the halal durring  the compare
----- Added on 2023-12-11 AA Added many variables 
----- Added on 2023-12-11 AA Added new codes for zatca rounding
----- Added on 2023-12-11 AA it is very old and modified it 
----- Added on 2023-12-11 AA will be updated auto through the system

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
	declare @lttl numeric(20,7)=0,
	@lptr int =0,
	@no_entries int=0,
	@lttlinv numeric(20,7)=0,
	@lextamt numeric(20,7)=0,
	@is_dsc_amt bit =0,
	@lvat_amt_rcvd numeric(20,7)=0

	if @errcode='1' set @is_dsc_amt=1
	set @errcode='';
		--
		--  prepair the parameters needed for the sql statement
		--
	declare @p_supermarket bit,
	@dbc nvarchar(14),
	@lcalcomp char(2),
	@yrcode char(4),
	@lno_round_nm BIT =0,
	@lpricevattype numeric(1,0)=1
--- Added on 2023-12-11 AA Variables for zatca rounding-----	
	declare
	@lzatca_rounding bit=0, 
	@lextamt_vat numeric(12,3)=0 ,
	@lvat_percent numeric(5,2)=0,
	@llextamt float =0,
	@linstflag bit =0 -- Added on 2024-05-13 AA
---------------------------------
	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)

	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
----------------------------------------   Modified on 2017-01-25 
	select @lno_round_nm=isnull(no_round_nm,0),@is_dsc_amt=isnull(is_dsc_amt,0),
	@syscode=sysno,@lpricevattype=pricevattype
	from sysdb.dbo.glcalend 
	where calcomp=@lcalcomp and yrcode=@yrcode

	set @lpricevattype=isnull(@lpricevattype,1)
	set @lpricevattype=iif(@lpricevattype=0,1,@lpricevattype)

	if @syscode=6 or @lno_round_nm=1  set @p_supermarket = 1
	else set @p_supermarket = 0 
--------------- Added on 2023-12-11 AA ----------------------------------------------------------------------------------------------------------
    set @lextamt_vat=0
	set @lvat_percent=0
	set @lzatca_rounding=0
	set @linstflag=0 -- Added on 2024-05-13 AA
	if COL_LENGTH('dbo.sales_hd','zatca_rounding') is not null
	begin 
		select @lzatca_rounding=isnull(zatca_rounding,0),@lvat_percent=isnull(vat_percent,0),@llextamt=extamt,@lpricevattype=pricevattype,
		@lno_round_nm=no_round_nm ,@linstflag=isnull(instflag,0), -- Added on 2024-05-13 AA 
		@syscode=sysno --- Added on 2024-08-30 AA bug for those who has multibarnches & multi sysno
	    from sales_hd with (NOLOCK) 
		where COMPANY=@m_cmp AND INVTYPE=@m_type AND REF=@m_ref;
        set @lzatca_rounding=isnull(@lzatca_rounding,0)

		if @llextamt>0 and @lzatca_rounding=1 and @lpricevattype>1 and @lvat_percent>0 
		set @lextamt_vat=round(@llextamt*@lvat_percent/(100+@lvat_percent),2)
------- Added on 2024-05-13 AA -------------------------------------------------
		if @syscode=6 or @lno_round_nm=1 or @linstflag=1 set @p_supermarket = 1
		else set @p_supermarket = 0 
--------------------------------------------------------------------------------
	end
    
-----------------------------------------------------------------------------------------------------------------------------------------------------
	If @syscode in (2,3,6) And  @m_type in ('06','26')
	begin
	  if @p_supermarket = 1
	  begin
----------- Modifoed on 2023-12-11 AA ----------------------------------------------------------------------------------------
			with cte_a (entries,ttlinv,EXTAMT,lpt,xttl) as
			(
			select H.ENTRIES,H.INVTTL,H.EXTAMT+iif(@lpricevattype=1 or @lzatca_rounding=1,h.vat_amt_rcvd,0) ,D.LPT,D.xTTL FROM SALES_HD H with (NOLOCK) INNER JOIN 
			(SELECT COMPANY,INVTYPE,REF,sum(iif(@lzatca_rounding=1,qty*item_price_net,(qty*(price-(price*discpc/100)))-imfcval)) AS xTTL,SUM(1) AS LPT 
			FROM SALES_DT with (NOLOCK) WHERE COMPANY=@m_cmp AND INVTYPE=@m_type AND REF=@m_ref
			GROUP BY COMPANY,INVTYPE,REF) AS D
			ON H.COMPANY=D.COMPANY AND H.INVTYPE=D.INVTYPE AND H.REF=D.REF
			)
			select @no_entries=entries,@lttlinv=ttlinv,@lextamt=extamt,@lptr=lpt,@lttl=xttl from cte_a ;
	  end
	  else
	  begin
----------- Modifoed on 2023-12-11 AA ----------------------------------------------------------------------------------------
			with cte_a (entries,ttlinv,EXTAMT,lpt,xttl) as
			(
----------- Added on 2024-05-13 AA ---------------------------------------------------------------------------------------------------------------------------
			select H.ENTRIES,H.INVTTL,H.EXTAMT+iif(@lpricevattype=1 or @lzatca_rounding=1,h.vat_amt_rcvd,0),D.LPT,D.xTTL FROM SALES_HD H with (NOLOCK) INNER JOIN 
			(SELECT COMPANY,INVTYPE,REF,sum(iif(@lzatca_rounding=1,qty*item_price_net,
			(qty*(price-iif(@is_dsc_amt=1 or @linstflag=1 or @lno_round_nm=1,price*discpc/100,cast(price*discpc/100 as int))))-imfcval)) AS xTTL,SUM(1) AS LPT 
			FROM SALES_DT with (NOLOCK) WHERE COMPANY=@m_cmp AND INVTYPE=@m_type AND REF=@m_ref
			GROUP BY COMPANY,INVTYPE,REF) AS D
			ON H.COMPANY=D.COMPANY AND H.INVTYPE=D.INVTYPE AND H.REF=D.REF
			)
			select @no_entries=entries,@lttlinv=ttlinv,@lextamt=extamt,@lptr=lpt,@lttl=xttl from cte_a ;
----------- Stopped on 2024-05-13 AA ---------------------------------------------------------------------------------------------------------------------------
			--select H.ENTRIES,H.INVTTL,H.EXTAMT+iif(@lpricevattype=1 or @lzatca_rounding=1,h.vat_amt_rcvd,0),D.LPT,D.xTTL FROM SALES_HD H with (NOLOCK) INNER JOIN 
			--(SELECT COMPANY,INVTYPE,REF,sum(iif(@lzatca_rounding=1,qty*item_price_net,(qty*(price-iif(@is_dsc_amt=0,cast(price*discpc/100 as int),price*discpc/100)))-imfcval)) AS xTTL,SUM(1) AS LPT 
			--FROM SALES_DT with (NOLOCK) WHERE COMPANY=@m_cmp AND INVTYPE=@m_type AND REF=@m_ref
			--GROUP BY COMPANY,INVTYPE,REF) AS D
			--ON H.COMPANY=D.COMPANY AND H.INVTYPE=D.INVTYPE AND H.REF=D.REF
	  end
	end
	else
	begin
----------- Modifoed on 2023-12-11 AA ----------------------------------------------------------------------------------------
			with cte_a (entries,INVTTL,EXTAMT,lpt,xttl) as
			(
			select H.ENTRIES,H.INVTTL,H.EXTAMT+iif(@lpricevattype=1 or @lzatca_rounding=1,h.vat_amt_rcvd,0) ,D.LPT,D.xTTL FROM SALES_HD H with (NOLOCK) INNER JOIN 
			(SELECT COMPANY,INVTYPE,REF,sum(iif(@lzatca_rounding=1,qty*item_price_net,(PRICE*QTY)-(PRICE*QTY*DISCPC/100))) AS xTTL,SUM(1) AS LPT 
			FROM SALES_DT with (NOLOCK) WHERE COMPANY=@m_cmp AND INVTYPE=@m_type AND REF=@m_ref
			GROUP BY COMPANY,INVTYPE,REF) AS D
			ON H.COMPANY=D.COMPANY AND H.INVTYPE=D.INVTYPE AND H.REF=D.REF
			)
			select @no_entries=entries,@lttlinv=INVTTL,@lextamt=extamt,@lptr=lpt,@lttl=xttl from cte_a ;
	end
	If @lptr<>@no_entries Or (@lptr=0 And @no_entries=0)
	set @errcode='140'
	if dbo.value_balanced(@lttl+@lextamt-@lextamt_vat,@lttlinv)=0 -- Modifoed on 2023-12-11 AA
-------- Added on 2024-02-21 AA -----------------------------------------------------
	begin
		if @lpricevattype=3
		begin
			set @lttlinv=cast(@lttlinv as numeric(18,2))
			set @lttl=cast(@lttl+@lextamt-@lextamt_vat as numeric(18,2))
			if dbo.value_balanced(@lttl,@lttlinv)=0 set @errcode='281'
		end
		else set @errcode='281'
	 end
--------------------------------------------------------------------------------
end

GO
/****** Object:  StoredProcedure [dbo].[sp_customerbal_mobile]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

---- This variable @m_Branch_code must be retrevied at the login screen level from the branch field
--set @m_Branch_code='01'
CREATE PROCEDURE  [dbo].[sp_customerbal_mobile]
@m_Branch_code char(2)
-------------------------------------------------------------------------------  For Customers Balances
as 
select cu_code 'cucode',cu_name 'cuname',cu_mobile 'cu_mobile',cu_tel 'cutel',cu_opnbal+
 isnull(sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))),0) 'bal'
from customer a left outer join ardtl b on a.cu_company=b.dt_company and a.cu_code=b.dt_cucode and a.cf_fcy=b.dt_fcy
 and dt_cucode<>''
 where cu_company=@m_Branch_code
group by cu_company,cu_code,cf_fcy,cu_name,cu_mobile,cu_tel,cu_opnbal
having cu_opnbal+isnull(sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))),0)>0
order by cu_name



--select cu_code 'رقم العميل',cu_name 'اسم العميل',cu_mobile 'الجوال',cu_tel 'التلفون',cu_opnbal+
--isnull(sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))),0) 'الرصيد الحالي'















GO
/****** Object:  StoredProcedure [dbo].[sp_LockDetail]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  PROCEDURE [dbo].[sp_LockDetail]
AS
BEGIN
SELECT SessionID = s.Session_id,s.resource_type,DatabaseName = DB_NAME(resource_database_id),request_mode,request_type,login_time,host_name,program_name,
       client_interface_name,login_name,nt_domain,nt_user_name,s.status,last_request_start_time,last_request_end_time,s.logical_reads,s.reads,request_status,
	   request_owner_type,objectid,dbid,a.number,a.encrypted ,a.blocking_session_id,a.text FROM dbc01y30
	   JOIN sys.dm_exec_sessions s ON l.request_session_id = s.session_id LEFT JOIN(SELECT  * FROM    sys.dm_exec_requests r CROSS APPLY 
	   sys.dm_exec_sql_text(sql_handle)) a ON s.session_id = a.session_id  WHERE  s.session_id > 50


END



GO
/****** Object:  StoredProcedure [dbo].[st_del_pcsinv]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[st_del_pcsinv]
 @m_cmp char(2),
 @m_type char(2),
 @m_ref  numeric(6,0), 
 @errstatus int = 0 output
	
AS
BEGIN
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
			SET NOCOUNT ON


		update  stunits set rsvqty=rsvqty+iif(@m_type in ('04','06'),a.ttlrsvqty,0),
				curbal=curbal+iif(@m_type in ('04','06'),a.ttlrsvqty,-a.ttlrsvqty)
		from stunits as b
		join 
		(select c.itemno,[unicode],sum(qty*iif(pkqty=0,1,pkqty)) as ttlrsvqty 
			from sales_dt c inner join stitems on c.itemno=stitems.itemno
			where  c.company=@m_cmp and INVTYPE=@m_type and ref=@m_ref and itemtype<>'5' group by c.itemno,c.unicode) a
		on a.itemno=b.itemno and a.unicode=b.unicode
		if @@error<>0
		begin
			set @errstatus=-1
			return @errstatus
		end
		---
		--- Update rsvqty in STBINS
		---
		update  stbins set rsvqty=rsvqty+iif(@m_type in ('04','06'),a.ttlrsvqty,0),
				qty=qty+iif(@m_type in ('04','06'),a.ttlrsvqty,-a.ttlrsvqty)
		from stbins as b
		join 
		(select branch,itemno,unicode,whno,binno,sum(qty) as ttlrsvqty from stdtl
		 where  branch=@m_cmp and trTYPE=@m_type and ref=@m_ref 
			group by  branch,itemno,unicode,whno,binno) a
		on a.branch=b.branch and a.itemno=b.itemno and a.unicode=b.unicode and a.whno=b.whno and a.binno=b.binno
		if @@error<>0
		begin
			set @errstatus=-2
			return @errstatus
		end
		update sthdr set posted= '0' ,RELEASED = '0' where branch=@m_cmp and trTYPE=@m_type and ref=@m_ref 
		if @@error<>0
		begin
			set @errstatus=-3
		end
		return @errstatus
end













GO
/****** Object:  StoredProcedure [dbo].[st_pst_pcsinv]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[st_pst_pcsinv]
 @m_cmp char(2),
 @m_type char(2),
 @m_ref  numeric(6,0), 
 @errstatus int = 0 output
	
AS
BEGIN
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
		SET NOCOUNT ON


		
		merge stbins as t
		using (select distinct branch,a.itemno,a.unicode,whno,binno,a.lcost,a.fcost from stdtl a inner join stunits b on a.itemno=b.itemno 
			and a.unicode=b.unicode where a.branch=@m_cmp and a.trtype=@m_type and a.ref=@m_ref ) as s
		on t.branch=s.branch and t.itemno=s.itemno and t.unicode=s.unicode and t.whno=s.whno and t.binno=s.binno
		when not matched then
		insert values (s.branch,s.itemno,s.unicode,s.whno,s.binno,0,0,0,s.lcost,s.fcost,0,0,'');
		if @@error<>0
		begin
			set @errstatus=-1	
			return --@errstatus			 				
		end
	---
	--- Update Curbal & Rsvqty in STUNITS
	---
		update  stunits set rsvqty=iif((rsvqty+iif(@m_type in ('04','06'),-a.ttlrsvqty,0))>0,
				rsvqty+iif(@m_type in ('04','06'),-a.ttlrsvqty,0),0),
				curbal=curbal+iif(@m_type in ('04','06'),-a.ttlrsvqty,a.ttlrsvqty),lcost=iif(lcost<=0,a.cost,lcost),
				moved=1,LASTISSUE=iif(LASTISSUE<a.invdate,a.invdate,LASTISSUE)
		from stunits as b
		join 
		(select c.itemno,[unicode],sum(qty*iif(pkqty=0,1,pkqty)) as ttlrsvqty,cost,invdate 
			from sales_dt c inner join stitems on c.itemno=stitems.itemno
			where  c.company=@m_cmp and INVTYPE=@m_type and ref=@m_ref and itemtype<>'5' 
			group by c.itemno,c.unicode,cost,invdate) a
		on a.itemno=b.itemno and a.unicode=b.unicode
		if @@error<>0
		begin
			set @errstatus=-1
			return @errstatus
		end
	---
	--- Update Qty & Rsvqty in STBINS
	---
		update  stbins set rsvqty=iif((rsvqty+iif(@m_type in ('04','06'),-a.ttlrsvqty,0))>0,
				rsvqty+iif(@m_type in ('04','06'),-a.ttlrsvqty,0),0),
				qty=qty+iif(@m_type in ('04','06'),-a.ttlrsvqty,a.ttlrsvqty),lcost=iif(lcost<=0,a.cost,lcost)
		from stbins as b
		join 
		(select branch,itemno,unicode,whno,binno,sum(qty) as ttlrsvqty,lcost as cost from stdtl
		 where  branch=@m_cmp and trTYPE=@m_type and ref=@m_ref 
			group by  branch,itemno,unicode,whno,binno,lcost) a
		on a.branch=b.branch and a.itemno=b.itemno and a.unicode=b.unicode and a.whno=b.whno and a.binno=b.binno
		if @@error<>0
		begin
			set @errstatus=-2
			return @errstatus
		end
		update sthdr set posted= '1' ,RELEASED = '1' where branch=@m_cmp and trTYPE=@m_type and ref=@m_ref 
		if @@error<>0
		begin
			set @errstatus=-3
		end
		return @errstatus
end












GO
/****** Object:  StoredProcedure [dbo].[st_pst_slinv]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-08-17@@$$##  Important : must have this line as first line which contains the last update date for the this file 
----- Fixed on 2024-08-17 AA lastissue column in stunits must  be updated if @m_type in ('04','06')
----- Added on 2024-08-17 AA to update the new column brlastissue in stcosttype
----- Added on 2024-05-20 AA removed an old codes 
----- Added on 2023-11-25 AA Changed the numeric(6,0) to int for all ref
----- Added on 2022-03-03 AA semi colon at the end of each select or update statement
----- Added on 2022-03-03 AA to fix the problem of different decimal digits length 
----- Modified on 2020-08-22 to fix the comparing between float & float . Changed to numeric & numeric
CREATE PROCEDURE [dbo].[st_pst_slinv]
 @m_cmp char(2),
 @m_type char(2),
 @m_ref  int, 
 @m_caalwngtv bit,
 @m_replication int,
 @errstatus int = 0 output
	
AS
BEGIN
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
		SET NOCOUNT ON
		declare @m_dtl_lines int=0,
		        @m_updated_lined int=0,
				@decimal_dgits int=12
 	---
	--- Update Qty & Rsvqty in STBINS
	---
		if @m_type in ('04','06') 
		begin
		   if @m_caalwngtv=0
		   begin
				with cte_a(recno) as
				(
				select sum(1) as recno from stdtl with (NOLOCK) where branch=@m_cmp and trTYPE=@m_type and ref=@m_ref
				group by branch,itemno,unicode,whno,binno,lcost
				)
				select @m_dtl_lines=count(*) from cte_a ;
------------------ Stopped on 2024-05-20 AA --------------------------------------------------
------------------ Added on 2022-03-03 AA --------------------------------------------------
--				select s.branch,s.itemno,s.unicode,s.whno,s.binno,sum(s.qty) as ttlrsvqty,t.qty
--				from stbins t inner join stdtl s 
--				on t.branch=s.branch and t.itemno=s.itemno and t.unicode=s.unicode and t.whno=s.whno and t.binno=s.binno
--				where  s.branch='70' and trTYPE='04' and ref=13162
--				group by  s.branch,s.itemno,s.unicode,s.whno,s.binno,t.qty
--				having cast(t.qty as numeric(20,12)) -cast(sum(s.qty) as numeric(20,12))>=0;
--				set @m_updated_lined= @@ROWCOUNT

--				if @m_updated_lined<@m_dtl_lines
--				begin
--					set @m_updated_lined=0
--					select s.branch,s.itemno,s.unicode,s.whno,s.binno,sum(s.qty) as ttlrsvqty,t.qty
--					from stbins t inner join stdtl s 
--					on t.branch=s.branch and t.itemno=s.itemno and t.unicode=s.unicode and t.whno=s.whno and t.binno=s.binno
--					where  s.branch='70' and trTYPE='04' and ref=13162
--					group by  s.branch,s.itemno,s.unicode,s.whno,s.binno,t.qty
--					having cast(t.qty as numeric(20,11)) -cast(sum(s.qty) as numeric(20,11))>=0;
--					set @m_updated_lined= @@ROWCOUNT
--					set @decimal_dgits=11
--				end
				set @m_updated_lined=0
----------------- End of Addition   ----------------------------------------------------------

				merge stbins as t
				using 
				(select branch,itemno,unicode,whno,binno,sum(qty) as ttlrsvqty from stdtl
				where  branch=@m_cmp and trTYPE=@m_type and ref=@m_ref 
				group by  branch,itemno,unicode,whno,binno) s
				on t.branch=s.branch and t.itemno=s.itemno and t.unicode=s.unicode and t.whno=s.whno and t.binno=s.binno
				when matched and iif(@decimal_dgits=12,cast(t.qty as numeric(20,12)) -cast(s.ttlrsvqty as numeric(20,12)),cast(t.qty as numeric(20,11)) -cast(s.ttlrsvqty as numeric(20,11)))>=0 then
				update set qty=qty-s.ttlrsvqty,rsvqty=iif(rsvqty-s.ttlrsvqty>=0,rsvqty-s.ttlrsvqty,0);
				set @m_updated_lined=@@ROWCOUNT
				if @@error<>0
				begin
					set @errstatus=-1	
					return --@errstatus			 				
				end	
				IF  @m_updated_lined<@m_dtl_lines
				begin
					set @errstatus=-2
					return --@errstatus			 				
				end									
			end
			else
			begin
				merge stbins as t
				using 
				(select branch,itemno,unicode,whno,binno,sum(qty) as ttlrsvqty,sum(lcost*qty) as cost from stdtl
					where  branch=@m_cmp and trTYPE=@m_type and ref=@m_ref 
					group by  branch,itemno,unicode,whno,binno) s
				on t.branch=s.branch and t.itemno=s.itemno and t.unicode=s.unicode and t.whno=s.whno and t.binno=s.binno
				when matched then
					update set qty=qty-s.ttlrsvqty,rsvqty=iif(rsvqty-s.ttlrsvqty>=0,rsvqty-s.ttlrsvqty,0)
				when not matched then
				insert values (s.branch,s.itemno,s.unicode,s.whno,s.binno,-s.ttlrsvqty,0,0,s.cost/s.ttlrsvqty,0,0,0,'');
				if @@error<>0
				begin
					set @errstatus=-3	
					return --@errstatus			 				
				end
			end
		end
		else
		begin
			merge stbins as t
			using 
			(select branch,itemno,unicode,whno,binno,sum(qty) as ttlrsvqty,sum(lcost*qty) as cost from stdtl
				where  branch=@m_cmp and trTYPE=@m_type and ref=@m_ref 
				group by  branch,itemno,unicode,whno,binno) s
			on t.branch=s.branch and t.itemno=s.itemno and t.unicode=s.unicode and t.whno=s.whno and t.binno=s.binno
			when matched then
				update set qty=isnull(qty,0)+s.ttlrsvqty,lcost=iif(isnull(lcost,0)>0,lcost,s.cost/s.ttlrsvqty)
			when not matched then
			insert values (s.branch,s.itemno,s.unicode,s.whno,s.binno,s.ttlrsvqty,0,0,s.cost/s.ttlrsvqty,0,0,0,'');
			if @@error<>0
			begin
				set @errstatus=-4	
				return --@errstatus			 				
			end
		end
	---
	--- Update Curbal & Rsvqty in STUNITS
	---
		update  stunits set rsvqty=iif((rsvqty+iif(@m_type in ('04','06'),-a.ttlrsvqty,0))>0,
				rsvqty+iif(@m_type in ('04','06'),-a.ttlrsvqty,0),0),
				curbal=curbal+iif(@m_type in ('04','06'),-a.ttlrsvqty,a.ttlrsvqty),lcost=iif(lcost<=0,a.cost,lcost),
				moved=1,LASTISSUE=iif(LASTISSUE<a.invdate and @m_type in ('04','06'),a.invdate,LASTISSUE) -- added on 2024-08-17 AA @m_type in ('04','06')
		from stunits as b
		join 
		(select c.itemno,[unicode],sum(qty*iif(pkqty=0,1,pkqty)) as ttlrsvqty,cost,invdate 
			from sales_dt c inner join stitems on c.itemno=stitems.itemno
			where  c.company=@m_cmp and INVTYPE=@m_type and ref=@m_ref and itemtype<>'5' 
			group by c.itemno,c.unicode,cost,invdate) a
		on a.itemno=b.itemno and a.unicode=b.unicode;
		if @@error<>0
		begin
			set @errstatus=-5
			return @errstatus
		end

------ Added on 2024-08-17 AA to update stcosttype column  ------------------------------------------------------------------------------------
       	if @m_type in ('04','06') 
		begin
			update  stcosttype set brlastissue=iif(isnull(brlastissue,'')<a.invdate,a.invdate,brlastissue)
			from stcosttype as b
			join 
			(select distinct c.company,c.itemno,[unicode],invdate 
				from sales_dt c 
				where  c.company=@m_cmp and INVTYPE=@m_type and ref=@m_ref ) a
			on b.branch=a.company and b.itemno=a.itemno and b.unicode=a.unicode;
			if @@error<>0
			begin
				set @errstatus=-8
				return @errstatus
			end
		end
------------------------------------------------------------------------------------------------------------------------
	---
	--- Update Posted & released fields in STHDR
	---
		update sthdr set posted= '1' ,RELEASED = '1' where branch=@m_cmp and trTYPE=@m_type and ref=@m_ref;
		if @@error<>0
		begin
			set @errstatus=-6
			return @errstatus
		end
		if @m_replication=1
		begin
			update stdtl set rplct_post= '1'  where branch=@m_cmp and trTYPE=@m_type and ref=@m_ref; 
			if @@error<>0
			begin
				set @errstatus=-7
			end	
		end	
		return @errstatus
end

GO
/****** Object:  StoredProcedure [dbo].[st_uncomplete]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-02-22@@$$##  Important : must have this line as first line which contains the last update date for the this file 
---- Added on 2024-02-21 AA fixed the bug when using pricevattype=3 
---- Added on 2024-01-10 AA Added new code to get the proper price from sales_dt for zatca_rounding
---- Added on 2024-01-10 AA Added new variable @linvdsvl 
---- Added on 2024-01-07 AA Added new code (qty*iif(@lzatca_rounding=0,price,item_price_net)) instead of qty*price
---- Added on 2023-12-11 AA Added two more variables vat_percent & lextamt_vat 
---- Added on 2023-12-11 AA Added code to fit zatca rounding requirement 
---- Added on 2023-12-11 AA Added the new variable for zatca rounding 
---- Added on 2023-11-30 AA Resize @errcode varibale to varchar(8) since we have a error greater than 4 digits
---- Added on 2023-03-13 AA to fix the bug when the fqty used in separated line
---- Stopped on 2022-05-14 AA the codes belong to the fqty, it was fucking wrong
---- Added on 2022-05-09 AA i have made the @m_ref parameter & @llref variable to be int instead of numeric(6,0)
---- Added on 2022-04-12 AA to solve the problem of the free qty when qty = 0
---- Added on 2022-04-04 AA new modification 
---- Added on 2022-04-02 AA new varibale for country
---- Added on 2022-04-02 AA round to 2 decimel if saudi or yemen , round 3 for bahreen,jorden,kuwait
CREATE PROCEDURE [dbo].[st_uncomplete]
 @m_cmp char(2),
 @m_type char(2),
 @m_ref  int, 
 @pstmode bit,
 @lsrc char(2),
 @errcode varchar(8) output -- Modified on 2023-11-30 AA resized 
 	
AS
BEGIN
	SET NOCOUNT ON
	declare @lAMNTTL float=0,
	@lptr int =0,
	@no_entries int=0,
	@lcostttl float,
	@posted bit,
	@src char(2),
	@lcountry int =0  -- Added on 2022-04-02 AA
--- Added on 2023-12-11 AA Variables for zatca rounding-----	
	declare
	@lzatca_rounding bit=0, 
	@lextamt_vat numeric(12,3)=0 ,
	@lvat_percent numeric(5,2)=0,
	@linvdsvl float =0 -- Added on 2024-01-11 AA
---------------------------------

	set @errcode='';

	declare @lpricevattype numeric(1,0)=1,
	@l_PVT_level numeric(1,0)=0,
	@lsysno int =1;

	declare 
	@dbc nvarchar(14),
	@lcalcomp char(2),
	@yrcode char(4);
	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)

	select @lpricevattype=pricevattype,@l_PVT_level=isnull(SysNo_PVT_level,0),@lsysno=sysno,@lcountry=country --Added on 2022-04-02 AA
	from sysdb.dbo.glcalend 
	where calcomp=@lcalcomp and yrcode=@yrcode;

	set @lpricevattype=isnull(@lpricevattype,1)
	set @lpricevattype=iif(@lpricevattype=0,1,@lpricevattype)

    select @posted=posted,@src=src,@lAMNTTL=AMNTTL,@lcostttl=costttl,@no_entries=entries from sthdr with (NOLOCK) 
	where branch=@m_cmp and trtype=@m_type and ref=@m_ref;
    set @lptr=@@rowcount

	declare @llref int, -- changed to int 2022-05-09
		@llinvttl float,
		@llextamt float,
		@llfcy char(3),
		@llfcyrate float,
		@llcamt float=0,
		@litem_lines int=0,
		@llttl float=0,
		@llxttl float=0,
		@lvat_amt_rcvd float=0

	if @lsrc<>'03'
	begin
		  if @lptr=0
		  begin
			set @errcode='122'
			return
		  end
		  set @lptr=0
		  if @pstmode=1 
		  begin
			  if  @posted=0
			  begin
				set @errcode='136'
				return
			  end
		  end
		  else 
		  if  @posted=1
		  begin 
				set @errcode='212'
				return
		  end


          If @lsrc='05' And @src=@lsrc
		  begin
				if @l_PVT_level>0				    
					select @llinvttl=invTTL,@llextamt=extamt,@lvat_amt_rcvd=vat_amt_rcvd,@llfcy=isnull(fcy,''),
					@llfcyrate=isnull(fcyrate,0),@lpricevattype=isnull(pricevattype,@lpricevattype),@lsysno=isnull(sysno,1)					
					from sales_hd with (NOLOCK) where COMPANY=@m_cmp AND INVTYPE=@m_type AND REF=@m_ref;
				else
					select @llinvttl=invTTL,@llextamt=extamt,@lvat_amt_rcvd=vat_amt_rcvd,@llfcy=isnull(fcy,''),@llfcyrate=isnull(fcyrate,0)
					from sales_hd with (NOLOCK) where COMPANY=@m_cmp AND INVTYPE=@m_type AND REF=@m_ref;
				if @@rowcount=0
				begin
					set @errcode='122'
					return
				end

--------------- Added on 2023-12-11 AA ----------------------------------------------------------------------------------------------------------
                set @lextamt_vat=0
				set @lvat_percent=0
				set @lzatca_rounding=0 -- Added on 2024-01-11 AA
				set @linvdsvl=0 

				if COL_LENGTH('dbo.sales_hd','zatca_rounding') is not null
				begin 
					select @lzatca_rounding=isnull(zatca_rounding,0),@lvat_percent=isnull(vat_percent,0),@linvdsvl=invdsvl from sales_hd with (NOLOCK) 
					where COMPANY=@m_cmp AND INVTYPE=@m_type AND REF=@m_ref;
					if @llextamt>0 and @lzatca_rounding=1 and @lpricevattype>1 and @lvat_percent>0 
					set @lextamt_vat=round(@llextamt*@lvat_percent/(100+@lvat_percent),2)
				end
-----------------------------------------------------------------------------------------------------------------------------------------------------
				If isnull(@llfcy,'')=''
					set  @llcamt=(@llinvttl-@llextamt-iif(@lpricevattype=1 or @lzatca_rounding=1,@lvat_amt_rcvd,0))+@lextamt_vat --Added on 2023-12-11 AA
				Else
					set  @llcamt=(@llinvttl-@llextamt-iif(@lpricevattype=1 or @lzatca_rounding=1,@lvat_amt_rcvd,0))+@lextamt_vat;  -- Added on 2023-12-11 AA
                
				select @litem_lines=sum(iif(itemtype in ('5','6'),1,0)),@llxttl=sum(iif(itemtype in ('5','6'),0,
				(qty*iif(@lzatca_rounding=0,price,item_price_net))*iif(@llfcy<>'' and @llfcyrate>0,@llfcyrate,1)))  -- Added on 2024-01-07 AA iif(@lzatca_rounding=0,
				from sales_dt with (NOLOCK) inner join stitems on sales_dt.itemno=stitems.itemno
				where sales_dt.COMPANY=@m_cmp AND INVTYPE=@m_type AND REF=@m_ref;   
				if @@rowcount=0
				begin
					set @errcode='140'
					return
				end

				if @lzatca_rounding=1 set @llxttl=@llxttl-@linvdsvl -- Added on 2024-01-11 AA

				If dbo.value_balanced(@lAMNTTL,@llcamt)=0  And @litem_lines=0 
				begin
					set @errcode='213'
					return
				end
				  select @lptr=sum(1),@llttl=sum(iif(itemtype in ('5','6'),0,(lprice*qty))) from stdtl with (NOLOCK) inner join stitems (NOLOCK)
			    on stdtl.itemno=stitems.itemno
				where branch=@m_cmp and trtype=@m_type and ref=@m_ref;
		  end
          If @lsrc='07' And @src=@lsrc
		  begin
				select @llcamt=invcst,@llfcy=isnull(fcy,''),@llfcyrate=isnull(fcyrate,0)
				from puhdr with (NOLOCK) where COMPANY=@m_cmp AND INVTYPE=@m_type AND REF=@m_ref;
				if @@rowcount=0
				begin
					set @errcode='122'
					return
				end
				If dbo.value_balanced(@lcostttl,@llcamt)=0
				begin
--------------- --Added on 2022-04-04 AA  --------------------- 
					if @lcountry in (0,1)
					begin
						set @lcostttl=round(@lcostttl,2)
						set @llcamt=round(@llcamt,2)
					end
					else
					begin
						set @lcostttl=round(@lcostttl,3)
						set @llcamt=round(@llcamt,3)
					end
					If dbo.value_balanced(@lcostttl,@llcamt)=0
					begin
						set @errcode='213'
						return
					end
--------------------------------------------------------------
				end
----------------- Stopped on 2023-03-13 AA Bug when free qty in separated line
    --            select @lptr=sum(1),@llttl=sum(lcost*(qty+fqty)) from stdtl with (NOLOCK) where 
				--branch=@m_cmp and trtype=@m_type and ref=@m_ref;
----------------- Added on 2023-03-13 AA Bug when free qty in separated line
                select @lptr=sum(1),@llttl=sum(lcost*(qty+iif(qty=0,0,fqty))) from stdtl with (NOLOCK) where 
				branch=@m_cmp and trtype=@m_type and ref=@m_ref;
-------------- Added on 2022-04-12 AA to solve the problem of the free qty with qty = 0 ---------------------------------------------------
    --            declare @lfqty_val float 
				--set @lfqty_val=0
				--select @lfqty_val=sum(fqty*price) from pudtl where company=@m_cmp and invtype=@m_type and ref=@m_ref and qty=0 and fqty>0 ;
				--set @lfqty_val=isnull(@lfqty_val,0)
				--if @lfqty_val>0
				--begin
				--    if len(@llfcy)>0 set @lfqty_val=@lfqty_val*@llfcyrate
				--	set @llttl=@llttl- @lfqty_val
				--end
---------------------------------------------------------------------------------------------------------------------------------------------
		  end
	end
    if  @src<>@lsrc
	begin
		set @errcode='124'
		return
	end	
	set @no_entries=@no_entries+iif(@m_type='20',@no_entries,0)
	if @lsrc='03'
	begin
		select @lptr=sum(1) from stdtl with (NOLOCK) where branch=@m_cmp and trtype=@m_type and ref=@m_ref;
	end
	set @lptr=isnull(@lptr,0)
	if @lptr<>@no_entries
	begin
		set @errcode='140'
		return
	end	
	if @lsrc<>'03'
	begin
	   if @lsrc='05'
	   begin
			 If dbo.value_balanced(@llxttl,@llttl)=0  
			 begin
-------- Added on 2024-02-21 AA -----------------------------------------------------
				if @lpricevattype=3
				begin
					set @llxttl=cast(@llxttl as numeric(18,2))
					set @llttl=cast(@llttl as numeric(18,2))
					if dbo.value_balanced(@llxttl,@llttl)=0 
					begin
						set @errcode='213'
						return					
					end 
				end
				else 
				begin
					set @errcode='213'
					return
				end
---------------------------------------------------------------------
			 end
	   end
	   else
	   begin
			If dbo.value_balanced(@llttl,@llcamt)=0  
			begin
--------------- --Added on 2022-04-04 AA  --------------------- 
				if @lcountry in (0,1)
				begin
					set @llttl=round(@llttl,2)
					set @llcamt=round(@llcamt,2)
				end
				else
				begin
					set @llttl=round(@llttl,3)
					set @llcamt=round(@llcamt,3)
				end
				If dbo.value_balanced(@llttl,@llcamt)=0
				begin
					set @errcode='111213'  -- to big so i have to resize the @errcode to varchar(8)
					return
				end
---------------------------------------------------------------
			end
	   end
	end	
end

GO
/****** Object:  StoredProcedure [dbo].[subtarct_2dates]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2023-11-25@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[subtarct_2dates]
-------- 

 @pfdate varchar(8) ,
 @ptdate varchar(8) ,
 @errstatus int  output,
 @diffval  int output,
 @dummy bit
 	
AS
BEGIN
----       Added on 2023-11-20 AA Removed the @dummy paramter 
----       Modified on 2022-07-20 KAN. it was very old in some customer databases like step by step and causes error
----       modified on 2019-03-11 
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
		SET NOCOUNT ON;
		

		declare @lfdate date,
		        @ltdate date,
		        @lgrdate date

		set @errstatus  =0
		
		set @diffval=0
		if len(isnull(@pfdate,''))=0 and len(isnull(@ptdate,''))=0 
		begin
		    set @errstatus  =-2
			return
		end 
		set @diffval=0
		if len(isnull(@pfdate,''))=0
		begin
		   set @pfdate=convert(varchar(8),getdate(),112)
		   set @lfdate=cast(getdate() as date)
		end
		else
		begin
			exec dbo.validate_date @pfdate output,@errstatus output,@lfdate output
			if @errstatus<-1 or @lfdate is null return
		end
		set @errstatus  =0
		if len(isnull(@ptdate,''))=0
		begin
		    set @ptdate=convert(varchar(8),getdate(),112)
			set @ltdate=cast(getdate() as date)
		end
		else
		begin
			exec dbo.validate_date @ptdate output,@errstatus output,@ltdate output
			if @errstatus<-1 or @ltdate is null  return	
		end
		
		set @errstatus  =0	
		begin try
				set @diffval = datediff(d,@lfdate,@ltdate)
		end try
		begin catch
				set @errstatus  =-1
				set @diffval = 0
		end catch		
END












GO
/****** Object:  StoredProcedure [dbo].[supp_bal_whbal]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[supp_bal_whbal]

 @l_company char(2),
 @l_cucode char(6),
 @l_fcy char(3),
 @l_posted bit ,
 @l_curbal   float =0 output ,
 @l_whbal float  output  -- If @l_whbal = 1 , means vender on main branch only
	
AS
BEGIN
declare @open_bal float =0,
        @trx_bal float =0,
		@l_suppcode char(19)='',
		@vender_on_mainbranch bit =0

       
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	set @vender_on_mainbranch=IIF(@l_whbal=1,1,0)
	set @l_whbal=0

	select @open_bal=cu_opnbal from supplier with (NOLOCK) where cu_company=@l_company and cu_code=@l_cucode and cf_fcy=@l_fcy
	if @l_posted=0
	begin
		select @trx_bal=sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))) from aphdr with (NOLOCK) inner join 
				apdtl on hd_company=dt_company and hd_type=dt_type and hd_ref=dt_ref 
				where dt_company=@l_company and dt_cucode=@l_cucode
				and dt_fcy=@l_fcy

    end
	else
	begin
		select @trx_bal=sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))) from aphdr with (NOLOCK) inner join 
				apdtl with (NOLOCK) on hd_company=dt_company and hd_type=dt_type and hd_ref=dt_ref 
				where dt_company=@l_company and dt_cucode=@l_cucode
				and dt_fcy=@l_fcy and hd_posted=1
	end
	set @l_curbal=isnull(@open_bal,0)+isnull(@trx_bal,0)

	set @l_suppcode=rtrim(@l_cucode)+replicate(space(1),19-datalength(rtrim(@l_cucode)))
	IF @vender_on_mainbranch=1
		select @open_bal=sum(qty*b.lcost) from stitems a with (NOLOCK) inner join stbins b with (NOLOCK) 
		on a.itemno=b.itemno
		where a.splycode=@l_suppcode and a.itemtype<'5'
	ELSE
		select @open_bal=sum(qty*b.lcost) from stitems a with (NOLOCK) inner join stbins b with (NOLOCK) 
		on a.itemno=b.itemno
		where b.branch=@l_company and a.splycode=@l_suppcode and a.itemtype<'5'
	
	set @l_whbal=isnull(@open_bal,0)
	
END

















GO
/****** Object:  StoredProcedure [dbo].[supp_bal_whbal_tmp_tc]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[supp_bal_whbal_tmp_tc]

 @l_company char(2),
 @l_cucode char(6),
 @l_fcy char(3),
 @l_posted bit ,
 @l_curbal   float =0 output ,
 @l_whbal float  output  -- If @l_whbal = 1 , means vender on main branch only
	
AS
BEGIN
declare @open_bal float =0,
        @trx_bal float =0,
		@l_suppcode char(19)='',
		@vender_on_mainbranch bit =0

       
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	set @vender_on_mainbranch=IIF(@l_whbal=1,1,0)
	set @l_whbal=0

	select @open_bal=cu_opnbal from supplier with (NOLOCK) where cu_company=@l_company and cu_code=@l_cucode and cf_fcy=@l_fcy
	if @l_posted=0
	begin
		select @trx_bal=sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))) from aphdr with (NOLOCK) inner join 
				apdtl on hd_company=dt_company and hd_type=dt_type and hd_ref=dt_ref 
				where dt_cucode=@l_cucode
				and dt_fcy=@l_fcy

    end
	else
	begin
		select @trx_bal=sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))) from aphdr with (NOLOCK) inner join 
				apdtl with (NOLOCK) on hd_company=dt_company and hd_type=dt_type and hd_ref=dt_ref 
				where  dt_cucode=@l_cucode
				and dt_fcy=@l_fcy and hd_posted=1
	end
	set @l_curbal=isnull(@open_bal,0)+isnull(@trx_bal,0)

	set @l_suppcode=rtrim(@l_cucode)+replicate(space(1),19-datalength(rtrim(@l_cucode)))
	IF @vender_on_mainbranch=1
		select @open_bal=sum(qty*b.lcost) from stitems a with (NOLOCK) inner join stbins b with (NOLOCK) 
		on a.itemno=b.itemno
		where a.splycode=@l_suppcode and a.itemtype<'5'
	ELSE
		select @open_bal=sum(qty*b.lcost) from stitems a with (NOLOCK) inner join stbins b with (NOLOCK) 
		on a.itemno=b.itemno
		where b.branch=@l_company and a.splycode=@l_suppcode and a.itemtype<'5'
	
	set @l_whbal=isnull(@open_bal,0)
	
END

















GO
/****** Object:  StoredProcedure [dbo].[Update_Pos_Auto]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--البغدادية

CREATE PROCEDURE [dbo].[Update_Pos_Auto]
 @whr_condn nvarchar(200) = 'invdate > convert(date,dateadd(day,-7,GETDATE()),112)' ,
 @brlinksrvr nvarchar(15) = 'BRLNKSRVR0101',
 @wth_slp_cntr bit = 0 ,
 @no_of_invoices int=0 output,
 @errstatus int = 0 output
	
AS
BEGIN
	declare @sqlmsg nvarchar(max)='',
	@dbc nvarchar(14) = '.dbc01y30.dbo.',
	@lcalcomp char(2) = '01',
	@yrcode char(4) = '2020',
	@syscode int =2,
	@lcauseslctr bit=0,
	@it_is_pos bit=0
---------------------------------------------------------------------------------------------
	--set @dbc=db_name()
	--set @lcalcomp=substring(@dbc,4,2)
	--set @yrcode=substring(@dbc,7,2)
	--SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
	
	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @syscode=sysno,@lcauseslctr=causeslctr  from sysdb.dbo.glcalend 
	where calcomp=@lcalcomp and yrcode=@yrcode
------------------------------------------------------------------------------------------------------------------------------

    set @errstatus=0
 --   if @syscode<>3  --set @dbc='.'+db_name()+'.dbo.'
	--else 
	--begin
------------------------------ Get Yrcode & Calcomp from Branch Boteequ  ----------------------------------------------
--		declare @dynsql nvarchar(300),
--				@params nvarchar(100)

--		set @yrcode=''
--		set @lcalcomp=''
--		set @dynsql='select top 1 @yrcd=yrcode,@lclcmp=calcomp  from '+@brlinksrvr+'.posysdb.dbo.glcalend'
--		+ ' order by yrcode desc';
--		set @params='@yrcd char(4) output,@lclcmp char(2) output';
--		exec sp_executesql @dynsql,@params,@yrcd=@yrcode output,@lclcmp=@lcalcomp output
--		if @@error<>0 or @@rowcount=0
--		begin
--		  	set @errstatus=-1
--			return 
--		end
--		if @yrcode<>'' and @lcalcomp<>'' set @dbc='.pos'+@lcalcomp+'y'+substring(@yrcode,3,2)+'.dbo.'
--		else
--		begin
--		  	set @errstatus=-2
--			return 		  
--		end
--		set @it_is_pos=1
--------------------------------------------------------------------------------------------------------------------------
--	end
    

  if @wth_slp_cntr=1
	begin
	    set @sqlmsg='merge pos_ctr as t '
		+ ' using '+@brlinksrvr+@dbc+'pos_ctr as s'
		+ ' on t.ctrcompany=s.ctrcompany and t.ctrcode=s.ctrcode'
		+ ' when matched then '
		+ ' update set t.ctrloc = s.ctrloc ,t.ctrstatus = s.ctrstatus ,t.ctrnote = s.ctrnote ,t.ctrcash = s.ctrcash'
        + ',t.ctrrpls = s.ctrrpls,t.ctrcard = s.ctrcard ,t.ctrsanet = s.ctrsanet,t.ctrsanetpctg = s.ctrsanetpctg'
        + ',t.ctrvisa = s.ctrvisa ,t.ctrvisapctg = s.ctrvisapctg ,t.ctrmaster = s.ctrmaster'
        + ',t.ctrmasterpctg = s.ctrmasterpctg,t.ctrothers = s.ctrothers ,t.ctrotherspctg = s.ctrotherspctg'
        + ',t.slcenter = s.slcenter ,t.invser = s.invser,t.drwrcomport = s.drwrcomport,t.spath = s.spath'
        + ',t.ctrserial = s.ctrserial,t.modified = s.modified,t.started = s.started ,t.ended = s.ended'
        + ',t.drawer = s.drawer,t.cdisplay = s.cdisplay ,t.slmsg = s.slmsg,t.rtnmsg = s.rtnmsg'
        + ',t.footmsg1 = s.footmsg1,t.footmsg2 = s.footmsg2,t.footmsg3 = s.footmsg3,t.saveinserver = s.saveinserver'
        + ',t.saveinvall = s.saveinvall,t.scr_open = s.scr_open,t.slnoprint = s.slnoprint,t.rtnoprint = s.rtnoprint'
        + ',t.ccconus = s.ccconus,t.upditem_hrs = s.upditem_hrs,t.updinv_hrs = s.updinv_hrs,t.prntbyclass = s.prntbyclass'
        + ',t.sltype = s.sltype,t.rttype = s.rttype,t.rptype = s.rptype,t.icrptype = s.icrptype'
        + ',t.ctrprpaid = s.ctrprpaid,t.rtfmothrs = s.rtfmothrs,t.magcard = s.magcard,t.usbdsply = s.usbdsply'
        + ',t.dsplycomport = s.dsplycomport,t.rpt_grp_items = s.rpt_grp_items,
		   t.ctrsaned=s.ctrsaned,t.ctrsndecrpos=s.ctrsndecrpos,t.ctreftpos=s.ctreftpos ,t.eftport=s.eftport'
		+ ' when not matched then '
		+ ' insert (ctrcompany,ctrcode,ctrloc,ctrstatus ,ctrnote ,ctrcash ,ctrrpls ,ctrcard,ctrsanet'
        + ',ctrsanetpctg,ctrvisa,ctrvisapctg ,ctrmaster,ctrmasterpctg,ctrothers,ctrotherspctg'
        + ',slcenter,invser ,drwrcomport,spath ,ctrserial,modified,started,ended,drawer'
        + ',cdisplay,slmsg,rtnmsg,footmsg1,footmsg2,footmsg3,saveinserver,saveinvall,scr_open'
        + ',slnoprint,rtnoprint,ccconus ,upditem_hrs,updinv_hrs,prntbyclass ,sltype ,rttype'
        + ',rptype ,icrptype,ctrprpaid ,rtfmothrs,magcard ,usbdsply,dsplycomport,rpt_grp_items,
		    ctrsaned,ctrsndecrpos,eftport,ctreftpos,ntk_printer1,ntk_printer2,grp_printers,grp_prnt_local,cshRtn_f_o_b)'
		+ ' values (s.ctrcompany,s.ctrcode,s.ctrloc,s.ctrstatus ,s.ctrnote ,s.ctrcash ,s.ctrrpls ,s.ctrcard,s.ctrsanet'
        + ',s.ctrsanetpctg,s.ctrvisa,s.ctrvisapctg ,s.ctrmaster,s.ctrmasterpctg,s.ctrothers,s.ctrotherspctg'
        + ',s.slcenter,s.invser ,s.drwrcomport,s.spath ,s.ctrserial,s.modified,s.started,s.ended,s.drawer'
        + ',s.cdisplay,s.slmsg,s.rtnmsg,s.footmsg1,s.footmsg2,s.footmsg3,s.saveinserver,s.saveinvall,s.scr_open'
        + ',s.slnoprint,s.rtnoprint,s.ccconus ,s.upditem_hrs,s.updinv_hrs,s.prntbyclass ,s.sltype ,s.rttype'
        + ',s.rptype ,s.icrptype,s.ctrprpaid ,s.rtfmothrs,s.magcard ,s.usbdsply,s.dsplycomport,s.rpt_grp_items,
		    s.ctrsaned,s.ctrsndecrpos,s.eftport,s.ctreftpos,s.ntk_printer1,s.ntk_printer2,s.grp_printers,s.grp_prnt_local,s.cshRtn_f_o_b);'
			
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-10
			return 
		end
		else commit transaction
-- t.slppassword=s.slppassword,  is rempved 08-06-2014
	    set @sqlmsg='merge pos_slp as t '
		+ ' using '+@brlinksrvr+@dbc+'pos_slp as s'
		+ ' on t.slpcompany=s.slpcompany and t.slpcode=s.slpcode'
		+ ' when matched then '
		+ ' update set t.slpname=s.slpname,t.slpaddress=s.slpaddress,t.slptel=s.slptel,'
		+ ' t.slpchgqty=s.slpchgqty,t.slpchgprice=s.slpchgprice'
        + ',t.slpdelline=s.slpdelline,t.slpothersinv=s.slpothersinv,t.slpreturn=s.slpreturn,t.slpstatus=s.slpstatus,'
		+ ' t.slpalowdisc=s.slpalowdisc,t.slpmaxdisc=s.slpmaxdisc,t.slppricetp=s.slppricetp'
        + ',t.slpalowcancel=s.slpalowcancel,t.slpalowopdr=s.slpalowopdr,t.modified=s.modified,t.slpalowexit=s.slpalowexit,'
		+ ' t.slprtwoinv=s.slprtwoinv,t.slpblowbal=s.slpblowbal,t.scr_open=s.scr_open'
        + ',t.alwitmdsc=s.alwitmdsc,t.maxitmdsc=s.maxitmdsc ,t.alwuserpls=s.alwuserpls ,t.alwuseicrpls=s.alwuseicrpls,'
		+ 't.slpmagnetic=s.slpmagnetic,t.alwusebrrtn=s.alwusebrrtn,t.alwreprint=s.alwreprint'
        + ',t.frcrplinv=s.frcrplinv,t.catch_thief=s.catch_thief,t.sold_once=s.sold_once,t.only_scan_bc=s.only_scan_bc,'
		+ 't.stop_item_column=s.stop_item_column,t.slpfpalw=s.slpfpalw,t.slpfpimage=s.slpfpimage'
        + ',t.slcenter=s.slcenter,t.salesquota=s.salesquota,t.commissionP=s.commissionP,t.bonus=s.bonus,
		    t.supervisor=s.supervisor,t.ReadInvByBarcd=s.ReadInvByBarcd,
			t.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,t.alwcshcardpay=s.alwcshcardpay,'
		+ 't.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,t.slp_hlldscamtMax=s.slp_hlldscamtMax,t.alwprnttmpinv=s.alwprnttmpinv,s.ignore_mnmprice=s.ignore_mnmprice'
		
		+ ' when not matched then '
		+ ' insert values (s.slpcompany,s.slpcode,s.slpname,s.slpaddress,s.slptel,s.slppassword,s.slpchgqty,s.slpchgprice'
        + ',s.slpdelline,s.slpothersinv,s.slpreturn,s.slpstatus,s.slpalowdisc,s.slpmaxdisc,s.slppricetp'
        + ',s.slpalowcancel,s.slpalowopdr,s.modified,s.slpalowexit,s.slprtwoinv,s.slpblowbal,s.scr_open'
        + ',s.alwitmdsc,s.maxitmdsc ,s.alwuserpls ,s.alwuseicrpls,s.slpmagnetic,s.alwusebrrtn,s.alwreprint'
        + ',s.frcrplinv,s.catch_thief,s.sold_once,s.only_scan_bc,s.stop_item_column,s.slpfpalw,s.slpfpimage'
        + ',s.slcenter,s.salesquota,s.commissionP,s.bonus,s.supervisor,s.ReadInvByBarcd,s.alwrtncash,
		   s.alwmtchrtn,s.alwinvtrnsfr,s.alwcshcardpay,s.alwrtncash,s.alwmtchrtn,s.alwinvtrnsfr,s.slp_hlldscamtMax,s.alwprnttmpinv,s.ignore_mnmprice);'
		   
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-11
			return 
		end
		else commit transaction
	end
------------------------------------------------------------------------------------------------------------------------
	set @sqlmsg='merge pos_hd as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_hd b where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, invdate, entries, slperson, paytype, chargepctg, chargeamt, invdspc, disccard, 
		cardtype, invttl, invcst, invdsvl, valafds, invpaid, pricetp, slcenter, invorrtrn, cashamt, modified, 
		salinvno, salctrno, tdatetime, cktype, geninv, rref, rcontr, ccpaid, ccconus, prepaidamt, fmbranch,
		mobile, fcamt, custtype, paycard, saned_amt,rtncshamt,dfvchramt,frc_rtncash,vat_amt_rcvd,taxfree_sales,hlldscnt,discamt,No_round_nm,PriceVatType,CashDsc4RtnPrepaid,outside_order,stcpay_amt,Qitaf_amt,whlslinv , vat_percent)'
	+ ' values (s.company,s.contr,s.ref,s.invdate,s.entries,s.slperson ,s.paytype,s.chargepctg,s.chargeamt'
    + ' ,s.invdspc ,s.disccard ,s.cardtype ,s.invttl,s.invcst,s.invdsvl,s.valafds ,s.invpaid,s.pricetp,s.slcenter'
    + ' ,s.invorrtrn ,s.cashamt,s.modified ,s.salinvno ,s.salctrno ,s.tdatetime ,s.cktype ,s.geninv ,s.rref'
    + ' ,s.rcontr ,s.ccpaid ,s.ccconus,s.prepaidamt ,s.fmbranch,s.mobile ,s.fcamt ,s.custtype ,s.paycard,s.saned_amt,
	     s.rtncshamt,s.dfvchramt,s.frc_rtncash,s.vat_amt_rcvd,s.taxfree_sales,s.hlldscnt,s.discamt,s.No_round_nm,s.PriceVatType,s.CashDsc4RtnPrepaid,s.outside_order,s.stcpay_amt,s.Qitaf_amt,s.whlslinv , s.vat_percent);'	
	
	begin transaction
	exec sp_executesql @sqlmsg
	set @no_of_invoices=@@ROWCOUNT
	if @@error<>0 or @no_of_invoices=0
	begin
		rollback transaction
		set @errstatus=-3
		if @no_of_invoices=0 set @errstatus=0
		return 
	end

--  Make sure that the field NQATI_PRCNT is available in pos_dt
	
    declare @is_nqati_there varchar(30)=''
    set @is_nqati_there=iif(EXISTS(SELECT name FROM sys.columns
    WHERE Name = N'nqati_prcnt' AND OBJECT_ID = OBJECT_ID(N'pos_dt')),',s.nqati_prcnt);',');')
	
	set @sqlmsg='merge pos_dt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'pos_dt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' And exists(Select contr,ref From pos_hd s1 Where a.company=s1.company and a.contr = s1.contr and a.ref = s1.ref)) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, cmbkey, qty, price, barcode, dscprsnt, srlno, rtrnd, dsc_amt, offer_amt
	    , nqati_prcnt,scl_barcode,taxtype) 
	    values (s.company ,s.contr ,s.ref,s.cmbkey ,s.qty,s.price ,s.barcode ,s.dscprsnt ,s.srlno,s.rtrnd,
	            s.dsc_amt,s.offer_amt,s.nqati_prcnt,s.scl_barcode,s.taxtype);'
	
	

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-4
		return 
	end
		
	set @sqlmsg='merge POSRTNINV as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSRTNINV a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.rcontr,s.rref,s.Contr,s.ref,s.rtnamt);'

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end

	set @sqlmsg='merge POSPPCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSPPCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.disccard=s.disccard'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.disccard,s.paytype,s.prepaidamt,s.paycard,s.nodsc4promo,s.prepaidamt_rtn);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

	set @sqlmsg='merge POSCCCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSCCCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' and b.ccpaid>0) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.cccardno=s.cccardno and t.ccsrlno=s.ccsrlno'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.cccardno,s.ccsrlno,s.cardtype,s.ccpaid,
	    s.ccconus,s.chargepctg,s.chargeamt,s.cctype,s.approvl_no,s.TransDate,s.TransTime,s.TransNo,s.terminal_id);'
		
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

	set @sqlmsg='merge poschrtinv as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'poschrtinv a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.hllamt,s.chrcode);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end

	set @sqlmsg='merge posfcamt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'posfcamt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' and b.invcst>0) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.fcy,s.fcamt,s.fcyrate,s.lcamt,s.srlno);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-6
		return 
	end
	else commit transaction
	
	declare @new_cndn nvarchar(250),
	        @lpos int =0
	set @lpos=charindex('INVDATE',@whr_condn)
	set @new_cndn=substring(@whr_condn,@lpos,200)
	set @new_cndn=replace(replace(@new_cndn,'INVDATE','mnydate'),'smalldatetime','date')
	set @sqlmsg='merge pos_mny as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_mny  where '+@new_cndn+') as s'	
	+ ' on t.company=s.company and t.contr=s.contr and t.mnydate=s.mnydate and t.slpcode=s.slpcode'
    + ' when not matched then '
	+ ' insert (company,contr,mnydate,slpcode,oner,fiver,tenr,twntyr,fiftyr,hundredr,
                twohandr,fivehandr,modified,rtnval,network,prepaidamt,scrtnval,scnetwork,scprepaidamt,
				sccash,saned_amt,scsaned_amt)                
	    values (s.company,s.contr,s.mnydate,s.slpcode,s.oner,s.fiver,s.tenr,s.twntyr,s.fiftyr,s.hundredr,
                s.twohandr,s.fivehandr,s.modified,s.rtnval,s.network,s.prepaidamt'
	+ iif(@it_is_pos=0,',s.scrtnval ,s.scnetwork,s.scprepaidamt,s.sccash,s.saned_amt,s.scsaned_amt',',0,0,0,0,s.saned_amt,0')+');'
	
	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
	end
	else commit transaction
	--END TRY
	--BEGIN CATCH
	--		SET @STR_MSG ='ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +' rtncode='+@rtncode
			
	--		return @errstatus
	--END CATCH
end 






GO
/****** Object:  StoredProcedure [dbo].[Update_Pos_Auto10]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--الاحساء

CREATE PROCEDURE [dbo].[Update_Pos_Auto10]
 @whr_condn nvarchar(200) = 'invdate > convert(date,dateadd(day,-7,GETDATE()),112)' ,
 @brlinksrvr nvarchar(15) = 'BRLNKSRVR0110',
 @wth_slp_cntr bit = 0 ,
 @no_of_invoices int=0 output,
 @errstatus int = 0 output
	
AS
BEGIN
	declare @sqlmsg nvarchar(max)='',
	@dbc nvarchar(14) = '.dbc01y30.dbo.',
	@lcalcomp char(2) = '01',
	@yrcode char(4) = '2020',
	@syscode int =2,
	@lcauseslctr bit=0,
	@it_is_pos bit=0
---------------------------------------------------------------------------------------------
	--set @dbc=db_name()
	--set @lcalcomp=substring(@dbc,4,2)
	--set @yrcode=substring(@dbc,7,2)
	--SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
	
	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @syscode=sysno,@lcauseslctr=causeslctr  from sysdb.dbo.glcalend 
	where calcomp=@lcalcomp and yrcode=@yrcode
------------------------------------------------------------------------------------------------------------------------------

    set @errstatus=0
 --   if @syscode<>3  --set @dbc='.'+db_name()+'.dbo.'
	--else 
	--begin
------------------------------ Get Yrcode & Calcomp from Branch Boteequ  ----------------------------------------------
--		declare @dynsql nvarchar(300),
--				@params nvarchar(100)

--		set @yrcode=''
--		set @lcalcomp=''
--		set @dynsql='select top 1 @yrcd=yrcode,@lclcmp=calcomp  from '+@brlinksrvr+'.posysdb.dbo.glcalend'
--		+ ' order by yrcode desc';
--		set @params='@yrcd char(4) output,@lclcmp char(2) output';
--		exec sp_executesql @dynsql,@params,@yrcd=@yrcode output,@lclcmp=@lcalcomp output
--		if @@error<>0 or @@rowcount=0
--		begin
--		  	set @errstatus=-1
--			return 
--		end
--		if @yrcode<>'' and @lcalcomp<>'' set @dbc='.pos'+@lcalcomp+'y'+substring(@yrcode,3,2)+'.dbo.'
--		else
--		begin
--		  	set @errstatus=-2
--			return 		  
--		end
--		set @it_is_pos=1
--------------------------------------------------------------------------------------------------------------------------
--	end
    

  if @wth_slp_cntr=1
	begin
	    set @sqlmsg='merge pos_ctr as t '
		+ ' using '+@brlinksrvr+@dbc+'pos_ctr as s'
		+ ' on t.ctrcompany=s.ctrcompany and t.ctrcode=s.ctrcode'
		+ ' when matched then '
		+ ' update set t.ctrloc = s.ctrloc ,t.ctrstatus = s.ctrstatus ,t.ctrnote = s.ctrnote ,t.ctrcash = s.ctrcash'
        + ',t.ctrrpls = s.ctrrpls,t.ctrcard = s.ctrcard ,t.ctrsanet = s.ctrsanet,t.ctrsanetpctg = s.ctrsanetpctg'
        + ',t.ctrvisa = s.ctrvisa ,t.ctrvisapctg = s.ctrvisapctg ,t.ctrmaster = s.ctrmaster'
        + ',t.ctrmasterpctg = s.ctrmasterpctg,t.ctrothers = s.ctrothers ,t.ctrotherspctg = s.ctrotherspctg'
        + ',t.slcenter = s.slcenter ,t.invser = s.invser,t.drwrcomport = s.drwrcomport,t.spath = s.spath'
        + ',t.ctrserial = s.ctrserial,t.modified = s.modified,t.started = s.started ,t.ended = s.ended'
        + ',t.drawer = s.drawer,t.cdisplay = s.cdisplay ,t.slmsg = s.slmsg,t.rtnmsg = s.rtnmsg'
        + ',t.footmsg1 = s.footmsg1,t.footmsg2 = s.footmsg2,t.footmsg3 = s.footmsg3,t.saveinserver = s.saveinserver'
        + ',t.saveinvall = s.saveinvall,t.scr_open = s.scr_open,t.slnoprint = s.slnoprint,t.rtnoprint = s.rtnoprint'
        + ',t.ccconus = s.ccconus,t.upditem_hrs = s.upditem_hrs,t.updinv_hrs = s.updinv_hrs,t.prntbyclass = s.prntbyclass'
        + ',t.sltype = s.sltype,t.rttype = s.rttype,t.rptype = s.rptype,t.icrptype = s.icrptype'
        + ',t.ctrprpaid = s.ctrprpaid,t.rtfmothrs = s.rtfmothrs,t.magcard = s.magcard,t.usbdsply = s.usbdsply'
        + ',t.dsplycomport = s.dsplycomport,t.rpt_grp_items = s.rpt_grp_items,
		   t.ctrsaned=s.ctrsaned,t.ctrsndecrpos=s.ctrsndecrpos,t.ctreftpos=s.ctreftpos ,t.eftport=s.eftport'
		+ ' when not matched then '
		+ ' insert (ctrcompany,ctrcode,ctrloc,ctrstatus ,ctrnote ,ctrcash ,ctrrpls ,ctrcard,ctrsanet'
        + ',ctrsanetpctg,ctrvisa,ctrvisapctg ,ctrmaster,ctrmasterpctg,ctrothers,ctrotherspctg'
        + ',slcenter,invser ,drwrcomport,spath ,ctrserial,modified,started,ended,drawer'
        + ',cdisplay,slmsg,rtnmsg,footmsg1,footmsg2,footmsg3,saveinserver,saveinvall,scr_open'
        + ',slnoprint,rtnoprint,ccconus ,upditem_hrs,updinv_hrs,prntbyclass ,sltype ,rttype'
        + ',rptype ,icrptype,ctrprpaid ,rtfmothrs,magcard ,usbdsply,dsplycomport,rpt_grp_items,
		    ctrsaned,ctrsndecrpos,eftport,ctreftpos,ntk_printer1,ntk_printer2,grp_printers,grp_prnt_local,cshRtn_f_o_b)'
		+ ' values (s.ctrcompany,s.ctrcode,s.ctrloc,s.ctrstatus ,s.ctrnote ,s.ctrcash ,s.ctrrpls ,s.ctrcard,s.ctrsanet'
        + ',s.ctrsanetpctg,s.ctrvisa,s.ctrvisapctg ,s.ctrmaster,s.ctrmasterpctg,s.ctrothers,s.ctrotherspctg'
        + ',s.slcenter,s.invser ,s.drwrcomport,s.spath ,s.ctrserial,s.modified,s.started,s.ended,s.drawer'
        + ',s.cdisplay,s.slmsg,s.rtnmsg,s.footmsg1,s.footmsg2,s.footmsg3,s.saveinserver,s.saveinvall,s.scr_open'
        + ',s.slnoprint,s.rtnoprint,s.ccconus ,s.upditem_hrs,s.updinv_hrs,s.prntbyclass ,s.sltype ,s.rttype'
        + ',s.rptype ,s.icrptype,s.ctrprpaid ,s.rtfmothrs,s.magcard ,s.usbdsply,s.dsplycomport,s.rpt_grp_items,
		    s.ctrsaned,s.ctrsndecrpos,s.eftport,s.ctreftpos,s.ntk_printer1,s.ntk_printer2,s.grp_printers,s.grp_prnt_local,s.cshRtn_f_o_b);'
			
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-10
			return 
		end
		else commit transaction
-- t.slppassword=s.slppassword,  is rempved 08-06-2014
	    set @sqlmsg='merge pos_slp as t '
		+ ' using '+@brlinksrvr+@dbc+'pos_slp as s'
		+ ' on t.slpcompany=s.slpcompany and t.slpcode=s.slpcode'
		+ ' when matched then '
		+ ' update set t.slpname=s.slpname,t.slpaddress=s.slpaddress,t.slptel=s.slptel,'
		+ ' t.slpchgqty=s.slpchgqty,t.slpchgprice=s.slpchgprice'
        + ',t.slpdelline=s.slpdelline,t.slpothersinv=s.slpothersinv,t.slpreturn=s.slpreturn,t.slpstatus=s.slpstatus,'
		+ ' t.slpalowdisc=s.slpalowdisc,t.slpmaxdisc=s.slpmaxdisc,t.slppricetp=s.slppricetp'
        + ',t.slpalowcancel=s.slpalowcancel,t.slpalowopdr=s.slpalowopdr,t.modified=s.modified,t.slpalowexit=s.slpalowexit,'
		+ ' t.slprtwoinv=s.slprtwoinv,t.slpblowbal=s.slpblowbal,t.scr_open=s.scr_open'
        + ',t.alwitmdsc=s.alwitmdsc,t.maxitmdsc=s.maxitmdsc ,t.alwuserpls=s.alwuserpls ,t.alwuseicrpls=s.alwuseicrpls,'
		+ 't.slpmagnetic=s.slpmagnetic,t.alwusebrrtn=s.alwusebrrtn,t.alwreprint=s.alwreprint'
        + ',t.frcrplinv=s.frcrplinv,t.catch_thief=s.catch_thief,t.sold_once=s.sold_once,t.only_scan_bc=s.only_scan_bc,'
		+ 't.stop_item_column=s.stop_item_column,t.slpfpalw=s.slpfpalw,t.slpfpimage=s.slpfpimage'
        + ',t.slcenter=s.slcenter,t.salesquota=s.salesquota,t.commissionP=s.commissionP,t.bonus=s.bonus,
		    t.supervisor=s.supervisor,t.ReadInvByBarcd=s.ReadInvByBarcd,
			t.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,t.alwcshcardpay=s.alwcshcardpay,'
		+ 't.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,t.slp_hlldscamtMax=s.slp_hlldscamtMax,t.alwprnttmpinv=s.alwprnttmpinv,s.ignore_mnmprice=s.ignore_mnmprice'
		
		+ ' when not matched then '
		+ ' insert values (s.slpcompany,s.slpcode,s.slpname,s.slpaddress,s.slptel,s.slppassword,s.slpchgqty,s.slpchgprice'
        + ',s.slpdelline,s.slpothersinv,s.slpreturn,s.slpstatus,s.slpalowdisc,s.slpmaxdisc,s.slppricetp'
        + ',s.slpalowcancel,s.slpalowopdr,s.modified,s.slpalowexit,s.slprtwoinv,s.slpblowbal,s.scr_open'
        + ',s.alwitmdsc,s.maxitmdsc ,s.alwuserpls ,s.alwuseicrpls,s.slpmagnetic,s.alwusebrrtn,s.alwreprint'
        + ',s.frcrplinv,s.catch_thief,s.sold_once,s.only_scan_bc,s.stop_item_column,s.slpfpalw,s.slpfpimage'
        + ',s.slcenter,s.salesquota,s.commissionP,s.bonus,s.supervisor,s.ReadInvByBarcd,s.alwrtncash,
		   s.alwmtchrtn,s.alwinvtrnsfr,s.alwcshcardpay,s.alwrtncash,s.alwmtchrtn,s.alwinvtrnsfr,s.slp_hlldscamtMax,s.alwprnttmpinv,s.ignore_mnmprice);'
		   
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-11
			return 
		end
		else commit transaction
	end
------------------------------------------------------------------------------------------------------------------------
	set @sqlmsg='merge pos_hd as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_hd b where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, invdate, entries, slperson, paytype, chargepctg, chargeamt, invdspc, disccard, 
		cardtype, invttl, invcst, invdsvl, valafds, invpaid, pricetp, slcenter, invorrtrn, cashamt, modified, 
		salinvno, salctrno, tdatetime, cktype, geninv, rref, rcontr, ccpaid, ccconus, prepaidamt, fmbranch,
		mobile, fcamt, custtype, paycard, saned_amt,rtncshamt,dfvchramt,frc_rtncash,vat_amt_rcvd,taxfree_sales,hlldscnt,discamt,No_round_nm,PriceVatType,CashDsc4RtnPrepaid,outside_order,stcpay_amt,Qitaf_amt,whlslinv , vat_percent)'
	+ ' values (s.company,s.contr,s.ref,s.invdate,s.entries,s.slperson ,s.paytype,s.chargepctg,s.chargeamt'
    + ' ,s.invdspc ,s.disccard ,s.cardtype ,s.invttl,s.invcst,s.invdsvl,s.valafds ,s.invpaid,s.pricetp,s.slcenter'
    + ' ,s.invorrtrn ,s.cashamt,s.modified ,s.salinvno ,s.salctrno ,s.tdatetime ,s.cktype ,s.geninv ,s.rref'
    + ' ,s.rcontr ,s.ccpaid ,s.ccconus,s.prepaidamt ,s.fmbranch,s.mobile ,s.fcamt ,s.custtype ,s.paycard,s.saned_amt,
	     s.rtncshamt,s.dfvchramt,s.frc_rtncash,s.vat_amt_rcvd,s.taxfree_sales,s.hlldscnt,s.discamt,s.No_round_nm,s.PriceVatType,s.CashDsc4RtnPrepaid,s.outside_order,s.stcpay_amt,s.Qitaf_amt,s.whlslinv , s.vat_percent);'	
	
	begin transaction
	exec sp_executesql @sqlmsg
	set @no_of_invoices=@@ROWCOUNT
	if @@error<>0 or @no_of_invoices=0
	begin
		rollback transaction
		set @errstatus=-3
		if @no_of_invoices=0 set @errstatus=0
		return 
	end

--  Make sure that the field NQATI_PRCNT is available in pos_dt
	
    declare @is_nqati_there varchar(30)=''
    set @is_nqati_there=iif(EXISTS(SELECT name FROM sys.columns
    WHERE Name = N'nqati_prcnt' AND OBJECT_ID = OBJECT_ID(N'pos_dt')),',s.nqati_prcnt);',');')
	
	set @sqlmsg='merge pos_dt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'pos_dt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' And exists(Select contr,ref From pos_hd s1 Where a.company=s1.company and a.contr = s1.contr and a.ref = s1.ref)) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, cmbkey, qty, price, barcode, dscprsnt, srlno, rtrnd, dsc_amt, offer_amt
	    , nqati_prcnt,scl_barcode,taxtype) 
	    values (s.company ,s.contr ,s.ref,s.cmbkey ,s.qty,s.price ,s.barcode ,s.dscprsnt ,s.srlno,s.rtrnd,
	            s.dsc_amt,s.offer_amt,s.nqati_prcnt,s.scl_barcode,s.taxtype);'
	
	

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-4
		return 
	end
		
	set @sqlmsg='merge POSRTNINV as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSRTNINV a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.rcontr,s.rref,s.Contr,s.ref,s.rtnamt);'

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end

	set @sqlmsg='merge POSPPCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSPPCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.disccard=s.disccard'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.disccard,s.paytype,s.prepaidamt,s.paycard,s.nodsc4promo,s.prepaidamt_rtn);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

	set @sqlmsg='merge POSCCCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSCCCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' and b.ccpaid>0) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.cccardno=s.cccardno and t.ccsrlno=s.ccsrlno'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.cccardno,s.ccsrlno,s.cardtype,s.ccpaid,
	    s.ccconus,s.chargepctg,s.chargeamt,s.cctype,s.approvl_no,s.TransDate,s.TransTime,s.TransNo,s.terminal_id);'
		
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

	set @sqlmsg='merge poschrtinv as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'poschrtinv a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.hllamt,s.chrcode);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end

	set @sqlmsg='merge posfcamt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'posfcamt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' and b.invcst>0) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.fcy,s.fcamt,s.fcyrate,s.lcamt,s.srlno);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-6
		return 
	end
	else commit transaction
	
	declare @new_cndn nvarchar(250),
	        @lpos int =0
	set @lpos=charindex('INVDATE',@whr_condn)
	set @new_cndn=substring(@whr_condn,@lpos,200)
	set @new_cndn=replace(replace(@new_cndn,'INVDATE','mnydate'),'smalldatetime','date')
	set @sqlmsg='merge pos_mny as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_mny  where '+@new_cndn+') as s'	
	+ ' on t.company=s.company and t.contr=s.contr and t.mnydate=s.mnydate and t.slpcode=s.slpcode'
    + ' when not matched then '
	+ ' insert (company,contr,mnydate,slpcode,oner,fiver,tenr,twntyr,fiftyr,hundredr,
                twohandr,fivehandr,modified,rtnval,network,prepaidamt,scrtnval,scnetwork,scprepaidamt,
				sccash,saned_amt,scsaned_amt)                
	    values (s.company,s.contr,s.mnydate,s.slpcode,s.oner,s.fiver,s.tenr,s.twntyr,s.fiftyr,s.hundredr,
                s.twohandr,s.fivehandr,s.modified,s.rtnval,s.network,s.prepaidamt'
	+ iif(@it_is_pos=0,',s.scrtnval ,s.scnetwork,s.scprepaidamt,s.sccash,s.saned_amt,s.scsaned_amt',',0,0,0,0,s.saned_amt,0')+');'
	
	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
	end
	else commit transaction
	--END TRY
	--BEGIN CATCH
	--		SET @STR_MSG ='ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +' rtncode='+@rtncode
			
	--		return @errstatus
	--END CATCH
end 






GO
/****** Object:  StoredProcedure [dbo].[Update_Pos_Auto11]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--السامر

CREATE PROCEDURE [dbo].[Update_Pos_Auto11]
 @whr_condn nvarchar(200) = 'invdate > convert(date,dateadd(day,-7,GETDATE()),112)' ,
 @brlinksrvr nvarchar(15) = 'BRLNKSRVR0111',
 @wth_slp_cntr bit = 0 ,
 @no_of_invoices int=0 output,
 @errstatus int = 0 output
	
AS
BEGIN
	declare @sqlmsg nvarchar(max)='',
	@dbc nvarchar(14) = '.dbc01y30.dbo.',
	@lcalcomp char(2) = '01',
	@yrcode char(4) = '2020',
	@syscode int =2,
	@lcauseslctr bit=0,
	@it_is_pos bit=0
---------------------------------------------------------------------------------------------
	--set @dbc=db_name()
	--set @lcalcomp=substring(@dbc,4,2)
	--set @yrcode=substring(@dbc,7,2)
	--SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
	
	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @syscode=sysno,@lcauseslctr=causeslctr  from sysdb.dbo.glcalend 
	where calcomp=@lcalcomp and yrcode=@yrcode
------------------------------------------------------------------------------------------------------------------------------

    set @errstatus=0
 --   if @syscode<>3  --set @dbc='.'+db_name()+'.dbo.'
	--else 
	--begin
------------------------------ Get Yrcode & Calcomp from Branch Boteequ  ----------------------------------------------
--		declare @dynsql nvarchar(300),
--				@params nvarchar(100)

--		set @yrcode=''
--		set @lcalcomp=''
--		set @dynsql='select top 1 @yrcd=yrcode,@lclcmp=calcomp  from '+@brlinksrvr+'.posysdb.dbo.glcalend'
--		+ ' order by yrcode desc';
--		set @params='@yrcd char(4) output,@lclcmp char(2) output';
--		exec sp_executesql @dynsql,@params,@yrcd=@yrcode output,@lclcmp=@lcalcomp output
--		if @@error<>0 or @@rowcount=0
--		begin
--		  	set @errstatus=-1
--			return 
--		end
--		if @yrcode<>'' and @lcalcomp<>'' set @dbc='.pos'+@lcalcomp+'y'+substring(@yrcode,3,2)+'.dbo.'
--		else
--		begin
--		  	set @errstatus=-2
--			return 		  
--		end
--		set @it_is_pos=1
--------------------------------------------------------------------------------------------------------------------------
--	end
    

  if @wth_slp_cntr=1
	begin
	    set @sqlmsg='merge pos_ctr as t '
		+ ' using '+@brlinksrvr+@dbc+'pos_ctr as s'
		+ ' on t.ctrcompany=s.ctrcompany and t.ctrcode=s.ctrcode'
		+ ' when matched then '
		+ ' update set t.ctrloc = s.ctrloc ,t.ctrstatus = s.ctrstatus ,t.ctrnote = s.ctrnote ,t.ctrcash = s.ctrcash'
        + ',t.ctrrpls = s.ctrrpls,t.ctrcard = s.ctrcard ,t.ctrsanet = s.ctrsanet,t.ctrsanetpctg = s.ctrsanetpctg'
        + ',t.ctrvisa = s.ctrvisa ,t.ctrvisapctg = s.ctrvisapctg ,t.ctrmaster = s.ctrmaster'
        + ',t.ctrmasterpctg = s.ctrmasterpctg,t.ctrothers = s.ctrothers ,t.ctrotherspctg = s.ctrotherspctg'
        + ',t.slcenter = s.slcenter ,t.invser = s.invser,t.drwrcomport = s.drwrcomport,t.spath = s.spath'
        + ',t.ctrserial = s.ctrserial,t.modified = s.modified,t.started = s.started ,t.ended = s.ended'
        + ',t.drawer = s.drawer,t.cdisplay = s.cdisplay ,t.slmsg = s.slmsg,t.rtnmsg = s.rtnmsg'
        + ',t.footmsg1 = s.footmsg1,t.footmsg2 = s.footmsg2,t.footmsg3 = s.footmsg3,t.saveinserver = s.saveinserver'
        + ',t.saveinvall = s.saveinvall,t.scr_open = s.scr_open,t.slnoprint = s.slnoprint,t.rtnoprint = s.rtnoprint'
        + ',t.ccconus = s.ccconus,t.upditem_hrs = s.upditem_hrs,t.updinv_hrs = s.updinv_hrs,t.prntbyclass = s.prntbyclass'
        + ',t.sltype = s.sltype,t.rttype = s.rttype,t.rptype = s.rptype,t.icrptype = s.icrptype'
        + ',t.ctrprpaid = s.ctrprpaid,t.rtfmothrs = s.rtfmothrs,t.magcard = s.magcard,t.usbdsply = s.usbdsply'
        + ',t.dsplycomport = s.dsplycomport,t.rpt_grp_items = s.rpt_grp_items,
		   t.ctrsaned=s.ctrsaned,t.ctrsndecrpos=s.ctrsndecrpos,t.ctreftpos=s.ctreftpos ,t.eftport=s.eftport'
		+ ' when not matched then '
		+ ' insert (ctrcompany,ctrcode,ctrloc,ctrstatus ,ctrnote ,ctrcash ,ctrrpls ,ctrcard,ctrsanet'
        + ',ctrsanetpctg,ctrvisa,ctrvisapctg ,ctrmaster,ctrmasterpctg,ctrothers,ctrotherspctg'
        + ',slcenter,invser ,drwrcomport,spath ,ctrserial,modified,started,ended,drawer'
        + ',cdisplay,slmsg,rtnmsg,footmsg1,footmsg2,footmsg3,saveinserver,saveinvall,scr_open'
        + ',slnoprint,rtnoprint,ccconus ,upditem_hrs,updinv_hrs,prntbyclass ,sltype ,rttype'
        + ',rptype ,icrptype,ctrprpaid ,rtfmothrs,magcard ,usbdsply,dsplycomport,rpt_grp_items,
		    ctrsaned,ctrsndecrpos,eftport,ctreftpos,ntk_printer1,ntk_printer2,grp_printers,grp_prnt_local,cshRtn_f_o_b)'
		+ ' values (s.ctrcompany,s.ctrcode,s.ctrloc,s.ctrstatus ,s.ctrnote ,s.ctrcash ,s.ctrrpls ,s.ctrcard,s.ctrsanet'
        + ',s.ctrsanetpctg,s.ctrvisa,s.ctrvisapctg ,s.ctrmaster,s.ctrmasterpctg,s.ctrothers,s.ctrotherspctg'
        + ',s.slcenter,s.invser ,s.drwrcomport,s.spath ,s.ctrserial,s.modified,s.started,s.ended,s.drawer'
        + ',s.cdisplay,s.slmsg,s.rtnmsg,s.footmsg1,s.footmsg2,s.footmsg3,s.saveinserver,s.saveinvall,s.scr_open'
        + ',s.slnoprint,s.rtnoprint,s.ccconus ,s.upditem_hrs,s.updinv_hrs,s.prntbyclass ,s.sltype ,s.rttype'
        + ',s.rptype ,s.icrptype,s.ctrprpaid ,s.rtfmothrs,s.magcard ,s.usbdsply,s.dsplycomport,s.rpt_grp_items,
		    s.ctrsaned,s.ctrsndecrpos,s.eftport,s.ctreftpos,s.ntk_printer1,s.ntk_printer2,s.grp_printers,s.grp_prnt_local,s.cshRtn_f_o_b);'
			
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-10
			return 
		end
		else commit transaction
-- t.slppassword=s.slppassword,  is rempved 08-06-2014
	    set @sqlmsg='merge pos_slp as t '
		+ ' using '+@brlinksrvr+@dbc+'pos_slp as s'
		+ ' on t.slpcompany=s.slpcompany and t.slpcode=s.slpcode'
		+ ' when matched then '
		+ ' update set t.slpname=s.slpname,t.slpaddress=s.slpaddress,t.slptel=s.slptel,'
		+ ' t.slpchgqty=s.slpchgqty,t.slpchgprice=s.slpchgprice'
        + ',t.slpdelline=s.slpdelline,t.slpothersinv=s.slpothersinv,t.slpreturn=s.slpreturn,t.slpstatus=s.slpstatus,'
		+ ' t.slpalowdisc=s.slpalowdisc,t.slpmaxdisc=s.slpmaxdisc,t.slppricetp=s.slppricetp'
        + ',t.slpalowcancel=s.slpalowcancel,t.slpalowopdr=s.slpalowopdr,t.modified=s.modified,t.slpalowexit=s.slpalowexit,'
		+ ' t.slprtwoinv=s.slprtwoinv,t.slpblowbal=s.slpblowbal,t.scr_open=s.scr_open'
        + ',t.alwitmdsc=s.alwitmdsc,t.maxitmdsc=s.maxitmdsc ,t.alwuserpls=s.alwuserpls ,t.alwuseicrpls=s.alwuseicrpls,'
		+ 't.slpmagnetic=s.slpmagnetic,t.alwusebrrtn=s.alwusebrrtn,t.alwreprint=s.alwreprint'
        + ',t.frcrplinv=s.frcrplinv,t.catch_thief=s.catch_thief,t.sold_once=s.sold_once,t.only_scan_bc=s.only_scan_bc,'
		+ 't.stop_item_column=s.stop_item_column,t.slpfpalw=s.slpfpalw,t.slpfpimage=s.slpfpimage'
        + ',t.slcenter=s.slcenter,t.salesquota=s.salesquota,t.commissionP=s.commissionP,t.bonus=s.bonus,
		    t.supervisor=s.supervisor,t.ReadInvByBarcd=s.ReadInvByBarcd,
			t.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,t.alwcshcardpay=s.alwcshcardpay,'
		+ 't.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,t.slp_hlldscamtMax=s.slp_hlldscamtMax,t.alwprnttmpinv=s.alwprnttmpinv,s.ignore_mnmprice=s.ignore_mnmprice'
		
		+ ' when not matched then '
		+ ' insert values (s.slpcompany,s.slpcode,s.slpname,s.slpaddress,s.slptel,s.slppassword,s.slpchgqty,s.slpchgprice'
        + ',s.slpdelline,s.slpothersinv,s.slpreturn,s.slpstatus,s.slpalowdisc,s.slpmaxdisc,s.slppricetp'
        + ',s.slpalowcancel,s.slpalowopdr,s.modified,s.slpalowexit,s.slprtwoinv,s.slpblowbal,s.scr_open'
        + ',s.alwitmdsc,s.maxitmdsc ,s.alwuserpls ,s.alwuseicrpls,s.slpmagnetic,s.alwusebrrtn,s.alwreprint'
        + ',s.frcrplinv,s.catch_thief,s.sold_once,s.only_scan_bc,s.stop_item_column,s.slpfpalw,s.slpfpimage'
        + ',s.slcenter,s.salesquota,s.commissionP,s.bonus,s.supervisor,s.ReadInvByBarcd,s.alwrtncash,
		   s.alwmtchrtn,s.alwinvtrnsfr,s.alwcshcardpay,s.alwrtncash,s.alwmtchrtn,s.alwinvtrnsfr,s.slp_hlldscamtMax,s.alwprnttmpinv,s.ignore_mnmprice);'
		   
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-11
			return 
		end
		else commit transaction
	end
------------------------------------------------------------------------------------------------------------------------
	set @sqlmsg='merge pos_hd as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_hd b where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, invdate, entries, slperson, paytype, chargepctg, chargeamt, invdspc, disccard, 
		cardtype, invttl, invcst, invdsvl, valafds, invpaid, pricetp, slcenter, invorrtrn, cashamt, modified, 
		salinvno, salctrno, tdatetime, cktype, geninv, rref, rcontr, ccpaid, ccconus, prepaidamt, fmbranch,
		mobile, fcamt, custtype, paycard, saned_amt,rtncshamt,dfvchramt,frc_rtncash,vat_amt_rcvd,taxfree_sales,hlldscnt,discamt,No_round_nm,PriceVatType,CashDsc4RtnPrepaid,outside_order,stcpay_amt,Qitaf_amt,whlslinv , vat_percent)'
	+ ' values (s.company,s.contr,s.ref,s.invdate,s.entries,s.slperson ,s.paytype,s.chargepctg,s.chargeamt'
    + ' ,s.invdspc ,s.disccard ,s.cardtype ,s.invttl,s.invcst,s.invdsvl,s.valafds ,s.invpaid,s.pricetp,s.slcenter'
    + ' ,s.invorrtrn ,s.cashamt,s.modified ,s.salinvno ,s.salctrno ,s.tdatetime ,s.cktype ,s.geninv ,s.rref'
    + ' ,s.rcontr ,s.ccpaid ,s.ccconus,s.prepaidamt ,s.fmbranch,s.mobile ,s.fcamt ,s.custtype ,s.paycard,s.saned_amt,
	     s.rtncshamt,s.dfvchramt,s.frc_rtncash,s.vat_amt_rcvd,s.taxfree_sales,s.hlldscnt,s.discamt,s.No_round_nm,s.PriceVatType,s.CashDsc4RtnPrepaid,s.outside_order,s.stcpay_amt,s.Qitaf_amt,s.whlslinv , s.vat_percent);'	
	
	begin transaction
	exec sp_executesql @sqlmsg
	set @no_of_invoices=@@ROWCOUNT
	if @@error<>0 or @no_of_invoices=0
	begin
		rollback transaction
		set @errstatus=-3
		if @no_of_invoices=0 set @errstatus=0
		return 
	end

--  Make sure that the field NQATI_PRCNT is available in pos_dt
	
    declare @is_nqati_there varchar(30)=''
    set @is_nqati_there=iif(EXISTS(SELECT name FROM sys.columns
    WHERE Name = N'nqati_prcnt' AND OBJECT_ID = OBJECT_ID(N'pos_dt')),',s.nqati_prcnt);',');')
	
	set @sqlmsg='merge pos_dt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'pos_dt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' And exists(Select contr,ref From pos_hd s1 Where a.company=s1.company and a.contr = s1.contr and a.ref = s1.ref)) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, cmbkey, qty, price, barcode, dscprsnt, srlno, rtrnd, dsc_amt, offer_amt
	    , nqati_prcnt,scl_barcode,taxtype) 
	    values (s.company ,s.contr ,s.ref,s.cmbkey ,s.qty,s.price ,s.barcode ,s.dscprsnt ,s.srlno,s.rtrnd,
	            s.dsc_amt,s.offer_amt,s.nqati_prcnt,s.scl_barcode,s.taxtype);'
	
	

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-4
		return 
	end
		
	set @sqlmsg='merge POSRTNINV as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSRTNINV a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.rcontr,s.rref,s.Contr,s.ref,s.rtnamt);'

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end

	set @sqlmsg='merge POSPPCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSPPCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.disccard=s.disccard'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.disccard,s.paytype,s.prepaidamt,s.paycard,s.nodsc4promo,s.prepaidamt_rtn);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

	set @sqlmsg='merge POSCCCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSCCCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' and b.ccpaid>0) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.cccardno=s.cccardno and t.ccsrlno=s.ccsrlno'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.cccardno,s.ccsrlno,s.cardtype,s.ccpaid,
	    s.ccconus,s.chargepctg,s.chargeamt,s.cctype,s.approvl_no,s.TransDate,s.TransTime,s.TransNo,s.terminal_id);'
		
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

	set @sqlmsg='merge poschrtinv as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'poschrtinv a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.hllamt,s.chrcode);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end

	set @sqlmsg='merge posfcamt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'posfcamt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' and b.invcst>0) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.fcy,s.fcamt,s.fcyrate,s.lcamt,s.srlno);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-6
		return 
	end
	else commit transaction
	
	declare @new_cndn nvarchar(250),
	        @lpos int =0
	set @lpos=charindex('INVDATE',@whr_condn)
	set @new_cndn=substring(@whr_condn,@lpos,200)
	set @new_cndn=replace(replace(@new_cndn,'INVDATE','mnydate'),'smalldatetime','date')
	set @sqlmsg='merge pos_mny as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_mny  where '+@new_cndn+') as s'	
	+ ' on t.company=s.company and t.contr=s.contr and t.mnydate=s.mnydate and t.slpcode=s.slpcode'
    + ' when not matched then '
	+ ' insert (company,contr,mnydate,slpcode,oner,fiver,tenr,twntyr,fiftyr,hundredr,
                twohandr,fivehandr,modified,rtnval,network,prepaidamt,scrtnval,scnetwork,scprepaidamt,
				sccash,saned_amt,scsaned_amt)                
	    values (s.company,s.contr,s.mnydate,s.slpcode,s.oner,s.fiver,s.tenr,s.twntyr,s.fiftyr,s.hundredr,
                s.twohandr,s.fivehandr,s.modified,s.rtnval,s.network,s.prepaidamt'
	+ iif(@it_is_pos=0,',s.scrtnval ,s.scnetwork,s.scprepaidamt,s.sccash,s.saned_amt,s.scsaned_amt',',0,0,0,0,s.saned_amt,0')+');'
	
	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
	end
	else commit transaction
	--END TRY
	--BEGIN CATCH
	--		SET @STR_MSG ='ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +' rtncode='+@rtncode
			
	--		return @errstatus
	--END CATCH
end 






GO
/****** Object:  StoredProcedure [dbo].[Update_Pos_Auto12]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--كوكتيل

CREATE PROCEDURE [dbo].[Update_Pos_Auto12]
 @whr_condn nvarchar(200) = 'invdate > convert(date,dateadd(day,-7,GETDATE()),112)' ,
 @brlinksrvr nvarchar(15) = 'BRLNKSRVR0112',
 @wth_slp_cntr bit = 0 ,
 @no_of_invoices int=0 output,
 @errstatus int = 0 output
	
AS
BEGIN
	declare @sqlmsg nvarchar(max)='',
	@dbc nvarchar(14) = '.dbc01y30.dbo.',
	@lcalcomp char(2) = '01',
	@yrcode char(4) = '2020',
	@syscode int =2,
	@lcauseslctr bit=0,
	@it_is_pos bit=0
---------------------------------------------------------------------------------------------
	--set @dbc=db_name()
	--set @lcalcomp=substring(@dbc,4,2)
	--set @yrcode=substring(@dbc,7,2)
	--SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
	
	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @syscode=sysno,@lcauseslctr=causeslctr  from sysdb.dbo.glcalend 
	where calcomp=@lcalcomp and yrcode=@yrcode
------------------------------------------------------------------------------------------------------------------------------

    set @errstatus=0
 --   if @syscode<>3  --set @dbc='.'+db_name()+'.dbo.'
	--else 
	--begin
------------------------------ Get Yrcode & Calcomp from Branch Boteequ  ----------------------------------------------
--		declare @dynsql nvarchar(300),
--				@params nvarchar(100)

--		set @yrcode=''
--		set @lcalcomp=''
--		set @dynsql='select top 1 @yrcd=yrcode,@lclcmp=calcomp  from '+@brlinksrvr+'.posysdb.dbo.glcalend'
--		+ ' order by yrcode desc';
--		set @params='@yrcd char(4) output,@lclcmp char(2) output';
--		exec sp_executesql @dynsql,@params,@yrcd=@yrcode output,@lclcmp=@lcalcomp output
--		if @@error<>0 or @@rowcount=0
--		begin
--		  	set @errstatus=-1
--			return 
--		end
--		if @yrcode<>'' and @lcalcomp<>'' set @dbc='.pos'+@lcalcomp+'y'+substring(@yrcode,3,2)+'.dbo.'
--		else
--		begin
--		  	set @errstatus=-2
--			return 		  
--		end
--		set @it_is_pos=1
--------------------------------------------------------------------------------------------------------------------------
--	end
    

  if @wth_slp_cntr=1
	begin
	    set @sqlmsg='merge pos_ctr as t '
		+ ' using '+@brlinksrvr+@dbc+'pos_ctr as s'
		+ ' on t.ctrcompany=s.ctrcompany and t.ctrcode=s.ctrcode'
		+ ' when matched then '
		+ ' update set t.ctrloc = s.ctrloc ,t.ctrstatus = s.ctrstatus ,t.ctrnote = s.ctrnote ,t.ctrcash = s.ctrcash'
        + ',t.ctrrpls = s.ctrrpls,t.ctrcard = s.ctrcard ,t.ctrsanet = s.ctrsanet,t.ctrsanetpctg = s.ctrsanetpctg'
        + ',t.ctrvisa = s.ctrvisa ,t.ctrvisapctg = s.ctrvisapctg ,t.ctrmaster = s.ctrmaster'
        + ',t.ctrmasterpctg = s.ctrmasterpctg,t.ctrothers = s.ctrothers ,t.ctrotherspctg = s.ctrotherspctg'
        + ',t.slcenter = s.slcenter ,t.invser = s.invser,t.drwrcomport = s.drwrcomport,t.spath = s.spath'
        + ',t.ctrserial = s.ctrserial,t.modified = s.modified,t.started = s.started ,t.ended = s.ended'
        + ',t.drawer = s.drawer,t.cdisplay = s.cdisplay ,t.slmsg = s.slmsg,t.rtnmsg = s.rtnmsg'
        + ',t.footmsg1 = s.footmsg1,t.footmsg2 = s.footmsg2,t.footmsg3 = s.footmsg3,t.saveinserver = s.saveinserver'
        + ',t.saveinvall = s.saveinvall,t.scr_open = s.scr_open,t.slnoprint = s.slnoprint,t.rtnoprint = s.rtnoprint'
        + ',t.ccconus = s.ccconus,t.upditem_hrs = s.upditem_hrs,t.updinv_hrs = s.updinv_hrs,t.prntbyclass = s.prntbyclass'
        + ',t.sltype = s.sltype,t.rttype = s.rttype,t.rptype = s.rptype,t.icrptype = s.icrptype'
        + ',t.ctrprpaid = s.ctrprpaid,t.rtfmothrs = s.rtfmothrs,t.magcard = s.magcard,t.usbdsply = s.usbdsply'
        + ',t.dsplycomport = s.dsplycomport,t.rpt_grp_items = s.rpt_grp_items,
		   t.ctrsaned=s.ctrsaned,t.ctrsndecrpos=s.ctrsndecrpos,t.ctreftpos=s.ctreftpos ,t.eftport=s.eftport'
		+ ' when not matched then '
		+ ' insert (ctrcompany,ctrcode,ctrloc,ctrstatus ,ctrnote ,ctrcash ,ctrrpls ,ctrcard,ctrsanet'
        + ',ctrsanetpctg,ctrvisa,ctrvisapctg ,ctrmaster,ctrmasterpctg,ctrothers,ctrotherspctg'
        + ',slcenter,invser ,drwrcomport,spath ,ctrserial,modified,started,ended,drawer'
        + ',cdisplay,slmsg,rtnmsg,footmsg1,footmsg2,footmsg3,saveinserver,saveinvall,scr_open'
        + ',slnoprint,rtnoprint,ccconus ,upditem_hrs,updinv_hrs,prntbyclass ,sltype ,rttype'
        + ',rptype ,icrptype,ctrprpaid ,rtfmothrs,magcard ,usbdsply,dsplycomport,rpt_grp_items,
		    ctrsaned,ctrsndecrpos,eftport,ctreftpos,ntk_printer1,ntk_printer2,grp_printers,grp_prnt_local,cshRtn_f_o_b)'
		+ ' values (s.ctrcompany,s.ctrcode,s.ctrloc,s.ctrstatus ,s.ctrnote ,s.ctrcash ,s.ctrrpls ,s.ctrcard,s.ctrsanet'
        + ',s.ctrsanetpctg,s.ctrvisa,s.ctrvisapctg ,s.ctrmaster,s.ctrmasterpctg,s.ctrothers,s.ctrotherspctg'
        + ',s.slcenter,s.invser ,s.drwrcomport,s.spath ,s.ctrserial,s.modified,s.started,s.ended,s.drawer'
        + ',s.cdisplay,s.slmsg,s.rtnmsg,s.footmsg1,s.footmsg2,s.footmsg3,s.saveinserver,s.saveinvall,s.scr_open'
        + ',s.slnoprint,s.rtnoprint,s.ccconus ,s.upditem_hrs,s.updinv_hrs,s.prntbyclass ,s.sltype ,s.rttype'
        + ',s.rptype ,s.icrptype,s.ctrprpaid ,s.rtfmothrs,s.magcard ,s.usbdsply,s.dsplycomport,s.rpt_grp_items,
		    s.ctrsaned,s.ctrsndecrpos,s.eftport,s.ctreftpos,s.ntk_printer1,s.ntk_printer2,s.grp_printers,s.grp_prnt_local,s.cshRtn_f_o_b);'
			
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-10
			return 
		end
		else commit transaction
-- t.slppassword=s.slppassword,  is rempved 08-06-2014
	    set @sqlmsg='merge pos_slp as t '
		+ ' using '+@brlinksrvr+@dbc+'pos_slp as s'
		+ ' on t.slpcompany=s.slpcompany and t.slpcode=s.slpcode'
		+ ' when matched then '
		+ ' update set t.slpname=s.slpname,t.slpaddress=s.slpaddress,t.slptel=s.slptel,'
		+ ' t.slpchgqty=s.slpchgqty,t.slpchgprice=s.slpchgprice'
        + ',t.slpdelline=s.slpdelline,t.slpothersinv=s.slpothersinv,t.slpreturn=s.slpreturn,t.slpstatus=s.slpstatus,'
		+ ' t.slpalowdisc=s.slpalowdisc,t.slpmaxdisc=s.slpmaxdisc,t.slppricetp=s.slppricetp'
        + ',t.slpalowcancel=s.slpalowcancel,t.slpalowopdr=s.slpalowopdr,t.modified=s.modified,t.slpalowexit=s.slpalowexit,'
		+ ' t.slprtwoinv=s.slprtwoinv,t.slpblowbal=s.slpblowbal,t.scr_open=s.scr_open'
        + ',t.alwitmdsc=s.alwitmdsc,t.maxitmdsc=s.maxitmdsc ,t.alwuserpls=s.alwuserpls ,t.alwuseicrpls=s.alwuseicrpls,'
		+ 't.slpmagnetic=s.slpmagnetic,t.alwusebrrtn=s.alwusebrrtn,t.alwreprint=s.alwreprint'
        + ',t.frcrplinv=s.frcrplinv,t.catch_thief=s.catch_thief,t.sold_once=s.sold_once,t.only_scan_bc=s.only_scan_bc,'
		+ 't.stop_item_column=s.stop_item_column,t.slpfpalw=s.slpfpalw,t.slpfpimage=s.slpfpimage'
        + ',t.slcenter=s.slcenter,t.salesquota=s.salesquota,t.commissionP=s.commissionP,t.bonus=s.bonus,
		    t.supervisor=s.supervisor,t.ReadInvByBarcd=s.ReadInvByBarcd,
			t.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,t.alwcshcardpay=s.alwcshcardpay,'
		+ 't.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,t.slp_hlldscamtMax=s.slp_hlldscamtMax,t.alwprnttmpinv=s.alwprnttmpinv,s.ignore_mnmprice=s.ignore_mnmprice'
		
		+ ' when not matched then '
		+ ' insert values (s.slpcompany,s.slpcode,s.slpname,s.slpaddress,s.slptel,s.slppassword,s.slpchgqty,s.slpchgprice'
        + ',s.slpdelline,s.slpothersinv,s.slpreturn,s.slpstatus,s.slpalowdisc,s.slpmaxdisc,s.slppricetp'
        + ',s.slpalowcancel,s.slpalowopdr,s.modified,s.slpalowexit,s.slprtwoinv,s.slpblowbal,s.scr_open'
        + ',s.alwitmdsc,s.maxitmdsc ,s.alwuserpls ,s.alwuseicrpls,s.slpmagnetic,s.alwusebrrtn,s.alwreprint'
        + ',s.frcrplinv,s.catch_thief,s.sold_once,s.only_scan_bc,s.stop_item_column,s.slpfpalw,s.slpfpimage'
        + ',s.slcenter,s.salesquota,s.commissionP,s.bonus,s.supervisor,s.ReadInvByBarcd,s.alwrtncash,
		   s.alwmtchrtn,s.alwinvtrnsfr,s.alwcshcardpay,s.alwrtncash,s.alwmtchrtn,s.alwinvtrnsfr,s.slp_hlldscamtMax,s.alwprnttmpinv,s.ignore_mnmprice);'
		   
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-11
			return 
		end
		else commit transaction
	end
------------------------------------------------------------------------------------------------------------------------
	set @sqlmsg='merge pos_hd as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_hd b where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, invdate, entries, slperson, paytype, chargepctg, chargeamt, invdspc, disccard, 
		cardtype, invttl, invcst, invdsvl, valafds, invpaid, pricetp, slcenter, invorrtrn, cashamt, modified, 
		salinvno, salctrno, tdatetime, cktype, geninv, rref, rcontr, ccpaid, ccconus, prepaidamt, fmbranch,
		mobile, fcamt, custtype, paycard, saned_amt,rtncshamt,dfvchramt,frc_rtncash,vat_amt_rcvd,taxfree_sales,hlldscnt,discamt,No_round_nm,PriceVatType,CashDsc4RtnPrepaid,outside_order,stcpay_amt,Qitaf_amt,whlslinv , vat_percent)'
	+ ' values (s.company,s.contr,s.ref,s.invdate,s.entries,s.slperson ,s.paytype,s.chargepctg,s.chargeamt'
    + ' ,s.invdspc ,s.disccard ,s.cardtype ,s.invttl,s.invcst,s.invdsvl,s.valafds ,s.invpaid,s.pricetp,s.slcenter'
    + ' ,s.invorrtrn ,s.cashamt,s.modified ,s.salinvno ,s.salctrno ,s.tdatetime ,s.cktype ,s.geninv ,s.rref'
    + ' ,s.rcontr ,s.ccpaid ,s.ccconus,s.prepaidamt ,s.fmbranch,s.mobile ,s.fcamt ,s.custtype ,s.paycard,s.saned_amt,
	     s.rtncshamt,s.dfvchramt,s.frc_rtncash,s.vat_amt_rcvd,s.taxfree_sales,s.hlldscnt,s.discamt,s.No_round_nm,s.PriceVatType,s.CashDsc4RtnPrepaid,s.outside_order,s.stcpay_amt,s.Qitaf_amt,s.whlslinv , s.vat_percent);'	
	
	begin transaction
	exec sp_executesql @sqlmsg
	set @no_of_invoices=@@ROWCOUNT
	if @@error<>0 or @no_of_invoices=0
	begin
		rollback transaction
		set @errstatus=-3
		if @no_of_invoices=0 set @errstatus=0
		return 
	end

--  Make sure that the field NQATI_PRCNT is available in pos_dt
	
    declare @is_nqati_there varchar(30)=''
    set @is_nqati_there=iif(EXISTS(SELECT name FROM sys.columns
    WHERE Name = N'nqati_prcnt' AND OBJECT_ID = OBJECT_ID(N'pos_dt')),',s.nqati_prcnt);',');')
	
	set @sqlmsg='merge pos_dt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'pos_dt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' And exists(Select contr,ref From pos_hd s1 Where a.company=s1.company and a.contr = s1.contr and a.ref = s1.ref)) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, cmbkey, qty, price, barcode, dscprsnt, srlno, rtrnd, dsc_amt, offer_amt
	    , nqati_prcnt,scl_barcode,taxtype) 
	    values (s.company ,s.contr ,s.ref,s.cmbkey ,s.qty,s.price ,s.barcode ,s.dscprsnt ,s.srlno,s.rtrnd,
	            s.dsc_amt,s.offer_amt,s.nqati_prcnt,s.scl_barcode,s.taxtype);'
	
	

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-4
		return 
	end
		
	set @sqlmsg='merge POSRTNINV as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSRTNINV a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.rcontr,s.rref,s.Contr,s.ref,s.rtnamt);'

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end

	set @sqlmsg='merge POSPPCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSPPCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.disccard=s.disccard'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.disccard,s.paytype,s.prepaidamt,s.paycard,s.nodsc4promo,s.prepaidamt_rtn);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

	set @sqlmsg='merge POSCCCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSCCCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' and b.ccpaid>0) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.cccardno=s.cccardno and t.ccsrlno=s.ccsrlno'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.cccardno,s.ccsrlno,s.cardtype,s.ccpaid,
	    s.ccconus,s.chargepctg,s.chargeamt,s.cctype,s.approvl_no,s.TransDate,s.TransTime,s.TransNo,s.terminal_id);'
		
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

	set @sqlmsg='merge poschrtinv as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'poschrtinv a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.hllamt,s.chrcode);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end

	set @sqlmsg='merge posfcamt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'posfcamt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' and b.invcst>0) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.fcy,s.fcamt,s.fcyrate,s.lcamt,s.srlno);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-6
		return 
	end
	else commit transaction
	
	declare @new_cndn nvarchar(250),
	        @lpos int =0
	set @lpos=charindex('INVDATE',@whr_condn)
	set @new_cndn=substring(@whr_condn,@lpos,200)
	set @new_cndn=replace(replace(@new_cndn,'INVDATE','mnydate'),'smalldatetime','date')
	set @sqlmsg='merge pos_mny as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_mny  where '+@new_cndn+') as s'	
	+ ' on t.company=s.company and t.contr=s.contr and t.mnydate=s.mnydate and t.slpcode=s.slpcode'
    + ' when not matched then '
	+ ' insert (company,contr,mnydate,slpcode,oner,fiver,tenr,twntyr,fiftyr,hundredr,
                twohandr,fivehandr,modified,rtnval,network,prepaidamt,scrtnval,scnetwork,scprepaidamt,
				sccash,saned_amt,scsaned_amt)                
	    values (s.company,s.contr,s.mnydate,s.slpcode,s.oner,s.fiver,s.tenr,s.twntyr,s.fiftyr,s.hundredr,
                s.twohandr,s.fivehandr,s.modified,s.rtnval,s.network,s.prepaidamt'
	+ iif(@it_is_pos=0,',s.scrtnval ,s.scnetwork,s.scprepaidamt,s.sccash,s.saned_amt,s.scsaned_amt',',0,0,0,0,s.saned_amt,0')+');'
	
	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
	end
	else commit transaction
	--END TRY
	--BEGIN CATCH
	--		SET @STR_MSG ='ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +' rtncode='+@rtncode
			
	--		return @errstatus
	--END CATCH
end 






GO
/****** Object:  StoredProcedure [dbo].[Update_Pos_Auto13]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--حراء

CREATE PROCEDURE [dbo].[Update_Pos_Auto13]
 @whr_condn nvarchar(200) = 'invdate > convert(date,dateadd(day,-7,GETDATE()),112)' ,
 @brlinksrvr nvarchar(15) = 'BRLNKSRVR0113',
 @wth_slp_cntr bit = 0 ,
 @no_of_invoices int=0 output,
 @errstatus int = 0 output
	
AS
BEGIN
	declare @sqlmsg nvarchar(max)='',
	@dbc nvarchar(14) = '.dbc01y30.dbo.',
	@lcalcomp char(2) = '01',
	@yrcode char(4) = '2020',
	@syscode int =2,
	@lcauseslctr bit=0,
	@it_is_pos bit=0
---------------------------------------------------------------------------------------------
	--set @dbc=db_name()
	--set @lcalcomp=substring(@dbc,4,2)
	--set @yrcode=substring(@dbc,7,2)
	--SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
	
	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @syscode=sysno,@lcauseslctr=causeslctr  from sysdb.dbo.glcalend 
	where calcomp=@lcalcomp and yrcode=@yrcode
------------------------------------------------------------------------------------------------------------------------------

    set @errstatus=0
 --   if @syscode<>3  --set @dbc='.'+db_name()+'.dbo.'
	--else 
	--begin
------------------------------ Get Yrcode & Calcomp from Branch Boteequ  ----------------------------------------------
--		declare @dynsql nvarchar(300),
--				@params nvarchar(100)

--		set @yrcode=''
--		set @lcalcomp=''
--		set @dynsql='select top 1 @yrcd=yrcode,@lclcmp=calcomp  from '+@brlinksrvr+'.posysdb.dbo.glcalend'
--		+ ' order by yrcode desc';
--		set @params='@yrcd char(4) output,@lclcmp char(2) output';
--		exec sp_executesql @dynsql,@params,@yrcd=@yrcode output,@lclcmp=@lcalcomp output
--		if @@error<>0 or @@rowcount=0
--		begin
--		  	set @errstatus=-1
--			return 
--		end
--		if @yrcode<>'' and @lcalcomp<>'' set @dbc='.pos'+@lcalcomp+'y'+substring(@yrcode,3,2)+'.dbo.'
--		else
--		begin
--		  	set @errstatus=-2
--			return 		  
--		end
--		set @it_is_pos=1
--------------------------------------------------------------------------------------------------------------------------
--	end
    

  if @wth_slp_cntr=1
	begin
	    set @sqlmsg='merge pos_ctr as t '
		+ ' using '+@brlinksrvr+@dbc+'pos_ctr as s'
		+ ' on t.ctrcompany=s.ctrcompany and t.ctrcode=s.ctrcode'
		+ ' when matched then '
		+ ' update set t.ctrloc = s.ctrloc ,t.ctrstatus = s.ctrstatus ,t.ctrnote = s.ctrnote ,t.ctrcash = s.ctrcash'
        + ',t.ctrrpls = s.ctrrpls,t.ctrcard = s.ctrcard ,t.ctrsanet = s.ctrsanet,t.ctrsanetpctg = s.ctrsanetpctg'
        + ',t.ctrvisa = s.ctrvisa ,t.ctrvisapctg = s.ctrvisapctg ,t.ctrmaster = s.ctrmaster'
        + ',t.ctrmasterpctg = s.ctrmasterpctg,t.ctrothers = s.ctrothers ,t.ctrotherspctg = s.ctrotherspctg'
        + ',t.slcenter = s.slcenter ,t.invser = s.invser,t.drwrcomport = s.drwrcomport,t.spath = s.spath'
        + ',t.ctrserial = s.ctrserial,t.modified = s.modified,t.started = s.started ,t.ended = s.ended'
        + ',t.drawer = s.drawer,t.cdisplay = s.cdisplay ,t.slmsg = s.slmsg,t.rtnmsg = s.rtnmsg'
        + ',t.footmsg1 = s.footmsg1,t.footmsg2 = s.footmsg2,t.footmsg3 = s.footmsg3,t.saveinserver = s.saveinserver'
        + ',t.saveinvall = s.saveinvall,t.scr_open = s.scr_open,t.slnoprint = s.slnoprint,t.rtnoprint = s.rtnoprint'
        + ',t.ccconus = s.ccconus,t.upditem_hrs = s.upditem_hrs,t.updinv_hrs = s.updinv_hrs,t.prntbyclass = s.prntbyclass'
        + ',t.sltype = s.sltype,t.rttype = s.rttype,t.rptype = s.rptype,t.icrptype = s.icrptype'
        + ',t.ctrprpaid = s.ctrprpaid,t.rtfmothrs = s.rtfmothrs,t.magcard = s.magcard,t.usbdsply = s.usbdsply'
        + ',t.dsplycomport = s.dsplycomport,t.rpt_grp_items = s.rpt_grp_items,
		   t.ctrsaned=s.ctrsaned,t.ctrsndecrpos=s.ctrsndecrpos,t.ctreftpos=s.ctreftpos ,t.eftport=s.eftport'
		+ ' when not matched then '
		+ ' insert (ctrcompany,ctrcode,ctrloc,ctrstatus ,ctrnote ,ctrcash ,ctrrpls ,ctrcard,ctrsanet'
        + ',ctrsanetpctg,ctrvisa,ctrvisapctg ,ctrmaster,ctrmasterpctg,ctrothers,ctrotherspctg'
        + ',slcenter,invser ,drwrcomport,spath ,ctrserial,modified,started,ended,drawer'
        + ',cdisplay,slmsg,rtnmsg,footmsg1,footmsg2,footmsg3,saveinserver,saveinvall,scr_open'
        + ',slnoprint,rtnoprint,ccconus ,upditem_hrs,updinv_hrs,prntbyclass ,sltype ,rttype'
        + ',rptype ,icrptype,ctrprpaid ,rtfmothrs,magcard ,usbdsply,dsplycomport,rpt_grp_items,
		    ctrsaned,ctrsndecrpos,eftport,ctreftpos,ntk_printer1,ntk_printer2,grp_printers,grp_prnt_local,cshRtn_f_o_b)'
		+ ' values (s.ctrcompany,s.ctrcode,s.ctrloc,s.ctrstatus ,s.ctrnote ,s.ctrcash ,s.ctrrpls ,s.ctrcard,s.ctrsanet'
        + ',s.ctrsanetpctg,s.ctrvisa,s.ctrvisapctg ,s.ctrmaster,s.ctrmasterpctg,s.ctrothers,s.ctrotherspctg'
        + ',s.slcenter,s.invser ,s.drwrcomport,s.spath ,s.ctrserial,s.modified,s.started,s.ended,s.drawer'
        + ',s.cdisplay,s.slmsg,s.rtnmsg,s.footmsg1,s.footmsg2,s.footmsg3,s.saveinserver,s.saveinvall,s.scr_open'
        + ',s.slnoprint,s.rtnoprint,s.ccconus ,s.upditem_hrs,s.updinv_hrs,s.prntbyclass ,s.sltype ,s.rttype'
        + ',s.rptype ,s.icrptype,s.ctrprpaid ,s.rtfmothrs,s.magcard ,s.usbdsply,s.dsplycomport,s.rpt_grp_items,
		    s.ctrsaned,s.ctrsndecrpos,s.eftport,s.ctreftpos,s.ntk_printer1,s.ntk_printer2,s.grp_printers,s.grp_prnt_local,s.cshRtn_f_o_b);'
			
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-10
			return 
		end
		else commit transaction
-- t.slppassword=s.slppassword,  is rempved 08-06-2014
	    set @sqlmsg='merge pos_slp as t '
		+ ' using '+@brlinksrvr+@dbc+'pos_slp as s'
		+ ' on t.slpcompany=s.slpcompany and t.slpcode=s.slpcode'
		+ ' when matched then '
		+ ' update set t.slpname=s.slpname,t.slpaddress=s.slpaddress,t.slptel=s.slptel,'
		+ ' t.slpchgqty=s.slpchgqty,t.slpchgprice=s.slpchgprice'
        + ',t.slpdelline=s.slpdelline,t.slpothersinv=s.slpothersinv,t.slpreturn=s.slpreturn,t.slpstatus=s.slpstatus,'
		+ ' t.slpalowdisc=s.slpalowdisc,t.slpmaxdisc=s.slpmaxdisc,t.slppricetp=s.slppricetp'
        + ',t.slpalowcancel=s.slpalowcancel,t.slpalowopdr=s.slpalowopdr,t.modified=s.modified,t.slpalowexit=s.slpalowexit,'
		+ ' t.slprtwoinv=s.slprtwoinv,t.slpblowbal=s.slpblowbal,t.scr_open=s.scr_open'
        + ',t.alwitmdsc=s.alwitmdsc,t.maxitmdsc=s.maxitmdsc ,t.alwuserpls=s.alwuserpls ,t.alwuseicrpls=s.alwuseicrpls,'
		+ 't.slpmagnetic=s.slpmagnetic,t.alwusebrrtn=s.alwusebrrtn,t.alwreprint=s.alwreprint'
        + ',t.frcrplinv=s.frcrplinv,t.catch_thief=s.catch_thief,t.sold_once=s.sold_once,t.only_scan_bc=s.only_scan_bc,'
		+ 't.stop_item_column=s.stop_item_column,t.slpfpalw=s.slpfpalw,t.slpfpimage=s.slpfpimage'
        + ',t.slcenter=s.slcenter,t.salesquota=s.salesquota,t.commissionP=s.commissionP,t.bonus=s.bonus,
		    t.supervisor=s.supervisor,t.ReadInvByBarcd=s.ReadInvByBarcd,
			t.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,t.alwcshcardpay=s.alwcshcardpay,'
		+ 't.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,t.slp_hlldscamtMax=s.slp_hlldscamtMax,t.alwprnttmpinv=s.alwprnttmpinv,s.ignore_mnmprice=s.ignore_mnmprice'
		
		+ ' when not matched then '
		+ ' insert values (s.slpcompany,s.slpcode,s.slpname,s.slpaddress,s.slptel,s.slppassword,s.slpchgqty,s.slpchgprice'
        + ',s.slpdelline,s.slpothersinv,s.slpreturn,s.slpstatus,s.slpalowdisc,s.slpmaxdisc,s.slppricetp'
        + ',s.slpalowcancel,s.slpalowopdr,s.modified,s.slpalowexit,s.slprtwoinv,s.slpblowbal,s.scr_open'
        + ',s.alwitmdsc,s.maxitmdsc ,s.alwuserpls ,s.alwuseicrpls,s.slpmagnetic,s.alwusebrrtn,s.alwreprint'
        + ',s.frcrplinv,s.catch_thief,s.sold_once,s.only_scan_bc,s.stop_item_column,s.slpfpalw,s.slpfpimage'
        + ',s.slcenter,s.salesquota,s.commissionP,s.bonus,s.supervisor,s.ReadInvByBarcd,s.alwrtncash,
		   s.alwmtchrtn,s.alwinvtrnsfr,s.alwcshcardpay,s.alwrtncash,s.alwmtchrtn,s.alwinvtrnsfr,s.slp_hlldscamtMax,s.alwprnttmpinv,s.ignore_mnmprice);'
		   
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-11
			return 
		end
		else commit transaction
	end
------------------------------------------------------------------------------------------------------------------------
	set @sqlmsg='merge pos_hd as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_hd b where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, invdate, entries, slperson, paytype, chargepctg, chargeamt, invdspc, disccard, 
		cardtype, invttl, invcst, invdsvl, valafds, invpaid, pricetp, slcenter, invorrtrn, cashamt, modified, 
		salinvno, salctrno, tdatetime, cktype, geninv, rref, rcontr, ccpaid, ccconus, prepaidamt, fmbranch,
		mobile, fcamt, custtype, paycard, saned_amt,rtncshamt,dfvchramt,frc_rtncash,vat_amt_rcvd,taxfree_sales,hlldscnt,discamt,No_round_nm,PriceVatType,CashDsc4RtnPrepaid,outside_order,stcpay_amt,Qitaf_amt,whlslinv , vat_percent)'
	+ ' values (s.company,s.contr,s.ref,s.invdate,s.entries,s.slperson ,s.paytype,s.chargepctg,s.chargeamt'
    + ' ,s.invdspc ,s.disccard ,s.cardtype ,s.invttl,s.invcst,s.invdsvl,s.valafds ,s.invpaid,s.pricetp,s.slcenter'
    + ' ,s.invorrtrn ,s.cashamt,s.modified ,s.salinvno ,s.salctrno ,s.tdatetime ,s.cktype ,s.geninv ,s.rref'
    + ' ,s.rcontr ,s.ccpaid ,s.ccconus,s.prepaidamt ,s.fmbranch,s.mobile ,s.fcamt ,s.custtype ,s.paycard,s.saned_amt,
	     s.rtncshamt,s.dfvchramt,s.frc_rtncash,s.vat_amt_rcvd,s.taxfree_sales,s.hlldscnt,s.discamt,s.No_round_nm,s.PriceVatType,s.CashDsc4RtnPrepaid,s.outside_order,s.stcpay_amt,s.Qitaf_amt,s.whlslinv , s.vat_percent);'	
	
	begin transaction
	exec sp_executesql @sqlmsg
	set @no_of_invoices=@@ROWCOUNT
	if @@error<>0 or @no_of_invoices=0
	begin
		rollback transaction
		set @errstatus=-3
		if @no_of_invoices=0 set @errstatus=0
		return 
	end

--  Make sure that the field NQATI_PRCNT is available in pos_dt
	
    declare @is_nqati_there varchar(30)=''
    set @is_nqati_there=iif(EXISTS(SELECT name FROM sys.columns
    WHERE Name = N'nqati_prcnt' AND OBJECT_ID = OBJECT_ID(N'pos_dt')),',s.nqati_prcnt);',');')
	
	set @sqlmsg='merge pos_dt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'pos_dt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' And exists(Select contr,ref From pos_hd s1 Where a.company=s1.company and a.contr = s1.contr and a.ref = s1.ref)) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, cmbkey, qty, price, barcode, dscprsnt, srlno, rtrnd, dsc_amt, offer_amt
	    , nqati_prcnt,scl_barcode,taxtype) 
	    values (s.company ,s.contr ,s.ref,s.cmbkey ,s.qty,s.price ,s.barcode ,s.dscprsnt ,s.srlno,s.rtrnd,
	            s.dsc_amt,s.offer_amt,s.nqati_prcnt,s.scl_barcode,s.taxtype);'
	
	

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-4
		return 
	end
		
	set @sqlmsg='merge POSRTNINV as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSRTNINV a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.rcontr,s.rref,s.Contr,s.ref,s.rtnamt);'

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end

	set @sqlmsg='merge POSPPCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSPPCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.disccard=s.disccard'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.disccard,s.paytype,s.prepaidamt,s.paycard,s.nodsc4promo,s.prepaidamt_rtn);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

	set @sqlmsg='merge POSCCCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSCCCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' and b.ccpaid>0) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.cccardno=s.cccardno and t.ccsrlno=s.ccsrlno'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.cccardno,s.ccsrlno,s.cardtype,s.ccpaid,
	    s.ccconus,s.chargepctg,s.chargeamt,s.cctype,s.approvl_no,s.TransDate,s.TransTime,s.TransNo,s.terminal_id);'
		
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

	set @sqlmsg='merge poschrtinv as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'poschrtinv a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.hllamt,s.chrcode);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end

	set @sqlmsg='merge posfcamt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'posfcamt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' and b.invcst>0) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.fcy,s.fcamt,s.fcyrate,s.lcamt,s.srlno);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-6
		return 
	end
	else commit transaction
	
	declare @new_cndn nvarchar(250),
	        @lpos int =0
	set @lpos=charindex('INVDATE',@whr_condn)
	set @new_cndn=substring(@whr_condn,@lpos,200)
	set @new_cndn=replace(replace(@new_cndn,'INVDATE','mnydate'),'smalldatetime','date')
	set @sqlmsg='merge pos_mny as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_mny  where '+@new_cndn+') as s'	
	+ ' on t.company=s.company and t.contr=s.contr and t.mnydate=s.mnydate and t.slpcode=s.slpcode'
    + ' when not matched then '
	+ ' insert (company,contr,mnydate,slpcode,oner,fiver,tenr,twntyr,fiftyr,hundredr,
                twohandr,fivehandr,modified,rtnval,network,prepaidamt,scrtnval,scnetwork,scprepaidamt,
				sccash,saned_amt,scsaned_amt)                
	    values (s.company,s.contr,s.mnydate,s.slpcode,s.oner,s.fiver,s.tenr,s.twntyr,s.fiftyr,s.hundredr,
                s.twohandr,s.fivehandr,s.modified,s.rtnval,s.network,s.prepaidamt'
	+ iif(@it_is_pos=0,',s.scrtnval ,s.scnetwork,s.scprepaidamt,s.sccash,s.saned_amt,s.scsaned_amt',',0,0,0,0,s.saned_amt,0')+');'
	
	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
	end
	else commit transaction
	--END TRY
	--BEGIN CATCH
	--		SET @STR_MSG ='ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +' rtncode='+@rtncode
			
	--		return @errstatus
	--END CATCH
end 






GO
/****** Object:  StoredProcedure [dbo].[Update_Pos_Auto14]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--صبيا

CREATE PROCEDURE [dbo].[Update_Pos_Auto14]
 @whr_condn nvarchar(200) = 'invdate > convert(date,dateadd(day,-7,GETDATE()),112)' ,
 @brlinksrvr nvarchar(15) = 'BRLNKSRVR0114',
 @wth_slp_cntr bit = 0 ,
 @no_of_invoices int=0 output,
 @errstatus int = 0 output
	
AS
BEGIN
	declare @sqlmsg nvarchar(max)='',
	@dbc nvarchar(14) = '.dbc01y30.dbo.',
	@lcalcomp char(2) = '01',
	@yrcode char(4) = '2020',
	@syscode int =2,
	@lcauseslctr bit=0,
	@it_is_pos bit=0
---------------------------------------------------------------------------------------------
	--set @dbc=db_name()
	--set @lcalcomp=substring(@dbc,4,2)
	--set @yrcode=substring(@dbc,7,2)
	--SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
	
	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @syscode=sysno,@lcauseslctr=causeslctr  from sysdb.dbo.glcalend 
	where calcomp=@lcalcomp and yrcode=@yrcode
------------------------------------------------------------------------------------------------------------------------------

    set @errstatus=0
 --   if @syscode<>3  --set @dbc='.'+db_name()+'.dbo.'
	--else 
	--begin
------------------------------ Get Yrcode & Calcomp from Branch Boteequ  ----------------------------------------------
--		declare @dynsql nvarchar(300),
--				@params nvarchar(100)

--		set @yrcode=''
--		set @lcalcomp=''
--		set @dynsql='select top 1 @yrcd=yrcode,@lclcmp=calcomp  from '+@brlinksrvr+'.posysdb.dbo.glcalend'
--		+ ' order by yrcode desc';
--		set @params='@yrcd char(4) output,@lclcmp char(2) output';
--		exec sp_executesql @dynsql,@params,@yrcd=@yrcode output,@lclcmp=@lcalcomp output
--		if @@error<>0 or @@rowcount=0
--		begin
--		  	set @errstatus=-1
--			return 
--		end
--		if @yrcode<>'' and @lcalcomp<>'' set @dbc='.pos'+@lcalcomp+'y'+substring(@yrcode,3,2)+'.dbo.'
--		else
--		begin
--		  	set @errstatus=-2
--			return 		  
--		end
--		set @it_is_pos=1
--------------------------------------------------------------------------------------------------------------------------
--	end
    

  if @wth_slp_cntr=1
	begin
	    set @sqlmsg='merge pos_ctr as t '
		+ ' using '+@brlinksrvr+@dbc+'pos_ctr as s'
		+ ' on t.ctrcompany=s.ctrcompany and t.ctrcode=s.ctrcode'
		+ ' when matched then '
		+ ' update set t.ctrloc = s.ctrloc ,t.ctrstatus = s.ctrstatus ,t.ctrnote = s.ctrnote ,t.ctrcash = s.ctrcash'
        + ',t.ctrrpls = s.ctrrpls,t.ctrcard = s.ctrcard ,t.ctrsanet = s.ctrsanet,t.ctrsanetpctg = s.ctrsanetpctg'
        + ',t.ctrvisa = s.ctrvisa ,t.ctrvisapctg = s.ctrvisapctg ,t.ctrmaster = s.ctrmaster'
        + ',t.ctrmasterpctg = s.ctrmasterpctg,t.ctrothers = s.ctrothers ,t.ctrotherspctg = s.ctrotherspctg'
        + ',t.slcenter = s.slcenter ,t.invser = s.invser,t.drwrcomport = s.drwrcomport,t.spath = s.spath'
        + ',t.ctrserial = s.ctrserial,t.modified = s.modified,t.started = s.started ,t.ended = s.ended'
        + ',t.drawer = s.drawer,t.cdisplay = s.cdisplay ,t.slmsg = s.slmsg,t.rtnmsg = s.rtnmsg'
        + ',t.footmsg1 = s.footmsg1,t.footmsg2 = s.footmsg2,t.footmsg3 = s.footmsg3,t.saveinserver = s.saveinserver'
        + ',t.saveinvall = s.saveinvall,t.scr_open = s.scr_open,t.slnoprint = s.slnoprint,t.rtnoprint = s.rtnoprint'
        + ',t.ccconus = s.ccconus,t.upditem_hrs = s.upditem_hrs,t.updinv_hrs = s.updinv_hrs,t.prntbyclass = s.prntbyclass'
        + ',t.sltype = s.sltype,t.rttype = s.rttype,t.rptype = s.rptype,t.icrptype = s.icrptype'
        + ',t.ctrprpaid = s.ctrprpaid,t.rtfmothrs = s.rtfmothrs,t.magcard = s.magcard,t.usbdsply = s.usbdsply'
        + ',t.dsplycomport = s.dsplycomport,t.rpt_grp_items = s.rpt_grp_items,
		   t.ctrsaned=s.ctrsaned,t.ctrsndecrpos=s.ctrsndecrpos,t.ctreftpos=s.ctreftpos ,t.eftport=s.eftport'
		+ ' when not matched then '
		+ ' insert (ctrcompany,ctrcode,ctrloc,ctrstatus ,ctrnote ,ctrcash ,ctrrpls ,ctrcard,ctrsanet'
        + ',ctrsanetpctg,ctrvisa,ctrvisapctg ,ctrmaster,ctrmasterpctg,ctrothers,ctrotherspctg'
        + ',slcenter,invser ,drwrcomport,spath ,ctrserial,modified,started,ended,drawer'
        + ',cdisplay,slmsg,rtnmsg,footmsg1,footmsg2,footmsg3,saveinserver,saveinvall,scr_open'
        + ',slnoprint,rtnoprint,ccconus ,upditem_hrs,updinv_hrs,prntbyclass ,sltype ,rttype'
        + ',rptype ,icrptype,ctrprpaid ,rtfmothrs,magcard ,usbdsply,dsplycomport,rpt_grp_items,
		    ctrsaned,ctrsndecrpos,eftport,ctreftpos,ntk_printer1,ntk_printer2,grp_printers,grp_prnt_local,cshRtn_f_o_b)'
		+ ' values (s.ctrcompany,s.ctrcode,s.ctrloc,s.ctrstatus ,s.ctrnote ,s.ctrcash ,s.ctrrpls ,s.ctrcard,s.ctrsanet'
        + ',s.ctrsanetpctg,s.ctrvisa,s.ctrvisapctg ,s.ctrmaster,s.ctrmasterpctg,s.ctrothers,s.ctrotherspctg'
        + ',s.slcenter,s.invser ,s.drwrcomport,s.spath ,s.ctrserial,s.modified,s.started,s.ended,s.drawer'
        + ',s.cdisplay,s.slmsg,s.rtnmsg,s.footmsg1,s.footmsg2,s.footmsg3,s.saveinserver,s.saveinvall,s.scr_open'
        + ',s.slnoprint,s.rtnoprint,s.ccconus ,s.upditem_hrs,s.updinv_hrs,s.prntbyclass ,s.sltype ,s.rttype'
        + ',s.rptype ,s.icrptype,s.ctrprpaid ,s.rtfmothrs,s.magcard ,s.usbdsply,s.dsplycomport,s.rpt_grp_items,
		    s.ctrsaned,s.ctrsndecrpos,s.eftport,s.ctreftpos,s.ntk_printer1,s.ntk_printer2,s.grp_printers,s.grp_prnt_local,s.cshRtn_f_o_b);'
			
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-10
			return 
		end
		else commit transaction
-- t.slppassword=s.slppassword,  is rempved 08-06-2014
	    set @sqlmsg='merge pos_slp as t '
		+ ' using '+@brlinksrvr+@dbc+'pos_slp as s'
		+ ' on t.slpcompany=s.slpcompany and t.slpcode=s.slpcode'
		+ ' when matched then '
		+ ' update set t.slpname=s.slpname,t.slpaddress=s.slpaddress,t.slptel=s.slptel,'
		+ ' t.slpchgqty=s.slpchgqty,t.slpchgprice=s.slpchgprice'
        + ',t.slpdelline=s.slpdelline,t.slpothersinv=s.slpothersinv,t.slpreturn=s.slpreturn,t.slpstatus=s.slpstatus,'
		+ ' t.slpalowdisc=s.slpalowdisc,t.slpmaxdisc=s.slpmaxdisc,t.slppricetp=s.slppricetp'
        + ',t.slpalowcancel=s.slpalowcancel,t.slpalowopdr=s.slpalowopdr,t.modified=s.modified,t.slpalowexit=s.slpalowexit,'
		+ ' t.slprtwoinv=s.slprtwoinv,t.slpblowbal=s.slpblowbal,t.scr_open=s.scr_open'
        + ',t.alwitmdsc=s.alwitmdsc,t.maxitmdsc=s.maxitmdsc ,t.alwuserpls=s.alwuserpls ,t.alwuseicrpls=s.alwuseicrpls,'
		+ 't.slpmagnetic=s.slpmagnetic,t.alwusebrrtn=s.alwusebrrtn,t.alwreprint=s.alwreprint'
        + ',t.frcrplinv=s.frcrplinv,t.catch_thief=s.catch_thief,t.sold_once=s.sold_once,t.only_scan_bc=s.only_scan_bc,'
		+ 't.stop_item_column=s.stop_item_column,t.slpfpalw=s.slpfpalw,t.slpfpimage=s.slpfpimage'
        + ',t.slcenter=s.slcenter,t.salesquota=s.salesquota,t.commissionP=s.commissionP,t.bonus=s.bonus,
		    t.supervisor=s.supervisor,t.ReadInvByBarcd=s.ReadInvByBarcd,
			t.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,t.alwcshcardpay=s.alwcshcardpay,'
		+ 't.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,t.slp_hlldscamtMax=s.slp_hlldscamtMax,t.alwprnttmpinv=s.alwprnttmpinv,s.ignore_mnmprice=s.ignore_mnmprice'
		
		+ ' when not matched then '
		+ ' insert values (s.slpcompany,s.slpcode,s.slpname,s.slpaddress,s.slptel,s.slppassword,s.slpchgqty,s.slpchgprice'
        + ',s.slpdelline,s.slpothersinv,s.slpreturn,s.slpstatus,s.slpalowdisc,s.slpmaxdisc,s.slppricetp'
        + ',s.slpalowcancel,s.slpalowopdr,s.modified,s.slpalowexit,s.slprtwoinv,s.slpblowbal,s.scr_open'
        + ',s.alwitmdsc,s.maxitmdsc ,s.alwuserpls ,s.alwuseicrpls,s.slpmagnetic,s.alwusebrrtn,s.alwreprint'
        + ',s.frcrplinv,s.catch_thief,s.sold_once,s.only_scan_bc,s.stop_item_column,s.slpfpalw,s.slpfpimage'
        + ',s.slcenter,s.salesquota,s.commissionP,s.bonus,s.supervisor,s.ReadInvByBarcd,s.alwrtncash,
		   s.alwmtchrtn,s.alwinvtrnsfr,s.alwcshcardpay,s.alwrtncash,s.alwmtchrtn,s.alwinvtrnsfr,s.slp_hlldscamtMax,s.alwprnttmpinv,s.ignore_mnmprice);'
		   
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-11
			return 
		end
		else commit transaction
	end
------------------------------------------------------------------------------------------------------------------------
	set @sqlmsg='merge pos_hd as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_hd b where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, invdate, entries, slperson, paytype, chargepctg, chargeamt, invdspc, disccard, 
		cardtype, invttl, invcst, invdsvl, valafds, invpaid, pricetp, slcenter, invorrtrn, cashamt, modified, 
		salinvno, salctrno, tdatetime, cktype, geninv, rref, rcontr, ccpaid, ccconus, prepaidamt, fmbranch,
		mobile, fcamt, custtype, paycard, saned_amt,rtncshamt,dfvchramt,frc_rtncash,vat_amt_rcvd,taxfree_sales,hlldscnt,discamt,No_round_nm,PriceVatType,CashDsc4RtnPrepaid,outside_order,stcpay_amt,Qitaf_amt,whlslinv , vat_percent)'
	+ ' values (s.company,s.contr,s.ref,s.invdate,s.entries,s.slperson ,s.paytype,s.chargepctg,s.chargeamt'
    + ' ,s.invdspc ,s.disccard ,s.cardtype ,s.invttl,s.invcst,s.invdsvl,s.valafds ,s.invpaid,s.pricetp,s.slcenter'
    + ' ,s.invorrtrn ,s.cashamt,s.modified ,s.salinvno ,s.salctrno ,s.tdatetime ,s.cktype ,s.geninv ,s.rref'
    + ' ,s.rcontr ,s.ccpaid ,s.ccconus,s.prepaidamt ,s.fmbranch,s.mobile ,s.fcamt ,s.custtype ,s.paycard,s.saned_amt,
	     s.rtncshamt,s.dfvchramt,s.frc_rtncash,s.vat_amt_rcvd,s.taxfree_sales,s.hlldscnt,s.discamt,s.No_round_nm,s.PriceVatType,s.CashDsc4RtnPrepaid,s.outside_order,s.stcpay_amt,s.Qitaf_amt,s.whlslinv , s.vat_percent);'	
	
	begin transaction
	exec sp_executesql @sqlmsg
	set @no_of_invoices=@@ROWCOUNT
	if @@error<>0 or @no_of_invoices=0
	begin
		rollback transaction
		set @errstatus=-3
		if @no_of_invoices=0 set @errstatus=0
		return 
	end

--  Make sure that the field NQATI_PRCNT is available in pos_dt
	
    declare @is_nqati_there varchar(30)=''
    set @is_nqati_there=iif(EXISTS(SELECT name FROM sys.columns
    WHERE Name = N'nqati_prcnt' AND OBJECT_ID = OBJECT_ID(N'pos_dt')),',s.nqati_prcnt);',');')
	
	set @sqlmsg='merge pos_dt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'pos_dt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' And exists(Select contr,ref From pos_hd s1 Where a.company=s1.company and a.contr = s1.contr and a.ref = s1.ref)) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, cmbkey, qty, price, barcode, dscprsnt, srlno, rtrnd, dsc_amt, offer_amt
	    , nqati_prcnt,scl_barcode,taxtype) 
	    values (s.company ,s.contr ,s.ref,s.cmbkey ,s.qty,s.price ,s.barcode ,s.dscprsnt ,s.srlno,s.rtrnd,
	            s.dsc_amt,s.offer_amt,s.nqati_prcnt,s.scl_barcode,s.taxtype);'
	
	

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-4
		return 
	end
		
	set @sqlmsg='merge POSRTNINV as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSRTNINV a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.rcontr,s.rref,s.Contr,s.ref,s.rtnamt);'

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end

	set @sqlmsg='merge POSPPCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSPPCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.disccard=s.disccard'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.disccard,s.paytype,s.prepaidamt,s.paycard,s.nodsc4promo,s.prepaidamt_rtn);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

	set @sqlmsg='merge POSCCCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSCCCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' and b.ccpaid>0) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.cccardno=s.cccardno and t.ccsrlno=s.ccsrlno'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.cccardno,s.ccsrlno,s.cardtype,s.ccpaid,
	    s.ccconus,s.chargepctg,s.chargeamt,s.cctype,s.approvl_no,s.TransDate,s.TransTime,s.TransNo,s.terminal_id);'
		
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

	set @sqlmsg='merge poschrtinv as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'poschrtinv a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.hllamt,s.chrcode);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end

	set @sqlmsg='merge posfcamt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'posfcamt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' and b.invcst>0) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.fcy,s.fcamt,s.fcyrate,s.lcamt,s.srlno);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-6
		return 
	end
	else commit transaction
	
	declare @new_cndn nvarchar(250),
	        @lpos int =0
	set @lpos=charindex('INVDATE',@whr_condn)
	set @new_cndn=substring(@whr_condn,@lpos,200)
	set @new_cndn=replace(replace(@new_cndn,'INVDATE','mnydate'),'smalldatetime','date')
	set @sqlmsg='merge pos_mny as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_mny  where '+@new_cndn+') as s'	
	+ ' on t.company=s.company and t.contr=s.contr and t.mnydate=s.mnydate and t.slpcode=s.slpcode'
    + ' when not matched then '
	+ ' insert (company,contr,mnydate,slpcode,oner,fiver,tenr,twntyr,fiftyr,hundredr,
                twohandr,fivehandr,modified,rtnval,network,prepaidamt,scrtnval,scnetwork,scprepaidamt,
				sccash,saned_amt,scsaned_amt)                
	    values (s.company,s.contr,s.mnydate,s.slpcode,s.oner,s.fiver,s.tenr,s.twntyr,s.fiftyr,s.hundredr,
                s.twohandr,s.fivehandr,s.modified,s.rtnval,s.network,s.prepaidamt'
	+ iif(@it_is_pos=0,',s.scrtnval ,s.scnetwork,s.scprepaidamt,s.sccash,s.saned_amt,s.scsaned_amt',',0,0,0,0,s.saned_amt,0')+');'
	
	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
	end
	else commit transaction
	--END TRY
	--BEGIN CATCH
	--		SET @STR_MSG ='ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +' rtncode='+@rtncode
			
	--		return @errstatus
	--END CATCH
end 






GO
/****** Object:  StoredProcedure [dbo].[Update_Pos_Auto15]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--الرياض 1

CREATE PROCEDURE [dbo].[Update_Pos_Auto15]
 @whr_condn nvarchar(200) = 'invdate > convert(date,dateadd(day,-7,GETDATE()),112)' ,
 @brlinksrvr nvarchar(15) = 'BRLNKSRVR0115',
 @wth_slp_cntr bit = 0 ,
 @no_of_invoices int=0 output,
 @errstatus int = 0 output
	
AS
BEGIN
	declare @sqlmsg nvarchar(max)='',
	@dbc nvarchar(14) = '.dbc01y30.dbo.',
	@lcalcomp char(2) = '01',
	@yrcode char(4) = '2020',
	@syscode int =2,
	@lcauseslctr bit=0,
	@it_is_pos bit=0
---------------------------------------------------------------------------------------------
	--set @dbc=db_name()
	--set @lcalcomp=substring(@dbc,4,2)
	--set @yrcode=substring(@dbc,7,2)
	--SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
	
	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @syscode=sysno,@lcauseslctr=causeslctr  from sysdb.dbo.glcalend 
	where calcomp=@lcalcomp and yrcode=@yrcode
------------------------------------------------------------------------------------------------------------------------------

    set @errstatus=0
 --   if @syscode<>3  --set @dbc='.'+db_name()+'.dbo.'
	--else 
	--begin
------------------------------ Get Yrcode & Calcomp from Branch Boteequ  ----------------------------------------------
--		declare @dynsql nvarchar(300),
--				@params nvarchar(100)

--		set @yrcode=''
--		set @lcalcomp=''
--		set @dynsql='select top 1 @yrcd=yrcode,@lclcmp=calcomp  from '+@brlinksrvr+'.posysdb.dbo.glcalend'
--		+ ' order by yrcode desc';
--		set @params='@yrcd char(4) output,@lclcmp char(2) output';
--		exec sp_executesql @dynsql,@params,@yrcd=@yrcode output,@lclcmp=@lcalcomp output
--		if @@error<>0 or @@rowcount=0
--		begin
--		  	set @errstatus=-1
--			return 
--		end
--		if @yrcode<>'' and @lcalcomp<>'' set @dbc='.pos'+@lcalcomp+'y'+substring(@yrcode,3,2)+'.dbo.'
--		else
--		begin
--		  	set @errstatus=-2
--			return 		  
--		end
--		set @it_is_pos=1
--------------------------------------------------------------------------------------------------------------------------
--	end
    

  if @wth_slp_cntr=1
	begin
	    set @sqlmsg='merge pos_ctr as t '
		+ ' using '+@brlinksrvr+@dbc+'pos_ctr as s'
		+ ' on t.ctrcompany=s.ctrcompany and t.ctrcode=s.ctrcode'
		+ ' when matched then '
		+ ' update set t.ctrloc = s.ctrloc ,t.ctrstatus = s.ctrstatus ,t.ctrnote = s.ctrnote ,t.ctrcash = s.ctrcash'
        + ',t.ctrrpls = s.ctrrpls,t.ctrcard = s.ctrcard ,t.ctrsanet = s.ctrsanet,t.ctrsanetpctg = s.ctrsanetpctg'
        + ',t.ctrvisa = s.ctrvisa ,t.ctrvisapctg = s.ctrvisapctg ,t.ctrmaster = s.ctrmaster'
        + ',t.ctrmasterpctg = s.ctrmasterpctg,t.ctrothers = s.ctrothers ,t.ctrotherspctg = s.ctrotherspctg'
        + ',t.slcenter = s.slcenter ,t.invser = s.invser,t.drwrcomport = s.drwrcomport,t.spath = s.spath'
        + ',t.ctrserial = s.ctrserial,t.modified = s.modified,t.started = s.started ,t.ended = s.ended'
        + ',t.drawer = s.drawer,t.cdisplay = s.cdisplay ,t.slmsg = s.slmsg,t.rtnmsg = s.rtnmsg'
        + ',t.footmsg1 = s.footmsg1,t.footmsg2 = s.footmsg2,t.footmsg3 = s.footmsg3,t.saveinserver = s.saveinserver'
        + ',t.saveinvall = s.saveinvall,t.scr_open = s.scr_open,t.slnoprint = s.slnoprint,t.rtnoprint = s.rtnoprint'
        + ',t.ccconus = s.ccconus,t.upditem_hrs = s.upditem_hrs,t.updinv_hrs = s.updinv_hrs,t.prntbyclass = s.prntbyclass'
        + ',t.sltype = s.sltype,t.rttype = s.rttype,t.rptype = s.rptype,t.icrptype = s.icrptype'
        + ',t.ctrprpaid = s.ctrprpaid,t.rtfmothrs = s.rtfmothrs,t.magcard = s.magcard,t.usbdsply = s.usbdsply'
        + ',t.dsplycomport = s.dsplycomport,t.rpt_grp_items = s.rpt_grp_items,
		   t.ctrsaned=s.ctrsaned,t.ctrsndecrpos=s.ctrsndecrpos,t.ctreftpos=s.ctreftpos ,t.eftport=s.eftport'
		+ ' when not matched then '
		+ ' insert (ctrcompany,ctrcode,ctrloc,ctrstatus ,ctrnote ,ctrcash ,ctrrpls ,ctrcard,ctrsanet'
        + ',ctrsanetpctg,ctrvisa,ctrvisapctg ,ctrmaster,ctrmasterpctg,ctrothers,ctrotherspctg'
        + ',slcenter,invser ,drwrcomport,spath ,ctrserial,modified,started,ended,drawer'
        + ',cdisplay,slmsg,rtnmsg,footmsg1,footmsg2,footmsg3,saveinserver,saveinvall,scr_open'
        + ',slnoprint,rtnoprint,ccconus ,upditem_hrs,updinv_hrs,prntbyclass ,sltype ,rttype'
        + ',rptype ,icrptype,ctrprpaid ,rtfmothrs,magcard ,usbdsply,dsplycomport,rpt_grp_items,
		    ctrsaned,ctrsndecrpos,eftport,ctreftpos,ntk_printer1,ntk_printer2,grp_printers,grp_prnt_local,cshRtn_f_o_b)'
		+ ' values (s.ctrcompany,s.ctrcode,s.ctrloc,s.ctrstatus ,s.ctrnote ,s.ctrcash ,s.ctrrpls ,s.ctrcard,s.ctrsanet'
        + ',s.ctrsanetpctg,s.ctrvisa,s.ctrvisapctg ,s.ctrmaster,s.ctrmasterpctg,s.ctrothers,s.ctrotherspctg'
        + ',s.slcenter,s.invser ,s.drwrcomport,s.spath ,s.ctrserial,s.modified,s.started,s.ended,s.drawer'
        + ',s.cdisplay,s.slmsg,s.rtnmsg,s.footmsg1,s.footmsg2,s.footmsg3,s.saveinserver,s.saveinvall,s.scr_open'
        + ',s.slnoprint,s.rtnoprint,s.ccconus ,s.upditem_hrs,s.updinv_hrs,s.prntbyclass ,s.sltype ,s.rttype'
        + ',s.rptype ,s.icrptype,s.ctrprpaid ,s.rtfmothrs,s.magcard ,s.usbdsply,s.dsplycomport,s.rpt_grp_items,
		    s.ctrsaned,s.ctrsndecrpos,s.eftport,s.ctreftpos,s.ntk_printer1,s.ntk_printer2,s.grp_printers,s.grp_prnt_local,s.cshRtn_f_o_b);'
			
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-10
			return 
		end
		else commit transaction
-- t.slppassword=s.slppassword,  is rempved 08-06-2014
	    set @sqlmsg='merge pos_slp as t '
		+ ' using '+@brlinksrvr+@dbc+'pos_slp as s'
		+ ' on t.slpcompany=s.slpcompany and t.slpcode=s.slpcode'
		+ ' when matched then '
		+ ' update set t.slpname=s.slpname,t.slpaddress=s.slpaddress,t.slptel=s.slptel,'
		+ ' t.slpchgqty=s.slpchgqty,t.slpchgprice=s.slpchgprice'
        + ',t.slpdelline=s.slpdelline,t.slpothersinv=s.slpothersinv,t.slpreturn=s.slpreturn,t.slpstatus=s.slpstatus,'
		+ ' t.slpalowdisc=s.slpalowdisc,t.slpmaxdisc=s.slpmaxdisc,t.slppricetp=s.slppricetp'
        + ',t.slpalowcancel=s.slpalowcancel,t.slpalowopdr=s.slpalowopdr,t.modified=s.modified,t.slpalowexit=s.slpalowexit,'
		+ ' t.slprtwoinv=s.slprtwoinv,t.slpblowbal=s.slpblowbal,t.scr_open=s.scr_open'
        + ',t.alwitmdsc=s.alwitmdsc,t.maxitmdsc=s.maxitmdsc ,t.alwuserpls=s.alwuserpls ,t.alwuseicrpls=s.alwuseicrpls,'
		+ 't.slpmagnetic=s.slpmagnetic,t.alwusebrrtn=s.alwusebrrtn,t.alwreprint=s.alwreprint'
        + ',t.frcrplinv=s.frcrplinv,t.catch_thief=s.catch_thief,t.sold_once=s.sold_once,t.only_scan_bc=s.only_scan_bc,'
		+ 't.stop_item_column=s.stop_item_column,t.slpfpalw=s.slpfpalw,t.slpfpimage=s.slpfpimage'
        + ',t.slcenter=s.slcenter,t.salesquota=s.salesquota,t.commissionP=s.commissionP,t.bonus=s.bonus,
		    t.supervisor=s.supervisor,t.ReadInvByBarcd=s.ReadInvByBarcd,
			t.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,t.alwcshcardpay=s.alwcshcardpay,'
		+ 't.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,t.slp_hlldscamtMax=s.slp_hlldscamtMax,t.alwprnttmpinv=s.alwprnttmpinv,s.ignore_mnmprice=s.ignore_mnmprice'
		
		+ ' when not matched then '
		+ ' insert values (s.slpcompany,s.slpcode,s.slpname,s.slpaddress,s.slptel,s.slppassword,s.slpchgqty,s.slpchgprice'
        + ',s.slpdelline,s.slpothersinv,s.slpreturn,s.slpstatus,s.slpalowdisc,s.slpmaxdisc,s.slppricetp'
        + ',s.slpalowcancel,s.slpalowopdr,s.modified,s.slpalowexit,s.slprtwoinv,s.slpblowbal,s.scr_open'
        + ',s.alwitmdsc,s.maxitmdsc ,s.alwuserpls ,s.alwuseicrpls,s.slpmagnetic,s.alwusebrrtn,s.alwreprint'
        + ',s.frcrplinv,s.catch_thief,s.sold_once,s.only_scan_bc,s.stop_item_column,s.slpfpalw,s.slpfpimage'
        + ',s.slcenter,s.salesquota,s.commissionP,s.bonus,s.supervisor,s.ReadInvByBarcd,s.alwrtncash,
		   s.alwmtchrtn,s.alwinvtrnsfr,s.alwcshcardpay,s.alwrtncash,s.alwmtchrtn,s.alwinvtrnsfr,s.slp_hlldscamtMax,s.alwprnttmpinv,s.ignore_mnmprice);'
		   
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-11
			return 
		end
		else commit transaction
	end
------------------------------------------------------------------------------------------------------------------------
	set @sqlmsg='merge pos_hd as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_hd b where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, invdate, entries, slperson, paytype, chargepctg, chargeamt, invdspc, disccard, 
		cardtype, invttl, invcst, invdsvl, valafds, invpaid, pricetp, slcenter, invorrtrn, cashamt, modified, 
		salinvno, salctrno, tdatetime, cktype, geninv, rref, rcontr, ccpaid, ccconus, prepaidamt, fmbranch,
		mobile, fcamt, custtype, paycard, saned_amt,rtncshamt,dfvchramt,frc_rtncash,vat_amt_rcvd,taxfree_sales,hlldscnt,discamt,No_round_nm,PriceVatType,CashDsc4RtnPrepaid,outside_order,stcpay_amt,Qitaf_amt,whlslinv , vat_percent)'
	+ ' values (s.company,s.contr,s.ref,s.invdate,s.entries,s.slperson ,s.paytype,s.chargepctg,s.chargeamt'
    + ' ,s.invdspc ,s.disccard ,s.cardtype ,s.invttl,s.invcst,s.invdsvl,s.valafds ,s.invpaid,s.pricetp,s.slcenter'
    + ' ,s.invorrtrn ,s.cashamt,s.modified ,s.salinvno ,s.salctrno ,s.tdatetime ,s.cktype ,s.geninv ,s.rref'
    + ' ,s.rcontr ,s.ccpaid ,s.ccconus,s.prepaidamt ,s.fmbranch,s.mobile ,s.fcamt ,s.custtype ,s.paycard,s.saned_amt,
	     s.rtncshamt,s.dfvchramt,s.frc_rtncash,s.vat_amt_rcvd,s.taxfree_sales,s.hlldscnt,s.discamt,s.No_round_nm,s.PriceVatType,s.CashDsc4RtnPrepaid,s.outside_order,s.stcpay_amt,s.Qitaf_amt,s.whlslinv , s.vat_percent);'	
	
	begin transaction
	exec sp_executesql @sqlmsg
	set @no_of_invoices=@@ROWCOUNT
	if @@error<>0 or @no_of_invoices=0
	begin
		rollback transaction
		set @errstatus=-3
		if @no_of_invoices=0 set @errstatus=0
		return 
	end

--  Make sure that the field NQATI_PRCNT is available in pos_dt
	
    declare @is_nqati_there varchar(30)=''
    set @is_nqati_there=iif(EXISTS(SELECT name FROM sys.columns
    WHERE Name = N'nqati_prcnt' AND OBJECT_ID = OBJECT_ID(N'pos_dt')),',s.nqati_prcnt);',');')
	
	set @sqlmsg='merge pos_dt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'pos_dt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' And exists(Select contr,ref From pos_hd s1 Where a.company=s1.company and a.contr = s1.contr and a.ref = s1.ref)) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, cmbkey, qty, price, barcode, dscprsnt, srlno, rtrnd, dsc_amt, offer_amt
	    , nqati_prcnt,scl_barcode,taxtype) 
	    values (s.company ,s.contr ,s.ref,s.cmbkey ,s.qty,s.price ,s.barcode ,s.dscprsnt ,s.srlno,s.rtrnd,
	            s.dsc_amt,s.offer_amt,s.nqati_prcnt,s.scl_barcode,s.taxtype);'
	
	

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-4
		return 
	end
		
	set @sqlmsg='merge POSRTNINV as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSRTNINV a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.rcontr,s.rref,s.Contr,s.ref,s.rtnamt);'

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end

	set @sqlmsg='merge POSPPCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSPPCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.disccard=s.disccard'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.disccard,s.paytype,s.prepaidamt,s.paycard,s.nodsc4promo,s.prepaidamt_rtn);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

	set @sqlmsg='merge POSCCCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSCCCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' and b.ccpaid>0) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.cccardno=s.cccardno and t.ccsrlno=s.ccsrlno'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.cccardno,s.ccsrlno,s.cardtype,s.ccpaid,
	    s.ccconus,s.chargepctg,s.chargeamt,s.cctype,s.approvl_no,s.TransDate,s.TransTime,s.TransNo,s.terminal_id);'
		
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

	set @sqlmsg='merge poschrtinv as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'poschrtinv a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.hllamt,s.chrcode);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end

	set @sqlmsg='merge posfcamt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'posfcamt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' and b.invcst>0) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.fcy,s.fcamt,s.fcyrate,s.lcamt,s.srlno);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-6
		return 
	end
	else commit transaction
	
	declare @new_cndn nvarchar(250),
	        @lpos int =0
	set @lpos=charindex('INVDATE',@whr_condn)
	set @new_cndn=substring(@whr_condn,@lpos,200)
	set @new_cndn=replace(replace(@new_cndn,'INVDATE','mnydate'),'smalldatetime','date')
	set @sqlmsg='merge pos_mny as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_mny  where '+@new_cndn+') as s'	
	+ ' on t.company=s.company and t.contr=s.contr and t.mnydate=s.mnydate and t.slpcode=s.slpcode'
    + ' when not matched then '
	+ ' insert (company,contr,mnydate,slpcode,oner,fiver,tenr,twntyr,fiftyr,hundredr,
                twohandr,fivehandr,modified,rtnval,network,prepaidamt,scrtnval,scnetwork,scprepaidamt,
				sccash,saned_amt,scsaned_amt)                
	    values (s.company,s.contr,s.mnydate,s.slpcode,s.oner,s.fiver,s.tenr,s.twntyr,s.fiftyr,s.hundredr,
                s.twohandr,s.fivehandr,s.modified,s.rtnval,s.network,s.prepaidamt'
	+ iif(@it_is_pos=0,',s.scrtnval ,s.scnetwork,s.scprepaidamt,s.sccash,s.saned_amt,s.scsaned_amt',',0,0,0,0,s.saned_amt,0')+');'
	
	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
	end
	else commit transaction
	--END TRY
	--BEGIN CATCH
	--		SET @STR_MSG ='ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +' rtncode='+@rtncode
			
	--		return @errstatus
	--END CATCH
end 






GO
/****** Object:  StoredProcedure [dbo].[Update_Pos_Auto17]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--الرياض 2

CREATE PROCEDURE [dbo].[Update_Pos_Auto17]
 @whr_condn nvarchar(200) = 'invdate > convert(date,dateadd(day,-7,GETDATE()),112)' ,
 @brlinksrvr nvarchar(15) = 'BRLNKSRVR0117',
 @wth_slp_cntr bit = 0 ,
 @no_of_invoices int=0 output,
 @errstatus int = 0 output
	
AS
BEGIN
	declare @sqlmsg nvarchar(max)='',
	@dbc nvarchar(14) = '.dbc01y30.dbo.',
	@lcalcomp char(2) = '01',
	@yrcode char(4) = '2020',
	@syscode int =2,
	@lcauseslctr bit=0,
	@it_is_pos bit=0
---------------------------------------------------------------------------------------------
	--set @dbc=db_name()
	--set @lcalcomp=substring(@dbc,4,2)
	--set @yrcode=substring(@dbc,7,2)
	--SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
	
	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @syscode=sysno,@lcauseslctr=causeslctr  from sysdb.dbo.glcalend 
	where calcomp=@lcalcomp and yrcode=@yrcode
------------------------------------------------------------------------------------------------------------------------------

    set @errstatus=0
 --   if @syscode<>3  --set @dbc='.'+db_name()+'.dbo.'
	--else 
	--begin
------------------------------ Get Yrcode & Calcomp from Branch Boteequ  ----------------------------------------------
--		declare @dynsql nvarchar(300),
--				@params nvarchar(100)

--		set @yrcode=''
--		set @lcalcomp=''
--		set @dynsql='select top 1 @yrcd=yrcode,@lclcmp=calcomp  from '+@brlinksrvr+'.posysdb.dbo.glcalend'
--		+ ' order by yrcode desc';
--		set @params='@yrcd char(4) output,@lclcmp char(2) output';
--		exec sp_executesql @dynsql,@params,@yrcd=@yrcode output,@lclcmp=@lcalcomp output
--		if @@error<>0 or @@rowcount=0
--		begin
--		  	set @errstatus=-1
--			return 
--		end
--		if @yrcode<>'' and @lcalcomp<>'' set @dbc='.pos'+@lcalcomp+'y'+substring(@yrcode,3,2)+'.dbo.'
--		else
--		begin
--		  	set @errstatus=-2
--			return 		  
--		end
--		set @it_is_pos=1
--------------------------------------------------------------------------------------------------------------------------
--	end
    

  if @wth_slp_cntr=1
	begin
	    set @sqlmsg='merge pos_ctr as t '
		+ ' using '+@brlinksrvr+@dbc+'pos_ctr as s'
		+ ' on t.ctrcompany=s.ctrcompany and t.ctrcode=s.ctrcode'
		+ ' when matched then '
		+ ' update set t.ctrloc = s.ctrloc ,t.ctrstatus = s.ctrstatus ,t.ctrnote = s.ctrnote ,t.ctrcash = s.ctrcash'
        + ',t.ctrrpls = s.ctrrpls,t.ctrcard = s.ctrcard ,t.ctrsanet = s.ctrsanet,t.ctrsanetpctg = s.ctrsanetpctg'
        + ',t.ctrvisa = s.ctrvisa ,t.ctrvisapctg = s.ctrvisapctg ,t.ctrmaster = s.ctrmaster'
        + ',t.ctrmasterpctg = s.ctrmasterpctg,t.ctrothers = s.ctrothers ,t.ctrotherspctg = s.ctrotherspctg'
        + ',t.slcenter = s.slcenter ,t.invser = s.invser,t.drwrcomport = s.drwrcomport,t.spath = s.spath'
        + ',t.ctrserial = s.ctrserial,t.modified = s.modified,t.started = s.started ,t.ended = s.ended'
        + ',t.drawer = s.drawer,t.cdisplay = s.cdisplay ,t.slmsg = s.slmsg,t.rtnmsg = s.rtnmsg'
        + ',t.footmsg1 = s.footmsg1,t.footmsg2 = s.footmsg2,t.footmsg3 = s.footmsg3,t.saveinserver = s.saveinserver'
        + ',t.saveinvall = s.saveinvall,t.scr_open = s.scr_open,t.slnoprint = s.slnoprint,t.rtnoprint = s.rtnoprint'
        + ',t.ccconus = s.ccconus,t.upditem_hrs = s.upditem_hrs,t.updinv_hrs = s.updinv_hrs,t.prntbyclass = s.prntbyclass'
        + ',t.sltype = s.sltype,t.rttype = s.rttype,t.rptype = s.rptype,t.icrptype = s.icrptype'
        + ',t.ctrprpaid = s.ctrprpaid,t.rtfmothrs = s.rtfmothrs,t.magcard = s.magcard,t.usbdsply = s.usbdsply'
        + ',t.dsplycomport = s.dsplycomport,t.rpt_grp_items = s.rpt_grp_items,
		   t.ctrsaned=s.ctrsaned,t.ctrsndecrpos=s.ctrsndecrpos,t.ctreftpos=s.ctreftpos ,t.eftport=s.eftport'
		+ ' when not matched then '
		+ ' insert (ctrcompany,ctrcode,ctrloc,ctrstatus ,ctrnote ,ctrcash ,ctrrpls ,ctrcard,ctrsanet'
        + ',ctrsanetpctg,ctrvisa,ctrvisapctg ,ctrmaster,ctrmasterpctg,ctrothers,ctrotherspctg'
        + ',slcenter,invser ,drwrcomport,spath ,ctrserial,modified,started,ended,drawer'
        + ',cdisplay,slmsg,rtnmsg,footmsg1,footmsg2,footmsg3,saveinserver,saveinvall,scr_open'
        + ',slnoprint,rtnoprint,ccconus ,upditem_hrs,updinv_hrs,prntbyclass ,sltype ,rttype'
        + ',rptype ,icrptype,ctrprpaid ,rtfmothrs,magcard ,usbdsply,dsplycomport,rpt_grp_items,
		    ctrsaned,ctrsndecrpos,eftport,ctreftpos,ntk_printer1,ntk_printer2,grp_printers,grp_prnt_local,cshRtn_f_o_b)'
		+ ' values (s.ctrcompany,s.ctrcode,s.ctrloc,s.ctrstatus ,s.ctrnote ,s.ctrcash ,s.ctrrpls ,s.ctrcard,s.ctrsanet'
        + ',s.ctrsanetpctg,s.ctrvisa,s.ctrvisapctg ,s.ctrmaster,s.ctrmasterpctg,s.ctrothers,s.ctrotherspctg'
        + ',s.slcenter,s.invser ,s.drwrcomport,s.spath ,s.ctrserial,s.modified,s.started,s.ended,s.drawer'
        + ',s.cdisplay,s.slmsg,s.rtnmsg,s.footmsg1,s.footmsg2,s.footmsg3,s.saveinserver,s.saveinvall,s.scr_open'
        + ',s.slnoprint,s.rtnoprint,s.ccconus ,s.upditem_hrs,s.updinv_hrs,s.prntbyclass ,s.sltype ,s.rttype'
        + ',s.rptype ,s.icrptype,s.ctrprpaid ,s.rtfmothrs,s.magcard ,s.usbdsply,s.dsplycomport,s.rpt_grp_items,
		    s.ctrsaned,s.ctrsndecrpos,s.eftport,s.ctreftpos,s.ntk_printer1,s.ntk_printer2,s.grp_printers,s.grp_prnt_local,s.cshRtn_f_o_b);'
			
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-10
			return 
		end
		else commit transaction
-- t.slppassword=s.slppassword,  is rempved 08-06-2014
	    set @sqlmsg='merge pos_slp as t '
		+ ' using '+@brlinksrvr+@dbc+'pos_slp as s'
		+ ' on t.slpcompany=s.slpcompany and t.slpcode=s.slpcode'
		+ ' when matched then '
		+ ' update set t.slpname=s.slpname,t.slpaddress=s.slpaddress,t.slptel=s.slptel,'
		+ ' t.slpchgqty=s.slpchgqty,t.slpchgprice=s.slpchgprice'
        + ',t.slpdelline=s.slpdelline,t.slpothersinv=s.slpothersinv,t.slpreturn=s.slpreturn,t.slpstatus=s.slpstatus,'
		+ ' t.slpalowdisc=s.slpalowdisc,t.slpmaxdisc=s.slpmaxdisc,t.slppricetp=s.slppricetp'
        + ',t.slpalowcancel=s.slpalowcancel,t.slpalowopdr=s.slpalowopdr,t.modified=s.modified,t.slpalowexit=s.slpalowexit,'
		+ ' t.slprtwoinv=s.slprtwoinv,t.slpblowbal=s.slpblowbal,t.scr_open=s.scr_open'
        + ',t.alwitmdsc=s.alwitmdsc,t.maxitmdsc=s.maxitmdsc ,t.alwuserpls=s.alwuserpls ,t.alwuseicrpls=s.alwuseicrpls,'
		+ 't.slpmagnetic=s.slpmagnetic,t.alwusebrrtn=s.alwusebrrtn,t.alwreprint=s.alwreprint'
        + ',t.frcrplinv=s.frcrplinv,t.catch_thief=s.catch_thief,t.sold_once=s.sold_once,t.only_scan_bc=s.only_scan_bc,'
		+ 't.stop_item_column=s.stop_item_column,t.slpfpalw=s.slpfpalw,t.slpfpimage=s.slpfpimage'
        + ',t.slcenter=s.slcenter,t.salesquota=s.salesquota,t.commissionP=s.commissionP,t.bonus=s.bonus,
		    t.supervisor=s.supervisor,t.ReadInvByBarcd=s.ReadInvByBarcd,
			t.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,t.alwcshcardpay=s.alwcshcardpay,'
		+ 't.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,t.slp_hlldscamtMax=s.slp_hlldscamtMax,t.alwprnttmpinv=s.alwprnttmpinv,s.ignore_mnmprice=s.ignore_mnmprice'
		
		+ ' when not matched then '
		+ ' insert values (s.slpcompany,s.slpcode,s.slpname,s.slpaddress,s.slptel,s.slppassword,s.slpchgqty,s.slpchgprice'
        + ',s.slpdelline,s.slpothersinv,s.slpreturn,s.slpstatus,s.slpalowdisc,s.slpmaxdisc,s.slppricetp'
        + ',s.slpalowcancel,s.slpalowopdr,s.modified,s.slpalowexit,s.slprtwoinv,s.slpblowbal,s.scr_open'
        + ',s.alwitmdsc,s.maxitmdsc ,s.alwuserpls ,s.alwuseicrpls,s.slpmagnetic,s.alwusebrrtn,s.alwreprint'
        + ',s.frcrplinv,s.catch_thief,s.sold_once,s.only_scan_bc,s.stop_item_column,s.slpfpalw,s.slpfpimage'
        + ',s.slcenter,s.salesquota,s.commissionP,s.bonus,s.supervisor,s.ReadInvByBarcd,s.alwrtncash,
		   s.alwmtchrtn,s.alwinvtrnsfr,s.alwcshcardpay,s.alwrtncash,s.alwmtchrtn,s.alwinvtrnsfr,s.slp_hlldscamtMax,s.alwprnttmpinv,s.ignore_mnmprice);'
		   
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-11
			return 
		end
		else commit transaction
	end
------------------------------------------------------------------------------------------------------------------------
	set @sqlmsg='merge pos_hd as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_hd b where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, invdate, entries, slperson, paytype, chargepctg, chargeamt, invdspc, disccard, 
		cardtype, invttl, invcst, invdsvl, valafds, invpaid, pricetp, slcenter, invorrtrn, cashamt, modified, 
		salinvno, salctrno, tdatetime, cktype, geninv, rref, rcontr, ccpaid, ccconus, prepaidamt, fmbranch,
		mobile, fcamt, custtype, paycard, saned_amt,rtncshamt,dfvchramt,frc_rtncash,vat_amt_rcvd,taxfree_sales,hlldscnt,discamt,No_round_nm,PriceVatType,CashDsc4RtnPrepaid,outside_order,stcpay_amt,Qitaf_amt,whlslinv , vat_percent)'
	+ ' values (s.company,s.contr,s.ref,s.invdate,s.entries,s.slperson ,s.paytype,s.chargepctg,s.chargeamt'
    + ' ,s.invdspc ,s.disccard ,s.cardtype ,s.invttl,s.invcst,s.invdsvl,s.valafds ,s.invpaid,s.pricetp,s.slcenter'
    + ' ,s.invorrtrn ,s.cashamt,s.modified ,s.salinvno ,s.salctrno ,s.tdatetime ,s.cktype ,s.geninv ,s.rref'
    + ' ,s.rcontr ,s.ccpaid ,s.ccconus,s.prepaidamt ,s.fmbranch,s.mobile ,s.fcamt ,s.custtype ,s.paycard,s.saned_amt,
	     s.rtncshamt,s.dfvchramt,s.frc_rtncash,s.vat_amt_rcvd,s.taxfree_sales,s.hlldscnt,s.discamt,s.No_round_nm,s.PriceVatType,s.CashDsc4RtnPrepaid,s.outside_order,s.stcpay_amt,s.Qitaf_amt,s.whlslinv , s.vat_percent);'	
	
	begin transaction
	exec sp_executesql @sqlmsg
	set @no_of_invoices=@@ROWCOUNT
	if @@error<>0 or @no_of_invoices=0
	begin
		rollback transaction
		set @errstatus=-3
		if @no_of_invoices=0 set @errstatus=0
		return 
	end

--  Make sure that the field NQATI_PRCNT is available in pos_dt
	
    declare @is_nqati_there varchar(30)=''
    set @is_nqati_there=iif(EXISTS(SELECT name FROM sys.columns
    WHERE Name = N'nqati_prcnt' AND OBJECT_ID = OBJECT_ID(N'pos_dt')),',s.nqati_prcnt);',');')
	
	set @sqlmsg='merge pos_dt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'pos_dt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' And exists(Select contr,ref From pos_hd s1 Where a.company=s1.company and a.contr = s1.contr and a.ref = s1.ref)) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, cmbkey, qty, price, barcode, dscprsnt, srlno, rtrnd, dsc_amt, offer_amt
	    , nqati_prcnt,scl_barcode,taxtype) 
	    values (s.company ,s.contr ,s.ref,s.cmbkey ,s.qty,s.price ,s.barcode ,s.dscprsnt ,s.srlno,s.rtrnd,
	            s.dsc_amt,s.offer_amt,s.nqati_prcnt,s.scl_barcode,s.taxtype);'
	
	

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-4
		return 
	end
		
	set @sqlmsg='merge POSRTNINV as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSRTNINV a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.rcontr,s.rref,s.Contr,s.ref,s.rtnamt);'

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end

	set @sqlmsg='merge POSPPCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSPPCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.disccard=s.disccard'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.disccard,s.paytype,s.prepaidamt,s.paycard,s.nodsc4promo,s.prepaidamt_rtn);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

	set @sqlmsg='merge POSCCCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSCCCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' and b.ccpaid>0) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.cccardno=s.cccardno and t.ccsrlno=s.ccsrlno'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.cccardno,s.ccsrlno,s.cardtype,s.ccpaid,
	    s.ccconus,s.chargepctg,s.chargeamt,s.cctype,s.approvl_no,s.TransDate,s.TransTime,s.TransNo,s.terminal_id);'
		
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

	set @sqlmsg='merge poschrtinv as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'poschrtinv a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.hllamt,s.chrcode);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end

	set @sqlmsg='merge posfcamt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'posfcamt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' and b.invcst>0) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.fcy,s.fcamt,s.fcyrate,s.lcamt,s.srlno);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-6
		return 
	end
	else commit transaction
	
	declare @new_cndn nvarchar(250),
	        @lpos int =0
	set @lpos=charindex('INVDATE',@whr_condn)
	set @new_cndn=substring(@whr_condn,@lpos,200)
	set @new_cndn=replace(replace(@new_cndn,'INVDATE','mnydate'),'smalldatetime','date')
	set @sqlmsg='merge pos_mny as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_mny  where '+@new_cndn+') as s'	
	+ ' on t.company=s.company and t.contr=s.contr and t.mnydate=s.mnydate and t.slpcode=s.slpcode'
    + ' when not matched then '
	+ ' insert (company,contr,mnydate,slpcode,oner,fiver,tenr,twntyr,fiftyr,hundredr,
                twohandr,fivehandr,modified,rtnval,network,prepaidamt,scrtnval,scnetwork,scprepaidamt,
				sccash,saned_amt,scsaned_amt)                
	    values (s.company,s.contr,s.mnydate,s.slpcode,s.oner,s.fiver,s.tenr,s.twntyr,s.fiftyr,s.hundredr,
                s.twohandr,s.fivehandr,s.modified,s.rtnval,s.network,s.prepaidamt'
	+ iif(@it_is_pos=0,',s.scrtnval ,s.scnetwork,s.scprepaidamt,s.sccash,s.saned_amt,s.scsaned_amt',',0,0,0,0,s.saned_amt,0')+');'
	
	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
	end
	else commit transaction
	--END TRY
	--BEGIN CATCH
	--		SET @STR_MSG ='ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +' rtncode='+@rtncode
			
	--		return @errstatus
	--END CATCH
end 






GO
/****** Object:  StoredProcedure [dbo].[Update_Pos_Auto2]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--قباء

CREATE PROCEDURE [dbo].[Update_Pos_Auto2]
 @whr_condn nvarchar(200) = 'invdate > convert(date,dateadd(day,-7,GETDATE()),112)' ,
 @brlinksrvr nvarchar(15) = 'BRLNKSRVR0102',
 @wth_slp_cntr bit = 0 ,
 @no_of_invoices int=0 output,
 @errstatus int = 0 output
	
AS
BEGIN
	declare @sqlmsg nvarchar(max)='',
	@dbc nvarchar(14) = '.dbc01y30.dbo.',
	@lcalcomp char(2) = '01',
	@yrcode char(4) = '2020',
	@syscode int =2,
	@lcauseslctr bit=0,
	@it_is_pos bit=0
---------------------------------------------------------------------------------------------
	--set @dbc=db_name()
	--set @lcalcomp=substring(@dbc,4,2)
	--set @yrcode=substring(@dbc,7,2)
	--SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
	
	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @syscode=sysno,@lcauseslctr=causeslctr  from sysdb.dbo.glcalend 
	where calcomp=@lcalcomp and yrcode=@yrcode
------------------------------------------------------------------------------------------------------------------------------

    set @errstatus=0
 --   if @syscode<>3  --set @dbc='.'+db_name()+'.dbo.'
	--else 
	--begin
------------------------------ Get Yrcode & Calcomp from Branch Boteequ  ----------------------------------------------
--		declare @dynsql nvarchar(300),
--				@params nvarchar(100)

--		set @yrcode=''
--		set @lcalcomp=''
--		set @dynsql='select top 1 @yrcd=yrcode,@lclcmp=calcomp  from '+@brlinksrvr+'.posysdb.dbo.glcalend'
--		+ ' order by yrcode desc';
--		set @params='@yrcd char(4) output,@lclcmp char(2) output';
--		exec sp_executesql @dynsql,@params,@yrcd=@yrcode output,@lclcmp=@lcalcomp output
--		if @@error<>0 or @@rowcount=0
--		begin
--		  	set @errstatus=-1
--			return 
--		end
--		if @yrcode<>'' and @lcalcomp<>'' set @dbc='.pos'+@lcalcomp+'y'+substring(@yrcode,3,2)+'.dbo.'
--		else
--		begin
--		  	set @errstatus=-2
--			return 		  
--		end
--		set @it_is_pos=1
--------------------------------------------------------------------------------------------------------------------------
--	end
    

  if @wth_slp_cntr=1
	begin
	    set @sqlmsg='merge pos_ctr as t '
		+ ' using '+@brlinksrvr+@dbc+'pos_ctr as s'
		+ ' on t.ctrcompany=s.ctrcompany and t.ctrcode=s.ctrcode'
		+ ' when matched then '
		+ ' update set t.ctrloc = s.ctrloc ,t.ctrstatus = s.ctrstatus ,t.ctrnote = s.ctrnote ,t.ctrcash = s.ctrcash'
        + ',t.ctrrpls = s.ctrrpls,t.ctrcard = s.ctrcard ,t.ctrsanet = s.ctrsanet,t.ctrsanetpctg = s.ctrsanetpctg'
        + ',t.ctrvisa = s.ctrvisa ,t.ctrvisapctg = s.ctrvisapctg ,t.ctrmaster = s.ctrmaster'
        + ',t.ctrmasterpctg = s.ctrmasterpctg,t.ctrothers = s.ctrothers ,t.ctrotherspctg = s.ctrotherspctg'
        + ',t.slcenter = s.slcenter ,t.invser = s.invser,t.drwrcomport = s.drwrcomport,t.spath = s.spath'
        + ',t.ctrserial = s.ctrserial,t.modified = s.modified,t.started = s.started ,t.ended = s.ended'
        + ',t.drawer = s.drawer,t.cdisplay = s.cdisplay ,t.slmsg = s.slmsg,t.rtnmsg = s.rtnmsg'
        + ',t.footmsg1 = s.footmsg1,t.footmsg2 = s.footmsg2,t.footmsg3 = s.footmsg3,t.saveinserver = s.saveinserver'
        + ',t.saveinvall = s.saveinvall,t.scr_open = s.scr_open,t.slnoprint = s.slnoprint,t.rtnoprint = s.rtnoprint'
        + ',t.ccconus = s.ccconus,t.upditem_hrs = s.upditem_hrs,t.updinv_hrs = s.updinv_hrs,t.prntbyclass = s.prntbyclass'
        + ',t.sltype = s.sltype,t.rttype = s.rttype,t.rptype = s.rptype,t.icrptype = s.icrptype'
        + ',t.ctrprpaid = s.ctrprpaid,t.rtfmothrs = s.rtfmothrs,t.magcard = s.magcard,t.usbdsply = s.usbdsply'
        + ',t.dsplycomport = s.dsplycomport,t.rpt_grp_items = s.rpt_grp_items,
		   t.ctrsaned=s.ctrsaned,t.ctrsndecrpos=s.ctrsndecrpos,t.ctreftpos=s.ctreftpos ,t.eftport=s.eftport'
		+ ' when not matched then '
		+ ' insert (ctrcompany,ctrcode,ctrloc,ctrstatus ,ctrnote ,ctrcash ,ctrrpls ,ctrcard,ctrsanet'
        + ',ctrsanetpctg,ctrvisa,ctrvisapctg ,ctrmaster,ctrmasterpctg,ctrothers,ctrotherspctg'
        + ',slcenter,invser ,drwrcomport,spath ,ctrserial,modified,started,ended,drawer'
        + ',cdisplay,slmsg,rtnmsg,footmsg1,footmsg2,footmsg3,saveinserver,saveinvall,scr_open'
        + ',slnoprint,rtnoprint,ccconus ,upditem_hrs,updinv_hrs,prntbyclass ,sltype ,rttype'
        + ',rptype ,icrptype,ctrprpaid ,rtfmothrs,magcard ,usbdsply,dsplycomport,rpt_grp_items,
		    ctrsaned,ctrsndecrpos,eftport,ctreftpos,ntk_printer1,ntk_printer2,grp_printers,grp_prnt_local,cshRtn_f_o_b)'
		+ ' values (s.ctrcompany,s.ctrcode,s.ctrloc,s.ctrstatus ,s.ctrnote ,s.ctrcash ,s.ctrrpls ,s.ctrcard,s.ctrsanet'
        + ',s.ctrsanetpctg,s.ctrvisa,s.ctrvisapctg ,s.ctrmaster,s.ctrmasterpctg,s.ctrothers,s.ctrotherspctg'
        + ',s.slcenter,s.invser ,s.drwrcomport,s.spath ,s.ctrserial,s.modified,s.started,s.ended,s.drawer'
        + ',s.cdisplay,s.slmsg,s.rtnmsg,s.footmsg1,s.footmsg2,s.footmsg3,s.saveinserver,s.saveinvall,s.scr_open'
        + ',s.slnoprint,s.rtnoprint,s.ccconus ,s.upditem_hrs,s.updinv_hrs,s.prntbyclass ,s.sltype ,s.rttype'
        + ',s.rptype ,s.icrptype,s.ctrprpaid ,s.rtfmothrs,s.magcard ,s.usbdsply,s.dsplycomport,s.rpt_grp_items,
		    s.ctrsaned,s.ctrsndecrpos,s.eftport,s.ctreftpos,s.ntk_printer1,s.ntk_printer2,s.grp_printers,s.grp_prnt_local,s.cshRtn_f_o_b);'
			
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-10
			return 
		end
		else commit transaction
-- t.slppassword=s.slppassword,  is rempved 08-06-2014
	    set @sqlmsg='merge pos_slp as t '
		+ ' using '+@brlinksrvr+@dbc+'pos_slp as s'
		+ ' on t.slpcompany=s.slpcompany and t.slpcode=s.slpcode'
		+ ' when matched then '
		+ ' update set t.slpname=s.slpname,t.slpaddress=s.slpaddress,t.slptel=s.slptel,'
		+ ' t.slpchgqty=s.slpchgqty,t.slpchgprice=s.slpchgprice'
        + ',t.slpdelline=s.slpdelline,t.slpothersinv=s.slpothersinv,t.slpreturn=s.slpreturn,t.slpstatus=s.slpstatus,'
		+ ' t.slpalowdisc=s.slpalowdisc,t.slpmaxdisc=s.slpmaxdisc,t.slppricetp=s.slppricetp'
        + ',t.slpalowcancel=s.slpalowcancel,t.slpalowopdr=s.slpalowopdr,t.modified=s.modified,t.slpalowexit=s.slpalowexit,'
		+ ' t.slprtwoinv=s.slprtwoinv,t.slpblowbal=s.slpblowbal,t.scr_open=s.scr_open'
        + ',t.alwitmdsc=s.alwitmdsc,t.maxitmdsc=s.maxitmdsc ,t.alwuserpls=s.alwuserpls ,t.alwuseicrpls=s.alwuseicrpls,'
		+ 't.slpmagnetic=s.slpmagnetic,t.alwusebrrtn=s.alwusebrrtn,t.alwreprint=s.alwreprint'
        + ',t.frcrplinv=s.frcrplinv,t.catch_thief=s.catch_thief,t.sold_once=s.sold_once,t.only_scan_bc=s.only_scan_bc,'
		+ 't.stop_item_column=s.stop_item_column,t.slpfpalw=s.slpfpalw,t.slpfpimage=s.slpfpimage'
        + ',t.slcenter=s.slcenter,t.salesquota=s.salesquota,t.commissionP=s.commissionP,t.bonus=s.bonus,
		    t.supervisor=s.supervisor,t.ReadInvByBarcd=s.ReadInvByBarcd,
			t.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,t.alwcshcardpay=s.alwcshcardpay,'
		+ 't.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,t.slp_hlldscamtMax=s.slp_hlldscamtMax,t.alwprnttmpinv=s.alwprnttmpinv,s.ignore_mnmprice=s.ignore_mnmprice'
		
		+ ' when not matched then '
		+ ' insert values (s.slpcompany,s.slpcode,s.slpname,s.slpaddress,s.slptel,s.slppassword,s.slpchgqty,s.slpchgprice'
        + ',s.slpdelline,s.slpothersinv,s.slpreturn,s.slpstatus,s.slpalowdisc,s.slpmaxdisc,s.slppricetp'
        + ',s.slpalowcancel,s.slpalowopdr,s.modified,s.slpalowexit,s.slprtwoinv,s.slpblowbal,s.scr_open'
        + ',s.alwitmdsc,s.maxitmdsc ,s.alwuserpls ,s.alwuseicrpls,s.slpmagnetic,s.alwusebrrtn,s.alwreprint'
        + ',s.frcrplinv,s.catch_thief,s.sold_once,s.only_scan_bc,s.stop_item_column,s.slpfpalw,s.slpfpimage'
        + ',s.slcenter,s.salesquota,s.commissionP,s.bonus,s.supervisor,s.ReadInvByBarcd,s.alwrtncash,
		   s.alwmtchrtn,s.alwinvtrnsfr,s.alwcshcardpay,s.alwrtncash,s.alwmtchrtn,s.alwinvtrnsfr,s.slp_hlldscamtMax,s.alwprnttmpinv,s.ignore_mnmprice);'
		   
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-11
			return 
		end
		else commit transaction
	end
------------------------------------------------------------------------------------------------------------------------
	set @sqlmsg='merge pos_hd as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_hd b where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, invdate, entries, slperson, paytype, chargepctg, chargeamt, invdspc, disccard, 
		cardtype, invttl, invcst, invdsvl, valafds, invpaid, pricetp, slcenter, invorrtrn, cashamt, modified, 
		salinvno, salctrno, tdatetime, cktype, geninv, rref, rcontr, ccpaid, ccconus, prepaidamt, fmbranch,
		mobile, fcamt, custtype, paycard, saned_amt,rtncshamt,dfvchramt,frc_rtncash,vat_amt_rcvd,taxfree_sales,hlldscnt,discamt,No_round_nm,PriceVatType,CashDsc4RtnPrepaid,outside_order,stcpay_amt,Qitaf_amt,whlslinv , vat_percent)'
	+ ' values (s.company,s.contr,s.ref,s.invdate,s.entries,s.slperson ,s.paytype,s.chargepctg,s.chargeamt'
    + ' ,s.invdspc ,s.disccard ,s.cardtype ,s.invttl,s.invcst,s.invdsvl,s.valafds ,s.invpaid,s.pricetp,s.slcenter'
    + ' ,s.invorrtrn ,s.cashamt,s.modified ,s.salinvno ,s.salctrno ,s.tdatetime ,s.cktype ,s.geninv ,s.rref'
    + ' ,s.rcontr ,s.ccpaid ,s.ccconus,s.prepaidamt ,s.fmbranch,s.mobile ,s.fcamt ,s.custtype ,s.paycard,s.saned_amt,
	     s.rtncshamt,s.dfvchramt,s.frc_rtncash,s.vat_amt_rcvd,s.taxfree_sales,s.hlldscnt,s.discamt,s.No_round_nm,s.PriceVatType,s.CashDsc4RtnPrepaid,s.outside_order,s.stcpay_amt,s.Qitaf_amt,s.whlslinv , s.vat_percent);'	
	
	begin transaction
	exec sp_executesql @sqlmsg
	set @no_of_invoices=@@ROWCOUNT
	if @@error<>0 or @no_of_invoices=0
	begin
		rollback transaction
		set @errstatus=-3
		if @no_of_invoices=0 set @errstatus=0
		return 
	end

--  Make sure that the field NQATI_PRCNT is available in pos_dt
	
    declare @is_nqati_there varchar(30)=''
    set @is_nqati_there=iif(EXISTS(SELECT name FROM sys.columns
    WHERE Name = N'nqati_prcnt' AND OBJECT_ID = OBJECT_ID(N'pos_dt')),',s.nqati_prcnt);',');')
	
	set @sqlmsg='merge pos_dt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'pos_dt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' And exists(Select contr,ref From pos_hd s1 Where a.company=s1.company and a.contr = s1.contr and a.ref = s1.ref)) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, cmbkey, qty, price, barcode, dscprsnt, srlno, rtrnd, dsc_amt, offer_amt
	    , nqati_prcnt,scl_barcode,taxtype) 
	    values (s.company ,s.contr ,s.ref,s.cmbkey ,s.qty,s.price ,s.barcode ,s.dscprsnt ,s.srlno,s.rtrnd,
	            s.dsc_amt,s.offer_amt,s.nqati_prcnt,s.scl_barcode,s.taxtype);'
	
	

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-4
		return 
	end
		
	set @sqlmsg='merge POSRTNINV as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSRTNINV a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.rcontr,s.rref,s.Contr,s.ref,s.rtnamt);'

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end

	set @sqlmsg='merge POSPPCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSPPCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.disccard=s.disccard'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.disccard,s.paytype,s.prepaidamt,s.paycard,s.nodsc4promo,s.prepaidamt_rtn);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

	set @sqlmsg='merge POSCCCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSCCCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' and b.ccpaid>0) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.cccardno=s.cccardno and t.ccsrlno=s.ccsrlno'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.cccardno,s.ccsrlno,s.cardtype,s.ccpaid,
	    s.ccconus,s.chargepctg,s.chargeamt,s.cctype,s.approvl_no,s.TransDate,s.TransTime,s.TransNo,s.terminal_id);'
		
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

	set @sqlmsg='merge poschrtinv as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'poschrtinv a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.hllamt,s.chrcode);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end

	set @sqlmsg='merge posfcamt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'posfcamt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' and b.invcst>0) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.fcy,s.fcamt,s.fcyrate,s.lcamt,s.srlno);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-6
		return 
	end
	else commit transaction
	
	declare @new_cndn nvarchar(250),
	        @lpos int =0
	set @lpos=charindex('INVDATE',@whr_condn)
	set @new_cndn=substring(@whr_condn,@lpos,200)
	set @new_cndn=replace(replace(@new_cndn,'INVDATE','mnydate'),'smalldatetime','date')
	set @sqlmsg='merge pos_mny as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_mny  where '+@new_cndn+') as s'	
	+ ' on t.company=s.company and t.contr=s.contr and t.mnydate=s.mnydate and t.slpcode=s.slpcode'
    + ' when not matched then '
	+ ' insert (company,contr,mnydate,slpcode,oner,fiver,tenr,twntyr,fiftyr,hundredr,
                twohandr,fivehandr,modified,rtnval,network,prepaidamt,scrtnval,scnetwork,scprepaidamt,
				sccash,saned_amt,scsaned_amt)                
	    values (s.company,s.contr,s.mnydate,s.slpcode,s.oner,s.fiver,s.tenr,s.twntyr,s.fiftyr,s.hundredr,
                s.twohandr,s.fivehandr,s.modified,s.rtnval,s.network,s.prepaidamt'
	+ iif(@it_is_pos=0,',s.scrtnval ,s.scnetwork,s.scprepaidamt,s.sccash,s.saned_amt,s.scsaned_amt',',0,0,0,0,s.saned_amt,0')+');'
	
	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
	end
	else commit transaction
	--END TRY
	--BEGIN CATCH
	--		SET @STR_MSG ='ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +' rtncode='+@rtncode
			
	--		return @errstatus
	--END CATCH
end 






GO
/****** Object:  StoredProcedure [dbo].[Update_Pos_Auto3]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--التحلية

CREATE PROCEDURE [dbo].[Update_Pos_Auto3]
 @whr_condn nvarchar(200) = 'invdate > convert(date,dateadd(day,-7,GETDATE()),112)' ,
 @brlinksrvr nvarchar(15) = 'BRLNKSRVR0103',
 @wth_slp_cntr bit = 0 ,
 @no_of_invoices int=0 output,
 @errstatus int = 0 output
	
AS
BEGIN
	declare @sqlmsg nvarchar(max)='',
	@dbc nvarchar(14) = '.dbc01y30.dbo.',
	@lcalcomp char(2) = '01',
	@yrcode char(4) = '2020',
	@syscode int =2,
	@lcauseslctr bit=0,
	@it_is_pos bit=0
---------------------------------------------------------------------------------------------
	--set @dbc=db_name()
	--set @lcalcomp=substring(@dbc,4,2)
	--set @yrcode=substring(@dbc,7,2)
	--SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
	
	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @syscode=sysno,@lcauseslctr=causeslctr  from sysdb.dbo.glcalend 
	where calcomp=@lcalcomp and yrcode=@yrcode
------------------------------------------------------------------------------------------------------------------------------

    set @errstatus=0
 --   if @syscode<>3  --set @dbc='.'+db_name()+'.dbo.'
	--else 
	--begin
------------------------------ Get Yrcode & Calcomp from Branch Boteequ  ----------------------------------------------
--		declare @dynsql nvarchar(300),
--				@params nvarchar(100)

--		set @yrcode=''
--		set @lcalcomp=''
--		set @dynsql='select top 1 @yrcd=yrcode,@lclcmp=calcomp  from '+@brlinksrvr+'.posysdb.dbo.glcalend'
--		+ ' order by yrcode desc';
--		set @params='@yrcd char(4) output,@lclcmp char(2) output';
--		exec sp_executesql @dynsql,@params,@yrcd=@yrcode output,@lclcmp=@lcalcomp output
--		if @@error<>0 or @@rowcount=0
--		begin
--		  	set @errstatus=-1
--			return 
--		end
--		if @yrcode<>'' and @lcalcomp<>'' set @dbc='.pos'+@lcalcomp+'y'+substring(@yrcode,3,2)+'.dbo.'
--		else
--		begin
--		  	set @errstatus=-2
--			return 		  
--		end
--		set @it_is_pos=1
--------------------------------------------------------------------------------------------------------------------------
--	end
    

  if @wth_slp_cntr=1
	begin
	    set @sqlmsg='merge pos_ctr as t '
		+ ' using '+@brlinksrvr+@dbc+'pos_ctr as s'
		+ ' on t.ctrcompany=s.ctrcompany and t.ctrcode=s.ctrcode'
		+ ' when matched then '
		+ ' update set t.ctrloc = s.ctrloc ,t.ctrstatus = s.ctrstatus ,t.ctrnote = s.ctrnote ,t.ctrcash = s.ctrcash'
        + ',t.ctrrpls = s.ctrrpls,t.ctrcard = s.ctrcard ,t.ctrsanet = s.ctrsanet,t.ctrsanetpctg = s.ctrsanetpctg'
        + ',t.ctrvisa = s.ctrvisa ,t.ctrvisapctg = s.ctrvisapctg ,t.ctrmaster = s.ctrmaster'
        + ',t.ctrmasterpctg = s.ctrmasterpctg,t.ctrothers = s.ctrothers ,t.ctrotherspctg = s.ctrotherspctg'
        + ',t.slcenter = s.slcenter ,t.invser = s.invser,t.drwrcomport = s.drwrcomport,t.spath = s.spath'
        + ',t.ctrserial = s.ctrserial,t.modified = s.modified,t.started = s.started ,t.ended = s.ended'
        + ',t.drawer = s.drawer,t.cdisplay = s.cdisplay ,t.slmsg = s.slmsg,t.rtnmsg = s.rtnmsg'
        + ',t.footmsg1 = s.footmsg1,t.footmsg2 = s.footmsg2,t.footmsg3 = s.footmsg3,t.saveinserver = s.saveinserver'
        + ',t.saveinvall = s.saveinvall,t.scr_open = s.scr_open,t.slnoprint = s.slnoprint,t.rtnoprint = s.rtnoprint'
        + ',t.ccconus = s.ccconus,t.upditem_hrs = s.upditem_hrs,t.updinv_hrs = s.updinv_hrs,t.prntbyclass = s.prntbyclass'
        + ',t.sltype = s.sltype,t.rttype = s.rttype,t.rptype = s.rptype,t.icrptype = s.icrptype'
        + ',t.ctrprpaid = s.ctrprpaid,t.rtfmothrs = s.rtfmothrs,t.magcard = s.magcard,t.usbdsply = s.usbdsply'
        + ',t.dsplycomport = s.dsplycomport,t.rpt_grp_items = s.rpt_grp_items,
		   t.ctrsaned=s.ctrsaned,t.ctrsndecrpos=s.ctrsndecrpos,t.ctreftpos=s.ctreftpos ,t.eftport=s.eftport'
		+ ' when not matched then '
		+ ' insert (ctrcompany,ctrcode,ctrloc,ctrstatus ,ctrnote ,ctrcash ,ctrrpls ,ctrcard,ctrsanet'
        + ',ctrsanetpctg,ctrvisa,ctrvisapctg ,ctrmaster,ctrmasterpctg,ctrothers,ctrotherspctg'
        + ',slcenter,invser ,drwrcomport,spath ,ctrserial,modified,started,ended,drawer'
        + ',cdisplay,slmsg,rtnmsg,footmsg1,footmsg2,footmsg3,saveinserver,saveinvall,scr_open'
        + ',slnoprint,rtnoprint,ccconus ,upditem_hrs,updinv_hrs,prntbyclass ,sltype ,rttype'
        + ',rptype ,icrptype,ctrprpaid ,rtfmothrs,magcard ,usbdsply,dsplycomport,rpt_grp_items,
		    ctrsaned,ctrsndecrpos,eftport,ctreftpos,ntk_printer1,ntk_printer2,grp_printers,grp_prnt_local,cshRtn_f_o_b)'
		+ ' values (s.ctrcompany,s.ctrcode,s.ctrloc,s.ctrstatus ,s.ctrnote ,s.ctrcash ,s.ctrrpls ,s.ctrcard,s.ctrsanet'
        + ',s.ctrsanetpctg,s.ctrvisa,s.ctrvisapctg ,s.ctrmaster,s.ctrmasterpctg,s.ctrothers,s.ctrotherspctg'
        + ',s.slcenter,s.invser ,s.drwrcomport,s.spath ,s.ctrserial,s.modified,s.started,s.ended,s.drawer'
        + ',s.cdisplay,s.slmsg,s.rtnmsg,s.footmsg1,s.footmsg2,s.footmsg3,s.saveinserver,s.saveinvall,s.scr_open'
        + ',s.slnoprint,s.rtnoprint,s.ccconus ,s.upditem_hrs,s.updinv_hrs,s.prntbyclass ,s.sltype ,s.rttype'
        + ',s.rptype ,s.icrptype,s.ctrprpaid ,s.rtfmothrs,s.magcard ,s.usbdsply,s.dsplycomport,s.rpt_grp_items,
		    s.ctrsaned,s.ctrsndecrpos,s.eftport,s.ctreftpos,s.ntk_printer1,s.ntk_printer2,s.grp_printers,s.grp_prnt_local,s.cshRtn_f_o_b);'
			
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-10
			return 
		end
		else commit transaction
-- t.slppassword=s.slppassword,  is rempved 08-06-2014
	    set @sqlmsg='merge pos_slp as t '
		+ ' using '+@brlinksrvr+@dbc+'pos_slp as s'
		+ ' on t.slpcompany=s.slpcompany and t.slpcode=s.slpcode'
		+ ' when matched then '
		+ ' update set t.slpname=s.slpname,t.slpaddress=s.slpaddress,t.slptel=s.slptel,'
		+ ' t.slpchgqty=s.slpchgqty,t.slpchgprice=s.slpchgprice'
        + ',t.slpdelline=s.slpdelline,t.slpothersinv=s.slpothersinv,t.slpreturn=s.slpreturn,t.slpstatus=s.slpstatus,'
		+ ' t.slpalowdisc=s.slpalowdisc,t.slpmaxdisc=s.slpmaxdisc,t.slppricetp=s.slppricetp'
        + ',t.slpalowcancel=s.slpalowcancel,t.slpalowopdr=s.slpalowopdr,t.modified=s.modified,t.slpalowexit=s.slpalowexit,'
		+ ' t.slprtwoinv=s.slprtwoinv,t.slpblowbal=s.slpblowbal,t.scr_open=s.scr_open'
        + ',t.alwitmdsc=s.alwitmdsc,t.maxitmdsc=s.maxitmdsc ,t.alwuserpls=s.alwuserpls ,t.alwuseicrpls=s.alwuseicrpls,'
		+ 't.slpmagnetic=s.slpmagnetic,t.alwusebrrtn=s.alwusebrrtn,t.alwreprint=s.alwreprint'
        + ',t.frcrplinv=s.frcrplinv,t.catch_thief=s.catch_thief,t.sold_once=s.sold_once,t.only_scan_bc=s.only_scan_bc,'
		+ 't.stop_item_column=s.stop_item_column,t.slpfpalw=s.slpfpalw,t.slpfpimage=s.slpfpimage'
        + ',t.slcenter=s.slcenter,t.salesquota=s.salesquota,t.commissionP=s.commissionP,t.bonus=s.bonus,
		    t.supervisor=s.supervisor,t.ReadInvByBarcd=s.ReadInvByBarcd,
			t.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,t.alwcshcardpay=s.alwcshcardpay,'
		+ 't.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,t.slp_hlldscamtMax=s.slp_hlldscamtMax,t.alwprnttmpinv=s.alwprnttmpinv,s.ignore_mnmprice=s.ignore_mnmprice'
		
		+ ' when not matched then '
		+ ' insert values (s.slpcompany,s.slpcode,s.slpname,s.slpaddress,s.slptel,s.slppassword,s.slpchgqty,s.slpchgprice'
        + ',s.slpdelline,s.slpothersinv,s.slpreturn,s.slpstatus,s.slpalowdisc,s.slpmaxdisc,s.slppricetp'
        + ',s.slpalowcancel,s.slpalowopdr,s.modified,s.slpalowexit,s.slprtwoinv,s.slpblowbal,s.scr_open'
        + ',s.alwitmdsc,s.maxitmdsc ,s.alwuserpls ,s.alwuseicrpls,s.slpmagnetic,s.alwusebrrtn,s.alwreprint'
        + ',s.frcrplinv,s.catch_thief,s.sold_once,s.only_scan_bc,s.stop_item_column,s.slpfpalw,s.slpfpimage'
        + ',s.slcenter,s.salesquota,s.commissionP,s.bonus,s.supervisor,s.ReadInvByBarcd,s.alwrtncash,
		   s.alwmtchrtn,s.alwinvtrnsfr,s.alwcshcardpay,s.alwrtncash,s.alwmtchrtn,s.alwinvtrnsfr,s.slp_hlldscamtMax,s.alwprnttmpinv,s.ignore_mnmprice);'
		   
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-11
			return 
		end
		else commit transaction
	end
------------------------------------------------------------------------------------------------------------------------
	set @sqlmsg='merge pos_hd as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_hd b where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, invdate, entries, slperson, paytype, chargepctg, chargeamt, invdspc, disccard, 
		cardtype, invttl, invcst, invdsvl, valafds, invpaid, pricetp, slcenter, invorrtrn, cashamt, modified, 
		salinvno, salctrno, tdatetime, cktype, geninv, rref, rcontr, ccpaid, ccconus, prepaidamt, fmbranch,
		mobile, fcamt, custtype, paycard, saned_amt,rtncshamt,dfvchramt,frc_rtncash,vat_amt_rcvd,taxfree_sales,hlldscnt,discamt,No_round_nm,PriceVatType,CashDsc4RtnPrepaid,outside_order,stcpay_amt,Qitaf_amt,whlslinv , vat_percent)'
	+ ' values (s.company,s.contr,s.ref,s.invdate,s.entries,s.slperson ,s.paytype,s.chargepctg,s.chargeamt'
    + ' ,s.invdspc ,s.disccard ,s.cardtype ,s.invttl,s.invcst,s.invdsvl,s.valafds ,s.invpaid,s.pricetp,s.slcenter'
    + ' ,s.invorrtrn ,s.cashamt,s.modified ,s.salinvno ,s.salctrno ,s.tdatetime ,s.cktype ,s.geninv ,s.rref'
    + ' ,s.rcontr ,s.ccpaid ,s.ccconus,s.prepaidamt ,s.fmbranch,s.mobile ,s.fcamt ,s.custtype ,s.paycard,s.saned_amt,
	     s.rtncshamt,s.dfvchramt,s.frc_rtncash,s.vat_amt_rcvd,s.taxfree_sales,s.hlldscnt,s.discamt,s.No_round_nm,s.PriceVatType,s.CashDsc4RtnPrepaid,s.outside_order,s.stcpay_amt,s.Qitaf_amt,s.whlslinv , s.vat_percent);'	
	
	begin transaction
	exec sp_executesql @sqlmsg
	set @no_of_invoices=@@ROWCOUNT
	if @@error<>0 or @no_of_invoices=0
	begin
		rollback transaction
		set @errstatus=-3
		if @no_of_invoices=0 set @errstatus=0
		return 
	end

--  Make sure that the field NQATI_PRCNT is available in pos_dt
	
    declare @is_nqati_there varchar(30)=''
    set @is_nqati_there=iif(EXISTS(SELECT name FROM sys.columns
    WHERE Name = N'nqati_prcnt' AND OBJECT_ID = OBJECT_ID(N'pos_dt')),',s.nqati_prcnt);',');')
	
	set @sqlmsg='merge pos_dt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'pos_dt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' And exists(Select contr,ref From pos_hd s1 Where a.company=s1.company and a.contr = s1.contr and a.ref = s1.ref)) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, cmbkey, qty, price, barcode, dscprsnt, srlno, rtrnd, dsc_amt, offer_amt
	    , nqati_prcnt,scl_barcode,taxtype) 
	    values (s.company ,s.contr ,s.ref,s.cmbkey ,s.qty,s.price ,s.barcode ,s.dscprsnt ,s.srlno,s.rtrnd,
	            s.dsc_amt,s.offer_amt,s.nqati_prcnt,s.scl_barcode,s.taxtype);'
	
	

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-4
		return 
	end
		
	set @sqlmsg='merge POSRTNINV as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSRTNINV a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.rcontr,s.rref,s.Contr,s.ref,s.rtnamt);'

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end

	set @sqlmsg='merge POSPPCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSPPCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.disccard=s.disccard'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.disccard,s.paytype,s.prepaidamt,s.paycard,s.nodsc4promo,s.prepaidamt_rtn);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

	set @sqlmsg='merge POSCCCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSCCCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' and b.ccpaid>0) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.cccardno=s.cccardno and t.ccsrlno=s.ccsrlno'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.cccardno,s.ccsrlno,s.cardtype,s.ccpaid,
	    s.ccconus,s.chargepctg,s.chargeamt,s.cctype,s.approvl_no,s.TransDate,s.TransTime,s.TransNo,s.terminal_id);'
		
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

	set @sqlmsg='merge poschrtinv as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'poschrtinv a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.hllamt,s.chrcode);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end

	set @sqlmsg='merge posfcamt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'posfcamt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' and b.invcst>0) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.fcy,s.fcamt,s.fcyrate,s.lcamt,s.srlno);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-6
		return 
	end
	else commit transaction
	
	declare @new_cndn nvarchar(250),
	        @lpos int =0
	set @lpos=charindex('INVDATE',@whr_condn)
	set @new_cndn=substring(@whr_condn,@lpos,200)
	set @new_cndn=replace(replace(@new_cndn,'INVDATE','mnydate'),'smalldatetime','date')
	set @sqlmsg='merge pos_mny as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_mny  where '+@new_cndn+') as s'	
	+ ' on t.company=s.company and t.contr=s.contr and t.mnydate=s.mnydate and t.slpcode=s.slpcode'
    + ' when not matched then '
	+ ' insert (company,contr,mnydate,slpcode,oner,fiver,tenr,twntyr,fiftyr,hundredr,
                twohandr,fivehandr,modified,rtnval,network,prepaidamt,scrtnval,scnetwork,scprepaidamt,
				sccash,saned_amt,scsaned_amt)                
	    values (s.company,s.contr,s.mnydate,s.slpcode,s.oner,s.fiver,s.tenr,s.twntyr,s.fiftyr,s.hundredr,
                s.twohandr,s.fivehandr,s.modified,s.rtnval,s.network,s.prepaidamt'
	+ iif(@it_is_pos=0,',s.scrtnval ,s.scnetwork,s.scprepaidamt,s.sccash,s.saned_amt,s.scsaned_amt',',0,0,0,0,s.saned_amt,0')+');'
	
	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
	end
	else commit transaction
	--END TRY
	--BEGIN CATCH
	--		SET @STR_MSG ='ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +' rtncode='+@rtncode
			
	--		return @errstatus
	--END CATCH
end 






GO
/****** Object:  StoredProcedure [dbo].[Update_Pos_Auto4]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--الرمال

CREATE PROCEDURE [dbo].[Update_Pos_Auto4]
 @whr_condn nvarchar(200) = 'invdate > convert(date,dateadd(day,-7,GETDATE()),112)' ,
 @brlinksrvr nvarchar(15) = 'BRLNKSRVR0104',
 @wth_slp_cntr bit = 0 ,
 @no_of_invoices int=0 output,
 @errstatus int = 0 output
	
AS
BEGIN
	declare @sqlmsg nvarchar(max)='',
	@dbc nvarchar(14) = '.dbc01y30.dbo.',
	@lcalcomp char(2) = '01',
	@yrcode char(4) = '2020',
	@syscode int =2,
	@lcauseslctr bit=0,
	@it_is_pos bit=0
---------------------------------------------------------------------------------------------
	--set @dbc=db_name()
	--set @lcalcomp=substring(@dbc,4,2)
	--set @yrcode=substring(@dbc,7,2)
	--SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
	
	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @syscode=sysno,@lcauseslctr=causeslctr  from sysdb.dbo.glcalend 
	where calcomp=@lcalcomp and yrcode=@yrcode
------------------------------------------------------------------------------------------------------------------------------

    set @errstatus=0
 --   if @syscode<>3  --set @dbc='.'+db_name()+'.dbo.'
	--else 
	--begin
------------------------------ Get Yrcode & Calcomp from Branch Boteequ  ----------------------------------------------
--		declare @dynsql nvarchar(300),
--				@params nvarchar(100)

--		set @yrcode=''
--		set @lcalcomp=''
--		set @dynsql='select top 1 @yrcd=yrcode,@lclcmp=calcomp  from '+@brlinksrvr+'.posysdb.dbo.glcalend'
--		+ ' order by yrcode desc';
--		set @params='@yrcd char(4) output,@lclcmp char(2) output';
--		exec sp_executesql @dynsql,@params,@yrcd=@yrcode output,@lclcmp=@lcalcomp output
--		if @@error<>0 or @@rowcount=0
--		begin
--		  	set @errstatus=-1
--			return 
--		end
--		if @yrcode<>'' and @lcalcomp<>'' set @dbc='.pos'+@lcalcomp+'y'+substring(@yrcode,3,2)+'.dbo.'
--		else
--		begin
--		  	set @errstatus=-2
--			return 		  
--		end
--		set @it_is_pos=1
--------------------------------------------------------------------------------------------------------------------------
--	end
    

  if @wth_slp_cntr=1
	begin
	    set @sqlmsg='merge pos_ctr as t '
		+ ' using '+@brlinksrvr+@dbc+'pos_ctr as s'
		+ ' on t.ctrcompany=s.ctrcompany and t.ctrcode=s.ctrcode'
		+ ' when matched then '
		+ ' update set t.ctrloc = s.ctrloc ,t.ctrstatus = s.ctrstatus ,t.ctrnote = s.ctrnote ,t.ctrcash = s.ctrcash'
        + ',t.ctrrpls = s.ctrrpls,t.ctrcard = s.ctrcard ,t.ctrsanet = s.ctrsanet,t.ctrsanetpctg = s.ctrsanetpctg'
        + ',t.ctrvisa = s.ctrvisa ,t.ctrvisapctg = s.ctrvisapctg ,t.ctrmaster = s.ctrmaster'
        + ',t.ctrmasterpctg = s.ctrmasterpctg,t.ctrothers = s.ctrothers ,t.ctrotherspctg = s.ctrotherspctg'
        + ',t.slcenter = s.slcenter ,t.invser = s.invser,t.drwrcomport = s.drwrcomport,t.spath = s.spath'
        + ',t.ctrserial = s.ctrserial,t.modified = s.modified,t.started = s.started ,t.ended = s.ended'
        + ',t.drawer = s.drawer,t.cdisplay = s.cdisplay ,t.slmsg = s.slmsg,t.rtnmsg = s.rtnmsg'
        + ',t.footmsg1 = s.footmsg1,t.footmsg2 = s.footmsg2,t.footmsg3 = s.footmsg3,t.saveinserver = s.saveinserver'
        + ',t.saveinvall = s.saveinvall,t.scr_open = s.scr_open,t.slnoprint = s.slnoprint,t.rtnoprint = s.rtnoprint'
        + ',t.ccconus = s.ccconus,t.upditem_hrs = s.upditem_hrs,t.updinv_hrs = s.updinv_hrs,t.prntbyclass = s.prntbyclass'
        + ',t.sltype = s.sltype,t.rttype = s.rttype,t.rptype = s.rptype,t.icrptype = s.icrptype'
        + ',t.ctrprpaid = s.ctrprpaid,t.rtfmothrs = s.rtfmothrs,t.magcard = s.magcard,t.usbdsply = s.usbdsply'
        + ',t.dsplycomport = s.dsplycomport,t.rpt_grp_items = s.rpt_grp_items,
		   t.ctrsaned=s.ctrsaned,t.ctrsndecrpos=s.ctrsndecrpos,t.ctreftpos=s.ctreftpos ,t.eftport=s.eftport'
		+ ' when not matched then '
		+ ' insert (ctrcompany,ctrcode,ctrloc,ctrstatus ,ctrnote ,ctrcash ,ctrrpls ,ctrcard,ctrsanet'
        + ',ctrsanetpctg,ctrvisa,ctrvisapctg ,ctrmaster,ctrmasterpctg,ctrothers,ctrotherspctg'
        + ',slcenter,invser ,drwrcomport,spath ,ctrserial,modified,started,ended,drawer'
        + ',cdisplay,slmsg,rtnmsg,footmsg1,footmsg2,footmsg3,saveinserver,saveinvall,scr_open'
        + ',slnoprint,rtnoprint,ccconus ,upditem_hrs,updinv_hrs,prntbyclass ,sltype ,rttype'
        + ',rptype ,icrptype,ctrprpaid ,rtfmothrs,magcard ,usbdsply,dsplycomport,rpt_grp_items,
		    ctrsaned,ctrsndecrpos,eftport,ctreftpos,ntk_printer1,ntk_printer2,grp_printers,grp_prnt_local,cshRtn_f_o_b)'
		+ ' values (s.ctrcompany,s.ctrcode,s.ctrloc,s.ctrstatus ,s.ctrnote ,s.ctrcash ,s.ctrrpls ,s.ctrcard,s.ctrsanet'
        + ',s.ctrsanetpctg,s.ctrvisa,s.ctrvisapctg ,s.ctrmaster,s.ctrmasterpctg,s.ctrothers,s.ctrotherspctg'
        + ',s.slcenter,s.invser ,s.drwrcomport,s.spath ,s.ctrserial,s.modified,s.started,s.ended,s.drawer'
        + ',s.cdisplay,s.slmsg,s.rtnmsg,s.footmsg1,s.footmsg2,s.footmsg3,s.saveinserver,s.saveinvall,s.scr_open'
        + ',s.slnoprint,s.rtnoprint,s.ccconus ,s.upditem_hrs,s.updinv_hrs,s.prntbyclass ,s.sltype ,s.rttype'
        + ',s.rptype ,s.icrptype,s.ctrprpaid ,s.rtfmothrs,s.magcard ,s.usbdsply,s.dsplycomport,s.rpt_grp_items,
		    s.ctrsaned,s.ctrsndecrpos,s.eftport,s.ctreftpos,s.ntk_printer1,s.ntk_printer2,s.grp_printers,s.grp_prnt_local,s.cshRtn_f_o_b);'
			
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-10
			return 
		end
		else commit transaction
-- t.slppassword=s.slppassword,  is rempved 08-06-2014
	    set @sqlmsg='merge pos_slp as t '
		+ ' using '+@brlinksrvr+@dbc+'pos_slp as s'
		+ ' on t.slpcompany=s.slpcompany and t.slpcode=s.slpcode'
		+ ' when matched then '
		+ ' update set t.slpname=s.slpname,t.slpaddress=s.slpaddress,t.slptel=s.slptel,'
		+ ' t.slpchgqty=s.slpchgqty,t.slpchgprice=s.slpchgprice'
        + ',t.slpdelline=s.slpdelline,t.slpothersinv=s.slpothersinv,t.slpreturn=s.slpreturn,t.slpstatus=s.slpstatus,'
		+ ' t.slpalowdisc=s.slpalowdisc,t.slpmaxdisc=s.slpmaxdisc,t.slppricetp=s.slppricetp'
        + ',t.slpalowcancel=s.slpalowcancel,t.slpalowopdr=s.slpalowopdr,t.modified=s.modified,t.slpalowexit=s.slpalowexit,'
		+ ' t.slprtwoinv=s.slprtwoinv,t.slpblowbal=s.slpblowbal,t.scr_open=s.scr_open'
        + ',t.alwitmdsc=s.alwitmdsc,t.maxitmdsc=s.maxitmdsc ,t.alwuserpls=s.alwuserpls ,t.alwuseicrpls=s.alwuseicrpls,'
		+ 't.slpmagnetic=s.slpmagnetic,t.alwusebrrtn=s.alwusebrrtn,t.alwreprint=s.alwreprint'
        + ',t.frcrplinv=s.frcrplinv,t.catch_thief=s.catch_thief,t.sold_once=s.sold_once,t.only_scan_bc=s.only_scan_bc,'
		+ 't.stop_item_column=s.stop_item_column,t.slpfpalw=s.slpfpalw,t.slpfpimage=s.slpfpimage'
        + ',t.slcenter=s.slcenter,t.salesquota=s.salesquota,t.commissionP=s.commissionP,t.bonus=s.bonus,
		    t.supervisor=s.supervisor,t.ReadInvByBarcd=s.ReadInvByBarcd,
			t.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,t.alwcshcardpay=s.alwcshcardpay,'
		+ 't.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,t.slp_hlldscamtMax=s.slp_hlldscamtMax,t.alwprnttmpinv=s.alwprnttmpinv,s.ignore_mnmprice=s.ignore_mnmprice'
		
		+ ' when not matched then '
		+ ' insert values (s.slpcompany,s.slpcode,s.slpname,s.slpaddress,s.slptel,s.slppassword,s.slpchgqty,s.slpchgprice'
        + ',s.slpdelline,s.slpothersinv,s.slpreturn,s.slpstatus,s.slpalowdisc,s.slpmaxdisc,s.slppricetp'
        + ',s.slpalowcancel,s.slpalowopdr,s.modified,s.slpalowexit,s.slprtwoinv,s.slpblowbal,s.scr_open'
        + ',s.alwitmdsc,s.maxitmdsc ,s.alwuserpls ,s.alwuseicrpls,s.slpmagnetic,s.alwusebrrtn,s.alwreprint'
        + ',s.frcrplinv,s.catch_thief,s.sold_once,s.only_scan_bc,s.stop_item_column,s.slpfpalw,s.slpfpimage'
        + ',s.slcenter,s.salesquota,s.commissionP,s.bonus,s.supervisor,s.ReadInvByBarcd,s.alwrtncash,
		   s.alwmtchrtn,s.alwinvtrnsfr,s.alwcshcardpay,s.alwrtncash,s.alwmtchrtn,s.alwinvtrnsfr,s.slp_hlldscamtMax,s.alwprnttmpinv,s.ignore_mnmprice);'
		   
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-11
			return 
		end
		else commit transaction
	end
------------------------------------------------------------------------------------------------------------------------
	set @sqlmsg='merge pos_hd as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_hd b where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, invdate, entries, slperson, paytype, chargepctg, chargeamt, invdspc, disccard, 
		cardtype, invttl, invcst, invdsvl, valafds, invpaid, pricetp, slcenter, invorrtrn, cashamt, modified, 
		salinvno, salctrno, tdatetime, cktype, geninv, rref, rcontr, ccpaid, ccconus, prepaidamt, fmbranch,
		mobile, fcamt, custtype, paycard, saned_amt,rtncshamt,dfvchramt,frc_rtncash,vat_amt_rcvd,taxfree_sales,hlldscnt,discamt,No_round_nm,PriceVatType,CashDsc4RtnPrepaid,outside_order,stcpay_amt,Qitaf_amt,whlslinv , vat_percent)'
	+ ' values (s.company,s.contr,s.ref,s.invdate,s.entries,s.slperson ,s.paytype,s.chargepctg,s.chargeamt'
    + ' ,s.invdspc ,s.disccard ,s.cardtype ,s.invttl,s.invcst,s.invdsvl,s.valafds ,s.invpaid,s.pricetp,s.slcenter'
    + ' ,s.invorrtrn ,s.cashamt,s.modified ,s.salinvno ,s.salctrno ,s.tdatetime ,s.cktype ,s.geninv ,s.rref'
    + ' ,s.rcontr ,s.ccpaid ,s.ccconus,s.prepaidamt ,s.fmbranch,s.mobile ,s.fcamt ,s.custtype ,s.paycard,s.saned_amt,
	     s.rtncshamt,s.dfvchramt,s.frc_rtncash,s.vat_amt_rcvd,s.taxfree_sales,s.hlldscnt,s.discamt,s.No_round_nm,s.PriceVatType,s.CashDsc4RtnPrepaid,s.outside_order,s.stcpay_amt,s.Qitaf_amt,s.whlslinv , s.vat_percent);'	
	
	begin transaction
	exec sp_executesql @sqlmsg
	set @no_of_invoices=@@ROWCOUNT
	if @@error<>0 or @no_of_invoices=0
	begin
		rollback transaction
		set @errstatus=-3
		if @no_of_invoices=0 set @errstatus=0
		return 
	end

--  Make sure that the field NQATI_PRCNT is available in pos_dt
	
    declare @is_nqati_there varchar(30)=''
    set @is_nqati_there=iif(EXISTS(SELECT name FROM sys.columns
    WHERE Name = N'nqati_prcnt' AND OBJECT_ID = OBJECT_ID(N'pos_dt')),',s.nqati_prcnt);',');')
	
	set @sqlmsg='merge pos_dt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'pos_dt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' And exists(Select contr,ref From pos_hd s1 Where a.company=s1.company and a.contr = s1.contr and a.ref = s1.ref)) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, cmbkey, qty, price, barcode, dscprsnt, srlno, rtrnd, dsc_amt, offer_amt
	    , nqati_prcnt,scl_barcode,taxtype) 
	    values (s.company ,s.contr ,s.ref,s.cmbkey ,s.qty,s.price ,s.barcode ,s.dscprsnt ,s.srlno,s.rtrnd,
	            s.dsc_amt,s.offer_amt,s.nqati_prcnt,s.scl_barcode,s.taxtype);'
	
	

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-4
		return 
	end
		
	set @sqlmsg='merge POSRTNINV as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSRTNINV a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.rcontr,s.rref,s.Contr,s.ref,s.rtnamt);'

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end

	set @sqlmsg='merge POSPPCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSPPCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.disccard=s.disccard'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.disccard,s.paytype,s.prepaidamt,s.paycard,s.nodsc4promo,s.prepaidamt_rtn);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

	set @sqlmsg='merge POSCCCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSCCCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' and b.ccpaid>0) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.cccardno=s.cccardno and t.ccsrlno=s.ccsrlno'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.cccardno,s.ccsrlno,s.cardtype,s.ccpaid,
	    s.ccconus,s.chargepctg,s.chargeamt,s.cctype,s.approvl_no,s.TransDate,s.TransTime,s.TransNo,s.terminal_id);'
		
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

	set @sqlmsg='merge poschrtinv as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'poschrtinv a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.hllamt,s.chrcode);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end

	set @sqlmsg='merge posfcamt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'posfcamt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' and b.invcst>0) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.fcy,s.fcamt,s.fcyrate,s.lcamt,s.srlno);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-6
		return 
	end
	else commit transaction
	
	declare @new_cndn nvarchar(250),
	        @lpos int =0
	set @lpos=charindex('INVDATE',@whr_condn)
	set @new_cndn=substring(@whr_condn,@lpos,200)
	set @new_cndn=replace(replace(@new_cndn,'INVDATE','mnydate'),'smalldatetime','date')
	set @sqlmsg='merge pos_mny as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_mny  where '+@new_cndn+') as s'	
	+ ' on t.company=s.company and t.contr=s.contr and t.mnydate=s.mnydate and t.slpcode=s.slpcode'
    + ' when not matched then '
	+ ' insert (company,contr,mnydate,slpcode,oner,fiver,tenr,twntyr,fiftyr,hundredr,
                twohandr,fivehandr,modified,rtnval,network,prepaidamt,scrtnval,scnetwork,scprepaidamt,
				sccash,saned_amt,scsaned_amt)                
	    values (s.company,s.contr,s.mnydate,s.slpcode,s.oner,s.fiver,s.tenr,s.twntyr,s.fiftyr,s.hundredr,
                s.twohandr,s.fivehandr,s.modified,s.rtnval,s.network,s.prepaidamt'
	+ iif(@it_is_pos=0,',s.scrtnval ,s.scnetwork,s.scprepaidamt,s.sccash,s.saned_amt,s.scsaned_amt',',0,0,0,0,s.saned_amt,0')+');'
	
	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
	end
	else commit transaction
	--END TRY
	--BEGIN CATCH
	--		SET @STR_MSG ='ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +' rtncode='+@rtncode
			
	--		return @errstatus
	--END CATCH
end 






GO
/****** Object:  StoredProcedure [dbo].[Update_Pos_Auto5]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--شهار

CREATE PROCEDURE [dbo].[Update_Pos_Auto5]
 @whr_condn nvarchar(200) = 'invdate > convert(date,dateadd(day,-7,GETDATE()),112)' ,
 @brlinksrvr nvarchar(15) = 'BRLNKSRVR0105',
 @wth_slp_cntr bit = 0 ,
 @no_of_invoices int=0 output,
 @errstatus int = 0 output
	
AS
BEGIN
	declare @sqlmsg nvarchar(max)='',
	@dbc nvarchar(14) = '.dbc01y30.dbo.',
	@lcalcomp char(2) = '01',
	@yrcode char(4) = '2020',
	@syscode int =2,
	@lcauseslctr bit=0,
	@it_is_pos bit=0
---------------------------------------------------------------------------------------------
	--set @dbc=db_name()
	--set @lcalcomp=substring(@dbc,4,2)
	--set @yrcode=substring(@dbc,7,2)
	--SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
	
	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @syscode=sysno,@lcauseslctr=causeslctr  from sysdb.dbo.glcalend 
	where calcomp=@lcalcomp and yrcode=@yrcode
------------------------------------------------------------------------------------------------------------------------------

    set @errstatus=0
 --   if @syscode<>3  --set @dbc='.'+db_name()+'.dbo.'
	--else 
	--begin
------------------------------ Get Yrcode & Calcomp from Branch Boteequ  ----------------------------------------------
--		declare @dynsql nvarchar(300),
--				@params nvarchar(100)

--		set @yrcode=''
--		set @lcalcomp=''
--		set @dynsql='select top 1 @yrcd=yrcode,@lclcmp=calcomp  from '+@brlinksrvr+'.posysdb.dbo.glcalend'
--		+ ' order by yrcode desc';
--		set @params='@yrcd char(4) output,@lclcmp char(2) output';
--		exec sp_executesql @dynsql,@params,@yrcd=@yrcode output,@lclcmp=@lcalcomp output
--		if @@error<>0 or @@rowcount=0
--		begin
--		  	set @errstatus=-1
--			return 
--		end
--		if @yrcode<>'' and @lcalcomp<>'' set @dbc='.pos'+@lcalcomp+'y'+substring(@yrcode,3,2)+'.dbo.'
--		else
--		begin
--		  	set @errstatus=-2
--			return 		  
--		end
--		set @it_is_pos=1
--------------------------------------------------------------------------------------------------------------------------
--	end
    

  if @wth_slp_cntr=1
	begin
	    set @sqlmsg='merge pos_ctr as t '
		+ ' using '+@brlinksrvr+@dbc+'pos_ctr as s'
		+ ' on t.ctrcompany=s.ctrcompany and t.ctrcode=s.ctrcode'
		+ ' when matched then '
		+ ' update set t.ctrloc = s.ctrloc ,t.ctrstatus = s.ctrstatus ,t.ctrnote = s.ctrnote ,t.ctrcash = s.ctrcash'
        + ',t.ctrrpls = s.ctrrpls,t.ctrcard = s.ctrcard ,t.ctrsanet = s.ctrsanet,t.ctrsanetpctg = s.ctrsanetpctg'
        + ',t.ctrvisa = s.ctrvisa ,t.ctrvisapctg = s.ctrvisapctg ,t.ctrmaster = s.ctrmaster'
        + ',t.ctrmasterpctg = s.ctrmasterpctg,t.ctrothers = s.ctrothers ,t.ctrotherspctg = s.ctrotherspctg'
        + ',t.slcenter = s.slcenter ,t.invser = s.invser,t.drwrcomport = s.drwrcomport,t.spath = s.spath'
        + ',t.ctrserial = s.ctrserial,t.modified = s.modified,t.started = s.started ,t.ended = s.ended'
        + ',t.drawer = s.drawer,t.cdisplay = s.cdisplay ,t.slmsg = s.slmsg,t.rtnmsg = s.rtnmsg'
        + ',t.footmsg1 = s.footmsg1,t.footmsg2 = s.footmsg2,t.footmsg3 = s.footmsg3,t.saveinserver = s.saveinserver'
        + ',t.saveinvall = s.saveinvall,t.scr_open = s.scr_open,t.slnoprint = s.slnoprint,t.rtnoprint = s.rtnoprint'
        + ',t.ccconus = s.ccconus,t.upditem_hrs = s.upditem_hrs,t.updinv_hrs = s.updinv_hrs,t.prntbyclass = s.prntbyclass'
        + ',t.sltype = s.sltype,t.rttype = s.rttype,t.rptype = s.rptype,t.icrptype = s.icrptype'
        + ',t.ctrprpaid = s.ctrprpaid,t.rtfmothrs = s.rtfmothrs,t.magcard = s.magcard,t.usbdsply = s.usbdsply'
        + ',t.dsplycomport = s.dsplycomport,t.rpt_grp_items = s.rpt_grp_items,
		   t.ctrsaned=s.ctrsaned,t.ctrsndecrpos=s.ctrsndecrpos,t.ctreftpos=s.ctreftpos ,t.eftport=s.eftport'
		+ ' when not matched then '
		+ ' insert (ctrcompany,ctrcode,ctrloc,ctrstatus ,ctrnote ,ctrcash ,ctrrpls ,ctrcard,ctrsanet'
        + ',ctrsanetpctg,ctrvisa,ctrvisapctg ,ctrmaster,ctrmasterpctg,ctrothers,ctrotherspctg'
        + ',slcenter,invser ,drwrcomport,spath ,ctrserial,modified,started,ended,drawer'
        + ',cdisplay,slmsg,rtnmsg,footmsg1,footmsg2,footmsg3,saveinserver,saveinvall,scr_open'
        + ',slnoprint,rtnoprint,ccconus ,upditem_hrs,updinv_hrs,prntbyclass ,sltype ,rttype'
        + ',rptype ,icrptype,ctrprpaid ,rtfmothrs,magcard ,usbdsply,dsplycomport,rpt_grp_items,
		    ctrsaned,ctrsndecrpos,eftport,ctreftpos,ntk_printer1,ntk_printer2,grp_printers,grp_prnt_local,cshRtn_f_o_b)'
		+ ' values (s.ctrcompany,s.ctrcode,s.ctrloc,s.ctrstatus ,s.ctrnote ,s.ctrcash ,s.ctrrpls ,s.ctrcard,s.ctrsanet'
        + ',s.ctrsanetpctg,s.ctrvisa,s.ctrvisapctg ,s.ctrmaster,s.ctrmasterpctg,s.ctrothers,s.ctrotherspctg'
        + ',s.slcenter,s.invser ,s.drwrcomport,s.spath ,s.ctrserial,s.modified,s.started,s.ended,s.drawer'
        + ',s.cdisplay,s.slmsg,s.rtnmsg,s.footmsg1,s.footmsg2,s.footmsg3,s.saveinserver,s.saveinvall,s.scr_open'
        + ',s.slnoprint,s.rtnoprint,s.ccconus ,s.upditem_hrs,s.updinv_hrs,s.prntbyclass ,s.sltype ,s.rttype'
        + ',s.rptype ,s.icrptype,s.ctrprpaid ,s.rtfmothrs,s.magcard ,s.usbdsply,s.dsplycomport,s.rpt_grp_items,
		    s.ctrsaned,s.ctrsndecrpos,s.eftport,s.ctreftpos,s.ntk_printer1,s.ntk_printer2,s.grp_printers,s.grp_prnt_local,s.cshRtn_f_o_b);'
			
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-10
			return 
		end
		else commit transaction
-- t.slppassword=s.slppassword,  is rempved 08-06-2014
	    set @sqlmsg='merge pos_slp as t '
		+ ' using '+@brlinksrvr+@dbc+'pos_slp as s'
		+ ' on t.slpcompany=s.slpcompany and t.slpcode=s.slpcode'
		+ ' when matched then '
		+ ' update set t.slpname=s.slpname,t.slpaddress=s.slpaddress,t.slptel=s.slptel,'
		+ ' t.slpchgqty=s.slpchgqty,t.slpchgprice=s.slpchgprice'
        + ',t.slpdelline=s.slpdelline,t.slpothersinv=s.slpothersinv,t.slpreturn=s.slpreturn,t.slpstatus=s.slpstatus,'
		+ ' t.slpalowdisc=s.slpalowdisc,t.slpmaxdisc=s.slpmaxdisc,t.slppricetp=s.slppricetp'
        + ',t.slpalowcancel=s.slpalowcancel,t.slpalowopdr=s.slpalowopdr,t.modified=s.modified,t.slpalowexit=s.slpalowexit,'
		+ ' t.slprtwoinv=s.slprtwoinv,t.slpblowbal=s.slpblowbal,t.scr_open=s.scr_open'
        + ',t.alwitmdsc=s.alwitmdsc,t.maxitmdsc=s.maxitmdsc ,t.alwuserpls=s.alwuserpls ,t.alwuseicrpls=s.alwuseicrpls,'
		+ 't.slpmagnetic=s.slpmagnetic,t.alwusebrrtn=s.alwusebrrtn,t.alwreprint=s.alwreprint'
        + ',t.frcrplinv=s.frcrplinv,t.catch_thief=s.catch_thief,t.sold_once=s.sold_once,t.only_scan_bc=s.only_scan_bc,'
		+ 't.stop_item_column=s.stop_item_column,t.slpfpalw=s.slpfpalw,t.slpfpimage=s.slpfpimage'
        + ',t.slcenter=s.slcenter,t.salesquota=s.salesquota,t.commissionP=s.commissionP,t.bonus=s.bonus,
		    t.supervisor=s.supervisor,t.ReadInvByBarcd=s.ReadInvByBarcd,
			t.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,t.alwcshcardpay=s.alwcshcardpay,'
		+ 't.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,t.slp_hlldscamtMax=s.slp_hlldscamtMax,t.alwprnttmpinv=s.alwprnttmpinv,s.ignore_mnmprice=s.ignore_mnmprice'
		
		+ ' when not matched then '
		+ ' insert values (s.slpcompany,s.slpcode,s.slpname,s.slpaddress,s.slptel,s.slppassword,s.slpchgqty,s.slpchgprice'
        + ',s.slpdelline,s.slpothersinv,s.slpreturn,s.slpstatus,s.slpalowdisc,s.slpmaxdisc,s.slppricetp'
        + ',s.slpalowcancel,s.slpalowopdr,s.modified,s.slpalowexit,s.slprtwoinv,s.slpblowbal,s.scr_open'
        + ',s.alwitmdsc,s.maxitmdsc ,s.alwuserpls ,s.alwuseicrpls,s.slpmagnetic,s.alwusebrrtn,s.alwreprint'
        + ',s.frcrplinv,s.catch_thief,s.sold_once,s.only_scan_bc,s.stop_item_column,s.slpfpalw,s.slpfpimage'
        + ',s.slcenter,s.salesquota,s.commissionP,s.bonus,s.supervisor,s.ReadInvByBarcd,s.alwrtncash,
		   s.alwmtchrtn,s.alwinvtrnsfr,s.alwcshcardpay,s.alwrtncash,s.alwmtchrtn,s.alwinvtrnsfr,s.slp_hlldscamtMax,s.alwprnttmpinv,s.ignore_mnmprice);'
		   
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-11
			return 
		end
		else commit transaction
	end
------------------------------------------------------------------------------------------------------------------------
	set @sqlmsg='merge pos_hd as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_hd b where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, invdate, entries, slperson, paytype, chargepctg, chargeamt, invdspc, disccard, 
		cardtype, invttl, invcst, invdsvl, valafds, invpaid, pricetp, slcenter, invorrtrn, cashamt, modified, 
		salinvno, salctrno, tdatetime, cktype, geninv, rref, rcontr, ccpaid, ccconus, prepaidamt, fmbranch,
		mobile, fcamt, custtype, paycard, saned_amt,rtncshamt,dfvchramt,frc_rtncash,vat_amt_rcvd,taxfree_sales,hlldscnt,discamt,No_round_nm,PriceVatType,CashDsc4RtnPrepaid,outside_order,stcpay_amt,Qitaf_amt,whlslinv , vat_percent)'
	+ ' values (s.company,s.contr,s.ref,s.invdate,s.entries,s.slperson ,s.paytype,s.chargepctg,s.chargeamt'
    + ' ,s.invdspc ,s.disccard ,s.cardtype ,s.invttl,s.invcst,s.invdsvl,s.valafds ,s.invpaid,s.pricetp,s.slcenter'
    + ' ,s.invorrtrn ,s.cashamt,s.modified ,s.salinvno ,s.salctrno ,s.tdatetime ,s.cktype ,s.geninv ,s.rref'
    + ' ,s.rcontr ,s.ccpaid ,s.ccconus,s.prepaidamt ,s.fmbranch,s.mobile ,s.fcamt ,s.custtype ,s.paycard,s.saned_amt,
	     s.rtncshamt,s.dfvchramt,s.frc_rtncash,s.vat_amt_rcvd,s.taxfree_sales,s.hlldscnt,s.discamt,s.No_round_nm,s.PriceVatType,s.CashDsc4RtnPrepaid,s.outside_order,s.stcpay_amt,s.Qitaf_amt,s.whlslinv , s.vat_percent);'	
	
	begin transaction
	exec sp_executesql @sqlmsg
	set @no_of_invoices=@@ROWCOUNT
	if @@error<>0 or @no_of_invoices=0
	begin
		rollback transaction
		set @errstatus=-3
		if @no_of_invoices=0 set @errstatus=0
		return 
	end

--  Make sure that the field NQATI_PRCNT is available in pos_dt
	
    declare @is_nqati_there varchar(30)=''
    set @is_nqati_there=iif(EXISTS(SELECT name FROM sys.columns
    WHERE Name = N'nqati_prcnt' AND OBJECT_ID = OBJECT_ID(N'pos_dt')),',s.nqati_prcnt);',');')
	
	set @sqlmsg='merge pos_dt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'pos_dt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' And exists(Select contr,ref From pos_hd s1 Where a.company=s1.company and a.contr = s1.contr and a.ref = s1.ref)) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, cmbkey, qty, price, barcode, dscprsnt, srlno, rtrnd, dsc_amt, offer_amt
	    , nqati_prcnt,scl_barcode,taxtype) 
	    values (s.company ,s.contr ,s.ref,s.cmbkey ,s.qty,s.price ,s.barcode ,s.dscprsnt ,s.srlno,s.rtrnd,
	            s.dsc_amt,s.offer_amt,s.nqati_prcnt,s.scl_barcode,s.taxtype);'
	
	

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-4
		return 
	end
		
	set @sqlmsg='merge POSRTNINV as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSRTNINV a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.rcontr,s.rref,s.Contr,s.ref,s.rtnamt);'

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end

	set @sqlmsg='merge POSPPCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSPPCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.disccard=s.disccard'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.disccard,s.paytype,s.prepaidamt,s.paycard,s.nodsc4promo,s.prepaidamt_rtn);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

	set @sqlmsg='merge POSCCCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSCCCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' and b.ccpaid>0) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.cccardno=s.cccardno and t.ccsrlno=s.ccsrlno'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.cccardno,s.ccsrlno,s.cardtype,s.ccpaid,
	    s.ccconus,s.chargepctg,s.chargeamt,s.cctype,s.approvl_no,s.TransDate,s.TransTime,s.TransNo,s.terminal_id);'
		
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

	set @sqlmsg='merge poschrtinv as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'poschrtinv a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.hllamt,s.chrcode);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end

	set @sqlmsg='merge posfcamt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'posfcamt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' and b.invcst>0) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.fcy,s.fcamt,s.fcyrate,s.lcamt,s.srlno);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-6
		return 
	end
	else commit transaction
	
	declare @new_cndn nvarchar(250),
	        @lpos int =0
	set @lpos=charindex('INVDATE',@whr_condn)
	set @new_cndn=substring(@whr_condn,@lpos,200)
	set @new_cndn=replace(replace(@new_cndn,'INVDATE','mnydate'),'smalldatetime','date')
	set @sqlmsg='merge pos_mny as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_mny  where '+@new_cndn+') as s'	
	+ ' on t.company=s.company and t.contr=s.contr and t.mnydate=s.mnydate and t.slpcode=s.slpcode'
    + ' when not matched then '
	+ ' insert (company,contr,mnydate,slpcode,oner,fiver,tenr,twntyr,fiftyr,hundredr,
                twohandr,fivehandr,modified,rtnval,network,prepaidamt,scrtnval,scnetwork,scprepaidamt,
				sccash,saned_amt,scsaned_amt)                
	    values (s.company,s.contr,s.mnydate,s.slpcode,s.oner,s.fiver,s.tenr,s.twntyr,s.fiftyr,s.hundredr,
                s.twohandr,s.fivehandr,s.modified,s.rtnval,s.network,s.prepaidamt'
	+ iif(@it_is_pos=0,',s.scrtnval ,s.scnetwork,s.scprepaidamt,s.sccash,s.saned_amt,s.scsaned_amt',',0,0,0,0,s.saned_amt,0')+');'
	
	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
	end
	else commit transaction
	--END TRY
	--BEGIN CATCH
	--		SET @STR_MSG ='ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +' rtncode='+@rtncode
			
	--		return @errstatus
	--END CATCH
end 






GO
/****** Object:  StoredProcedure [dbo].[Update_Pos_Auto8]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--مكة

CREATE PROCEDURE [dbo].[Update_Pos_Auto8]
 @whr_condn nvarchar(200) = 'invdate > convert(date,dateadd(day,-7,GETDATE()),112)' ,
 @brlinksrvr nvarchar(15) = 'BRLNKSRVR0108',
 @wth_slp_cntr bit = 0 ,
 @no_of_invoices int=0 output,
 @errstatus int = 0 output
	
AS
BEGIN
	declare @sqlmsg nvarchar(max)='',
	@dbc nvarchar(14) = '.dbc01y30.dbo.',
	@lcalcomp char(2) = '01',
	@yrcode char(4) = '2020',
	@syscode int =2,
	@lcauseslctr bit=0,
	@it_is_pos bit=0
---------------------------------------------------------------------------------------------
	--set @dbc=db_name()
	--set @lcalcomp=substring(@dbc,4,2)
	--set @yrcode=substring(@dbc,7,2)
	--SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
	
	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @syscode=sysno,@lcauseslctr=causeslctr  from sysdb.dbo.glcalend 
	where calcomp=@lcalcomp and yrcode=@yrcode
------------------------------------------------------------------------------------------------------------------------------

    set @errstatus=0
 --   if @syscode<>3  --set @dbc='.'+db_name()+'.dbo.'
	--else 
	--begin
------------------------------ Get Yrcode & Calcomp from Branch Boteequ  ----------------------------------------------
--		declare @dynsql nvarchar(300),
--				@params nvarchar(100)

--		set @yrcode=''
--		set @lcalcomp=''
--		set @dynsql='select top 1 @yrcd=yrcode,@lclcmp=calcomp  from '+@brlinksrvr+'.posysdb.dbo.glcalend'
--		+ ' order by yrcode desc';
--		set @params='@yrcd char(4) output,@lclcmp char(2) output';
--		exec sp_executesql @dynsql,@params,@yrcd=@yrcode output,@lclcmp=@lcalcomp output
--		if @@error<>0 or @@rowcount=0
--		begin
--		  	set @errstatus=-1
--			return 
--		end
--		if @yrcode<>'' and @lcalcomp<>'' set @dbc='.pos'+@lcalcomp+'y'+substring(@yrcode,3,2)+'.dbo.'
--		else
--		begin
--		  	set @errstatus=-2
--			return 		  
--		end
--		set @it_is_pos=1
--------------------------------------------------------------------------------------------------------------------------
--	end
    

  if @wth_slp_cntr=1
	begin
	    set @sqlmsg='merge pos_ctr as t '
		+ ' using '+@brlinksrvr+@dbc+'pos_ctr as s'
		+ ' on t.ctrcompany=s.ctrcompany and t.ctrcode=s.ctrcode'
		+ ' when matched then '
		+ ' update set t.ctrloc = s.ctrloc ,t.ctrstatus = s.ctrstatus ,t.ctrnote = s.ctrnote ,t.ctrcash = s.ctrcash'
        + ',t.ctrrpls = s.ctrrpls,t.ctrcard = s.ctrcard ,t.ctrsanet = s.ctrsanet,t.ctrsanetpctg = s.ctrsanetpctg'
        + ',t.ctrvisa = s.ctrvisa ,t.ctrvisapctg = s.ctrvisapctg ,t.ctrmaster = s.ctrmaster'
        + ',t.ctrmasterpctg = s.ctrmasterpctg,t.ctrothers = s.ctrothers ,t.ctrotherspctg = s.ctrotherspctg'
        + ',t.slcenter = s.slcenter ,t.invser = s.invser,t.drwrcomport = s.drwrcomport,t.spath = s.spath'
        + ',t.ctrserial = s.ctrserial,t.modified = s.modified,t.started = s.started ,t.ended = s.ended'
        + ',t.drawer = s.drawer,t.cdisplay = s.cdisplay ,t.slmsg = s.slmsg,t.rtnmsg = s.rtnmsg'
        + ',t.footmsg1 = s.footmsg1,t.footmsg2 = s.footmsg2,t.footmsg3 = s.footmsg3,t.saveinserver = s.saveinserver'
        + ',t.saveinvall = s.saveinvall,t.scr_open = s.scr_open,t.slnoprint = s.slnoprint,t.rtnoprint = s.rtnoprint'
        + ',t.ccconus = s.ccconus,t.upditem_hrs = s.upditem_hrs,t.updinv_hrs = s.updinv_hrs,t.prntbyclass = s.prntbyclass'
        + ',t.sltype = s.sltype,t.rttype = s.rttype,t.rptype = s.rptype,t.icrptype = s.icrptype'
        + ',t.ctrprpaid = s.ctrprpaid,t.rtfmothrs = s.rtfmothrs,t.magcard = s.magcard,t.usbdsply = s.usbdsply'
        + ',t.dsplycomport = s.dsplycomport,t.rpt_grp_items = s.rpt_grp_items,
		   t.ctrsaned=s.ctrsaned,t.ctrsndecrpos=s.ctrsndecrpos,t.ctreftpos=s.ctreftpos ,t.eftport=s.eftport'
		+ ' when not matched then '
		+ ' insert (ctrcompany,ctrcode,ctrloc,ctrstatus ,ctrnote ,ctrcash ,ctrrpls ,ctrcard,ctrsanet'
        + ',ctrsanetpctg,ctrvisa,ctrvisapctg ,ctrmaster,ctrmasterpctg,ctrothers,ctrotherspctg'
        + ',slcenter,invser ,drwrcomport,spath ,ctrserial,modified,started,ended,drawer'
        + ',cdisplay,slmsg,rtnmsg,footmsg1,footmsg2,footmsg3,saveinserver,saveinvall,scr_open'
        + ',slnoprint,rtnoprint,ccconus ,upditem_hrs,updinv_hrs,prntbyclass ,sltype ,rttype'
        + ',rptype ,icrptype,ctrprpaid ,rtfmothrs,magcard ,usbdsply,dsplycomport,rpt_grp_items,
		    ctrsaned,ctrsndecrpos,eftport,ctreftpos,ntk_printer1,ntk_printer2,grp_printers,grp_prnt_local,cshRtn_f_o_b)'
		+ ' values (s.ctrcompany,s.ctrcode,s.ctrloc,s.ctrstatus ,s.ctrnote ,s.ctrcash ,s.ctrrpls ,s.ctrcard,s.ctrsanet'
        + ',s.ctrsanetpctg,s.ctrvisa,s.ctrvisapctg ,s.ctrmaster,s.ctrmasterpctg,s.ctrothers,s.ctrotherspctg'
        + ',s.slcenter,s.invser ,s.drwrcomport,s.spath ,s.ctrserial,s.modified,s.started,s.ended,s.drawer'
        + ',s.cdisplay,s.slmsg,s.rtnmsg,s.footmsg1,s.footmsg2,s.footmsg3,s.saveinserver,s.saveinvall,s.scr_open'
        + ',s.slnoprint,s.rtnoprint,s.ccconus ,s.upditem_hrs,s.updinv_hrs,s.prntbyclass ,s.sltype ,s.rttype'
        + ',s.rptype ,s.icrptype,s.ctrprpaid ,s.rtfmothrs,s.magcard ,s.usbdsply,s.dsplycomport,s.rpt_grp_items,
		    s.ctrsaned,s.ctrsndecrpos,s.eftport,s.ctreftpos,s.ntk_printer1,s.ntk_printer2,s.grp_printers,s.grp_prnt_local,s.cshRtn_f_o_b);'
			
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-10
			return 
		end
		else commit transaction
-- t.slppassword=s.slppassword,  is rempved 08-06-2014
	    set @sqlmsg='merge pos_slp as t '
		+ ' using '+@brlinksrvr+@dbc+'pos_slp as s'
		+ ' on t.slpcompany=s.slpcompany and t.slpcode=s.slpcode'
		+ ' when matched then '
		+ ' update set t.slpname=s.slpname,t.slpaddress=s.slpaddress,t.slptel=s.slptel,'
		+ ' t.slpchgqty=s.slpchgqty,t.slpchgprice=s.slpchgprice'
        + ',t.slpdelline=s.slpdelline,t.slpothersinv=s.slpothersinv,t.slpreturn=s.slpreturn,t.slpstatus=s.slpstatus,'
		+ ' t.slpalowdisc=s.slpalowdisc,t.slpmaxdisc=s.slpmaxdisc,t.slppricetp=s.slppricetp'
        + ',t.slpalowcancel=s.slpalowcancel,t.slpalowopdr=s.slpalowopdr,t.modified=s.modified,t.slpalowexit=s.slpalowexit,'
		+ ' t.slprtwoinv=s.slprtwoinv,t.slpblowbal=s.slpblowbal,t.scr_open=s.scr_open'
        + ',t.alwitmdsc=s.alwitmdsc,t.maxitmdsc=s.maxitmdsc ,t.alwuserpls=s.alwuserpls ,t.alwuseicrpls=s.alwuseicrpls,'
		+ 't.slpmagnetic=s.slpmagnetic,t.alwusebrrtn=s.alwusebrrtn,t.alwreprint=s.alwreprint'
        + ',t.frcrplinv=s.frcrplinv,t.catch_thief=s.catch_thief,t.sold_once=s.sold_once,t.only_scan_bc=s.only_scan_bc,'
		+ 't.stop_item_column=s.stop_item_column,t.slpfpalw=s.slpfpalw,t.slpfpimage=s.slpfpimage'
        + ',t.slcenter=s.slcenter,t.salesquota=s.salesquota,t.commissionP=s.commissionP,t.bonus=s.bonus,
		    t.supervisor=s.supervisor,t.ReadInvByBarcd=s.ReadInvByBarcd,
			t.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,t.alwcshcardpay=s.alwcshcardpay,'
		+ 't.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,t.slp_hlldscamtMax=s.slp_hlldscamtMax,t.alwprnttmpinv=s.alwprnttmpinv,s.ignore_mnmprice=s.ignore_mnmprice'
		
		+ ' when not matched then '
		+ ' insert values (s.slpcompany,s.slpcode,s.slpname,s.slpaddress,s.slptel,s.slppassword,s.slpchgqty,s.slpchgprice'
        + ',s.slpdelline,s.slpothersinv,s.slpreturn,s.slpstatus,s.slpalowdisc,s.slpmaxdisc,s.slppricetp'
        + ',s.slpalowcancel,s.slpalowopdr,s.modified,s.slpalowexit,s.slprtwoinv,s.slpblowbal,s.scr_open'
        + ',s.alwitmdsc,s.maxitmdsc ,s.alwuserpls ,s.alwuseicrpls,s.slpmagnetic,s.alwusebrrtn,s.alwreprint'
        + ',s.frcrplinv,s.catch_thief,s.sold_once,s.only_scan_bc,s.stop_item_column,s.slpfpalw,s.slpfpimage'
        + ',s.slcenter,s.salesquota,s.commissionP,s.bonus,s.supervisor,s.ReadInvByBarcd,s.alwrtncash,
		   s.alwmtchrtn,s.alwinvtrnsfr,s.alwcshcardpay,s.alwrtncash,s.alwmtchrtn,s.alwinvtrnsfr,s.slp_hlldscamtMax,s.alwprnttmpinv,s.ignore_mnmprice);'
		   
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-11
			return 
		end
		else commit transaction
	end
------------------------------------------------------------------------------------------------------------------------
	set @sqlmsg='merge pos_hd as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_hd b where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, invdate, entries, slperson, paytype, chargepctg, chargeamt, invdspc, disccard, 
		cardtype, invttl, invcst, invdsvl, valafds, invpaid, pricetp, slcenter, invorrtrn, cashamt, modified, 
		salinvno, salctrno, tdatetime, cktype, geninv, rref, rcontr, ccpaid, ccconus, prepaidamt, fmbranch,
		mobile, fcamt, custtype, paycard, saned_amt,rtncshamt,dfvchramt,frc_rtncash,vat_amt_rcvd,taxfree_sales,hlldscnt,discamt,No_round_nm,PriceVatType,CashDsc4RtnPrepaid,outside_order,stcpay_amt,Qitaf_amt,whlslinv , vat_percent)'
	+ ' values (s.company,s.contr,s.ref,s.invdate,s.entries,s.slperson ,s.paytype,s.chargepctg,s.chargeamt'
    + ' ,s.invdspc ,s.disccard ,s.cardtype ,s.invttl,s.invcst,s.invdsvl,s.valafds ,s.invpaid,s.pricetp,s.slcenter'
    + ' ,s.invorrtrn ,s.cashamt,s.modified ,s.salinvno ,s.salctrno ,s.tdatetime ,s.cktype ,s.geninv ,s.rref'
    + ' ,s.rcontr ,s.ccpaid ,s.ccconus,s.prepaidamt ,s.fmbranch,s.mobile ,s.fcamt ,s.custtype ,s.paycard,s.saned_amt,
	     s.rtncshamt,s.dfvchramt,s.frc_rtncash,s.vat_amt_rcvd,s.taxfree_sales,s.hlldscnt,s.discamt,s.No_round_nm,s.PriceVatType,s.CashDsc4RtnPrepaid,s.outside_order,s.stcpay_amt,s.Qitaf_amt,s.whlslinv , s.vat_percent);'	
	
	begin transaction
	exec sp_executesql @sqlmsg
	set @no_of_invoices=@@ROWCOUNT
	if @@error<>0 or @no_of_invoices=0
	begin
		rollback transaction
		set @errstatus=-3
		if @no_of_invoices=0 set @errstatus=0
		return 
	end

--  Make sure that the field NQATI_PRCNT is available in pos_dt
	
    declare @is_nqati_there varchar(30)=''
    set @is_nqati_there=iif(EXISTS(SELECT name FROM sys.columns
    WHERE Name = N'nqati_prcnt' AND OBJECT_ID = OBJECT_ID(N'pos_dt')),',s.nqati_prcnt);',');')
	
	set @sqlmsg='merge pos_dt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'pos_dt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' And exists(Select contr,ref From pos_hd s1 Where a.company=s1.company and a.contr = s1.contr and a.ref = s1.ref)) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, cmbkey, qty, price, barcode, dscprsnt, srlno, rtrnd, dsc_amt, offer_amt
	    , nqati_prcnt,scl_barcode,taxtype) 
	    values (s.company ,s.contr ,s.ref,s.cmbkey ,s.qty,s.price ,s.barcode ,s.dscprsnt ,s.srlno,s.rtrnd,
	            s.dsc_amt,s.offer_amt,s.nqati_prcnt,s.scl_barcode,s.taxtype);'
	
	

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-4
		return 
	end
		
	set @sqlmsg='merge POSRTNINV as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSRTNINV a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.rcontr,s.rref,s.Contr,s.ref,s.rtnamt);'

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end

	set @sqlmsg='merge POSPPCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSPPCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.disccard=s.disccard'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.disccard,s.paytype,s.prepaidamt,s.paycard,s.nodsc4promo,s.prepaidamt_rtn);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

	set @sqlmsg='merge POSCCCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSCCCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' and b.ccpaid>0) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.cccardno=s.cccardno and t.ccsrlno=s.ccsrlno'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.cccardno,s.ccsrlno,s.cardtype,s.ccpaid,
	    s.ccconus,s.chargepctg,s.chargeamt,s.cctype,s.approvl_no,s.TransDate,s.TransTime,s.TransNo,s.terminal_id);'
		
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

	set @sqlmsg='merge poschrtinv as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'poschrtinv a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.hllamt,s.chrcode);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end

	set @sqlmsg='merge posfcamt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'posfcamt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' and b.invcst>0) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.fcy,s.fcamt,s.fcyrate,s.lcamt,s.srlno);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-6
		return 
	end
	else commit transaction
	
	declare @new_cndn nvarchar(250),
	        @lpos int =0
	set @lpos=charindex('INVDATE',@whr_condn)
	set @new_cndn=substring(@whr_condn,@lpos,200)
	set @new_cndn=replace(replace(@new_cndn,'INVDATE','mnydate'),'smalldatetime','date')
	set @sqlmsg='merge pos_mny as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_mny  where '+@new_cndn+') as s'	
	+ ' on t.company=s.company and t.contr=s.contr and t.mnydate=s.mnydate and t.slpcode=s.slpcode'
    + ' when not matched then '
	+ ' insert (company,contr,mnydate,slpcode,oner,fiver,tenr,twntyr,fiftyr,hundredr,
                twohandr,fivehandr,modified,rtnval,network,prepaidamt,scrtnval,scnetwork,scprepaidamt,
				sccash,saned_amt,scsaned_amt)                
	    values (s.company,s.contr,s.mnydate,s.slpcode,s.oner,s.fiver,s.tenr,s.twntyr,s.fiftyr,s.hundredr,
                s.twohandr,s.fivehandr,s.modified,s.rtnval,s.network,s.prepaidamt'
	+ iif(@it_is_pos=0,',s.scrtnval ,s.scnetwork,s.scprepaidamt,s.sccash,s.saned_amt,s.scsaned_amt',',0,0,0,0,s.saned_amt,0')+');'
	
	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
	end
	else commit transaction
	--END TRY
	--BEGIN CATCH
	--		SET @STR_MSG ='ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +' rtncode='+@rtncode
			
	--		return @errstatus
	--END CATCH
end 






GO
/****** Object:  StoredProcedure [dbo].[Update_Pos_Auto9]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--الدمام

CREATE PROCEDURE [dbo].[Update_Pos_Auto9]
 @whr_condn nvarchar(200) = 'invdate > convert(date,dateadd(day,-7,GETDATE()),112)' ,
 @brlinksrvr nvarchar(15) = 'BRLNKSRVR0109',
 @wth_slp_cntr bit = 0 ,
 @no_of_invoices int=0 output,
 @errstatus int = 0 output
	
AS
BEGIN
	declare @sqlmsg nvarchar(max)='',
	@dbc nvarchar(14) = '.dbc01y30.dbo.',
	@lcalcomp char(2) = '01',
	@yrcode char(4) = '2020',
	@syscode int =2,
	@lcauseslctr bit=0,
	@it_is_pos bit=0
---------------------------------------------------------------------------------------------
	--set @dbc=db_name()
	--set @lcalcomp=substring(@dbc,4,2)
	--set @yrcode=substring(@dbc,7,2)
	--SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
	
	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @syscode=sysno,@lcauseslctr=causeslctr  from sysdb.dbo.glcalend 
	where calcomp=@lcalcomp and yrcode=@yrcode
------------------------------------------------------------------------------------------------------------------------------

    set @errstatus=0
 --   if @syscode<>3  --set @dbc='.'+db_name()+'.dbo.'
	--else 
	--begin
------------------------------ Get Yrcode & Calcomp from Branch Boteequ  ----------------------------------------------
--		declare @dynsql nvarchar(300),
--				@params nvarchar(100)

--		set @yrcode=''
--		set @lcalcomp=''
--		set @dynsql='select top 1 @yrcd=yrcode,@lclcmp=calcomp  from '+@brlinksrvr+'.posysdb.dbo.glcalend'
--		+ ' order by yrcode desc';
--		set @params='@yrcd char(4) output,@lclcmp char(2) output';
--		exec sp_executesql @dynsql,@params,@yrcd=@yrcode output,@lclcmp=@lcalcomp output
--		if @@error<>0 or @@rowcount=0
--		begin
--		  	set @errstatus=-1
--			return 
--		end
--		if @yrcode<>'' and @lcalcomp<>'' set @dbc='.pos'+@lcalcomp+'y'+substring(@yrcode,3,2)+'.dbo.'
--		else
--		begin
--		  	set @errstatus=-2
--			return 		  
--		end
--		set @it_is_pos=1
--------------------------------------------------------------------------------------------------------------------------
--	end
    

  if @wth_slp_cntr=1
	begin
	    set @sqlmsg='merge pos_ctr as t '
		+ ' using '+@brlinksrvr+@dbc+'pos_ctr as s'
		+ ' on t.ctrcompany=s.ctrcompany and t.ctrcode=s.ctrcode'
		+ ' when matched then '
		+ ' update set t.ctrloc = s.ctrloc ,t.ctrstatus = s.ctrstatus ,t.ctrnote = s.ctrnote ,t.ctrcash = s.ctrcash'
        + ',t.ctrrpls = s.ctrrpls,t.ctrcard = s.ctrcard ,t.ctrsanet = s.ctrsanet,t.ctrsanetpctg = s.ctrsanetpctg'
        + ',t.ctrvisa = s.ctrvisa ,t.ctrvisapctg = s.ctrvisapctg ,t.ctrmaster = s.ctrmaster'
        + ',t.ctrmasterpctg = s.ctrmasterpctg,t.ctrothers = s.ctrothers ,t.ctrotherspctg = s.ctrotherspctg'
        + ',t.slcenter = s.slcenter ,t.invser = s.invser,t.drwrcomport = s.drwrcomport,t.spath = s.spath'
        + ',t.ctrserial = s.ctrserial,t.modified = s.modified,t.started = s.started ,t.ended = s.ended'
        + ',t.drawer = s.drawer,t.cdisplay = s.cdisplay ,t.slmsg = s.slmsg,t.rtnmsg = s.rtnmsg'
        + ',t.footmsg1 = s.footmsg1,t.footmsg2 = s.footmsg2,t.footmsg3 = s.footmsg3,t.saveinserver = s.saveinserver'
        + ',t.saveinvall = s.saveinvall,t.scr_open = s.scr_open,t.slnoprint = s.slnoprint,t.rtnoprint = s.rtnoprint'
        + ',t.ccconus = s.ccconus,t.upditem_hrs = s.upditem_hrs,t.updinv_hrs = s.updinv_hrs,t.prntbyclass = s.prntbyclass'
        + ',t.sltype = s.sltype,t.rttype = s.rttype,t.rptype = s.rptype,t.icrptype = s.icrptype'
        + ',t.ctrprpaid = s.ctrprpaid,t.rtfmothrs = s.rtfmothrs,t.magcard = s.magcard,t.usbdsply = s.usbdsply'
        + ',t.dsplycomport = s.dsplycomport,t.rpt_grp_items = s.rpt_grp_items,
		   t.ctrsaned=s.ctrsaned,t.ctrsndecrpos=s.ctrsndecrpos,t.ctreftpos=s.ctreftpos ,t.eftport=s.eftport'
		+ ' when not matched then '
		+ ' insert (ctrcompany,ctrcode,ctrloc,ctrstatus ,ctrnote ,ctrcash ,ctrrpls ,ctrcard,ctrsanet'
        + ',ctrsanetpctg,ctrvisa,ctrvisapctg ,ctrmaster,ctrmasterpctg,ctrothers,ctrotherspctg'
        + ',slcenter,invser ,drwrcomport,spath ,ctrserial,modified,started,ended,drawer'
        + ',cdisplay,slmsg,rtnmsg,footmsg1,footmsg2,footmsg3,saveinserver,saveinvall,scr_open'
        + ',slnoprint,rtnoprint,ccconus ,upditem_hrs,updinv_hrs,prntbyclass ,sltype ,rttype'
        + ',rptype ,icrptype,ctrprpaid ,rtfmothrs,magcard ,usbdsply,dsplycomport,rpt_grp_items,
		    ctrsaned,ctrsndecrpos,eftport,ctreftpos,ntk_printer1,ntk_printer2,grp_printers,grp_prnt_local,cshRtn_f_o_b)'
		+ ' values (s.ctrcompany,s.ctrcode,s.ctrloc,s.ctrstatus ,s.ctrnote ,s.ctrcash ,s.ctrrpls ,s.ctrcard,s.ctrsanet'
        + ',s.ctrsanetpctg,s.ctrvisa,s.ctrvisapctg ,s.ctrmaster,s.ctrmasterpctg,s.ctrothers,s.ctrotherspctg'
        + ',s.slcenter,s.invser ,s.drwrcomport,s.spath ,s.ctrserial,s.modified,s.started,s.ended,s.drawer'
        + ',s.cdisplay,s.slmsg,s.rtnmsg,s.footmsg1,s.footmsg2,s.footmsg3,s.saveinserver,s.saveinvall,s.scr_open'
        + ',s.slnoprint,s.rtnoprint,s.ccconus ,s.upditem_hrs,s.updinv_hrs,s.prntbyclass ,s.sltype ,s.rttype'
        + ',s.rptype ,s.icrptype,s.ctrprpaid ,s.rtfmothrs,s.magcard ,s.usbdsply,s.dsplycomport,s.rpt_grp_items,
		    s.ctrsaned,s.ctrsndecrpos,s.eftport,s.ctreftpos,s.ntk_printer1,s.ntk_printer2,s.grp_printers,s.grp_prnt_local,s.cshRtn_f_o_b);'
			
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-10
			return 
		end
		else commit transaction
-- t.slppassword=s.slppassword,  is rempved 08-06-2014
	    set @sqlmsg='merge pos_slp as t '
		+ ' using '+@brlinksrvr+@dbc+'pos_slp as s'
		+ ' on t.slpcompany=s.slpcompany and t.slpcode=s.slpcode'
		+ ' when matched then '
		+ ' update set t.slpname=s.slpname,t.slpaddress=s.slpaddress,t.slptel=s.slptel,'
		+ ' t.slpchgqty=s.slpchgqty,t.slpchgprice=s.slpchgprice'
        + ',t.slpdelline=s.slpdelline,t.slpothersinv=s.slpothersinv,t.slpreturn=s.slpreturn,t.slpstatus=s.slpstatus,'
		+ ' t.slpalowdisc=s.slpalowdisc,t.slpmaxdisc=s.slpmaxdisc,t.slppricetp=s.slppricetp'
        + ',t.slpalowcancel=s.slpalowcancel,t.slpalowopdr=s.slpalowopdr,t.modified=s.modified,t.slpalowexit=s.slpalowexit,'
		+ ' t.slprtwoinv=s.slprtwoinv,t.slpblowbal=s.slpblowbal,t.scr_open=s.scr_open'
        + ',t.alwitmdsc=s.alwitmdsc,t.maxitmdsc=s.maxitmdsc ,t.alwuserpls=s.alwuserpls ,t.alwuseicrpls=s.alwuseicrpls,'
		+ 't.slpmagnetic=s.slpmagnetic,t.alwusebrrtn=s.alwusebrrtn,t.alwreprint=s.alwreprint'
        + ',t.frcrplinv=s.frcrplinv,t.catch_thief=s.catch_thief,t.sold_once=s.sold_once,t.only_scan_bc=s.only_scan_bc,'
		+ 't.stop_item_column=s.stop_item_column,t.slpfpalw=s.slpfpalw,t.slpfpimage=s.slpfpimage'
        + ',t.slcenter=s.slcenter,t.salesquota=s.salesquota,t.commissionP=s.commissionP,t.bonus=s.bonus,
		    t.supervisor=s.supervisor,t.ReadInvByBarcd=s.ReadInvByBarcd,
			t.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,t.alwcshcardpay=s.alwcshcardpay,'
		+ 't.alwrtncash=s.alwrtncash,t.alwmtchrtn=s.alwmtchrtn,t.alwinvtrnsfr=s.alwinvtrnsfr,t.slp_hlldscamtMax=s.slp_hlldscamtMax,t.alwprnttmpinv=s.alwprnttmpinv,s.ignore_mnmprice=s.ignore_mnmprice'
		
		+ ' when not matched then '
		+ ' insert values (s.slpcompany,s.slpcode,s.slpname,s.slpaddress,s.slptel,s.slppassword,s.slpchgqty,s.slpchgprice'
        + ',s.slpdelline,s.slpothersinv,s.slpreturn,s.slpstatus,s.slpalowdisc,s.slpmaxdisc,s.slppricetp'
        + ',s.slpalowcancel,s.slpalowopdr,s.modified,s.slpalowexit,s.slprtwoinv,s.slpblowbal,s.scr_open'
        + ',s.alwitmdsc,s.maxitmdsc ,s.alwuserpls ,s.alwuseicrpls,s.slpmagnetic,s.alwusebrrtn,s.alwreprint'
        + ',s.frcrplinv,s.catch_thief,s.sold_once,s.only_scan_bc,s.stop_item_column,s.slpfpalw,s.slpfpimage'
        + ',s.slcenter,s.salesquota,s.commissionP,s.bonus,s.supervisor,s.ReadInvByBarcd,s.alwrtncash,
		   s.alwmtchrtn,s.alwinvtrnsfr,s.alwcshcardpay,s.alwrtncash,s.alwmtchrtn,s.alwinvtrnsfr,s.slp_hlldscamtMax,s.alwprnttmpinv,s.ignore_mnmprice);'
		   
		begin transaction
		exec sp_executesql @sqlmsg
		if @@error<>0 
		begin
			rollback transaction
			set @errstatus=-11
			return 
		end
		else commit transaction
	end
------------------------------------------------------------------------------------------------------------------------
	set @sqlmsg='merge pos_hd as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_hd b where '+@whr_condn+') as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, invdate, entries, slperson, paytype, chargepctg, chargeamt, invdspc, disccard, 
		cardtype, invttl, invcst, invdsvl, valafds, invpaid, pricetp, slcenter, invorrtrn, cashamt, modified, 
		salinvno, salctrno, tdatetime, cktype, geninv, rref, rcontr, ccpaid, ccconus, prepaidamt, fmbranch,
		mobile, fcamt, custtype, paycard, saned_amt,rtncshamt,dfvchramt,frc_rtncash,vat_amt_rcvd,taxfree_sales,hlldscnt,discamt,No_round_nm,PriceVatType,CashDsc4RtnPrepaid,outside_order,stcpay_amt,Qitaf_amt,whlslinv , vat_percent)'
	+ ' values (s.company,s.contr,s.ref,s.invdate,s.entries,s.slperson ,s.paytype,s.chargepctg,s.chargeamt'
    + ' ,s.invdspc ,s.disccard ,s.cardtype ,s.invttl,s.invcst,s.invdsvl,s.valafds ,s.invpaid,s.pricetp,s.slcenter'
    + ' ,s.invorrtrn ,s.cashamt,s.modified ,s.salinvno ,s.salctrno ,s.tdatetime ,s.cktype ,s.geninv ,s.rref'
    + ' ,s.rcontr ,s.ccpaid ,s.ccconus,s.prepaidamt ,s.fmbranch,s.mobile ,s.fcamt ,s.custtype ,s.paycard,s.saned_amt,
	     s.rtncshamt,s.dfvchramt,s.frc_rtncash,s.vat_amt_rcvd,s.taxfree_sales,s.hlldscnt,s.discamt,s.No_round_nm,s.PriceVatType,s.CashDsc4RtnPrepaid,s.outside_order,s.stcpay_amt,s.Qitaf_amt,s.whlslinv , s.vat_percent);'	
	
	begin transaction
	exec sp_executesql @sqlmsg
	set @no_of_invoices=@@ROWCOUNT
	if @@error<>0 or @no_of_invoices=0
	begin
		rollback transaction
		set @errstatus=-3
		if @no_of_invoices=0 set @errstatus=0
		return 
	end

--  Make sure that the field NQATI_PRCNT is available in pos_dt
	
    declare @is_nqati_there varchar(30)=''
    set @is_nqati_there=iif(EXISTS(SELECT name FROM sys.columns
    WHERE Name = N'nqati_prcnt' AND OBJECT_ID = OBJECT_ID(N'pos_dt')),',s.nqati_prcnt);',');')
	
	set @sqlmsg='merge pos_dt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'pos_dt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' And exists(Select contr,ref From pos_hd s1 Where a.company=s1.company and a.contr = s1.contr and a.ref = s1.ref)) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert (company, contr, ref, cmbkey, qty, price, barcode, dscprsnt, srlno, rtrnd, dsc_amt, offer_amt
	    , nqati_prcnt,scl_barcode,taxtype) 
	    values (s.company ,s.contr ,s.ref,s.cmbkey ,s.qty,s.price ,s.barcode ,s.dscprsnt ,s.srlno,s.rtrnd,
	            s.dsc_amt,s.offer_amt,s.nqati_prcnt,s.scl_barcode,s.taxtype);'
	
	

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-4
		return 
	end
		
	set @sqlmsg='merge POSRTNINV as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSRTNINV a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.rcontr,s.rref,s.Contr,s.ref,s.rtnamt);'

	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end

	set @sqlmsg='merge POSPPCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSPPCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.disccard=s.disccard'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.disccard,s.paytype,s.prepaidamt,s.paycard,s.nodsc4promo,s.prepaidamt_rtn);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

	set @sqlmsg='merge POSCCCARD as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'POSCCCARD a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' and b.ccpaid>0) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.cccardno=s.cccardno and t.ccsrlno=s.ccsrlno'
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.cccardno,s.ccsrlno,s.cardtype,s.ccpaid,
	    s.ccconus,s.chargepctg,s.chargeamt,s.cctype,s.approvl_no,s.TransDate,s.TransTime,s.TransNo,s.terminal_id);'
		
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
		return 
	end

	set @sqlmsg='merge poschrtinv as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'poschrtinv a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' ) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.hllamt,s.chrcode);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-5
		return 
	end

	set @sqlmsg='merge posfcamt as t '
	+ ' using '
	+ ' (select a.* from '+@brlinksrvr+@dbc+'posfcamt a inner join '+@brlinksrvr+@dbc+'pos_hd b'
	+ ' on a.company=b.company and a.contr=b.contr and a.ref=b.ref'
	+ ' where '+@whr_condn+' and b.invcst>0) as s'
	+ ' on t.company=s.company and t.contr=s.contr and t.ref=s.ref and t.srlno=s.srlno '
	+ ' when not matched then '
	+ ' insert values (s.company,s.contr,s.ref,s.fcy,s.fcamt,s.fcyrate,s.lcamt,s.srlno);'
	
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-6
		return 
	end
	else commit transaction
	
	declare @new_cndn nvarchar(250),
	        @lpos int =0
	set @lpos=charindex('INVDATE',@whr_condn)
	set @new_cndn=substring(@whr_condn,@lpos,200)
	set @new_cndn=replace(replace(@new_cndn,'INVDATE','mnydate'),'smalldatetime','date')
	set @sqlmsg='merge pos_mny as t '
	+ ' using '
	+ ' (select * from '+@brlinksrvr+@dbc+'pos_mny  where '+@new_cndn+') as s'	
	+ ' on t.company=s.company and t.contr=s.contr and t.mnydate=s.mnydate and t.slpcode=s.slpcode'
    + ' when not matched then '
	+ ' insert (company,contr,mnydate,slpcode,oner,fiver,tenr,twntyr,fiftyr,hundredr,
                twohandr,fivehandr,modified,rtnval,network,prepaidamt,scrtnval,scnetwork,scprepaidamt,
				sccash,saned_amt,scsaned_amt)                
	    values (s.company,s.contr,s.mnydate,s.slpcode,s.oner,s.fiver,s.tenr,s.twntyr,s.fiftyr,s.hundredr,
                s.twohandr,s.fivehandr,s.modified,s.rtnval,s.network,s.prepaidamt'
	+ iif(@it_is_pos=0,',s.scrtnval ,s.scnetwork,s.scprepaidamt,s.sccash,s.saned_amt,s.scsaned_amt',',0,0,0,0,s.saned_amt,0')+');'
	
	begin transaction
	exec sp_executesql @sqlmsg
	if @@error<>0
	begin
		rollback transaction
		set @errstatus=-9
	end
	else commit transaction
	--END TRY
	--BEGIN CATCH
	--		SET @STR_MSG ='ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +' rtncode='+@rtncode
			
	--		return @errstatus
	--END CATCH
end 






GO
/****** Object:  StoredProcedure [dbo].[Update_pos_dsc_in_HO]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-10-10@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROC [dbo].[Update_pos_dsc_in_HO]
@STR_MSG VARCHAR(256) OUT,
@RET_ID INT OUT,
@pposppcard VARCHAR(max),
@ppos_dsc   varchar(max),
@prepaidamt_2_pay float,
@prepaidamt_sales float,
@pos_ppcard_cmp_lvl bit,
@prepaidamt_Of_cardtype5 bit,
@net_amt_deserve_points float,
@divprcnt float,
@divprcnt5_6 float,
@pprepaidamt float,
@comp_code char(2),
@next_id_card char(20) out

AS BEGIN 
    
	
    set lock_timeout 3000

    declare @l_card char(20),
	@m_name varchar(50),
	@m_addr varchar(30),
	@m_mobl varchar(21),
	@m_rmrk varchar(30),
	@m_chrc char(1),
	@flg_pp bit,
	@flg_pp2 bit,
	@flg_pp3 bit,
	@dbc varchar(20),
	@yrcode varchar(4),
	@b_vl float ,
	@lcardtype int,
	@ldscstatus int,
	@lexpdate char(8),
	@employee_cardtype3 int=0,
	@donot_update_now2 bit =0

	declare @ldisccard varchar(20),
		@lpaytype int,
		@lprepaidamt float,
		@lpaycard varchar(20)
    declare @dsccompany char(2), @ldsccard char(20),
	    @lcust_ttlsales numeric(12, 3), 
		@lttl_grantd numeric(12, 3),
		@lsales_grantd numeric(12, 3),
	    @lcardused bit ,
		@lmnth_target numeric(12, 3),
		@lvchr_used numeric(12, 3)

	DECLARE @handle INT,@handle2 INT

	set @employee_cardtype3=@RET_ID	
	set @donot_update_now2=IIF(@STR_MSG='TRUE',1,0)
	set @RET_ID=0
	SET @STR_MSG=''
	BEGIN TRY
		IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[#TPOSPPCARD]') AND type in (N'U'))
		DROP TABLE [dbo].[#TPOSPPCARD]
		IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[#tpos_dsc]') AND type in (N'U'))
		DROP TABLE [dbo].[#tpos_dsc]	
	--return -1
---- Process the posppcard table ----------------------------
	EXEC sp_xml_preparedocument @handle OUTPUT, @pposppcard
	select  disccard,paytype,prepaidamt,paycard
	into #TPOSPPCARD FROM OPENXML (@handle, 'VFPData/pos_ppcard', 2) WITH
	(disccard nvarchar(20),
	paytype int,
	prepaidamt float,
	paycard nvarchar(20))
	EXEC sp_xml_removedocument @handle;

---- Process the pos_dsc table ----------------------------
    
    EXEC sp_xml_preparedocument @handle2 OUTPUT, @ppos_dsc
	select  dsccompany,dsccard,cust_ttlsales,ttl_grantd,sales_grantd,cardused,mnth_target,vchr_used
	into #tpos_dsc FROM OPENXML (@handle2, 'VFPData/client_card', 2) WITH
	(dsccompany nchar(2),dsccard NVARCHAR(20),
	cust_ttlsales numeric(12,3),
	ttl_grantd numeric(12,3),
	sales_grantd numeric(12,3),
	cardused bit,
	mnth_target numeric(12,3),
	vchr_used numeric(12,3))
	EXEC sp_xml_removedocument @handle2;
-------------------------------  Check for the sequence if available ------------------------------------------
	if not exists(select name from sys.sequences where name='next_card_id') and @prepaidamt_2_pay>0
	begin
	    declare @max_card char(20),@max_card_int bigint,@sqlmsg nvarchar(300)
		select @max_card=max(dsccard) from pos_dsc where cardtype=5;
		set @max_card=isnull(@max_card,'')
		set @max_card_int=cast(@max_card as bigint)
	    if @max_card_int>9000000000 set @max_card_int=@max_card_int+2000
		else set @max_card_int=9000000000+2000
		set @sqlmsg='CREATE SEQUENCE [dbo].[next_card_id] 
					AS [bigint]
					START WITH '+ cast(@max_card_int as varchar(20))
		set @sqlmsg=@sqlmsg+' INCREMENT BY 1 
					MINVALUE '+cast(9000000000 as varchar(20))+
					' MAXVALUE 9223372036854775807	 CACHE '
		exec sp_executesql @sqlmsg
		if @@error<>0
		begin
		   set @RET_ID=-11
		   SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
		   return -11
		end
	end
---------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------
	DECLARE ppcard CURSOR LOCAL FAST_FORWARD FOR
	select * from #TPOSPPCARD;
	open ppcard; 
	Fetch Next From ppcard Into @ldisccard,@lpaytype,@lprepaidamt,@lpaycard;
	begin transaction
	WHILE dbo.FetchStatusOfCursorNamed('ppcard') = 0 
	begin
	    set @dsccompany=''
		set @lcust_ttlsales=0
		set @lttl_grantd=0
		set @lsales_grantd=0
		set @lcardused=0
		set @lmnth_target=0
		set @lvchr_used=0

	    set @l_card=iif(@lpaytype<>5,@ldisccard,@lpaycard)

		select @dsccompany=dsccompany,@lcust_ttlsales=cust_ttlsales,@lttl_grantd=ttl_grantd,@lsales_grantd=sales_grantd,@lcardused=cardused,
		@lmnth_target=mnth_target,@lvchr_used=vchr_used
		from #tpos_dsc where dsccard=@l_card;		 

		if @lpaytype=1
		begin
			if @prepaidamt_2_pay>0 and @pprepaidamt>0
			begin
				set @lttl_grantd=@lttl_grantd+@pprepaidamt
				if @prepaidamt_sales>0 set @lsales_grantd=@lsales_grantd+@prepaidamt_sales
			end
			if @pos_ppcard_cmp_lvl=1
				update pos_dsc set cust_ttlsales=@lcust_ttlsales,ttl_grantd=@lttl_grantd,sales_grantd=@lsales_grantd where dsccard=@l_card;
			else
				update pos_dsc set cust_ttlsales=@lcust_ttlsales,ttl_grantd=@lttl_grantd,sales_grantd=@lsales_grantd where dsccompany=@dsccompany
				and dsccard=@l_card;
			if @@error<>0
			begin
				rollback transaction
				if @prepaidamt_2_pay>0 and @pprepaidamt>0 SET @RET_ID = -1
				else SET @RET_ID = 1

				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
				goto jumplbl
			end			  		      
		end
		if @lpaytype=2
		begin
			if @pos_ppcard_cmp_lvl=1
				update pos_dsc set cardused=@lcardused  where dsccard=@l_card;
			else
				update pos_dsc set cardused=@lcardused  where  dsccompany=@dsccompany and dsccard=@l_card ; 
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -2
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
				goto jumplbl
			end						         
		end
		if @lpaytype=3 and @employee_cardtype3=1
		begin
			if @pos_ppcard_cmp_lvl=1
				update pos_dsc set cust_ttlsales=@lcust_ttlsales  where dsccard=@l_card;
			else
				update pos_dsc set cust_ttlsales=@lcust_ttlsales  where  dsccompany=@dsccompany and dsccard=@l_card;  
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = 3
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
				goto jumplbl
			end						         
		end
		if @lpaytype=4
		begin
			if @pos_ppcard_cmp_lvl=1
				update pos_dsc set mnth_target=@lmnth_target  where dsccard=@l_card;
			else
				update pos_dsc set mnth_target=@lmnth_target  where  dsccompany=@dsccompany and dsccard=@l_card;  
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -4
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
				goto jumplbl
			end		
		end
		if @lpaytype=5
		begin
			if @pos_ppcard_cmp_lvl=1
				update pos_dsc set vchr_used=@lvchr_used  where dsccard=@l_card;
			else
				update pos_dsc set vchr_used=@lvchr_used  where  dsccompany=@dsccompany and dsccard=@l_card ; 
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -5
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
				goto jumplbl
			end	
								         
		end
		if @lpaytype=6
		begin
			if @prepaidamt_2_pay>0 and @pprepaidamt>0
			begin
				set @lttl_grantd=@lttl_grantd+@pprepaidamt
				set @lsales_grantd=@lsales_grantd-@pprepaidamt
			end
			if @pos_ppcard_cmp_lvl=1
				update pos_dsc set cust_ttlsales=@lcust_ttlsales,ttl_grantd=@lttl_grantd,sales_grantd=@lsales_grantd where dsccard=@l_card;
			else
				update pos_dsc set cust_ttlsales=@lcust_ttlsales,ttl_grantd=@lttl_grantd,sales_grantd=@lsales_grantd where dsccompany=@comp_code
				and dsccard=@l_card;
			if @@error<>0
			begin
				rollback transaction
				if @prepaidamt_2_pay>0 and @pprepaidamt>0 SET @RET_ID = -6
				else SET @RET_ID = 6

				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
				goto jumplbl
			end			  		      
		end
		if @prepaidamt_2_pay>0 and @pprepaidamt>0 and @lpaytype in (1,6)
		begin
			if @pos_ppcard_cmp_lvl=1
				select @m_name=dscname,@m_addr=dscaddress,@m_mobl=dsctel,@m_rmrk=dscnote,@m_chrc=chrcode from pos_dsc where dsccard=@ldisccard;
			else
				select @m_name=dscname,@m_addr=dscaddress,@m_mobl=dsctel,@m_rmrk=dscnote,@m_chrc=chrcode from pos_dsc where dsccompany=@comp_code
				and dsccard=@ldisccard;
			set @dbc=db_name()
			set @yrcode=substring(@dbc,7,2)
			SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)
---------- To get a new ID card 			
			set @next_id_card=0
			while 1=1
			begin
				set @next_id_card =cast((next value for dbo.next_card_id) as varchar(20))
				if @pos_ppcard_cmp_lvl=1
				   select dsccompany from pos_dsc where dsccard=@next_id_card;
				else
				   select dsccompany from pos_dsc where dsccompany=@comp_code and dsccard=@next_id_card;
				if @@ROWCOUNT=0 break
		    end
-------------------------------------
			insert into pos_dsc ( dsccompany, dsccard, dscname, dscaddress, dsctel, dscprtg, dscstatus, dscnote, modified, mnth_target, mnthbal,
			                    trgt_prcnt, prepaidamt, cardtype, cardused, expdate, chrcode, cstpassw, crtdate, crtyear, cust_ttlsales, 
                                sales_grantd, ttl_grantd, vchr_value, vchr_used, mothercard, lastpaycard, nqati_openbal, nodsc4promo,
								employees_only, no_payment)
					values (@comp_code,@next_id_card,@m_name,@m_addr,@m_mobl,0,1,@m_rmrk,1,0,0,
						    0,0,5,1,convert(varchar(10),dateadd(d,120,getdate()),112),@m_chrc,'',convert(varchar(10),getdate(),112),@yrcode,0,
							0,0,@pprepaidamt,@pprepaidamt,@ldisccard,'',0,0,0,0);
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -7

				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
				goto jumplbl
			end	
			if @pos_ppcard_cmp_lvl=1
				update pos_dsc set lastpaycard=@next_id_card  where dsccard=@l_card;
			else
				update pos_dsc set lastpaycard=@next_id_card  where  dsccompany=@comp_code and dsccard=@l_card  ;
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -8
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
				goto jumplbl
			end									  		      
		end

		if @lpaytype=5
		if @net_amt_deserve_points>0 and @prepaidamt_Of_cardtype5>0 and len(@ldisccard)>0
		begin
			set @lcust_ttlsales=0
			set @lsales_grantd=0

		    set @b_vl=cast(@divprcnt*@lprepaidamt as int)
			if @pos_ppcard_cmp_lvl=1
			   select @lcust_ttlsales=cust_ttlsales,@lsales_grantd=sales_grantd,@lcardtype=cardtype,@ldscstatus=dscstatus,
			   @lexpdate=expdate from pos_dsc where  dsccard=@ldisccard;
			else
			   select @lcust_ttlsales=cust_ttlsales,@lsales_grantd=sales_grantd,@lcardtype=cardtype,@ldscstatus=dscstatus,
			   @lexpdate=expdate from pos_dsc where  dsccompany=@comp_code and dsccard=@ldisccard;
			if not (@ldscstatus>0 or (len(isnull(@lexpdate,''))>0 and convert(varchar(10),cast(getdate() as date),112)>=@lexpdate))
			begin
			     set @lcust_ttlsales=@lcust_ttlsales+@b_vl
				 if @lcardtype=6 
				 begin
				     set @b_vl=cast(@divprcnt5_6 *@lprepaidamt as int)
				     set @lsales_grantd=@lsales_grantd+@b_vl
			     end
				if @pos_ppcard_cmp_lvl=1
					update pos_dsc set cust_ttlsales=@lcust_ttlsales,sales_grantd=@lsales_grantd where dsccard=@ldisccard;
				else
					update pos_dsc set cust_ttlsales=@lcust_ttlsales,sales_grantd=@lsales_grantd where dsccompany=@comp_code
					and dsccard=@ldisccard;
				if @@error<>0
				begin
					rollback transaction
					SET @RET_ID = -9

					SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
					goto jumplbl
				end			  		      
			end
		end
		Fetch Next From ppcard Into @ldisccard,@lpaytype,@lprepaidamt,@lpaycard
	end -- loop while end
	jumplbl:
	CLOSE ppcard 
	DEALLOCATE ppcard

	if @RET_ID=0 commit transaction
	else if @@TRANCOUNT>0 ROLLBACK TRANSACTION 
	END TRY
	BEGIN CATCH
			if @@TRANCOUNT>0 ROLLBACK TRANSACTION
			SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
			if @donot_update_now2=1	SET @RET_ID = -99
			  else set @RET_ID = 99
			--IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'#TEMPSLINV_PDA'))
			--DROP TABLE [#TEMPSLINV_PDA]
			--insert into TMP(FLD)values(@STR_MSG)
			RETURN @RET_ID
	END CATCH
end



GO
/****** Object:  StoredProcedure [dbo].[update_PVT_no_round_nm]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[update_PVT_no_round_nm]
 @errcode int output 	
AS
BEGIN

	SET NOCOUNT ON
	set @errcode=0;	
	declare @p_supermarket bit,
	@dbc nvarchar(14),
	@lcalcomp char(2),
	@yrcode char(4),
	@lno_round_nm BIT =0,
	@lpricevattype numeric(1,0)=1,
	@lmkt_frc_rounding bit =0,
	@lis_dsc_amt bit =0,
	@syscode int =0,
	@lSysNo_PVT_level int=0


	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>25,'14','20')+rtrim(@yrcode)

	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
----------------------------------------   Modified on 2017-01-25 
	select @lno_round_nm=isnull(no_round_nm,0),@lis_dsc_amt=isnull(is_dsc_amt,0),
	@syscode=sysno,@lpricevattype=pricevattype,@lmkt_frc_rounding=isnull(mkt_frc_rounding,0),
	@lSysNo_PVT_level=isnull(SysNo_PVT_level,0)
	from sysdb.dbo.glcalend 
	where calcomp=@lcalcomp and yrcode=@yrcode

	if @lSysNo_PVT_level=0
	begin
		set @lpricevattype=isnull(@lpricevattype,1)
		set @lpricevattype=iif(@lpricevattype=0,1,@lpricevattype)
		set @p_supermarket = 0
		if @syscode in (1,4,5,8,9) or @syscode=6
		set @p_supermarket = 1
---  handle the sales_hd table 
		begin transaction
		update sales_hd set sysno=@syscode,pricevattype=l_Pvt, 
		no_round_nm=iif(@p_supermarket = 1 or c.invtype in ('04','24'),
		iif(cast(ttl_no_round as numeric(20,5))=cast(c.valafds as numeric(20,5)),1,
		iif(cast(ttl_round as numeric(20,5))=cast(c.valafds as numeric(20,5)),0,1)),
		iif(cast(ttl_round as numeric(20,5))=cast(c.valafds as numeric(20,5)),0,
		iif(cast(ttl_no_round as numeric(20,5))=cast(c.valafds as numeric(20,5)),1,0)))
		from sales_hd c
		join
		(
		select b.company,b.invtype,b.ref,a.valafds,l_Pvt=iif(cast(invttl-extamt as numeric(20,5))>cast(valafds as numeric(20,5)),1,
		iif(cast(taxfree_sales+invdsvl as numeric(20,5))=cast(valafds  as numeric(20,5)),@lpricevattype,iif(@lpricevattype in (2,3),@lpricevattype,2))),
		ttl_no_round=sum((b.QTY*(b.price-(b.price*b.discpc/100)))-b.imfcval) ,
		ttl_round=sum((b.QTY*(b.price-Floor(b.price*b.discpc/100)))-b.imfcval),
		ttl_itm_dsc=sum(discpc)
		from sales_hd a inner join sales_dt b
		on a.company=b.company and a.invtype=b.invtype and a.ref=b.ref
		where (a.PriceVatType is null or a.PriceVatType=0 or a.no_round_nm is null or a.sysno is null or a.taxfree_sales>0)
		group by b.company,b.invtype,b.ref,a.valafds,invttl,extamt,taxfree_sales,invdsvl) d
		on c.company=d.company and c.invtype=d.invtype and c.ref=d.ref
		if @@error<>0
		begin
			rollback transaction
			set @errcode=-1
		end
		else
		begin
		    commit transaction
---  Fill the sales_dt taxtype column 
			begin transaction
			update sales_dt set taxtype=l_taxtype
			from sales_dt a
			join
			(select c.company,invtype,ref,folio,c.itemno,l_taxtype=iif(isnull(d.taxtype,'')='' or 
			len(d.taxtype)=0 or d.taxtype='0','1',d.taxtype) from stitems d inner join sales_dt c
			on d.itemno=c.itemno
			where c.taxtype is null or len(c.taxtype)=0 or c.taxtype='0') b
			on a.company=b.company and a.invtype=b.invtype and a.ref=b.ref and a.folio=b.folio and
			a.itemno=b.itemno 
			if @@error<>0
			begin
				rollback transaction
				set @errcode=-2
			end
			else
		    begin
				 commit transaction

	---  Fill the Pudtl taxtype column 
				begin transaction
				update Pudtl set taxtype=l_taxtype
				from Pudtl a
				join
				(select c.company,invtype,ref,folio,c.itemno,l_taxtype=iif(isnull(d.taxtype,'')='' or 
				len(d.taxtype)=0 or d.taxtype='0','1',d.taxtype) from stitems d inner join Pudtl c
				on d.itemno=c.itemno
				where c.taxtype is null or len(c.taxtype)=0 or c.taxtype='0') b
				on a.company=b.company and a.invtype=b.invtype and a.ref=b.ref and a.folio=b.folio and
			    a.itemno=b.itemno 
				if @@error<>0
				begin
					rollback transaction
					set @errcode=-3
				end
				else
				begin
				    commit transaction
-------------------------------------------------------------------------------------------
----------------------  handle the Pos_hd & Pos_dt tables
					if @syscode in (2,3,6)
					begin
						set @p_supermarket = 0
						if  @syscode=6
						set @p_supermarket = 1
				---  handle the Pos_hd table 
						begin transaction
						update pos_hd set discamt=iif(dsc_amt_col>0,1,0),pricevattype=l_Pvt, 
						no_round_nm=iif(@p_supermarket = 1 or dsc_amt_col>0,
						iif(cast(ttl_no_round as numeric(20,5))=cast(c.valafds as numeric(20,5)),1,
						iif(cast(ttl_round as numeric(20,5))=cast(c.valafds as numeric(20,5)),0,1)),
						iif(cast(ttl_round as numeric(20,5))=cast(c.valafds as numeric(20,5)),0,
						iif(cast(ttl_no_round as numeric(20,5))=cast(c.valafds as numeric(20,5)),1,0)))
						from pos_hd c
						join
						(
						select b.company,b.contr,b.ref,a.valafds,l_Pvt=iif(cast(invttl+invdsvl-vat_amt_rcvd-iif(ccconus=1,0,chargeamt)
						 as numeric(20,5))
						=cast(valafds as numeric(20,5)),1,
						iif(cast(taxfree_sales+invdsvl as numeric(20,5))=cast(valafds  as numeric(20,5)),@lpricevattype,
						iif(@lpricevattype in (2,3),@lpricevattype,2))),
						ttl_no_round=sum((b.QTY*(b.price-(b.price*b.dscprsnt/100)))-isnull(offer_amt,0)) ,
						ttl_round=sum((b.QTY*(b.price-Floor(b.price*b.dscprsnt/100)))-isnull(offer_amt,0)),
						dsc_amt_col=sum(dsc_amt)
						from pos_hd a inner join pos_dt b
						on a.company=b.company and a.contr=b.contr and a.ref=b.ref
						where (a.PriceVatType is null or a.PriceVatType=0 or a.no_round_nm is null or a.discamt is null or a.taxfree_sales>0)
						group by b.company,b.contr,b.ref,a.valafds,invttl,invdsvl,vat_amt_rcvd,taxfree_sales,chargeamt,ccconus) d
						on c.company=d.company and c.contr=d.contr and c.ref=d.ref
						if @@error<>0
						begin
							rollback transaction
							set @errcode=-4
						end
						else
						begin
							commit transaction
				---  Fill the pos_dt taxtype column 
							begin transaction
							update pos_dt set taxtype=l_taxtype
							from pos_dt a
							join
							(select c.company,c.contr,c.ref,c.srlno,c.cmbkey,l_taxtype=iif(isnull(e.taxtype,'')='' or
							 len(e.taxtype)=0 or e.taxtype='0','1',e.taxtype) from pos_dt c
							 inner join stunits d inner join  stitems e
							on d.itemno=e.itemno
							on c.cmbkey=d.cmbkey 
							where c.taxtype is null or len(c.taxtype)=0 or c.taxtype='0') b
							on a.company=b.company and a.contr=b.contr and a.ref=b.ref and a.srlno=b.srlno and a.cmbkey=b.cmbkey 
							if @@error<>0
							begin
								rollback transaction
								set @errcode=-5
							end
							else commit transaction
						end
					end
-------------------------------------------------------------------------------------------
                    if @errcode=0
					begin
						begin transaction
						update sysdb.dbo.glcalend set SysNo_PVT_level=1 where calcomp=@lcalcomp and yrcode=@yrcode
						if @@error<>0
						begin
							rollback transaction
							set @errcode=-7
						end
						else commit transaction
					end
				end
           end
		end
	end
end













GO
/****** Object:  StoredProcedure [dbo].[update_qty_offer_limit]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-04-05@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[update_qty_offer_limit]
 @l_company char(2),
 @l_contr int,
 @l_ref int,
 @errstatus int  output,
 @l_slcenter char(2),  -- added on 2019-01-22 
 @l_vat_percent numeric(8,3)
AS
BEGIN
---- Added on 2024-04-04 AA must make substraction instead of addition. Fixed
---- Added on 2024-04-04 AA ambugus givenamt. Fixed
---- Added on 2024-02-25 AA to fit the new modification of the new offers
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	begin transaction;

	update stoffers set qty_offer_sold=qty_offer_sold-isnull(lnewqty,0)
	from stoffers t
	join (
	select a.company,b.slcenter,b.offer_no,a.barcode,lnewqty=sum((offer_amt/iif(@l_vat_percent>1 and taxtype<='1',b.GivenAmt*@l_vat_percent,b.GivenAmt)*iif(c.invorrtrn='1',1,-1))) 
	from (pos_hd c (NOLOCK) inner join posinvoffer z on c.company=z.company and c.contr=z.contr and c.ref=z.ref
	inner join pos_dt a (NOLOCK) on z.company=a.company and z.contr=a.contr and z.ref=a.ref and z.srlno=a.srlno)
	inner join stoffers b (NOLOCK) on a.company=b.company and iif(len(@l_slcenter)>0,c.slcenter,@l_slcenter)=b.slcenter 
	and z.offer_no=b.offer_no and a.barcode=b.barcode
	inner join stoffers_main d (NOLOCK) on b.company=d.company and b.slcenter=d.slcenter and b.offer_no=d.offer_no
	where c.company=@l_company and c.contr=@l_contr and c.ref=@l_ref and (b.slcenter=@l_slcenter or len(b.slcenter)=0) and 
	a.offer_amt>0 and b.disctype=3 and b.GivenAmt>0
	and invorrtrn<>'4'
	group by a.company,b.slcenter,b.offer_no,a.barcode) s
	on t.company=s.company and t.slcenter=s.slcenter and t.offer_no=s.offer_no and t.barcode=s.barcode;
--- (b.slcenter=@l_slcenter or len(b.slcenter)=0)	
	if @@error<>0
	begin
		rollback transaction	
		set @errstatus=-2
		return @errstatus
	end

	commit transaction

	return @errstatus
end


GO
/****** Object:  StoredProcedure [dbo].[Update_rtn_pos_dsc_in_HO]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[Update_rtn_pos_dsc_in_HO]
@STR_MSG VARCHAR(256) OUT,
@RET_ID INT OUT,
@ppos_dsc   varchar(max),
@pos_ppcard_cmp_lvl bit

AS BEGIN 
    
    set lock_timeout 3000

    declare @l_card char(20),
	@b_vl float 

    declare @dsccompany char(2), @ldsccard char(20),
	    @lcust_ttlsales numeric(12, 3), 
		@lsales_grantd numeric(12, 3),
		@lttl_grantd numeric(12, 3)

	DECLARE @handle INT

	set @RET_ID=0
	SET @STR_MSG=''
	BEGIN TRY
		IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[#rpos_dsc]') AND type in (N'U'))
		DROP TABLE [dbo].[#rpos_dsc]	

---- Process the pos_dsc table ----------------------------
    
		EXEC sp_xml_preparedocument @handle OUTPUT, @ppos_dsc
		select  dsccompany,dsccard,cust_ttlsales,sales_grantd,ttl_grantd
		into #rpos_dsc FROM OPENXML (@handle, 'VFPData/client_card', 2) WITH
		(dsccompany nchar(2),dsccard NVARCHAR(20),
		cust_ttlsales numeric(12,3),
		sales_grantd numeric(12,3),
		ttl_grantd numeric(12,3))

		EXEC sp_xml_removedocument @handle

---------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------
		DECLARE ppcard CURSOR LOCAL FAST_FORWARD FOR
		select * from #rpos_dsc
		open ppcard 
		Fetch Next From ppcard Into @dsccompany,@ldsccard,@lcust_ttlsales,@lsales_grantd,@lttl_grantd
		begin transaction
		WHILE dbo.FetchStatusOfCursorNamed('ppcard') = 0 
		begin
			set @l_card=@ldsccard	 
			if @pos_ppcard_cmp_lvl=1
				update pos_dsc set cust_ttlsales=@lcust_ttlsales,sales_grantd=@lsales_grantd,ttl_grantd=@lttl_grantd where dsccard=@l_card
			else
				update pos_dsc set cust_ttlsales=@lcust_ttlsales,sales_grantd=@lsales_grantd,ttl_grantd=@lttl_grantd where dsccompany=@dsccompany
				and dsccard=@l_card
			if @@error<>0
			begin
				rollback transaction
				SET @RET_ID = -1
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
				goto jumplbl
			end			  
			Fetch Next From ppcard Into @dsccompany,@ldsccard,@lcust_ttlsales,@lsales_grantd,@lttl_grantd
		end -- loop while end
		jumplbl:
		CLOSE ppcard 
		DEALLOCATE ppcard

		if @RET_ID=0 commit transaction
		else  ROLLBACK TRANSACTION 
	END TRY
	BEGIN CATCH
			if @@TRANCOUNT>0 ROLLBACK TRANSACTION
			SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () +', ERROR_LINE= '+cast(ERROR_LINE() as varchar(20))  
	        SET @RET_ID = -99
			--IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'#TEMPSLINV_PDA'))
			--DROP TABLE [#TEMPSLINV_PDA]
			--insert into TMP(FLD)values(@STR_MSG)
			RETURN @RET_ID
	END CATCH
end





GO
/****** Object:  StoredProcedure [dbo].[update_rtncshamt]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[update_rtncshamt]
@lcompany char(2),
@rplcntr int,
@rplref int,
@alwamtrtn numeric(12,2) ,
@status int=0 output

AS
BEGIN
SET NOCOUNT ON
 
------  Inialize vars
		set @status=0
		update pos_hd set rtncshamt=isnull(rtncshamt,0.00)+@alwamtrtn where company=@lcompany 
			  and contr=@rplcntr and ref=@rplref
 		if @@error<>0
		begin
			set @status=-1
			return @status
		end        

     --return @status
END











GO
/****** Object:  StoredProcedure [dbo].[update_sales_ei_table]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2022-06-06@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[update_sales_ei_table]
 @errstatus int =0 output
as
begin
	SET NOCOUNT ON
	DECLARE @ConstraintName nvarchar(200),@lcommand nvarchar(200),
	@table_action int =0
----- @table_action = 1 table not exists  2= Table is droped  3= Table is up to date
	set @errstatus=0
	if exists(SELECT table_name  FROM INFORMATION_SCHEMA.tables  with (NOLOCK) WHERE TABLE_NAME ='sales_ei')
	begin
----- Get red of the old table structure --------------------------
		SELECT @ConstraintName=name FROM sys.foreign_keys
		WHERE OBJECT_NAME(parent_object_id) IN ('sales_ei');

		IF @ConstraintName IS NOT NULL
		begin
			set @lcommand='ALTER TABLE [dbo].[sales_ei] drop  CONSTRAINT '+@ConstraintName
			exec sp_executesql @lcommand;
			if @@error<>0
			begin
				 set @errstatus=1	
				 return @errstatus
			end
		  DROP TABLE [dbo].[sales_ei]  
			if @@error<>0
			begin
				 set @errstatus=2	
				 return @errstatus
			end
			set @table_action=2 --Table is droped
		end
		else set @table_action=3  --Table is up to date
	end
	else set @table_action=1 --table not exists
  set @errstatus=@table_action
end



GO
/****** Object:  StoredProcedure [dbo].[update_sales_hd_no_round_nm]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[update_sales_hd_no_round_nm]
 @errcode int output 	
AS
BEGIN

	SET NOCOUNT ON
	set @errcode=0;	
	declare @p_supermarket bit,
	@dbc nvarchar(14),
	@lcalcomp char(2),
	@yrcode char(4),
	@lno_round_nm BIT =0,
	@lpricevattype numeric(1,0)=1,
	@lmkt_frc_rounding bit =0,
	@lis_dsc_amt bit =0,
	@syscode int =0,
	@lSysNo_PVT_level int=0


	set @dbc=db_name()
	set @lcalcomp=substring(@dbc,4,2)
	set @yrcode=substring(@dbc,7,2)
	SET @yrcode=iif(cast(@yrcode as int)>25,'14','20')+rtrim(@yrcode)

	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
----------------------------------------   Modified on 2017-01-25 
	select @lno_round_nm=isnull(no_round_nm,0),@lis_dsc_amt=isnull(is_dsc_amt,0),
	@syscode=sysno,@lpricevattype=pricevattype,@lmkt_frc_rounding=isnull(mkt_frc_rounding,0),
	@lSysNo_PVT_level=isnull(SysNo_PVT_level,0)
	from sysdb.dbo.glcalend 
	where calcomp=@lcalcomp and yrcode=@yrcode

	if @lSysNo_PVT_level=0
	begin
		set @lpricevattype=isnull(@lpricevattype,1)
		set @lpricevattype=iif(@lpricevattype=0,1,@lpricevattype)
		set @p_supermarket = 0
		if @syscode in (1,4,5,8,9) or @syscode=6
		set @p_supermarket = 1
---  handle the sales_hd table 
		begin transaction
		update sales_hd set sysno=@syscode,pricevattype=l_Pvt, 
		no_round_nm=iif(@p_supermarket = 1 or c.invtype in ('04','24'),iif(ttl_no_round=cast(c.valafds as numeric(20,5)),1,0),
		iif(ttl_round=cast(c.valafds as numeric(20,5)),0,1))
		from sales_hd c
		join
		(
		select b.company,b.invtype,b.ref,a.valafds,l_Pvt=iif(invttl-extamt>valafds,1,iif(@lpricevattype in (2,3),@lpricevattype,2)),
		ttl_no_round=sum((b.QTY*(b.price-(b.price*b.discpc/100)))-b.imfcval) ,
		ttl_round=sum((b.QTY*(b.price-Floor(b.price*b.discpc/100)))-b.imfcval),
		ttl_itm_dsc=sum(discpc)
		from sales_hd a inner join sales_dt b
		on a.company=b.company and a.invtype=b.invtype and a.ref=b.ref
		group by b.company,b.invtype,b.ref,a.valafds,invttl,extamt) d
		on c.company=d.company and c.invtype=d.invtype and c.ref=d.ref
		if @@error<>0
		begin
			rollback transaction
			set @errcode=-1
		end
		else
		begin
		    commit transaction
---  Fill the sales_dt taxtype column 
			begin transaction
			update sales_dt set taxtype=l_taxtype
			from sales_dt a
			join
			(select itemno,l_taxtype=iif(isnull(taxtype,'')='' or len(taxtype)=0 or taxtype='0','1',taxtype) from stitems) b
			on a.itemno=b.itemno 
			if @@error<>0
			begin
				rollback transaction
				set @errcode=-2
			end
			else
		    begin
				 commit transaction

	---  Fill the Pudtl taxtype column 
				begin transaction
				update Pudtl set taxtype=l_taxtype
				from Pudtl a
				join
				(select itemno,l_taxtype=iif(isnull(taxtype,'')='' or len(taxtype)=0  or taxtype='0','1',taxtype) from stitems) b
				on a.itemno=b.itemno 
				if @@error<>0
				begin
					rollback transaction
					set @errcode=-3
				end
				else
				begin
				    commit transaction
					begin transaction
					update sysdb.dbo.glcalend set SysNo_PVT_level=1 where calcomp=@lcalcomp and yrcode=@yrcode
					if @@error<>0
					begin
						rollback transaction
						set @errcode=-4
					end
					else commit transaction
				end
           end
		end
	end
end













GO
/****** Object:  StoredProcedure [dbo].[update_slpu_unused_inv]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2023-01-12@@$$##  Important : must have this line as first line which contains the last update date for the this file 
CREATE PROCEDURE [dbo].[update_slpu_unused_inv]
 @pcompany char(2),
 @pinvtype char(2),
 @pref int output,   -- when >0 write ref   = 0 get ref
 @psc_code char(6),
 @pusrid varchar(10),
 @preasons numeric(1,0),   
 @errstatus int output -- Used as input  0 = serial from section not used  1 = serial from section is used
	
AS
BEGIN
---- 2023-01-12 AA Added new column name lastupdate to record when the transaction is used 
---- Removed on 2022-12-08 AA usrid=@pusrid and from two places 
---- Stopped on 2022-06-12 AA if @lis_used=1 --and @lis_used=@pusrid
	SET NOCOUNT ON
-- 
-- This section is used to addup new entries for stbins
--
declare 
        @ltype char(2),
        @lref numeric(6,0),
		@lis_used bit,
		@ldate smalldatetime,
		@lbranch char(2),
		@lsc_code char(6),
		@luse_section_serial bit,
		@lwrite_mode bit,
		@tmpref int,
		@new_inv_found bit

--
--  
--
       set @luse_section_serial=@errstatus
	   set @lwrite_mode=iif(@pref>0,1,0)
       set @ldate=getdate()
	   set @errstatus=0
	   set @lref=0
	   set @new_inv_found=0

	   if @lwrite_mode=1
	   begin
			select  @lref=ref,@lis_used=is_used,@lsc_code=sc_code from slpu_unused_inv where company=@pcompany and invtype=@pinvtype and
			ref=@pref;

			begin transaction
------------ Write ref to table -----------------------------------------
			if isnull(@lref,0)=0
				insert into slpu_unused_inv (company, invtype, ref, sc_code, is_used, usrid, invdate, reasons,lastupdate) --- Added on 2023-01-12 AA  lastupdate
				values (@pcompany,@pinvtype,@pref,@psc_code,0,@pusrid,@ldate,@preasons,null);
			else
			if @lis_used=1 --and @lis_used=@pusrid Stopped on 2022-06-012 AA
				update slpu_unused_inv set is_used=0,invdate=@ldate where company=@pcompany and invtype=@pinvtype and  ref=@pref;
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-1
				return
			end	
			commit transaction
		end
------------ Get ref From table -----------------------------------------
		else
		begin
		    set @pref=0
		    if @luse_section_serial=0
			    DECLARE crs0 CURSOR LOCAL FAST_FORWARD FOR
				select  ref from slpu_unused_inv where company=@pcompany and invtype=@pinvtype and
				is_used=0 order by ref;  -- Removed on 2022-12-08 AA usrid=@pusrid and 
			else
			    DECLARE crs0 CURSOR LOCAL FAST_FORWARD FOR
				select ref from slpu_unused_inv where company=@pcompany and invtype=@pinvtype and
				is_used=0 and sc_code=@psc_code order by ref;	-- Removed on 2022-12-08 AA  usrid=@pusrid and 
	        
			open crs0;
			fetch next from crs0 into @lref;
			WHILE dbo.FetchStatusOfCursorNamed('crs0') = 0
			BEGIN
			    set @tmpref=0
			    if @pinvtype in ('04','06','24','26')
				begin
				   select @tmpref=ref from sales_hd where company=@pcompany and invtype=@pinvtype and ref=@lref;
				   if isnull(@tmpref,0)=0
				   begin
				      set @new_inv_found=1
					  break
				   end
				end
				else
			    if @pinvtype in ('10','11','30','31')
				begin
				   select @tmpref=ref from puhdr where company=@pcompany and invtype=@pinvtype and ref=@lref;
				   if isnull(@tmpref,0)=0
				   begin
				      set @new_inv_found=1
					  break
				   end
				end
				begin transaction
				--- 2023-01-12 AA Changed invdate to lastupdate 
				update slpu_unused_inv set is_used=1,lastupdate=@ldate where company=@pcompany and invtype=@pinvtype and  ref=@lref;
				if @@error<>0
				begin
					rollback transaction
					set @errstatus=-2
					break
				end	
				commit transaction

			    fetch next from crs0 into @lref;
			end
			CLOSE crs0;
			DEALLOCATE crs0;
			if @new_inv_found=1 and @errstatus=0
			begin
				begin transaction
				--- 2023-01-12 AA Changed invdate to lastupdate
				update slpu_unused_inv set is_used=1,lastupdate=@ldate where company=@pcompany and invtype=@pinvtype and  ref=@lref;
				if @@error<>0
				begin
					rollback transaction
					set @errstatus=-3
				end
				else
			    begin
					 commit transaction
					 set @pref=@lref
			    end
			end
		end
end


GO
/****** Object:  StoredProcedure [dbo].[update_tables_upper_case]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2022-08-22@@$$##  Important : must have this line as first line which contains the last update date for the this file
create procedure [dbo].[update_tables_upper_case]
@errstatus int = 0 output

as
begin
----- 2022-08-22 KAN Modified To Include bin Fields
set nocount on
declare @update_stmt as nvarchar(max)
declare @chk_lower_stmt as nvarchar(max)
declare @tbl_name as nvarchar(max)
declare @column_name as nvarchar(max)

set @errstatus=0

declare crs0 cursor local fast_forward for
        select table_name,column_name from information_schema.columns where 
               (column_name in ('itemno','asmitemno','rplitemno','modelno') and character_maximum_length=16) or 
			   (column_name in ('unicode','asmunicode','rplunicode') and character_maximum_length=6) or
	           (column_name in ('cmbkey','srvc24k_cmbkey','cat1_svccmbkey','cat2_svccmbkey','cat3_svccmbkey','cat4_svccmbkey','cat5_svccmbkey','cat6_svccmbkey','cat7_svccmbkey',
			                    'rent_svccmbkey','srvc_cmbkey','clnt_tylrng_srvc_cmbkey','our_tylrng_srvc_cmbkey','good_cmbkey','ready_made_cmbkey','rtrn_cmbkey') 
			      and character_maximum_length=24) or
			   (column_name in ('barcode','pbarcode','ms_barcode') and character_maximum_length=20)  or
			   (column_name in ('binno','tobinno','binsrlno') and character_maximum_length=6)
	           order by table_name,column_name;			   	        	 
   open crs0;
   
   fetch next from crs0 into @tbl_name,@column_name
   begin transaction
   while dbo.fetchstatusofcursornamed('crs0') = 0
   begin
	  set @chk_lower_stmt='select top 1 '+@column_name+' from '+@tbl_name+' where dbo.is_any_character_small_Caps('+@column_name+')>0'
	  exec sp_executesql @chk_lower_stmt
	  if @@ROWCOUNT>0 --means there is a t least one recod with lower case
	  --if exists (select 'y' from information_schema.columns where table_name =@tbl_name and column_name = @column_name)
	  begin
		  set @update_stmt='update '+@tbl_name+' set '+@column_name+'=upper('+@column_name+') where dbo.is_any_character_small_Caps('+@column_name+')>0'
		  exec sp_executesql @update_stmt
		  if @@error<>0
		  begin
		     rollback transaction
		     set @errstatus=-1
		     break
		   end
	  end
	  set @chk_lower_stmt=''
	  set @update_stmt=''
	  fetch next from crs0 into @tbl_name,@column_name
   end
	 
   close crs0
   deallocate crs0

   if @errstatus=-1 
	  begin
		rollback transaction
	    return
	  end
   else commit transaction

end


GO
/****** Object:  StoredProcedure [dbo].[Update_ttkfile_frm_inventory]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-04-29@@$$##  Important : must have this line as first line which contains the last update date for the this file
CREATE PROCEDURE [dbo].[Update_ttkfile_frm_inventory]
 @whno varchar(2),
 @STR_MSG varchar(400) output ,
 @errstatus int  output, -- used as input & output
 @lclasskey varchar(12) -- Added on 2024-04-27 AA
AS
BEGIN
---- Added on 2024-04-29 AA Added binno from inventory to ttkfile 
---- Added on 2024-04-27 AA new codes to select by classkey
---- Added on 2024-04-27 AA new parameter named @lclasskey
---- Modified on 2020-11-28 AA To work with supermarker system 

		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
	SET NOCOUNT ON
	declare @maxsrlno numeric(8,0) =0,
	        @lsupermarket bit =0,
			@class_len int=0
    set @class_len=len(@lclasskey)
    set @lsupermarket=@errstatus
	set @errstatus=0 

	select 	@maxsrlno=max(srl_no) from ttkfile where whno=@whno
	if isnull(@maxsrlno,0)=0 
	begin
	    set @errstatus = -1
		SET @STR_MSG ='Ttkfile is empty , you must start the Stock Take on First before running this operation'
		return @errstatus
	end
	begin try

		begin transaction
		if @class_len=0
		begin
			if @lsupermarket=0
			begin
				merge ttkfile as t
				using 
				(select   sum(a.qty) as qty,a.whno,a.binno,c.itemno,c.unicode ,
				classkey,b.name,c.name as name2,cmbkey,c.barcode,lcost,fcost from stitems b 
				inner join stunits c on b.itemno = c.itemno inner join  inventory a 
				on c.cmbkey=a.itemno 
				where a.whno=@whno
				group by a.whno,a.binno,c.itemno,c.unicode , classkey,b.name,c.name,cmbkey,c.barcode,lcost,fcost) as s
				on t.whno=s.whno and t.binno=s.binno and t.itemno=s.itemno and t.unicode=s.unicode
				when matched then
				update set t.ttqty=s.qty,t.ttstatus = 2
				when not matched then
				insert (whno,ttqty,ttstatus,itemno,unicode,lcost,fcost,srl_no,barcode,cmbkey,mclass,fname,binno,expdate)
				values (s.whno,s.qty,2,s.itemno,s.unicode,s.lcost,s.fcost,0,s.barcode,s.cmbkey,s.classkey,
				rtrim(s.name)+' '+rtrim(s.name2),s.binno,' ');
			end
			else
			begin
				update inventory set itemno = s1.cmbkey from stitembc s1 where s1.pbarcode = inventory.barcode
				merge ttkfile as t
				using 
				(select   sum(a.qty*x.pkqty) as qty,a.whno,a.binno,c.itemno,c.unicode ,
				classkey,b.name,c.name as name2,c.cmbkey,c.barcode,lcost,fcost from stitems b 
				inner join stunits c on b.itemno = c.itemno inner join  inventory a inner join stitembc x
				on a.barcode=x.pbarcode
				on c.cmbkey=a.itemno 
				where a.whno=@whno
				group by a.whno,a.binno,c.itemno,c.unicode , classkey,b.name,c.name,c.cmbkey,c.barcode,lcost,fcost) as s
				on t.whno=s.whno and t.binno=s.binno and t.itemno=s.itemno and t.unicode=s.unicode
				when matched then
				update set t.ttqty=s.qty,t.ttstatus = 2
				when not matched then
				insert (whno,ttqty,ttstatus,itemno,unicode,lcost,fcost,srl_no,barcode,cmbkey,mclass,fname,binno,expdate)
				values (s.whno,s.qty,2,s.itemno,s.unicode,s.lcost,s.fcost,0,s.barcode,s.cmbkey,s.classkey,
				rtrim(s.name)+' '+rtrim(s.name2),s.binno,' ');
			end
		end
		else
		begin
			if @lsupermarket=0
			begin
				merge ttkfile as t
				using 
				(select   sum(a.qty) as qty,a.whno,a.binno,c.itemno,c.unicode ,
				classkey,b.name,c.name as name2,cmbkey,c.barcode,lcost,fcost from stitems b 
				inner join stunits c on b.itemno = c.itemno inner join  inventory a 
				on c.cmbkey=a.itemno 
				where a.whno=@whno and substring(classkey,1,@class_len)=@lclasskey
				group by a.whno,a.binno,c.itemno,c.unicode , classkey,b.name,c.name,cmbkey,c.barcode,lcost,fcost) as s
				on t.whno=s.whno and t.binno=s.binno and t.itemno=s.itemno and t.unicode=s.unicode
				when matched then
				update set t.ttqty=s.qty,t.ttstatus = 2
				when not matched then
				insert (whno,ttqty,ttstatus,itemno,unicode,lcost,fcost,srl_no,barcode,cmbkey,mclass,fname,binno,expdate)
				values (s.whno,s.qty,2,s.itemno,s.unicode,s.lcost,s.fcost,0,s.barcode,s.cmbkey,s.classkey,
				rtrim(s.name)+' '+rtrim(s.name2),s.binno,' ');
			end
			else
			begin
				update inventory set itemno = s1.cmbkey from stitembc s1 where s1.pbarcode = inventory.barcode
				merge ttkfile as t
				using 
				(select   sum(a.qty*x.pkqty) as qty,a.whno,a.binno,c.itemno,c.unicode ,
				classkey,b.name,c.name as name2,c.cmbkey,c.barcode,lcost,fcost from stitems b 
				inner join stunits c on b.itemno = c.itemno inner join  inventory a inner join stitembc x
				on a.barcode=x.pbarcode
				on c.cmbkey=a.itemno 
				where a.whno=@whno and substring(classkey,1,@class_len)=@lclasskey
				group by a.whno,a.binno,c.itemno,c.unicode , classkey,b.name,c.name,c.cmbkey,c.barcode,lcost,fcost) as s
				on t.whno=s.whno and t.binno=s.binno and t.itemno=s.itemno and t.unicode=s.unicode
				when matched then
				update set t.ttqty=s.qty,t.ttstatus = 2
				when not matched then
				insert (whno,ttqty,ttstatus,itemno,unicode,lcost,fcost,srl_no,barcode,cmbkey,mclass,fname,binno,expdate)
				values (s.whno,s.qty,2,s.itemno,s.unicode,s.lcost,s.fcost,0,s.barcode,s.cmbkey,s.classkey,
				rtrim(s.name)+' '+rtrim(s.name2),s.binno,' ');
			end
		end
		if @@error<>0
		begin
			rollback transaction
			SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   
			set @errstatus = -2
		end
		else
		begin
		    set @errstatus = @@ROWCOUNT
            update ttkfile set @maxsrlno=srl_no= @maxsrlno+1  where whno=@whno and srl_no=0
			if @@error<>0
			begin
				rollback transaction
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   
				set @errstatus = -3
			end
			else
			begin
			     update ttkhdr set ttcntr=@maxsrlno where ttwhno=@whno
				 commit transaction
			end
		end
		return @errstatus
	END TRY
	BEGIN CATCH
	    if @@trancount>0  ROLLBACK TRANSACTION
		SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () 
		SET @errstatus = -99
		RETURN @errstatus
	END CATCH
end




GO
/****** Object:  StoredProcedure [dbo].[Update_ttkfile_frm_ttkNfile]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Update_ttkfile_frm_ttkNfile]
 @whno varchar(2),
 @STR_MSG varchar(400) output ,
 @errstatus int = 0 output
	
AS
BEGIN
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
	SET NOCOUNT ON
	declare @maxsrlno numeric(8,0) =0
	select 	@maxsrlno=max(srl_no) from ttkfile where whno=@whno
	if isnull(@maxsrlno,0)=0 
	begin
	    set @errstatus = -1
		SET @STR_MSG ='Ttkfile is empty , you must start the Stock Take on First before running this operation'
		return @errstatus
	end
	begin try

		begin transaction

		merge ttkfile as t
		using 
		(select q1+q2+q3+q4+q5+q6+q7+q8+q9+q10+q11+q12 as qty,whno,binno,a.itemno,a.unicode ,
		classkey,b.name,c.name as name2,cmbkey,barcode,lcost,fcost from stitems b 
		inner join stunits c on b.itemno = c.itemno inner join  ttknfile a 
		on c.itemno=a.itemno and c.unicode=a.unicode
		where whno=@whno) as s
		on t.whno=s.whno and t.binno=s.binno and t.itemno=s.itemno and t.unicode=s.unicode
		when matched then
		update set t.ttqty=s.qty,t.ttstatus = 2
		when not matched then
		insert (whno,ttqty,ttstatus,itemno,unicode,lcost,fcost,srl_no,barcode,cmbkey,mclass,fname,binno,expdate)
		values (s.whno,s.qty,2,s.itemno,s.unicode,s.lcost,s.fcost,0,s.barcode,s.cmbkey,s.classkey,
		rtrim(s.name)+' '+rtrim(s.name2),' ',' ');
		if @@error<>0
		begin
			rollback transaction
			SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   
			set @errstatus = -2
		end
		else
		begin
		    set @errstatus = @@ROWCOUNT
            update ttkfile set @maxsrlno=srl_no= @maxsrlno+1  where whno=@whno and srl_no=0
			if @@error<>0
			begin
				rollback transaction
				SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE ()   
				set @errstatus = -3
			end
			else
			begin
			     if @@ROWCOUNT>0  update ttkhdr set ttcntr=@maxsrlno where ttwhno=@whno
				 commit transaction
			end
		end
		return @errstatus
	END TRY
	BEGIN CATCH
	    if @@trancount>0  ROLLBACK TRANSACTION
		SET @STR_MSG = 'ERROR INFO:- NUMBER : ' + CONVERT (VARCHAR, ERROR_NUMBER ()) + ', MESSAGE : ' + ERROR_MESSAGE () 
		SET @errstatus = -99
		RETURN @errstatus
	END CATCH
end









GO
/****** Object:  StoredProcedure [dbo].[update_xitems]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

create PROCEDURE [dbo].[update_xitems]
 @wh_condtion nvarchar(200), -- condition for main select statement to import items
 @wh_condtion2 nvarchar(100), -- condition to uniqu barcode statement
 @m_multibarcode bit,  -- is it multibarcode
 @pos_alwbrprice bit,  -- is it multi branch prices
 @unq_bc_in_shwrm bit, -- is unique barcode system
 @dbc nvarchar(13),    -- main database name in the server
 @lNoOf_items_updated int=0 output,
 @errstatus int = 0 output
	
AS
BEGIN

----------------------------------  Bring Items from main server to POS  -----------------------------------------
---------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------
declare @sqlmsg nvarchar(max),
        @sqlmsg2 nvarchar(100)='',
		@nosales_is_existed bit =0
		
		if exists(SELECT COLUMN_NAME  FROM INFORMATION_SCHEMA.COLUMNS  WHERE TABLE_NAME = 'positems' and COLUMN_NAME='nosales') 
		 set @nosales_is_existed=1;

        set @sqlmsg='merge positems as t using '
	    If @m_multibarcode=1 And @pos_alwbrprice=0
		begin
			set @sqlmsg=@sqlmsg+'(Select a.cmbkey, SUBSTRING(rtrim(rTrim(b.Name)+space(1)+rTrim(c.itext)),1,55) As name, c.pbarcode as barcode,'
			+ ' c.lprice1,a.lprice2,a.lprice3, c.mnmprice,b.DSCTYPE,maxdisc1 as dscprsnt,b.fix_barcode'+iif(@nosales_is_existed=1,',nosales','')+',b.taxtype' 
			+ ' from [update_items].'+@dbc+'[stitems]  b (NOLOCK) inner Join [update_items].'+@dbc+'[stunits]  a (NOLOCK) '
			+ ' inner join [update_items].'+@dbc+'[stitembc] c (NOLOCK) '
			+ ' on a.itemno=c.itemno and a.unicode=c.unicode'
			+ ' on b.ITEMNO=a.ITEMNO '
			+ ' where  b.itemtype not In (''5'',''6'') And not (b.itemtype=''2'' And a.Unicode=space(6)) and rtrim(c.pbarcode)<>'''''
		end
		else
		begin
		   if @unq_bc_in_shwrm=1
		   begin
			   set @sqlmsg2='merge pos_ubc as t using '
			   + '(select barcode,cmbkey from [update_items].'+@dbc+'[stqtybc] (NOLOCK) '+Iif(@wh_condtion2='''','''',' where '+@wh_condtion2)+') as s '
			   + ' on t.barcode=s.barcode '
			   + ' when not matched then '
			   + ' insert values (s.barcode,s.cmbkey);' 
		   end
		   if @pos_alwbrprice=1
		   begin

               set @sqlmsg=@sqlmsg+'(Select a.cmbkey, rtrim(rTrim(b.Name)+'' ''+rTrim(a.Name)+'' ''+rtrim(a.scnname)) As name, a.barcode,'
               + ' c.lprice1,c.lprice2,c.lprice3, c.mnmprice,c.maxdisc1 as dscprsnt,b.DSCTYPE,b.fix_barcode'+iif(@nosales_is_existed=1,',nosales','')+',b.taxtype' 
               + ' from [update_items].'+@dbc+'[stitems]  b (NOLOCK) inner Join [update_items].'+@dbc+'[stunits]  a (NOLOCK) '
			   + ' inner join [update_items].'+@dbc+'[stbrprice] c (NOLOCK) '
               + ' on a.itemno=c.itemno and a.unicode=c.unicode'
               + ' on b.ITEMNO=a.ITEMNO '
               + ' where  b.itemtype not In (''5'',''6'') And not (b.itemtype=''2'' And a.Unicode=space(6))'
		   end
		   else
		   begin
               set @sqlmsg=@sqlmsg+'(Select a.cmbkey, rtrim(rTrim(b.Name)+'' ''+rTrim(a.Name)+'' ''+rtrim(a.scnname)) As name, a.barcode,'
               + ' a.lprice1,a.lprice2,a.lprice3, a.mnmprice,b.DSCTYPE,maxdisc1 as dscprsnt,b.fix_barcode'+iif(@nosales_is_existed=1,',nosales','')+',b.taxtype'
               + ' from [update_items].'+@dbc+'[stunits]  a (NOLOCK) inner Join [update_items].'+@dbc+'[stitems]  b (NOLOCK) '
               + ' on a.ITEMNO=b.ITEMNO '
               + ' where  b.itemtype not In (''5'',''6'') And not (b.itemtype=''2'' And a.Unicode=space(6))'
		   end
		end
		set @sqlmsg=@sqlmsg+ Iif(@wh_condtion='','',' and '+@wh_condtion)+') as s '
		+ ' on t.barcode=s.barcode '
		+ ' when not matched then '
		+ ' insert values (s.cmbkey ,s.name ,s.barcode ,s.lprice1 ,s.lprice2 ,s.lprice3,'''',s.mnmprice,s.dscprsnt,'''',s.dsctype'
		+ '	,s.fix_barcode,0'+iif(@nosales_is_existed=1,',s.nosales','')+',isnull(s.taxtype,''1'')) '
		+ ' when matched then '
		+ ' update set t.lprice1=s.lprice1,t.lprice2=s.lprice2,t.lprice3=s.lprice3,t.mnmprice=s.mnmprice,t.dsctype=s.dsctype,'
		+ ' t.dscprsnt=s.dscprsnt,t.name=s.name,t.fix_barcode=s.fix_barcode,t.nosales=s.nosales,t.taxtype=isnull(s.taxtype,''1'');'
--	

		begin transaction
		exec sp_executesql @sqlmsg
		set @lNoOf_items_updated=@@ROWCOUNT
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-1
			return 
		end
		else 
		begin
		   if @unq_bc_in_shwrm=1 and @sqlmsg2<>''
		   begin
				exec sp_executesql @sqlmsg2
				if @@error<>0
				begin
					rollback transaction
					set @errstatus=-2
					return 
				end
		   end
		end
		commit transaction
end










GO
/****** Object:  StoredProcedure [dbo].[validate_date]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2023-11-25@@$$##  Important : must have this line as first line which contains the last update date for the this file
CREATE PROCEDURE [dbo].[validate_date]
-------- This Routine is used To check if the hijjri or grogarian date is correct and accepted by the database
-------- For example '14380230' is not valid in database according to O'mm Al Gora calancder if even though it is accepted 
--------  By FoxPro program

 @p_date char(8) output,
 @errstatus int  output, -- When @errstatus=1 this means return strict date 
 @lgrgdate date output
 	
AS
BEGIN
------- Added on 2023-11-20 AA Passed the @strictDate as a new parameter of  SP get_correct_hijjri_date
------- Added on 2023-11-20 AA when @errstatus=0 means if @p_date is 14450430 which is wrong date in hijiri , correct the date & return it as 14450501 
-------                        when @errstatus=1 means if @p_date is 14450430 which is wrong date in hijiri , Do not correct the date & return empty string
------- Added on 2023-11-19 AA Stopped bad code at the end of the routine & added new correct code
------- Added on 2023-11-16 AA re-writtin from scrash & enhenced , improved & solved many date hijiri problems 
------- Added on 2023-11-15 AA new variable named @hj_today_date
------- Added on 2023-11-15 AA to fixed problem coming from convert function which gives wrong result when convert from hijiri to milady
		-- modified on 2019-03-11
		-- SET NOCOUNT ON added to prevent extra result sets from
		-- interfering with SELECT statements.
		SET NOCOUNT ON;
	declare @dbc varchar(20),
			@is_it_hij bit=0,
			@DateConvertFactor int=112,
			@strictDate bit, 
			@tmpdate char(8),
			@hj_today_date char(8) --- Added on 2023-11-15 AA

	declare @lcdate char(8)='',
	@ptr int=0,
	@dd int,@org_dd int=0,
	@ldone bit=0,
	@mm int=0,
	@yy int=0,
	@fndate varchar(10)='',
	@lastdate char(8)=''
	set @lgrgdate = null
	set @strictDate=@errstatus

	set @errstatus  =0
	set @ldone=0
	set @dbc=db_name()
	SET @is_it_hij=iif(substring(@p_date,1,2)='14',1,0) 
	set @DateConvertFactor=iif(substring(@p_date,1,2)='14',131,112)

	set @lcdate=@p_date
	set @p_date=''
	set @lastdate=@lcdate
	
	if @is_it_hij=1 
		exec dbo.get_correct_hijjri_date @lcdate output,@lgrgdate output,@strictDate
	else
	begin
		begin try
			set @lgrgdate= convert(date,@lcdate,@DateConvertFactor)
		end try
		begin catch
		   set @errstatus=-2
		   set @p_date=''
		   set @lcdate=''
		   set @lgrgdate=null
		end catch
	end
---- Stopp on 2023-11-19 AA -----------
	--set @errstatus=0
	--if @errstatus in (0) set @p_date=@lcdate
-------------------------------------------
	set @p_date=@lcdate -- Added on 2023-11-19 AA
end



GO
/****** Object:  StoredProcedure [dbo].[Validate_Login]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[Validate_Login]
(@userName nvarchar(10)) as begin
SELECT username,convert(varchar(100),DecryptByPassPhrase('cickey', passwordPDA ))as  password,mobilNo
FROM SYSUSE WHERE username=@userName  and mobileuser =1 
end 










GO
/****** Object:  StoredProcedure [dbo].[Validate_Web_User]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Validate_Web_User]
      @Username VARCHAR(10),
      @Password VARCHAR(20)
AS
BEGIN
	SET NOCOUNT ON
	declare @lpassword varbinary(100)
	set @lpassword = EncryptByPassPhrase('cickey',@Password)
	select username,fullname,passwordPDA,showcost,[suspend] from sysuse where rtrim(username)=@Username and 
	passwordPDA=@lpassword and isnull([suspend],0)=0 and posuser=1 -- only for testing we use posuser instead of mobileuser=1

  --convert(varchar(100),DecryptByPassPhrase('cickey', passwordPDA ))
		
end















GO
/****** Object:  StoredProcedure [dbo].[ver13_new_stupdt]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---- 2024-04-16@@$$##  Important : must have this line as first line which contains the last update date for the this file
CREATE PROCEDURE [dbo].[ver13_new_stupdt]
   @errstatus int  output  -- Works as input as well when 12 = version12 , when 13 = version13 -- Added on 2023-03-13 AA
	
AS
BEGIN
---- 2024-04-16 AA modified any code @stk_lcost=0 to @stk_lcost<=0
---- 2024-04-16 AA Added code to check if @stk_lcost<0 
---- 2024-04-05 AA Added changed the order of item trx list
---- 2024-03-27 AA Added @lasmtype to the last fetch statement
---- 2024-03-27 AA Added new code to update qty in stdtl when trtype=14 and asmtype=7
---- 2024-03-27 AA Added new varibale @lasmtype 
---- 2024-03-27 AA Added new code for type=14 to get the proper stk_lcost avg
---- 2023-11-25 AA Changed the numeric(6,0) to int for ref & glref
---- 2023-10-26 AA Added code to update type='14' of lprice ,fprice and qty in stdtl 
---- 2023-10-26 AA Added code to calculate the avg cost from type='14'
---- 2023-10-25 AA Added code not to allow the transfer trx between branchs will not effect the avg cost for stunits
---- 2023-10-25 AA Added new codes to build up the avg cost for binno
---- 2023-10-24 AA Added 5 variables for shobra for trx transfer between branchs
---- 2023-10-24 AA Added 3 variables to be used for trx transfer between branchs
---- 2023-10-25 AA Added new codes to update the cost of transfer trx between branches
---- 2023-10-24 AA Modified the order by in crs1 statement to make the isssue trx between branch comes first 
---- 2023-10-24 AA added isnull(expdate,'') 
---- 2023-10-23 AA to fix the bug of using towhno instead of @ltowhno
---- 2023-10-23 AA to fix the bug of removing expdate from binno
---- 2023-03-13 AA  New procedure 
---- 2023-03-13 AA  get the value of @infoversion from @errstatus parameter
---- 2023-03-13 AA  get the value of @lcaloccost from glcalend
---- 2023-03-13 AA  the parameter @errstatus works as input as well as output
---- 2023-03-13 AA Added Two variable @infoversion & @lcaloccost 
---- 2023-01-07 AA Fixed the bug of lrunbal value when it is 0.000000000nnnn set to 0.00
---- 2022-12-21 Fixed the bug when and inventory transaction has JV (glref>0) do not build cost
---- Added on 2022-05-23 AA semi colons are added to the end of eash select statements
---- Added on 2022-05-23 AA Fixed the bug of converting float to numeric(20,12)
---- 2021-08-27 AA allow to take the lcost from sttypecost table if lstrcvdate>=yr_start
---- 2020-08-16 AA Made all the qty to be numeric(20,21) instead of float to get red of the long decimal fractions 
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.posted,trdate,src,AMNTTL,costttl,entries
	SET NOCOUNT ON


	declare @lcurbal float ,  
        @lrunbal float , 
        @inbal float , 
        @lopenbal float , 
		@llprice float,
		@llcost float,
		@lfcost float,
		@lopenlcost float,
		@lopenfcost float,
		@trxlcost float,
		@trxfcost float,
		@trxqty float , 
		@lbranch char(2),
        @litemno char(16),
		@lunicode char(6) ,
		@lwhno char(2) ,
		@lbinno char(6),
		@lttlqty float=0 , 
		@lmnopenlcost float,
		@stk_lcost float,
		@costchg int=0,
		@lastcost float,
		@stk_fcost float,
		@lmnopenfcost float

	declare 
		@dbc nvarchar(14),
		@lcalcomp char(2),
		@yrcode char(4),
		@lbrxautojv bit=0,
		@lyr_start char(8), -- Added on 2021-08-27 
		@lasmtype numeric(1,0)=0 -- Added on 2024-03-27 AA
--- Added on 2023-03-13 AA -------
    Declare 
		@lcaloccost bit =0, 
		@infoversion int =0, 
		@lprv_itemno char(22) ='',
		@stk_bn_lcost float=0,
		@stk_bn_fcost float=0,
		@runbal_binno float =0
		set @infoversion=@errstatus 
-------------------------------------
		set @dbc=db_name()
		set @lcalcomp=substring(@dbc,4,2)
		set @yrcode=substring(@dbc,7,2)
		SET @yrcode=iif(cast(@yrcode as int)>33,'14','20')+rtrim(@yrcode)

	
------------------------------ Get syscode from Main office glcalend  ------------------------------------------------------
	select @lbrxautojv=brxautojv,@lyr_start=calstart,@lcaloccost=caloccost  from sysdb.dbo.glcalend  -- Modified on 2023-03-13 AA @lcaloccost=caloccost
	       where calcomp=@lcalcomp and yrcode=@yrcode;
    set @lbrxautojv=isnull(@lbrxautojv,0)
--------------------------------------------------------------------------------------------------------------------------- 
---
---   Prepair for deletion and updating to openbal vaalues
---
        if @lcaloccost=1
		begin
			  set @errstatus=-111		
			  return
		end
		begin transaction
		delete from stbins where openbal=0 and openlcost=0  and len(isnull(expdate,''))=0 -- Added on 2023-10-13 AA to fix the bug of removing expdate from binno
		if @@error<>0
			begin
			  rollback transaction
			  set @errstatus=-1		
			  return		 
			end
		
		update stbins set qty=openbal,lcost=openlcost,fcost=openfcost
		if @@error<>0
			begin
			  rollback transaction
			  set @errstatus=-1		
			  return		 
			end
			
		update stunits set curbal=openbal,lcost=openlcost,fcost=openfcost
		if @@error<>0
			begin
			  rollback transaction
			  set @errstatus=-1		
			  return		 
			end
		commit transaction
-----------------------------------------------------------------------------------------------
        begin transaction
		merge stbins as t
		using (select distinct branch,a.itemno,a.unicode,whno,binno from stdtl a inner join stunits b 
		   on a.itemno=b.itemno and a.unicode=b.unicode
		   inner join stitems c
		   on b.itemno=c.itemno
		where c.itemtype not in ('5','6')) as s
		on t.branch=s.branch and t.itemno=s.itemno and t.unicode=s.unicode and t.whno=s.whno and t.binno=s.binno
		when not matched then
			insert values (s.branch,s.itemno,s.unicode,s.whno,s.binno,0,0,0,0,0,0,0,'');
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-1	
				return --@errstatus			 				
			end
			else commit transaction
		  if @errstatus<0 
		  return 
-------------------------------------  Added on 22-03-2017 --------------------------------
--- To handle the pu fcyrate 0.000001 which make the fcost of stdtl very big
        begin transaction
		update stdtl set fcost=0
		from stdtl t
		join
		(
		select a.itemno,a.unicode,a.branch,a.trtype,a.ref,folio,b.fcyrate,lcost,fcost from stdtl a with (nolock)
		 inner join puhdr b with (nolock) on a.branch=b.company and a.trtype=b.invtype
		and a.ref=b.ref
		where a.src='07' and b.fcyrate=0.000001 and len(fcy)=0) s
		on t.branch=s.branch and t.trtype=s.trtype and t.ref=s.ref and t.folio=s.folio
		where t.src='07';
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-1	
			return 			 				
		end
		
		--  the fcost always zero
		update stdtl set fcost=nfcost
		from stdtl t
		join
		(
		select a.branch,a.trtype,a.ref,folio,nfcost=lcost/curfix  from sthdr x 
		inner join  stdtl a on a.branch=x.branch and a.trtype=x.trtype and a.ref=x.ref inner join 
		stitems b on a.itemno=b.itemno inner join glcurr c on b.fcy=c.curcode
		where len(b.fcy)>0 and a.trtype='01' and fcost=0 and curfix>0) s
		on t.branch=s.branch and t.trtype=s.trtype and t.ref=s.ref and t.folio=s.folio;
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-1	
			return 			 				
		end
		update puhdr set fcyrate=0 where fcyrate=0.000001 and len(fcy)=0
		if @@error<>0
		begin
			rollback transaction
			set @errstatus=-1	
			return 			 				
		end
		commit transaction			
-----------------------------------------------------------------------------------------------
--  Building stbins items qty balances and cost
--
     declare @ltrtype char(2),
	         @ltrdate char(8),
	         @lref int,
			 @lqty float,
			 @lfolio int,
			 @lisbrtrx bit,
			 @lrcvdtrn bit,
			 @lposted bit,
			 @ltowhno char(2),
			 @ltobinno char(6),
			 @lfcy char(3),
			 @lfcyrate float,
			 @ttp int,
			 @dont_check_cost int=0,
			 @xdate char(8),
			 @lcurfixrate float=0,
			 @only20type bit =0,
			 @lglref int=0, -- Added on 2022-12-21 AA
			 @qty_binno float =0, -- Added on 2023-03-13 AA
			 @cadj bit =0 , -- Added on 2023-03-13 AA
			 @lfprice float=0 

---- Added on 2023-10-24 AA ----------------------------------------------
     declare @ltobrno char(2)='',
			 @lbrxref int =0,
			 @lclient_is_shobra int =0
     select @lclient_is_shobra=count(*) from stbranch where smsuser in (142,143);
	 set @lclient_is_shobra=isnull(@lclient_is_shobra,0)
--- For Shobra ---------------------------------	 
	 declare @l_ttlcost float=0,
			@l_item_count int =0,
			@l_pcslcost float =0,
			@l_fcttlcost float =0,
			@l_pcsfcost float =0
--------------------------------------------------------------------------
     set @errstatus=0;
     DECLARE crs0 CURSOR LOCAL FAST_FORWARD FOR
     select c.itemno,c.unicode,openbal,openlcost,openfcost,b.fcy from stunits c  inner join stitems b
	 on c.itemno=b.itemno 
	 order by itemno,unicode;
	
	 
  	 open crs0;

------------------------------------
		fetch next from crs0 into @litemno,@lunicode,@lopenbal,@lopenlcost,@lopenfcost,@lfcy

		WHILE dbo.FetchStatusOfCursorNamed('crs0') = 0
        BEGIN
		    
			set @dont_check_cost=0
			set @runbal_binno=0.00
			set @stk_lcost=ABS(@lopenlcost) 
			set @stk_fcost=ABS(@lopenfcost)
			set @lrunbal= @lopenbal
 			set @stk_bn_lcost=0
			set @stk_bn_fcost=0            
			set @lastcost=0
			set @only20type=0
	        
            			
			 
			set @lcurfixrate=0
			if len(@lfcy)>0 select @lcurfixrate=curfix from glcurr where curcode=@lfcy;

            DECLARE crs1 CURSOR LOCAL FAST_FORWARD FOR
			select a.trtype,a.ref,a.folio,qty+fqty as qty,lcost,fcost,isbrtrx,posted,a.towhno,a.tobinno,fcyrate,a.trdate,
			rcvdtrn,b.glref,a.branch,a.whno,a.binno,lprice,fprice,
			b.tobrno,b.brxref, -- Added on 2023-10-24 AA
			asmtype -- added on 2024-03-27 AA
			from sthdr b inner join stdtl a
	    	on b.branch=a.branch and b.trtype=a.trtype and b.ref=a.ref 
	    	where a.itemno=@litemno and a.unicode=@lunicode 
			order by a.trdate,Iif(a.trtype in ('10','11') or (a.trtype='01' and isbrtrx=0),'01',Iif(a.trtype='14','02',
			iif(a.trtype in ('13','46','12','14') or (a.trtype='09' and isbrtrx=1),'03','04'))),a.branch,a.trtype,a.ref,folio; -- Modified on 2024-04-05 AA
   --         order by a.trdate,Iif((a.trtype in ('10','11','13','46','12','14') or (a.trtype='01' and isbrtrx=0) or 
			--(a.trtype='09' and isbrtrx=1)),'01','02'),a.branch,a.trtype,a.ref,folio  -- Modified on 2023-10-24 AA to make the isssue trx between branch comes first
			open crs1;
			

			fetch next from crs1 into @ltrtype,@lref,@lfolio,@lqty,@llcost,@lfcost,@lisbrtrx,@lposted,@ltowhno
			,@ltobinno,@lfcyrate,@ltrdate,@lrcvdtrn,@lglref,@lbranch,@lwhno,@lbinno,@llprice,@lfprice, -- Added on 2022-12-21 AA @lglref
			@ltobrno,@lbrxref, -- Added on 2023-10-24 AA
			@lasmtype; -- added on 2024-03-27 AA 

			begin transaction

			WHILE dbo.FetchStatusOfCursorNamed('crs1') = 0
            BEGIN
				set @trxlcost=0
				set @trxfcost=0
			    set @qty_binno=0
				set @stk_bn_lcost=0
				set @stk_bn_fcost=0
				set @cadj=0

			    set @ttp=cast(@ltrtype as int)
				if @stk_lcost<=0 and @llcost>0 set @lastcost=@llcost
				if @lposted=1
				begin
				   if @ttp in (4,6,9,30,31,2)
				   begin
				       set @lrunbal=@lrunbal-@lqty
					   set @qty_binno=-@lqty
				   end
				   if @ttp in (5,24,26,13,12) or (@ttp=46 And @lqty<0)  
				   begin
				       set @lrunbal=@lrunbal+@lqty
					   set @qty_binno=@lqty
                       If @lqty>0 And @stk_lcost<=0 
					   begin  
                         set @lastcost=@llcost
                       
                       end
				   end
				   if @ttp in (1,10,11) or (@ttp=46 And @lqty>0) 
				   begin
				      set @qty_binno=@lqty
					  if not(@ttp=1 and @lisbrtrx=1) -- Added on 2023-10-25 AA not allow the trx between branchs will not effect the avg cost
					  begin
						  if @lrunbal>0
						  begin
								if @stk_lcost>0
								set @stk_lcost=Abs(((@stk_lcost*@lrunbal)+Abs(@lqty*@llcost))/(@lrunbal+@lqty))
								else set @stk_lcost=@llcost

								if isnull(@lfcost,0)<>0
								begin 
									if @stk_fcost>0
										set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*@lfcost))/(@lrunbal+@lqty))
									else set @stk_fcost=@lfcost
								end
								else 
								if isnull(@lfcy,'')<>''
								begin
									if  isnull(@lfcyrate,0)>0
										if @stk_fcost>0
										set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*(@llcost/@lfcyrate)))/(@lrunbal+@lqty))
										else set @stk_fcost=(@llcost/@lfcyrate)
									else 
									if isnull(@lcurfixrate,0)>0
										if @stk_fcost>0
											set @stk_fcost=Abs(((@stk_fcost*@lrunbal)+Abs(@lqty*(@llcost/@lcurfixrate)))/(@lrunbal+@lqty))
										else set @stk_fcost=(@llcost/@lcurfixrate)
								end
						  end
						  else
						  begin
								set @stk_lcost=@llcost
								if isnull(@lfcost,0)<>0  set @stk_fcost=@lfcost
								else if isnull(@lfcy,'')<>'' 
								begin
									if  isnull(@lfcyrate,0)>0 set @stk_fcost=@llcost/@lfcyrate
									else  if isnull(@lcurfixrate,0)>0 set @stk_fcost=@llcost/@lcurfixrate
								end
						  end
					  end
					  set @lrunbal=@lrunbal+@lqty
				   end
                   if @ttp=20
				   begin
				       set @lrunbal = @lrunbal + Iif(rtrim(@ltowhno)<>'',-@lqty,@lqty)
					   set @qty_binno=Iif(rtrim(@ltowhno)<>'',-@lqty,@lqty)
				   end
				   if @ttp=14
				   begin
					   if @lrunbal<>0 and @stk_lcost>0
					   begin
					      select @runbal_binno=qty,@stk_bn_lcost=lcost,@stk_bn_fcost=fcost from stbins where
						  branch=@lbranch and itemno=@litemno and unicode=@lunicode and whno=@lwhno and binno=@lbinno;
						  set @runbal_binno=abs(isnull(@runbal_binno,0))
						  set @stk_bn_lcost=isnull(@stk_bn_lcost,0)
						  set @stk_bn_fcost=isnull(@stk_bn_fcost,0)
-------- Added on 2024-03-27 AA ----------------------------------------
						  if @lasmtype<>7
						  begin
							  if @stk_bn_lcost>0 set @llprice=@stk_bn_lcost
							  if @stk_bn_fcost>0 set @lfprice=@stk_bn_fcost
						  end
-----------------------------------------------------------------------------
						  --if @runbal_binno<>0
						  --begin
						       set @cadj=1
-------- Stopped on 2024-03-27 AA --------------------------------------------------------------------------------
						    --   set @lqty=@runbal_binno
						    --   set @stk_lcost=(abs(@lrunbal*@stk_lcost)+((@llcost-@llprice)*@lqty))/abs(@lrunbal)
							   --set @stk_fcost=(abs(@lrunbal*@stk_fcost)+((@lfcost-@lfprice)*@lqty))/abs(@lrunbal)
---------------------------------------------------------------------------------------------------------------------
------------------------------- Added on 2024-03-27 AA ------------------------------------------------------------
						       set @lqty=@lrunbal
						       set @stk_lcost=(abs(@lrunbal*@stk_lcost)+((@llcost-@llprice)*@lqty))/abs(@lrunbal)
							   set @stk_fcost=(abs(@lrunbal*@stk_fcost)+((@lfcost-@lfprice)*@lqty))/abs(@lrunbal)
------------------------------- Added on 2024-04-16 AA -----------------------------------------------------
							   if @stk_lcost<0 set @stk_lcost=@llcost
							   if @stk_fcost<0 set @stk_fcost=@lfcost
-------------------------------------------------------------------------------------------------------------------
						  --end
					   end
				   end
			    end  -- end of @lposted
--
---------- beginning of stdtl lcost update
--
				If not (@ttp in (1,10,11,14,30,31) or (@ttp=46 And @lqty>0) --or @lisbrtrx=1 Removed on 2023-10-24 AA
				       or @lglref>0) -- Added on 2022-12-21 AA
				begin
				    set @only20type=1
				    if @stk_lcost<=0 and  @dont_check_cost<3  
					begin

						set @dont_check_cost +=1
						set @xdate=@ltrdate
						Select top 1 @trxlcost=lcost,@trxfcost=fcost From stdtl a inner join sthdr b
						on a.branch=b.branch and a.trtype=b.trtype and a.ref=b.ref
						where a.branch=@lbranch and itemno=@litemno and unicode=@lunicode and a.whno=@lwhno and
						(a.trtype in ('10','11') or (a.trtype='46' And qty>0) or (a.trtype='01' And isbrtrx=0)) --or (trtype='20' And towhno='')
						order by a.trdate,iif(a.trtype in ('01','10','11'),1,2),a.ref,folio;

						if isnull(@trxlcost,0)=0 
						begin
							set @dont_check_cost +=1
							Select top 1 @trxlcost=lcost,@trxfcost=fcost From stdtl a inner join sthdr b
							on a.branch=b.branch and a.trtype=b.trtype and a.ref=b.ref
							where a.branch=@lbranch and itemno=@litemno and unicode=@lunicode  and
							(a.trtype in ('10','11') or (a.trtype='46' And qty>0) or (a.trtype='01' And isbrtrx=0)) --or (trtype='20' And towhno='')
							order by a.trdate,iif(a.trtype in ('01','10','11'),1,2),a.ref,folio;
						end
						if isnull(@trxlcost,0)=0 
						begin
							Select top 1 @trxlcost=lcost,@trxfcost=fcost From stdtl a inner join sthdr b
							on a.branch=b.branch and a.trtype=b.trtype and a.ref=b.ref
							where  itemno=@litemno and unicode=@lunicode  and
							(a.trtype in ('10','11') or (a.trtype='46' And qty>0) or (a.trtype='01' And isbrtrx=0)) --or (trtype='20' And towhno='')
							order by a.trdate,iif(a.trtype in ('01','10','11'),1,2),a.ref,folio;
						end
						if isnull(@trxlcost,0)=0 
						begin
							set @trxlcost=0
							set @trxfcost=0
							select @trxlcost=lastlcost,@trxfcost=lastfcost from stcosttype 
							where branch=@lbranch  and itemno=@litemno and unicode=@lunicode 
							and lstrcvdate>=@lyr_start; -- Added on 2021-08-27 AA
							if isnull(@trxlcost,0)=0
							begin
								select top 1 @trxlcost=lastlcost,@trxfcost=lastfcost from stcosttype 
								where  itemno=@litemno and unicode=@lunicode and lstrcvdate>=@lyr_start order by lstrcvdate desc,branch; 
							end
						end									 
						
						if isnull(@trxlcost,0)>0
						begin
							set @stk_lcost=@trxlcost
							set @stk_fcost=isnull(@trxfcost,0)
						end

					end  -- end of @stk_lcost=0

					if @stk_lcost>0 
					begin
						update stdtl set lcost=@stk_lcost,fcost=@stk_fcost where branch=@lbranch and trtype=@ltrtype and
						ref=@lref and folio=@lfolio;
			         	if @@error<>0
						begin
							rollback transaction
							set @errstatus=-1
							break
						end
----------------------- Added on 2023-10-24 AA to handle trx between branches-------------------------------------------------------
                        if (@ttp=9 and @lisbrtrx=1 and @lglref=0) 
						begin
							if @lclient_is_shobra=0
							update stdtl set lcost = @stk_lcost,fcost=@stk_fcost where branch=@ltobrno and trtype='01' and ref=@lbrxref 
							and folio=@lfolio
							else 
							begin
							    set @l_ttlcost =0
								set @l_fcttlcost=0
                                set @l_item_count  =0
		                        set @l_pcslcost =@stk_lcost
								set @l_pcsfcost =@stk_fcost
								set @lttlqty =0
							    select @lttlqty=sum(qty),@l_ttlcost=sum(qty*lcost),@l_fcttlcost=sum(qty*fcost),
								@l_item_count=count(*) from stdtl where branch=@lbranch and trtype=@ltrtype and ref=@lref
								and itemno=@litemno and unicode=@lunicode group by branch,trtype,ref,itemno,unicode having count(*)>1;
								if isnull(@l_item_count,0)>1 and isnull(@lttlqty,0)>0
								begin
								   set @l_pcslcost = @l_ttlcost/@lttlqty
								   if @l_fcttlcost>0 set @l_pcsfcost = @l_fcttlcost/@lttlqty
								end
								update stdtl set lcost = @l_pcslcost,fcost=@l_pcsfcost where branch=@ltobrno and trtype='01' and ref=@lbrxref 
								and itemno=@litemno and unicode=@lunicode
							end
							if @@error<>0
							begin
								rollback transaction
								set @errstatus=-1
								break
							end	
						end
------------------------------------------------------------------------------------------------------
					end  -- end of @stk_lcost>0
				end -- end of not (@ttp in (1,10,11,14,30,31))
				if @qty_binno<>0 or @ttp=14
				begin 
					select 	@l_pcslcost=lcost,@l_pcsfcost=fcost,@lttlqty=qty from stbins where 	
					branch=@lbranch and itemno=@litemno and unicode=@lunicode and whno=@lwhno and binno=@lbinno;
		            set @l_pcslcost =isnull(@l_pcslcost,0)
					set @l_pcsfcost =isnull(@l_pcsfcost,0)
					set @lttlqty =isnull(@lttlqty,0)
						
					if @ttp in (1,10,11) or (@ttp=46 And @lqty>0) or (@ttp=20 and len(@ltowhno)=0)
					begin
						if @lttlqty>0
						begin
							if @l_pcslcost>0
							set @l_pcslcost=Abs(((@l_pcslcost*@lttlqty)+Abs(@lqty*@llcost))/(@lttlqty+@lqty))
							else set @l_pcslcost=@llcost

							if isnull(@lfcost,0)<>0
							begin 
								if @l_pcsfcost>0
									set @l_pcsfcost=Abs(((@l_pcsfcost*@lttlqty)+Abs(@lqty*@lfcost))/(@lttlqty+@lqty))
								else set @l_pcsfcost=@lfcost
							end
							else 
							if isnull(@lfcy,'')<>''
							begin
								if  isnull(@lfcyrate,0)>0
									if @l_pcsfcost>0
									set @l_pcsfcost=Abs(((@l_pcsfcost*@lttlqty)+Abs(@lqty*(@llcost/@lfcyrate)))/(@lttlqty+@lqty))
									else set @l_pcsfcost=(@llcost/@lfcyrate);
								else 
								if isnull(@lcurfixrate,0)>0
									if @l_pcsfcost>0
										set @l_pcsfcost=Abs(((@l_pcsfcost*@lttlqty)+Abs(@lqty*(@llcost/@lcurfixrate)))/(@lttlqty+@lqty))
									else set @l_pcsfcost=(@llcost/@lcurfixrate)
							end
						end
						else
						begin
							set @l_pcslcost=@llcost
							if isnull(@lfcost,0)<>0  set @l_pcsfcost=@lfcost
							else if isnull(@lfcy,'')<>'' 
							begin
								if  isnull(@lfcyrate,0)>0 set @l_pcsfcost=@llcost/@lfcyrate
								else  if isnull(@lcurfixrate,0)>0 set @l_pcsfcost=@llcost/@lcurfixrate
							end
						end
					end
					else
					if @ttp=14
					begin
						set @l_pcslcost=@llcost
						set @l_pcsfcost=@lfcost
						set @qty_binno=0
---------------------- Added on 2023-10-26 AA to update the value of lprice , fprice & qty -----------------------------------------------------------
---------------------- Added on 2024-03-27 AA -----------------------------------------------------------------------
                         if @lasmtype=7
							update stdtl set qty=@lqty where branch=@lbranch and trtype=@ltrtype and
							ref=@lref and folio=@lfolio;
						 else
-----------------------------------------------------------------------------------------------------
							update stdtl set lprice=@llprice,fprice=@lfprice,qty=@lqty where branch=@lbranch and trtype=@ltrtype and
							ref=@lref and folio=@lfolio;

			         	if @@error<>0
						begin
							rollback transaction
							set @errstatus=-1
							break
						end
-----------------------------------------------------------------------------------------------------------------------------------------
					end
					else 
					if @l_pcslcost=0
					begin
					    set @l_pcslcost=iif(@stk_lcost<=0,@llcost,@stk_lcost)
						set @l_pcsfcost=iif(@stk_fcost<=0,@lfcost,@stk_fcost)
					end	
    
					update stbins set qty=qty+@qty_binno,lcost=@l_pcslcost, --iif(@stk_lcost=0,@llcost,@stk_lcost)
					fcost=@l_pcsfcost where    --iif(@stk_fcost=0,@lfcost,@stk_fcost)
					branch=@lbranch and itemno=@litemno and unicode=@lunicode and whno=@lwhno and binno=@lbinno;
					if @@error<>0
					begin
						rollback transaction
						set @errstatus=-1
						break
					end
					
				end		

				fetch next from crs1 into @ltrtype,@lref,@lfolio,@lqty,@llcost,@lfcost,@lisbrtrx,@lposted,@ltowhno
			    ,@ltobinno,@lfcyrate,@ltrdate,@lrcvdtrn,@lglref,@lbranch,@lwhno,@lbinno,@llprice,@lfprice,
				@ltobrno,@lbrxref, -- Added on 2023-10-24 AA
				@lasmtype; -- added on 2024-03-27 AA 
			end  -- end of crs1 inner loop
            CLOSE crs1
            DEALLOCATE crs1
			if @errstatus=-1
			break;

------------------------------------------------------

-----
------          update stbins qty and lcost
------

            if @lrunbal<>0 and  @stk_lcost<=0
			if  @only20type=0
			begin
				set @trxlcost=0
				set @trxfcost=0
				select @trxlcost=lastlcost,@trxfcost=lastfcost from stcosttype 
				where branch=@lbranch  and itemno=@litemno and unicode=@lunicode;
				if isnull(@trxlcost,0)=0
				begin
					select top 1 @trxlcost=lastlcost,@trxfcost=lastfcost from stcosttype 
					where  itemno=@litemno and unicode=@lunicode order by lstrcvdate desc,branch; 
				end
				if isnull(@trxlcost,0)>0
				begin
					set @stk_lcost=@trxlcost
					set @stk_fcost=isnull(@trxfcost,0)
				end
			end

			if @stk_lcost<=0 -- Modified on 2024-04-16 AA @stk_lcost=0
			if @lopenlcost>0 
			begin
			    set @stk_lcost=ABS(@lopenlcost)
				set @stk_fcost=ABS(@lopenfcost)
			end
			else if @lastcost>0 set @stk_lcost=@lastcost
------------ Added on 2023-01-07 AA get red of bad decimals ----------------------------
            if abs(@lrunbal)<1 and @lrunbal<>0 and cast(@lrunbal as numeric(20,4))=0
			 set @lrunbal=0.00
----------------------------------------------------------------------------------------
 
       
            update stunits set curbal=@lrunbal,lcost=@stk_lcost,fcost=@stk_fcost where 
			itemno=@litemno and unicode=@lunicode;
			if @@error<>0
			begin
				rollback transaction
				set @errstatus=-1
				break
			end
			commit transaction
			--else
		 --   begin
			--    update stbins set lcost=@stk_lcost,fcost=@stk_fcost where itemno=@litemno and unicode=@lunicode;
			--	if @@error<>0
			--	begin
			--		rollback transaction
			--		set @errstatus=-1
			--		break
			--	end
			--	else commit transaction
			--end
            fetch next from crs0 into @litemno,@lunicode,@lopenbal,@lopenlcost,@lopenfcost,@lfcy
		end  -- end of crs0 ourter loop
		CLOSE crs0;
        DEALLOCATE crs0;
		if @errstatus=-1 
		begin
		   if @@TRANCOUNT>0   rollback transaction
			return @errstatus
	    end
		else if @@TRANCOUNT>0 commit transaction
---

 
--		
		IF  EXISTS(SELECT * FROM sys.indexes WHERE object_id = object_id('dbo.stdtl') AND NAME ='xx100xxtemp')
		drop index 	xx100xxtemp on dbo.stdtl;
end


GO
/****** Object:  StoredProcedure [dbo].[WB_SALES_POS]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[WB_SALES_POS]
@fdate varchar(20) ,
@tdate varchar(20)


AS BEGIN
--------------------------------------------------Sales Summary by sales center 1
	select company,slcenter, SUM(IIF(invorrtrn='1', valafds -invdsvl , -(valafds -invdsvl))) as Invtotal ,dp_name as salescenter_Name
	from pos_hd with (nolock) inner join salecntr on pos_hd.company=salecntr.dp_brno and pos_hd.slcenter=salecntr.dp_dept
	where invorrtrn <>'4' and tdatetime between CAST(@fdate  AS smalldatetime) and CAST(@tdate AS smalldatetime)
	group by company,slcenter,dp_name ORDER BY company,slcenter 

END










GO
/****** Object:  StoredProcedure [dbo].[WB_SALES_SUMMARY]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[WB_SALES_SUMMARY]
@by_branch bit,
@m_Branch_code char(2),
@fdate char(8) ,
@tdate char(8),
@usr_showcost bit,
@cmb_wth_last_year bit

AS BEGIN
--------------------------------------------------Sales Summary by sales center 1
declare @showcost as int=0,
 @dynamicSQL as nvarchar(max)
 declare @dbc varchar(40),
 @paralist nvarchar(400)
 declare @yrcode char(2)
 DECLARE @lastYearCursor CURSOR
 declare @lfdate char(8),@ltdate char(8)
 set @showcost=iif(@usr_showcost=1,1,0) 
 set @dbc=DB_NAME()	

   declare @ldp_brno char(2)='',
   @ldp_dept char(2)='',
   @ldp_name varchar(40),
   @lslnet float = 0,
   @recnos int=0,
   @error int = 0
	if @cmb_wth_last_year = 1
	begin
	      set @showcost=0
		  set @yrcode=substring(@dbc,7,2)
		  set @dbc=substring(@dbc,1,6)+str(cast(@yrcode as int)-1,2)
		  set @lfdate=substring(@fdate,1,2)+str(cast(substring(@fdate,3,2) as int)-1,2)+substring(@fdate,5,4)
		  set @ltdate=substring(@tdate,1,2)+str(cast(substring(@tdate,3,2) as int)-1,2)+substring(@tdate,5,4)
	end
if @by_branch=0
begin
   create table dbo.#crntYear
   ( dp_brno char(2) not null,
     dp_dept char(2) not null,
	 dp_name varchar(40) not null,
	 slnet float null default 0,
	 slcst float null default 0,
	 Profit float null default 0
   )



   insert into dbo.#crntYear
	select dp_brno ,dp_dept ,dp_name ,slnet=sum(iif(invtype in ('04','06'),valafds-invdsvl,-(valafds-invdsvl))),
	slcst=round(sum(iif(invtype in ('04','06'),invcst,-invcst)),2)*@showcost,
	Profit=(sum(iif(invtype in ('04','06'),valafds-invdsvl,-(valafds-invdsvl)))-round(sum(iif(invtype in ('04','06'),invcst,-invcst)),2))*@showcost 
	from salecntr a inner join sales_hd b on a.dp_brno=b.company and a.dp_dept=b.slcenter
	where invdate between  @fdate and @tdate and dp_brno=@m_branch_code
	group by dp_brno,dp_dept,dp_name

	if @cmb_wth_last_year = 1
	begin

		  if exists(SELECT name FROM sys.databases where name=@dbc)
		  begin
		      set @paralist=N'@lastYearCursor CURSOR OUTPUT'
	          SET @dynamicSQL = 'SET @lastYearCursor = CURSOR FORWARD_ONLY STATIC FOR  
			    select dp_brno ,dp_dept ,dp_name ,slnet=sum(iif(invtype in (''04'',''06''),valafds-invdsvl,-(valafds-invdsvl)))
				from '+@dbc+'.dbo.salecntr a inner join '+@dbc+'.dbo.sales_hd b on a.dp_brno=b.company and a.dp_dept=b.slcenter
				where invdate between '''+ @lfdate+''' and '''+@ltdate+''' and dp_brno='''+@m_branch_code+'''
				group by dp_brno,dp_dept,dp_name ; OPEN @lastYearCursor'

				EXECUTE sp_executesql @dynamicSQL ,
				   N'@lastYearCursor CURSOR OUTPUT',
				   @lastYearCursor output

				FETCH NEXT FROM @lastYearCursor INTO @ldp_brno,@ldp_dept,@ldp_name,@lslnet
				WHILE @@FETCH_STATUS = 0
				BEGIN
					set @recnos=0
					select @recnos=count(*) from dbo.#crntYear where dp_brno= @ldp_brno and dp_dept=@ldp_dept
					set @recnos=isnull(@recnos,0)
					if @recnos=0
						insert into dbo.#crntYear (dp_brno,dp_dept,dp_name,slnet,slcst,Profit)
						values (@ldp_brno,@ldp_dept,@ldp_name,0,@lslnet,-@lslnet)
					else
						update dbo.#crntYear set slcst=@lslnet,Profit=slnet-@lslnet where dp_brno= @ldp_brno and dp_dept=@ldp_dept 
					if @@error<>0 
					begin
					    set @error = -1
						break
					end
					FETCH NEXT FROM @lastYearCursor INTO @ldp_brno,@ldp_dept,@ldp_name,@lslnet
				end
		        CLOSE @lastYearCursor
                DEALLOCATE @lastYearCursor
		  end
	end
	if @error=0 select * from dbo.#crntYear order by dp_brno,dp_dept
    DROP TABLE dbo.#crntYear
end
---------------------------------------------------Sales Summary by branches 2
else
	begin
		create table dbo.#crntYearB
	   (brnno char(2) not null,
		 name varchar(40) not null,
		 slnet float null default 0,
		 slcst float null default 0,
		 Profit float null default 0
	   )	
      insert into dbo.#crntYearB	
		select brnno ,name ,slnet=sum(iif(invtype in ('04','06'),valafds-invdsvl,-(valafds-invdsvl))),
		slcst=round(sum(iif(invtype in ('04','06'),invcst,-invcst)),2)*@showcost,
		Profit=(sum(iif(invtype in ('04','06'),valafds-invdsvl,-(valafds-invdsvl)))-round(sum(iif(invtype in ('04','06'),invcst,-invcst)),2))*@showcost 
		from stbranch a inner join sales_hd b on a.brnno=b.company 
		where invdate between  @fdate and @tdate 
		group by brnno,name

		if @cmb_wth_last_year = 1
		begin
			if exists(SELECT name FROM sys.databases where name=@dbc)
			begin
				set @paralist=N'@lastYearCursor CURSOR OUTPUT'
				SET @dynamicSQL = 'SET @lastYearCursor = CURSOR FORWARD_ONLY STATIC FOR  
				select brnno  ,name ,slnet=sum(iif(invtype in (''04'',''06''),valafds-invdsvl,-(valafds-invdsvl)))
				from '+@dbc+'.dbo.stbranch a inner join '+@dbc+'.dbo.sales_hd b on a.brnno=b.company
				where invdate between '''+ @lfdate+''' and '''+@ltdate+'''
				group by brnno,name ; OPEN @lastYearCursor'

				EXECUTE sp_executesql @dynamicSQL ,
					N'@lastYearCursor CURSOR OUTPUT',
					@lastYearCursor output

				FETCH NEXT FROM @lastYearCursor INTO @ldp_brno,@ldp_name,@lslnet
				WHILE @@FETCH_STATUS = 0
				BEGIN
					set @recnos=0
					select @recnos=count(*) from dbo.#crntYearB where brnno= @ldp_brno 
					set @recnos=isnull(@recnos,0)
					if @recnos=0
						insert into dbo.#crntYearB (brnno,name,slnet,slcst,Profit)
						values (@ldp_brno,@ldp_name,0,@lslnet,-@lslnet)
					else
						update dbo.#crntYearB set slcst=@lslnet,Profit=slnet-@lslnet where brnno= @ldp_brno  
					if @@error<>0 
					begin
						set @error = -1
						break
					end
					FETCH NEXT FROM @lastYearCursor INTO @ldp_brno,@ldp_name,@lslnet
				end
				CLOSE @lastYearCursor
				DEALLOCATE @lastYearCursor
			end
		end
		if @error=0 select * from dbo.#crntYearB order by brnno
		DROP TABLE dbo.#crntYearB
	END
end









GO
/****** Object:  StoredProcedure [dbo].[WB_Validate_User]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[WB_Validate_User]
      @Username VARCHAR(10),
      @Password VARCHAR(20)
AS
BEGIN
	SET NOCOUNT ON
	select username,fullname,passwordPDA,showcost  from sysuse where rtrim(username)=@Username and 
	convert(varchar(100),DecryptByPassPhrase('cickey', passwordPDA ))=@password and isnull([suspend],0)=0 and posuser=1 -- only for testing we use posuser instead of mobileuser=1

  --convert(varchar(100),DecryptByPassPhrase('cickey', passwordPDA ))
		
end
















GO
/****** Object:  StoredProcedure [dbo].[WBAP_Get_Supplier_Top20_items]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[WBAP_Get_Supplier_Top20_items]
(
@m_Branch_code char(2),@m_supp_code char(6),@fdate char(8) ,@tdate char(8),@fcy char(3))
AS BEGIN
	select top 20  v.cmbkey ,x.name ,
	sum(iif(src='05' and trdate between @fdate and @tdate,iif(trtype in ('04','06'),(qty+fqty),-(qty+fqty)),0)) as Top_sales ,
	openbal+
	 sum(iif(trtype in ('05','01','12','13','10','11','24','26'),(qty+fqty),-(qty+fqty))) as cur_bal
	from (supplier a inner join stitems x on a.cu_code= cast(rtrim(x.splycode) as char(6)) and a.cf_fcy=x.fcy
	and a.cu_company=@m_Branch_code
	inner join stunits v on x.itemno=v.itemno)
	left outer join stdtl b on v.itemno=b.itemno and b.unicode=b.unicode and b.branch=@m_Branch_code and trtype not in ('14','20')
	and trdate <= @tdate
	 where cu_company=@m_branch_code and cu_code=@m_supp_code and cf_fcy=@fcy
	group by  v.cmbkey,x.name,openbal having sum(iif(src='05',iif(trtype in ('04','06'),(qty+fqty),-(qty+fqty)),0))>0
	order by Top_sales desc 

END
--declare @m_Branch_code char(2)='01',
--        @m_supp_code char(6)='60',
--		@purchase_person char(2)='7'
--declare @fdate char(8) ='20110101',
--        @tdate char(8)='20150101'











GO
/****** Object:  StoredProcedure [dbo].[WBAP_Statement_Of_Account]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[WBAP_Statement_Of_Account]
(
@m_Branch_code char(2),@m_supp_code char(6),@fdate char(8) ,@tdate char(8),@fcy as char(3))
AS BEGIN
		declare @open_bal float =0,
		 @fcopen_bal float =0,
		@prd_openbal varchar(50)=''
		--@fcy char(3)=@prd_openbal -- can by used as input parameter for FCY and out put parameter as open period balace

		(select @open_bal=(cu_opnbal+sum(isnull(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt)),0))),
		@fcopen_bal=(cf_opnfcy+sum(isnull(iif(dt_dbcr='D',dt_fcamt-dt_fdscamt,-(dt_fcamt-dt_fdscamt)),0)))  
		from supplier Left Outer Join apdtl inner Join aphdr
		on  apdtl.dt_company=aphdr.hd_company and apdtl.dt_type=aphdr.hd_type and apdtl.dt_ref=aphdr.hd_ref
		and hd_date<@fdate
		on cu_company=dt_company and cu_code=dt_cucode and cf_fcy=dt_fcy
		where   cu_company=@m_branch_code and cu_code=@m_supp_code and cf_fcy=@fcy
		group by cu_company,cu_code,cf_fcy,cu_opnbal,cf_opnfcy)

		if len(rtrim(@fcy))>0
		begin
			set @prd_openbal=cast(@fcopen_bal as varchar(50))
			;
			with cte_openbal (cu_company ,cu_code ,cu_name,cf_fcy ,cu_openbal )
			as
			(select cu_company,cu_code,cu_name,cf_fcy,cf_opnfcy+sum(isnull(iif(dt_dbcr='D',dt_fcamt-dt_fdscamt,-(dt_fcamt-dt_fdscamt)),0)) as cu_openbal
			from supplier Left Outer Join apdtl inner Join aphdr
			on  apdtl.dt_company=aphdr.hd_company and apdtl.dt_type=aphdr.hd_type and apdtl.dt_ref=aphdr.hd_ref
			and hd_date<@fdate
			on cu_company=dt_company and cu_code=dt_cucode and cf_fcy=dt_fcy
			where   cu_company=@m_branch_code and cu_code=@m_supp_code and cf_fcy=@fcy
			group by cu_company,cu_code,cu_name,cf_fcy,cf_opnfcy)

			select dt_type ,dt_ref ,substring(dt_date,1,4)+'-'+substring(dt_date,5,2)+'-'+substring(dt_date,7,2) as dt_date  ,
			iif(dt_dbcr='D',dt_fcamt-dt_fdscamt,0) as dbtamt,iif(dt_dbcr='C',dt_fcamt-dt_fdscamt,0) as crtamt ,dt_desc ,
			cu_openbal+sum(iif(dt_dbcr='D',dt_fcamt-dt_fdscamt,-(dt_fcamt-dt_fdscamt))) over (order by dt_date,dt_type,dt_ref,dt_folio) as cur_bal,@prd_openbal as prd_openbalance
			from cte_openbal a inner join apdtl b on a.cu_company=b.dt_company and a.cu_code=b.dt_cucode and a.cf_fcy=b.dt_fcy
			where  dt_date between @fdate and @tdate
		end
		else
		begin
			set @prd_openbal=cast(@open_bal as varchar(50))
			;
			with cte_openbal (cu_company ,cu_code ,cu_name,cf_fcy ,cu_openbal )
			as
			(select cu_company,cu_code,cu_name,cf_fcy,cu_opnbal+sum(isnull(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt)),0)) as cu_openbal
			from supplier Left Outer Join apdtl inner Join aphdr
			on  apdtl.dt_company=aphdr.hd_company and apdtl.dt_type=aphdr.hd_type and apdtl.dt_ref=aphdr.hd_ref
			and hd_date<@fdate
			on cu_company=dt_company and cu_code=dt_cucode and cf_fcy=dt_fcy
			where   cu_company=@m_branch_code and cu_code=@m_supp_code and cf_fcy=@fcy
			group by cu_company,cu_code,cu_name,cf_fcy,cu_opnbal)

			select dt_type ,dt_ref ,substring(dt_date,1,4)+'-'+substring(dt_date,5,2)+'-'+substring(dt_date,7,2) as dt_date  ,
			iif(dt_dbcr='D',dt_lcamt-dt_discamt,0) as dbtamt,iif(dt_dbcr='C',dt_lcamt-dt_discamt,0) as crtamt ,dt_desc ,
				   cu_openbal+sum(iif(dt_dbcr='D',dt_lcamt,-dt_lcamt)) over (order by dt_date,dt_type,dt_ref,dt_folio) as cur_bal,@prd_openbal as prd_openbalance
			from cte_openbal a inner join apdtl b on a.cu_company=b.dt_company and a.cu_code=b.dt_cucode and a.cf_fcy=b.dt_fcy
			where  dt_date between @fdate and @tdate
		end

END











GO
/****** Object:  StoredProcedure [dbo].[WBAP_SupplierMovementSummary]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[WBAP_SupplierMovementSummary]
(
@m_Branch_code char(2),@m_supp_code char(6),@fdate char(8) ,@tdate char(8),@fcy as varchar(3),@vclass char(2),@usr_showcost bit )
AS BEGIN
	declare @showcost as int=0
    set @showcost=iif(@usr_showcost=1,1,0) 	
	if len(rtrim(@vclass))>0
	begin
		; with cte_suppOpenbal
		as
		(select cu_company,cu_code,cu_name,cu_opnbal,sum(isnull(iif(dt_dbcr='D',(dt_lcamt-dt_paidamt-dt_discamt),
		-(dt_lcamt-dt_paidamt-dt_discamt)),0)) as opntrxbal from supplier a left outer join apdtl b
		on a.cu_company=b.dt_company and a.cu_code=b.dt_cucode and dt_cucode<>'' and dt_date<@fdate
		where cu_company=@m_Branch_code and cu_class=@vclass
		group by cu_company,cu_code,cu_name,cu_opnbal
		)
	
		,cte_supp_trx
		as
		(select dt_company,dt_cucode,sum(isnull(iif(dt_trxsrc<>'07',iif(dt_dbcr='D',(dt_lcamt-dt_paidamt-dt_discamt),
		0),0),0.00)) as paidbal,
		sum(isnull(iif(dt_trxsrc<>'07',iif(dt_dbcr='C',(dt_lcamt-dt_paidamt-dt_discamt),
		0),0),0.00)) as crdtbal,
		 sum(isnull(iif(dt_trxsrc='07',iif(dt_dbcr='D',(dt_lcamt-dt_paidamt-dt_discamt),
		-(dt_lcamt-dt_paidamt-dt_discamt)),0),0.00)) as punet
		from apdtl a inner join cte_suppOpenbal b on a.dt_company=b.cu_company and a.dt_cucode=b.cu_code
		where dt_company=@m_Branch_code and dt_date between @fdate and @tdate
		group by dt_company,dt_cucode
		)
		,cte_sales_slcost
		as
		(select cu_company,cu_code,slnet=sum(iif(c.invtype in ('04','06'),(price*qty),-(price*qty))),
		slcost=sum(iif(c.invtype in ('04','06'),(c.cost*pkqty*(qty+fqty)),-(c.cost*pkqty*(qty+fqty)))),
		dsc= sum((invdsvl/valafds)*(price*qty)*(case when c.invtype in ('04','06') then 1 else -1 end))
		from cte_suppOpenbal a inner join stitems b on a.cu_code=cast(rtrim(splycode) as char(6))
		inner join sales_dt c 
		on b.itemno=c.itemno
		inner join sales_hd d on c.company=d.company and c.invtype=d.invtype and c.ref=d.ref
		where c.company=@m_Branch_code and splycode<>'' and splylcact=0 and valafds<>0 and c.invdate between @fdate and @tdate
		group by cu_company,cu_code
		)
		,cte_suppstockval
		as
		(select cu_company,cu_code,wval=sum(qty*lcost)
		from cte_suppOpenbal a inner join stitems b on a.cu_code=cast(rtrim(splycode) as char(6))
		inner join stbins c on b.itemno=c.itemno and a.cu_company=c.branch
		where c.branch=@m_Branch_code and splycode<>'' and splylcact=0
		group by cu_company,cu_code
		)
	
		select a.cu_code ,cu_name as name,cu_opnbal+isnull(opntrxbal,0) as openbal,
		isnull(punet,0) as punet,isnull(paidbal,0) as paidbal,isnull(crdtbal,0) adjustment,
		cu_opnbal+isnull(opntrxbal,0)+isnull(punet,0)+isnull(crdtbal,0)+isnull(paidbal,0) cur_bal,round(isnull(wval,0),2) whbal,
		cast(isnull(slnet,0)-isnull(dsc,0) as numeric(12,2)) as slnet,cast(isnull(slnet,0)-(isnull(slcost,0)+isnull(dsc,0)) as numeric(12,2))*@showcost as  slprofit
		from cte_suppOpenbal a left outer join cte_supp_trx b on a.cu_company=b.dt_company and a.cu_code=b.dt_cucode
		left outer join cte_sales_slcost c on a.cu_company=c.cu_company and a.cu_code=c.cu_code
		left outer join cte_suppstockval d on a.cu_company=d.cu_company and a.cu_code=d.cu_code 
		order by cast(a.cu_code as int)
	end
	else
	begin
		; with cte_suppOpenbal
		as
		(select cu_company,cu_code,cu_name,cu_opnbal,sum(isnull(iif(dt_dbcr='D',(dt_lcamt-dt_paidamt-dt_discamt),
		-(dt_lcamt-dt_paidamt-dt_discamt)),0)) as opntrxbal from supplier a left outer join apdtl b
		on a.cu_company=b.dt_company and a.cu_code=b.dt_cucode and dt_cucode<>'' and dt_date<@fdate
		where cu_company=@m_Branch_code 
		group by cu_company,cu_code,cu_name,cu_opnbal
		)
	
		,cte_supp_trx
		as
		(select dt_company,dt_cucode,sum(isnull(iif(dt_trxsrc<>'07',iif(dt_dbcr='D',(dt_lcamt-dt_paidamt-dt_discamt),
		0),0),0.00)) as paidbal,
		sum(isnull(iif(dt_trxsrc<>'07',iif(dt_dbcr='C',(dt_lcamt-dt_paidamt-dt_discamt),
		0),0),0.00)) as crdtbal,
		 sum(isnull(iif(dt_trxsrc='07',iif(dt_dbcr='D',(dt_lcamt-dt_paidamt-dt_discamt),
		-(dt_lcamt-dt_paidamt-dt_discamt)),0),0.00)) as punet
		from apdtl a inner join cte_suppOpenbal b on a.dt_company=b.cu_company and a.dt_cucode=b.cu_code
		where dt_company=@m_Branch_code and dt_date between @fdate and @tdate
		group by dt_company,dt_cucode
		)
		,cte_sales_slcost
		as
		(select cu_company,cu_code,slnet=sum(iif(c.invtype in ('04','06'),(price*qty),-(price*qty))),
		slcost=sum(iif(c.invtype in ('04','06'),(c.cost*pkqty*(qty+fqty)),-(c.cost*pkqty*(qty+fqty)))),
		dsc= sum((invdsvl/valafds)*(price*qty)*(case when c.invtype in ('04','06') then 1 else -1 end))
		from cte_suppOpenbal a inner join stitems b on a.cu_code=cast(rtrim(splycode) as char(6))
		inner join sales_dt c 
		on b.itemno=c.itemno
		inner join sales_hd d on c.company=d.company and c.invtype=d.invtype and c.ref=d.ref
		where c.company=@m_Branch_code and splycode<>'' and splylcact=0 and valafds<>0 and c.invdate between @fdate and @tdate
		group by cu_company,cu_code
		)
		,cte_suppstockval
		as
		(select cu_company,cu_code,wval=sum(qty*lcost)
		from cte_suppOpenbal a inner join stitems b on a.cu_code=cast(rtrim(splycode) as char(6))
		inner join stbins c on b.itemno=c.itemno and a.cu_company=c.branch
		where c.branch=@m_Branch_code and splycode<>'' and splylcact=0
		group by cu_company,cu_code
		)
	
		select a.cu_code ,cu_name as name,cu_opnbal+isnull(opntrxbal,0) as openbal,
		isnull(punet,0) as punet,isnull(paidbal,0) as paidbal,isnull(crdtbal,0) adjustment,
		cu_opnbal+isnull(opntrxbal,0)+isnull(punet,0)+isnull(crdtbal,0)+isnull(paidbal,0) cur_bal,round(isnull(wval,0),2) whbal,
		cast(isnull(slnet,0)-isnull(dsc,0) as numeric(12,2)) as slnet,cast(isnull(slnet,0)-(isnull(slcost,0)+isnull(dsc,0)) as numeric(12,2))*@showcost as  slprofit
		from cte_suppOpenbal a left outer join cte_supp_trx b on a.cu_company=b.dt_company and a.cu_code=b.dt_cucode
		left outer join cte_sales_slcost c on a.cu_company=c.cu_company and a.cu_code=c.cu_code
		left outer join cte_suppstockval d on a.cu_company=d.cu_company and a.cu_code=d.cu_code 
		order by cast(a.cu_code as int)
	end
END











GO
/****** Object:  StoredProcedure [dbo].[WBAR_CustomerMovementSummary]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[WBAR_CustomerMovementSummary]
(
@m_Branch_code char(2),@m_supp_code char(6),@fdate char(8) ,@tdate char(8),@fcy as varchar(3),@vclass char(12),@usr_showcost bit )
AS BEGIN
		declare @showcost as int=0
		set @showcost=iif(@usr_showcost=1,1,0) 		
		; with cte_clientOpenbal
		as
		(select cu_company,cu_code,cu_name,cu_opnbal,sum(isnull(iif(dt_dbcr='D',(dt_lcamt-dt_paidamt-dt_discamt),
		-(dt_lcamt-dt_paidamt-dt_discamt)),0)) as opntrxbal from customer a left outer join ardtl b
		on a.cu_company=b.dt_company and a.cu_code=b.dt_cucode and dt_cucode<>'' and dt_date<@fdate
		where cu_company=@m_Branch_code 
		group by cu_company,cu_code,cu_name,cu_opnbal
		)
		,cte_client_trx
		as
		(select dt_company,dt_cucode,sum(isnull(iif(dt_trxsrc<>'05',iif(dt_dbcr='C',(dt_lcamt-dt_paidamt-dt_discamt),
		0),0),0.00)) as rcvdbal,
		sum(isnull(iif(dt_trxsrc<>'05',iif(dt_dbcr='D',(dt_lcamt-dt_paidamt-dt_discamt),
		0),0),0.00)) as dbtbal,
		 sum(isnull(iif(dt_trxsrc='05',iif(dt_dbcr='D',(dt_lcamt-dt_paidamt-dt_discamt),
		-(dt_lcamt-dt_paidamt-dt_discamt)),0),0.00)) as slnet
		from ardtl a inner join cte_clientOpenbal b on a.dt_company=b.cu_company and a.dt_cucode=b.cu_code
		where dt_company=@m_Branch_code and dt_date between @fdate and @tdate
		group by dt_company,dt_cucode
		)
		,cte_slprofit
		as
		(select company,custno,slprofit=sum(iif(invtype='04',(valafds-invdsvl-invcst),-(valafds-invdsvl-invcst)))
		from sales_hd a inner join cte_clientOpenbal b
		on a.company=b.cu_company and a.custno=b.cu_code
		where company=@m_Branch_code and invtype in ('04','24') and invdate between @fdate and @tdate
		group by company,custno
		)
		select cu_code ,cu_name ,cu_opnbal+isnull(opntrxbal,0) as openbal,
		slnet ,rcvdbal ,dbtbal as adjustment,round(slprofit,2)*@showcost as slprofit,
		cu_opnbal+isnull(opntrxbal,0)+slnet+dbtbal-rcvdbal cur_bal
		from cte_clientOpenbal a left outer join cte_client_trx b on a.cu_company=b.dt_company and a.cu_code=b.dt_cucode
		left outer join cte_slprofit c on a.cu_company=c.company and a.cu_code=c.custno
		order by cast(cu_code as int)

END











GO
/****** Object:  StoredProcedure [dbo].[WBAR_CustomersBalances]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

---- This variable @m_Branch_code must be retrevied at the login screen level from the branch field
CREATE PROC [dbo].[WBAR_CustomersBalances](@m_Branch_code char(2),@m_classcode char(2)  )
as begin
if @m_classcode<>''
begin
	select cu_code ,cu_name ,cu_mobile ,cu_tel ,cu_opnbal+
	 isnull(sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))),0) as cur_bal
	from customer a left outer join ardtl b on a.cu_company=b.dt_company and a.cu_code=b.dt_cucode and a.cf_fcy=b.dt_fcy
	 and dt_cucode<>''
	 where cu_company=@m_Branch_code and cu_class=@m_classcode
	group by cu_company,cu_code,cf_fcy,cu_name,cu_mobile,cu_tel,cu_opnbal
	having cu_opnbal+isnull(sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))),0)>0
	order by cu_name
end
else
begin
  	select cu_code ,cu_name ,cu_mobile ,cu_tel ,cu_opnbal+
	 isnull(sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))),0) as cur_bal
	from customer a left outer join ardtl b on a.cu_company=b.dt_company and a.cu_code=b.dt_cucode and a.cf_fcy=b.dt_fcy
	 and dt_cucode<>''
	 where cu_company=@m_Branch_code
	group by cu_company,cu_code,cf_fcy,cu_name,cu_mobile,cu_tel,cu_opnbal
	having cu_opnbal+isnull(sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))),0)>0
	order by cu_name
end
end 











GO
/****** Object:  StoredProcedure [dbo].[WBAR_Statement_Of_Account]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[WBAR_Statement_Of_Account]
(
@m_Branch_code char(2),@m_supp_code char(6),@fdate char(8) ,@tdate char(8),@prd_openbal as varchar(50) output )
AS BEGIN
		declare @open_bal float =0,
		@fcy char(3)=@prd_openbal -- can by used as input parameter for FCY and out put parameter as open period balace

		(select @open_bal=(cu_opnbal+sum(isnull(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt)),0))) 
		from customer Left Outer Join ardtl inner Join arhdr
		on  ardtl.dt_company=arhdr.hd_company and ardtl.dt_type=arhdr.hd_type and ardtl.dt_ref=arhdr.hd_ref
		and hd_date<@fdate
		on cu_company=dt_company and cu_code=dt_cucode and cf_fcy=dt_fcy
		where   cu_company=@m_branch_code and cu_code=@m_supp_code
		group by cu_company,cu_code,cu_name,cu_opnbal)

		set @prd_openbal=cast(@open_bal as varchar(50))
		;
		with cte_openbal (cu_company ,cu_code ,cu_name ,cu_openbal )
		as
		(select cu_company,cu_code,cu_name,cu_opnbal+sum(isnull(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt)),0)) as cu_openbal
		from customer Left Outer Join ardtl inner Join arhdr
		on  ardtl.dt_company=arhdr.hd_company and ardtl.dt_type=arhdr.hd_type and ardtl.dt_ref=arhdr.hd_ref
		and hd_date<@fdate
		on cu_company=dt_company and cu_code=dt_cucode and cf_fcy=dt_fcy
		where   cu_company=@m_branch_code and cu_code=@m_supp_code
		group by cu_company,cu_code,cu_name,cu_opnbal)

		select dt_type ,dt_ref ,substring(dt_date,1,4)+'-'+substring(dt_date,5,2)+'-'+substring(dt_date,7,2) as dt_date  ,
		iif(dt_dbcr='D',dt_lcamt,0) as dbtamt,iif(dt_dbcr='C',dt_lcamt,0) as crtamt ,dt_desc ,
			   cu_openbal+sum(iif(dt_dbcr='D',dt_lcamt,-dt_lcamt)) over (order by dt_date,dt_type,dt_ref,dt_folio) as cur_bal,@prd_openbal as prd_openbalance
		from cte_openbal a inner join ardtl b on a.cu_company=b.dt_company and a.cu_code=b.dt_cucode 
		where  dt_date between @fdate and @tdate

END











GO
/****** Object:  StoredProcedure [dbo].[WBSL_GET_ITEM_BR_SUMMARY]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[WBSL_GET_ITEM_BR_SUMMARY]
(
@m_cmbkey char(24))
AS BEGIN
	;with cte_Openbal (branch,name,openbal)
	as
	(select a.brnno as branch,a.name,Sum(isnull(d.openbal,0)) as openbal
	from stbranch a left outer join stbins d on a.brnno=d.branch inner join stunits c
	on d.itemno=c.itemno and d.unicode=c.unicode and c.cmbkey=@m_cmbkey  
	group by a.brnno,a.name
	)

	,ctr_trxbal
	as
	(select stdtl.branch,
		   rcvtrx=sum(case when stdtl.trtype in ('01','02','11','10','31','30') then (case when stdtl.trtype in ('01','11','10')
		   then qty+fqty else -(qty+fqty) end) else 0.00 end),
		   rtntrx=sum(case  when stdtl.trtype in ('24','26') then qty+fqty else 0.00 end),
		   slstrx=sum(case  when stdtl.trtype in ('04','06') then qty+fqty else 0.00 end),
		   isstrx=sum(case when stdtl.trtype in ('05','09') then (case when stdtl.trtype='09' then qty+fqty else -(qty+fqty) end) else 0.00 end),
		   adjtrx=sum(case when stdtl.trtype in ('13','20','12','46') then (case when stdtl.trtype='20' and tobinno<>'+' 
		   then -qty else qty end) else 0.00 end)
		   from stitems inner Join stunits inner join stdtl inner Join sthdr
		   on stdtl.branch=sthdr.branch and stdtl.trtype=sthdr.trtype and stdtl.ref=sthdr.ref
		   on stunits.itemno=stdtl.itemno and stunits.Unicode=stdtl.Unicode
		   on stitems.itemno=stunits.itemno
		   where stdtl.cmbkey=@m_cmbkey
		   group by stdtl.branch
	)

	select a.branch,name,isnull(openbal,0) as prdopenbal,isnull(rcvtrx,0) as purchase_qty,isnull(rtntrx,0) as sales_rtn_qty,
	isnull(isstrx,0) as Isstrx_qty,isnull(slstrx,0) as sales_qty,
	isnull(adjtrx,0) as adjustment,
	openbal+isnull(rcvtrx,0)+isnull(rtntrx,0)-isnull(slstrx,0)+isnull(adjtrx,0)-isnull(isstrx,0) as current_balance
	from cte_openbal a left outer join ctr_trxbal b on a.branch=b.branch 
END











GO
/****** Object:  StoredProcedure [dbo].[z_getdte]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[z_getdte](
  @ret char(10))
  as begin
	SELECT DBO.Z_convert_2_hirji(@ret)
 end 

















GO
/****** Object:  StoredProcedure [dbo].[Z_INVOICE_ITEM_BALANCE]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROC [dbo].[Z_INVOICE_ITEM_BALANCE]
(@m_Branch_code char(2),@m_splyinv char(10),@m_supp_code char(6))
AS BEGIN

;with cte_splyinv (splyinv,splycode,invdate,cmbkey,company,lcost,qty,invtype,ref,itemno,unicode)
as
(select  a.splyinv,a.custno as splycode,a.invdate ,b.cmbkey,a.company,lcost,
sum(iif(b.invtype in ('10','11'),(b.qty+b.fqty),-(b.qty+b.fqty))*pkqty) as qty
,a.invtype,a.ref,b.itemno,b.unicode
 from puhdr a inner join pudtl b on a.company=b.company and a.invtype=b.invtype and a.ref=b.ref
 inner join stdtl c on b.company=c.branch and b.invtype=c.trtype and b.ref=c.ref and b.itemno=c.itemno 
 and b.unicode=c.unicode and b.folio = c.folio
 where a.company=@m_Branch_code and a.custno=@m_supp_code and a.splyinv=@m_splyinv
 group by a.company,a.custno,a.splyinv,b.cmbkey,a.invtype,a.ref,b.itemno,b.unicode,a.invdate,lcost
)
,cte_solditems 
as
(select d.itemno,d.unicode,sum(iif(d.invtype in ('04','06'),d.qty+d.fqty,-(d.qty+d.fqty))*pkqty) as slqty,
 sum(iif(d.invtype in ('04','06'),d.qty,-d.qty)*d.price) as ttlprice,
 sum(iif(d.invtype in ('04','06'),d.qty+d.fqty,-(d.qty+d.fqty))*d.cost) as ttlcost
 from sales_dt d inner join cte_splyinv on d.itemno=cte_splyinv.itemno and d.unicode=cte_splyinv.unicode
 where d.company=@m_Branch_code and d.invdate>=cte_splyinv.invdate
 group by d.itemno,d.unicode
)
select cmbkey,stitems.name,cast(qty as numeric(12,2)) as purchase_qty,round(lcost,3) as Purchase_price,
round(qty*lcost,3) as Total_purchase,cast(iif(slqty>qty,qty,slqty) as numeric(12,2)) as SoldQty,
cast(ttlprice/iif(slqty<>0,slqty,1) as numeric(12,2)) as UnitPrice,
cast((ttlprice/iif(slqty<>0,slqty,1))*iif(slqty>qty,qty,slqty) as numeric(12,2)) as totalSales,
cast(qty-iif(isnull(slqty,0)>qty,qty,isnull(slqty,0)) as numeric(12,2)) balance,
cast(((ttlprice/iif(slqty<>0,slqty,1))-lcost)*iif(slqty>qty,qty,slqty) as numeric(12,2))as profit,
cast(qty-iif(slqty>qty,qty,slqty) as numeric(12,2))*round(lcost,3) as CostRemaining
 from cte_splyinv v left outer join cte_solditems x
on v.itemno=x.itemno and v.unicode=x.unicode
left outer join stitems on stitems.itemno=v.itemno
END 











GO
/****** Object:  StoredProcedure [dbo].[Z_Itembalancesforspecificsupplier]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[Z_Itembalancesforspecificsupplier](@m_Branch_code char(2),@m_supp_code  char(6),@fcy char(3) )
as begin
select v.cmbkey ,x.name ,openbal ,
sum(iif(src='07',iif(trtype in ('10','11'),(qty+fqty),-(qty+fqty)),0)) purchase,
sum(iif(src='05',iif(trtype in ('04','06'),(qty+fqty),-(qty+fqty)),0)) sales,
sum(iif(trtype in ('12','13'),(qty+fqty),0)) adjustment,
sum(iif(trtype in ('05','09','01','02'),iif(trtype in ('05','01'),(qty+fqty),-(qty+fqty)),0)) rcvd_issue,
openbal+ sum(isnull(iif(trtype in ('05','01','12','13','10','11','24','26'),(qty+fqty),-(qty+fqty)),0)) cur_bal
from (supplier a inner join stitems x on a.cu_code= cast(rtrim(x.splycode) as char(6)) and a.cf_fcy=x.fcy
 and a.cu_company=@m_Branch_code
inner join stunits v on x.itemno=v.itemno)
left outer join stdtl b on v.itemno=b.itemno and b.unicode=b.unicode and b.branch=@m_Branch_code and trtype not in ('14','20')
 where cu_company=@m_branch_code and cu_code=@m_supp_code and cf_fcy=@fcy
group by  v.cmbkey,x.name,openbal
having openbal+ sum(isnull(iif(trtype in ('05','01','12','13','10','11','24','26'),(qty+fqty),-(qty+fqty)),0))<>0
order by sales desc
end











GO
/****** Object:  StoredProcedure [dbo].[Z_Purchase_represtative_Person_Summary]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[Z_Purchase_represtative_Person_Summary]
(
@m_Branch_code char(2),@m_supp_code char(6),@purchase_person char(2),@fdate char(8) ,@tdate char(8))
AS BEGIN
;with cte_Openbal (cmbkey,name,itemno,unicode,openbal)
as
(select c.cmbkey,b.name,a.itemno,c.unicode,Sum(isnull(d.openbal,0)) as openbal
from puprsnitems a inner join stitems b on a.itemno=b.itemno inner join stunits c on b.itemno=c.itemno
left outer join stbins d on c.itemno=d.itemno and c.unicode=d.unicode
where slcode=@purchase_person and branch=@m_Branch_code and splycode=@m_supp_code
group by cmbkey,a.itemno,c.unicode,b.name 
)
,cte_trxOpnbal
as
(select d.itemno,d.unicode,topenbal=sum(isnull(iif(trtype in ('05','01','12','13','10','11','24','26'),(qty+fqty),-(qty+fqty)),0))
from  stdtl d inner join cte_Openbal f on d.itemno=f.itemno and d.unicode=f.unicode
where d.trdate<@fdate
group by d.itemno,d.unicode
)
,ctr_curntbal
as
(select d.itemno,d.unicode,purchasebal=sum(iif(src='07',iif(trtype in ('10','11'),(qty+fqty),-(qty+fqty)),0)),
salesbal=sum(iif(src='05',iif(trtype in ('04','06'),(qty+fqty),-(qty+fqty)),0)),
adjbal=sum(iif(trtype in ('12','13'),(qty+fqty),0)),
inoutbal=sum(iif(trtype in ('05','09','01','02'),iif(trtype in ('05','01'),(qty+fqty),-(qty+fqty)),0))
from  stdtl d inner join cte_Openbal f on d.itemno=f.itemno and d.unicode=f.unicode
where d.trdate between @fdate and @tdate
group by d.itemno,d.unicode
)
select cmbkey,name,openbal+isnull(topenbal,0) as prdopenbal,isnull(purchasebal,0) purchase_qty,isnull(adjbal,0) as adjustment,
isnull(inoutbal,0) as InOut,isnull(salesbal,0) as sales_qty,openbal+isnull(topenbal,0)+isnull(purchasebal,0)
+isnull(adjbal,0)+isnull(inoutbal,0)-isnull(salesbal,0) as current_balance
from ((cte_openbal a left outer join cte_trxOpnbal b on a.itemno=b.itemno and a.unicode=b.unicode)
left outer join ctr_curntbal c on a.itemno=c.itemno and a.unicode=c.unicode)

END
--declare @m_Branch_code char(2)='01',
--        @m_supp_code char(6)='60',
--		@purchase_person char(2)='7'
--declare @fdate char(8) ='20110101',
--        @tdate char(8)='20150101'











GO
/****** Object:  StoredProcedure [dbo].[Z_SALES_SUMMARY]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[Z_SALES_SUMMARY]
@by_branch bit,
@m_Branch_code char(2),
@fdate char(8) ,
@tdate char(8),
@usr_showcost bit

AS BEGIN
--------------------------------------------------Sales Summary by sales center 1
declare @showcost as int=0
set @showcost=iif(@usr_showcost=1,1,0) 

if @by_branch=0
-- select dp_brno 'رمز الفرع',dp_dept 'رمز مركز البيع',dp_name 'اسم مركز البيع',slnet=sum(iif(invtype in ('04','06'),valafds-invdsvl,-(valafds-invdsvl))),
	select dp_brno ,dp_dept ,dp_name ,slnet=sum(iif(invtype in ('04','06'),valafds-invdsvl,-(valafds-invdsvl))),
	slcst=round(sum(iif(invtype in ('04','06'),invcst,-invcst)),2)*@showcost,
	Profit=(sum(iif(invtype in ('04','06'),valafds-invdsvl,-(valafds-invdsvl)))-round(sum(iif(invtype in ('04','06'),invcst,-invcst)),2))*@showcost 
	from salecntr a inner join sales_hd b on a.dp_brno=b.company and a.dp_dept=b.slcenter
	where invdate between  @fdate and @tdate and dp_brno=@m_branch_code
	group by dp_brno,dp_dept,dp_name

---------------------------------------------------Sales Summary by branches 2
else
	--select brnno 'رمز الفرع',name 'اسم الفرع',slnet=sum(iif(invtype in ('04','06'),valafds-invdsvl,-(valafds-invdsvl))),
	select brnno ,name ,slnet=sum(iif(invtype in ('04','06'),valafds-invdsvl,-(valafds-invdsvl))),
	slcst=round(sum(iif(invtype in ('04','06'),invcst,-invcst)),2)*@showcost,
	Profit=(sum(iif(invtype in ('04','06'),valafds-invdsvl,-(valafds-invdsvl)))-round(sum(iif(invtype in ('04','06'),invcst,-invcst)),2))*@showcost 
	from stbranch a inner join sales_hd b on a.brnno=b.company 
	where invdate between  @fdate and @tdate 
	group by brnno,name
END










GO
/****** Object:  StoredProcedure [dbo].[Z_Sales_Summary_by_Categories]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC  [dbo].[Z_Sales_Summary_by_Categories](
@m_branch_code char(2),@class_level int, -- 1 to 5
		@syscode int,
		@fdate char(8),
		@tdate char(8),
        @usr_showcost bit)
AS BEGIN
--@class_code char(12)='',
DECLARE   @class_len int 
declare @showcost as int=0
set @showcost=iif(@usr_showcost=1,1,0) 

if @class_level<4
set @class_len=@class_level*2
else if @class_level=4 set @class_len=9
else set @class_len=12

if @syscode in (1,4,5)
	select Substring(stitems.classkey,1,@class_len) classkey,(select name from stclass where rtrim(cmbkey)=Substring(stitems.classkey,1,@class_len))name,
	slprice=sum(case when sales_dt.invtype in ('04','06') then (sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100))) else -(sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100))) end),
	slcst=sum(case when sales_dt.invtype in ('04','06') then sales_dt.cost*(qty+fqty)*pkqty else -sales_dt.cost*(qty+fqty)*pkqty end)*@showcost,
	dsc= sum((invdsvl/valafds)*(sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100)))*(case when sales_hd.invtype in ('04','06') then 1 else -1 end))
	FROM  STITEMS inner join stunits inner Join sales_dt inner Join sales_hd
	on sales_dt.company=sales_hd.company and sales_dt.invtype=sales_hd.invtype and sales_dt.ref=sales_hd.ref
	on stunits.itemno=sales_dt.itemno and stunits.Unicode=sales_dt.Unicode
	on stitems.itemno=stunits.itemno
	where  valafds<> 0 and sales_hd.invdate between  @fdate and @tdate and sales_hd.company=@m_branch_code
	group by Substring(stitems.classkey,1,@class_len)
	order by Substring(stitems.classkey,1,@class_len)
else
if @syscode=6 --or No rounding
	select Substring(stitems.classkey,1,@class_len) classkey,(select name from stclass where rtrim(cmbkey)=Substring(stitems.classkey,1,@class_len))name ,
	slprice=sum(case when sales_dt.invtype in ('04','06') then(sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100))-sales_dt.imfcval)
	 else -(sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100))-sales_dt.imfcval) end),
	slcst=sum(case when sales_dt.invtype in ('04','06') then sales_dt.cost*(qty+fqty)*pkqty else -sales_dt.cost*(qty+fqty)*pkqty end)*@showcost,
	dsc= sum((invdsvl/valafds)*(sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100))-sales_dt.imfcval)*(case when sales_hd.invtype in ('04','06') then 1 else -1 end))
	FROM  STITEMS inner join stunits inner Join sales_dt inner Join sales_hd
	on sales_dt.company=sales_hd.company and sales_dt.invtype=sales_hd.invtype and sales_dt.ref=sales_hd.ref
	on stunits.itemno=sales_dt.itemno and stunits.Unicode=sales_dt.Unicode
	on stitems.itemno=stunits.itemno
	where  valafds<> 0 and sales_hd.invdate between  @fdate and @tdate and sales_hd.company=@m_branch_code
	group by Substring(stitems.classkey,1,@class_len)
	order by Substring(stitems.classkey,1,@class_len)
else
if @syscode in (2,3)
	select Substring(stitems.classkey,1,@class_len) classkey,(select name from stclass where rtrim(cmbkey)=Substring(stitems.classkey,1,@class_len)) name,
	slprice=sum(case when sales_dt.invtype in ('04','06') then(sales_dt.QTY*(sales_dt.price-floor(sales_dt.price*sales_dt.discpc/100))-sales_dt.imfcval)
	 else -(sales_dt.QTY*(sales_dt.price-floor(sales_dt.price*sales_dt.discpc/100))-sales_dt.imfcval) end),
	slcst=sum(case when sales_dt.invtype in ('04','06') then sales_dt.cost*(qty+fqty)*pkqty else -sales_dt.cost*(qty+fqty)*pkqty end)*@showcost,
	dsc= sum((invdsvl/valafds)*(sales_dt.QTY*(sales_dt.price-(sales_dt.price*sales_dt.discpc/100))-sales_dt.imfcval)*(case when sales_hd.invtype in ('04','06') then 1 else -1 end))
	FROM  STITEMS inner join stunits inner Join sales_dt inner Join sales_hd
	on sales_dt.company=sales_hd.company and sales_dt.invtype=sales_hd.invtype and sales_dt.ref=sales_hd.ref
	on stunits.itemno=sales_dt.itemno and stunits.Unicode=sales_dt.Unicode
	on stitems.itemno=stunits.itemno
	where  valafds<> 0 and sales_hd.invdate between  @fdate and @tdate and sales_hd.company=@m_branch_code
	group by Substring(stitems.classkey,1,@class_len)
	order by Substring(stitems.classkey,1,@class_len)
	END 











GO
/****** Object:  StoredProcedure [dbo].[Z_SuppliersBalances]    Script Date: 2025-11-13 12:21:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

---- This variable @m_Branch_code must be retrevied at the login screen level from the branch field
CREATE PROC [dbo].[Z_SuppliersBalances](@m_Branch_code char(2),@m_classcode char(2) , @fcy char(2))
as begin
if @m_classcode<>''
begin
	select cu_code ,cu_name ,cu_tel ,
	format(cast(max(iif(dt_dbcr='D' and dt_type<>'30',dt_date,'')) as int),'####-##-##') lastrcvdate,
	sum(iif(dt_trxsrc='07',iif(dt_type in ('10','11'),(dt_lcamt-dt_discamt),-(dt_lcamt-dt_discamt)),0)) punet,
	(select sum(iif(src='05',iif(trtype in ('04','06'),lcost*qty,-(lcost*qty)),0))
	 from stdtl d inner join stitems f on d.itemno=f.itemno
	where a.cu_company=branch  and cast(rtrim(splycode) as char(6))=a.cu_code  
	group by branch,splycode) slnet,
	-(cu_opnbal+
	 isnull(sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))),0)) cur_bal
	from supplier a left outer join apdtl b on a.cu_company=b.dt_company and a.cu_code=b.dt_cucode and a.cf_fcy=b.dt_fcy
	 and dt_cucode<>''
	where cu_company=@m_Branch_code and cu_class=@m_classcode and cf_fcy=@fcy
	group by  cu_company,cu_code,cu_name,cu_mobile,cu_tel,cu_opnbal
	having a.cu_opnbal+isnull(sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))),0)<0
	order by a.cu_name
end
else
begin
	select cu_code ,cu_name ,cu_tel ,
	format(cast(max(iif(dt_dbcr='D' and dt_type<>'30',dt_date,'')) as int),'####-##-##') lastrcvdate,
	sum(iif(dt_trxsrc='07',iif(dt_type in ('10','11'),(dt_lcamt-dt_discamt),-(dt_lcamt-dt_discamt)),0)) punet,
	(select sum(iif(src='05',iif(trtype in ('04','06'),lcost*qty,-(lcost*qty)),0))
	 from stdtl d inner join stitems f on d.itemno=f.itemno
	where a.cu_company=branch and cast(rtrim(splycode) as char(6))=a.cu_code  
	group by branch,splycode) slnet,
	-(cu_opnbal+
	 isnull(sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))),0)) cur_bal
	from supplier a left outer join apdtl b on a.cu_company=b.dt_company and a.cu_code=b.dt_cucode and a.cf_fcy=b.dt_fcy
	 and dt_cucode<>''
	where cu_company=@m_Branch_code and cf_fcy=@fcy
	group by  cu_company,cu_code,cu_name,cu_mobile,cu_tel,cu_opnbal
	having a.cu_opnbal+isnull(sum(iif(dt_dbcr='D',dt_lcamt-dt_discamt,-(dt_lcamt-dt_discamt))),0)<0
	order by a.cu_name
end
end 











GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'This can be used for Rebate losses Account' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'apclass', @level2type=N'COLUMN',@level2name=N'cl_salser'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'0 =modified   1= deleted' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'delchghdr', @level2type=N'COLUMN',@level2name=N'action_type'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'1= Active 2= Inactive' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'expense', @level2type=N'COLUMN',@level2name=N'expstatus'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'1 = constant  2=variable' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'expense', @level2type=N'COLUMN',@level2name=N'exptype'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'1 = constant  2=variable' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'exporders_dt', @level2type=N'COLUMN',@level2name=N'exptype'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'1=Under review 2=accepted  3= rejected 4-transfer' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'exporders_dt', @level2type=N'COLUMN',@level2name=N'expaction'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'1=accepted 2=rejected' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'exporders_dt', @level2type=N'COLUMN',@level2name=N'transfaction'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'1=accepted 2=rejected' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'exporders_dt', @level2type=N'COLUMN',@level2name=N'expstatus'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'1= Auto distribute cost center 2= Manual ' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'exporders_dt', @level2type=N'COLUMN',@level2name=N'cstcntrtype'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'1= Branch  2= Head Office  3= Warehouse' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'freplicate', @level2type=N'COLUMN',@level2name=N'brtype'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'is updated by branch for the actual qty received' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'fsiss_dt', @level2type=N'COLUMN',@level2name=N'qtyrcv'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'is update each time qty sent to branch when genrate the TRX' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'fsiss_dt', @level2type=N'COLUMN',@level2name=N'qtysent'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'0 = not processed yes 1=under processing (collecting items) 2=prcessed partialy 3= processed all' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'fsiss_hd', @level2type=N'COLUMN',@level2name=N'ostatus'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'the actual qty received by the branch against TRX' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'fsrcv_dt', @level2type=N'COLUMN',@level2name=N'qtyrcv'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'used to store the REQUESTED ORDER NO' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'fsrcv_hd', @level2type=N'COLUMN',@level2name=N'glref'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'0= not checked 1=match  2= not match with no TRX 3= not match with generate TRX for the differnces' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'fsrcv_hd', @level2type=N'COLUMN',@level2name=N'ostatus'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'name of the user of make the qty check ' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'fsrcv_hd', @level2type=N'COLUMN',@level2name=N'usrchkid'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'Hold the Issue Voucher Number of shortage qty in the branch recipient' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'fsrcv_hd', @level2type=N'COLUMN',@level2name=N'shrt_vchr'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'Hold the Issue Voucher Number of excess qty in the Branch Sender' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'fsrcv_hd', @level2type=N'COLUMN',@level2name=N'excess_vchr'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'1= as selected and must select at least one warehouse selected
 2=all branch warehouses ( must not select any ware house)
3=No warehouse 
4=' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'glcstctr', @level2type=N'COLUMN',@level2name=N'whtype'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'حساب تخفيضات' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'glsction', @level2type=N'COLUMN',@level2name=N'rebate_act'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'حساب خسائر التخفيضات' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'glsction', @level2type=N'COLUMN',@level2name=N'lossRebateAct'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'if this field is on that means the invoice is retreived back to pos_hd & pos_dt' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'invhstry', @level2type=N'COLUMN',@level2name=N'retreived'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'1=Issue fash 2=process Fash to send 3=Fash confirmation' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'notifyMe', @level2type=N'COLUMN',@level2name=N'mode'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'user name to notify him' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'notifyMe', @level2type=N'COLUMN',@level2name=N'usrnotify'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'used for AR AP GL PU SL as start date to notify' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'notifyMe', @level2type=N'COLUMN',@level2name=N'datenotify'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'If OFF there is No notify if ON notify for login action only' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'notifyMe', @level2type=N'COLUMN',@level2name=N'inactive'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'True When sms is sent ' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'notifyMe', @level2type=N'COLUMN',@level2name=N'smsdone'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'True when email is sent' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'notifyMe', @level2type=N'COLUMN',@level2name=N'emaildone'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'True Auto generate journal voucher' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'notifyMe', @level2type=N'COLUMN',@level2name=N'autojv'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'1=anual quarter 2=monthly 3=half month 4=weekly 5=daily' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'notifyMe', @level2type=N'COLUMN',@level2name=N'ntperiod'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'mnthly 1-12 , hfmnth 1-2 , weekly 1-4' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'notifyMe', @level2type=N'COLUMN',@level2name=N'lastprdgnr'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'to stop jv from aut generation' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'notifyMe', @level2type=N'COLUMN',@level2name=N'stop_jv'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'sum all samerial items (qty & price) in the invoice for reporting only' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'pos_ctr', @level2type=N'COLUMN',@level2name=N'rpt_grp_items'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'total sales of card accumulative' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'pos_dsc', @level2type=N'COLUMN',@level2name=N'cust_ttlsales'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'total points given to the customer by issuing points payments card' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'pos_dsc', @level2type=N'COLUMN',@level2name=N'ttl_grantd'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'the original amount of the points payment voucher' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'pos_dsc', @level2type=N'COLUMN',@level2name=N'vchr_value'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'the amount used from the original points payment voucher' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'pos_dsc', @level2type=N'COLUMN',@level2name=N'vchr_used'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'for poinrs payment card this is the original customer card who the card points issued for' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'pos_dsc', @level2type=N'COLUMN',@level2name=N'mothercard'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'for  dsc card this is the last poinrs payment card issued for the customer' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'pos_dsc', @level2type=N'COLUMN',@level2name=N'lastpaycard'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'used only for discount amount not discount percent' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'pos_dt', @level2type=N'COLUMN',@level2name=N'dsc_amt'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'use only for offers and promotion from the table stoffers' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'pos_dt', @level2type=N'COLUMN',@level2name=N'offer_amt'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'used only for discount amount not discount percent' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'pos_dtti', @level2type=N'COLUMN',@level2name=N'dsc_amt'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'use only for offers and promotion from the table stoffers' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'pos_dtti', @level2type=N'COLUMN',@level2name=N'offer_amt'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'if invoice is printed from the infosrvr then the value is 9 else anything' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'pos_hd', @level2type=N'COLUMN',@level2name=N'cktype'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'to be updated by the cashier who took the invoice' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'pos_hdti', @level2type=N'COLUMN',@level2name=N'rref'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'to be updated by the cashier who took the invoice' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'pos_hdti', @level2type=N'COLUMN',@level2name=N'rcontr'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'when =0 not taken =1 taken but not saved yet 2= taken and saved' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'pos_hdti', @level2type=N'COLUMN',@level2name=N'invstatus'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'when empty means card is not generated yet for this client' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'pos_nqmbr', @level2type=N'COLUMN',@level2name=N'nq_disccard'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'1- SPAN  2- Visa card 3- Master card 4- Maestro Card' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'poscccard', @level2type=N'COLUMN',@level2name=N'cardtype'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'Return from ECR/POS' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'poscccard', @level2type=N'COLUMN',@level2name=N'cctype'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'fasoohat fees' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'pudept', @level2type=N'COLUMN',@level2name=N'chk_serfre'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'transportation ' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'pudept', @level2type=N'COLUMN',@level2name=N'chk_sertrn'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'Expense Distribution Method 1-Value 2-CBM 3- Weight 4-Percent' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'puhdr', @level2type=N'COLUMN',@level2name=N'edm'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'1-Mall 2-Building 3- Villa 4- warehouse 5- = Land' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'reproperty', @level2type=N'COLUMN',@level2name=N're_resttype_code'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'1 = residential 2 = commercial ' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'reunits', @level2type=N'COLUMN',@level2name=N'un_unuse_code'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'this field is used to hold the value of offer_amt that comming from POS' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'sales_dt', @level2type=N'COLUMN',@level2name=N'imfcval'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'388 = tax invoice 383=Debit Note  381= Credit Note' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'sales_ei', @level2type=N'COLUMN',@level2name=N'InvoiceTypeCode'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'01 = tax invoice 02 simplified Tax Invoice' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'sales_ei', @level2type=N'COLUMN',@level2name=N'tax_invoice_type'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'10 = Cash  30 = Credit   42 = Payment to bank account   48 = Bank Card 1= others' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'sales_ei', @level2type=N'COLUMN',@level2name=N'PaymentType'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'NNPNESB' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'sales_ei', @level2type=N'COLUMN',@level2name=N'InvoiceTransactionCode'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'0=invoice created by infosoft account  1= Invoice created by Infosrvr for cash sales  (invorrtrn=1)  2= Invoice created by Infosrvr for Sales Replacement (invorrtrn=2)  3= Invoice created by Infosrvr for Sales Replacement (invorrtrn=3)
 4= Invoice created by PDA device' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'sales_hd', @level2type=N'COLUMN',@level2name=N'posinv'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'0= do not notify 1=Notify by email   2= Notify by SMS  3=Notify at login time' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'salesmen', @level2type=N'COLUMN',@level2name=N'notify_type'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'01 employee ,02 Tel  03 Addad elect ...' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'sdsubscribers', @level2type=N'COLUMN',@level2name=N'sdsubtype'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'this can be used for Rebate losses' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'slclass', @level2type=N'COLUMN',@level2name=N'srslcst'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'1 = Fatal error  2=Cancel   3=Delete' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'slpu_unused_inv', @level2type=N'COLUMN',@level2name=N'reasons'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'1 = No commessiion ,  2= commession allowed without targat , 3= commessiion allowed with monthly targat  4= comm with annual  target' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'stcommission', @level2type=N'COLUMN',@level2name=N'commtype'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'dbcxxYyy= yy example dbc01y14  means this field must be=14' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'stcrtpuinv', @level2type=N'COLUMN',@level2name=N'dbxyr'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'Purchase Invoice date' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'stcrtpuinv', @level2type=N'COLUMN',@level2name=N'idate'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'used for transaction between branch and can be used to slcenter of pu & sl ' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'sthdr', @level2type=N'COLUMN',@level2name=N'tobrno'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'this used for assembled item but if the value is 9 this means its transfer trx from trx between branch system' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'sthdr', @level2type=N'COLUMN',@level2name=N'asmtype'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'Repost those transactions that were not entered in this local database' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'sthdr', @level2type=N'COLUMN',@level2name=N'repost'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'store the nqati percent for this item to be given durring  sales process' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'stitemnqati', @level2type=N'COLUMN',@level2name=N'nqati_prcnt'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'store the sales discount amount for this items durring the sales process' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'stitemnqati', @level2type=N'COLUMN',@level2name=N'dsc_prcnt'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'can be used for 1-3 but if this value>0 then Givenamt must be 0' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'stoffers', @level2type=N'COLUMN',@level2name=N'DiscountP'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'1=  A- discount by group qty for any body.
      B- and It used  for none group qty but limit the max2buy during           the promotion for client only.
2= use the lprice1 
3= discount on big Pre fixed qty until it is unavailable then bring the       original price 
4= discount on per item and per invoice not exceed max2buy for the invoice' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'stoffers', @level2type=N'COLUMN',@level2name=N'disctype'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'if disctype is 1 or 2 this value must be >0' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'stoffers', @level2type=N'COLUMN',@level2name=N'MinQty'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'used for disctype =1 or 2 only and if this value>0 then discountp must be 0' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'stoffers', @level2type=N'COLUMN',@level2name=N'GivenAmt'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'The client will NOTbe  allowed to buy more than the qty in this column from this promoted item with startdate and enddate.
This used for client who has customer card' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'stoffers', @level2type=N'COLUMN',@level2name=N'Max2buy'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'If dsctype = 3 then lprice1 column used to hold the balance sold from this item and compare it with max2buy' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'stoffers', @level2type=N'COLUMN',@level2name=N'lprice1'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'01= Alocation 02 Dislocation ' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'stwmaloc_hd', @level2type=N'COLUMN',@level2name=N'alctype'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N' = empty 1= filled but not alocated 2= alocated 3-dispatched' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'stwmcntnr_hd', @level2type=N'COLUMN',@level2name=N'cn_status'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'01= receive 02 = carton split  03 = transfer to other carton' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'stwmcntnrtrx_hd', @level2type=N'COLUMN',@level2name=N'trtype'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'used for transaction between branch and can be used to slcenter of pu & sl ' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'stwmtrx_hd', @level2type=N'COLUMN',@level2name=N'tobrno'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'this used for assembled item but if the value is 9 this means its transfer trx from trx between branch system' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'stwmtrx_hd', @level2type=N'COLUMN',@level2name=N'asmtype'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'Repost those transactions that were not entered in this local database' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'stwmtrx_hd', @level2type=N'COLUMN',@level2name=N'repost'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'if true user can sale below minimum sales price of items' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'sysuse', @level2type=N'COLUMN',@level2name=N'goblwmnmp'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'مدخلات =1  مخرجات=2 for tax ' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'taxcategory', @level2type=N'COLUMN',@level2name=N'In_out_tax'
GO
USE [master]
GO
ALTER DATABASE [dbc01y30] SET  READ_WRITE 
GO